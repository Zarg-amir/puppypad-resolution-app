/**
 * PuppyPad Resolution Worker
 * Backend API for the Resolution App
 *
 * This worker handles both:
 * 1. Resolution App (customer-facing self-service)
 * 2. Resolution Hub (admin dashboard for case management)
 *
 * Module Structure:
 * - src/config/constants.js - Policy, admin, carrier configs
 * - src/services/shopify.js - Shopify API interactions
 * - src/services/tracking.js - ParcelPanel tracking
 * - src/utils/auth.js - Authentication utilities
 * - src/utils/cors.js - CORS headers
 * - src/utils/db.js - Database operations
 * - src/utils/formatters.js - Date, currency, text formatting
 */

// ============================================
// MODULE IMPORTS
// ============================================
import {
  POLICY_CONFIG,
  ADMIN_CONFIG,
  RICHPANEL_CONFIG,
  CHINA_CARRIERS,
  SOP_URLS,
  getCasePrefix,
  isChinaCarrier,
  isTestMode
} from './config/constants.js';

import {
  lookupOrders,
  processLineItems,
  extractClientOrderId,
  fetchClientOrderIdFromMetafields,
  getCountryNameFromCode
} from './services/shopify.js';

import {
  lookupTracking
} from './services/tracking.js';

import {
  hashPassword,
  generateToken,
  verifyToken,
  extractToken,
  requireAuth
} from './utils/auth.js';

import {
  getCorsHeaders,
  handleOptions as handleOptionsResponse,
  jsonResponse,
  errorResponse
} from './utils/cors.js';

import {
  runMigrations,
  generateCaseId,
  generateSessionId,
  logEvent,
  logCase,
  updateCaseStatus,
  getCaseById,
  checkExistingCase
} from './utils/db.js';

import {
  formatDate,
  formatDateTime,
  timeAgo,
  formatCurrency,
  formatDollarAmount,
  toTitleCase,
  escapeHtml,
  cleanPhoneNumber,
  cleanOrderNumber,
  formatTrackingStatus
} from './utils/formatters.js';
// Note: formatResolution is defined locally with more comprehensive mappings

// ============================================
// EASY CONFIG: PERSONA PROMPTS (Amy, Claudia)
// Note: POLICY_CONFIG, ADMIN_CONFIG, RICHPANEL_CONFIG, CHINA_CARRIERS,
// isChinaCarrier, isTestMode are now imported from ./config/constants.js
// Modify these to change AI personality/responses
// ============================================
const PERSONA_PROMPTS = {
  amy: {
    name: 'Amy',
    role: 'Customer Support',
    characteristics: [
      'Warm and heartwarming tone',
      'Use occasional emojis like ðŸ™‚ â¤ï¸ but don\'t overuse them',
      'Sound like a real human friend, not a corporate bot',
      'Be empathetic and understanding',
      'Keep responses concise but caring',
    ],
    instruction: 'Respond naturally to help the customer. If tackling an objection, be persuasive but genuine about the product\'s value.',
  },
  claudia: {
    name: 'Claudia',
    role: 'Dog Trainer',
    characteristics: [
      'Professional but warm and friendly',
      'Knowledgeable about dog behavior and training',
      'Encouraging and supportive',
      'Provide specific, actionable tips',
      'Sound like a trusted friend who happens to be an expert',
    ],
    instruction: 'Provide personalized training tips based on the dog\'s information. Be specific and helpful. Make the customer feel confident they can succeed.',
  },
  sarah: {
    name: 'Sarah',
    role: 'CX Lead',
    characteristics: [
      'Professional and solution-focused',
      'Takes ownership of issues',
      'Apologetic when needed',
      'Offers concrete next steps',
    ],
    instruction: 'Handle escalated issues with empathy and clear action plans.',
  },
};

// ============================================
// INTENT-SPECIFIC PROMPT PACKS
// Provides tailored context for different customer situations
// ============================================
const PROMPT_PACKS = {
  // Subscription-related intents
  subscription: {
    too_expensive: {
      context: 'Customer finds the subscription too expensive and is considering cancellation.',
      instruction: 'Acknowledge the customer\'s budget concerns genuinely. Highlight the long-term savings compared to disposable pads. Mention the quality and durability (1000+ washes). Do NOT offer discounts unless prompted by the system - focus on value, not price cuts.',
      objectionHandling: 'Avoid being pushy. If they\'ve made up their mind, respect it while leaving the door open for the future.',
    },
    too_many: {
      context: 'Customer has too many pads and wants to pause or cancel their subscription.',
      instruction: 'Validate their situation. Suggest pausing instead of cancelling to lock in their current price (prices may increase). Mention they can resume whenever they\'re ready.',
      objectionHandling: 'Be understanding. A pause is a win - they stay in the system.',
    },
    not_working: {
      context: 'Customer says the product isn\'t working as described.',
      instruction: 'Show genuine concern and ask specific questions about the issue. Offer to connect them with Claudia (our dog trainer) for training tips. Product may need break-in period or proper training approach.',
      objectionHandling: 'Listen first. Many "not working" issues are training-related, not product defects.',
    },
    moving: {
      context: 'Customer is moving and wants to cancel.',
      instruction: 'Offer to update their shipping address instead of cancelling. Emphasize continuity and that the service follows them.',
      objectionHandling: 'Moving is logistical, not dissatisfaction. Easy to resolve.',
    },
  },

  // Refund-related intents
  refund: {
    damaged: {
      context: 'Customer received a damaged product and wants a refund.',
      instruction: 'Apologize sincerely for the damaged item. Express that this isn\'t the experience we want. Ask for a photo if not already provided. Process quickly to rebuild trust.',
      objectionHandling: 'Damage claims should be handled generously. Speed matters more than investigation.',
    },
    not_as_described: {
      context: 'Customer feels the product doesn\'t match the description.',
      instruction: 'Listen to their specific concerns. Clarify any misunderstandings about features. If it\'s truly a mismatch, process the refund while noting feedback for product team.',
      objectionHandling: 'Don\'t be defensive. Acknowledge their perspective.',
    },
    changed_mind: {
      context: 'Customer simply changed their mind about the purchase.',
      instruction: 'Be understanding. Process within our return policy. Gently ask what changed to gather feedback.',
      objectionHandling: 'No need to convince. A smooth return creates future customers.',
    },
    doesnt_work: {
      context: 'Customer says the product doesn\'t work for their situation.',
      instruction: 'Ask about their specific use case. Offer training tips if applicable. If truly not suitable, process refund gracefully.',
      objectionHandling: 'May be a training opportunity. Suggest Claudia if dog-related.',
    },
  },

  // Tracking-related intents
  track: {
    late: {
      context: 'Customer\'s package is late and they\'re frustrated.',
      instruction: 'Apologize for the delay. Provide current tracking status. Explain carrier delays are outside our control but we\'re monitoring. Offer proactive updates.',
      objectionHandling: 'Focus on what we CAN do (monitor, follow up) rather than blame carriers.',
    },
    lost: {
      context: 'Package appears lost in transit.',
      instruction: 'Take ownership of the situation. Explain our investigation process. Assure them we\'ll either locate it or ship a replacement. Be specific about timeline.',
      objectionHandling: 'Lost packages are stressful. Speed and certainty help.',
    },
    delivered_not_received: {
      context: 'Carrier marked delivered but customer didn\'t receive it.',
      instruction: 'Take this seriously - package theft is real. Ask about common locations (neighbors, safe spots). Explain our investigation process including carrier contact and GPS verification.',
      objectionHandling: 'Never imply the customer is lying. Investigate thoroughly.',
    },
    stuck: {
      context: 'Package stuck at carrier facility or in transit.',
      instruction: 'Explain common reasons for delays (customs, facility backlogs). Provide realistic timeline. Offer to contact carrier on their behalf.',
      objectionHandling: 'Patience is needed. Set expectations clearly.',
    },
  },

  // General/fallback
  general: {
    default: {
      context: 'General customer inquiry.',
      instruction: 'Be helpful and friendly. Address their question directly. Offer additional assistance if relevant.',
      objectionHandling: 'Listen actively and respond to their actual concern.',
    },
  },
};

// ============================================
// DETAILED AI SCENARIO PROMPTS
// Full system prompts for specific customer scenarios
// ============================================
const AI_SCENARIO_PROMPTS = {
  // Claudia tips for dog not using product
  dog_tips: {
    model: 'gpt-4o',
    temperature: 0.75,
    maxTokens: 1000,
    buildSystemPrompt: (productDoc) => `You are Claudia, a compassionate dog trainer who specializes in dog behavior. You write warm, friendly messages.

=== KEY PRODUCT KNOWLEDGE ===
The PuppyPad is infused with pheromones that naturally attract dogs to use it. Most dogs (95%+) use it immediately with ZERO training required. However, a small percentage of dogs need a little extra encouragement - and that's completely normal!

=== YOUR EXPERTISE ===
You know how different breeds and ages respond:
- Puppies (under 1 year): Short attention spans, need frequent reminders, learn through repetition
- Adult dogs (1-7 years): May have established habits, need redirection
- Senior dogs (7+ years): May have mobility issues, need pad placed conveniently
- Stubborn breeds (Bulldogs, Huskies, Beagles): Need extra patience and positive reinforcement
- Eager-to-please breeds (Labs, Golden Retrievers, Poodles): Respond well to praise
- Small breeds (Chihuahuas, Yorkies): May be intimidated by large pads, need encouragement

=== CRITICAL RULES ===
1. ALWAYS use each dog's actual name throughout
2. Give BREED-SPECIFIC advice when breed is provided
3. Give AGE-APPROPRIATE advice based on their dog's age
4. If they mention what they've tried, you MUST:
   - Acknowledge it explicitly ("I can see you've already tried X...")
   - Explain why those methods might not have worked
   - Suggest DIFFERENT approaches that build on or complement what they tried
5. Emphasize these are simple tips, not intensive training (pheromones do most of the work)
6. If multiple dogs, give tips that work for all of them or address each dog specifically

=== OUTPUT FORMAT ===
You MUST output valid HTML. Use these tags:
- <p> for paragraphs
- <ul> and <li> for bullet point tips

CRITICAL:
- Do NOT use markdown (no asterisks, no backticks)
- Do NOT wrap in code blocks (no \`\`\`html)
- Just output raw HTML directly

=== PRODUCT INFO ===
${productDoc || 'PuppyPad - reusable pee pad with pheromone attractant'}`,
    buildUserPrompt: (data) => {
      // Format dogs list
      const dogs = data.dogs || [{ name: data.dogName, breed: data.dogBreed, age: data.dogAge }];
      const dogsInfo = dogs.map((d, i) => `Dog ${i + 1}: ${d.name} (${d.breed}, ${d.age})`).join('\n');
      const dogNames = dogs.map(d => d.name).join(' and ');
      const isSingleDog = dogs.length === 1;

      return `A customer needs help - their dog${isSingleDog ? " isn't" : "s aren't"} using the PuppyPad yet.

DOG INFO:
${dogsInfo}

WHAT THEY'VE ALREADY TRIED:
${data.methodsTried || 'Nothing specific mentioned'}

Write your response in HTML. ${isSingleDog ? '' : 'Address all dogs by name.'}

STRUCTURE:

<p>[Warm greeting mentioning ${dogNames}. Say something positive about their breed${isSingleDog ? '' : 's'}.]</p>

${data.methodsTried && data.methodsTried !== 'Nothing specific mentioned' ? `<p>[IMPORTANT: Acknowledge what they've tried: "${data.methodsTried}". Say something like "I can see you've already tried..." and briefly explain why it might not have worked yet. Show you've taken this into account.]</p>` : ''}

<p>[Explain that PuppyPads have pheromones that work instantly for most dogs, but some pups need extra help. Reassure them - they're not alone!]</p>

<p>Here are a few tips specifically for ${dogNames}:</p>

<ul>
<li>[Tip 1 - Tailored to breed/age. Use dog name${isSingleDog ? '' : 's'}.]</li>
<li>[Tip 2 - MUST be different from what they already tried. Explain why this approach is different.]</li>
<li>[Tip 3 - Another practical tip for their situation.]</li>
</ul>

<p>[Encouraging close - confident ${dogNames} will get it within days. Be warm!]</p>

CRITICAL:
- Output raw HTML only - NO markdown, NO code blocks
- Start with <p>, end with </p>
- If they mentioned trying something, ACKNOWLEDGE IT and explain why your tips are different`;
    }
  },

  // Changed mind / Didn't meet expectations (post-delivery)
  changed_mind: {
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 800,
    buildSystemPrompt: (productDoc, orderItems) => `You are Amy, a warm customer support specialist for a PET PRODUCTS brand. A customer is reconsidering their purchase. Read their message carefully and identify WHY, then respond appropriately.

=== IDENTIFY THE REASON & RESPOND ACCORDINGLY ===

1. PET LOSS OR REHOMED (dog died, gave away pet, pet very sick)
   â†’ Express genuine sympathy
   â†’ Suggest: donate to shelter, gift to friend/neighbor, keep for future pet
   â†’ Make them feel good about helping other animals

2. DOG NO LONGER NEEDS IT (trained, goes outside now, solved the problem)
   â†’ Congratulate them! But gently mention:
   â†’ Great for backup during bad weather, travel, or emergencies
   â†’ Useful as your dog ages (senior dogs have accidents)
   â†’ Good to have on hand "just in case"

3. IMPULSE BUY ("bought too quickly", "didn't think it through")
   â†’ Reassure them it was actually a good decision
   â†’ Explain the real benefits and quality
   â†’ Help them see the value they're getting

4. ORDERED TOO MANY ("only need one", "didn't realize it was a multipack")
   â†’ These are reusable and last a long time
   â†’ Having extras means less frequent washing
   â†’ Great for multiple rooms or rotation

5. FOUND DIFFERENT SOLUTION ("went with another option", "bought something else")
   â†’ Explain what makes THIS product different/better
   â†’ Focus on quality, durability, features
   â†’ Don't bash competitors, just highlight strengths

6. LIVING SITUATION CHANGED ("I'm moving", "won't work where I live now")
   â†’ Show empathy for big life changes
   â†’ Suggest: gift to someone, donate to local shelter
   â†’ Useful in any living situation (apartments especially!)

7. TIMING ISSUES ("needed it sooner", "won't arrive in time")
   â†’ Check delivery status and reassure if shipped
   â†’ These are reusable - they'll still be valuable when they arrive

8. FINANCIAL CONCERNS ("need to save money", "budget changed")
   â†’ Be understanding - money concerns are real
   â†’ Gently mention: reusable = saves money long-term vs disposables
   â†’ Quality means it lasts, which is better value

9. MISUNDERSTOOD THE PRODUCT ("not what I thought", "didn't realize what it was")
   â†’ Clarify what the product actually is/does
   â†’ Explain benefits they might not have known about

10. PERSONAL/VAGUE ("personal reasons", "things changed", won't explain)
    â†’ Respect their privacy
    â†’ Gentle, warm response without prying
    â†’ Share a few benefits in case it helps them reconsider

=== TONE & STYLE ===
- Warm, caring, genuine - like a helpful friend
- SHORT paragraphs (2-3 sentences max)
- Blank line between paragraphs
- Use ellipses (...) for pauses, NEVER em-dashes
- This is a CHAT message, NOT an email
- NEVER sign off with "Warm regards", "Best", "Thanks", or any email-style closing
- NEVER sign your name
- Just end naturally after your last point

=== CRITICAL - PRODUCT MATCHING ===
- ONLY mention products from the order items list
- Do NOT invent or guess product names
- When in doubt, use "your products" instead of guessing

=== PRODUCT DOCUMENTATION ===
${productDoc || 'Premium reusable dog pee pads, machine washable, leak-proof.'}

=== PRODUCTS THEY ORDERED ===
${orderItems || 'PuppyPad products'}

Write 4-5 short, warm paragraphs.`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Their message: "${data.customerMessage || 'I want to cancel'}"

Respond appropriately based on their situation. Don't mention refunds or returns. End naturally - no sign-offs.`
  },

  // Pre-shipment: Found it cheaper elsewhere
  preshipment_cheaper: {
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 600,
    buildSystemPrompt: (productDoc) => `You are Amy, a warm and knowledgeable customer support specialist for PuppyPad.

A customer wants to cancel their pre-shipment order because they "found it cheaper elsewhere." Your job is to explain why PuppyPad offers BETTER VALUE despite potentially higher upfront cost.

IMPORTANT: Be warm and understanding, NOT defensive or pushy.

KEY VALUE ARGUMENTS:
1. **Quality & Durability**: One PuppyPad lasts 2-3 years with proper care. Cheaper alternatives often need replacing within months.
2. **Absorbency**: Our 5-layer design handles accidents better than thin, cheap alternatives that leak through.
3. **Machine Washable**: 300+ washes = massive long-term savings vs constantly buying cheap pads.
4. **Leak-Proof Guarantee**: Our backing actually works. Cheap pads often soak through to floors.
5. **Eco-Friendly**: One PuppyPad replaces 300+ disposable pads (better for environment AND wallet).

TONE & STYLE:
- Warm, caring, genuine - like a helpful friend
- SHORT paragraphs (2-3 sentences max)
- Use ellipses (...) for pauses, NEVER em-dashes
- This is a CHAT message, NOT an email
- NEVER sign off with "Warm regards", "Best", etc.
- End naturally after your last point

=== PRODUCT INFO ===
${productDoc || 'PuppyPad premium reusable dog pee pads'}

Write 3-4 short, warm paragraphs that address their price concern.`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Order total: ${data.orderTotal || 'their order'}

Acknowledge their price concern warmly, then explain the VALUE difference. Focus on long-term savings and quality.`
  },

  // Pre-shipment: Financial reasons
  preshipment_financial: {
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 600,
    buildSystemPrompt: (productDoc) => `You are Amy, a warm and understanding customer support specialist for PuppyPad.

A customer wants to cancel their order due to "financial reasons." Your job is to help them see the FINANCIAL VALUE - showing them how this is actually a SMART financial decision, not an expense.

IMPORTANT: This is about helping them see the INVESTMENT VALUE, not guilt-tripping them.

KEY FINANCIAL ARGUMENTS:
1. **Cost Comparison**: One PuppyPad ($40-60) replaces 300+ disposable pads. At $0.25-0.50 per disposable, that's $75-150 in savings!
2. **Monthly Savings**: Disposable pads cost $20-40/month. PuppyPad pays for itself in 2-3 months.
3. **Long-term Math**: Over 2-3 years, you'll save $300-600+ compared to disposables
4. **No Hidden Costs**: Machine washable - no ongoing purchase costs
5. **One-Time Investment**: Unlike disposables, you buy once and you're set

TONE & STYLE:
- Warm, caring, understanding - money concerns are real and valid
- SHORT paragraphs (2-3 sentences max)
- Use ellipses (...) for pauses, NEVER em-dashes
- This is a CHAT message, NOT an email
- Show the math in a friendly, non-pushy way
- If they still want to cancel after this, that's okay

=== PRODUCT INFO ===
${productDoc || 'PuppyPad premium reusable dog pee pads'}

Write 3-4 short, warm paragraphs that address their financial concern.`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Order total: ${data.orderTotal || 'their order'}

Acknowledge their financial concern with empathy, show the MATH of why this saves money long-term.`
  },

  // Pre-shipment: Accidental order
  preshipment_accidental: {
    model: 'gpt-4o-mini',
    temperature: 0.75,
    maxTokens: 400,
    buildSystemPrompt: (productDoc, orderItems) => `You are Amy, a warm and friendly customer support specialist for PuppyPad.

A customer placed an order "by accident" and wants to cancel. Your job is to gently persuade them that maybe this wasn't an accident after all... it might be exactly what they need! But don't be pushy.

APPROACH:
- Acknowledge the "accident" with humor/lightness
- Mention their specific product(s) by name
- Highlight 1-2 key benefits of what THEY ordered
- Share a quick "why customers love it" moment
- End with an encouraging nudge, not pressure

TONE & STYLE:
- Warm, playful, like a helpful friend
- SHORT paragraphs (2-3 sentences max)
- Use ellipses (...) for pauses, NEVER em-dashes
- This is a CHAT message, NOT an email
- Keep it light and fun!
- NEVER sign off with "Warm regards", "Best", etc.

=== PRODUCT INFO ===
${productDoc || 'Premium reusable dog pee pads'}

=== PRODUCTS THEY ORDERED ===
${orderItems || 'PuppyPad'}

Write 2-3 short, warm paragraphs. Keep it playful!`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Order total: ${data.orderTotal || 'their order'}

Playfully acknowledge the "accident" and encourage them to give it a try. Keep it light - no pressure.`
  },

  // Subscription too expensive
  subscription_expensive: {
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 400,
    buildSystemPrompt: (productDoc) => `You are Amy, a warm customer support specialist for PuppyPad. A subscription customer says their subscription is "too expensive" and wants to cancel.

Write a brief, empathetic response (3-4 short sentences) that:
1. Shows you understand budget concerns are real
2. Mentions what makes our product worth it (reusable, long-lasting, quality)
3. Hints that you might have a solution

TONE:
- Understanding, not defensive
- Casual and friendly, like a chat message
- Don't be pushy about keeping them

CRITICAL RULES:
- This is a CHAT message, not an email
- NEVER use em-dashes
- NEVER sign off with "Warm regards", "Best", "Thanks", etc.
- Don't mention specific discounts yet
- End naturally - no sign-offs

=== PRODUCT INFO ===
${productDoc || 'PuppyPad subscription'}`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Subscription price: ${data.subscriptionPrice || 'their subscription'}

Write a short, understanding response that acknowledges their budget concern and gently explains the value.`
  },

  // Satisfied customer thank you
  satisfied_thankyou: {
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 200,
    buildSystemPrompt: () => `You are Amy, a warm customer support specialist for PuppyPad. A customer was having second thoughts about their purchase, but you talked with them and they've decided they're happy to keep it.

Write a brief, warm thank you message (2-3 short sentences max).

TONE:
- Genuinely happy and warm
- Casual and friendly, like a chat message
- Don't be over-the-top or salesy
- Make them feel good about their decision

CRITICAL RULES:
- This is a CHAT message, not an email
- NEVER sign off with "Warm regards", "Best", "Thanks", etc.
- NEVER sign your name
- Keep it short and natural
- End naturally after your last point`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Their original concern: "${data.originalConcern || 'had some concerns'}"

Write a short, warm thank you message now that they're satisfied.`
  },

  // Amy general response
  amy_general: {
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 300,
    buildSystemPrompt: (productDoc, context) => `You are Amy, a friendly and caring customer support representative for PuppyPad (a pet products company). You're chatting with a customer who needs help.

YOUR PERSONALITY:
- Warm, friendly, and genuinely caring - like talking to a helpful friend
- Empathetic and understanding - you really get how frustrating issues can be
- Casual but professional - use natural conversational language
- Brief and to the point - keep responses to 1-2 short sentences max

IMPORTANT RULES:
- Use the customer's first name naturally if provided
- Reference what they selected/told you to show you're listening
- NEVER use em-dashes. Use "..." for pauses if needed
- Keep it SHORT - just 1-2 sentences, conversational
- Be genuine, not scripted or robotic
- Don't over-apologize or be overly formal
- Sound like a real person texting a friend who needs help

=== CONTEXT ===
${context || 'General customer support'}

=== PRODUCT INFO ===
${productDoc || 'PuppyPad products'}`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Situation: ${data.situation || 'needs help'}

Write a brief, warm response.`
  },

  // Case confirmation message
  case_confirmation: {
    model: 'gpt-4o-mini',
    temperature: 0.6,
    maxTokens: 200,
    buildSystemPrompt: () => `You are writing a brief confirmation message for a PuppyPad customer who just submitted a support request.

RULES:
- Be warm and reassuring
- Keep it to 2-3 short sentences
- Acknowledge their specific issue/selection
- Confirm we got their request
- Let them know what happens next (24-48 hours)
- Don't repeat all the details they already know
- This is a CHAT message, not an email
- NEVER use em-dashes
- Do NOT sign off with any email-style closing
- End naturally after your last sentence`,
    buildUserPrompt: (data) => `Issue type: ${data.issueType || 'support request'}
Resolution: ${data.resolution || 'being processed'}

Write a warm, empathetic 2-3 sentence confirmation. Acknowledge their situation and let them know our team will handle it within 24-48 hours.`
  },

  // Package help - can't find delivered package
  package_help: {
    model: 'gpt-4o-mini',
    temperature: 0.6,
    maxTokens: 400,
    buildSystemPrompt: () => `You are a helpful customer support specialist. The customer says they can't find their delivered package. Provide practical tips for locating it based on the delivery information.

Be helpful and practical. List 4-5 specific places to check for the package based on common delivery locations.`,
    buildUserPrompt: (data) => `Package delivery info:
Carrier: ${data.carrier || 'Unknown'}
Delivery date: ${data.deliveryDate || 'Recently'}
Address type: ${data.addressType || 'Unknown'}
Latest tracking: ${data.trackingStatus || 'Delivered'}

Provide 4-5 specific places to check for the package. Be helpful and practical.`
  },

  // Product issue help
  product_issue: {
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 500,
    buildSystemPrompt: (productDoc) => `You are a helpful customer support specialist for PuppyPad.

Provide empathetic, helpful responses when customers have issues with their products.

TONE:
- Understanding and caring
- Helpful and solution-oriented
- Professional but friendly

RULES:
- Acknowledge their frustration
- Provide practical suggestions
- Use product documentation when relevant
- End by asking if this helps

=== PRODUCT DOCUMENTATION ===
${productDoc || 'Premium reusable dog pee pads, machine washable, leak-proof.'}`,
    buildUserPrompt: (data) => `Customer concern about ${data.productName || 'their product'}:
Issue: "${data.issue || 'having problems'}"
${data.expectations ? `Expectations not met: "${data.expectations}"` : ''}

Provide an empathetic response with helpful suggestions. End with asking if this helps.`
  },

  // Product benefits pitch - for "charged unexpectedly" / don't recognize order
  product_benefits_pitch: {
    model: 'gpt-4o-mini',
    temperature: 0.75,
    maxTokens: 600,
    buildSystemPrompt: (productDoc, orderItems) => `You are Amy, a warm and knowledgeable customer support specialist for PuppyPad.

A customer doesn't recognize a charge on their account. You've already explained that it was likely ordered by someone in their household or as a gift. Now your job is to EXCITE them about the products they received!

=== YOUR GOAL ===
Make them WANT to keep the products by highlighting the genuine benefits. Focus on problem-solution messaging - what problems do these products solve for pet owners?

=== APPROACH ===
1. Mention the SPECIFIC products from their order by name
2. For each product, explain ONE key benefit using problem-solution framing
3. Share a quick "customers love this because..." moment
4. Make it feel like a happy accident - they got something great!
5. Keep it genuine - don't oversell or be pushy

=== PROBLEM-SOLUTION EXAMPLES ===
- PuppyPad: "Tired of buying disposables every week? This reusable pad lasts years and saves hundreds!"
- BusyPet: "Does your pup get bored and destructive? This keeps them mentally stimulated for hours!"
- CalmBuddy: "Anxious during storms or fireworks? The pheromone diffuser helps dogs relax naturally."
- CozyBed: "Older dogs with joint pain? The orthopedic design supports their joints perfectly."

=== TONE & STYLE ===
- Warm, enthusiastic but genuine
- SHORT paragraphs (2-3 sentences max)
- Use ellipses (...) for pauses, NEVER em-dashes
- This is a CHAT message, NOT an email
- Make it feel like discovering something great, not a sales pitch
- NEVER sign off with "Warm regards", "Best", etc.

=== PRODUCT DOCUMENTATION ===
${productDoc || 'Premium pet products designed to solve real problems for pet parents.'}

=== PRODUCTS IN THIS ORDER ===
${orderItems || 'PuppyPad products'}

Write 2-3 short, enthusiastic paragraphs about the products.`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Products in their order: ${data.products || 'PuppyPad products'}
Order total: ${data.orderTotal || 'their order'}

Get them excited about what they received! Focus on genuine benefits and problem-solution messaging. Be warm and enthusiastic but not pushy.`
  },

  // Quality difference - customer noticed material difference
  quality_difference: {
    model: 'gpt-4o-mini',
    temperature: 0.7,
    maxTokens: 600,
    buildSystemPrompt: (productDoc) => `You are Amy, a warm and knowledgeable customer support specialist for PuppyPad.

A customer has noticed a quality/material difference in their PuppyPad order. This is because we've been transitioning from Original (5-layer) to Enhanced (6-layer) materials.

=== KEY INFORMATION ===
We have TWO versions of PuppyPad:

ORIGINAL (5-layer):
- 270gsm absorber
- Standard waterproof backing
- Anti-slip coating
- Standard stitching
- Retail price: ~$50/pad

ENHANCED (6-layer):
- 300gsm absorber (+30% more absorbent)
- Comfort cushion layer (NEW)
- Medical-grade TPU waterproof backing
- Rubber paw-shaped grip dots
- Reinforced edge binding
- Retail price: ~$70/pad

During transition, some orders ship with Original, some with Enhanced - depending on warehouse stock. Everyone pays Original pricing regardless of which version ships.

=== WHAT STAYS THE SAME ===
Both versions have:
âœ“ Pheromone technology
âœ“ 100% leak-proof protection
âœ“ Machine washable 300+ times
âœ“ Full 90-day guarantee

=== TONE & STYLE ===
- Warm, friendly, reassuring
- Make them feel like they got a good deal either way
- Don't be defensive about the difference
- Use ellipses (...) for pauses, NEVER em-dashes
- This is a CHAT message, NOT an email
- NEVER sign off with "Warm regards", "Best", etc.

=== PRODUCT INFO ===
${productDoc || 'PuppyPad premium reusable dog pee pads'}`,
    buildUserPrompt: (data) => `Customer name: ${data.customerName || 'there'}
Their concern: "${data.customerMessage || 'noticed different materials'}"
What version they received: ${data.versionReceived || 'Unknown'}

Explain the quality difference in a positive way. Make them feel good about their purchase.`
  }
};

// ============================================
// EASY CONFIG: PRODUCT DOC MAPPING
// Maps product names to R2 file names
// ============================================
const PRODUCT_DOC_MAP = {
  'puppypad': 'PuppyPad-_Reusable-Pee-Pad_-_1_.txt',
  'pee pad': 'PuppyPad-_Reusable-Pee-Pad_-_1_.txt',
  'busypet': 'BusyPet.txt',
  'calmbuddy': 'CalmBuddy Premium Diffuser Kit.txt',
  'cozybed': 'CozyBed (1).txt',
  'laundry': 'Laundry-Detergent-Sheets.txt',
  'stain': 'Stain-and-Odor-Eliminator.txt',
};

// ============================================
// WORKER ENTRY POINT
// Note: SOP_URLS, runMigrations are imported from modules
// ============================================

export default {
  async fetch(request, env, ctx) {
    const url = new URL(request.url);
    const pathname = url.pathname;

    // CORS headers for frontend
    const corsHeaders = {
      'Access-Control-Allow-Origin': '*',
      'Access-Control-Allow-Methods': 'GET, POST, PUT, DELETE, OPTIONS',
      'Access-Control-Allow-Headers': 'Content-Type, Authorization',
    };

    // Handle preflight
    if (request.method === 'OPTIONS') {
      return new Response(null, { headers: corsHeaders });
    }

    // Run database migrations (adds missing columns)
    await runMigrations(env);

    try {
      // Health check
      if (pathname === '/api/health') {
        return Response.json({ status: 'ok', timestamp: new Date().toISOString() }, { headers: corsHeaders });
      }

      // Lookup order
      if (pathname === '/api/lookup-order' && request.method === 'POST') {
        return await handleLookupOrder(request, env, corsHeaders);
      }

      // Get tracking
      if (pathname === '/api/tracking' && request.method === 'POST') {
        return await handleTracking(request, env, corsHeaders);
      }

      // Validate 90-day guarantee
      if (pathname === '/api/validate-guarantee' && request.method === 'POST') {
        return await handleValidateGuarantee(request, env, corsHeaders);
      }

      // Get subscription
      if (pathname === '/api/subscription' && request.method === 'POST') {
        return await handleSubscription(request, env, corsHeaders);
      }

      // Create case
      if (pathname === '/api/create-case' && request.method === 'POST') {
        return await handleCreateCase(request, env, corsHeaders);
      }

      // Create manual help case (order not found)
      if (pathname === '/api/create-manual-case' && request.method === 'POST') {
        return await handleCreateManualCase(request, env, corsHeaders);
      }

      // Check existing case
      if (pathname === '/api/check-case' && request.method === 'POST') {
        return await handleCheckCase(request, env, corsHeaders);
      }

      // Append to existing case (dedupe flow)
      if (pathname === '/api/append-to-case' && request.method === 'POST') {
        return await handleAppendToCase(request, env, corsHeaders);
      }

      // AI response (Amy/Claudia)
      if (pathname === '/api/ai-response' && request.method === 'POST') {
        return await handleAIResponse(request, env, corsHeaders);
      }

      // Parse pickup location from tracking data using AI
      if (pathname === '/api/parse-pickup-location' && request.method === 'POST') {
        return await handleParsePickupLocation(request, env, corsHeaders);
      }

      // Upload evidence
      if (pathname === '/api/upload-evidence' && request.method === 'POST') {
        return await handleUploadEvidence(request, env, corsHeaders);
      }

      // Serve audio files
      if (pathname.startsWith('/audio/')) {
        return await handleAudio(pathname, env, corsHeaders);
      }

      // ============================================
      // DATA COLLECTION ENDPOINTS (renamed from analytics to avoid ad blockers)
      // ============================================

      // Log event
      if ((pathname === '/api/a/event' || pathname === '/api/analytics/event') && request.method === 'POST') {
        return await handleLogEvent(request, env, corsHeaders);
      }

      // Log session
      if ((pathname === '/api/a/session' || pathname === '/api/analytics/session') && request.method === 'POST') {
        return await handleLogSession(request, env, corsHeaders);
      }

      // Log survey response
      if ((pathname === '/api/a/survey' || pathname === '/api/analytics/survey') && request.method === 'POST') {
        return await handleLogSurvey(request, env, corsHeaders);
      }

      // Log policy block
      if ((pathname === '/api/a/policy-block' || pathname === '/api/analytics/policy-block') && request.method === 'POST') {
        return await handleLogPolicyBlock(request, env, corsHeaders);
      }

      // Trouble report submission (for users having issues with the app)
      if (pathname === '/api/trouble-report' && request.method === 'POST') {
        return await handleTroubleReport(request, env, corsHeaders);
      }

      // ============================================
      // ADMIN DASHBOARD ENDPOINTS
      // ============================================

      // Admin login
      if (pathname === '/admin/api/login' && request.method === 'POST') {
        return await handleAdminLogin(request, env, corsHeaders);
      }

      // Admin setup (one-time password reset)
      if (pathname === '/admin/api/setup' && request.method === 'POST') {
        return await handleAdminSetup(request, env, corsHeaders);
      }

      // ============================================
      // USER MANAGEMENT ENDPOINTS
      // ============================================

      // List users (Admin only)
      if (pathname === '/hub/api/users' && request.method === 'GET') {
        return await handleListUsers(request, env, corsHeaders);
      }

      // Create user (Admin only)
      if (pathname === '/hub/api/users' && request.method === 'POST') {
        return await handleCreateUser(request, env, corsHeaders);
      }

      // Update user (Admin only)
      if (pathname === '/hub/api/users' && request.method === 'PUT') {
        return await handleUpdateUser(request, env, corsHeaders);
      }

      // Delete user (Admin only)
      if (pathname.match(/^\/hub\/api\/users\/\d+$/) && request.method === 'DELETE') {
        return await handleDeleteUser(request, env, corsHeaders);
      }

      // Update own profile (any logged-in user)
      if (pathname === '/hub/api/profile' && request.method === 'PUT') {
        return await handleUpdateProfile(request, env, corsHeaders);
      }

      // Admin: Reset user password
      if (pathname.match(/^\/hub\/api\/users\/\d+\/reset-password$/) && request.method === 'POST') {
        return await handleResetUserPassword(request, env, corsHeaders);
      }

      // Get user activity log (Admin only, filtered by user ID)
      if (pathname.match(/^\/hub\/api\/users\/\d+\/activity$/) && request.method === 'GET') {
        return await handleGetUserActivityLog(request, env, corsHeaders);
      }

      // Get current user profile
      if (pathname === '/hub/api/profile' && request.method === 'GET') {
        return await handleGetProfile(request, env, corsHeaders);
      }

      // Change password
      if (pathname === '/hub/api/change-password' && request.method === 'POST') {
        return await handleChangePassword(request, env, corsHeaders);
      }

      // Audit log (Admin only)
      if (pathname === '/hub/api/audit-log' && request.method === 'GET') {
        return await handleGetAuditLog(request, env, corsHeaders);
      }

      // ============================================
      // BULK ACTIONS ENDPOINTS
      // ============================================

      // Bulk update status
      if (pathname === '/hub/api/bulk/status' && request.method === 'POST') {
        return await handleBulkUpdateStatus(request, env, corsHeaders);
      }

      // Bulk assign (Admin only)
      if (pathname === '/hub/api/bulk/assign' && request.method === 'POST') {
        return await handleBulkAssign(request, env, corsHeaders);
      }

      // Bulk add comment
      if (pathname === '/hub/api/bulk/comment' && request.method === 'POST') {
        return await handleBulkAddComment(request, env, corsHeaders);
      }

      // Export cases to CSV
      if (pathname === '/hub/api/bulk/export' && request.method === 'POST') {
        return await handleExportCases(request, env, corsHeaders);
      }

      // ============================================
      // ASSIGNMENT SYSTEM ENDPOINTS (Admin Only)
      // ============================================

      // Get assignment queue
      if (pathname === '/hub/api/assignment-queue' && request.method === 'GET') {
        return await handleGetAssignmentQueue(request, env, corsHeaders);
      }

      // Update assignment queue
      if (pathname === '/hub/api/assignment-queue' && request.method === 'POST') {
        return await handleUpdateAssignmentQueue(request, env, corsHeaders);
      }

      // Get next assignee (round robin)
      if (pathname === '/hub/api/assignment/next' && request.method === 'GET') {
        return await handleGetNextAssignee(request, env, corsHeaders);
      }

      // Auto-assign case (round robin)
      if (pathname === '/hub/api/assignment/auto' && request.method === 'POST') {
        return await handleAutoAssign(request, env, corsHeaders);
      }

      // Recalculate assignment loads
      if (pathname === '/hub/api/assignment/recalculate' && request.method === 'POST') {
        return await handleRecalculateLoads(request, env, corsHeaders);
      }

      // ============================================
      // SAVED VIEWS ENDPOINTS
      // ============================================

      // Get saved views
      if (pathname === '/hub/api/views' && request.method === 'GET') {
        return await handleGetSavedViews(request, env, corsHeaders);
      }

      // Create saved view
      if (pathname === '/hub/api/views' && request.method === 'POST') {
        return await handleCreateSavedView(request, env, corsHeaders);
      }

      // Update saved view
      if (pathname === '/hub/api/views' && request.method === 'PUT') {
        return await handleUpdateSavedView(request, env, corsHeaders);
      }

      // Delete saved view
      if (pathname.match(/^\/hub\/api\/views\/\d+$/) && request.method === 'DELETE') {
        return await handleDeleteSavedView(request, env, corsHeaders);
      }

      // ============================================
      // COMPLETION CHECKLIST ENDPOINTS
      // ============================================

      // Get checklist items for a case type
      if (pathname === '/hub/api/checklist-items' && request.method === 'GET') {
        return await handleGetChecklistItems(request, env, corsHeaders);
      }

      // Get checklist status for a specific case
      if (pathname.match(/^\/hub\/api\/case\/[^\/]+\/checklist$/) && request.method === 'GET') {
        return await handleGetCaseChecklistStatus(request, env, corsHeaders);
      }

      // Mark checklist item complete/incomplete
      if (pathname === '/hub/api/checklist/complete' && request.method === 'POST') {
        return await handleCompleteChecklistItem(request, env, corsHeaders);
      }

      // Admin: Manage checklist templates (GET/POST/PUT/DELETE)
      if (pathname === '/hub/api/admin/checklists' || pathname.match(/^\/hub\/api\/admin\/checklists\/\d+$/)) {
        return await handleManageChecklists(request, env, corsHeaders);
      }

      // ============================================
      // PHASE 2: ADMIN TOOLS
      // ============================================

      // SOP Link Management (Admin only)
      if (pathname === '/hub/api/admin/sop-links' && request.method === 'GET') {
        return await handleGetSOPLinks(request, env, corsHeaders);
      }

      if (pathname === '/hub/api/admin/sop-links' && request.method === 'POST') {
        return await handleCreateSOPLink(request, env, corsHeaders);
      }

      if (pathname.match(/^\/hub\/api\/admin\/sop-links\/\d+$/) && request.method === 'PUT') {
        const id = pathname.split('/').pop();
        return await handleUpdateSOPLink(request, id, env, corsHeaders);
      }

      if (pathname.match(/^\/hub\/api\/admin\/sop-links\/\d+$/) && request.method === 'DELETE') {
        const id = pathname.split('/').pop();
        return await handleDeleteSOPLink(request, id, env, corsHeaders);
      }

      // Get SOP link for a specific case (public for hub users)
      if (pathname === '/hub/api/sop-link' && request.method === 'GET') {
        return await handleGetSOPForCase(request, env, corsHeaders);
      }

      // Enhanced Audit Log (Admin only)
      if (pathname === '/hub/api/admin/audit-log' && request.method === 'GET') {
        return await handleGetEnhancedAuditLog(request, env, corsHeaders);
      }

      // Audit Log Export (Admin only)
      if (pathname === '/hub/api/admin/audit-log/export' && request.method === 'GET') {
        return await handleExportAuditLog(request, env, corsHeaders);
      }

      // Resolution Validation Rules
      if (pathname === '/hub/api/validate-resolution' && request.method === 'POST') {
        return await handleValidateResolution(request, env, corsHeaders);
      }

      // Dashboard data (protected)
      if (pathname === '/admin/api/dashboard' && request.method === 'GET') {
        return await handleDashboardData(request, env, corsHeaders);
      }

      // Recent cases list (protected)
      if (pathname === '/admin/api/cases' && request.method === 'GET') {
        return await handleCasesList(request, env, corsHeaders);
      }

      // Events log (protected)
      if (pathname === '/admin/api/events' && request.method === 'GET') {
        return await handleEventsList(request, env, corsHeaders);
      }

      // Sessions list (protected)
      if (pathname === '/admin/api/sessions' && request.method === 'GET') {
        return await handleSessionsList(request, env, corsHeaders);
      }

      // Analytics breakdowns (protected)
      if (pathname === '/admin/api/analytics/issues' && request.method === 'GET') {
        return await handleIssuesAnalytics(request, env, corsHeaders);
      }

      // Serve dashboard HTML
      if (pathname === '/admin' || pathname === '/admin/') {
        return await serveDashboard(env, corsHeaders);
      }

      // Serve Hub JavaScript (must come before /hub/* catch-all)
      if (pathname === '/hub/hub-app.js') {
        return await serveHubAsset('js', corsHeaders);
      }

      // Serve Flow Docs React JavaScript
      if (pathname === '/hub/flow-docs-react.js') {
        return await serveHubAsset('flow-docs-react', corsHeaders);
      }

      // Serve Flow Docs as standalone page (3-panel layout: left nav, canvas, right properties) - Admin only
      if (pathname === '/hub/flow-docs' || pathname === '/hub/flow-docs/') {
        return await serveFlowDocsPage(request, env, corsHeaders);
      }

      // Serve Hub CSS (must come before /hub/* catch-all)
      if (pathname === '/hub/hub-styles.css') {
        return await serveHubAsset('css', corsHeaders);
      }

      // Serve Flow Docs React JS (must come before /hub/* catch-all)
      if (pathname === '/hub/flow-docs-react.js') {
        return await serveHubAsset('flow-react', corsHeaders);
      }

      // Hub API routes (must come BEFORE /hub/* catch-all)
      // Hub API - Stats
      if (pathname === '/hub/api/stats' && request.method === 'GET') {
        return await handleHubStats(request, env, corsHeaders);
      }

      // Hub API - Cases list
      if (pathname === '/hub/api/cases' && request.method === 'GET') {
        return await handleHubCases(request, env, corsHeaders);
      }

      // Hub API - Self-Resolved cases (cases resolved within the app)
      if (pathname === '/hub/api/self-resolved' && request.method === 'GET') {
        return await handleHubSelfResolved(request, env, corsHeaders);
      }

      // Hub API - Cases search (for dropdown suggestions)
      if (pathname === '/hub/api/cases/search' && request.method === 'GET') {
        return await handleHubCasesSearch(request, env, corsHeaders);
      }

      // Hub API - Cases by category (for email template live preview)
      if (pathname === '/hub/api/cases/by-category' && request.method === 'GET') {
        return await handleHubCasesByCategory(request, env, corsHeaders);
      }

      // Hub API - Single case
      if (pathname.startsWith('/hub/api/case/') && request.method === 'GET' && !pathname.includes('/comments') && !pathname.includes('/status') && !pathname.includes('/activity')) {
        const caseId = pathname.split('/hub/api/case/')[1];
        return await handleHubGetCase(caseId, env, corsHeaders);
      }

      // Hub API - Update case status
      if (pathname.startsWith('/hub/api/case/') && pathname.endsWith('/status') && request.method === 'PUT') {
        const caseId = pathname.split('/hub/api/case/')[1].replace('/status', '');
        return await handleHubUpdateStatus(request, caseId, env, corsHeaders);
      }

      // Hub API - Get case comments
      if (pathname.startsWith('/hub/api/case/') && pathname.endsWith('/comments') && request.method === 'GET') {
        const caseId = pathname.split('/hub/api/case/')[1].replace('/comments', '');
        return await handleHubGetComments(caseId, env, corsHeaders);
      }

      // Hub API - Add case comment
      if (pathname.startsWith('/hub/api/case/') && pathname.endsWith('/comments') && request.method === 'POST') {
        const caseId = pathname.split('/hub/api/case/')[1].replace('/comments', '');
        return await handleHubAddComment(request, caseId, env, corsHeaders);
      }

      // Hub API - Case activity timeline
      if (pathname.startsWith('/hub/api/case/') && pathname.endsWith('/activity') && request.method === 'GET') {
        const caseId = pathname.split('/hub/api/case/')[1].replace('/activity', '');
        return await handleHubCaseActivity(caseId, env, corsHeaders);
      }

      // Hub API - Format case details with OpenAI
      if (pathname === '/hub/api/format-case-details' && request.method === 'POST') {
        return await handleFormatCaseDetails(request, env, corsHeaders);
      }

      // Hub API - Sessions list
      if (pathname === '/hub/api/sessions' && request.method === 'GET') {
        return await handleHubSessions(request, env, corsHeaders);
      }

      // Hub API - Events list
      if (pathname === '/hub/api/events' && request.method === 'GET') {
        return await handleHubEvents(request, env, corsHeaders);
      }

      // Hub API - Analytics
      if (pathname === '/hub/api/analytics' && request.method === 'GET') {
        return await handleHubAnalytics(request, env, corsHeaders);
      }

      // Hub API - Duplicate Cases
      if (pathname === '/hub/api/duplicates' && request.method === 'GET') {
        return await handleHubDuplicates(request, env, corsHeaders);
      }

      // Hub API - Issues search (must come before /hub/api/issues)
      if (pathname === '/hub/api/issues/search' && request.method === 'GET') {
        return await handleHubIssuesSearch(request, env, corsHeaders);
      }

      // Hub API - Issues (Trouble Reports)
      if (pathname === '/hub/api/issues' && request.method === 'GET') {
        return await handleHubIssues(request, env, corsHeaders);
      }

      // Hub API - Single Issue
      if (pathname.startsWith('/hub/api/issues/') && request.method === 'GET') {
        const reportId = pathname.split('/hub/api/issues/')[1];
        return await handleHubIssueDetail(reportId, env, corsHeaders);
      }

      // Hub API - Update Issue Status
      if (pathname.match(/\/hub\/api\/issues\/[^\/]+\/status/) && request.method === 'PUT') {
        const reportId = pathname.split('/hub/api/issues/')[1].split('/status')[0];
        return await handleHubIssueStatusUpdate(reportId, request, env, corsHeaders);
      }

      // ============================================
      // HUB API - SOP LINKS
      // ============================================
      // List all SOPs (with optional category filter) - Admin only
      if (pathname === '/hub/api/sop' && request.method === 'GET') {
        return await handleHubSOPList(request, env, corsHeaders);
      }

      // Get single SOP
      if (pathname.match(/\/hub\/api\/sop\/\d+$/) && request.method === 'GET') {
        const sopId = pathname.split('/hub/api/sop/')[1];
        return await handleHubSOPGet(sopId, env, corsHeaders);
      }

      // Create SOP (admin only)
      if (pathname === '/hub/api/sop' && request.method === 'POST') {
        return await handleHubSOPCreate(request, env, corsHeaders);
      }

      // Update SOP (admin only)
      if (pathname.match(/\/hub\/api\/sop\/\d+$/) && request.method === 'PUT') {
        const sopId = pathname.split('/hub/api/sop/')[1];
        return await handleHubSOPUpdate(sopId, request, env, corsHeaders);
      }

      // Delete SOP (admin only)
      if (pathname.match(/\/hub\/api\/sop\/\d+$/) && request.method === 'DELETE') {
        const sopId = pathname.split('/hub/api/sop/')[1];
        return await handleHubSOPDelete(sopId, request, env, corsHeaders);
      }

      // ============================================
      // HUB API - EMAIL TEMPLATES
      // ============================================
      // List all email templates (with optional category filter) - Admin only
      if (pathname === '/hub/api/email-templates' && request.method === 'GET') {
        return await handleHubEmailTemplatesList(request, env, corsHeaders);
      }

      // Get single email template
      if (pathname.match(/\/hub\/api\/email-templates\/\d+$/) && request.method === 'GET') {
        const templateId = pathname.split('/hub/api/email-templates/')[1];
        return await handleHubEmailTemplateGet(templateId, env, corsHeaders);
      }

      // Create email template (admin only)
      if (pathname === '/hub/api/email-templates' && request.method === 'POST') {
        return await handleHubEmailTemplateCreate(request, env, corsHeaders);
      }

      // Update email template (admin only)
      if (pathname.match(/\/hub\/api\/email-templates\/\d+$/) && request.method === 'PUT') {
        const templateId = pathname.split('/hub/api/email-templates/')[1];
        return await handleHubEmailTemplateUpdate(templateId, request, env, corsHeaders);
      }

      // Delete email template (admin only)
      if (pathname.match(/\/hub\/api\/email-templates\/\d+$/) && request.method === 'DELETE') {
        const templateId = pathname.split('/hub/api/email-templates/')[1];
        return await handleHubEmailTemplateDelete(templateId, request, env, corsHeaders);
      }

      // ============================================
      // HUB API - SAVED VIEWS
      // ============================================
      // List saved views for current user (includes global views)
      if (pathname === '/hub/api/saved-views' && request.method === 'GET') {
        return await handleHubSavedViewsList(request, env, corsHeaders);
      }

      // Create saved view
      if (pathname === '/hub/api/saved-views' && request.method === 'POST') {
        return await handleHubSavedViewCreate(request, env, corsHeaders);
      }

      // Update saved view
      if (pathname.match(/\/hub\/api\/saved-views\/\d+$/) && request.method === 'PUT') {
        const viewId = pathname.split('/hub/api/saved-views/')[1];
        return await handleHubSavedViewUpdate(viewId, request, env, corsHeaders);
      }

      // Delete saved view
      if (pathname.match(/\/hub\/api\/saved-views\/\d+$/) && request.method === 'DELETE') {
        const viewId = pathname.split('/hub/api/saved-views/')[1];
        return await handleHubSavedViewDelete(viewId, request, env, corsHeaders);
      }

      // Track view usage (increment use_count)
      if (pathname.match(/\/hub\/api\/saved-views\/\d+\/use$/) && request.method === 'POST') {
        const viewId = pathname.split('/hub/api/saved-views/')[1].replace('/use', '');
        return await handleHubSavedViewUse(viewId, env, corsHeaders);
      }

      // ============================================
      // HUB API - FLOW POSITIONS
      // ============================================
      // Get flow positions
      if (pathname.startsWith('/hub/api/flow-positions/') && request.method === 'GET') {
        const flowId = pathname.split('/hub/api/flow-positions/')[1];
        return await handleFlowPositionsGet(flowId, env, corsHeaders);
      }

      // Save flow positions
      if (pathname.startsWith('/hub/api/flow-positions/') && request.method === 'PUT') {
        const flowId = pathname.split('/hub/api/flow-positions/')[1];
        return await handleFlowPositionsSave(flowId, request, env, corsHeaders);
      }

      // Reset flow positions
      if (pathname.startsWith('/hub/api/flow-positions/') && request.method === 'DELETE') {
        const flowId = pathname.split('/hub/api/flow-positions/')[1];
        return await handleFlowPositionsReset(flowId, env, corsHeaders);
      }

      // Render email template with case data
      if (pathname.match(/\/hub\/api\/email-templates\/\d+\/render$/) && request.method === 'POST') {
        const templateId = pathname.split('/hub/api/email-templates/')[1].replace('/render', '');
        return await handleHubEmailTemplateRender(templateId, request, env, corsHeaders);
      }

      // ============================================
      // HUB API - ACTIVITY LOGGING
      // ============================================
      // Log activity (for tracking team actions)
      if (pathname === '/hub/api/activity' && request.method === 'POST') {
        return await handleHubActivityLog(request, env, corsHeaders);
      }

      // ============================================
      // HUB API - UNIFIED SEARCH
      // ============================================
      // Universal search across cases, sessions, issues
      if (pathname === '/hub/api/search' && request.method === 'GET') {
        return await handleHubUnifiedSearch(request, env, corsHeaders);
      }

      // Serve Resolution Hub - handle all /hub/* routes (SPA fallback)
      // This must come AFTER all static assets and API routes
      if (pathname.startsWith('/hub')) {
        return await serveResolutionHub(env, corsHeaders);
      }

      // Admin setup endpoint (one-time use to create admin user)
      if (pathname === '/admin/setup' && request.method === 'POST') {
        return await handleAdminSetup(request, env, corsHeaders);
      }

      // ============================================
      // POSTHOG PROXY (bypass ad blockers)
      // ============================================

      // Proxy PostHog script
      if (pathname === '/ph/array.js') {
        const response = await fetch('https://us-assets.i.posthog.com/static/array.js');
        return new Response(response.body, {
          headers: {
            'Content-Type': 'application/javascript',
            'Cache-Control': 'public, max-age=3600',
            ...corsHeaders
          }
        });
      }

      // Proxy PostHog ingest (events, recordings, decide, etc.)
      if (pathname.startsWith('/ph/')) {
        const posthogPath = pathname.replace('/ph/', '');
        const posthogUrl = `https://us.i.posthog.com/${posthogPath}${url.search}`;

        // Read body as arrayBuffer to preserve binary/compressed data
        const requestBody = request.method !== 'GET' && request.method !== 'HEAD'
          ? await request.arrayBuffer()
          : undefined;

        // Forward request with necessary headers for PostHog
        const headers = new Headers();

        // Copy all content-related headers
        const contentType = request.headers.get('Content-Type');
        if (contentType) headers.set('Content-Type', contentType);

        // Critical: Forward Content-Encoding for gzip compressed data
        const contentEncoding = request.headers.get('Content-Encoding');
        if (contentEncoding) headers.set('Content-Encoding', contentEncoding);

        const response = await fetch(posthogUrl, {
          method: request.method,
          headers: headers,
          body: requestBody,
        });

        // Forward the response with CORS headers
        const responseHeaders = new Headers(response.headers);
        responseHeaders.set('Access-Control-Allow-Origin', '*');
        responseHeaders.set('Access-Control-Allow-Methods', 'GET, POST, OPTIONS');
        responseHeaders.set('Access-Control-Allow-Headers', 'Content-Type, Content-Encoding');

        return new Response(response.body, {
          status: response.status,
          headers: responseHeaders
        });
      }

      // 404 for unknown routes
      return Response.json({ error: 'Not found' }, { status: 404, headers: corsHeaders });

    } catch (error) {
      console.error('Worker error:', error);
      return Response.json({ error: 'Internal server error' }, { status: 500, headers: corsHeaders });
    }
  }
};

// ============================================
// SHOPIFY ORDER LOOKUP
// ============================================
async function handleLookupOrder(request, env, corsHeaders) {
  const { email, phone, firstName, lastName, orderNumber, address1, country, deepSearch } = await request.json();

  let orders = [];

  // For phone number searches, use the two-step approach:
  // 1. First search for customers by phone number (using query parameter)
  // 2. Then query orders using the customer IDs
  if (phone && !email && !deepSearch) {
    const cleanPhone = cleanPhoneNumber(phone);
    const searchPhoneLast10 = cleanPhone.slice(-10);
    const searchPhone = cleanPhone;
    const searchPhoneWithout1 = searchPhone.startsWith('1') && searchPhone.length >= 11 
      ? searchPhone.slice(1) 
      : searchPhone;
    
    console.log(`[Phone Lookup] Searching for phone: ${phone}, cleaned: ${cleanPhone}, last10: ${searchPhoneLast10}`);
    
    // Step 1: Search for customers by phone number
    // Use the customers/search.json endpoint which supports phone search
    // Try multiple query formats to maximize chances of finding customers
    const customerQueries = [
      searchPhoneLast10,                    // Just the digits (201522-0159 -> 2015220159)
      `+1${searchPhoneLast10}`,             // With +1 prefix
      phone,                                 // Original phone as provided
    ];
    
    let matchingCustomerIds = [];
    
    try {
      // Try each query format using the search endpoint
      for (const customerQuery of customerQueries) {
        // Use /customers/search.json endpoint
        const customerSearchUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/customers/search.json?query=${encodeURIComponent(customerQuery)}&limit=250`;
        
        console.log(`[Phone Lookup] Trying customer search with query: "${customerQuery}"`);
        
        const customerResponse = await fetch(customerSearchUrl, {
          headers: {
            'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
            'Content-Type': 'application/json',
          },
        });

        if (customerResponse.ok) {
          const customerData = await customerResponse.json();
          const customers = customerData.customers || [];
          console.log(`[Phone Lookup] Query "${customerQuery}" returned ${customers.length} customers`);
          
          // Filter customers to ensure phone number matches
          const newCustomerIds = customers
            .filter(customer => {
              const customerPhone = cleanPhoneNumber(customer.phone || '');
              const matches = customerPhone === searchPhone ||
                     customerPhone === searchPhoneWithout1 ||
                     customerPhone.slice(-10) === searchPhoneLast10;
              if (matches) {
                console.log(`[Phone Lookup] Customer ${customer.id} matches - phone: ${customer.phone}`);
              }
              return matches;
            })
            .map(customer => customer.id);
          
          matchingCustomerIds = [...new Set([...matchingCustomerIds, ...newCustomerIds])]; // Deduplicate
        } else {
          console.log(`[Phone Lookup] Query "${customerQuery}" failed with status: ${customerResponse.status}`);
        }
      }
      
      console.log(`[Phone Lookup] Found ${matchingCustomerIds.length} matching customers for phone: ${phone}`);
      
      // Step 2: Query orders for these customer IDs
      if (matchingCustomerIds.length > 0) {
        // Build query with customer IDs
        const customerIdQueries = matchingCustomerIds.map(id => `customer_id:${id}`).join(' OR ');
        let query = `(${customerIdQueries})`;
        
        if (orderNumber) {
          query += ` name:#${orderNumber.replace('#', '').replace('P', '').replace('p', '')}`;
        }
        
        const ordersUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/orders.json?status=any&limit=250&query=${encodeURIComponent(query)}`;
        
        const ordersResponse = await fetch(ordersUrl, {
          headers: {
            'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
            'Content-Type': 'application/json',
          },
        });
        
        if (ordersResponse.ok) {
          const ordersData = await ordersResponse.json();
          orders = ordersData.orders || [];
          console.log(`[Phone Lookup] Found ${orders.length} orders for ${matchingCustomerIds.length} customers`);
        } else {
          console.error(`[Phone Lookup] Failed to fetch orders: ${ordersResponse.status}`);
        }
      } else {
        console.log(`[Phone Lookup] No matching customers found for phone: ${phone}, falling back to recent orders search`);
        
        // Fallback: Fetch recent orders and filter by phone number locally
        // This is more reliable than trying to use Shopify's unreliable phone query
        const fallbackUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/orders.json?status=any&limit=250`;
        
        try {
          const fallbackResponse = await fetch(fallbackUrl, {
            headers: {
              'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
              'Content-Type': 'application/json',
            },
          });
          
          if (fallbackResponse.ok) {
            const fallbackData = await fallbackResponse.json();
            let fallbackOrders = fallbackData.orders || [];
            console.log(`[Phone Lookup] Fetched ${fallbackOrders.length} recent orders for local filtering`);
            
            // Apply strict phone filtering to find matching orders
            const searchPhone = cleanPhoneNumber(phone);
            const searchPhoneLast10 = searchPhone.slice(-10);
            const searchPhoneWithout1 = searchPhone.startsWith('1') && searchPhone.length >= 11 
              ? searchPhone.slice(1) 
              : searchPhone;
            
            fallbackOrders = fallbackOrders.filter(order => {
              const orderPhone = cleanPhoneNumber(order.phone || '');
              const shippingPhone = cleanPhoneNumber(order.shipping_address?.phone || '');
              const billingPhone = cleanPhoneNumber(order.billing_address?.phone || '');
              const customerPhone = cleanPhoneNumber(order.customer?.phone || '');
              
              const matches = orderPhone === searchPhone ||
                     orderPhone === searchPhoneWithout1 ||
                     orderPhone.slice(-10) === searchPhoneLast10 ||
                     shippingPhone === searchPhone ||
                     shippingPhone === searchPhoneWithout1 ||
                     shippingPhone.slice(-10) === searchPhoneLast10 ||
                     billingPhone === searchPhone ||
                     billingPhone === searchPhoneWithout1 ||
                     billingPhone.slice(-10) === searchPhoneLast10 ||
                     customerPhone === searchPhone ||
                     customerPhone === searchPhoneWithout1 ||
                     customerPhone.slice(-10) === searchPhoneLast10;
              
              if (matches) {
                console.log(`[Phone Lookup] Order ${order.name} matches - phone fields: order=${order.phone}, shipping=${order.shipping_address?.phone}, customer=${order.customer?.phone}`);
              }
              
              return matches;
            });
            
            orders = fallbackOrders;
            console.log(`[Phone Lookup] After filtering, ${orders.length} orders match the phone number`);
          }
        } catch (fallbackError) {
          console.error('[Phone Lookup] Fallback search also failed:', fallbackError);
        }
      }
    } catch (error) {
      console.error('[Phone Lookup] Error in customer search:', error);
      return Response.json({ error: 'Phone lookup failed' }, { status: 500, headers: corsHeaders });
    }
  } else if (deepSearch && firstName && lastName && address1) {
    // Deep search mode: Search customers by name, then get their orders
    // Shopify REST API doesn't support complex field queries on orders
    console.log(`[Deep Search] Searching for customer: ${firstName} ${lastName}, address: ${address1}`);
    
    try {
      // Search customers by name using the query parameter
      const customerQuery = `${firstName} ${lastName}`;
      const customerSearchUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/customers/search.json?query=${encodeURIComponent(customerQuery)}&limit=250`;
      
      const customerResponse = await fetch(customerSearchUrl, {
        headers: {
          'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
          'Content-Type': 'application/json',
        },
      });
      
      if (customerResponse.ok) {
        const customerData = await customerResponse.json();
        const customers = customerData.customers || [];
        console.log(`[Deep Search] Found ${customers.length} customers matching "${customerQuery}"`);
        
        // Filter customers by name match
        const searchFirstName = firstName.toLowerCase().trim();
        const searchLastName = lastName.toLowerCase().trim();
        
        const matchingCustomerIds = customers
          .filter(customer => {
            const custFirstName = (customer.first_name || '').toLowerCase().trim();
            const custLastName = (customer.last_name || '').toLowerCase().trim();
            return custFirstName === searchFirstName && custLastName === searchLastName;
          })
          .map(customer => customer.id);
        
        console.log(`[Deep Search] ${matchingCustomerIds.length} customers have exact name match`);
        
        // Get orders for matching customers
        if (matchingCustomerIds.length > 0) {
          const customerIdQueries = matchingCustomerIds.map(id => `customer_id:${id}`).join(' OR ');
          const ordersQuery = `(${customerIdQueries})`;
          const ordersUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/orders.json?status=any&limit=250&query=${encodeURIComponent(ordersQuery)}`;
          
          const ordersResponse = await fetch(ordersUrl, {
            headers: {
              'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
              'Content-Type': 'application/json',
            },
          });
          
          if (ordersResponse.ok) {
            const ordersData = await ordersResponse.json();
            orders = ordersData.orders || [];
            console.log(`[Deep Search] Found ${orders.length} orders for matching customers`);
          }
        }
        
        // If no customers found via search, try alternate approach: search all recent orders
        if (orders.length === 0) {
          console.log(`[Deep Search] No orders via customer search, trying direct order search...`);
          // Get recent orders and filter locally (fallback approach)
          const fallbackUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/orders.json?status=any&limit=250`;
          
          const fallbackResponse = await fetch(fallbackUrl, {
            headers: {
              'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
              'Content-Type': 'application/json',
            },
          });
          
          if (fallbackResponse.ok) {
            const fallbackData = await fallbackResponse.json();
            orders = fallbackData.orders || [];
            console.log(`[Deep Search] Fallback fetched ${orders.length} recent orders to filter locally`);
          }
        }
      } else {
        console.error(`[Deep Search] Customer search failed with status: ${customerResponse.status}`);
        // Fallback to getting recent orders
        const fallbackUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/orders.json?status=any&limit=250`;
        const fallbackResponse = await fetch(fallbackUrl, {
          headers: {
            'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
            'Content-Type': 'application/json',
          },
        });
        
        if (fallbackResponse.ok) {
          const fallbackData = await fallbackResponse.json();
          orders = fallbackData.orders || [];
          console.log(`[Deep Search] Fallback fetched ${orders.length} recent orders`);
        }
      }
    } catch (error) {
      console.error('[Deep Search] Error:', error);
    }
  } else {
    // Standard lookup: email only
    let query = '';
    
    if (email) {
      query = `email:${email}`;
    }

    if (orderNumber) {
      query += ` name:#${orderNumber.replace('#', '').replace('P', '').replace('p', '')}`;
    }
    
    console.log(`[Email Lookup] Query: ${query}`);

    const shopifyUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/orders.json?status=any&limit=50&query=${encodeURIComponent(query)}`;

    const response = await fetch(shopifyUrl, {
      headers: {
        'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      return Response.json({ error: 'Shopify lookup failed' }, { status: 500, headers: corsHeaders });
    }

    const data = await response.json();
    orders = data.orders || [];
    console.log(`[Email Lookup] Found ${orders.length} orders`);
  }

  // For phone number searches, apply name filtering if provided
  // (Phone matching is already handled by customer search, so we just filter by name here)
  if (phone && !email && !deepSearch && orders.length > 0 && (firstName || lastName)) {
    orders = orders.filter(order => {
      const addr = order.shipping_address || order.billing_address;
      if (!addr) return true; // Include orders without address if phone matched
      
      // Filter by first name if provided
      if (firstName) {
        const orderFirstName = (addr.first_name || order.customer?.first_name || '').toLowerCase().trim();
        const searchFirstName = firstName.toLowerCase().trim();
        // Allow partial match (e.g., "Daniel" matches "Daniel Bell") or exact match
        if (orderFirstName && searchFirstName && 
            orderFirstName !== searchFirstName && 
            !orderFirstName.startsWith(searchFirstName) && 
            !searchFirstName.startsWith(orderFirstName)) {
          // Name doesn't match - exclude this order
          return false;
        }
      }
      
      // Filter by last name if provided
      if (lastName) {
        const orderLastName = (addr.last_name || order.customer?.last_name || '').toLowerCase().trim();
        const searchLastName = lastName.toLowerCase().trim();
        if (orderLastName && searchLastName && 
            orderLastName !== searchLastName && 
            !orderLastName.startsWith(searchLastName) && 
            !searchLastName.startsWith(orderLastName)) {
          // Last name doesn't match - exclude this order
          return false;
        }
      }
      
      return true;
    });
  }

  // For deep search, apply strict filtering
  if (deepSearch && orders.length > 0) {
    const searchFirstName = firstName?.toLowerCase().trim();
    const searchLastName = lastName?.toLowerCase().trim();
    const searchAddress = address1?.toLowerCase().trim();
    const searchCountryName = country ? getCountryNameFromCode(country)?.toLowerCase() : null;

    orders = orders.filter(order => {
      const addr = order.shipping_address;
      if (!addr) return false;

      // EXACT match on first name (case insensitive)
      const orderFirstName = (addr.first_name || '').toLowerCase().trim();
      if (orderFirstName !== searchFirstName) return false;

      // EXACT match on last name (case insensitive)
      const orderLastName = (addr.last_name || '').toLowerCase().trim();
      if (orderLastName !== searchLastName) return false;

      // EXACT match on country (case insensitive)
      if (searchCountryName) {
        const orderCountry = (addr.country || '').toLowerCase().trim();
        if (orderCountry !== searchCountryName) return false;
      }

      // FUZZY match on address - check if key parts match
      if (searchAddress) {
        const orderAddress = (addr.address1 || '').toLowerCase();

        // Extract significant parts (numbers and words > 2 chars)
        const searchParts = searchAddress.split(/[\s,]+/).filter(p => p.length > 1);

        // Check how many parts match
        let matchCount = 0;
        for (const part of searchParts) {
          if (orderAddress.includes(part)) {
            matchCount++;
          }
        }

        // Require at least 40% of parts to match for fuzzy address
        const matchRatio = searchParts.length > 0 ? matchCount / searchParts.length : 0;
        if (matchRatio < 0.4) return false;
      }

      return true;
    });
  }

  // Process orders - extract line items with images and product type
  const processedOrders = await Promise.all(orders.map(async (order) => {
    const lineItems = await processLineItems(order.line_items, env);

    // Try to extract clientOrderId from order data first
    let clientOrderId = extractClientOrderId(order);

    // If not found, try fetching from order metafields (separate API call)
    if (!clientOrderId) {
      clientOrderId = await fetchClientOrderIdFromMetafields(order.id, env);
    }

    // Calculate fulfillment window (backend enforcement)
    const orderDate = new Date(order.created_at);
    const now = new Date();
    const hoursSinceOrder = (now.getTime() - orderDate.getTime()) / (1000 * 60 * 60);
    const isUnfulfilled = !order.fulfillment_status || order.fulfillment_status === 'null';
    const withinFulfillmentWindow = hoursSinceOrder < POLICY_CONFIG.fulfillmentCutoffHours;

    // canModify = unfulfilled AND within 10-hour window
    const canModify = isUnfulfilled && withinFulfillmentWindow;
    const hoursUntilFulfillment = withinFulfillmentWindow
      ? Math.max(0, POLICY_CONFIG.fulfillmentCutoffHours - hoursSinceOrder)
      : 0;

    // Fetch tracking status from ParcelPanel
    let trackingInfo = null;
    try {
      const trackingUrl = `https://open.parcelpanel.com/api/v2/tracking/order?order_number=${encodeURIComponent(order.name)}`;
      const trackingResponse = await fetch(trackingUrl, {
        method: 'GET',
        headers: {
          'x-parcelpanel-api-key': env.PARCELPANEL_API_KEY,
          'Content-Type': 'application/json',
        },
      });
      
      if (trackingResponse.ok) {
        const trackingData = await trackingResponse.json();
        const shipments = trackingData?.order?.shipments || [];
        
        if (shipments.length > 0) {
          const shipment = shipments[0]; // Primary shipment
          const statusMap = {
            1: 'pending',
            2: 'info_received',
            3: 'in_transit',
            4: 'in_transit',
            5: 'out_for_delivery',
            6: 'delivered',
            7: 'failed_attempt',
            8: 'exception',
            9: 'expired',
            10: 'pickup'
          };
          
          let status = statusMap[shipment.status];
          if (!status) {
            const labelNormalized = (shipment.status_label || '').toLowerCase().replace(/\s+/g, '_');
            if (labelNormalized.includes('pickup') || labelNormalized.includes('ready_for')) {
              status = 'pickup';
            } else if (labelNormalized.includes('delivered')) {
              status = 'delivered';
            } else if (labelNormalized.includes('transit') || labelNormalized.includes('shipped')) {
              status = 'in_transit';
            } else if (labelNormalized.includes('out_for_delivery')) {
              status = 'out_for_delivery';
            } else {
              status = labelNormalized || 'unknown';
            }
          }
          
          trackingInfo = {
            status: status,
            statusLabel: shipment.status_label || formatStatusLabel(status),
            trackingNumber: shipment.tracking_number,
            carrier: shipment.carrier?.name || shipment.carrier?.code || 'Unknown',
            deliveryDate: shipment.delivery_date,
            estimatedDelivery: shipment.estimated_delivery_date,
            lastUpdate: shipment.checkpoints?.[0]?.checkpoint_time || null,
            location: shipment.checkpoints?.[0]?.location || null
          };
        }
      }
    } catch (trackingError) {
      console.error(`[Tracking] Error fetching tracking for order ${order.name}:`, trackingError);
    }

    // Build items summary for display
    const itemsSummary = lineItems.slice(0, 3).map(item => {
      const qty = item.quantity > 1 ? `${item.quantity}x ` : '';
      const title = item.variantTitle ? `${item.title} (${item.variantTitle})` : item.title;
      // Truncate long titles
      const shortTitle = title.length > 30 ? title.substring(0, 30) + '...' : title;
      return `${qty}${shortTitle}`;
    });
    if (lineItems.length > 3) {
      itemsSummary.push(`+${lineItems.length - 3} more`);
    }

    return {
      id: order.id,
      orderNumber: order.name,
      email: order.email,
      phone: order.phone,
      createdAt: order.created_at,
      financialStatus: order.financial_status,
      fulfillmentStatus: order.fulfillment_status,
      totalPrice: order.total_price,
      currency: order.currency,
      customerName: `${order.billing_address?.first_name || ''} ${order.billing_address?.last_name || ''}`.trim(),
      customerFirstName: order.billing_address?.first_name || order.customer?.first_name || '',
      customerLastName: order.billing_address?.last_name || order.customer?.last_name || '',
      shippingAddress: order.shipping_address,
      billingAddress: order.billing_address,
      lineItems,
      itemsSummary, // New: condensed items list for display
      itemsCount: lineItems.length,
      clientOrderId,
      orderUrl: `https://${env.SHOPIFY_STORE}/admin/orders/${order.id}`,
      // Tracking info from ParcelPanel
      tracking: trackingInfo,
      // Fulfillment window fields (backend-enforced)
      canModify,                    // true if order can be changed/cancelled
      hoursUntilFulfillment,        // hours remaining in window
      hoursSinceOrder,              // for debugging/display
    };
  }));

  return Response.json({ orders: processedOrders }, { headers: corsHeaders });
}

// Helper function to format tracking status label
function formatStatusLabel(status) {
  const labels = {
    'pending': 'Pending',
    'info_received': 'Info Received',
    'in_transit': 'In Transit',
    'out_for_delivery': 'Out for Delivery',
    'delivered': 'Delivered',
    'failed_attempt': 'Delivery Failed',
    'exception': 'Exception',
    'expired': 'Expired',
    'pickup': 'Ready for Pickup',
    'unknown': 'Unknown'
  };
  return labels[status] || status;
}

// Note: processLineItems, extractClientOrderId, fetchClientOrderIdFromMetafields
// are imported from ./services/shopify.js

// ============================================
// PARCEL PANEL TRACKING (API v2)
// ============================================
async function handleTracking(request, env, corsHeaders) {
  try {
    const { orderNumber, trackingNumber } = await request.json();

    if (!orderNumber && !trackingNumber) {
      return Response.json({ tracking: null, message: 'No identifier provided' }, { headers: corsHeaders });
    }

    // Use ParcelPanel API v2 endpoint
    // Docs: https://docs.parcelpanel.com/shopify/api-webhook/api-v2/
    let url = 'https://open.parcelpanel.com/api/v2/tracking/order?';

    if (orderNumber) {
      // Keep the # in order number as ParcelPanel expects it
      const orderNum = orderNumber.startsWith('#') ? orderNumber : `#${orderNumber}`;
      url += `order_number=${encodeURIComponent(orderNum)}`;
    } else if (trackingNumber) {
      url = `https://open.parcelpanel.com/api/v2/tracking?tracking_number=${encodeURIComponent(trackingNumber)}`;
    }

    const response = await fetch(url, {
      method: 'GET',
      headers: {
        'x-parcelpanel-api-key': env.PARCELPANEL_API_KEY,
        'Content-Type': 'application/json',
      },
    });

    if (!response.ok) {
      console.error('ParcelPanel API error:', response.status, await response.text());
      return Response.json({ tracking: null, message: 'Tracking lookup failed' }, { headers: corsHeaders });
    }

    const data = await response.json();

    // ParcelPanel v2 returns { order: { shipments: [...] } }
    const shipments = data?.order?.shipments || [];

    if (shipments.length === 0) {
      return Response.json({ tracking: null, message: 'No tracking found' }, { headers: corsHeaders });
    }

    // Process all shipments
    const trackingResults = shipments.map(shipment => {
      const checkpoints = shipment.checkpoints || [];

      // Map numeric status to string status
      const statusMap = {
        1: 'pending',
        2: 'info_received',
        3: 'in_transit',
        4: 'in_transit',
        5: 'out_for_delivery',
        6: 'delivered',
        7: 'failed_attempt',
        8: 'exception',
        9: 'expired',
        10: 'pickup'
      };

      const statusCode = shipment.status;
      let status = statusMap[statusCode];

      // If no numeric mapping, try to normalize string status
      if (!status) {
        const labelNormalized = (shipment.status_label || '').toLowerCase().replace(/\s+/g, '_');
        // Map common string variations to our standard status codes
        if (labelNormalized.includes('pickup') || labelNormalized.includes('ready_for')) {
          status = 'pickup';
        } else if (labelNormalized.includes('exception') || labelNormalized.includes('problem')) {
          status = 'exception';
        } else if (labelNormalized.includes('delivered')) {
          status = 'delivered';
        } else if (labelNormalized.includes('transit') || labelNormalized.includes('shipped')) {
          status = 'in_transit';
        } else if (labelNormalized.includes('out_for_delivery')) {
          status = 'out_for_delivery';
        } else {
          status = labelNormalized || 'unknown';
        }
      }

      return {
        trackingNumber: shipment.tracking_number,
        carrier: shipment.carrier?.name || shipment.carrier?.code || 'Unknown',
        carrierCode: shipment.carrier?.code,
        carrierLogo: shipment.carrier?.logo_url,
        carrierUrl: shipment.carrier?.url,
        status: status,
        statusLabel: shipment.status_label || formatTrackingStatus(status),
        substatus: shipment.substatus,
        substatusLabel: shipment.substatus_label,
        deliveryDate: shipment.delivery_date,
        estimatedDelivery: shipment.estimated_delivery_date,
        daysInTransit: shipment.transit_time || 0,
        orderDate: shipment.order_date,
        fulfillmentDate: shipment.fulfillment_date,
        lastMile: shipment.last_mile,
        // Return ALL checkpoints with full details for pickup location parsing
        checkpoints: checkpoints.map(cp => ({
          checkpoint_time: cp.checkpoint_time,
          message: cp.message || cp.detail,
          detail: cp.detail,
          location: cp.location,
          tag: cp.tag,
          status: cp.status,
          substatus: cp.substatus,
          substatus_label: cp.substatus_label
        })),
        lastUpdate: checkpoints[0]?.checkpoint_time || null
      };
    });

    return Response.json({
      tracking: trackingResults[0],
      allTracking: trackingResults
    }, { headers: corsHeaders });

  } catch (error) {
    console.error('Tracking error:', error);
    return Response.json({ tracking: null, message: 'Tracking lookup error' }, { headers: corsHeaders });
  }
}

// Note: formatTrackingStatus is imported from ./utils/formatters.js
// Note: getCountryNameFromCode is imported from ./services/shopify.js

// ============================================
// 90-DAY GUARANTEE VALIDATION
// ============================================
async function handleValidateGuarantee(request, env, corsHeaders) {
  const { orderNumber, orderCreatedAt } = await request.json();

  if (!orderNumber && !orderCreatedAt) {
    return Response.json({
      error: 'orderNumber or orderCreatedAt required'
    }, { status: 400, headers: corsHeaders });
  }

  let referenceDate = null;
  let usedFallback = false;
  let deliverySource = null;

  // Step 1: Try to get delivery date from ParcelPanel
  if (orderNumber) {
    try {
      const cleanOrder = orderNumber.replace('#', '');
      const url = `https://api.parcelpanel.com/api/v3/parcels?order_number=${encodeURIComponent(cleanOrder)}`;

      const response = await fetch(url, {
        headers: {
          'Authorization': `Bearer ${env.PARCELPANEL_API_KEY}`,
          'Content-Type': 'application/json',
        },
      });

      if (response.ok) {
        const data = await response.json();
        const parcels = data.data || [];

        // Look for delivered parcel with delivery_date
        for (const parcel of parcels) {
          if (parcel.delivery_date && parcel.delivery_status === 'delivered') {
            referenceDate = new Date(parcel.delivery_date);
            deliverySource = 'parcelpanel_delivery';
            break;
          }
        }

        // If no delivery date but we have checkpoints, use the delivered checkpoint
        if (!referenceDate) {
          for (const parcel of parcels) {
            if (parcel.delivery_status === 'delivered' && parcel.checkpoints?.length > 0) {
              // Find the delivered checkpoint
              const deliveredCheckpoint = parcel.checkpoints.find(cp =>
                cp.tag === 'Delivered' || cp.substatus === 'delivered'
              );
              if (deliveredCheckpoint?.checkpoint_time) {
                referenceDate = new Date(deliveredCheckpoint.checkpoint_time);
                deliverySource = 'parcelpanel_checkpoint';
                break;
              }
            }
          }
        }
      }
    } catch (error) {
      console.error('ParcelPanel lookup error:', error);
    }
  }

  // Step 2: Fallback to order created date
  if (!referenceDate && orderCreatedAt) {
    referenceDate = new Date(orderCreatedAt);
    usedFallback = true;
    deliverySource = 'order_created_fallback';
  }

  // If we still don't have a date, return error
  if (!referenceDate) {
    return Response.json({
      eligible: false,
      error: 'Could not determine order date',
      daysRemaining: 0,
      usedFallback: true,
      deliverySource: null
    }, { headers: corsHeaders });
  }

  // Calculate days since delivery/order
  const now = new Date();
  const daysSince = Math.floor((now - referenceDate) / (1000 * 60 * 60 * 24));
  const daysRemaining = Math.max(0, POLICY_CONFIG.guaranteeDays - daysSince);
  const eligible = daysSince <= POLICY_CONFIG.guaranteeDays;

  return Response.json({
    eligible,
    daysSince,
    daysRemaining,
    usedFallback,
    deliverySource,
    referenceDate: referenceDate.toISOString(),
    guaranteeDays: POLICY_CONFIG.guaranteeDays
  }, { headers: corsHeaders });
}

// ============================================
// CHECKOUTCHAMP SUBSCRIPTION
// ============================================
async function handleSubscription(request, env, corsHeaders) {
  const { clientOrderId, email } = await request.json();

  console.log('Subscription lookup - clientOrderId:', clientOrderId, 'email:', email);

  try {
    let subscriptionData = null;

    // Method 1: If clientOrderId provided directly, use it
    if (clientOrderId) {
      console.log('Trying subscription lookup by provided clientOrderId:', clientOrderId);
      subscriptionData = await checkSubscriptionStatus(clientOrderId, env);
    }

    // Method 2: If no subscription found and email provided, search Shopify first
    // CORRECT FLOW: Email â†’ Shopify â†’ clientOrderId â†’ CheckoutChamp
    if ((!subscriptionData || !subscriptionData.isSubscription) && email) {
      console.log('Searching Shopify for orders with email:', email);
      subscriptionData = await findSubscriptionViaShopify(email, env);
    }

    if (!subscriptionData || !subscriptionData.isSubscription) {
      return Response.json({
        subscriptions: [],
        isSubscription: false,
        message: 'No subscription found'
      }, { headers: corsHeaders });
    }

    // Return subscription as array for frontend compatibility
    return Response.json({
      subscriptions: [{
        purchaseId: subscriptionData.purchaseId,
        productName: subscriptionData.subscriptionProductName || 'Subscription',
        productSku: subscriptionData.subscriptionProductSku || '',
        status: subscriptionData.subscriptionStatus || 'UNKNOWN',
        nextBillingDate: subscriptionData.nextBillDate,
        lastBillingDate: subscriptionData.currentBillDate,
        frequency: subscriptionData.billFrequency || 30,
        cycleNumber: subscriptionData.cycleNumber || 1,
        price: subscriptionData.price || '0.00',
        clientOrderId: subscriptionData.checkoutChampOrderId || clientOrderId
      }],
      isSubscription: true
    }, { headers: corsHeaders });

  } catch (error) {
    console.error('Subscription lookup error:', error);
    return Response.json({
      subscriptions: [],
      error: 'Subscription lookup failed: ' + error.message,
      isSubscription: false
    }, { status: 500, headers: corsHeaders });
  }
}

// CORRECT FLOW: Email â†’ Shopify â†’ clientOrderId â†’ CheckoutChamp
async function findSubscriptionViaShopify(email, env) {
  const result = {
    isSubscription: false,
    checkoutChampOrderId: null,
    subscriptionStatus: null,
    nextBillDate: null,
    currentBillDate: null,
    billFrequency: null,
    cycleNumber: null,
    purchaseId: null,
    subscriptionProductSku: null,
    subscriptionProductName: null,
    price: null
  };

  if (!email) {
    console.log('No email provided for subscription lookup');
    return result;
  }

  try {
    // Step 1: Query Shopify for orders with this email
    const shopifyUrl = `https://${env.SHOPIFY_STORE}/admin/api/2024-01/orders.json?status=any&limit=50&query=email:${encodeURIComponent(email)}`;

    console.log('Querying Shopify for orders with email:', email);

    const shopifyResponse = await fetch(shopifyUrl, {
      headers: {
        'X-Shopify-Access-Token': env.SHOPIFY_API_KEY,
        'Content-Type': 'application/json'
      }
    });

    if (!shopifyResponse.ok) {
      console.error('Shopify order query failed:', shopifyResponse.status);
      return result;
    }

    const shopifyData = await shopifyResponse.json();
    const orders = shopifyData.orders || [];

    console.log('Found', orders.length, 'Shopify orders for email:', email);

    if (orders.length === 0) {
      console.log('No Shopify orders found for email');
      return result;
    }

    // Step 2: For each Shopify order, try to find clientOrderId and check for subscription
    for (const order of orders) {
      console.log('Checking Shopify order:', order.name, 'id:', order.id);

      // Try to extract clientOrderId from order data
      let clientOrderId = extractClientOrderId(order);

      // If not found in order data, try metafields
      if (!clientOrderId) {
        clientOrderId = await fetchClientOrderIdFromMetafields(order.id, env);
      }

      if (!clientOrderId) {
        console.log('No clientOrderId found in Shopify order:', order.name);
        continue;
      }

      console.log('Found clientOrderId:', clientOrderId, 'in Shopify order:', order.name);

      // Step 3: Query CheckoutChamp with this clientOrderId
      const subscriptionData = await checkSubscriptionStatus(clientOrderId, env);

      if (subscriptionData.isSubscription) {
        console.log('Found subscription for clientOrderId:', clientOrderId);
        return subscriptionData;
      }
    }

    console.log('No subscription found in any Shopify order for email:', email);
    return result;

  } catch (error) {
    console.error('Error finding subscription via Shopify:', error);
    return result;
  }
}

// Find subscription by searching CheckoutChamp with email
// CheckoutChamp API uses 'emailAddress' parameter, not 'email'
async function findSubscriptionByEmail(email, env) {
  const result = {
    isSubscription: false,
    checkoutChampOrderId: null,
    subscriptionStatus: null,
    nextBillDate: null,
    currentBillDate: null,
    billFrequency: null,
    cycleNumber: null,
    purchaseId: null,
    subscriptionProductSku: null,
    subscriptionProductName: null,
    price: null
  };

  if (!email) {
    console.log('No email provided for subscription lookup');
    return result;
  }

  console.log('Finding subscription by email:', email);

  try {
    // Method 1: Try customer/find to get customer ID first
    const customerFindUrl = `https://api.checkoutchamp.com/customer/find/?loginId=${encodeURIComponent(env.CC_API_USERNAME)}&password=${encodeURIComponent(env.CC_API_PASSWORD)}&emailAddress=${encodeURIComponent(email)}`;

    console.log('Calling CheckoutChamp customer/find');
    const customerResponse = await fetch(customerFindUrl);
    const customerResponseText = await customerResponse.text();
    console.log('CheckoutChamp customer/find response:', customerResponseText.substring(0, 1000));

    if (customerResponse.ok) {
      try {
        const customerData = JSON.parse(customerResponseText);

        // Check for success response
        if (customerData.result === 'SUCCESS' || customerData.message?.result === 'SUCCESS') {
          const customerId = customerData.message?.customerId || customerData.customerId;

          if (customerId) {
            console.log('Found customerId:', customerId);

            // Now query purchases for this customer
            const purchaseByCustomerUrl = `https://api.checkoutchamp.com/purchase/query/?loginId=${encodeURIComponent(env.CC_API_USERNAME)}&password=${encodeURIComponent(env.CC_API_PASSWORD)}&customerId=${encodeURIComponent(customerId)}`;

            console.log('Calling CheckoutChamp purchase/query by customerId');
            const purchaseResponse = await fetch(purchaseByCustomerUrl);
            const purchaseResponseText = await purchaseResponse.text();
            console.log('CheckoutChamp purchase/query response:', purchaseResponseText.substring(0, 1000));

            if (purchaseResponse.ok) {
              const purchaseData = JSON.parse(purchaseResponseText);
              const subscriptionResult = extractSubscriptionFromPurchaseResponse(purchaseData);
              if (subscriptionResult.isSubscription) {
                return subscriptionResult;
              }
            }
          }
        }
      } catch (parseError) {
        console.log('Error parsing customer response:', parseError.message);
      }
    }

    // Method 2: Try purchase/query with emailAddress parameter
    const purchaseByEmailUrl = `https://api.checkoutchamp.com/purchase/query/?loginId=${encodeURIComponent(env.CC_API_USERNAME)}&password=${encodeURIComponent(env.CC_API_PASSWORD)}&emailAddress=${encodeURIComponent(email)}`;

    console.log('Calling CheckoutChamp purchase/query by emailAddress');
    const purchaseResponse = await fetch(purchaseByEmailUrl);
    const purchaseResponseText = await purchaseResponse.text();
    console.log('CheckoutChamp purchase/query by email response:', purchaseResponseText.substring(0, 1000));

    if (purchaseResponse.ok) {
      try {
        const purchaseData = JSON.parse(purchaseResponseText);
        const subscriptionResult = extractSubscriptionFromPurchaseResponse(purchaseData);
        if (subscriptionResult.isSubscription) {
          return subscriptionResult;
        }
      } catch (parseError) {
        console.log('Error parsing purchase response:', parseError.message);
      }
    }

    // Method 3: Try order/query with emailAddress
    const orderByEmailUrl = `https://api.checkoutchamp.com/order/query/?loginId=${encodeURIComponent(env.CC_API_USERNAME)}&password=${encodeURIComponent(env.CC_API_PASSWORD)}&emailAddress=${encodeURIComponent(email)}`;

    console.log('Calling CheckoutChamp order/query by emailAddress');
    const orderResponse = await fetch(orderByEmailUrl);
    const orderResponseText = await orderResponse.text();
    console.log('CheckoutChamp order/query by email response:', orderResponseText.substring(0, 1000));

    if (orderResponse.ok) {
      try {
        const orderData = JSON.parse(orderResponseText);
        let orders = orderData.message?.data || orderData.data || orderData;

        // Handle single object response
        if (orders && !Array.isArray(orders) && orders.orderId) {
          orders = [orders];
        }

        if (Array.isArray(orders) && orders.length > 0) {
          // Look through orders for one with a purchaseId (indicates subscription)
          for (const order of orders) {
            const purchaseId = order.purchaseId || order.purchase_id;
            const orderId = order.orderId || order.order_id;

            if (purchaseId) {
              console.log('Found order with purchaseId:', purchaseId, 'orderId:', orderId);
              return await checkSubscriptionStatus(orderId, env);
            }
          }

          // If no purchaseId found in orders, try querying each order
          for (const order of orders.slice(0, 5)) { // Limit to first 5 orders
            const orderId = order.orderId || order.order_id;
            if (orderId) {
              console.log('Checking order for subscription:', orderId);
              const subResult = await checkSubscriptionStatus(orderId, env);
              if (subResult.isSubscription) {
                return subResult;
              }
            }
          }
        }
      } catch (parseError) {
        console.log('Error parsing order response:', parseError.message);
      }
    }

    console.log('No subscription found by email after all methods');
    return result;

  } catch (error) {
    console.error('Error finding subscription by email:', error);
    return result;
  }
}

// Extract subscription data from CheckoutChamp purchase/query response
function extractSubscriptionFromPurchaseResponse(purchaseData) {
  const result = {
    isSubscription: false,
    checkoutChampOrderId: null,
    subscriptionStatus: null,
    nextBillDate: null,
    currentBillDate: null,
    billFrequency: null,
    cycleNumber: null,
    purchaseId: null,
    subscriptionProductSku: null,
    subscriptionProductName: null,
    price: null
  };

  // Handle wrapped response - check multiple locations
  let purchases = purchaseData.message?.data || purchaseData.data || purchaseData;

  // Check for error response
  if (purchaseData.result === 'ERROR' || purchaseData.message?.result === 'ERROR') {
    console.log('CheckoutChamp returned error:', purchaseData.message?.message || purchaseData.errorMessage);
    return result;
  }

  // Handle single object response
  if (purchases && !Array.isArray(purchases) && (purchases.purchaseId || purchases.id)) {
    purchases = [purchases];
  }

  // If it's an array, find ACTIVE subscription
  if (Array.isArray(purchases) && purchases.length > 0) {
    // Sort by dateCreated descending to get most recent first
    purchases.sort((a, b) => {
      const dateA = new Date(a.dateCreated || a.createdAt || 0);
      const dateB = new Date(b.dateCreated || b.createdAt || 0);
      return dateB - dateA;
    });

    // Find first ACTIVE subscription, or use first one
    let purchaseInfo = purchases.find(p =>
      p.status === 'ACTIVE' || p.purchaseStatus === 'ACTIVE'
    ) || purchases[0];

    result.isSubscription = true;
    result.purchaseId = purchaseInfo.purchaseId || purchaseInfo.purchase_id || purchaseInfo.id;
    result.checkoutChampOrderId = purchaseInfo.orderId || purchaseInfo.order_id;
    result.subscriptionStatus = purchaseInfo.status || purchaseInfo.purchaseStatus || 'Unknown';
    result.nextBillDate = purchaseInfo.nextBillDate || purchaseInfo.next_bill_date || null;
    result.currentBillDate = purchaseInfo.lastBillDate || purchaseInfo.last_bill_date || purchaseInfo.dateCreated || null;
    result.billFrequency = purchaseInfo.billingIntervalDays || purchaseInfo.frequency || purchaseInfo.billFrequency || null;
    result.cycleNumber = purchaseInfo.billingCycleNumber || purchaseInfo.cycleNumber || purchaseInfo.rebillDepth || null;
    result.subscriptionProductSku = purchaseInfo.productSku || null;
    result.subscriptionProductName = purchaseInfo.displayName || purchaseInfo.productName || null;
    result.price = purchaseInfo.price || purchaseInfo.amount || purchaseInfo.recurringPrice || null;

    console.log('Extracted subscription from purchase response:', JSON.stringify(result));
  }

  return result;
}

// Check subscription status - matches the working implementation exactly
async function checkSubscriptionStatus(clientOrderId, env) {
  const result = {
    isSubscription: false,
    checkoutChampOrderId: clientOrderId,
    subscriptionStatus: null,
    nextBillDate: null,
    currentBillDate: null,
    billFrequency: null,
    cycleNumber: null,
    purchaseId: null,
    subscriptionProductSku: null,
    subscriptionProductName: null,
    price: null
  };

  try {
    // Step 1: Query CheckoutChamp order to get purchaseId
    const orderQueryUrl = `https://api.checkoutchamp.com/order/query/?loginId=${encodeURIComponent(env.CC_API_USERNAME)}&password=${encodeURIComponent(env.CC_API_PASSWORD)}&orderId=${encodeURIComponent(clientOrderId)}`;

    console.log('Calling CheckoutChamp order query:', orderQueryUrl.replace(/password=[^&]+/, 'password=***'));

    const orderResponse = await fetch(orderQueryUrl);

    if (!orderResponse.ok) {
      console.error('CheckoutChamp order query failed:', orderResponse.status);
      return result;
    }

    const orderResponseText = await orderResponse.text();
    console.log('CheckoutChamp order response:', orderResponseText.substring(0, 800));

    let orderData;
    try {
      orderData = JSON.parse(orderResponseText);
    } catch (e) {
      console.error('Failed to parse order response:', e.message);
      return result;
    }

    // Handle wrapped response - data might be in message.data, data, or at root
    const orderInfo = orderData.message?.data || orderData.data || orderData;

    // Find purchaseId in 6 locations
    let purchaseId = null;

    // Method 1: Check top level
    purchaseId = orderInfo.purchaseId || orderInfo.purchase_id || orderInfo.subscriptionId || orderInfo.subscription_id;

    // Method 2: Check inside "items" array
    if (!purchaseId && orderInfo.items && Array.isArray(orderInfo.items)) {
      for (const item of orderInfo.items) {
        if (item.purchaseId || item.purchase_id) {
          purchaseId = item.purchaseId || item.purchase_id;
          break;
        }
      }
    }

    // Method 3: Check inside "products" array
    if (!purchaseId && orderInfo.products && Array.isArray(orderInfo.products)) {
      for (const product of orderInfo.products) {
        if (product.purchaseId || product.purchase_id) {
          purchaseId = product.purchaseId || product.purchase_id;
          break;
        }
      }
    }

    // Method 4: Check inside "purchases" array
    if (!purchaseId && orderInfo.purchases && Array.isArray(orderInfo.purchases)) {
      for (const purchase of orderInfo.purchases) {
        if (purchase.purchaseId || purchase.purchase_id || purchase.id) {
          purchaseId = purchase.purchaseId || purchase.purchase_id || purchase.id;
          break;
        }
      }
    }

    // Method 5: Check nested "order" object
    if (!purchaseId && orderInfo.order) {
      if (orderInfo.order.purchaseId) {
        purchaseId = orderInfo.order.purchaseId;
      }
      // Also check items inside nested order
      if (!purchaseId && orderInfo.order.items && Array.isArray(orderInfo.order.items)) {
        for (const item of orderInfo.order.items) {
          if (item.purchaseId || item.purchase_id) {
            purchaseId = item.purchaseId || item.purchase_id;
            break;
          }
        }
      }
    }

    // Method 6: Deep regex search as last resort
    if (!purchaseId) {
      const responseStr = JSON.stringify(orderInfo);
      const purchaseIdMatch = responseStr.match(/"purchaseId"\s*:\s*"?([A-Z0-9]+)"?/i);
      if (purchaseIdMatch) {
        purchaseId = purchaseIdMatch[1];
      }
    }

    // If no purchaseId found, it's NOT a subscription
    if (!purchaseId) {
      console.log('No purchaseId found in CheckoutChamp response - order is not a subscription');
      return result;
    }

    console.log('Found purchaseId:', purchaseId);
    result.isSubscription = true;
    result.purchaseId = purchaseId;

    // Step 2: Query purchase/subscription details
    const purchaseQueryUrl = `https://api.checkoutchamp.com/purchase/query/?loginId=${encodeURIComponent(env.CC_API_USERNAME)}&password=${encodeURIComponent(env.CC_API_PASSWORD)}&purchaseId=${encodeURIComponent(purchaseId)}`;

    console.log('Calling CheckoutChamp purchase query for purchaseId:', purchaseId);

    const purchaseResponse = await fetch(purchaseQueryUrl);

    if (!purchaseResponse.ok) {
      console.error('CheckoutChamp purchase query failed:', purchaseResponse.status);
      return result;
    }

    const purchaseResponseText = await purchaseResponse.text();
    console.log('CheckoutChamp purchase response:', purchaseResponseText.substring(0, 800));

    let purchaseData;
    try {
      purchaseData = JSON.parse(purchaseResponseText);
    } catch (e) {
      console.error('Failed to parse purchase response:', e.message);
      return result;
    }

    // Handle wrapped response - data might be in message.data, data, or at root
    // IMPORTANT: data is often an ARRAY, get first element
    let purchaseInfo = purchaseData.message?.data || purchaseData.data || purchaseData;

    if (Array.isArray(purchaseInfo)) {
      if (purchaseInfo.length > 0) {
        purchaseInfo = purchaseInfo[0];
      } else {
        console.log('Purchase query returned empty array');
        return result;
      }
    }

    // Extract subscription details
    result.subscriptionStatus = purchaseInfo.status || purchaseInfo.purchaseStatus || 'Unknown';
    result.nextBillDate = purchaseInfo.nextBillDate || purchaseInfo.next_bill_date || null;
    result.currentBillDate = purchaseInfo.lastBillDate || purchaseInfo.last_bill_date || purchaseInfo.dateCreated || purchaseInfo.createdAt || null;
    result.billFrequency = purchaseInfo.billingIntervalDays || purchaseInfo.frequency || purchaseInfo.billFrequency || purchaseInfo.bill_frequency || null;
    result.cycleNumber = purchaseInfo.billingCycleNumber || purchaseInfo.cycleNumber || purchaseInfo.cycle_number || purchaseInfo.rebillDepth || null;
    result.subscriptionProductSku = purchaseInfo.productSku || null;
    result.subscriptionProductName = purchaseInfo.displayName || purchaseInfo.productName || null;
    result.price = purchaseInfo.price || purchaseInfo.amount || purchaseInfo.recurringPrice || null;

    console.log('Subscription data extracted:', JSON.stringify(result));

    return result;

  } catch (error) {
    console.error('Error in checkSubscriptionStatus:', error);
    return result;
  }
}

function findPurchaseIdInOrder(order) {
  if (!order) return null;

  // 1. Top-level fields
  if (order.purchaseId) return order.purchaseId;
  if (order.purchase_id) return order.purchase_id;
  if (order.subscriptionId) return order.subscriptionId;
  if (order.subscription_id) return order.subscription_id;

  // 2. Inside items[] array
  if (Array.isArray(order.items)) {
    for (const item of order.items) {
      if (item.purchaseId) return item.purchaseId;
      if (item.purchase_id) return item.purchase_id;
      if (item.subscriptionId) return item.subscriptionId;
    }
  }

  // 3. Inside products[] array
  if (Array.isArray(order.products)) {
    for (const product of order.products) {
      if (product.purchaseId) return product.purchaseId;
      if (product.purchase_id) return product.purchase_id;
      if (product.subscriptionId) return product.subscriptionId;
    }
  }

  // 4. Inside purchases[] array
  if (Array.isArray(order.purchases)) {
    for (const purchase of order.purchases) {
      if (purchase.purchaseId) return purchase.purchaseId;
      if (purchase.purchase_id) return purchase.purchase_id;
      if (purchase.id) return purchase.id;
    }
  }

  // 5. Nested order object
  if (order.order) {
    const nestedId = findPurchaseIdInOrder(order.order);
    if (nestedId) return nestedId;
  }

  // 6. Deep regex search of entire response (last resort) - alphanumeric IDs
  try {
    const jsonStr = JSON.stringify(order);
    const purchaseMatch = jsonStr.match(/"purchaseId"\s*:\s*"?([A-Z0-9]+)"?/i);
    if (purchaseMatch) return purchaseMatch[1];

    const subscriptionMatch = jsonStr.match(/"subscriptionId"\s*:\s*"?([A-Z0-9]+)"?/i);
    if (subscriptionMatch) return subscriptionMatch[1];
  } catch (e) {
    // Ignore JSON stringify errors
  }

  return null;
}

// Get subscription details from Purchase Query API
async function getSubscriptionDetails(env, purchaseId, orderData) {
  const purchaseUrl = `https://api.checkoutchamp.com/purchase/query/?loginId=${encodeURIComponent(env.CC_API_USERNAME)}&password=${encodeURIComponent(env.CC_API_PASSWORD)}&purchaseId=${encodeURIComponent(purchaseId)}`;

  const purchaseResponse = await fetch(purchaseUrl, {
    method: 'GET',
    headers: { 'Content-Type': 'application/json' }
  });

  if (!purchaseResponse.ok) {
    console.error('CheckoutChamp purchase query failed:', purchaseResponse.status);
    return [];
  }

  const purchaseData = await purchaseResponse.json();
  console.log('CheckoutChamp purchase response:', JSON.stringify(purchaseData).substring(0, 500));

  const purchase = purchaseData?.result || purchaseData;

  if (!purchase) {
    return [];
  }

  // Extract subscription details from various possible field names
  const subscription = {
    purchaseId: purchaseId,
    productName: purchase.displayName || purchase.productName || purchase.product_name || 'Subscription',
    productSku: purchase.productSku || purchase.product_sku || purchase.sku || '',
    status: (purchase.status || purchase.purchaseStatus || purchase.purchase_status || 'unknown').toUpperCase(),
    nextBillingDate: purchase.nextBillDate || purchase.next_bill_date || purchase.nextBillingDate || null,
    lastBillingDate: purchase.lastBillDate || purchase.last_bill_date || purchase.dateCreated || purchase.createdAt || null,
    frequency: purchase.billingIntervalDays || purchase.frequency || purchase.billFrequency || purchase.billing_interval_days || 30,
    cycleNumber: purchase.billingCycleNumber || purchase.cycleNumber || purchase.rebillDepth || purchase.cycle_number || 1,
    price: purchase.price || purchase.amount || purchase.recurringPrice || '0.00',
    // Include order info if available
    orderId: orderData?.result?.orderId || orderData?.result?.id || null,
  };

  return [subscription];
}

// ============================================
// CREATE CASE (Hub + Richpanel)
// ============================================
async function handleCreateCase(request, env, corsHeaders) {
  const caseData = await request.json();
  
  // Log self-resolved case creation for debugging
  if (caseData.resolvedInApp) {
    console.log('Creating self-resolved case:', {
      orderNumber: caseData.orderNumber,
      email: caseData.email,
      issueType: caseData.issueType,
      resolvedInApp: caseData.resolvedInApp
    });
  }
  
  // Generate case ID
  const now = new Date();
  const prefix = getCasePrefix(caseData.caseType);
  const caseId = `${prefix}-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;

  // Skip Richpanel for self-resolved cases (they're not actual cases, just records)
  let richpanelResult = { success: false, conversationNo: null };
  if (!caseData.resolvedInApp) {
    // Create Richpanel email and private note (customer notification) only for actual cases
    richpanelResult = await createRichpanelEntry(env, caseData, caseId);
  } else {
    console.log('Skipping Richpanel for self-resolved case:', caseId);
  }

  // Log to D1 analytics database (Hub) - include ALL fields for extra_data
  // This MUST succeed even if Richpanel fails
  try {
    await logCaseToAnalytics(env, {
    caseId,
    sessionId: caseData.sessionId,
    caseType: caseData.caseType,
    resolution: caseData.resolution,
    orderNumber: caseData.orderNumber,
    email: caseData.email,
    customerName: caseData.customerName,
    customerFirstName: caseData.customerFirstName,
    customerLastName: caseData.customerLastName,
    refundAmount: caseData.refundAmount,
    selectedItems: caseData.selectedItems,
    sessionReplayUrl: caseData.sessionReplayUrl,
    orderUrl: caseData.orderUrl,
    orderDate: caseData.orderDate,
    richpanelConversationNo: richpanelResult?.conversationNo,
    resolvedInApp: caseData.resolvedInApp || false,
    // Subscription-specific fields
    actionType: caseData.actionType,
    purchaseId: caseData.purchaseId,
    clientOrderId: caseData.clientOrderId,
    subscriptionProductName: caseData.subscriptionProductName,
    subscriptionStatus: caseData.subscriptionStatus,
    pauseDuration: caseData.pauseDuration,
    pauseResumeDate: caseData.pauseResumeDate,
    cancelReason: caseData.cancelReason,
    discountPercent: caseData.discountPercent,
    newFrequency: caseData.newFrequency, // For schedule changes
    previousFrequency: caseData.previousFrequency, // For schedule changes
    newAddress: caseData.newAddress, // For address changes
    // Other fields for extra_data
    keepProduct: caseData.keepProduct,
    issueType: caseData.issueType,
    qualityDetails: caseData.qualityDetails,
    correctedAddress: caseData.correctedAddress,
    notes: caseData.notes,
    intentDetails: caseData.intentDetails,
    // Dog info (for dog_not_using cases)
    dogs: caseData.dogs,
    methodsTried: caseData.methodsTried,
    });
    
    console.log('Case logged to analytics successfully:', caseId, 'resolvedInApp:', caseData.resolvedInApp);
  } catch (dbError) {
    console.error('CRITICAL: Failed to log case to analytics database:', dbError);
    // Still return success to frontend, but log the error
    // The case might have been created in Richpanel but not in our DB
  }

  return Response.json({
    success: true,
    caseId,
  }, { headers: corsHeaders });
}

// ============================================
// CREATE MANUAL HELP CASE (ORDER NOT FOUND)
// ============================================
async function handleCreateManualCase(request, env, corsHeaders) {
  const { email, fullName, phone, orderNumber, issue, preferredContact, lookupAttempts, sessionId, sessionReplayUrl } = await request.json();

  // Generate case ID
  const now = new Date();
  const caseId = `MAN-${now.getFullYear()}${String(now.getMonth() + 1).padStart(2, '0')}${String(now.getDate()).padStart(2, '0')}${String(now.getHours()).padStart(2, '0')}${String(now.getMinutes()).padStart(2, '0')}${String(now.getSeconds()).padStart(2, '0')}`;

  try {
    // Create Richpanel entry (email + private note)
    let richpanelResult = null;
    if (env.RICHPANEL_API_KEY && email) {
      const caseData = {
        email,
        customerName: fullName,
        customerFirstName: fullName ? fullName.split(' ')[0] : 'Customer',
        customerLastName: fullName ? fullName.split(' ').slice(1).join(' ') : '',
        orderNumber: orderNumber || 'N/A',
        caseType: 'manual',
        resolution: 'manual_assistance',
        issueType: 'order_not_found',
        intentDetails: issue,
      };

      richpanelResult = await createRichpanelEntry(env, caseData, caseId);
    }

    // Log to D1 database (Hub)
    await logCaseToAnalytics(env, {
      caseId,
      sessionId,
      caseType: 'manual',
      resolution: 'manual_order_not_found',
      orderNumber: orderNumber || 'unknown',
      email: email || '',
      customerName: fullName || '',
      sessionReplayUrl: sessionReplayUrl || null,
      richpanelConversationNo: richpanelResult?.conversationNo,
      // Store additional details in extra_data
      phone: phone || '',
      preferredContact: preferredContact || 'email',
      intentDetails: issue || '',
      lookupAttempts: lookupAttempts || [],
    });

    return Response.json({
      success: true,
      caseId,
      richpanelConversationNo: richpanelResult?.conversationNo,
    }, { headers: corsHeaders });

  } catch (error) {
    console.error('Error creating manual case:', error);
    return Response.json({
      success: false,
      caseId,
      error: 'Failed to create case',
    }, { headers: corsHeaders });
  }
}

// Note: getCasePrefix is imported from ./config/constants.js

// Format resolution code to human-readable text (concise format)
function formatResolution(resolution, caseData) {
  if (!resolution) return 'Pending Review';

  const refundAmount = caseData.refundAmount ? `$${parseFloat(caseData.refundAmount).toFixed(2)}` : 'TBD';

  // Build concise resolution text
  const resolutionMap = {
    // Partial refunds (product issues) - all ladder steps
    'partial_20': `Give 20% partial refund (${refundAmount}) - customer keeps product`,
    'partial_30': `Give 30% partial refund (${refundAmount}) - customer keeps product`,
    'partial_40': `Give 40% partial refund (${refundAmount}) - customer keeps product`,
    'partial_50': `Give 50% partial refund (${refundAmount}) - customer keeps product`,
    'partial_75': `Give 75% partial refund (${refundAmount}) - customer keeps product`,

    // Full refunds
    'full_refund': caseData.keepProduct
      ? `Give full refund (${refundAmount})`
      : `Give full refund (${refundAmount}) after return`,
    'full': caseData.keepProduct
      ? `Give full refund (${refundAmount})`
      : `Give full refund (${refundAmount}) after return`,

    // Returns
    'return_refund': `Send return label and refund (${refundAmount}) after return`,
    'exchange': 'Send return label and ship replacement',

    // Shipping - Partial refund + reship combos
    'partial_20_reship': `Give 20% refund (${refundAmount}) and reship order`,
    'partial_50_reship': `Give 50% refund (${refundAmount}) and reship order`,

    // Shipping - Reship only
    'reship': 'Reship order',

    // Shipping - Refunds for lost/damaged
    'refund_lost': `Give full refund (${refundAmount}) - package lost`,
    'refund_damaged': `Give full refund (${refundAmount}) - package damaged`,

    // Investigation flows
    'investigation_delivered_not_received': 'Investigate with carrier',
    'replacement_damaged': 'Ship replacement - damaged item',
    'reship_wrong_item': 'Ship correct item',
    'reship_missing_item': 'Ship missing item',
    'reship_missing_item_bonus': 'Ship missing items + bonus item for inconvenience',
    'refund_missing_item': 'Calculate and refund for missing items (check bundle pricing)',
    'partial_missing': `Give partial refund (${refundAmount}) for missing item`,

    // Subscription
    'pause': 'Pause subscription',
    'cancel': 'Cancel subscription',
    'change_schedule': 'Update delivery schedule',
    'change_address': 'Update shipping address',

    // Shipping issues - general
    'no_tracking': 'Investigate and provide tracking or reship',
    'stuck_out_for_delivery': 'Contact carrier or reship',
    'pending_too_long': 'Check fulfillment status',
    'multiple_failed_attempts': 'Arrange redelivery or reship',

    // Quality difference - upgrade flows (ACTION: what team needs to do)
    'upgrade_keep_originals': 'ACTION: Send checkout link ($20/pad) â†’ Ship PuppyPad 2.0 after payment (customer keeps Originals)',
    'return_upgrade_enhanced': 'ACTION: Wait for return tracking â†’ Send checkout link ($20/pad) â†’ Ship PuppyPad 2.0 after payment',
    'reship_quality_upgrade': 'ACTION: Ship FREE PuppyPad 2.0 (customer keeps Originals) â€” We absorb cost',
    'full_refund_quality': 'ACTION: Process refund (team to calculate amount) â€” Customer keeps Originals',
    'full_refund_quality_used': 'ACTION: Process refund (team to calculate amount) â€” Used items, no return needed',
    'full_refund_quality_return': 'ACTION: Wait for return â†’ Process refund after received (team to calculate amount)',
  };

  // Check for dynamic partial_XX_reship patterns
  const partialReshipMatch = resolution.match(/^partial_(\d+)_reship$/);
  if (partialReshipMatch) {
    const percent = partialReshipMatch[1];
    return `Give ${percent}% partial refund (${refundAmount}) and reship order`;
  }

  // Check for dynamic partial_XX patterns (catches any percentage not explicitly mapped)
  const partialMatch = resolution.match(/^partial_(\d+)$/);
  if (partialMatch) {
    const percent = partialMatch[1];
    return `Give ${percent}% partial refund (${refundAmount}) - customer keeps product`;
  }

  return resolutionMap[resolution] || resolution.replace(/_/g, ' ');
}

// Format order issue from customer's reason (customer perspective - used in emails)
function formatOrderIssue(caseData) {
  // If there's detailed intent from the customer, use it directly
  if (caseData.intentDetails) {
    return caseData.intentDetails;
  }

  // Map issue types to customer-perspective descriptions (sounds like the customer is saying this)
  const issueMap = {
    // Product issues
    'not_met_expectations': "The product didn't meet my expectations",
    'changed_mind': "I changed my mind about this order",
    'ordered_mistake': "I ordered this by mistake",
    'defective': "The product I received is defective",
    'wrong_item': "I received the wrong item",
    'damaged': "My product arrived damaged",
    'missing_item': "There's an item missing from my order",
    'something_missing': "Something was missing from my order",
    'not_as_described': "The product isn't as described",
    'dog_not_using': "My dog isn't using the product",
    'quality_difference': "I noticed a quality difference",

    // Shipping issues
    'late_delivery': "My delivery is taking too long",
    'not_received': "I haven't received my order",
    'lost_package': "My package appears to be lost",
    'stuck_in_transit': "My package is stuck in transit",
    'delivery_exception': "There's a delivery exception on my package",
    'address_issue': "I need to correct my shipping address",
    'failed_delivery': "The delivery attempt failed",

    // Subscription issues
    'subscription_cancel': "I'd like to cancel my subscription",
    'subscription_pause': "I'd like to pause my subscription",
    'subscription_change': "I'd like to change my subscription",
    'charged_unexpectedly': "I was charged unexpectedly",

    // General
    'other': "I have an issue with my order",
  };

  // Check if we have a matching issue type
  if (caseData.issueType && issueMap[caseData.issueType]) {
    return issueMap[caseData.issueType];
  }

  // Fallback based on case type for better context (customer perspective)
  const caseTypeFallbacks = {
    'refund': "I'd like a refund for my order",
    'return': "I'd like to return my order",
    'shipping': "I'm having an issue with my delivery",
    'subscription': "I need help with my subscription",
    'manual': "I need help with my order",
  };

  return caseTypeFallbacks[caseData.caseType] || caseData.issueType?.replace(/_/g, ' ') || "I need help with my order";
}

// ============================================
// RICHPANEL INTEGRATION
// Requires env.RICHPANEL_API_KEY
// ============================================

async function createRichpanelEntry(env, caseData, caseId) {
  // Skip if no API key configured
  if (!env.RICHPANEL_API_KEY) {
    console.log('Richpanel: Skipping - no API key configured');
    return { success: false, error: 'No API key configured' };
  }

  try {
    // 1. Create the customer email (ticket)
    const ticketResult = await createRichpanelTicket(env, caseData, caseId);

    if (!ticketResult.success) {
      return ticketResult;
    }

    const ticketId = ticketResult.ticketId;
    const conversationNo = ticketResult.conversationNo;

    // 2. Add private note with action steps
    await createRichpanelPrivateNote(env, ticketId, caseData, caseId);

    // 3. Return conversation URL
    const conversationUrl = `https://app.richpanel.com/conversations?viewId=search&conversationNo=${conversationNo}`;

    console.log('Richpanel: Entry created successfully', { caseId, ticketId, conversationNo });

    return {
      success: true,
      ticketId,
      conversationNo,
      conversationUrl
    };
  } catch (error) {
    console.error('Richpanel integration error:', error);

    // Don't fail the whole case creation if Richpanel fails
    return {
      success: false,
      error: error.message
    };
  }
}

async function createRichpanelTicket(env, caseData, caseId) {
  // Use test email in test mode (determined by env variables)
  const testMode = isTestMode(env);
  const fromEmail = testMode
    ? RICHPANEL_CONFIG.testEmail
    : (caseData.email || RICHPANEL_CONFIG.testEmail);

  const customerFirstName = caseData.customerFirstName || 'Customer';
  const customerLastName = caseData.customerLastName || '';

  // Build subject line with Case ID and specific issue
  const orderIssue = formatOrderIssue(caseData);
  const subject = `${caseId} - ${orderIssue} - Order ${caseData.orderNumber || 'N/A'}`;

  // Build customer message (simulated email from customer)
  const customerMessage = buildCustomerMessage(caseData, caseId, testMode);

  const response = await fetch('https://api.richpanel.com/v1/tickets', {
    method: 'POST',
    headers: {
      'Content-Type': 'application/json',
      'x-richpanel-key': env.RICHPANEL_API_KEY
    },
    body: JSON.stringify({
      ticket: {
        status: 'OPEN',
        subject: subject,
        comment: {
          sender_type: 'customer',
          body: customerMessage
        },
        customer_profile: {
          firstName: customerFirstName,
          lastName: customerLastName
        },
        via: {
          channel: 'email',
          source: {
            from: { address: fromEmail },
            to: { address: RICHPANEL_CONFIG.supportEmail }
          }
        }
      }
    })
  });

  if (!response.ok) {
    const errorText = await response.text();
    console.error('Richpanel API error:', response.status, errorText);
    return { success: false, error: `Richpanel API error: ${response.status}` };
  }

  const result = await response.json();

  // Extract ticketId and conversationNo with multiple fallback variations
  const ticketId = result.id || result.ticket?.id;

  // Richpanel API response format can vary, check all possible field names
  const conversationNo = result.conversationNo ||
                         result.ticket?.conversationNo ||
                         result.conversation_no ||
                         result.ticket?.conversation_no ||
                         result.ticketNumber ||
                         result.ticket?.ticketNumber ||
                         result.ticket_number ||
                         result.ticket?.ticket_number;

  console.log('Richpanel ticket created:', { ticketId, conversationNo, rawResult: JSON.stringify(result) });

  return {
    success: true,
    ticketId,
    conversationNo
  };
}

function buildCustomerMessage(caseData, caseId, testMode = true) {
  const testNotice = testMode
    ? '[TEST MODE - This is not a real customer request]\n\n'
    : '';

  const orderIssue = formatOrderIssue(caseData);
  const formattedResolution = formatResolution(caseData.resolution, caseData);

  // Build items list if available
  const itemsList = caseData.selectedItems?.map(item =>
    `- ${item.title}${item.sku ? ` (SKU: ${item.sku})` : ''}`
  ).join('\n') || '';

  // Build address section if changed
  let addressSection = '';
  if (caseData.addressChanged && caseData.shippingAddress) {
    const addr = caseData.shippingAddress;
    const addressParts = [
      addr.address1,
      addr.address2,
      [addr.city, addr.province, addr.zip].filter(Boolean).join(', '),
      addr.country
    ].filter(Boolean);
    addressSection = `\nNEW ADDRESS: ${addressParts.join(', ')}`;
  }

  // Build message parts based on case type
  const messageParts = [testNotice];
  const firstName = caseData.customerFirstName || caseData.customerName?.split(' ')[0] || 'Customer';
  const refundAmountStr = caseData.refundAmount ? `$${parseFloat(caseData.refundAmount).toFixed(2)}` : '';

  // RETURN CASE - Natural customer email
  if (caseData.caseType === 'return') {
    messageParts.push(
      'Hi there,',
      '',
      `I used your online resolution center and would like to return my order for a refund.`,
      '',
      `Here's what happened: ${orderIssue}`,
      '',
      `I'm returning the following item(s):`,
      ''
    );
    if (itemsList) {
      messageParts.push(itemsList);
    }
    messageParts.push(
      '',
      `My order number is ${caseData.orderNumber || 'N/A'} and my case reference is ${caseId}.`,
      '',
      `Through the resolution center, I was told that once you receive and inspect my return, I'll get a full refund${refundAmountStr ? ` of ${refundAmountStr}` : ''}.`,
      '',
      `I'll send over the tracking number as soon as I've shipped the package.`,
      '',
      'Thanks for your help!',
      '',
      firstName
    );
  }
  // REFUND CASE - Natural customer email
  else if (caseData.caseType === 'refund') {
    messageParts.push(
      'Hi there,',
      '',
      `I used your online resolution center and wanted to follow up on my case.`,
      '',
      `The issue: ${orderIssue}`,
      '',
      `This is regarding my order #${caseData.orderNumber || 'N/A'} (Case ID: ${caseId}).`,
      ''
    );
    if (itemsList) {
      messageParts.push('The item(s) affected:', '', itemsList, '');
    }
    messageParts.push(
      `Through the resolution center, I was offered a ${formattedResolution.toLowerCase()}${refundAmountStr ? ` of ${refundAmountStr}` : ''} which I've accepted.`,
      '',
      `Please let me know if you need anything else from me.`,
      '',
      'Thanks!',
      '',
      firstName
    );
  }
  // SHIPPING CASE - Natural customer email
  else if (caseData.caseType === 'shipping') {
    messageParts.push(
      'Hi there,',
      '',
      `I used your online resolution center regarding an issue with the delivery of my order.`,
      '',
      `The problem: ${orderIssue}`,
      '',
      `My order number is ${caseData.orderNumber || 'N/A'} (Case ID: ${caseId}).`,
      ''
    );
    if (itemsList) {
      messageParts.push('Order contains:', '', itemsList, '');
    }
    messageParts.push(
      `Through the resolution center, we agreed on: ${formattedResolution}${refundAmountStr ? ` (${refundAmountStr})` : ''}.`,
      '',
      `Please let me know once this has been processed.`,
      '',
      'Thanks for sorting this out!',
      '',
      firstName
    );
  }
  // SUBSCRIPTION CASE - Natural customer email
  else if (caseData.caseType === 'subscription') {
    // Build action text with pause duration if applicable
    let actionText = 'make changes to my subscription';
    if (caseData.actionType === 'pause') {
      if (caseData.pauseDuration) {
        actionText = `pause my subscription for ${caseData.pauseDuration} days`;
      } else {
        actionText = 'pause my subscription';
      }
    } else if (caseData.actionType === 'cancel') {
      actionText = 'cancel my subscription';
    } else if (caseData.actionType === 'changeSchedule') {
      actionText = 'change my delivery schedule';
    } else if (caseData.actionType === 'changeAddress') {
      actionText = 'update my shipping address';
    }

    // Build resolution text with pause details
    let resolutionText = formattedResolution;
    if (caseData.actionType === 'pause' && caseData.pauseDuration) {
      resolutionText = `subscription paused for ${caseData.pauseDuration} days`;
      if (caseData.pauseResumeDate) {
        const resumeDate = new Date(caseData.pauseResumeDate);
        resolutionText += ` (resumes ${resumeDate.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' })})`;
      }
    }

    // Use clientOrderId if orderNumber not available
    const orderDisplay = caseData.orderNumber || caseData.clientOrderId || 'N/A';

    messageParts.push(
      'Hi there,',
      '',
      `I used your online resolution center and would like to ${actionText}.`,
      '',
      `Reason: ${orderIssue}`,
      '',
      `My details:`,
      `â€¢ Order: ${orderDisplay}`,
      `â€¢ Case ID: ${caseId}`
    );
    if (caseData.purchaseId) messageParts.push(`â€¢ Subscription ID: ${caseData.purchaseId} (Purchase ID)`);
    if (caseData.subscriptionProductName) messageParts.push(`â€¢ Product: ${caseData.subscriptionProductName}`);
    messageParts.push(
      '',
      `Through the resolution center, the agreed action is: ${resolutionText}${refundAmountStr ? ` (${refundAmountStr})` : ''}.`,
      '',
      'Thanks!',
      '',
      firstName
    );
  }
  // QUALITY DIFFERENCE CASES - Custom messages based on resolution
  else if (caseData.issueType === 'quality_difference') {
    const qd = caseData.qualityDetails || {};
    const padCount = qd.padCount || 'my';
    const upgradeTotal = qd.upgradeTotal ? `$${qd.upgradeTotal}` : 'the difference';

    if (caseData.resolution === 'upgrade_keep_originals') {
      // Branch 2A: Used items - keep originals + pay for enhanced
      messageParts.push(
        'Hi there,',
        '',
        `I used your online resolution center about a quality difference I noticed in my PuppyPads.`,
        '',
        `After chatting with your support, I understand there are two versions (Original and Enhanced) and I'd like to upgrade to the Enhanced version.`,
        '',
        `I have ${padCount} Original pads that I've already used, so I can't return them. I was told I could keep them AND pay just the $20 difference per pad for the Enhanced ones.`,
        '',
        `So that's ${upgradeTotal} for ${padCount} Enhanced PuppyPads.`,
        '',
        `Please send me the checkout link when it's ready!`,
        '',
        `My order number is ${caseData.orderNumber || 'N/A'} and my case reference is ${caseId}.`,
        '',
        'Thanks!',
        '',
        firstName
      );
    } else if (caseData.resolution === 'return_upgrade_enhanced') {
      // Branch 2B: Unused items - return + pay for enhanced
      messageParts.push(
        'Hi there,',
        '',
        `I used your online resolution center about a quality difference I noticed in my PuppyPads.`,
        '',
        `I'd like to return my ${padCount} unused Original pads and upgrade to the Enhanced version.`,
        '',
        `I was given your return address and I'll arrange shipping myself. I'll send you the tracking number once I've shipped it.`,
        '',
        `Then I'll pay the ${upgradeTotal} difference ($20 per pad) for the Enhanced ones.`,
        '',
        `My order number is ${caseData.orderNumber || 'N/A'} and my case reference is ${caseId}.`,
        '',
        'Thanks!',
        '',
        firstName
      );
    } else if (caseData.resolution === 'reship_quality_upgrade') {
      // Branch 3A: Accepted free reship of enhanced
      messageParts.push(
        'Hi there,',
        '',
        `I used your online resolution center about a quality difference I noticed in my PuppyPads.`,
        '',
        `I wasn't fully satisfied with the Original materials, but your support team offered to ship me the Enhanced version for free, and I've accepted that offer.`,
        '',
        `I understand I can keep what I already have, and you'll send the Enhanced pads at no cost.`,
        '',
        'Thank you for making this right!',
        '',
        `My order number is ${caseData.orderNumber || 'N/A'} and my case reference is ${caseId}.`,
        '',
        'Thanks!',
        '',
        firstName
      );
    } else if (caseData.resolution === 'full_refund_quality') {
      // Branch 3B: Still want refund
      messageParts.push(
        'Hi there,',
        '',
        `I used your online resolution center about a quality difference I noticed in my PuppyPads.`,
        '',
        `I was offered a free reship of the Enhanced version, but I'd prefer a refund instead.`,
        '',
        `I understand I can keep what I already have.`,
        '',
        `My order number is ${caseData.orderNumber || 'N/A'} and my case reference is ${caseId}.`,
        '',
        'Thanks!',
        '',
        firstName
      );
    } else {
      // Generic quality difference fallback
      messageParts.push(
        'Hi there,',
        '',
        `I used your online resolution center about a quality difference I noticed in my PuppyPads.`,
        '',
        `My order number is ${caseData.orderNumber || 'N/A'} and my case reference is ${caseId}.`,
        '',
        `Through the resolution center, we agreed on: ${formattedResolution}.`,
        '',
        'Thanks!',
        '',
        firstName
      );
    }
  }
  // DEFAULT/MANUAL CASE
  else {
    messageParts.push(
      'Hi there,',
      '',
      `I used your online resolution center and need some help with my order.`,
      '',
      `Issue: ${orderIssue}`,
      '',
      `Order Number: ${caseData.orderNumber || 'N/A'}`,
      `Case ID: ${caseId}`,
      ''
    );
    if (itemsList) {
      messageParts.push('Items:', '', itemsList, '');
    }
    if (formattedResolution) {
      messageParts.push(`Through the resolution center, the agreed resolution is: ${formattedResolution}${refundAmountStr ? ` (${refundAmountStr})` : ''}`, '');
    }
    messageParts.push(
      'Please let me know if you need any more information.',
      '',
      'Thanks!',
      '',
      firstName
    );
  }

  // Join message parts, converting to HTML for proper Richpanel rendering
  // Empty strings become blank lines (<br><br> for paragraph spacing)
  const plainText = messageParts
    .filter(part => part !== null && part !== undefined)
    .join('\n')
    .trim();

  // Convert newlines to HTML breaks for Richpanel
  return plainText.replace(/\n\n/g, '<br><br>').replace(/\n/g, '<br>');
}

function getSubjectByType(caseType, resolution) {
  const subjects = {
    'refund': `Refund Request - ${resolution || 'Full Refund'}`,
    'return': 'Return Request',
    'shipping': 'Shipping Issue',
    'subscription': `Subscription - ${resolution || 'Change Request'}`,
    'manual': 'Customer Support Request'
  };
  return subjects[caseType] || 'Customer Support Request';
}

async function createRichpanelPrivateNote(env, ticketId, caseData, caseId) {
  const actionSteps = getActionStepsHtml(caseData);
  const formattedResolution = formatResolution(caseData.resolution, caseData);
  const orderIssue = formatOrderIssue(caseData);
  // Use quality_difference SOP if that's the issue type, otherwise use case type
  const sopUrl = caseData.issueType === 'quality_difference'
    ? SOP_URLS.quality_difference
    : (SOP_URLS[caseData.caseType] || SOP_URLS.manual);
  const orderDate = caseData.orderDate ? new Date(caseData.orderDate).toLocaleDateString('en-US', {
    year: 'numeric', month: 'long', day: 'numeric'
  }) : 'Unknown';

  // Build items list in HTML
  const itemsHtml = caseData.selectedItems && caseData.selectedItems.length > 0
    ? caseData.selectedItems.map(item => `â€¢ ${item.title} (${item.sku || 'N/A'})`).join('<br>')
    : 'No items selected';

  // Build shipping-specific details HTML
  let shippingDetailsHtml = '';
  if (caseData.caseType === 'shipping') {
    let addressHtml = '';
    if (caseData.shippingAddress) {
      const addr = caseData.shippingAddress;
      const addressLabel = caseData.addressChanged ? 'âš ï¸ UPDATED SHIPPING ADDRESS' : 'Shipping Address';
      addressHtml = `
<b>${addressLabel}:</b><br>
${addr.address1 || ''}<br>
${addr.address2 ? `${addr.address2}<br>` : ''}
${[addr.city, addr.province, addr.zip].filter(Boolean).join(', ')}<br>
${addr.country || ''}<br>
`;
    }

    shippingDetailsHtml = `
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
<b>SHIPPING DETAILS</b><br>
${caseData.trackingNumber ? `<b>Tracking Number:</b> ${caseData.trackingNumber}<br>` : ''}
${caseData.carrierName ? `<b>Carrier:</b> ${caseData.carrierName}<br>` : ''}
${caseData.trackingStatus ? `<b>Tracking Status:</b> ${caseData.trackingStatus}<br>` : ''}
${caseData.daysInTransit ? `<b>Days in Transit:</b> ${caseData.daysInTransit}<br>` : ''}
${addressHtml}
${caseData.pickupReason ? `<b>Can't Pickup Reason:</b> ${caseData.pickupReason}<br>` : ''}
${caseData.notes ? `<b>Notes:</b> ${caseData.notes}<br>` : ''}
`;
  }

  // Build subscription-specific details HTML
  let subscriptionDetailsHtml = '';
  if (caseData.caseType === 'subscription') {
    const actionLabels = {
      pause: 'Pause Subscription',
      cancel: 'Cancel Subscription',
      changeSchedule: 'Change Schedule',
      changeAddress: 'Change Address'
    };
    const reasonLabels = {
      expensive: 'Too expensive',
      too_many: 'Has too many',
      not_working: 'Not working as described',
      moving: 'Moving',
      other: 'Other reason'
    };
    subscriptionDetailsHtml = `
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
<b>SUBSCRIPTION DETAILS</b><br>
${caseData.purchaseId ? `<b>Purchase ID:</b> ${caseData.purchaseId}<br>` : ''}
${caseData.clientOrderId ? `<b>Client Order ID:</b> ${caseData.clientOrderId}<br>` : ''}
${caseData.subscriptionProductName ? `<b>Product:</b> ${caseData.subscriptionProductName}<br>` : ''}
${caseData.actionType ? `<b>Action:</b> ${actionLabels[caseData.actionType] || caseData.actionType}<br>` : ''}
${caseData.discountPercent ? `<b>Discount Applied:</b> ${caseData.discountPercent}%<br>` : ''}
${caseData.cancelReason ? `<b>Cancel Reason:</b> ${reasonLabels[caseData.cancelReason] || caseData.cancelReason}<br>` : ''}
${caseData.notes ? `<b>Notes:</b> ${caseData.notes}<br>` : ''}
`;
  }

  // Build missing item-specific details HTML
  let missingItemDetailsHtml = '';
  if (caseData.missingItemOrderList || caseData.missingItemDescription) {
    missingItemDetailsHtml = `
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
<b>ðŸ“¦ MISSING ITEM DETAILS</b><br>
<br>
${caseData.missingItemOrderList ? `<b>What Customer Should Have Received:</b><br>${caseData.missingItemOrderList}<br><br>` : ''}
${caseData.missingItemDescription ? `<b>What Customer Says Is Missing:</b><br>${caseData.missingItemDescription}<br>` : ''}
`;
  }

  // Build quality difference-specific details HTML
  let qualityDetailsHtml = '';
  if (caseData.issueType === 'quality_difference' && caseData.qualityDetails) {
    const qd = caseData.qualityDetails;
    const resolution = caseData.resolution;

    let statusNote = '';
    if (resolution === 'upgrade_keep_originals') {
      statusNote = 'âš ï¸ Customer has USED Original pads - they keep them + pay for Enhanced';
    } else if (resolution === 'return_upgrade_enhanced') {
      statusNote = 'ðŸ“¦ Customer will RETURN unused Originals + pay for Enhanced';
    } else if (resolution === 'reship_quality_upgrade') {
      statusNote = 'ðŸŽ FREE RESHIP - Customer accepted free Enhanced pads';
    } else if (resolution === 'full_refund_quality') {
      statusNote = 'ðŸ’° Customer declined free reship - wants refund instead';
    }

    qualityDetailsHtml = `
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
<b>ðŸ”„ QUALITY UPGRADE DETAILS</b><br>
<br>
${statusNote ? `<b>${statusNote}</b><br><br>` : ''}
${qd.padCount ? `<b>Number of Pads:</b> ${qd.padCount}<br>` : ''}
${qd.itemsUsed !== undefined ? `<b>Items Status:</b> ${qd.itemsUsed ? 'USED (keeping)' : 'UNUSED (returning)'}<br>` : ''}
${qd.upgradeTotal ? `<b>Upgrade Cost:</b> $${qd.upgradeTotal} ($20 Ã— ${qd.padCount} pads)<br>` : ''}
`;
  }

  // Build HTML formatted note content with <br> and <b> tags (no italics)
  const noteContent = `
<b>ðŸŽ¯ ACTION REQUIRED</b><br>
<br>
<b>Case ID:</b> ${caseId}<br>
<b>Order Number:</b> ${caseData.orderNumber || 'N/A'}<br>
<b>Order Date:</b> ${orderDate}<br>
<b>Customer Email:</b> ${caseData.email || 'Not provided'}<br>
<br>
<b>Issue:</b> ${orderIssue}<br>
<b>Resolution:</b> ${formattedResolution}<br>
${caseData.refundAmount ? `<b>Refund Amount:</b> $${parseFloat(caseData.refundAmount).toFixed(2)}<br>` : ''}
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
<b>Action Steps:</b><br>
${actionSteps}<br>
${shippingDetailsHtml}
${subscriptionDetailsHtml}
${missingItemDetailsHtml}
${qualityDetailsHtml}
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
${caseData.caseType !== 'subscription' && caseData.caseType !== 'shipping' ? `<b>Items:</b><br>${itemsHtml}<br><br>` : ''}
${caseData.orderUrl ? `<b>Shopify Order:</b> <a href="${caseData.orderUrl}">${caseData.orderUrl}</a><br>` : ''}
<b>SOP:</b> <a href="${sopUrl}">${sopUrl}</a>
`.trim();

  // Use PUT to add a private note (operator comment)
  const response = await fetch(
    `https://api.richpanel.com/v1/tickets/${ticketId}`,
    {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'x-richpanel-key': env.RICHPANEL_API_KEY
      },
      body: JSON.stringify({
        ticket: {
          comment: {
            body: noteContent,
            public: false,
            sender_type: 'operator'
          }
        }
      })
    }
  );

  if (!response.ok) {
    console.error('Failed to create private note:', response.status);
  }

  return response.ok;
}

// HTML version of action steps for Richpanel
function getActionStepsHtml(caseData) {
  const type = caseData.caseType;
  const resolution = caseData.resolution;

  if (type === 'refund') {
    if (resolution === 'full_refund' || resolution === 'Full Refund') {
      return `1. âœ… Verify order in Shopify<br>2. âœ… Process full refund in Shopify<br>3. âœ… Send refund confirmation email<br>4. âœ… Close ticket`;
    }
    // Check if it's a missing item refund
    if (resolution === 'refund_missing_item') {
      return `1. âœ… Review customer's photos and description below<br>2. âœ… Calculate refund based on missing items (check bundle pricing)<br>3. âœ… Process partial refund in Shopify<br>4. âœ… Send refund confirmation email<br>5. âœ… Close ticket`;
    }
    return `1. âœ… Verify order in Shopify<br>2. âœ… Process partial refund: $${caseData.refundAmount || 'TBD'}<br>3. âœ… Send refund confirmation email<br>4. âœ… Close ticket`;
  }

  if (type === 'return') {
    return `1. âœ… Verify order is within return window<br>2. âœ… Send return label to customer<br>3. â³ Wait for return to arrive<br>4. âœ… Process refund once received<br>5. âœ… Close ticket`;
  }

  if (type === 'shipping') {
    // Check if it's a missing item case
    if (resolution === 'reship_missing_item_bonus') {
      return `1. âœ… Review customer's photos and description below<br>2. âœ… Verify what items are missing<br>3. âœ… Create reship order with missing items + bonus item<br>4. âœ… Send tracking to customer<br>5. âœ… Close ticket`;
    }
    return `1. âœ… Check tracking status in ParcelPanel<br>2. âœ… Contact carrier if needed<br>3. âœ… Update customer on status<br>4. âœ… Close ticket when resolved`;
  }

  if (type === 'subscription') {
    return `1. âœ… Verify subscription in CheckoutChamp<br>2. âœ… Process requested change: ${resolution || 'N/A'}<br>3. âœ… Confirm change with customer<br>4. âœ… Close ticket`;
  }

  // Quality difference specific action steps
  if (caseData.issueType === 'quality_difference') {
    const qd = caseData.qualityDetails || {};
    const padCount = qd.padCount || 'X';
    const upgradeTotal = qd.upgradeTotal || 'TBD';

    if (resolution === 'upgrade_keep_originals') {
      return `1. âœ… Generate custom checkout link for $${upgradeTotal}<br>2. âœ… Send checkout link to customer email<br>3. â³ Wait for payment<br>4. âœ… Ship ${padCount} Enhanced PuppyPads<br>5. âœ… Send tracking confirmation<br>6. âœ… Close ticket<br><br>âš ï¸ Customer keeps Original pads - we're absorbing cost for satisfaction`;
    }
    if (resolution === 'return_upgrade_enhanced') {
      return `1. â³ Wait for customer to ship return<br>2. â³ Customer will provide tracking number<br>3. âœ… Once tracking received, generate checkout link for $${upgradeTotal}<br>4. âœ… Send checkout link to customer<br>5. â³ Wait for payment<br>6. âœ… Ship ${padCount} Enhanced PuppyPads<br>7. âœ… Close ticket when delivered`;
    }
    if (resolution === 'reship_quality_upgrade') {
      return `1. âœ… Ship ${padCount} Enhanced PuppyPads (FREE - no charge)<br>2. âœ… Send tracking to customer<br>3. âœ… Close ticket once delivered<br><br>âš ï¸ We're covering product + shipping cost. Customer keeps Original pads.`;
    }
    if (resolution === 'full_refund_quality') {
      return `1. âœ… Calculate refund amount (check discounts applied)<br>2. âœ… Process refund in Shopify<br>3. âœ… Send refund confirmation email<br>4. âœ… Close ticket<br><br>âš ï¸ Customer declined free PuppyPad 2.0 reship. No return needed - customer keeps Original pads.`;
    }
    if (resolution === 'full_refund_quality_used') {
      return `1. âœ… Verify customer reported quantity: ${padCount} Original pad(s)<br>2. âœ… Check order for any discounts applied<br>3. âœ… Calculate fair refund amount for Original pads<br>4. âœ… Process refund in Shopify<br>5. âœ… Send refund confirmation email<br>6. âœ… Close ticket<br><br>âš ï¸ USED ITEMS - No return needed. Customer keeps Original pads.`;
    }
    if (resolution === 'full_refund_quality_return') {
      return `1. â³ Wait for customer to ship return<br>2. â³ Customer will provide tracking number<br>3. â³ Wait to receive ${padCount} Original pad(s)<br>4. âœ… Verify returned items<br>5. âœ… Check order for any discounts applied<br>6. âœ… Calculate fair refund amount<br>7. âœ… Process refund in Shopify<br>8. âœ… Send refund confirmation email<br>9. âœ… Close ticket`;
    }
  }

  return `1. âœ… Review customer request<br>2. âœ… Take appropriate action<br>3. âœ… Update customer<br>4. âœ… Close ticket`;
}

function getActionSteps(caseData) {
  const type = caseData.caseType;
  const resolution = caseData.resolution;

  if (type === 'refund') {
    if (resolution === 'full_refund' || resolution === 'Full Refund') {
      return `
1. âœ… Verify order in Shopify
2. âœ… Process full refund in Shopify
3. âœ… Send refund confirmation email
4. âœ… Close ticket`;
    }
    // Check if it's a missing item refund
    if (resolution === 'refund_missing_item') {
      return `
1. âœ… Review customer's photos and description below
2. âœ… Calculate refund based on missing items (check bundle pricing)
3. âœ… Process partial refund in Shopify
4. âœ… Send refund confirmation email
5. âœ… Close ticket`;
    }
    return `
1. âœ… Verify order in Shopify
2. âœ… Process partial refund: $${caseData.refundAmount || 'TBD'}
3. âœ… Send refund confirmation email
4. âœ… Close ticket`;
  }

  if (type === 'return') {
    return `
1. âœ… Verify order is within return window
2. âœ… Send return label to customer
3. â³ Wait for return to arrive
4. âœ… Process refund once received
5. âœ… Close ticket`;
  }

  if (type === 'shipping') {
    // Check if it's a missing item case
    if (resolution === 'reship_missing_item_bonus') {
      return `
1. âœ… Review customer's photos and description below
2. âœ… Verify what items are missing
3. âœ… Create reship order with missing items + bonus item
4. âœ… Send tracking to customer
5. âœ… Close ticket`;
    }
    return `
1. âœ… Check tracking status in ParcelPanel
2. âœ… Contact carrier if needed
3. âœ… Update customer on status
4. âœ… Close ticket when resolved`;
  }

  if (type === 'subscription') {
    return `
1. âœ… Verify subscription in CheckoutChamp
2. âœ… Process requested change: ${resolution || 'N/A'}
3. âœ… Confirm change with customer
4. âœ… Close ticket`;
  }

  return `
1. âœ… Review customer request
2. âœ… Take appropriate action
3. âœ… Update customer
4. âœ… Close ticket`;
}

// ============================================
// CHECK EXISTING CASE (DEDUPE)
// ============================================
async function handleCheckCase(request, env, corsHeaders) {
  const { orderNumber, email } = await request.json();

  if (!orderNumber && !email) {
    return Response.json({ existingCase: false }, { headers: corsHeaders });
  }

  try {
    // Search D1 database for existing open cases
    let existingCase = null;
    
    if (orderNumber) {
      existingCase = await env.ANALYTICS_DB.prepare(
        `SELECT case_id, status FROM cases WHERE order_number = ? AND status IN ('pending', 'in_progress') ORDER BY created_at DESC LIMIT 1`
      ).bind(orderNumber).first();
    }
    
    if (!existingCase && email) {
      existingCase = await env.ANALYTICS_DB.prepare(
        `SELECT case_id, status FROM cases WHERE customer_email = ? AND status IN ('pending', 'in_progress') ORDER BY created_at DESC LIMIT 1`
      ).bind(email).first();
    }

    if (existingCase) {
      return Response.json({ 
        existingCase: true, 
        caseId: existingCase.case_id,
        status: existingCase.status
      }, { headers: corsHeaders });
    }
  } catch (e) {
    console.error('Error checking existing case:', e);
  }

  return Response.json({ existingCase: false }, { headers: corsHeaders });
}

// ============================================
// APPEND TO EXISTING CASE
// Adds new info as a comment to an existing case
// ============================================
async function handleAppendToCase(request, env, corsHeaders) {
  const { caseId, caseData, additionalInfo, newIntent } = await request.json();

  if (!caseId) {
    return Response.json({ success: false, error: 'No case ID provided' }, { status: 400, headers: corsHeaders });
  }

  try {
    // Build comment content
    const now = new Date().toISOString();
    const formattedResolution = formatResolution(caseData?.resolution, caseData);
    const orderIssue = formatOrderIssue(caseData);

    const commentParts = ['Additional information added:'];

    if (newIntent) {
      commentParts.push(`New Issue Type: ${newIntent}`);
    }
    if (caseData?.resolution) {
      commentParts.push(`Requested Resolution: ${formattedResolution}`);
    }
    if (orderIssue) {
      commentParts.push(`Issue Details: ${orderIssue}`);
    }
    if (caseData?.intentDetails) {
      commentParts.push(`Customer Notes: ${caseData.intentDetails}`);
    }
    if (additionalInfo) {
      commentParts.push(`Additional Info: ${additionalInfo}`);
    }

    const commentContent = commentParts.join('\n');

    // Add comment to D1 database
    await env.ANALYTICS_DB.prepare(
      `INSERT INTO case_comments (case_id, content, author_name, source, created_at) VALUES (?, ?, ?, ?, ?)`
    ).bind(caseId, commentContent, 'Customer', 'chat_app', now).run();

    return Response.json({
      success: true,
      message: 'Information added to existing case'
    }, { headers: corsHeaders });

  } catch (error) {
    console.error('Error appending to case:', error);
    return Response.json({ success: false, error: error.message }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// AI RESPONSE (AMY / CLAUDIA)
// Supports both legacy PROMPT_PACKS and new AI_SCENARIO_PROMPTS
// ============================================
async function handleAIResponse(request, env, corsHeaders) {
  const body = await request.json();
  const {
    // New scenario-based approach
    scenarioType,
    scenarioData,
    // Legacy approach
    persona,
    context,
    productName,
    customerInput,
    methodsTried,
    intentCategory,
    intentReason,
    orderItems,
  } = body;

  // Get product doc from R2 if needed
  let productDoc = '';
  if (productName || scenarioData?.productName) {
    productDoc = await getProductDoc(env, productName || scenarioData?.productName);
  }

  let systemPrompt, userPrompt, model, temperature, maxTokens;

  // Check if using new scenario-based approach
  if (scenarioType && AI_SCENARIO_PROMPTS[scenarioType]) {
    const scenario = AI_SCENARIO_PROMPTS[scenarioType];
    model = scenario.model;
    temperature = scenario.temperature;
    maxTokens = scenario.maxTokens;

    // Build prompts using scenario builders
    systemPrompt = scenario.buildSystemPrompt(productDoc, orderItems || scenarioData?.orderItems, scenarioData?.context);
    userPrompt = scenario.buildUserPrompt(scenarioData || {});
  } else {
    // Legacy PROMPT_PACKS approach
    const promptPack = getPromptPack(intentCategory, intentReason);
    model = 'gpt-4o-mini';
    temperature = 0.7;
    maxTokens = 500;

    systemPrompt = persona === 'claudia'
      ? buildClaudiaPrompt(productDoc, methodsTried, promptPack)
      : buildAmyPrompt(productDoc, context, promptPack);
    userPrompt = customerInput;
  }

  const response = await fetch('https://api.openai.com/v1/chat/completions', {
    method: 'POST',
    headers: {
      'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
      'Content-Type': 'application/json',
    },
    body: JSON.stringify({
      model: model,
      messages: [
        { role: 'system', content: systemPrompt },
        { role: 'user', content: userPrompt },
      ],
      max_tokens: maxTokens,
      temperature: temperature,
    }),
  });

  if (!response.ok) {
    console.error('AI response failed:', response.status);
    return Response.json({ error: 'AI response failed' }, { status: 500, headers: corsHeaders });
  }

  const data = await response.json();
  const message = data.choices[0]?.message?.content || '';

  // Split into multiple messages if too long
  const messages = splitMessage(message);

  return Response.json({ messages }, { headers: corsHeaders });
}

// ============================================
// PARSE PICKUP LOCATION
// Extracts pickup location name from checkpoints
// Returns last-mile carrier tracking link for full details
// ============================================
async function handleParsePickupLocation(request, env, corsHeaders) {
  const { tracking, carrier, checkpoints, lastMile, shippingAddress } = await request.json();

  // Get data from ParcelPanel
  const lastMileCarrier = lastMile?.carrier_name || null;
  const lastMileTrackingNumber = lastMile?.tracking_number || null;
  const lastMileCarrierUrl = lastMile?.carrier_url || null;

  // Check if main carrier is a China carrier
  const isMainCarrierChina = isChinaCarrier(carrier);
  const displayCarrier = lastMileCarrier || (isMainCarrierChina ? null : carrier);

  // Get recent checkpoints for context
  const recentCheckpoints = (checkpoints || []).slice(0, 6);
  const checkpointContext = recentCheckpoints
    .map(cp => `${cp.checkpoint_time || ''}: ${cp.message || cp.detail || ''} ${cp.location ? `(${cp.location})` : ''}`)
    .join('\n');

  let pickupLocationName = null;

  try {
    // Extract pickup location NAME from checkpoints (e.g., "daoSHOP", "Post Office")
    const extractResponse = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [{
          role: 'user',
          content: `Extract ONLY the pickup location name from these tracking checkpoints.

TRACKING CHECKPOINTS:
${checkpointContext || 'No checkpoints'}

Look for the location name in phrases like:
- "Held at [LOCATION]"
- "Ready for pickup at [LOCATION]"
- "Available at [LOCATION]"
- "Awaiting collection at [LOCATION]"

Return ONLY the location name (e.g., "Post Office", "daoSHOP", "FedEx Office").
If no location found, return "pickup location".`
        }],
        max_tokens: 50,
        temperature: 0.1,
      }),
    });

    if (extractResponse.ok) {
      const data = await extractResponse.json();
      const content = data.choices?.[0]?.message?.content?.trim() || '';
      if (content && content.toLowerCase() !== 'null' && content.length < 100) {
        pickupLocationName = content.replace(/^["']|["']$/g, ''); // Remove quotes if present
      }
    }
  } catch (error) {
    console.error('Pickup location extraction error:', error.message);
  }

  return Response.json({
    success: true,
    pickupLocationName: pickupLocationName,
    lastMileCarrier: lastMileCarrier,
    lastMileTrackingNumber: lastMileTrackingNumber,
    lastMileCarrierUrl: lastMileCarrierUrl,
    displayCarrier: displayCarrier,
    isMainCarrierChina,
  }, { headers: corsHeaders });
}

// Gets the appropriate prompt pack for the given intent
function getPromptPack(category, reason) {
  if (!category) return null;

  const categoryPack = PROMPT_PACKS[category];
  if (!categoryPack) return PROMPT_PACKS.general.default;

  const reasonPack = categoryPack[reason];
  if (!reasonPack) {
    // If no specific reason, use the first one in the category as fallback
    const firstReason = Object.keys(categoryPack)[0];
    return categoryPack[firstReason] || PROMPT_PACKS.general.default;
  }

  return reasonPack;
}

async function getProductDoc(env, productName) {
  // Uses PRODUCT_DOC_MAP from config at top of file
  const lowerName = productName.toLowerCase();
  let filename = null;

  for (const [key, value] of Object.entries(PRODUCT_DOC_MAP)) {
    if (lowerName.includes(key)) {
      filename = value;
      break;
    }
  }

  if (!filename) return '';

  try {
    const file = await env.PRODUCT_DOCS.get(filename);
    if (file) {
      return await file.text();
    }
  } catch (e) {
    console.error('Error fetching product doc:', e);
  }

  return '';
}

// Builds prompt from PERSONA_PROMPTS config + intent-specific prompt pack
function buildAmyPrompt(productDoc, context, promptPack = null) {
  const persona = PERSONA_PROMPTS.amy;

  // Build intent-specific section if prompt pack provided
  let intentSection = '';
  if (promptPack) {
    intentSection = `
SITUATION CONTEXT:
${promptPack.context}

YOUR APPROACH FOR THIS SITUATION:
${promptPack.instruction}

HANDLING PUSHBACK:
${promptPack.objectionHandling}
`;
  }

  return `You are ${persona.name} from PuppyPad ${persona.role}. You are warm, caring, and helpful.

Your characteristics:
${persona.characteristics.map(c => '- ' + c).join('\n')}

Product knowledge:
${productDoc}

Context: ${context || 'General customer support'}
${intentSection}
${persona.instruction}`;
}

// Builds prompt from PERSONA_PROMPTS config + intent-specific prompt pack
function buildClaudiaPrompt(productDoc, methodsTried, promptPack = null) {
  const persona = PERSONA_PROMPTS.claudia;

  // Build intent-specific section if prompt pack provided
  let intentSection = '';
  if (promptPack) {
    intentSection = `
SITUATION CONTEXT:
${promptPack.context}

YOUR APPROACH FOR THIS SITUATION:
${promptPack.instruction}

HANDLING PUSHBACK:
${promptPack.objectionHandling}
`;
  }

  return `You are ${persona.name}, an ${persona.role} at PuppyPad. You specialize in helping customers train their dogs to use PuppyPad products.

Your characteristics:
${persona.characteristics.map(c => '- ' + c).join('\n')}

Product knowledge:
${productDoc}

Methods the customer has already tried (DO NOT suggest these again):
${methodsTried || 'None specified'}
${intentSection}
${persona.instruction}`;
}

function splitMessage(message) {
  // Don't split HTML content - keep as single message
  if (message.includes('<p>') || message.includes('<ul>') || message.includes('<li>')) {
    // Clean up any markdown code block wrappers GPT might add
    let cleaned = message.replace(/^```html\s*/i, '').replace(/```\s*$/i, '').trim();
    return [cleaned];
  }

  // If message is short, return as single message
  if (message.length < 500) return [message];

  // Split into 2 messages at a natural break point
  const midPoint = Math.floor(message.length / 2);
  let splitIndex = message.lastIndexOf('. ', midPoint + 50);

  if (splitIndex === -1 || splitIndex < midPoint - 100) {
    splitIndex = message.indexOf('. ', midPoint);
  }

  if (splitIndex === -1) return [message];

  return [
    message.substring(0, splitIndex + 1).trim(),
    message.substring(splitIndex + 1).trim(),
  ];
}

// ============================================
// UPLOAD EVIDENCE
// ============================================
async function handleUploadEvidence(request, env, corsHeaders) {
  const formData = await request.formData();
  const file = formData.get('file');
  const caseId = formData.get('caseId') || 'temp';

  if (!file) {
    return Response.json({ error: 'No file provided' }, { status: 400, headers: corsHeaders });
  }

  // Validate file type
  const allowedTypes = ['image/jpeg', 'image/png', 'image/jpg'];
  if (!allowedTypes.includes(file.type)) {
    return Response.json({ error: 'Please upload a JPG or PNG image' }, { status: 400, headers: corsHeaders });
  }

  // Validate file size (5MB max)
  if (file.size > 5 * 1024 * 1024) {
    return Response.json({ error: 'File too large. Please upload an image under 5MB.' }, { status: 400, headers: corsHeaders });
  }

  const filename = `${caseId}/${Date.now()}-${file.name}`;
  
  await env.EVIDENCE_UPLOADS.put(filename, file.stream(), {
    httpMetadata: { contentType: file.type },
  });

  return Response.json({ 
    success: true, 
    filename,
    url: `/evidence/${filename}`,
  }, { headers: corsHeaders });
}

// ============================================
// SERVE AUDIO FILES
// ============================================
async function handleAudio(pathname, env, corsHeaders) {
  const rawFilename = pathname.replace('/audio/', '');
  const filename = decodeURIComponent(rawFilename);
  
  const file = await env.PRODUCT_DOCS.get(filename);
  
  if (!file) {
    return Response.json({ error: 'Audio not found' }, { status: 404, headers: corsHeaders });
  }

  return new Response(file.body, {
    headers: {
      ...corsHeaders,
      'Content-Type': 'audio/mpeg',
      'Content-Length': file.size,
    },
  });
}

// ============================================
// ANALYTICS API HANDLERS
// ============================================

// Log event
async function handleLogEvent(request, env, corsHeaders) {
  try {
    const { sessionId, eventType, eventName, eventData } = await request.json();

    await env.ANALYTICS_DB.prepare(`
      INSERT INTO events (session_id, event_type, event_name, event_data)
      VALUES (?, ?, ?, ?)
    `).bind(
      sessionId,
      eventType,
      eventName,
      JSON.stringify(eventData || {})
    ).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (e) {
    console.error('Event logging failed:', e);
    return Response.json({ success: false, error: e.message }, { headers: corsHeaders });
  }
}

// Log or update session
async function handleLogSession(request, env, corsHeaders) {
  try {
    const data = await request.json();

    // Convert undefined to null (D1 doesn't support undefined)
    const sessionId = data.sessionId ?? null;
    const flowType = data.flowType ?? null;
    const customerEmail = data.customerEmail ?? null;
    const customerName = data.customerName ?? null;
    const orderNumber = data.orderNumber ?? null;
    const persona = data.persona ?? null;
    const deviceType = data.deviceType ?? null;
    const sessionReplayUrl = data.sessionReplayUrl ?? null;
    const issueType = data.issueType ?? null;
    const completed = data.completed;
    const ended = data.ended;

    if (ended) {
      // Update existing session when it ends
      await env.ANALYTICS_DB.prepare(`
        UPDATE sessions SET
          ended_at = CURRENT_TIMESTAMP,
          completed = ?,
          flow_type = COALESCE(?, flow_type),
          session_replay_url = COALESCE(?, session_replay_url),
          customer_email = COALESCE(?, customer_email),
          customer_name = COALESCE(?, customer_name),
          order_number = COALESCE(?, order_number),
          issue_type = COALESCE(?, issue_type)
        WHERE session_id = ?
      `).bind(
        completed ? 1 : 0,
        flowType,
        sessionReplayUrl,
        customerEmail,
        customerName,
        orderNumber,
        issueType,
        sessionId
      ).run();
    } else {
      // Insert or update session (upsert)
      await env.ANALYTICS_DB.prepare(`
        INSERT INTO sessions (session_id, flow_type, customer_email, customer_name, order_number, persona, device_type, session_replay_url, issue_type)
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?)
        ON CONFLICT(session_id) DO UPDATE SET
          flow_type = COALESCE(excluded.flow_type, flow_type),
          customer_email = COALESCE(excluded.customer_email, customer_email),
          customer_name = COALESCE(excluded.customer_name, customer_name),
          order_number = COALESCE(excluded.order_number, order_number),
          session_replay_url = COALESCE(excluded.session_replay_url, session_replay_url),
          issue_type = COALESCE(excluded.issue_type, issue_type)
      `).bind(sessionId, flowType, customerEmail, customerName, orderNumber, persona, deviceType, sessionReplayUrl, issueType).run();
    }

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (e) {
    console.error('Session logging failed:', e);
    return Response.json({ success: false, error: e.message }, { headers: corsHeaders });
  }
}

// Log survey response
async function handleLogSurvey(request, env, corsHeaders) {
  try {
    const { sessionId, caseId, rating } = await request.json();

    await env.ANALYTICS_DB.prepare(`
      INSERT INTO survey_responses (session_id, case_id, rating)
      VALUES (?, ?, ?)
    `).bind(sessionId, caseId, rating).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (e) {
    console.error('Survey logging failed:', e);
    return Response.json({ success: false, error: e.message }, { headers: corsHeaders });
  }
}

// Log policy block
async function handleLogPolicyBlock(request, env, corsHeaders) {
  try {
    const { sessionId, blockType, orderNumber, daysSince } = await request.json();

    await env.ANALYTICS_DB.prepare(`
      INSERT INTO policy_blocks (session_id, block_type, order_number, days_since)
      VALUES (?, ?, ?, ?)
    `).bind(sessionId, blockType, orderNumber, daysSince).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (e) {
    console.error('Policy block logging failed:', e);
    return Response.json({ success: false, error: e.message }, { headers: corsHeaders });
  }
}

// Handle trouble report submissions (users having issues with the app)
async function handleTroubleReport(request, env, corsHeaders) {
  try {
    const data = await request.json();

    const {
      name,
      email,
      description,
      sessionId,
      currentStep,
      customerEmail,
      orderData,
      browser,
      timestamp,
      sessionReplayUrl
    } = data;

    // Generate a reference ID for the report
    const reportId = 'TR-' + Date.now().toString(36).toUpperCase();

    // Create Richpanel conversation so team can respond to customer via email
    let richpanelResult = null;
    if (env.RICHPANEL_API_KEY && email) {
      try {
        richpanelResult = await createTroubleReportRichpanelEntry(env, {
          name,
          email,
          description,
          sessionId,
          currentStep,
          browser,
          sessionReplayUrl
        }, reportId);
      } catch (richpanelError) {
        console.error('Richpanel error:', richpanelError);
      }
    }

    // Log to analytics database
    try {
      await env.ANALYTICS_DB.prepare(`
        INSERT INTO issue_reports (
          report_id, name, email, description,
          session_id, current_step, browser, session_replay_url,
          richpanel_conversation_no, created_at
        )
        VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
      `).bind(
        reportId,
        name,
        email,
        description,
        sessionId || null,
        currentStep || null,
        browser || null,
        sessionReplayUrl || null,
        richpanelResult?.conversationNo || null
      ).run();
    } catch (dbError) {
      // Table might not exist yet or columns missing - try old table name for backwards compatibility
      console.log('Issue reports table issue, trying trouble_reports:', dbError.message);
      try {
        await env.ANALYTICS_DB.prepare(`
          INSERT INTO trouble_reports (
            report_id, name, email, description,
            session_id, current_step, browser, session_replay_url,
            richpanel_conversation_no, created_at
          )
          VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
        `).bind(
          reportId,
          name,
          email,
          description,
          sessionId || null,
          currentStep || null,
          browser || null,
          sessionReplayUrl || null,
          richpanelResult?.conversationNo || null
        ).run();
      } catch (e2) {
        // Try basic insert
        try {
          await env.ANALYTICS_DB.prepare(`
            INSERT INTO issue_reports (
            report_id, name, email, description,
            session_id, current_step, browser, created_at
          )
          VALUES (?, ?, ?, ?, ?, ?, ?, datetime('now'))
        `).bind(
          reportId,
          name,
          email,
          description,
          sessionId || null,
          currentStep || null,
          browser || null
        ).run();
      } catch (dbError2) {
        console.log('Basic insert also failed:', dbError2.message);
      }
      }  // Close catch(e2)
    }  // Close catch(dbError)

    const taskDescription = `
**TROUBLE REPORT: ${reportId}**

A customer reported an issue using the resolution app.

---

**Customer Details:**
â€¢ Name: ${name}
â€¢ Email: ${email}

**What went wrong:**
${description}

**Technical Info:**
â€¢ Session ID: ${sessionId || 'N/A'}
â€¢ Current Step: ${currentStep || 'N/A'}
â€¢ Browser: ${browser || 'N/A'}
â€¢ Timestamp: ${timestamp || new Date().toISOString()}
${sessionReplayUrl ? `â€¢ Session Recording: ${sessionReplayUrl}` : ''}
${richpanelResult?.conversationNo ? `â€¢ Richpanel Conversation: https://app.richpanel.com/conversations?viewId=search&conversationNo=${richpanelResult.conversationNo}` : ''}

---

**Action Required:**
1. Respond to customer via Richpanel conversation
2. If this is a bug, report it to the dev team
3. Help the customer complete their resolution manually if needed
`;

    // Log trouble report to D1 database for Hub visibility
    if (env.ANALYTICS_DB) {
      try {
        await env.ANALYTICS_DB.prepare(
          `INSERT INTO cases (
            case_id, case_type, resolution, customer_email, customer_name,
            order_number, status, session_id, session_replay_url,
            richpanel_conversation_no, extra_data, issue_type, created_at
          ) VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))`
        ).bind(
          reportId,
          'trouble_report',
          'manual_assistance',
          email || '',
          name || '',
          orderNumber || '',
          'pending',
          sessionId || null,
          sessionReplayUrl || null,
          richpanelResult?.conversationNo || null,
          JSON.stringify({ description, currentStep, browser, timestamp }),
          'app_issue'
        ).run();
      } catch (dbError) {
        console.error('D1 logging error for trouble report:', dbError);
      }
    }

    return Response.json({
      success: true,
      reportId: reportId,
      message: 'Report submitted successfully',
      richpanelConversationNo: richpanelResult?.conversationNo || null
    }, { headers: corsHeaders });

  } catch (error) {
    console.error('Trouble report error:', error);
    return Response.json({
      success: false,
      error: 'Failed to submit report'
    }, { status: 500, headers: corsHeaders });
  }
}

// Create Richpanel entry for trouble reports
async function createTroubleReportRichpanelEntry(env, reportData, reportId) {
  const testMode = isTestMode(env);
  const fromEmail = testMode
    ? RICHPANEL_CONFIG.testEmail
    : (reportData.email || RICHPANEL_CONFIG.testEmail);

  const customerName = reportData.name || 'Customer';
  const nameParts = customerName.split(' ');
  const firstName = nameParts[0] || 'Customer';
  const lastName = nameParts.slice(1).join(' ') || '';

  const subject = `${reportId} - Help Request - Resolution App`;

  // Build customer message (simulated email from customer - sounds natural)
  const testNotice = testMode
    ? '[TEST MODE - This is not a real customer request]<br><br>'
    : '';

  const customerMessage = `${testNotice}Hi,<br><br>
I need some help with my order. I was trying to use the Resolution Center but ran into a problem.<br><br>
${(reportData.description || 'No description provided').replace(/\n/g, '<br>')}<br><br>
Could you please help me sort this out?<br><br>
Thanks,<br>
${firstName}`;

  try {
    const response = await fetch('https://api.richpanel.com/v1/tickets', {
      method: 'POST',
      headers: {
        'Content-Type': 'application/json',
        'x-richpanel-key': env.RICHPANEL_API_KEY
      },
      body: JSON.stringify({
        ticket: {
          status: 'OPEN',
          subject: subject,
          comment: {
            sender_type: 'customer',
            body: customerMessage
          },
          customer_profile: {
            firstName: firstName,
            lastName: lastName
          },
          via: {
            channel: 'email',
            source: {
              from: { address: fromEmail },
              to: { address: RICHPANEL_CONFIG.supportEmail }
            }
          }
        }
      })
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('Richpanel API error for trouble report:', response.status, errorText);
      return { success: false, error: `Richpanel API error: ${response.status}` };
    }

    const result = await response.json();
    const ticketId = result.id || result.ticket?.id;
    const conversationNo = result.conversationNo ||
                           result.ticket?.conversationNo ||
                           result.conversation_no ||
                           result.ticket?.conversation_no ||
                           result.ticketNumber ||
                           result.ticket?.ticketNumber;

    // Add private note with action steps
    if (ticketId) {
      await createTroubleReportPrivateNote(env, ticketId, reportData, reportId);
    }

    console.log('Richpanel trouble report created:', { reportId, ticketId, conversationNo });

    return {
      success: true,
      ticketId,
      conversationNo,
      conversationUrl: conversationNo ? `https://app.richpanel.com/conversations?viewId=search&conversationNo=${conversationNo}` : null
    };
  } catch (error) {
    console.error('Richpanel trouble report error:', error);
    return { success: false, error: error.message };
  }
}

async function createTroubleReportPrivateNote(env, ticketId, reportData, reportId) {
  const sopUrl = SOP_URLS.trouble_report;

  const noteContent = `
<b>âš ï¸ TROUBLE REPORT: ${reportId}</b><br>
<br>
Customer reported an issue using the Resolution App and needs manual assistance.<br>
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
<b>Issue Description:</b><br>
${(reportData.description || 'No description provided').replace(/\n/g, '<br>')}<br>
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
<b>Action Steps:</b><br>
1. âœ… Respond to customer and understand what they need<br>
2. âœ… Help them complete their resolution manually if needed<br>
3. âœ… If this is a bug, notify the dev team<br>
4. âœ… Close ticket once resolved<br>
<br>
<b>â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€</b><br>
<br>
<b>Technical Info:</b><br>
â€¢ Session ID: ${reportData.sessionId || 'N/A'}<br>
â€¢ Current Step: ${reportData.currentStep || 'Unknown'}<br>
${reportData.sessionReplayUrl ? `<br>ðŸŽ¥ <b>Session Recording:</b> <a href="${reportData.sessionReplayUrl}">${reportData.sessionReplayUrl}</a><br>` : ''}
<br>
<b>SOP:</b> <a href="${sopUrl}">${sopUrl}</a>
`.trim();

  try {
    await fetch(`https://api.richpanel.com/v1/tickets/${ticketId}`, {
      method: 'PUT',
      headers: {
        'Content-Type': 'application/json',
        'x-richpanel-key': env.RICHPANEL_API_KEY
      },
      body: JSON.stringify({
        ticket: {
          comment: {
            body: noteContent,
            public: false,
            sender_type: 'operator'
          }
        }
      })
    });
  } catch (error) {
    console.error('Failed to create trouble report private note:', error);
  }
}

// Log case creation (called from handleCreateCase)
async function logCaseToAnalytics(env, caseData) {
  // Build customer name from first/last name if not directly provided
  let customerName = caseData.customerName;
  if (!customerName && caseData.customerFirstName) {
    customerName = caseData.customerFirstName;
    if (caseData.customerLastName) {
      customerName += ' ' + caseData.customerLastName;
    }
  }

  // Build extra_data JSON with all additional fields
  const extraData = JSON.stringify({
    // Subscription fields
    actionType: caseData.actionType || null,
    purchaseId: caseData.purchaseId || null,
    clientOrderId: caseData.clientOrderId || null,
    subscriptionProductName: caseData.subscriptionProductName || null,
    subscriptionStatus: caseData.subscriptionStatus || null,
    pauseDuration: caseData.pauseDuration || null,
    pauseResumeDate: caseData.pauseResumeDate || null,
    cancelReason: caseData.cancelReason || null,
    discountPercent: caseData.discountPercent || null,
    newFrequency: caseData.newFrequency || null, // For schedule changes
    previousFrequency: caseData.previousFrequency || null, // For schedule changes
    newAddress: caseData.newAddress || null, // For address changes
    // Other fields
    intentDetails: caseData.intentDetails || null,
    keepProduct: caseData.keepProduct,
    issueType: caseData.issueType || null,
    qualityDetails: caseData.qualityDetails || null,
    correctedAddress: caseData.correctedAddress || null,
    notes: caseData.notes || null,
    // Dog info (for dog_not_using cases)
    dogs: caseData.dogs || null,
    methodsTried: caseData.methodsTried || null,
  });

  // Try full insert first with extra_data and resolved_in_app, fall back to basic insert if columns don't exist
  try {
    const resolvedInApp = caseData.resolvedInApp ? 1 : 0;
    const status = caseData.resolvedInApp ? 'completed' : 'pending';
    // For self-resolved cases, set case_type and resolution to NULL (they're not cases, just records)
    const caseType = caseData.resolvedInApp ? null : caseData.caseType;
    const resolution = caseData.resolvedInApp ? null : caseData.resolution;
    
    console.log('Attempting to insert case to database:', {
      caseId: caseData.caseId,
      resolvedInApp: resolvedInApp,
      caseType: caseType,
      resolution: resolution,
      email: caseData.email,
      orderNumber: caseData.orderNumber
    });
    
    // First, ensure the resolved_in_app column exists (auto-migration)
    try {
      await env.ANALYTICS_DB.prepare(`
        ALTER TABLE cases ADD COLUMN resolved_in_app BOOLEAN DEFAULT 0
      `).run();
      console.log('Auto-migration: Added resolved_in_app column');
    } catch (migrationError) {
      // Column already exists or other error - that's fine
      if (!migrationError.message?.includes('duplicate column')) {
        console.log('Migration check (column may already exist):', migrationError.message);
      }
    }
    
    const result = await env.ANALYTICS_DB.prepare(`
      INSERT INTO cases (
        case_id, case_type, resolution, customer_email, customer_name,
        order_number, refund_amount, status, session_id,
        clickup_task_id, clickup_task_url, session_replay_url,
        order_url, order_date, richpanel_conversation_no, extra_data, issue_type, resolved_in_app, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      caseData.caseId,
      caseType,
      resolution,
      caseData.email,
      customerName || null,
      caseData.orderNumber,
      caseData.refundAmount || null,
      status,
      caseData.sessionId || null,
      caseData.clickupTaskId || null,
      caseData.clickupTaskUrl || null,
      caseData.sessionReplayUrl || null,
      caseData.orderUrl || null,
      caseData.orderDate || null,
      caseData.richpanelConversationNo || null,
      extraData,
      caseData.issueType || null,
      resolvedInApp
    ).run();
    
    console.log('Case saved to database (full with extra_data and resolved_in_app):', {
      caseId: caseData.caseId,
      resolvedInApp: resolvedInApp,
      success: result.success,
      meta: result.meta
    });
    
    // Verify the insert by querying it back
    if (caseData.resolvedInApp) {
      const verify = await env.ANALYTICS_DB.prepare(`
        SELECT case_id, resolved_in_app, case_type, resolution FROM cases WHERE case_id = ?
      `).bind(caseData.caseId).first();
      console.log('Verification query result:', verify);
    }
    
    return;
  } catch (e) {
    console.log('Full insert failed, trying without extra_data:', e.message);
  }

  // Try insert without extra_data column (but with resolved_in_app)
  try {
    const resolvedInApp = caseData.resolvedInApp ? 1 : 0;
    const status = caseData.resolvedInApp ? 'completed' : 'pending';
    const caseType = caseData.resolvedInApp ? null : caseData.caseType;
    const resolution = caseData.resolvedInApp ? null : caseData.resolution;
    
    await env.ANALYTICS_DB.prepare(`
      INSERT INTO cases (
        case_id, case_type, resolution, customer_email, customer_name,
        order_number, refund_amount, status, session_id,
        clickup_task_id, clickup_task_url, session_replay_url,
        order_url, order_date, richpanel_conversation_no, resolved_in_app, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      caseData.caseId,
      caseType,
      resolution,
      caseData.email,
      customerName || null,
      caseData.orderNumber,
      caseData.refundAmount || null,
      status,
      caseData.sessionId || null,
      caseData.clickupTaskId || null,
      caseData.clickupTaskUrl || null,
      caseData.sessionReplayUrl || null,
      caseData.orderUrl || null,
      caseData.orderDate || null,
      caseData.richpanelConversationNo || null,
      resolvedInApp
    ).run();
    console.log('Case saved to database (full):', caseData.caseId);
    return;
  } catch (e) {
    console.log('Full insert failed, trying basic insert:', e.message);
  }

  // Fallback: basic insert with only core columns (but with resolved_in_app)
  try {
    const resolvedInApp = caseData.resolvedInApp ? 1 : 0;
    const status = caseData.resolvedInApp ? 'completed' : 'pending';
    const caseType = caseData.resolvedInApp ? null : caseData.caseType;
    const resolution = caseData.resolvedInApp ? null : caseData.resolution;
    
    await env.ANALYTICS_DB.prepare(`
      INSERT INTO cases (
        case_id, case_type, resolution, customer_email, customer_name,
        order_number, refund_amount, status, session_id,
        clickup_task_id, clickup_task_url, resolved_in_app, created_at
      )
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      caseData.caseId,
      caseType,
      resolution,
      caseData.email,
      customerName || null,
      caseData.orderNumber,
      caseData.refundAmount || null,
      status,
      caseData.sessionId || null,
      caseData.clickupTaskId || null,
      caseData.clickupTaskUrl || null,
      resolvedInApp
    ).run();
    console.log('Case saved to database (basic):', caseData.caseId);
    return;
  } catch (e2) {
    console.log('Basic insert failed, trying minimal insert:', e2.message);
  }

  // Final fallback: minimal columns only (but with resolved_in_app)
  try {
    const resolvedInApp = caseData.resolvedInApp ? 1 : 0;
    const status = caseData.resolvedInApp ? 'completed' : 'pending';
    const caseType = caseData.resolvedInApp ? null : caseData.caseType;
    const resolution = caseData.resolvedInApp ? null : caseData.resolution;
    
    await env.ANALYTICS_DB.prepare(`
      INSERT INTO cases (case_id, case_type, resolution, customer_email, order_number, status, resolved_in_app, created_at)
      VALUES (?, ?, ?, ?, ?, ?, ?, datetime('now'))
    `).bind(
      caseData.caseId,
      caseType,
      resolution,
      caseData.email,
      caseData.orderNumber,
      status,
      resolvedInApp
    ).run();
    console.log('Case saved to database (minimal):', caseData.caseId);
  } catch (e3) {
    console.error('All case insert attempts failed:', e3.message);
  }
}

// ============================================
// ADMIN AUTHENTICATION
// Note: hashPassword, generateToken, verifyToken are imported from ./utils/auth.js
// ============================================

async function handleAdminLogin(request, env, corsHeaders) {
  try {
    const { username, password } = await request.json();

    const passwordHash = await hashPassword(password);

    const user = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM admin_users WHERE username = ? AND password_hash = ?
    `).bind(username, passwordHash).first();

    if (!user) {
      return Response.json({ success: false, error: 'Invalid credentials' }, { status: 401, headers: corsHeaders });
    }

    // Check if account is active
    if (user.is_active === 0) {
      return Response.json({ success: false, error: 'Account is disabled. Contact an administrator.' }, { status: 403, headers: corsHeaders });
    }

    // Update last login
    await env.ANALYTICS_DB.prepare(`
      UPDATE admin_users SET last_login = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(user.id).run();

    const token = await generateToken(username);

    return Response.json({
      success: true,
      token,
      user: {
        id: user.id,
        username: user.username,
        name: user.name,
        role: user.role,
        mustChangePassword: user.must_change_password === 1
      }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Login error:', e);
    return Response.json({ success: false, error: 'Login failed' }, { status: 500, headers: corsHeaders });
  }
}

// Admin setup - creates or updates admin user (one-time setup)
async function handleAdminSetup(request, env, corsHeaders) {
  try {
    const { username, password, setupKey } = await request.json();

    // Simple setup key protection (configured in ADMIN_CONFIG at top of file)
    if (setupKey !== ADMIN_CONFIG.setupKey) {
      return Response.json({ error: 'Invalid setup key' }, { status: 403, headers: corsHeaders });
    }

    if (!username || !password) {
      return Response.json({ error: 'Username and password required' }, { status: 400, headers: corsHeaders });
    }

    const passwordHash = await hashPassword(password);

    // Insert or replace admin user
    await env.ANALYTICS_DB.prepare(`
      INSERT OR REPLACE INTO admin_users (username, password_hash, name, role)
      VALUES (?, ?, 'Administrator', 'admin')
    `).bind(username, passwordHash).run();

    return Response.json({
      success: true,
      message: `Admin user '${username}' created successfully. You can now login at /admin`
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Admin setup error:', e);
    return Response.json({ error: 'Setup failed: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// USER MANAGEMENT (Admin Only)
// ============================================

// Helper: Verify token and get user with role
async function verifyAuthAndGetUser(request, env) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return { error: 'Unauthorized', status: 401 };
  }

  const token = authHeader.substring(7);
  const payload = await verifyToken(token);
  if (!payload) {
    return { error: 'Invalid or expired token', status: 401 };
  }

  // Get user details from database
  const user = await env.ANALYTICS_DB.prepare(`
    SELECT id, username, name, role, is_active FROM admin_users WHERE username = ?
  `).bind(payload.username).first();

  if (!user) {
    return { error: 'User not found', status: 401 };
  }

  if (user.is_active === 0) {
    return { error: 'Account is disabled', status: 403 };
  }

  return { user };
}

// Helper: Verify admin role (admin or super_admin)
async function verifyAdmin(request, env) {
  const result = await verifyAuthAndGetUser(request, env);
  if (result.error) return result;

  if (result.user.role !== 'admin' && result.user.role !== 'super_admin') {
    return { error: 'Admin access required', status: 403 };
  }

  return result;
}

// Helper: Verify super admin role
async function verifySuperAdmin(request, env) {
  const result = await verifyAuthAndGetUser(request, env);
  if (result.error) return result;

  if (result.user.role !== 'super_admin') {
    return { error: 'Super admin access required', status: 403 };
  }

  return result;
}

// Helper: Log audit event
async function logAudit(env, userId, userEmail, userName, actionType, actionCategory, resourceType, resourceId, details, oldValue, newValue, request) {
  try {
    const ip = request?.headers?.get('CF-Connecting-IP') || request?.headers?.get('X-Forwarded-For') || 'unknown';
    const ua = request?.headers?.get('User-Agent') || 'unknown';

    await env.ANALYTICS_DB.prepare(`
      INSERT INTO audit_log (user_id, user_email, user_name, action_type, action_category, resource_type, resource_id, details, old_value, new_value, ip_address, user_agent)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
    `).bind(
      userId, userEmail, userName, actionType, actionCategory, resourceType, resourceId,
      details ? JSON.stringify(details) : null,
      oldValue, newValue, ip, ua
    ).run();
  } catch (e) {
    console.error('Audit log error:', e);
  }
}

// List all users (Admin only)
async function handleListUsers(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    // Get all users with creator name
    // Use COALESCE to handle columns that might not exist yet (if migrations haven't run)
    const users = await env.ANALYTICS_DB.prepare(`
      SELECT 
        u.id, 
        u.username, 
        u.name, 
        u.email,
        u.role, 
        COALESCE(u.is_active, 1) as is_active, 
        COALESCE(u.must_change_password, 0) as must_change_password, 
        u.created_at, 
        u.last_login, 
        u.last_activity_at, 
        u.created_by,
        creator.name as created_by_name
      FROM admin_users u
      LEFT JOIN admin_users creator ON u.created_by = creator.id
      ORDER BY u.created_at DESC
    `).all();

    return Response.json({ success: true, users: users.results || [] }, { headers: corsHeaders });
  } catch (e) {
    console.error('List users error:', e);
    // Try a simpler query if the full one fails (columns might not exist)
    try {
      const users = await env.ANALYTICS_DB.prepare(`
        SELECT 
          id, 
          username, 
          name, 
          email,
          role, 
          created_at, 
          last_login
        FROM admin_users
        ORDER BY created_at DESC
      `).all();
      
      // Add default values for missing columns
      const usersWithDefaults = (users.results || []).map(u => ({
        ...u,
        is_active: 1,
        must_change_password: 0,
        last_activity_at: null,
        created_by: null,
        created_by_name: null
      }));
      
      return Response.json({ success: true, users: usersWithDefaults }, { headers: corsHeaders });
    } catch (e2) {
      console.error('Fallback list users error:', e2);
      return Response.json({ error: 'Failed to list users: ' + e.message }, { status: 500, headers: corsHeaders });
    }
  }
}

// Create new user (Admin or Super Admin)
// Super admins can create admin accounts
// Admins can only create user accounts
async function handleCreateUser(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { username, name, role, password, email } = await request.json();

    if (!username || !name || !password || !email) {
      return Response.json({ error: 'Username, email, name, and password are required' }, { status: 400, headers: corsHeaders });
    }

    // Validate role based on current user's role
    const validRoles = ['user'];
    if (auth.user.role === 'super_admin') {
      validRoles.push('admin'); // Super admins can create admin accounts
    }

    if (!validRoles.includes(role)) {
      if (auth.user.role === 'admin' && role === 'admin') {
        return Response.json({ error: 'Admins cannot create admin accounts. Only super admins can create admin accounts.' }, { status: 403, headers: corsHeaders });
      }
      return Response.json({ error: `Invalid role. Must be one of: ${validRoles.join(', ')}` }, { status: 400, headers: corsHeaders });
    }

    // Check if username exists
    const existing = await env.ANALYTICS_DB.prepare(`
      SELECT id FROM admin_users WHERE username = ?
    `).bind(username).first();

    if (existing) {
      return Response.json({ error: 'Username already exists' }, { status: 400, headers: corsHeaders });
    }

    const passwordHash = await hashPassword(password);

    // Create user with full column set
    await env.ANALYTICS_DB.prepare(`
      INSERT INTO admin_users (username, password_hash, name, email, role, is_active, must_change_password, created_by)
      VALUES (?, ?, ?, ?, ?, 1, 0, ?)
    `).bind(username, passwordHash, name, email, role, auth.user.id).run();

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'user_created', 'users', 'user', username, { name, role, email }, null, username, request);

    return Response.json({
      success: true,
      message: `User '${username}' created successfully. Share these credentials with the user: Username: ${username}, Password: ${password}`
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Create user error:', e);
    return Response.json({ error: 'Failed to create user: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Update user (Admin only)
async function handleUpdateUser(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { userId, name, role, is_active, resetPassword } = await request.json();

    if (!userId) {
      return Response.json({ error: 'User ID is required' }, { status: 400, headers: corsHeaders });
    }

    // Get current user data
    const currentUser = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM admin_users WHERE id = ?
    `).bind(userId).first();

    if (!currentUser) {
      return Response.json({ error: 'User not found' }, { status: 404, headers: corsHeaders });
    }

    // Prevent deactivating yourself
    if (userId === auth.user.id && is_active === false) {
      return Response.json({ error: 'Cannot deactivate your own account' }, { status: 400, headers: corsHeaders });
    }

    // Build update query
    const updates = [];
    const values = [];
    const changes = {};

    if (name !== undefined && name !== currentUser.name) {
      updates.push('name = ?');
      values.push(name);
      changes.name = { old: currentUser.name, new: name };
    }

    if (role !== undefined && role !== currentUser.role) {
      const validRoles = ['admin', 'user'];
      if (!validRoles.includes(role)) {
        return Response.json({ error: 'Invalid role' }, { status: 400, headers: corsHeaders });
      }
      updates.push('role = ?');
      values.push(role);
      changes.role = { old: currentUser.role, new: role };
    }

    if (is_active !== undefined && is_active !== currentUser.is_active) {
      updates.push('is_active = ?');
      values.push(is_active ? 1 : 0);
      changes.is_active = { old: currentUser.is_active, new: is_active };
    }

    if (resetPassword) {
      // Generate a temporary password
      const tempPassword = 'temp' + Math.random().toString(36).substring(2, 10);
      const passwordHash = await hashPassword(tempPassword);
      updates.push('password_hash = ?');
      updates.push('must_change_password = 1');
      values.push(passwordHash);
      changes.password = { reset: true, tempPassword };
    }

    if (updates.length === 0) {
      return Response.json({ error: 'No changes provided' }, { status: 400, headers: corsHeaders });
    }

    updates.push('updated_at = CURRENT_TIMESTAMP');
    values.push(userId);

    await env.ANALYTICS_DB.prepare(`
      UPDATE admin_users SET ${updates.join(', ')} WHERE id = ?
    `).bind(...values).run();

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'user_updated', 'users', 'user', currentUser.username, changes, JSON.stringify(currentUser), null, request);

    const response = { success: true, message: 'User updated successfully' };
    if (resetPassword && changes.password) {
      response.tempPassword = changes.password.tempPassword;
      response.message += `. Temporary password: ${changes.password.tempPassword}`;
    }

    return Response.json(response, { headers: corsHeaders });
  } catch (e) {
    console.error('Update user error:', e);
    return Response.json({ error: 'Failed to update user: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Delete user (Admin only)
async function handleDeleteUser(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const userId = url.pathname.split('/').pop();

    if (!userId) {
      return Response.json({ error: 'User ID is required' }, { status: 400, headers: corsHeaders });
    }

    // Prevent deleting yourself
    if (parseInt(userId) === auth.user.id) {
      return Response.json({ error: 'Cannot delete your own account' }, { status: 400, headers: corsHeaders });
    }

    // Get user for audit
    const user = await env.ANALYTICS_DB.prepare(`
      SELECT username, name FROM admin_users WHERE id = ?
    `).bind(userId).first();

    if (!user) {
      return Response.json({ error: 'User not found' }, { status: 404, headers: corsHeaders });
    }

    await env.ANALYTICS_DB.prepare(`
      DELETE FROM admin_users WHERE id = ?
    `).bind(userId).run();

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'user_deleted', 'users', 'user', user.username, { deletedUser: user.name }, user.username, null, request);

    return Response.json({ success: true, message: 'User deleted successfully' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Delete user error:', e);
    return Response.json({ error: 'Failed to delete user: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Update own profile (any logged-in user)
async function handleUpdateProfile(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { name, email, currentPassword, newPassword } = await request.json();

    if (!name || !email) {
      return Response.json({ error: 'Name and email are required' }, { status: 400, headers: corsHeaders });
    }

    // Check if email is being changed to one that already exists
    if (email !== auth.user.username) {
      const existing = await env.ANALYTICS_DB.prepare(`
        SELECT id FROM admin_users WHERE username = ? AND id != ?
      `).bind(email, auth.user.id).first();
      if (existing) {
        return Response.json({ error: 'Email address already in use' }, { status: 400, headers: corsHeaders });
      }
    }

    // If changing password, verify current password
    if (newPassword) {
      if (!currentPassword) {
        return Response.json({ error: 'Current password required to change password' }, { status: 400, headers: corsHeaders });
      }
      if (newPassword.length < 6) {
        return Response.json({ error: 'New password must be at least 6 characters' }, { status: 400, headers: corsHeaders });
      }

      const userFull = await env.ANALYTICS_DB.prepare(`
        SELECT password_hash FROM admin_users WHERE id = ?
      `).bind(auth.user.id).first();

      const currentHash = await hashPassword(currentPassword);
      if (currentHash !== userFull.password_hash) {
        return Response.json({ error: 'Current password is incorrect' }, { status: 400, headers: corsHeaders });
      }

      const newPasswordHash = await hashPassword(newPassword);
      await env.ANALYTICS_DB.prepare(`
        UPDATE admin_users SET name = ?, username = ?, password_hash = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(name, email, newPasswordHash, auth.user.id).run();
    } else {
      await env.ANALYTICS_DB.prepare(`
        UPDATE admin_users SET name = ?, username = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
      `).bind(name, email, auth.user.id).run();
    }

    return Response.json({ success: true, message: 'Profile updated successfully' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Update profile error:', e);
    return Response.json({ error: 'Failed to update profile: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Admin: Reset another user's password
async function handleResetUserPassword(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const userId = parseInt(url.pathname.split('/')[4]);
    const { newPassword } = await request.json();

    if (!newPassword || newPassword.length < 6) {
      return Response.json({ error: 'New password must be at least 6 characters' }, { status: 400, headers: corsHeaders });
    }

    // Get user to reset
    const user = await env.ANALYTICS_DB.prepare(`
      SELECT id, username, name FROM admin_users WHERE id = ?
    `).bind(userId).first();

    if (!user) {
      return Response.json({ error: 'User not found' }, { status: 404, headers: corsHeaders });
    }

    const newPasswordHash = await hashPassword(newPassword);
    await env.ANALYTICS_DB.prepare(`
      UPDATE admin_users SET password_hash = ?, must_change_password = 1, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(newPasswordHash, userId).run();

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'password_reset', 'users', 'user', user.username, { resetFor: user.name }, user.username, null, request);

    return Response.json({ success: true, message: 'Password reset successfully. User will be required to change it on next login.' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Reset password error:', e);
    return Response.json({ error: 'Failed to reset password: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Change own password
async function handleChangePassword(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { currentPassword, newPassword } = await request.json();

    if (!newPassword || newPassword.length < 6) {
      return Response.json({ error: 'New password must be at least 6 characters' }, { status: 400, headers: corsHeaders });
    }

    // If not must_change_password, verify current password
    const userFull = await env.ANALYTICS_DB.prepare(`
      SELECT password_hash, must_change_password FROM admin_users WHERE id = ?
    `).bind(auth.user.id).first();

    if (!userFull.must_change_password) {
      if (!currentPassword) {
        return Response.json({ error: 'Current password is required' }, { status: 400, headers: corsHeaders });
      }
      const currentHash = await hashPassword(currentPassword);
      if (currentHash !== userFull.password_hash) {
        return Response.json({ error: 'Current password is incorrect' }, { status: 400, headers: corsHeaders });
      }
    }

    const newPasswordHash = await hashPassword(newPassword);

    await env.ANALYTICS_DB.prepare(`
      UPDATE admin_users SET password_hash = ?, must_change_password = 0, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(newPasswordHash, auth.user.id).run();

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'password_changed', 'auth', 'user', auth.user.username, null, null, null, request);

    return Response.json({ success: true, message: 'Password changed successfully' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Change password error:', e);
    return Response.json({ error: 'Failed to change password: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Get current user profile
async function handleGetProfile(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const user = await env.ANALYTICS_DB.prepare(`
      SELECT id, username, name, email, role, is_active, must_change_password, created_at, last_login
      FROM admin_users WHERE id = ?
    `).bind(auth.user.id).first();

    return Response.json({ success: true, user }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get profile error:', e);
    return Response.json({ error: 'Failed to get profile' }, { status: 500, headers: corsHeaders });
  }
}

// Get user activity log (Admin only)
async function handleGetUserActivityLog(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const userId = parseInt(url.pathname.split('/')[4]);
    const page = parseInt(url.searchParams.get('page')) || 1;
    const limit = parseInt(url.searchParams.get('limit')) || 50;
    const offset = (page - 1) * limit;

    // Verify user exists
    const user = await env.ANALYTICS_DB.prepare(`
      SELECT id, username, name FROM admin_users WHERE id = ?
    `).bind(userId).first();

    if (!user) {
      return Response.json({ error: 'User not found' }, { status: 404, headers: corsHeaders });
    }

    // Get activity logs for this user
    const logs = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM audit_log 
      WHERE user_id = ?
      ORDER BY created_at DESC
      LIMIT ? OFFSET ?
    `).bind(userId, limit, offset).all();

    // Get total count
    const total = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as count FROM audit_log WHERE user_id = ?
    `).bind(userId).first();

    return Response.json({
      success: true,
      user: { id: user.id, username: user.username, name: user.name },
      logs: logs.results || [],
      pagination: {
        page,
        limit,
        total: total?.count || 0,
        totalPages: Math.ceil((total?.count || 0) / limit)
      }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get user activity log error:', e);
    return Response.json({ error: 'Failed to get user activity log' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// AUDIT LOG (Admin Only)
// ============================================

async function handleGetAuditLog(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const page = parseInt(url.searchParams.get('page')) || 1;
    const limit = parseInt(url.searchParams.get('limit')) || 50;
    const category = url.searchParams.get('category');
    const userId = url.searchParams.get('userId');
    const offset = (page - 1) * limit;

    let query = `SELECT * FROM audit_log WHERE 1=1`;
    const params = [];

    if (category) {
      query += ` AND action_category = ?`;
      params.push(category);
    }

    if (userId) {
      query += ` AND user_id = ?`;
      params.push(userId);
    }

    query += ` ORDER BY created_at DESC LIMIT ? OFFSET ?`;
    params.push(limit, offset);

    const logs = await env.ANALYTICS_DB.prepare(query).bind(...params).all();

    // Get total count
    let countQuery = `SELECT COUNT(*) as count FROM audit_log WHERE 1=1`;
    const countParams = [];
    if (category) {
      countQuery += ` AND action_category = ?`;
      countParams.push(category);
    }
    if (userId) {
      countQuery += ` AND user_id = ?`;
      countParams.push(userId);
    }
    const total = await env.ANALYTICS_DB.prepare(countQuery).bind(...countParams).first();

    return Response.json({
      success: true,
      logs: logs.results || [],
      pagination: {
        page,
        limit,
        total: total?.count || 0,
        totalPages: Math.ceil((total?.count || 0) / limit)
      }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get audit log error:', e);
    return Response.json({ error: 'Failed to get audit log' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// BULK ACTIONS
// ============================================

// Bulk update case status (no auth required - same as single case update)
async function handleBulkUpdateStatus(request, env, corsHeaders) {
  try {
    const { caseIds, status, actor, actor_email } = await request.json();

    if (!caseIds || !Array.isArray(caseIds) || caseIds.length === 0) {
      return Response.json({ error: 'Case IDs are required' }, { status: 400, headers: corsHeaders });
    }

    const validStatuses = ['pending', 'in_progress', 'completed', 'cancelled'];
    if (!validStatuses.includes(status)) {
      return Response.json({ error: 'Invalid status' }, { status: 400, headers: corsHeaders });
    }

    // Limit bulk operations
    if (caseIds.length > 100) {
      return Response.json({ error: 'Maximum 100 cases per bulk operation' }, { status: 400, headers: corsHeaders });
    }

    const actorName = actor || actor_email || 'team_member';
    const placeholders = caseIds.map(() => '?').join(',');
    const resolvedFields = status === 'completed' ? `, resolved_at = CURRENT_TIMESTAMP, resolved_by = ?` : '';
    const bindings = status === 'completed' ? [status, actorName, ...caseIds] : [status, ...caseIds];

    await env.ANALYTICS_DB.prepare(`
      UPDATE cases SET status = ?, updated_at = CURRENT_TIMESTAMP ${resolvedFields} WHERE case_id IN (${placeholders})
    `).bind(...bindings).run();

    return Response.json({
      success: true,
      message: `${caseIds.length} case(s) updated to ${status}`,
      updatedCount: caseIds.length
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Bulk update status error:', e);
    return Response.json({ error: 'Failed to update cases: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Bulk assign cases
async function handleBulkAssign(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { caseIds, assignToUserId } = await request.json();

    if (!caseIds || !Array.isArray(caseIds) || caseIds.length === 0) {
      return Response.json({ error: 'Case IDs are required' }, { status: 400, headers: corsHeaders });
    }

    if (caseIds.length > 100) {
      return Response.json({ error: 'Maximum 100 cases per bulk operation' }, { status: 400, headers: corsHeaders });
    }

    // Get assignee info
    let assigneeName = null;
    if (assignToUserId) {
      const assignee = await env.ANALYTICS_DB.prepare(`
        SELECT name FROM admin_users WHERE id = ? AND is_active = 1
      `).bind(assignToUserId).first();
      if (!assignee) {
        return Response.json({ error: 'Assignee not found or inactive' }, { status: 400, headers: corsHeaders });
      }
      assigneeName = assignee.name;
    }

    const placeholders = caseIds.map(() => '?').join(',');

    await env.ANALYTICS_DB.prepare(`
      UPDATE cases SET assigned_to = ?, updated_at = CURRENT_TIMESTAMP WHERE case_id IN (${placeholders})
    `).bind(assigneeName, ...caseIds).run();

    // Update assignment queue load
    if (assignToUserId) {
      await env.ANALYTICS_DB.prepare(`
        UPDATE assignment_queue SET current_load = current_load + ?, last_assigned_at = CURRENT_TIMESTAMP WHERE user_id = ?
      `).bind(caseIds.length, assignToUserId).run();
    }

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'bulk_assignment', 'cases', 'case', null,
      { caseIds, assignedTo: assigneeName, count: caseIds.length }, null, assigneeName, request);

    return Response.json({
      success: true,
      message: assigneeName ? `${caseIds.length} case(s) assigned to ${assigneeName}` : `${caseIds.length} case(s) unassigned`,
      updatedCount: caseIds.length
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Bulk assign error:', e);
    return Response.json({ error: 'Failed to assign cases: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Bulk add comment
async function handleBulkAddComment(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { caseIds, comment } = await request.json();

    if (!caseIds || !Array.isArray(caseIds) || caseIds.length === 0) {
      return Response.json({ error: 'Case IDs are required' }, { status: 400, headers: corsHeaders });
    }

    if (!comment || comment.trim().length === 0) {
      return Response.json({ error: 'Comment is required' }, { status: 400, headers: corsHeaders });
    }

    if (caseIds.length > 50) {
      return Response.json({ error: 'Maximum 50 cases per bulk comment operation' }, { status: 400, headers: corsHeaders });
    }

    // Insert comments for each case
    for (const caseId of caseIds) {
      await env.ANALYTICS_DB.prepare(`
        INSERT INTO case_comments (case_id, author, author_email, comment)
        VALUES (?, ?, ?, ?)
      `).bind(caseId, auth.user.name, auth.user.username, comment.trim()).run();
    }

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'bulk_comment', 'cases', 'case', null,
      { caseIds, commentPreview: comment.substring(0, 50), count: caseIds.length }, null, null, request);

    return Response.json({
      success: true,
      message: `Comment added to ${caseIds.length} case(s)`,
      updatedCount: caseIds.length
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Bulk add comment error:', e);
    return Response.json({ error: 'Failed to add comments: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Export cases to CSV
async function handleExportCases(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { caseIds } = await request.json();

    let query = `SELECT * FROM cases`;
    const params = [];

    if (caseIds && Array.isArray(caseIds) && caseIds.length > 0) {
      const placeholders = caseIds.map(() => '?').join(',');
      query += ` WHERE case_id IN (${placeholders})`;
      params.push(...caseIds);
    }

    query += ` ORDER BY created_at DESC LIMIT 1000`;

    const cases = await env.ANALYTICS_DB.prepare(query).bind(...params).all();

    // Convert to CSV
    const headers = ['case_id', 'case_type', 'resolution', 'status', 'customer_email', 'customer_name', 'order_number', 'refund_amount', 'assigned_to', 'created_at', 'resolved_at'];
    const csvRows = [headers.join(',')];

    for (const c of (cases.results || [])) {
      const row = headers.map(h => {
        const val = c[h] || '';
        // Escape commas and quotes
        if (String(val).includes(',') || String(val).includes('"')) {
          return `"${String(val).replace(/"/g, '""')}"`;
        }
        return val;
      });
      csvRows.push(row.join(','));
    }

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'export_cases', 'cases', 'case', null,
      { count: cases.results?.length || 0, filtered: !!caseIds }, null, null, request);

    return new Response(csvRows.join('\n'), {
      headers: {
        ...corsHeaders,
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="cases-export-${new Date().toISOString().split('T')[0]}.csv"`
      }
    });
  } catch (e) {
    console.error('Export cases error:', e);
    return Response.json({ error: 'Failed to export cases: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// ASSIGNMENT SYSTEM (Admin Only)
// ============================================

// Get assignment queue
async function handleGetAssignmentQueue(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const queue = await env.ANALYTICS_DB.prepare(`
      SELECT aq.*, au.name as user_name, au.username, au.is_active as user_active
      FROM assignment_queue aq
      JOIN admin_users au ON aq.user_id = au.id
      ORDER BY aq.sort_order ASC, aq.created_at ASC
    `).all();

    return Response.json({ success: true, queue: queue.results || [] }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get assignment queue error:', e);
    return Response.json({ error: 'Failed to get assignment queue' }, { status: 500, headers: corsHeaders });
  }
}

// Update assignment queue
async function handleUpdateAssignmentQueue(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { userId, caseType, isActive, maxLoad, sortOrder } = await request.json();

    if (!userId) {
      return Response.json({ error: 'User ID is required' }, { status: 400, headers: corsHeaders });
    }

    // Check if entry exists
    const existing = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM assignment_queue WHERE user_id = ? AND (case_type = ? OR (case_type IS NULL AND ? IS NULL))
    `).bind(userId, caseType, caseType).first();

    if (existing) {
      // Update existing
      await env.ANALYTICS_DB.prepare(`
        UPDATE assignment_queue SET is_active = ?, max_load = ?, sort_order = ? WHERE id = ?
      `).bind(isActive ? 1 : 0, maxLoad || 10, sortOrder || 0, existing.id).run();
    } else {
      // Insert new
      await env.ANALYTICS_DB.prepare(`
        INSERT INTO assignment_queue (user_id, case_type, is_active, max_load, sort_order)
        VALUES (?, ?, ?, ?, ?)
      `).bind(userId, caseType, isActive ? 1 : 0, maxLoad || 10, sortOrder || 0).run();
    }

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'assignment_queue_updated', 'system', 'assignment_queue', userId,
      { caseType, isActive, maxLoad, sortOrder }, null, null, request);

    return Response.json({ success: true, message: 'Assignment queue updated' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Update assignment queue error:', e);
    return Response.json({ error: 'Failed to update assignment queue: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Round robin assignment - get next assignee
async function handleGetNextAssignee(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const caseType = url.searchParams.get('caseType');

    // Get next available user in round robin (least recently assigned, under max load, active)
    const nextAssignee = await env.ANALYTICS_DB.prepare(`
      SELECT aq.*, au.name as user_name, au.username
      FROM assignment_queue aq
      JOIN admin_users au ON aq.user_id = au.id
      WHERE aq.is_active = 1
        AND au.is_active = 1
        AND aq.current_load < aq.max_load
        AND (aq.case_type IS NULL OR aq.case_type = ?)
      ORDER BY aq.last_assigned_at ASC NULLS FIRST, aq.sort_order ASC
      LIMIT 1
    `).bind(caseType).first();

    if (!nextAssignee) {
      return Response.json({
        success: true,
        assignee: null,
        message: 'No available assignees in queue'
      }, { headers: corsHeaders });
    }

    return Response.json({
      success: true,
      assignee: {
        userId: nextAssignee.user_id,
        name: nextAssignee.user_name,
        username: nextAssignee.username,
        currentLoad: nextAssignee.current_load,
        maxLoad: nextAssignee.max_load
      }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get next assignee error:', e);
    return Response.json({ error: 'Failed to get next assignee' }, { status: 500, headers: corsHeaders });
  }
}

// Auto-assign case via round robin
async function handleAutoAssign(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { caseId, caseType } = await request.json();

    if (!caseId) {
      return Response.json({ error: 'Case ID is required' }, { status: 400, headers: corsHeaders });
    }

    // Get next available user
    const nextAssignee = await env.ANALYTICS_DB.prepare(`
      SELECT aq.*, au.name as user_name
      FROM assignment_queue aq
      JOIN admin_users au ON aq.user_id = au.id
      WHERE aq.is_active = 1
        AND au.is_active = 1
        AND aq.current_load < aq.max_load
        AND (aq.case_type IS NULL OR aq.case_type = ?)
      ORDER BY aq.last_assigned_at ASC NULLS FIRST, aq.sort_order ASC
      LIMIT 1
    `).bind(caseType).first();

    if (!nextAssignee) {
      return Response.json({ error: 'No available assignees in queue' }, { status: 400, headers: corsHeaders });
    }

    // Assign case
    await env.ANALYTICS_DB.prepare(`
      UPDATE cases SET assigned_to = ?, updated_at = CURRENT_TIMESTAMP WHERE case_id = ?
    `).bind(nextAssignee.user_name, caseId).run();

    // Update queue
    await env.ANALYTICS_DB.prepare(`
      UPDATE assignment_queue SET current_load = current_load + 1, last_assigned_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(nextAssignee.id).run();

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'auto_assignment', 'cases', 'case', caseId,
      { assignedTo: nextAssignee.user_name, method: 'round_robin' }, null, nextAssignee.user_name, request);

    return Response.json({
      success: true,
      message: `Case assigned to ${nextAssignee.user_name}`,
      assignee: nextAssignee.user_name
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Auto assign error:', e);
    return Response.json({ error: 'Failed to auto-assign case: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Recalculate assignment loads (for maintenance)
async function handleRecalculateLoads(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    // Get all users in assignment queue
    const queueUsers = await env.ANALYTICS_DB.prepare(`
      SELECT aq.id, aq.user_id, au.name FROM assignment_queue aq JOIN admin_users au ON aq.user_id = au.id
    `).all();

    for (const qu of (queueUsers.results || [])) {
      // Count open cases assigned to this user
      const openCases = await env.ANALYTICS_DB.prepare(`
        SELECT COUNT(*) as count FROM cases WHERE assigned_to = ? AND status IN ('pending', 'in_progress')
      `).bind(qu.name).first();

      await env.ANALYTICS_DB.prepare(`
        UPDATE assignment_queue SET current_load = ? WHERE id = ?
      `).bind(openCases?.count || 0, qu.id).run();
    }

    return Response.json({ success: true, message: 'Assignment loads recalculated' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Recalculate loads error:', e);
    return Response.json({ error: 'Failed to recalculate loads' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// SAVED VIEWS
// ============================================

// Get saved views for current user
async function handleGetSavedViews(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    // Try with sort_order first, fall back to just created_at if column doesn't exist
    let views;
    try {
      views = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM saved_views WHERE user_id = ? ORDER BY sort_order ASC, created_at ASC
    `).bind(auth.user.id).all();
    } catch (e) {
      // Fallback if sort_order column doesn't exist
      views = await env.ANALYTICS_DB.prepare(`
        SELECT * FROM saved_views WHERE user_id = ? ORDER BY created_at ASC
      `).bind(auth.user.id).all();
    }

    return Response.json({ success: true, views: views.results || [] }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get saved views error:', e);
    return Response.json({ error: 'Failed to get saved views' }, { status: 500, headers: corsHeaders });
  }
}

// Create saved view
async function handleCreateSavedView(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { name, filters, isDefault } = await request.json();

    if (!name || !filters) {
      return Response.json({ error: 'Name and filters are required' }, { status: 400, headers: corsHeaders });
    }

    // Check limit (max 20 views per user)
    const count = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as count FROM saved_views WHERE user_id = ?
    `).bind(auth.user.id).first();

    if (count?.count >= 20) {
      return Response.json({ error: 'Maximum 20 saved views allowed' }, { status: 400, headers: corsHeaders });
    }

    // If setting as default, unset other defaults
    if (isDefault) {
      await env.ANALYTICS_DB.prepare(`
        UPDATE saved_views SET is_default = 0 WHERE user_id = ?
      `).bind(auth.user.id).run();
    }

    const result = await env.ANALYTICS_DB.prepare(`
      INSERT INTO saved_views (user_id, name, filters, is_default, sort_order)
      VALUES (?, ?, ?, ?, (SELECT COALESCE(MAX(sort_order), 0) + 1 FROM saved_views WHERE user_id = ?))
    `).bind(auth.user.id, name, JSON.stringify(filters), isDefault ? 1 : 0, auth.user.id).run();

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'view_created', 'views', 'saved_view', result.meta?.last_row_id,
      { name, filters }, null, name, request);

    return Response.json({ success: true, message: 'View saved', viewId: result.meta?.last_row_id }, { headers: corsHeaders });
  } catch (e) {
    console.error('Create saved view error:', e);
    return Response.json({ error: 'Failed to create saved view: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Update saved view
async function handleUpdateSavedView(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { viewId, name, filters, isDefault, sortOrder } = await request.json();

    if (!viewId) {
      return Response.json({ error: 'View ID is required' }, { status: 400, headers: corsHeaders });
    }

    // Verify ownership
    const view = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM saved_views WHERE id = ? AND user_id = ?
    `).bind(viewId, auth.user.id).first();

    if (!view) {
      return Response.json({ error: 'View not found' }, { status: 404, headers: corsHeaders });
    }

    // If setting as default, unset other defaults
    if (isDefault) {
      await env.ANALYTICS_DB.prepare(`
        UPDATE saved_views SET is_default = 0 WHERE user_id = ?
      `).bind(auth.user.id).run();
    }

    const updates = [];
    const values = [];

    if (name !== undefined) {
      updates.push('name = ?');
      values.push(name);
    }
    if (filters !== undefined) {
      updates.push('filters = ?');
      values.push(JSON.stringify(filters));
    }
    if (isDefault !== undefined) {
      updates.push('is_default = ?');
      values.push(isDefault ? 1 : 0);
    }
    if (sortOrder !== undefined) {
      updates.push('sort_order = ?');
      values.push(sortOrder);
    }

    updates.push('updated_at = CURRENT_TIMESTAMP');
    values.push(viewId);

    await env.ANALYTICS_DB.prepare(`
      UPDATE saved_views SET ${updates.join(', ')} WHERE id = ?
    `).bind(...values).run();

    return Response.json({ success: true, message: 'View updated' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Update saved view error:', e);
    return Response.json({ error: 'Failed to update saved view: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Delete saved view
async function handleDeleteSavedView(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const viewId = url.pathname.split('/').pop();

    if (!viewId) {
      return Response.json({ error: 'View ID is required' }, { status: 400, headers: corsHeaders });
    }

    // Verify ownership
    const view = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM saved_views WHERE id = ? AND user_id = ?
    `).bind(viewId, auth.user.id).first();

    if (!view) {
      return Response.json({ error: 'View not found' }, { status: 404, headers: corsHeaders });
    }

    await env.ANALYTICS_DB.prepare(`
      DELETE FROM saved_views WHERE id = ?
    `).bind(viewId).run();

    // Log audit
    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'view_deleted', 'views', 'saved_view', viewId,
      { name: view.name }, view.name, null, request);

    return Response.json({ success: true, message: 'View deleted' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Delete saved view error:', e);
    return Response.json({ error: 'Failed to delete saved view: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// COMPLETION CHECKLISTS
// ============================================

// Get checklist items for a case type
async function handleGetChecklistItems(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const caseType = url.searchParams.get('caseType');
    const resolution = url.searchParams.get('resolution');

    let query = `
      SELECT * FROM completion_checklists
      WHERE is_active = 1 AND case_type = ?
      AND (resolution_pattern IS NULL OR ? LIKE resolution_pattern)
      ORDER BY sort_order ASC
    `;

    const items = await env.ANALYTICS_DB.prepare(query).bind(caseType, resolution || '').all();

    return Response.json({ success: true, items: items.results || [] }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get checklist items error:', e);
    return Response.json({ error: 'Failed to get checklist items' }, { status: 500, headers: corsHeaders });
  }
}

// Get checklist status for a specific case
async function handleGetCaseChecklistStatus(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const caseId = url.pathname.split('/')[4]; // /hub/api/case/{caseId}/checklist

    // Get case info
    const caseInfo = await env.ANALYTICS_DB.prepare(`
      SELECT case_type, resolution FROM cases WHERE case_id = ?
    `).bind(caseId).first();

    if (!caseInfo) {
      return Response.json({ error: 'Case not found' }, { status: 404, headers: corsHeaders });
    }

    // Get checklist items for this case type
    const items = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM completion_checklists
      WHERE is_active = 1 AND case_type = ?
      AND (resolution_pattern IS NULL OR ? LIKE resolution_pattern)
      ORDER BY sort_order ASC
    `).bind(caseInfo.case_type, caseInfo.resolution || '').all();

    // Get completed items for this case
    const completions = await env.ANALYTICS_DB.prepare(`
      SELECT cc.*, au.name as completed_by_name
      FROM checklist_completions cc
      LEFT JOIN admin_users au ON cc.completed_by = au.id
      WHERE cc.case_id = ?
    `).bind(caseId).all();

    const completedIds = new Set((completions.results || []).map(c => c.checklist_item_id));

    const checklistWithStatus = (items.results || []).map(item => ({
      ...item,
      isCompleted: completedIds.has(item.id),
      completedBy: completions.results?.find(c => c.checklist_item_id === item.id)?.completed_by_name,
      completedAt: completions.results?.find(c => c.checklist_item_id === item.id)?.completed_at
    }));

    return Response.json({
      success: true,
      checklist: checklistWithStatus,
      allRequiredComplete: checklistWithStatus.filter(i => i.is_required).every(i => i.isCompleted)
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get case checklist status error:', e);
    return Response.json({ error: 'Failed to get checklist status' }, { status: 500, headers: corsHeaders });
  }
}

// Mark checklist item as complete
async function handleCompleteChecklistItem(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { caseId, checklistItemId, completed } = await request.json();

    if (!caseId || !checklistItemId) {
      return Response.json({ error: 'Case ID and checklist item ID are required' }, { status: 400, headers: corsHeaders });
    }

    if (completed) {
      // Mark as completed
      await env.ANALYTICS_DB.prepare(`
        INSERT OR REPLACE INTO checklist_completions (case_id, checklist_item_id, completed_by)
        VALUES (?, ?, ?)
      `).bind(caseId, checklistItemId, auth.user.id).run();
    } else {
      // Remove completion
      await env.ANALYTICS_DB.prepare(`
        DELETE FROM checklist_completions WHERE case_id = ? AND checklist_item_id = ?
      `).bind(caseId, checklistItemId).run();
    }

    return Response.json({ success: true, message: completed ? 'Item marked complete' : 'Item marked incomplete' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Complete checklist item error:', e);
    return Response.json({ error: 'Failed to update checklist item' }, { status: 500, headers: corsHeaders });
  }
}

// Admin: Manage checklist templates
async function handleManageChecklists(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    if (request.method === 'GET') {
      const items = await env.ANALYTICS_DB.prepare(`
        SELECT * FROM completion_checklists ORDER BY case_type, sort_order ASC
      `).all();
      return Response.json({ success: true, items: items.results || [] }, { headers: corsHeaders });
    }

    if (request.method === 'POST') {
      const { caseType, resolutionPattern, checklistItem, sortOrder, isRequired } = await request.json();

      if (!caseType || !checklistItem) {
        return Response.json({ error: 'Case type and checklist item are required' }, { status: 400, headers: corsHeaders });
      }

      await env.ANALYTICS_DB.prepare(`
        INSERT INTO completion_checklists (case_type, resolution_pattern, checklist_item, sort_order, is_required)
        VALUES (?, ?, ?, ?, ?)
      `).bind(caseType, resolutionPattern || null, checklistItem, sortOrder || 0, isRequired ? 1 : 0).run();

      await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'checklist_item_created', 'system', 'checklist', null,
        { caseType, checklistItem }, null, null, request);

      return Response.json({ success: true, message: 'Checklist item created' }, { headers: corsHeaders });
    }

    if (request.method === 'PUT') {
      const { id, checklistItem, sortOrder, isRequired, isActive } = await request.json();

      if (!id) {
        return Response.json({ error: 'Checklist item ID is required' }, { status: 400, headers: corsHeaders });
      }

      await env.ANALYTICS_DB.prepare(`
        UPDATE completion_checklists SET checklist_item = ?, sort_order = ?, is_required = ?, is_active = ? WHERE id = ?
      `).bind(checklistItem, sortOrder || 0, isRequired ? 1 : 0, isActive !== false ? 1 : 0, id).run();

      return Response.json({ success: true, message: 'Checklist item updated' }, { headers: corsHeaders });
    }

    if (request.method === 'DELETE') {
      const url = new URL(request.url);
      const id = url.pathname.split('/').pop();

      await env.ANALYTICS_DB.prepare(`
        DELETE FROM completion_checklists WHERE id = ?
      `).bind(id).run();

      return Response.json({ success: true, message: 'Checklist item deleted' }, { headers: corsHeaders });
    }

    return Response.json({ error: 'Method not allowed' }, { status: 405, headers: corsHeaders });
  } catch (e) {
    console.error('Manage checklists error:', e);
    return Response.json({ error: 'Failed to manage checklists: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// PHASE 2: SOP LINK MANAGEMENT
// ============================================

// Get all SOP links (admin)
async function handleGetSOPLinks(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const links = await env.ANALYTICS_DB.prepare(`
      SELECT sl.*,
             u1.name as created_by_name,
             u2.name as updated_by_name
      FROM sop_links sl
      LEFT JOIN admin_users u1 ON sl.created_by = u1.id
      LEFT JOIN admin_users u2 ON sl.updated_by = u2.id
      ORDER BY sl.case_type, sl.scenario_name ASC
    `).all();

    return Response.json({ success: true, links: links.results || [] }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get SOP links error:', e);
    return Response.json({ error: 'Failed to get SOP links' }, { status: 500, headers: corsHeaders });
  }
}

// Create SOP link (admin)
async function handleCreateSOPLink(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { scenarioKey, scenarioName, caseType, sopUrl, description } = await request.json();

    if (!scenarioKey || !scenarioName || !caseType || !sopUrl) {
      return Response.json({ error: 'Scenario key, name, case type, and URL are required' }, { status: 400, headers: corsHeaders });
    }

    // Check for duplicate key
    const existing = await env.ANALYTICS_DB.prepare(`
      SELECT id FROM sop_links WHERE scenario_key = ?
    `).bind(scenarioKey).first();

    if (existing) {
      return Response.json({ error: 'A SOP link with this scenario key already exists' }, { status: 400, headers: corsHeaders });
    }

    await env.ANALYTICS_DB.prepare(`
      INSERT INTO sop_links (scenario_key, scenario_name, case_type, sop_url, description, created_by, updated_by)
      VALUES (?, ?, ?, ?, ?, ?, ?)
    `).bind(scenarioKey, scenarioName, caseType, sopUrl, description || null, auth.user.id, auth.user.id).run();

    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'sop_link_created', 'sop', 'sop_link', scenarioKey,
      { scenarioKey, scenarioName, caseType, sopUrl }, null, JSON.stringify({ scenarioKey, sopUrl }), request);

    return Response.json({ success: true, message: 'SOP link created' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Create SOP link error:', e);
    return Response.json({ error: 'Failed to create SOP link: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// Update SOP link (admin)
async function handleUpdateSOPLink(request, id, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { scenarioName, sopUrl, description, isActive } = await request.json();

    // Get current values for audit
    const current = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM sop_links WHERE id = ?
    `).bind(id).first();

    if (!current) {
      return Response.json({ error: 'SOP link not found' }, { status: 404, headers: corsHeaders });
    }

    await env.ANALYTICS_DB.prepare(`
      UPDATE sop_links
      SET scenario_name = ?, sop_url = ?, description = ?, is_active = ?, updated_by = ?, updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      scenarioName || current.scenario_name,
      sopUrl || current.sop_url,
      description !== undefined ? description : current.description,
      isActive !== undefined ? (isActive ? 1 : 0) : current.is_active,
      auth.user.id,
      id
    ).run();

    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'sop_link_updated', 'sop', 'sop_link', current.scenario_key,
      { id, scenarioName, sopUrl }, JSON.stringify({ sopUrl: current.sop_url }), JSON.stringify({ sopUrl }), request);

    return Response.json({ success: true, message: 'SOP link updated' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Update SOP link error:', e);
    return Response.json({ error: 'Failed to update SOP link' }, { status: 500, headers: corsHeaders });
  }
}

// Delete SOP link (admin)
async function handleDeleteSOPLink(request, id, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const link = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM sop_links WHERE id = ?
    `).bind(id).first();

    if (!link) {
      return Response.json({ error: 'SOP link not found' }, { status: 404, headers: corsHeaders });
    }

    await env.ANALYTICS_DB.prepare(`
      DELETE FROM sop_links WHERE id = ?
    `).bind(id).run();

    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'sop_link_deleted', 'sop', 'sop_link', link.scenario_key,
      { scenarioKey: link.scenario_key }, JSON.stringify(link), null, request);

    return Response.json({ success: true, message: 'SOP link deleted' }, { headers: corsHeaders });
  } catch (e) {
    console.error('Delete SOP link error:', e);
    return Response.json({ error: 'Failed to delete SOP link' }, { status: 500, headers: corsHeaders });
  }
}

// Get SOP link for a specific case (used by hub)
async function handleGetSOPForCase(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const caseType = url.searchParams.get('caseType');
    const resolution = url.searchParams.get('resolution');

    if (!caseType) {
      return Response.json({ error: 'Case type is required' }, { status: 400, headers: corsHeaders });
    }

    // First try to find a specific match for resolution pattern
    let link = null;
    if (resolution) {
      link = await env.ANALYTICS_DB.prepare(`
        SELECT sop_url, scenario_name, description FROM sop_links
        WHERE case_type = ? AND is_active = 1 AND (
          scenario_key LIKE ? OR ? LIKE scenario_key || '%'
        )
        ORDER BY LENGTH(scenario_key) DESC
        LIMIT 1
      `).bind(caseType, resolution + '%', resolution).first();
    }

    // Fall back to general case type link
    if (!link) {
      link = await env.ANALYTICS_DB.prepare(`
        SELECT sop_url, scenario_name, description FROM sop_links
        WHERE case_type = ? AND is_active = 1 AND scenario_key LIKE ?
        LIMIT 1
      `).bind(caseType, caseType + '_general').first();
    }

    // Fall back to any link for the case type
    if (!link) {
      link = await env.ANALYTICS_DB.prepare(`
        SELECT sop_url, scenario_name, description FROM sop_links
        WHERE case_type = ? AND is_active = 1
        LIMIT 1
      `).bind(caseType).first();
    }

    // Ultimate fallback to hardcoded URLs
    if (!link) {
      const fallbackUrls = {
        refund: 'https://docs.puppypad.com/sop/refunds',
        return: 'https://docs.puppypad.com/sop/returns',
        shipping: 'https://docs.puppypad.com/sop/shipping-issues',
        subscription: 'https://docs.puppypad.com/sop/subscriptions',
        manual: 'https://docs.puppypad.com/sop/manual-assistance'
      };
      link = {
        sop_url: fallbackUrls[caseType] || fallbackUrls.manual,
        scenario_name: caseType.charAt(0).toUpperCase() + caseType.slice(1) + ' SOP',
        description: 'Standard operating procedure'
      };
    }

    return Response.json({ success: true, link }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get SOP for case error:', e);
    return Response.json({ error: 'Failed to get SOP link' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// PHASE 2: ENHANCED AUDIT LOG
// ============================================

// Get enhanced audit log with filtering
async function handleGetEnhancedAuditLog(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const page = parseInt(url.searchParams.get('page')) || 1;
    const limit = Math.min(parseInt(url.searchParams.get('limit')) || 50, 200);
    const offset = (page - 1) * limit;
    const category = url.searchParams.get('category');
    const actionType = url.searchParams.get('actionType');
    const userId = url.searchParams.get('userId');
    const resourceType = url.searchParams.get('resourceType');
    const startDate = url.searchParams.get('startDate');
    const endDate = url.searchParams.get('endDate');
    const search = url.searchParams.get('search');

    // Build dynamic query
    let conditions = [];
    let params = [];

    if (category) {
      conditions.push('action_category = ?');
      params.push(category);
    }
    if (actionType) {
      conditions.push('action_type = ?');
      params.push(actionType);
    }
    if (userId) {
      conditions.push('user_id = ?');
      params.push(userId);
    }
    if (resourceType) {
      conditions.push('resource_type = ?');
      params.push(resourceType);
    }
    if (startDate) {
      conditions.push('created_at >= ?');
      params.push(startDate);
    }
    if (endDate) {
      conditions.push('created_at <= ?');
      params.push(endDate + ' 23:59:59');
    }
    if (search) {
      conditions.push('(user_name LIKE ? OR user_email LIKE ? OR resource_id LIKE ? OR details LIKE ?)');
      const searchTerm = '%' + search + '%';
      params.push(searchTerm, searchTerm, searchTerm, searchTerm);
    }

    const whereClause = conditions.length > 0 ? 'WHERE ' + conditions.join(' AND ') : '';

    // Get total count
    const countResult = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as total FROM audit_log ${whereClause}
    `).bind(...params).first();

    // Get logs
    const logs = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM audit_log ${whereClause}
      ORDER BY created_at DESC
      LIMIT ? OFFSET ?
    `).bind(...params, limit, offset).all();

    // Get available categories and action types for filters
    const categories = await env.ANALYTICS_DB.prepare(`
      SELECT DISTINCT action_category FROM audit_log ORDER BY action_category
    `).all();

    const actionTypes = await env.ANALYTICS_DB.prepare(`
      SELECT DISTINCT action_type FROM audit_log ORDER BY action_type
    `).all();

    return Response.json({
      success: true,
      logs: logs.results || [],
      pagination: {
        page,
        limit,
        total: countResult?.total || 0,
        totalPages: Math.ceil((countResult?.total || 0) / limit)
      },
      filters: {
        categories: categories.results?.map(c => c.action_category) || [],
        actionTypes: actionTypes.results?.map(a => a.action_type) || []
      }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Get enhanced audit log error:', e);
    return Response.json({ error: 'Failed to get audit log' }, { status: 500, headers: corsHeaders });
  }
}

// Export audit log as CSV
async function handleExportAuditLog(request, env, corsHeaders) {
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const startDate = url.searchParams.get('startDate') || new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    const endDate = url.searchParams.get('endDate') || new Date().toISOString().split('T')[0];

    const logs = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM audit_log
      WHERE created_at >= ? AND created_at <= ?
      ORDER BY created_at DESC
      LIMIT 10000
    `).bind(startDate, endDate + ' 23:59:59').all();

    // Build CSV
    const headers = ['Timestamp', 'User', 'Email', 'Action Type', 'Category', 'Resource Type', 'Resource ID', 'Old Value', 'New Value', 'IP Address'];
    const rows = (logs.results || []).map(log => [
      log.created_at,
      log.user_name || '',
      log.user_email || '',
      log.action_type,
      log.action_category,
      log.resource_type || '',
      log.resource_id || '',
      (log.old_value || '').replace(/"/g, '""'),
      (log.new_value || '').replace(/"/g, '""'),
      log.ip_address || ''
    ]);

    const csv = [headers.join(','), ...rows.map(r => r.map(c => `"${c}"`).join(','))].join('\n');

    await logAudit(env, auth.user.id, auth.user.username, auth.user.name, 'audit_log_exported', 'system', 'audit_log', null,
      { startDate, endDate, count: logs.results?.length || 0 }, null, null, request);

    return new Response(csv, {
      headers: {
        ...corsHeaders,
        'Content-Type': 'text/csv',
        'Content-Disposition': `attachment; filename="audit-log-${startDate}-to-${endDate}.csv"`
      }
    });
  } catch (e) {
    console.error('Export audit log error:', e);
    return Response.json({ error: 'Failed to export audit log' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// PHASE 2: RESOLUTION VALIDATION
// ============================================

// Validate resolution before completing case
async function handleValidateResolution(request, env, corsHeaders) {
  const auth = await verifyAuthAndGetUser(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const { caseId, caseType, resolution, refundAmount, orderTotal } = await request.json();

    const errors = [];
    const warnings = [];

    // Case type specific validations
    if (caseType === 'refund') {
      // Refund validations
      if (!resolution) {
        errors.push('Resolution type is required for refund cases');
      }

      if (resolution?.includes('partial') && !refundAmount) {
        errors.push('Refund amount is required for partial refunds');
      }

      if (refundAmount && orderTotal) {
        const refundNum = parseFloat(refundAmount);
        const totalNum = parseFloat(orderTotal);

        if (refundNum > totalNum) {
          errors.push('Refund amount cannot exceed order total');
        }

        if (refundNum === totalNum && resolution?.includes('partial')) {
          warnings.push('Refund amount equals order total - should this be a full refund?');
        }

        if (refundNum < totalNum * 0.1) {
          warnings.push('Refund is less than 10% of order total - please verify');
        }
      }
    }

    if (caseType === 'shipping') {
      // Shipping validations
      if (!resolution) {
        errors.push('Resolution type is required for shipping cases');
      }

      if (resolution?.includes('reship') && !resolution?.includes('tracking')) {
        warnings.push('Consider adding tracking information for reshipment');
      }
    }

    if (caseType === 'subscription') {
      // Subscription validations
      if (!resolution) {
        errors.push('Resolution type is required for subscription cases');
      }

      if (resolution?.includes('cancel') || resolution?.includes('pause')) {
        warnings.push('Ensure subscription status is updated in CheckoutChamp');
      }
    }

    // Check for required checklist items
    const checklistItems = await env.ANALYTICS_DB.prepare(`
      SELECT id, checklist_item, is_required FROM completion_checklists
      WHERE case_type = ? AND is_active = 1 AND is_required = 1
      AND (resolution_pattern IS NULL OR ? LIKE resolution_pattern || '%' OR resolution_pattern LIKE ? || '%')
    `).bind(caseType, resolution || '', resolution || '').all();

    if (checklistItems.results?.length > 0) {
      // Check which are completed
      const completions = await env.ANALYTICS_DB.prepare(`
        SELECT checklist_item_id FROM checklist_completions WHERE case_id = ?
      `).bind(caseId).all();

      const completedIds = new Set((completions.results || []).map(c => c.checklist_item_id));

      for (const item of checklistItems.results) {
        if (!completedIds.has(item.id)) {
          errors.push(`Required checklist item not completed: "${item.checklist_item}"`);
        }
      }
    }

    // General validations
    if (!caseId) {
      errors.push('Case ID is required');
    }

    return Response.json({
      success: errors.length === 0,
      valid: errors.length === 0,
      errors,
      warnings,
      canProceed: errors.length === 0
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Validate resolution error:', e);
    return Response.json({ error: 'Validation failed: ' + e.message }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// ADMIN DASHBOARD DATA
// ============================================
async function handleDashboardData(request, env, corsHeaders) {
  // Verify authentication
  const authHeader = request.headers.get('Authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
  }

  const token = authHeader.substring(7);
  const payload = await verifyToken(token);
  if (!payload) {
    return Response.json({ error: 'Invalid or expired token' }, { status: 401, headers: corsHeaders });
  }

  const url = new URL(request.url);
  const range = url.searchParams.get('range') || '7d';

  // Calculate date range
  let daysAgo = 7;
  if (range === '30d') daysAgo = 30;
  else if (range === '90d') daysAgo = 90;
  else if (range === 'year') daysAgo = 365;

  const startDate = new Date();
  startDate.setDate(startDate.getDate() - daysAgo);
  const startDateStr = startDate.toISOString().split('T')[0];

  try {
    // Total sessions
    const sessionsResult = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as total FROM sessions WHERE started_at >= ?
    `).bind(startDateStr).first();

    // Completed sessions (resolved in-app)
    const completedResult = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as total FROM sessions WHERE started_at >= ? AND completed = 1
    `).bind(startDateStr).first();

    // Total cases created
    const casesResult = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as total FROM cases WHERE created_at >= ?
    `).bind(startDateStr).first();

    // Cases by type
    const casesByType = await env.ANALYTICS_DB.prepare(`
      SELECT case_type, COUNT(*) as count FROM cases WHERE created_at >= ? GROUP BY case_type
    `).bind(startDateStr).all();

    // Total refund amount
    const refundsResult = await env.ANALYTICS_DB.prepare(`
      SELECT SUM(refund_amount) as total FROM cases WHERE created_at >= ? AND refund_amount IS NOT NULL
    `).bind(startDateStr).first();

    // Average survey rating
    const surveyResult = await env.ANALYTICS_DB.prepare(`
      SELECT AVG(rating) as avg_rating, COUNT(*) as total FROM survey_responses WHERE created_at >= ?
    `).bind(startDateStr).first();

    // Policy blocks
    const blocksResult = await env.ANALYTICS_DB.prepare(`
      SELECT block_type, COUNT(*) as count FROM policy_blocks WHERE created_at >= ? GROUP BY block_type
    `).bind(startDateStr).all();

    // Recent cases (exclude self-resolved)
    const recentCases = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) ORDER BY created_at DESC LIMIT 10
    `).all();

    // Daily sessions for chart
    const dailySessions = await env.ANALYTICS_DB.prepare(`
      SELECT DATE(started_at) as date, COUNT(*) as count
      FROM sessions WHERE started_at >= ?
      GROUP BY DATE(started_at) ORDER BY date
    `).bind(startDateStr).all();

    const totalSessions = sessionsResult?.total || 0;
    const completedSessions = completedResult?.total || 0;
    const resolutionRate = totalSessions > 0 ? ((completedSessions / totalSessions) * 100).toFixed(1) : 0;

    return Response.json({
      summary: {
        totalSessions,
        completedSessions,
        resolutionRate,
        totalCases: casesResult?.total || 0,
        totalRefunds: refundsResult?.total || 0,
        avgRating: surveyResult?.avg_rating ? surveyResult.avg_rating.toFixed(1) : 'N/A',
        surveyResponses: surveyResult?.total || 0
      },
      casesByType: casesByType?.results || [],
      policyBlocks: blocksResult?.results || [],
      recentCases: recentCases?.results || [],
      dailySessions: dailySessions?.results || [],
      dateRange: { start: startDateStr, end: new Date().toISOString().split('T')[0], days: daysAgo }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Dashboard data error:', e);
    return Response.json({ error: 'Failed to load dashboard data' }, { status: 500, headers: corsHeaders });
  }
}

// Get cases list with pagination
async function handleCasesList(request, env, corsHeaders) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
  }

  const token = authHeader.substring(7);
  const payload = await verifyToken(token);
  if (!payload) {
    return Response.json({ error: 'Invalid or expired token' }, { status: 401, headers: corsHeaders });
  }

  const url = new URL(request.url);
  const page = parseInt(url.searchParams.get('page') || '1');
  const limit = parseInt(url.searchParams.get('limit') || '20');
  const offset = (page - 1) * limit;

  try {
    const cases = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) ORDER BY created_at DESC LIMIT ? OFFSET ?
    `).bind(limit, offset).all();

    const countResult = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as total FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL)
    `).first();

    return Response.json({
      cases: cases?.results || [],
      pagination: {
        page,
        limit,
        total: countResult?.total || 0,
        totalPages: Math.ceil((countResult?.total || 0) / limit)
      }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Cases list error:', e);
    return Response.json({ error: 'Failed to load cases' }, { status: 500, headers: corsHeaders });
  }
}

// Get events log
async function handleEventsList(request, env, corsHeaders) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
  }

  const token = authHeader.substring(7);
  const payload = await verifyToken(token);
  if (!payload) {
    return Response.json({ error: 'Invalid or expired token' }, { status: 401, headers: corsHeaders });
  }

  const url = new URL(request.url);
  const page = parseInt(url.searchParams.get('page') || '1');
  const limit = parseInt(url.searchParams.get('limit') || '50');
  const offset = (page - 1) * limit;

  try {
    const events = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM events ORDER BY created_at DESC LIMIT ? OFFSET ?
    `).bind(limit, offset).all();

    const countResult = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as total FROM events
    `).first();

    return Response.json({
      events: events?.results || [],
      pagination: {
        page,
        limit,
        total: countResult?.total || 0,
        totalPages: Math.ceil((countResult?.total || 0) / limit)
      }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Events list error:', e);
    return Response.json({ error: 'Failed to load events' }, { status: 500, headers: corsHeaders });
  }
}

// Get sessions list with pagination
async function handleSessionsList(request, env, corsHeaders) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
  }

  const token = authHeader.substring(7);
  const payload = await verifyToken(token);
  if (!payload) {
    return Response.json({ error: 'Invalid or expired token' }, { status: 401, headers: corsHeaders });
  }

  const url = new URL(request.url);
  const page = parseInt(url.searchParams.get('page') || '1');
  const limit = parseInt(url.searchParams.get('limit') || '20');
  const offset = (page - 1) * limit;
  const filter = url.searchParams.get('filter') || 'all'; // 'all', 'complete', 'incomplete'
  const range = url.searchParams.get('range') || '7d';

  // Calculate start date based on range
  const now = new Date();
  let startDate;
  switch (range) {
    case '24h': startDate = new Date(now - 24 * 60 * 60 * 1000); break;
    case '7d': startDate = new Date(now - 7 * 24 * 60 * 60 * 1000); break;
    case '30d': startDate = new Date(now - 30 * 24 * 60 * 60 * 1000); break;
    case '90d': startDate = new Date(now - 90 * 24 * 60 * 60 * 1000); break;
    default: startDate = new Date(now - 7 * 24 * 60 * 60 * 1000);
  }
  const startDateStr = startDate.toISOString().split('T')[0];

  try {
    let conditions = [`started_at >= '${startDateStr}'`];
    if (filter === 'complete') {
      conditions.push('completed = 1');
    } else if (filter === 'incomplete') {
      conditions.push('(completed = 0 OR completed IS NULL)');
    }
    const whereClause = 'WHERE ' + conditions.join(' AND ');

    const sessions = await env.ANALYTICS_DB.prepare(`
      SELECT
        session_id, started_at, ended_at, flow_type,
        customer_email, customer_name, order_number,
        device_type, completed, session_replay_url, issue_type
      FROM sessions ${whereClause}
      ORDER BY started_at DESC
      LIMIT ? OFFSET ?
    `).bind(limit, offset).all();

    const countResult = await env.ANALYTICS_DB.prepare(`
      SELECT COUNT(*) as total FROM sessions ${whereClause}
    `).first();

    return Response.json({
      sessions: sessions?.results || [],
      pagination: {
        page,
        limit,
        total: countResult?.total || 0,
        totalPages: Math.ceil((countResult?.total || 0) / limit)
      }
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Sessions list error:', e);
    return Response.json({ error: 'Failed to load sessions' }, { status: 500, headers: corsHeaders });
  }
}

// Get analytics for issues breakdown
async function handleIssuesAnalytics(request, env, corsHeaders) {
  const authHeader = request.headers.get('Authorization');
  if (!authHeader || !authHeader.startsWith('Bearer ')) {
    return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
  }

  const token = authHeader.substring(7);
  const payload = await verifyToken(token);
  if (!payload) {
    return Response.json({ error: 'Invalid or expired token' }, { status: 401, headers: corsHeaders });
  }

  const url = new URL(request.url);
  const range = url.searchParams.get('range') || '30d';
  const daysAgo = range === '7d' ? 7 : range === '90d' ? 90 : range === 'year' ? 365 : 30;
  const startDate = new Date();
  startDate.setDate(startDate.getDate() - daysAgo);
  const startDateStr = startDate.toISOString().split('T')[0];

  try {
    // Top issue types from cases
    const issueTypes = await env.ANALYTICS_DB.prepare(`
      SELECT resolution, COUNT(*) as count
      FROM cases
      WHERE created_at >= ?
      GROUP BY resolution
      ORDER BY count DESC
      LIMIT 10
    `).bind(startDateStr).all();

    // Case types breakdown
    const caseTypes = await env.ANALYTICS_DB.prepare(`
      SELECT case_type, COUNT(*) as count, SUM(refund_amount) as total_refund
      FROM cases
      WHERE created_at >= ?
      GROUP BY case_type
      ORDER BY count DESC
    `).bind(startDateStr).all();

    // Refund amounts by day
    const refundsByDay = await env.ANALYTICS_DB.prepare(`
      SELECT DATE(created_at) as date, SUM(refund_amount) as total, COUNT(*) as count
      FROM cases
      WHERE created_at >= ? AND refund_amount IS NOT NULL
      GROUP BY DATE(created_at)
      ORDER BY date
    `).bind(startDateStr).all();

    // Incomplete sessions with issues
    const incompleteIssues = await env.ANALYTICS_DB.prepare(`
      SELECT issue_type, COUNT(*) as count
      FROM sessions
      WHERE (completed = 0 OR completed IS NULL) AND issue_type IS NOT NULL AND started_at >= ?
      GROUP BY issue_type
      ORDER BY count DESC
    `).bind(startDateStr).all();

    return Response.json({
      issueTypes: issueTypes?.results || [],
      caseTypes: caseTypes?.results || [],
      refundsByDay: refundsByDay?.results || [],
      incompleteIssues: incompleteIssues?.results || []
    }, { headers: corsHeaders });
  } catch (e) {
    console.error('Issues analytics error:', e);
    return Response.json({ error: 'Failed to load analytics' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// SERVE DASHBOARD HTML
// ============================================
async function serveDashboard(env, corsHeaders) {
  const html = getDashboardHTML();
  return new Response(html, {
    headers: {
      ...corsHeaders,
      'Content-Type': 'text/html; charset=utf-8'
    }
  });
}

async function serveResolutionHub(env, corsHeaders) {
  const html = getResolutionHubHTML();
  return new Response(html, {
    headers: {
      ...corsHeaders,
      'Content-Type': 'text/html; charset=utf-8',
      'Cache-Control': 'no-cache, no-store, must-revalidate',
      'Pragma': 'no-cache',
      'Expires': '0'
    }
  });
}


async function serveHubAsset(type, corsHeaders) {
  let content, contentType;
  if (type === 'js') {
    content = getHubAppJS();
    contentType = 'application/javascript; charset=utf-8';
  } else if (type === 'flow-docs-react') {
    content = getFlowDocsReactJS();
    contentType = 'application/javascript; charset=utf-8';
  } else {
    content = getHubStylesCSS();
    contentType = 'text/css; charset=utf-8';
  }

  return new Response(content, {
    headers: {
      ...corsHeaders,
      'Content-Type': contentType,
      'Cache-Control': 'no-cache, no-store, must-revalidate', // Disable caching for development
      'Pragma': 'no-cache',
      'Expires': '0'
    }
  });
}

async function serveFlowDocsPage(request, env, corsHeaders) {
  // Check admin permission
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  // Check if getFlowDocsHTML exists, otherwise return a fallback
  if (typeof getFlowDocsHTML === 'function') {
    const html = getFlowDocsHTML();
    return new Response(html, {
      headers: {
        ...corsHeaders,
        'Content-Type': 'text/html; charset=utf-8',
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      }
    });
  } else {
    return new Response('Flow Docs page not yet built. Run node build-hub.js', {
      status: 500,
      headers: { ...corsHeaders, 'Content-Type': 'text/plain' }
    });
  }
}

function getDashboardHTML() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>PuppyPad Resolution - Admin Dashboard</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <style>
    :root {
      --brand-navy: #0A1628;
      --brand-navy-light: #1E3A5F;
      --accent-coral: #FF6B6B;
      --accent-teal: #4ECDC4;
      --gray-50: #F9FAFB;
      --gray-100: #F3F4F6;
      --gray-200: #E5E7EB;
      --gray-300: #D1D5DB;
      --gray-500: #6B7280;
      --gray-600: #4B5563;
      --gray-700: #374151;
      --gray-900: #111827;
      --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1);
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Inter', sans-serif;
      background: var(--gray-100);
      min-height: 100vh;
    }

    /* Login Screen */
    .login-container {
      min-height: 100vh;
      display: flex;
      align-items: center;
      justify-content: center;
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      padding: 20px;
    }

    .login-card {
      background: white;
      border-radius: 24px;
      padding: 48px;
      width: 100%;
      max-width: 400px;
      box-shadow: var(--shadow-lg);
    }

    .login-logo {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-logo img {
      height: 40px;
    }

    .login-title {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      font-weight: 700;
      color: var(--gray-900);
      text-align: center;
      margin-bottom: 8px;
    }

    .login-subtitle {
      color: var(--gray-500);
      text-align: center;
      margin-bottom: 32px;
    }

    .form-group {
      margin-bottom: 20px;
    }

    .form-group label {
      display: block;
      font-weight: 500;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    .form-group input {
      width: 100%;
      padding: 14px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      font-size: 15px;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--brand-navy);
    }

    .login-btn {
      width: 100%;
      padding: 16px;
      background: var(--brand-navy);
      color: white;
      border: none;
      border-radius: 12px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .login-btn:hover {
      background: var(--brand-navy-light);
      transform: translateY(-1px);
    }

    .login-error {
      color: var(--accent-coral);
      text-align: center;
      margin-bottom: 16px;
      display: none;
    }

    /* Dashboard Layout */
    .dashboard-container {
      display: none;
      min-height: 100vh;
    }

    .dashboard-container.active {
      display: block;
    }

    .dashboard-header {
      background: white;
      padding: 20px 32px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .header-left h1 {
      font-family: 'Poppins', sans-serif;
      font-size: 24px;
      color: var(--gray-900);
    }

    .header-left p {
      color: var(--gray-500);
      font-size: 14px;
    }

    .header-right {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .date-select {
      padding: 10px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
      cursor: pointer;
    }

    .logout-btn {
      padding: 10px 20px;
      background: var(--gray-100);
      border: none;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
      cursor: pointer;
    }

    .dashboard-content {
      padding: 32px;
      max-width: 1400px;
      margin: 0 auto;
    }

    /* Metrics Grid */
    .metrics-grid {
      display: grid;
      grid-template-columns: repeat(auto-fit, minmax(240px, 1fr));
      gap: 24px;
      margin-bottom: 32px;
    }

    .metric-card {
      background: white;
      border-radius: 16px;
      padding: 24px;
      box-shadow: var(--shadow-md);
    }

    .metric-card.highlight {
      background: linear-gradient(135deg, var(--accent-teal) 0%, #38B2AC 100%);
      color: white;
    }

    .metric-label {
      font-size: 14px;
      color: var(--gray-500);
      margin-bottom: 8px;
    }

    .metric-card.highlight .metric-label {
      color: rgba(255,255,255,0.8);
    }

    .metric-value {
      font-family: 'Poppins', sans-serif;
      font-size: 36px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .metric-card.highlight .metric-value {
      color: white;
    }

    .metric-sub {
      font-size: 13px;
      color: var(--gray-500);
      margin-top: 4px;
    }

    .metric-card.highlight .metric-sub {
      color: rgba(255,255,255,0.7);
    }

    /* Tables */
    .card {
      background: white;
      border-radius: 16px;
      box-shadow: var(--shadow-md);
      margin-bottom: 24px;
      overflow: hidden;
    }

    .card-header {
      padding: 20px 24px;
      border-bottom: 1px solid var(--gray-100);
      display: flex;
      justify-content: space-between;
      align-items: center;
    }

    .card-title {
      font-family: 'Poppins', sans-serif;
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-900);
    }

    .table-container {
      overflow-x: auto;
    }

    table {
      width: 100%;
      border-collapse: collapse;
    }

    th, td {
      padding: 14px 20px;
      text-align: left;
      border-bottom: 1px solid var(--gray-100);
    }

    th {
      background: var(--gray-50);
      font-weight: 600;
      color: var(--gray-600);
      font-size: 13px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    td {
      font-size: 14px;
      color: var(--gray-700);
    }

    .badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 500;
    }

    .badge-refund { background: #FEE2E2; color: #DC2626; }
    .badge-shipping { background: #DBEAFE; color: #2563EB; }
    .badge-subscription { background: #D1FAE5; color: #059669; }
    .badge-return { background: #FEF3C7; color: #D97706; }
    .badge-manual { background: #E5E7EB; color: #374151; }

    .loading {
      text-align: center;
      padding: 40px;
      color: var(--gray-500);
    }

    .pagination {
      display: flex;
      justify-content: center;
      gap: 8px;
      padding: 20px;
    }

    .pagination button {
      padding: 8px 16px;
      border: 1px solid var(--gray-200);
      background: white;
      border-radius: 8px;
      cursor: pointer;
      font-size: 14px;
    }

    .pagination button:hover {
      background: var(--gray-50);
    }

    .pagination button.active {
      background: var(--brand-navy);
      color: white;
      border-color: var(--brand-navy);
    }

    /* Tabs */
    .tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
    }

    .tab {
      padding: 12px 24px;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
    }

    .tab.active {
      background: var(--brand-navy);
      color: white;
      border-color: var(--brand-navy);
    }

    .card-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      flex-wrap: wrap;
      gap: 12px;
    }

    .filter-buttons {
      display: flex;
      gap: 8px;
    }

    .filter-btn {
      padding: 6px 12px;
      font-size: 12px;
      border: 1px solid var(--gray-200);
      background: white;
      border-radius: 6px;
      cursor: pointer;
      color: var(--gray-600);
    }

    .filter-btn.active {
      background: var(--accent-teal);
      color: white;
      border-color: var(--accent-teal);
    }

    .recording-link {
      color: var(--accent-coral);
      text-decoration: none;
      font-weight: 500;
      display: inline-flex;
      align-items: center;
      gap: 4px;
    }

    .recording-link:hover {
      text-decoration: underline;
    }

    .status-badge {
      display: inline-block;
      padding: 4px 8px;
      border-radius: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .status-complete {
      background: #D1FAE5;
      color: #065F46;
    }

    .status-incomplete {
      background: #FEE2E2;
      color: #991B1B;
    }

    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      padding: 16px 0;
    }

    .analytics-section {
      background: var(--gray-50);
      border-radius: 8px;
      padding: 16px;
    }

    .analytics-section h4 {
      margin: 0 0 12px 0;
      font-size: 14px;
      color: var(--gray-700);
    }

    .chart-container {
      min-height: 200px;
    }

    .chart-bar {
      display: flex;
      align-items: center;
      margin-bottom: 8px;
    }

    .chart-label {
      width: 140px;
      font-size: 12px;
      color: var(--gray-600);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .chart-bar-bg {
      flex: 1;
      height: 20px;
      background: var(--gray-200);
      border-radius: 4px;
      overflow: hidden;
    }

    .chart-bar-fill {
      height: 100%;
      background: var(--accent-teal);
      border-radius: 4px;
      transition: width 0.3s ease;
    }

    .chart-bar-fill.coral {
      background: var(--accent-coral);
    }

    .chart-value {
      width: 50px;
      text-align: right;
      font-size: 12px;
      font-weight: 500;
      color: var(--gray-700);
    }

    .no-data {
      text-align: center;
      color: var(--gray-500);
      padding: 40px;
      font-size: 14px;
    }

    .badge-complete {
      background: #D1FAE5;
      color: #065F46;
    }

    .badge-incomplete {
      background: #FEE2E2;
      color: #991B1B;
    }

    .no-recording {
      color: var(--gray-400);
      font-size: 12px;
    }

    .bar-chart {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bar-item {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .bar-label {
      font-size: 12px;
      color: var(--gray-600);
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .bar-wrapper {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .bar {
      height: 20px;
      border-radius: 4px;
      min-width: 4px;
      transition: width 0.3s ease;
    }

    .bar-value {
      font-size: 12px;
      font-weight: 600;
      color: var(--gray-700);
      min-width: 30px;
    }

    .refunds-summary {
      padding: 8px 0;
    }

    .refund-total {
      font-size: 18px;
      font-weight: 600;
      color: var(--gray-800);
      margin-bottom: 16px;
    }

    .refund-list {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .refund-day {
      display: flex;
      justify-content: space-between;
      font-size: 13px;
      padding: 8px;
      background: white;
      border-radius: 4px;
    }

    .refund-day span:first-child {
      color: var(--gray-600);
    }

    .refund-day span:last-child {
      font-weight: 500;
      color: var(--gray-800);
    }

    @media (max-width: 768px) {
      .dashboard-header {
        flex-direction: column;
        gap: 16px;
        align-items: flex-start;
      }

      .dashboard-content {
        padding: 16px;
      }

      .metrics-grid {
        grid-template-columns: 1fr;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div class="login-container" id="loginScreen">
    <div class="login-card">
      <div class="login-logo">
        <img src="https://cdn.shopify.com/s/files/1/0433/0510/7612/files/navyblue-logo.svg?v=1754231041" alt="PuppyPad">
      </div>
      <h2 class="login-title">Admin Dashboard</h2>
      <p class="login-subtitle">Sign in to view analytics</p>
      <div class="login-error" id="loginError">Invalid username or password</div>
      <form id="loginForm">
        <div class="form-group">
          <label>Username</label>
          <input type="text" id="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label>Password</label>
          <input type="password" id="password" required autocomplete="current-password">
        </div>
        <button type="submit" class="login-btn">Sign In</button>
      </form>
    </div>
  </div>

  <!-- Dashboard -->
  <div class="dashboard-container" id="dashboardScreen">
    <header class="dashboard-header">
      <div class="header-left">
        <h1>Analytics Dashboard</h1>
        <p>PuppyPad Resolution App Performance</p>
      </div>
      <div class="header-right">
        <select class="date-select" id="dateRange">
          <option value="7d">Last 7 days</option>
          <option value="30d">Last 30 days</option>
          <option value="90d">Last 90 days</option>
          <option value="year">This Year</option>
        </select>
        <button class="logout-btn" onclick="logout()">Logout</button>
      </div>
    </header>

    <div class="dashboard-content">
      <!-- Metrics -->
      <div class="metrics-grid" id="metricsGrid">
        <div class="loading">Loading metrics...</div>
      </div>

      <!-- Tabs -->
      <div class="tabs">
        <button class="tab active" data-tab="sessions">Sessions</button>
        <button class="tab" data-tab="cases">Cases</button>
        <button class="tab" data-tab="analytics">Analytics</button>
        <button class="tab" data-tab="events">Event Log</button>
      </div>

      <!-- Sessions Table -->
      <div class="card" id="sessionsCard">
        <div class="card-header">
          <h3 class="card-title">Session Recordings</h3>
          <div class="filter-buttons">
            <button class="filter-btn active" data-filter="all">All</button>
            <button class="filter-btn" data-filter="incomplete">Incomplete</button>
            <button class="filter-btn" data-filter="complete">Completed</button>
          </div>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Started</th>
                <th>Customer</th>
                <th>Order</th>
                <th>Flow</th>
                <th>Status</th>
                <th>Recording</th>
              </tr>
            </thead>
            <tbody id="sessionsTableBody">
              <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="sessionsPagination"></div>
      </div>

      <!-- Cases Table -->
      <div class="card" id="casesCard" style="display: none;">
        <div class="card-header">
          <h3 class="card-title">Customer Submissions</h3>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Case ID</th>
                <th>Type</th>
                <th>Customer</th>
                <th>Order</th>
                <th>Resolution</th>
                <th>Date</th>
              </tr>
            </thead>
            <tbody id="casesTableBody">
              <tr><td colspan="6" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="casesPagination"></div>
      </div>

      <!-- Analytics -->
      <div class="card" id="analyticsCard" style="display: none;">
        <div class="card-header">
          <h3 class="card-title">Issue Analytics</h3>
        </div>
        <div class="analytics-grid">
          <div class="analytics-section">
            <h4>Case Types Breakdown</h4>
            <div id="caseTypesChart" class="chart-container"></div>
          </div>
          <div class="analytics-section">
            <h4>Top Resolutions</h4>
            <div id="resolutionsChart" class="chart-container"></div>
          </div>
          <div class="analytics-section">
            <h4>Refunds Over Time</h4>
            <div id="refundsChart" class="chart-container"></div>
          </div>
          <div class="analytics-section">
            <h4>Incomplete Session Issues</h4>
            <div id="incompleteChart" class="chart-container"></div>
          </div>
        </div>
      </div>

      <!-- Events Table -->
      <div class="card" id="eventsCard" style="display: none;">
        <div class="card-header">
          <h3 class="card-title">Event Log</h3>
        </div>
        <div class="table-container">
          <table>
            <thead>
              <tr>
                <th>Session</th>
                <th>Event Type</th>
                <th>Event Name</th>
                <th>Data</th>
                <th>Time</th>
              </tr>
            </thead>
            <tbody id="eventsTableBody">
              <tr><td colspan="5" class="loading">Loading...</td></tr>
            </tbody>
          </table>
        </div>
        <div class="pagination" id="eventsPagination"></div>
      </div>
    </div>
  </div>

  <script>
    const API_BASE = '';
    let authToken = localStorage.getItem('adminToken');
    let currentCasesPage = 1;
    let currentEventsPage = 1;
    let currentSessionsPage = 1;
    let currentSessionsFilter = 'all';

    // Check if already logged in
    if (authToken) {
      showDashboard();
    }

    // Login form
    document.getElementById('loginForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      const username = document.getElementById('username').value;
      const password = document.getElementById('password').value;

      try {
        const response = await fetch(API_BASE + '/admin/api/login', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ username, password })
        });

        const data = await response.json();

        if (data.success) {
          authToken = data.token;
          localStorage.setItem('adminToken', authToken);
          showDashboard();
        } else {
          document.getElementById('loginError').style.display = 'block';
        }
      } catch (err) {
        document.getElementById('loginError').style.display = 'block';
      }
    });

    // Tabs
    document.querySelectorAll('.tab').forEach(tab => {
      tab.addEventListener('click', () => {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        tab.classList.add('active');

        const tabName = tab.dataset.tab;
        document.getElementById('sessionsCard').style.display = tabName === 'sessions' ? 'block' : 'none';
        document.getElementById('casesCard').style.display = tabName === 'cases' ? 'block' : 'none';
        document.getElementById('analyticsCard').style.display = tabName === 'analytics' ? 'block' : 'none';
        document.getElementById('eventsCard').style.display = tabName === 'events' ? 'block' : 'none';

        // Load analytics when tab is selected
        if (tabName === 'analytics') {
          loadAnalytics();
        }
      });
    });

    // Session filter buttons
    document.querySelectorAll('.filter-btn').forEach(btn => {
      btn.addEventListener('click', () => {
        document.querySelectorAll('.filter-btn').forEach(b => b.classList.remove('active'));
        btn.classList.add('active');
        currentSessionsFilter = btn.dataset.filter;
        loadSessions(1);
      });
    });

    // Date range change
    document.getElementById('dateRange').addEventListener('change', () => {
      loadDashboardData();
      loadAnalytics();
    });

    function showDashboard() {
      document.getElementById('loginScreen').style.display = 'none';
      document.getElementById('dashboardScreen').classList.add('active');
      loadDashboardData();
      loadSessions();
      // loadCases(); // REMOVED - was calling OLD rendering system that conflicts with new Cases view
      loadEvents();
    }

    function logout() {
      localStorage.removeItem('adminToken');
      authToken = null;
      document.getElementById('loginScreen').style.display = 'flex';
      document.getElementById('dashboardScreen').classList.remove('active');
    }

    async function loadDashboardData() {
      const range = document.getElementById('dateRange').value;

      try {
        const response = await fetch(API_BASE + '/admin/api/dashboard?range=' + range, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();
        renderMetrics(data);
      } catch (err) {
        console.error('Failed to load dashboard:', err);
      }
    }

    function renderMetrics(data) {
      const s = data.summary;
      document.getElementById('metricsGrid').innerHTML = \`
        <div class="metric-card">
          <div class="metric-label">Total Sessions</div>
          <div class="metric-value">\${s.totalSessions.toLocaleString()}</div>
          <div class="metric-sub">In selected period</div>
        </div>
        <div class="metric-card highlight">
          <div class="metric-label">Resolution Rate</div>
          <div class="metric-value">\${s.resolutionRate}%</div>
          <div class="metric-sub">\${s.completedSessions} resolved in-app</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Cases Created</div>
          <div class="metric-value">\${s.totalCases.toLocaleString()}</div>
          <div class="metric-sub">Across all types</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Total Refunds</div>
          <div class="metric-value">$\${(s.totalRefunds || 0).toLocaleString()}</div>
          <div class="metric-sub">Processed amount</div>
        </div>
        <div class="metric-card">
          <div class="metric-label">Avg Rating</div>
          <div class="metric-value">\${s.avgRating}/5</div>
          <div class="metric-sub">\${s.surveyResponses} responses</div>
        </div>
      \`;
    }

    // OLD RENDERING SYSTEM - DEPRECATED
    // These functions conflict with the new Cases view (loadCasesView/renderCaseRow)
    // which has 8 columns including Due and Resolution. Keeping commented for reference.
    /*
    async function loadCases(page = 1) {
      currentCasesPage = page;

      try {
        const response = await fetch(API_BASE + '/admin/api/cases?page=' + page, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();
        renderCases(data);
      } catch (err) {
        console.error('Failed to load cases:', err);
      }
    }

    function renderCases(data) {
      const tbody = document.getElementById('casesTableBody');

      if (!data.cases || data.cases.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">No cases found</td></tr>';
        return;
      }

      tbody.innerHTML = data.cases.map(c => \`
        <tr>
          <td><strong>\${c.case_id}</strong></td>
          <td><span class="badge badge-\${c.case_type}">\${c.case_type}</span></td>
          <td>\${c.customer_email || c.customer_name || 'N/A'}</td>
          <td>\${c.order_number || 'N/A'}</td>
          <td>\${c.resolution || 'N/A'}</td>
          <td>\${new Date(c.created_at).toLocaleString()}</td>
        </tr>
      \`).join('');

      renderPagination('casesPagination', data.pagination, loadCases);
    }
    */

    async function loadEvents(page = 1) {
      currentEventsPage = page;

      try {
        const response = await fetch(API_BASE + '/admin/api/events?page=' + page, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();
        renderEvents(data);
      } catch (err) {
        console.error('Failed to load events:', err);
      }
    }

    function renderEvents(data) {
      const tbody = document.getElementById('eventsTableBody');

      if (!data.events || data.events.length === 0) {
        tbody.innerHTML = '<tr><td colspan="5" class="loading">No events found</td></tr>';
        return;
      }

      tbody.innerHTML = data.events.map(e => \`
        <tr>
          <td><code>\${e.session_id?.substring(0, 8)}...</code></td>
          <td>\${e.event_type}</td>
          <td>\${e.event_name}</td>
          <td><code>\${e.event_data?.substring(0, 50) || '{}'}</code></td>
          <td>\${new Date(e.created_at).toLocaleString()}</td>
        </tr>
      \`).join('');

      renderPagination('eventsPagination', data.pagination, loadEvents);
    }

    function renderPagination(containerId, pagination, loadFn) {
      const container = document.getElementById(containerId);
      if (pagination.totalPages <= 1) {
        container.innerHTML = '';
        return;
      }

      let html = '';
      for (let i = 1; i <= Math.min(pagination.totalPages, 10); i++) {
        html += \`<button class="\${i === pagination.page ? 'active' : ''}" onclick="\${loadFn.name}(\${i})">\${i}</button>\`;
      }
      container.innerHTML = html;
    }

    async function loadSessions(page = 1) {
      currentSessionsPage = page;
      const range = document.getElementById('dateRange').value;

      try {
        const response = await fetch(API_BASE + '/admin/api/sessions?page=' + page + '&filter=' + currentSessionsFilter + '&range=' + range, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();
        renderSessions(data);
      } catch (err) {
        console.error('Failed to load sessions:', err);
        document.getElementById('sessionsTableBody').innerHTML = '<tr><td colspan="6" class="loading">Failed to load sessions</td></tr>';
      }
    }

    function renderSessions(data) {
      const tbody = document.getElementById('sessionsTableBody');

      if (!data.sessions || data.sessions.length === 0) {
        tbody.innerHTML = '<tr><td colspan="6" class="loading">No sessions found</td></tr>';
        return;
      }

      tbody.innerHTML = data.sessions.map(s => {
        const customerDisplay = s.customer_name || s.customer_email || 'Anonymous';
        const statusClass = s.completed ? 'badge-complete' : 'badge-incomplete';
        const statusText = s.completed ? 'Completed' : (s.issue_type || 'Incomplete');
        const recordingLink = s.session_replay_url
          ? \`<a href="\${s.session_replay_url}" target="_blank" class="recording-link">â–¶ Watch</a>\`
          : '<span class="no-recording">No recording</span>';

        return \`
          <tr>
            <td>\${new Date(s.started_at).toLocaleString()}</td>
            <td title="\${s.customer_email || ''}">\${customerDisplay}</td>
            <td>\${s.order_number || 'N/A'}</td>
            <td>\${s.flow_type || 'N/A'}</td>
            <td><span class="badge \${statusClass}">\${statusText}</span></td>
            <td>\${recordingLink}</td>
          </tr>
        \`;
      }).join('');

      renderPagination('sessionsPagination', data.pagination, loadSessions);
    }

    async function loadAnalytics() {
      const range = document.getElementById('dateRange').value;

      try {
        const response = await fetch(API_BASE + '/admin/api/analytics/issues?range=' + range, {
          headers: { 'Authorization': 'Bearer ' + authToken }
        });

        if (response.status === 401) {
          logout();
          return;
        }

        const data = await response.json();
        renderAnalytics(data);
      } catch (err) {
        console.error('Failed to load analytics:', err);
      }
    }

    function renderAnalytics(data) {
      // Transform caseTypes: { case_type, count } -> { name, count }
      const caseTypesData = (data.caseTypes || []).map(c => ({
        name: c.case_type || 'Unknown',
        count: c.count
      }));
      renderBarChart('caseTypesChart', caseTypesData, '#3B82F6');

      // Transform issueTypes (resolutions): { resolution, count } -> { name, count }
      const resolutionsData = (data.issueTypes || []).map(r => ({
        name: r.resolution || 'Unknown',
        count: r.count
      }));
      renderBarChart('resolutionsChart', resolutionsData, '#10B981');

      // Transform incompleteIssues: { issue_type, count } -> { name, count }
      const incompleteData = (data.incompleteIssues || []).map(i => ({
        name: i.issue_type || 'Unknown',
        count: i.count
      }));
      renderBarChart('incompleteChart', incompleteData, '#F59E0B');

      // Render Refunds Over Time as a simple list
      const refundsContainer = document.getElementById('refundsChart');
      if (data.refundsByDay && data.refundsByDay.length > 0) {
        refundsContainer.innerHTML = \`
          <div class="refunds-summary">
            <div class="refund-total">Total: $\${data.refundsByDay.reduce((sum, d) => sum + (d.total || 0), 0).toFixed(2)}</div>
            <div class="refund-list">
              \${data.refundsByDay.slice(-7).reverse().map(d => \`
                <div class="refund-day">
                  <span>\${d.date}</span>
                  <span>$\${(d.total || 0).toFixed(2)} (\${d.count} refunds)</span>
                </div>
              \`).join('')}
            </div>
          </div>
        \`;
      } else {
        refundsContainer.innerHTML = '<p class="no-data">No refund data available</p>';
      }
    }

    function renderBarChart(containerId, items, color) {
      const container = document.getElementById(containerId);

      if (!items || items.length === 0) {
        container.innerHTML = '<p class="no-data">No data available</p>';
        return;
      }

      const maxCount = Math.max(...items.map(i => i.count));

      container.innerHTML = \`
        <div class="bar-chart">
          \${items.slice(0, 8).map(item => \`
            <div class="bar-item">
              <div class="bar-label" title="\${item.name}">\${item.name.length > 20 ? item.name.substring(0, 20) + '...' : item.name}</div>
              <div class="bar-wrapper">
                <div class="bar" style="width: \${(item.count / maxCount * 100)}%; background: \${color};"></div>
                <span class="bar-value">\${item.count}</span>
              </div>
            </div>
          \`).join('')}
        </div>
      \`;
    }
  </script>
</body>
</html>`;
}

// ============================================
// RESOLUTION HUB API HANDLERS
// ============================================

async function handleHubStats(request, env, corsHeaders) {
  try {
    // Get case counts by status
    const pendingResult = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND (status = 'pending' OR status = 'open')`
    ).first();

    const inProgressResult = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'in_progress'`
    ).first();

    // Get ALL completed cases (for accurate total, exclude self-resolved)
    const completedResult = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'completed'`
    ).first();

    // Get completed today (for daily progress display)
    const today = new Date().toISOString().split('T')[0];
    const completedTodayResult = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'completed' AND DATE(resolved_at) = ?`
    ).bind(today).first();

    // Get counts by type (all statuses, not just non-completed, exclude self-resolved)
    const typeCountsResult = await env.ANALYTICS_DB.prepare(
      `SELECT case_type, COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) GROUP BY case_type`
    ).all();

    const typeCounts = {};
    let total = 0;
    for (const row of typeCountsResult.results || []) {
      typeCounts[row.case_type] = row.count;
      total += row.count;
    }

    // Also get total count (all cases, exclude self-resolved)
    const allCountResult = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL)`
    ).first();
    total = allCountResult?.count || 0;

    return Response.json({
      pending: pendingResult?.count || 0,
      inProgress: inProgressResult?.count || 0,
      completed: completedResult?.count || 0,
      completedToday: completedTodayResult?.count || 0,
      avgTime: '-', // TODO: Calculate average resolution time
      all: total,
      shipping: typeCounts.shipping || 0,
      refund: typeCounts.refund || 0,
      return: typeCounts.return || 0,
      subscription: typeCounts.subscription || 0,
      manual: typeCounts.manual || 0
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub stats error:', error);
    return Response.json({
      pending: 0, inProgress: 0, completed: 0, completedToday: 0, avgTime: '-',
      all: 0, shipping: 0, refund: 0, return: 0, subscription: 0, manual: 0
    }, { headers: corsHeaders });
  }
}

async function handleHubCases(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get('limit')) || 50;
    const page = parseInt(url.searchParams.get('page')) || 1;
    const offset = (page - 1) * limit;
    
    // Support both 'type' (from frontend) and 'filter' (legacy)
    const filter = url.searchParams.get('type') || url.searchParams.get('filter') || 'all';
    const status = url.searchParams.get('status');
    const assignee = url.searchParams.get('assignee');
    const dateRange = url.searchParams.get('dateRange');
    const sortBy = url.searchParams.get('sortBy') || 'created';
    const sortOrder = url.searchParams.get('sortOrder') || 'desc';
    const search = url.searchParams.get('search');

    // Exclude self-resolved cases from regular cases list
    const conditions = [`(resolved_in_app != 1 OR resolved_in_app IS NULL)`];
    const params = [];

    if (filter && filter !== 'all') {
      conditions.push(`case_type = ?`);
      params.push(filter);
    }

    if (status) {
      if (status === 'overdue') {
        // Overdue: created more than 24 hours ago and not completed
        conditions.push(`datetime(created_at, '+24 hours') < datetime('now') AND status != 'completed'`);
      } else {
      conditions.push(`status = ?`);
      params.push(status);
      }
    }

    if (assignee) {
      if (assignee === 'unassigned') {
        conditions.push(`(assigned_to IS NULL OR assigned_to = '' OR assigned_to = 'Unassigned')`);
      } else {
        conditions.push(`assigned_to = ?`);
        params.push(assignee);
      }
    }

    if (dateRange) {
      const now = new Date();
      let dateCondition = '';
      if (dateRange === 'today') {
        dateCondition = `DATE(created_at) = DATE('now')`;
      } else if (dateRange === '7d') {
        dateCondition = `created_at >= datetime('now', '-7 days')`;
      } else if (dateRange === '30d') {
        dateCondition = `created_at >= datetime('now', '-30 days')`;
      }
      if (dateCondition) {
        conditions.push(dateCondition);
      }
    }

    if (search) {
      // Enhanced search across multiple fields
      conditions.push(`(
        case_id LIKE ? OR 
        customer_email LIKE ? OR 
        customer_name LIKE ? OR
        order_number LIKE ? OR
        resolution LIKE ? OR
        assigned_to LIKE ?
      )`);
      const searchTerm = `%${search}%`;
      params.push(searchTerm, searchTerm, searchTerm, searchTerm, searchTerm, searchTerm);
    }

    const whereClause = conditions.length > 0 ? ` WHERE ` + conditions.join(' AND ') : '';
    let query = `SELECT * FROM cases` + whereClause;
    let countQuery = `SELECT COUNT(*) as total FROM cases` + whereClause;

    // Sorting
    let orderBy = 'created_at DESC';
    if (sortBy === 'created') {
      orderBy = `created_at ${sortOrder.toUpperCase()}`;
    } else if (sortBy === 'due') {
      // Due date is created_at + 24 hours
      orderBy = `datetime(created_at, '+24 hours') ${sortOrder.toUpperCase()}`;
    } else if (sortBy === 'customer') {
      orderBy = `customer_name ${sortOrder.toUpperCase()}`;
    } else if (sortBy === 'status') {
      orderBy = `status ${sortOrder.toUpperCase()}`;
    } else if (sortBy === 'type') {
      orderBy = `case_type ${sortOrder.toUpperCase()}`;
    } else if (sortBy === 'assignee') {
      orderBy = `assigned_to ${sortOrder.toUpperCase()}`;
    }

    query += ` ORDER BY ${orderBy} LIMIT ? OFFSET ?`;

    // Get total count first
    const countStmt = env.ANALYTICS_DB.prepare(countQuery);
    const countResult = await countStmt.bind(...params).first();
    const total = countResult?.total || 0;
    const totalPages = Math.ceil(total / limit);

    // Get cases
    const stmt = env.ANALYTICS_DB.prepare(query);
    const queryParams = [...params, limit, offset];
    const result = await stmt.bind(...queryParams).all();

    // Get unique assignees for filter dropdown (exclude self-resolved)
    const assigneesResult = await env.ANALYTICS_DB.prepare(`
      SELECT DISTINCT assigned_to FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND assigned_to IS NOT NULL AND assigned_to != '' AND assigned_to != 'Unassigned'
    `).all();
    const assignees = (assigneesResult.results || []).map(r => r.assigned_to).filter(Boolean);

    // Get counts by type for navigation badges (exclude self-resolved)
    const countsResult = await env.ANALYTICS_DB.prepare(`
      SELECT 
        COUNT(*) as all_count,
        SUM(CASE WHEN case_type = 'shipping' THEN 1 ELSE 0 END) as shipping_count,
        SUM(CASE WHEN case_type = 'refund' THEN 1 ELSE 0 END) as refund_count,
        SUM(CASE WHEN case_type = 'return' THEN 1 ELSE 0 END) as return_count,
        SUM(CASE WHEN case_type = 'subscription' THEN 1 ELSE 0 END) as subscription_count,
        SUM(CASE WHEN case_type = 'manual' THEN 1 ELSE 0 END) as manual_count
      FROM cases
      WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL)
    `).first();

    return Response.json({
      cases: result.results || [],
      total: total,
      totalPages: totalPages,
      page: page,
      assignees: assignees,
      counts: {
        all: countsResult?.all_count || 0,
        shipping: countsResult?.shipping_count || 0,
        refund: countsResult?.refund_count || 0,
        return: countsResult?.return_count || 0,
        subscription: countsResult?.subscription_count || 0,
        manual: countsResult?.manual_count || 0
      }
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub cases error:', error);
    return Response.json({ cases: [], total: 0, totalPages: 0, page: 1, assignees: [] }, { headers: corsHeaders });
  }
}

async function handleHubCasesSearch(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const query = url.searchParams.get('q') || '';
    const limit = parseInt(url.searchParams.get('limit')) || 10;

    if (!query || query.length < 2) {
      return Response.json({ results: [] }, { headers: corsHeaders });
    }

    const searchTerm = `%${query}%`;
    const result = await env.ANALYTICS_DB.prepare(`
      SELECT 
        case_id,
        customer_name,
        customer_email,
        case_type,
        status,
        order_number,
        resolution,
        assigned_to,
        created_at
      FROM cases
      WHERE 
        case_id LIKE ? OR 
        customer_email LIKE ? OR 
        customer_name LIKE ? OR
        order_number LIKE ? OR
        resolution LIKE ? OR
        assigned_to LIKE ?
      ORDER BY created_at DESC
      LIMIT ?
    `).bind(searchTerm, searchTerm, searchTerm, searchTerm, searchTerm, searchTerm, limit).all();

    return Response.json({
      results: result.results || []
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub cases search error:', error);
    return Response.json({ results: [] }, { headers: corsHeaders });
  }
}

async function handleHubCasesByCategory(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const category = url.searchParams.get('category') || '';
    const limit = parseInt(url.searchParams.get('limit')) || 10;

    if (!category) {
      return Response.json({ cases: [] }, { headers: corsHeaders });
    }

    const result = await env.ANALYTICS_DB.prepare(`
      SELECT 
        case_id,
        customer_name,
        customer_email,
        case_type,
        status,
        order_number,
        resolution,
        refund_amount,
        created_at
      FROM cases
      WHERE case_type = ?
      ORDER BY created_at DESC
      LIMIT ?
    `).bind(category, limit).all();

    return Response.json({
      cases: result.results || []
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub cases by category error:', error);
    return Response.json({ cases: [] }, { headers: corsHeaders });
  }
}

async function handleHubSelfResolved(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get('limit')) || 50;
    const page = parseInt(url.searchParams.get('page')) || 1;
    const offset = (page - 1) * limit;
    const search = url.searchParams.get('search');

    let query = `SELECT * FROM cases WHERE resolved_in_app = 1`;
    let countQuery = `SELECT COUNT(*) as total FROM cases WHERE resolved_in_app = 1`;
    const params = [];
    const countParams = [];

    if (search) {
      const searchCondition = ` AND (
        case_id LIKE ? OR 
        customer_email LIKE ? OR 
        customer_name LIKE ? OR
        order_number LIKE ? OR
        resolution LIKE ? OR
        issue_type LIKE ?
      )`;
      query += searchCondition;
      countQuery += searchCondition;
      const searchTerm = `%${search}%`;
      // Add search terms for both queries
      params.push(searchTerm, searchTerm, searchTerm, searchTerm, searchTerm, searchTerm);
      countParams.push(searchTerm, searchTerm, searchTerm, searchTerm, searchTerm, searchTerm);
    }

    // Get total count
    const countResult = await env.ANALYTICS_DB.prepare(countQuery).bind(...countParams).first();
    const total = countResult?.total || 0;
    const totalPages = Math.ceil(total / limit);

    // Get cases with pagination
    query += ` ORDER BY created_at DESC LIMIT ? OFFSET ?`;
    params.push(limit, offset);
    
    const result = await env.ANALYTICS_DB.prepare(query).bind(...params).all();

    return Response.json({
      cases: result.results || [],
      total: total,
      totalPages: totalPages,
      page: page
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub self-resolved error:', error);
    console.error('Error details:', {
      message: error.message,
      stack: error.stack,
      name: error.name
    });
    // If resolved_in_app column doesn't exist, return empty results
    if (error.message?.includes('no such column') || error.message?.includes('resolved_in_app')) {
      console.error('CRITICAL: resolved_in_app column does not exist in database. Migration 007_self_resolved.sql needs to be run.');
      return Response.json({
        cases: [],
        total: 0,
        totalPages: 0,
        page: 1,
        notice: 'Self-resolved feature not available. Run migration 007_self_resolved.sql'
      }, { headers: corsHeaders });
    }
    return Response.json({ cases: [], total: 0, totalPages: 0, page: 1 }, { headers: corsHeaders });
  }
}

async function handleHubIssuesSearch(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const query = url.searchParams.get('q') || '';
    const limit = parseInt(url.searchParams.get('limit')) || 10;

    if (!query || query.length < 2) {
      return Response.json({ results: [] }, { headers: corsHeaders });
    }

    // Determine which table to use
    let tableName = 'issue_reports';
    try {
      await env.ANALYTICS_DB.prepare(`SELECT 1 FROM ${tableName} LIMIT 1`).first();
    } catch {
      tableName = 'trouble_reports';
      try {
        await env.ANALYTICS_DB.prepare(`SELECT 1 FROM ${tableName} LIMIT 1`).first();
      } catch {
        return Response.json({ results: [] }, { headers: corsHeaders });
      }
    }

    const searchTerm = `%${query}%`;
    const result = await env.ANALYTICS_DB.prepare(`
      SELECT 
        report_id,
        customer_email,
        name,
        issue_type,
        status,
        description,
        created_at
      FROM ${tableName}
      WHERE 
        report_id LIKE ? OR 
        customer_email LIKE ? OR 
        name LIKE ? OR
        description LIKE ? OR
        issue_type LIKE ?
      ORDER BY created_at DESC
      LIMIT ?
    `).bind(searchTerm, searchTerm, searchTerm, searchTerm, searchTerm, limit).all();

    return Response.json({
      results: result.results || []
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub issues search error:', error);
    return Response.json({ results: [] }, { headers: corsHeaders });
  }
}

async function handleHubGetCase(caseId, env, corsHeaders) {
  try {
    const caseData = await env.ANALYTICS_DB.prepare(
      `SELECT * FROM cases WHERE case_id = ?`
    ).bind(caseId).first();

    if (!caseData) {
      return Response.json({ error: 'Case not found' }, { status: 404, headers: corsHeaders });
    }

    // Parse JSON fields
    if (caseData.selected_items) {
      try { caseData.selected_items = JSON.parse(caseData.selected_items); } catch (e) {}
    }
    if (caseData.photo_urls) {
      try { caseData.photo_urls = JSON.parse(caseData.photo_urls); } catch (e) {}
    }
    if (caseData.shipping_address) {
      try { caseData.shipping_address = JSON.parse(caseData.shipping_address); } catch (e) {}
    }
    if (caseData.extra_data) {
      try { caseData.extra_data = JSON.parse(caseData.extra_data); } catch (e) {}
    }

    // Calculate due date (24 hours from creation)
    if (caseData.created_at) {
      const createdAt = new Date(caseData.created_at);
      const dueDate = new Date(createdAt.getTime() + (24 * 60 * 60 * 1000));
      caseData.due_date = dueDate.toISOString();
      caseData.is_overdue = new Date() > dueDate && caseData.status !== 'completed';
    }

    // Construct CheckoutChamp URL if purchase_id exists (for subscription cases)
    const purchaseId = caseData.extra_data?.purchaseId || caseData.extra_data?.clientOrderId;
    if (purchaseId && caseData.case_type === 'subscription') {
      caseData.checkout_champ_url = `https://app.checkout-champ.com/orders/${purchaseId}`;
    }

    // Get session replay URL from session if not already on case
    if (!caseData.session_replay_url && caseData.session_id) {
      try {
        const session = await env.ANALYTICS_DB.prepare(
          'SELECT session_replay_url FROM sessions WHERE session_id = ?'
        ).bind(caseData.session_id).first();
        if (session?.session_replay_url) {
          caseData.session_replay_url = session.session_replay_url;
        }
      } catch (e) {
        // Session table might not have this column
      }
    }

    // Get activity logs for this case
    let activities = [];
    try {
      const activityResult = await env.ANALYTICS_DB.prepare(
        `SELECT * FROM case_activity WHERE case_id = ? ORDER BY created_at DESC LIMIT 50`
      ).bind(caseId).all();
      activities = activityResult.results || [];
    } catch (e) {
      // Activity table might not exist
    }

    // Get comments for this case
    let comments = [];
    try {
      const commentsResult = await env.ANALYTICS_DB.prepare(
        `SELECT * FROM case_comments WHERE case_id = ? ORDER BY created_at ASC`
      ).bind(caseId).all();
      comments = commentsResult.results || [];
    } catch (e) {
      // Comments table might not exist
    }

    // Get relevant SOP link based on case type and resolution
    let sopLink = null;
    try {
      // Try to find a matching SOP
      const sopResult = await env.ANALYTICS_DB.prepare(`
        SELECT * FROM sop_links 
        WHERE case_type = ? AND is_active = 1
        ORDER BY 
          CASE WHEN scenario_key LIKE ? THEN 0 ELSE 1 END,
          scenario_name
        LIMIT 1
      `).bind(caseData.case_type, `%${caseData.resolution || ''}%`).first();
      
      if (sopResult) {
        sopLink = sopResult;
      }
    } catch (e) {
      // SOP table might not exist
    }

    // Get relevant email templates for quick access
    let emailTemplates = [];
    try {
      const templatesResult = await env.ANALYTICS_DB.prepare(`
        SELECT id, template_key, template_name, subject FROM email_templates 
        WHERE category = ? AND is_active = 1
        ORDER BY template_name
        LIMIT 5
      `).bind(caseData.case_type).all();
      emailTemplates = templatesResult.results || [];
    } catch (e) {
      // Email templates table might not exist
    }

    // Try to enrich with Shopify order data if we have order_number
    let shopifyOrder = null;
    if (caseData.order_number && env.SHOPIFY_STORE && env.SHOPIFY_ACCESS_TOKEN) {
      try {
        const orderNum = caseData.order_number.replace('#', '');
        const shopifyResponse = await fetch(
          `https://${env.SHOPIFY_STORE}/admin/api/2024-01/orders.json?name=${encodeURIComponent(orderNum)}&status=any`,
          {
            headers: {
              'X-Shopify-Access-Token': env.SHOPIFY_ACCESS_TOKEN,
              'Content-Type': 'application/json',
            },
          }
        );
        
        if (shopifyResponse.ok) {
          const shopifyData = await shopifyResponse.json();
          if (shopifyData.orders && shopifyData.orders.length > 0) {
            const order = shopifyData.orders[0];
            shopifyOrder = {
              id: order.id,
              order_number: order.name,
              financial_status: order.financial_status,
              fulfillment_status: order.fulfillment_status,
              created_at: order.created_at,
              total_price: order.total_price,
              currency: order.currency,
              order_url: `https://${env.SHOPIFY_STORE}/admin/orders/${order.id}`,
              customer: order.customer ? {
                first_name: order.customer.first_name,
                last_name: order.customer.last_name,
                email: order.customer.email
              } : null
            };
          }
        }
      } catch (e) {
        console.error('Shopify enrichment error:', e);
        // Don't fail the request if Shopify lookup fails
      }
    }

    return Response.json({ 
      case: caseData,
      activities,
      comments,
      sop_link: sopLink,
      email_templates: emailTemplates,
      shopify_order: shopifyOrder
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub get case error:', error);
    return Response.json({ error: 'Failed to load case' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubUpdateStatus(request, caseId, env, corsHeaders) {
  try {
    const { status, actor, actor_email } = await request.json();

    // Get current case to record old status
    const currentCase = await env.ANALYTICS_DB.prepare(
      `SELECT status FROM cases WHERE case_id = ?`
    ).bind(caseId).first();

    if (!currentCase) {
      return Response.json({ error: 'Case not found' }, { status: 404, headers: corsHeaders });
    }

    const oldStatus = currentCase.status;
    const now = new Date().toISOString();

    // Update case status - use only columns that definitely exist
    try {
      if (status === 'completed' && oldStatus !== 'completed') {
        await env.ANALYTICS_DB.prepare(
          `UPDATE cases SET status = ?, updated_at = ?, resolved_at = ?, resolved_by = ? WHERE case_id = ?`
        ).bind(status, now, now, actor || actor_email || 'team_member', caseId).run();
      } else {
        await env.ANALYTICS_DB.prepare(
          `UPDATE cases SET status = ?, updated_at = ? WHERE case_id = ?`
        ).bind(status, now, caseId).run();
      }
    } catch (e) {
      // Fallback without resolved_by if column doesn't exist
      try {
        if (status === 'completed' && oldStatus !== 'completed') {
          await env.ANALYTICS_DB.prepare(
            `UPDATE cases SET status = ?, updated_at = ?, resolved_at = ? WHERE case_id = ?`
          ).bind(status, now, now, caseId).run();
        } else {
          await env.ANALYTICS_DB.prepare(
            `UPDATE cases SET status = ?, updated_at = ? WHERE case_id = ?`
          ).bind(status, now, caseId).run();
        }
      } catch (e2) {
        // Fallback without updated_at if column doesn't exist
        await env.ANALYTICS_DB.prepare(
          `UPDATE cases SET status = ? WHERE case_id = ?`
        ).bind(status, caseId).run();
      }
    }

    // Try to log activity (table might not exist)
    try {
      await env.ANALYTICS_DB.prepare(
        `INSERT INTO case_activity (case_id, activity_type, field_name, old_value, new_value, actor, actor_email, source) VALUES (?, ?, ?, ?, ?, ?, ?, ?)`
      ).bind(caseId, 'status_changed', 'status', oldStatus, status, actor || 'team_member', actor_email || '', 'hub').run();
    } catch (e) {
      console.log('Could not log to case_activity:', e.message);
    }

    // Try to log event (columns might not exist)
    try {
      await env.ANALYTICS_DB.prepare(
        `INSERT INTO events (session_id, event_type, event_name, event_data) VALUES (?, ?, ?, ?)`
      ).bind(caseId, 'status_change', 'Status changed to ' + status, JSON.stringify({ old_status: oldStatus, new_status: status, case_id: caseId })).run();
    } catch (e) {
      console.log('Could not log event:', e.message);
    }

    return Response.json({ success: true, status }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub update status error:', error);
    return Response.json({ error: 'Failed to update status: ' + error.message }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubGetComments(caseId, env, corsHeaders) {
  try {
    const comments = await env.ANALYTICS_DB.prepare(
      `SELECT * FROM case_comments WHERE case_id = ? ORDER BY created_at ASC`
    ).bind(caseId).all();

    return Response.json({ comments: comments.results || [] }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub get comments error:', error);
    // Check if table doesn't exist
    if (error.message?.includes('no such table')) {
      return Response.json({
        comments: [],
        notice: 'Comments table not yet created. Run migrations to enable comments.'
      }, { headers: corsHeaders });
    }
    return Response.json({ comments: [] }, { headers: corsHeaders });
  }
}

async function handleHubAddComment(request, caseId, env, corsHeaders) {
  try {
    const { content, author_name, author_email } = await request.json();

    if (!content || !content.trim()) {
      return Response.json({ error: 'Comment content is required' }, { status: 400, headers: corsHeaders });
    }

    const now = new Date().toISOString();

    // Insert comment
    const result = await env.ANALYTICS_DB.prepare(
      `INSERT INTO case_comments (case_id, content, author_name, author_email, source, created_at) VALUES (?, ?, ?, ?, ?, ?)`
    ).bind(caseId, content.trim(), author_name || 'Team Member', author_email || '', 'hub', now).run();

    // Log activity
    await env.ANALYTICS_DB.prepare(
      `INSERT INTO case_activity (case_id, activity_type, new_value, actor, actor_email, source) VALUES (?, ?, ?, ?, ?, ?)`
    ).bind(caseId, 'comment_added', content.trim().substring(0, 100), author_name || 'team_member', author_email || '', 'hub').run();

    // Update case updated_at
    await env.ANALYTICS_DB.prepare(
      `UPDATE cases SET updated_at = ? WHERE case_id = ?`
    ).bind(now, caseId).run();

    return Response.json({
      success: true,
      comment: {
        id: result.meta?.last_row_id,
        case_id: caseId,
        content: content.trim(),
        author_name: author_name || 'Team Member',
        author_email: author_email || '',
        source: 'hub',
        created_at: now
      }
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub add comment error:', error);
    // Check if table doesn't exist
    if (error.message?.includes('no such table')) {
      return Response.json({
        error: 'Comments table not yet created. Please run: CREATE TABLE case_comments (id INTEGER PRIMARY KEY AUTOINCREMENT, case_id TEXT NOT NULL, content TEXT NOT NULL, author_name TEXT, author_email TEXT, source TEXT DEFAULT \'hub\', created_at DATETIME DEFAULT CURRENT_TIMESTAMP);'
      }, { status: 500, headers: corsHeaders });
    }
    return Response.json({ error: 'Failed to add comment' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubCaseActivity(caseId, env, corsHeaders) {
  try {
    const activities = await env.ANALYTICS_DB.prepare(
      `SELECT id, case_id, activity_type, field_name, old_value, new_value, actor, actor_email, source, created_at
       FROM case_activity
       WHERE case_id = ?
       ORDER BY created_at DESC
       LIMIT 50`
    ).bind(caseId).all();

    return Response.json({
      success: true,
      activities: activities.results || []
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub case activity error:', error);
    // If table doesn't exist, return empty array
    if (error.message?.includes('no such table')) {
      return Response.json({ success: true, activities: [] }, { headers: corsHeaders });
    }
    return Response.json({ error: 'Failed to load activity' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// FORMAT CASE DETAILS WITH OPENAI
// Generates detailed issueReason and resolution from case data
// ============================================
async function handleFormatCaseDetails(request, env, corsHeaders) {
  try {
    const caseData = await request.json();

    console.log('ðŸ” OpenAI API: Received case data for case_id:', caseData?.case_id);
    console.log('ðŸ“¦ OpenAI API: Case type:', caseData?.case_type, 'Resolution:', caseData?.resolution);

    if (!caseData || !caseData.case_id) {
      console.error('âŒ OpenAI API: Missing case_id');
      return Response.json({ error: 'Case data required' }, { status: 400, headers: corsHeaders });
    }

    // Skip OpenAI for self-resolved cases - they're not cases, just records
    if (caseData.resolved_in_app) {
      console.log('â­ï¸ OpenAI API: Skipping - self-resolved case (not a case, just a record)');
      return Response.json({
        issueReason: caseData.issue_type ? caseData.issue_type.replace(/_/g, ' ').replace(/\b\w/g, c => c.toUpperCase()) : 'Customer inquiry',
        resolution: null // No resolution needed for self-resolved
      }, { headers: corsHeaders });
    }

    // Parse extra_data if it's a string
    if (caseData.extra_data && typeof caseData.extra_data === 'string') {
      try {
        caseData.extra_data = JSON.parse(caseData.extra_data);
        console.log('âœ… OpenAI API: Parsed extra_data from string');
      } catch (e) {
        console.error('âŒ OpenAI API: Failed to parse extra_data:', e);
        caseData.extra_data = {};
      }
    }

    const extraData = caseData.extra_data || {};
    console.log('ðŸ“‹ OpenAI API: Subscription details in extra_data:', {
      actionType: extraData.actionType,
      newFrequency: extraData.newFrequency,
      previousFrequency: extraData.previousFrequency,
      notes: extraData.notes,
      pauseDuration: extraData.pauseDuration,
    });

    // Build comprehensive prompt
    const systemPrompt = `You are a case management assistant. Analyze case data and generate TWO CONCISE, DIRECT fields:

1. **issueReason**: Simply state WHAT THE CUSTOMER'S ISSUE IS. Be direct and factual. No fluff, no unnecessary context.
   Examples:
   - "Customer wants to change delivery frequency"
   - "Customer requesting refund for damaged item"
   - "Customer did not receive their order"
   - "Customer wants to pause subscription"
   
   Keep it short and to the point. Only include essential information about the customer's problem.

2. **resolution**: State EXACTLY WHAT NEEDS TO BE DONE with ALL DETAILS. Detail is key - include dates, amounts, addresses, order numbers, and any specific information needed to complete the action. Make it as easy as possible for the team to execute.
   
   **CRITICAL FOR SUBSCRIPTION FREQUENCY CHANGES**: You MUST calculate and include the next delivery date. Use the case creation date and add the new frequency in days to calculate when the next delivery will occur. Format: "Next delivery date: [Month Day, Year]"
   
   Examples:
   - "Update subscription frequency to every 45 days. Next delivery date: March 7, 2026 (calculated from case date + 45 days). Subscription ID: AE4ADA882C. Order: #171088P. Product: Laundry Detergent Sheets. Notify customer at wendygareth77@hotmail.com once completed."
   - "Process 20% partial refund ($X.XX) for order [order number]. Customer keeps product. Refund to original payment method."
   - "Reship order [order number] to: [full address]. Use same shipping method. Send tracking number to customer email: [email]"
   - "Pause subscription [subscription ID] for 30 days. Resume date: [calculate and include specific date]. Product: [include product name]"
   
   Include ALL actionable details: dates (CALCULATE them when needed), amounts, IDs, addresses, email addresses, tracking numbers, etc. Be specific and complete.

CRITICAL RULES:
- issueReason: Be CONCISE - no unnecessary words, just the customer's issue
- resolution: DETAIL IS KEY - include ALL actionable information (dates, amounts, IDs, addresses, emails, etc.) to make it easy for the team
- These two fields must be DIFFERENT - issueReason is the problem, resolution is the detailed action steps
- DO NOT duplicate information between fields
- resolution must include specific details like dates, order numbers, subscription IDs, addresses, amounts, etc.

Return ONLY valid JSON in this format:
{
  "issueReason": "...",
  "resolution": "..."
}`;

    // Format case data for the prompt
    const refundAmount = caseData.refund_amount ? `$${parseFloat(caseData.refund_amount).toFixed(2)}` : null;
    
    // Build user prompt with all relevant data
    let userPrompt = `Analyze this case data and generate detailed issueReason and resolution fields:\n\n`;
    userPrompt += `CASE ID: ${caseData.case_id}\n`;
    userPrompt += `CASE TYPE: ${caseData.case_type || 'N/A'}\n`;
    userPrompt += `CATEGORY: ${caseData.category || 'N/A'}\n`;
    userPrompt += `RESOLUTION CODE: ${caseData.resolution || 'N/A'}\n`;
    userPrompt += `STATUS: ${caseData.status || 'N/A'}\n`;
    if (caseData.created_at) {
      const createdDate = new Date(caseData.created_at);
      userPrompt += `CASE CREATED: ${createdDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })} at ${createdDate.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' })}\n`;
    }
    userPrompt += `\n`;
    
    userPrompt += `CUSTOMER INFO:\n`;
    userPrompt += `- Name: ${caseData.customer_name || 'N/A'}\n`;
    userPrompt += `- Email: ${caseData.customer_email || 'N/A'}\n\n`;
    
    userPrompt += `ORDER INFO:\n`;
    userPrompt += `- Order Number: ${caseData.order_number || 'N/A'}\n`;
    if (refundAmount) userPrompt += `- Refund Amount: ${refundAmount}\n`;
    if (caseData.refund_percent) userPrompt += `- Refund Percent: ${caseData.refund_percent}%\n`;
    if (caseData.keepProduct !== undefined) userPrompt += `- Customer Keeps Product: ${caseData.keepProduct}\n`;
    userPrompt += `\n`;
    
    // Shipping info
    if (caseData.tracking_number || caseData.carrier_name) {
      userPrompt += `SHIPPING INFO:\n`;
      if (caseData.tracking_number) userPrompt += `- Tracking: ${caseData.tracking_number}\n`;
      if (caseData.carrier_name) userPrompt += `- Carrier: ${caseData.carrier_name}\n`;
      if (caseData.tracking_status) userPrompt += `- Status: ${caseData.tracking_status}\n`;
      if (caseData.shipping_address) {
        const addr = typeof caseData.shipping_address === 'string' 
          ? JSON.parse(caseData.shipping_address) 
          : caseData.shipping_address;
        userPrompt += `- Address: ${addr.street || ''}, ${addr.city || ''}, ${addr.state || ''} ${addr.zip || ''}, ${addr.country || ''}\n`;
      }
      userPrompt += `\n`;
    }
    
    // Missing items
    if (caseData.missing_item_description || caseData.missing_item_order_list) {
      userPrompt += `MISSING ITEMS:\n`;
      if (caseData.missing_item_description) userPrompt += `- Description: ${caseData.missing_item_description}\n`;
      if (caseData.missing_item_order_list) userPrompt += `- Order List: ${caseData.missing_item_order_list}\n`;
      userPrompt += `\n`;
    }
    
    // Extra data details
    userPrompt += `ADDITIONAL DETAILS (extra_data):\n`;
    if (extraData.intentDetails) userPrompt += `- Customer's Own Words: "${extraData.intentDetails}"\n`;
    if (extraData.issueType) userPrompt += `- Issue Type: ${extraData.issueType}\n`;
    if (extraData.notes) {
      userPrompt += `- Notes: ${extraData.notes}\n`;
      // Notes often contain critical context like "Schedule changed from every X days to every Y days"
      console.log('ðŸ“ OpenAI API: Notes field contains:', extraData.notes);
    }
    
    // Subscription details
    if (caseData.case_type === 'subscription' || extraData.actionType) {
      userPrompt += `\nSUBSCRIPTION DETAILS:\n`;
      if (extraData.actionType) userPrompt += `- Action Type: ${extraData.actionType}\n`;
      if (extraData.subscriptionProductName) userPrompt += `- Product: ${extraData.subscriptionProductName}\n`;
      if (extraData.clientOrderId) userPrompt += `- Order ID: ${extraData.clientOrderId}\n`;
      if (extraData.pauseDuration) userPrompt += `- Pause Duration: ${extraData.pauseDuration} days\n`;
      if (extraData.pauseResumeDate) {
        const resumeDate = new Date(extraData.pauseResumeDate);
        userPrompt += `- Resume Date: ${resumeDate.toLocaleDateString('en-US', { month: 'long', day: 'numeric', year: 'numeric' })}\n`;
      }
      if (extraData.cancelReason) userPrompt += `- Cancel Reason: ${extraData.cancelReason}\n`;
      // Schedule change details - CRITICAL for schedule_changed cases
      if (extraData.previousFrequency && extraData.newFrequency) {
        userPrompt += `- SCHEDULE CHANGE: Delivery frequency changed from every ${extraData.previousFrequency} days to every ${extraData.newFrequency} days\n`;
        userPrompt += `- Previous Schedule: Every ${extraData.previousFrequency} days\n`;
        userPrompt += `- New Schedule: Every ${extraData.newFrequency} days\n`;
      } else if (extraData.newFrequency) {
        userPrompt += `- New Delivery Schedule: Every ${extraData.newFrequency} days\n`;
      }
      if (extraData.newAddress) {
        const addr = extraData.newAddress;
        userPrompt += `- New Address: ${addr.street || ''}, ${addr.city || ''}, ${addr.state || ''} ${addr.zip || ''}, ${addr.country || ''}\n`;
      }
      if (extraData.discountPercent) userPrompt += `- Discount: ${extraData.discountPercent}%\n`;
    }
    
    // Dog information
    if (extraData.dogs && Array.isArray(extraData.dogs) && extraData.dogs.length > 0) {
      userPrompt += `\nDOG INFORMATION:\n`;
      extraData.dogs.forEach((dog, idx) => {
        userPrompt += `- Dog ${idx + 1}: ${dog.name || 'N/A'} (${dog.breed || 'N/A'}, Age ${dog.age || 'N/A'})\n`;
      });
      if (extraData.methodsTried) {
        userPrompt += `- Methods Tried: ${extraData.methodsTried}\n`;
      }
    }
    
    // Quality details
    if (extraData.qualityDetails) {
      userPrompt += `\nQUALITY DETAILS:\n`;
      const qd = extraData.qualityDetails;
      if (qd.customerReportedCount) userPrompt += `- Pads Affected: ${qd.customerReportedCount}\n`;
      if (qd.upgradeTotal) userPrompt += `- Upgrade Total: $${qd.upgradeTotal}\n`;
      if (qd.customerNotes) userPrompt += `- Customer Notes: ${qd.customerNotes}\n`;
    }
    
    // Corrected address
    if (extraData.correctedAddress) {
      userPrompt += `\nCORRECTED ADDRESS:\n`;
      const addr = extraData.correctedAddress;
      userPrompt += `${addr.street || ''}, ${addr.city || ''}, ${addr.state || ''} ${addr.zip || ''}, ${addr.country || ''}\n`;
    }
    
    userPrompt += `\nGenerate issueReason (customer perspective - what the problem is) and resolution (action steps - what team needs to do). Make sure they are DIFFERENT and serve different purposes.`;

    console.log('ðŸ“ OpenAI API: Sending prompt to OpenAI (length:', userPrompt.length, 'chars)');
    console.log('ðŸ“‹ OpenAI API: Prompt preview (first 500 chars):', userPrompt.substring(0, 500));

    // Call OpenAI
    if (!env.OPENAI_API_KEY) {
      console.error('âŒ OpenAI API: OPENAI_API_KEY not set in environment');
      return Response.json({ 
        error: 'OpenAI API key not configured',
        fallback: true 
      }, { status: 500, headers: corsHeaders });
    }

    console.log('ðŸš€ OpenAI API: Calling OpenAI API...');
    const response = await fetch('https://api.openai.com/v1/chat/completions', {
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${env.OPENAI_API_KEY}`,
        'Content-Type': 'application/json',
      },
      body: JSON.stringify({
        model: 'gpt-4o-mini',
        messages: [
          { role: 'system', content: systemPrompt },
          { role: 'user', content: userPrompt },
        ],
        max_tokens: 800,
        temperature: 0.3, // Lower temperature for more consistent, factual output
      }),
    });

    if (!response.ok) {
      const errorText = await response.text();
      console.error('âŒ OpenAI API error:', response.status, errorText);
      return Response.json({ 
        error: 'Failed to format case details',
        fallback: true 
      }, { status: 500, headers: corsHeaders });
    }

    const data = await response.json();
    const message = data.choices[0]?.message?.content || '';
    console.log('âœ… OpenAI API: Received response from OpenAI (length:', message.length, 'chars)');
    console.log('ðŸ“„ OpenAI API: Raw response:', message);

    // Parse JSON response
    try {
      // Extract JSON from markdown code blocks if present
      let jsonStr = message.trim();
      if (jsonStr.startsWith('```')) {
        jsonStr = jsonStr.replace(/```json\n?/g, '').replace(/```\n?/g, '').trim();
      }
      
      const result = JSON.parse(jsonStr);
      console.log('âœ… OpenAI API: Parsed JSON result:', result);
      
      return Response.json({
        success: true,
        issueReason: result.issueReason || 'Issue details not available',
        resolution: result.resolution || 'Resolution details not available'
      }, { headers: corsHeaders });
    } catch (parseError) {
      console.error('âŒ OpenAI API: Failed to parse OpenAI response:', parseError);
      console.error('ðŸ“„ OpenAI API: Response that failed to parse:', message);
      return Response.json({ 
        error: 'Failed to parse AI response',
        fallback: true,
        rawResponse: message
      }, { status: 500, headers: corsHeaders });
    }
  } catch (error) {
    console.error('Format case details error:', error);
    return Response.json({ 
      error: 'Failed to format case details',
      fallback: true 
    }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubSessions(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get('limit')) || 50;
    const page = parseInt(url.searchParams.get('page')) || 1;
    const offset = (page - 1) * limit;

    // Try to get sessions - handle both created_at and started_at columns
    let sessions = [];
    try {
      const result = await env.ANALYTICS_DB.prepare(
        `SELECT * FROM sessions ORDER BY COALESCE(started_at, created_at) DESC LIMIT ? OFFSET ?`
    ).bind(limit, offset).all();
      sessions = result.results || [];
    } catch (dbError) {
      console.log('Sessions query error:', dbError.message);
      // Try alternative query
      try {
        const result = await env.ANALYTICS_DB.prepare(
          `SELECT * FROM sessions ORDER BY started_at DESC LIMIT ? OFFSET ?`
        ).bind(limit, offset).all();
        sessions = result.results || [];
      } catch (e2) {
        console.log('Alternative sessions query also failed:', e2.message);
      }
    }

    const countResult = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM sessions`
    ).first();

    const total = countResult?.count || 0;
    const totalPages = Math.ceil(total / limit);

    return Response.json({
      sessions: sessions,
      total: total,
      totalPages: totalPages,
      page: page
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub sessions error:', error);
    return Response.json({ sessions: [], total: 0, totalPages: 0, page: 1 }, { headers: corsHeaders });
  }
}

async function handleHubEvents(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get('limit')) || 50;
    const page = parseInt(url.searchParams.get('page')) || 1;
    const offset = (page - 1) * limit;

    const events = await env.ANALYTICS_DB.prepare(
      `SELECT * FROM events ORDER BY created_at DESC LIMIT ? OFFSET ?`
    ).bind(limit, offset).all();

    const countResult = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM events`
    ).first();

    const total = countResult?.count || 0;
    const totalPages = Math.ceil(total / limit);

    return Response.json({
      events: events.results || [],
      total: total,
      totalPages: totalPages,
      page: page
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub events error:', error);
    return Response.json({ events: [], total: 0, totalPages: 0, page: 1 }, { headers: corsHeaders });
  }
}

async function handleHubAnalytics(request, env, corsHeaders) {
  try {
    // Total sessions
    const totalSessions = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM sessions`
    ).first();

    // Completed sessions
    const completedSessions = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM sessions WHERE completed = 1`
    ).first();

    // Total cases
    const totalCases = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL)`
    ).first();

    // Cases today
    const casesToday = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND DATE(created_at) = DATE('now')`
    ).first();

    // Cases this week
    const casesThisWeek = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND created_at > datetime('now', '-7 days')`
    ).first();

    // Cases this month
    const casesThisMonth = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND created_at > datetime('now', '-30 days')`
    ).first();

    // Pending cases
    const pendingCases = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'pending'`
    ).first();

    // In progress cases
    const inProgressCases = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'in_progress'`
    ).first();

    // Completed cases
    const completedCases = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'completed'`
    ).first();

    // Cases by type
    const casesByType = await env.ANALYTICS_DB.prepare(
      `SELECT case_type, COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) GROUP BY case_type`
    ).all();

    // Cases by status
    const casesByStatus = await env.ANALYTICS_DB.prepare(
      `SELECT status, COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) GROUP BY status`
    ).all();

    // Resolution types breakdown
    const resolutionTypes = await env.ANALYTICS_DB.prepare(
      `SELECT resolution, COUNT(*) as count, SUM(refund_amount) as total_refund FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) GROUP BY resolution ORDER BY count DESC LIMIT 10`
    ).all();

    // Total refunds
    const totalRefunds = await env.ANALYTICS_DB.prepare(
      `SELECT SUM(refund_amount) as total FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND refund_amount IS NOT NULL`
    ).first();

    // Refunds this month
    const refundsThisMonth = await env.ANALYTICS_DB.prepare(
      `SELECT SUM(refund_amount) as total FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND refund_amount IS NOT NULL AND created_at > datetime('now', '-30 days')`
    ).first();

    // Average refund amount
    const avgRefund = await env.ANALYTICS_DB.prepare(
      `SELECT AVG(refund_amount) as avg FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND refund_amount IS NOT NULL AND refund_amount > 0`
    ).first();

    // Sessions by day (last 14 days)
    const sessionsByDay = await env.ANALYTICS_DB.prepare(
      `SELECT DATE(created_at) as date, COUNT(*) as count FROM sessions WHERE created_at > datetime('now', '-14 days') GROUP BY DATE(created_at) ORDER BY date`
    ).all();

    // Cases by day (last 14 days, exclude self-resolved)
    const casesByDay = await env.ANALYTICS_DB.prepare(
      `SELECT DATE(created_at) as date, COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND created_at > datetime('now', '-14 days') GROUP BY DATE(created_at) ORDER BY date`
    ).all();

    // Refunds by day (last 14 days, exclude self-resolved)
    const refundsByDay = await env.ANALYTICS_DB.prepare(
      `SELECT DATE(created_at) as date, SUM(refund_amount) as total FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND refund_amount IS NOT NULL AND created_at > datetime('now', '-14 days') GROUP BY DATE(created_at) ORDER BY date`
    ).all();

    // Flow types breakdown (from sessions)
    const flowTypes = await env.ANALYTICS_DB.prepare(
      `SELECT flow_type, COUNT(*) as count FROM sessions WHERE flow_type IS NOT NULL GROUP BY flow_type ORDER BY count DESC`
    ).all();

    // Recent high-value refunds (exclude self-resolved)
    const highValueRefunds = await env.ANALYTICS_DB.prepare(
      `SELECT case_id, customer_email, refund_amount, resolution, created_at FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND refund_amount > 50 ORDER BY created_at DESC LIMIT 5`
    ).all();

    // Cases needing attention (pending for more than 24 hours, exclude self-resolved)
    const staleCases = await env.ANALYTICS_DB.prepare(
      `SELECT COUNT(*) as count FROM cases WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'pending' AND created_at < datetime('now', '-24 hours')`
    ).first();

    // ============================================
    // PHASE 3: ENHANCED ANALYTICS
    // ============================================

    // Resolution Time Metrics (for completed cases)
    let avgResolutionTime = { avg_hours: 0 };
    let minResolutionTime = { min_hours: 0 };
    let maxResolutionTime = { max_hours: 0 };
    try {
      avgResolutionTime = await env.ANALYTICS_DB.prepare(
        `SELECT AVG((julianday(resolved_at) - julianday(created_at)) * 24) as avg_hours
         FROM cases WHERE status = 'completed' AND resolved_at IS NOT NULL`
      ).first() || { avg_hours: 0 };

      minResolutionTime = await env.ANALYTICS_DB.prepare(
        `SELECT MIN((julianday(resolved_at) - julianday(created_at)) * 24) as min_hours
         FROM cases WHERE status = 'completed' AND resolved_at IS NOT NULL`
      ).first() || { min_hours: 0 };

      maxResolutionTime = await env.ANALYTICS_DB.prepare(
        `SELECT MAX((julianday(resolved_at) - julianday(created_at)) * 24) as max_hours
         FROM cases WHERE status = 'completed' AND resolved_at IS NOT NULL`
      ).first() || { max_hours: 0 };
    } catch (e) { console.log('Resolution time calc skipped:', e.message); }

    // SLA Compliance (completed within 24 hours)
    let slaCompliant = { count: 0 };
    let slaBreached = { count: 0 };
    try {
      slaCompliant = await env.ANALYTICS_DB.prepare(
        `SELECT COUNT(*) as count FROM cases
         WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'completed' AND resolved_at IS NOT NULL
         AND (julianday(resolved_at) - julianday(created_at)) <= 1`
      ).first() || { count: 0 };

      slaBreached = await env.ANALYTICS_DB.prepare(
        `SELECT COUNT(*) as count FROM cases
         WHERE (resolved_in_app != 1 OR resolved_in_app IS NULL) AND status = 'completed' AND resolved_at IS NOT NULL
         AND (julianday(resolved_at) - julianday(created_at)) > 1`
      ).first() || { count: 0 };
    } catch (e) { console.log('SLA calc skipped:', e.message); }

    // Team Performance (cases completed per user)
    let teamPerformance = { results: [] };
    try {
      teamPerformance = await env.ANALYTICS_DB.prepare(
        `SELECT
           COALESCE(c.resolved_by, c.assigned_to, 'Unassigned') as user_name,
           COUNT(*) as cases_completed,
           SUM(c.refund_amount) as total_refunds,
           AVG((julianday(c.resolved_at) - julianday(c.created_at)) * 24) as avg_resolution_hours
         FROM cases c
         WHERE c.status = 'completed' AND c.created_at > datetime('now', '-30 days')
         GROUP BY COALESCE(c.resolved_by, c.assigned_to, 'Unassigned')
         ORDER BY cases_completed DESC
         LIMIT 10`
      ).all();
    } catch (e) { console.log('Team performance skipped:', e.message); }

    // Root Cause Analysis (refund reasons breakdown)
    let rootCauses = { results: [] };
    try {
      rootCauses = await env.ANALYTICS_DB.prepare(
        `SELECT
           COALESCE(refund_reason, resolution, 'Unknown') as reason,
           COUNT(*) as count,
           SUM(refund_amount) as total_amount,
           AVG(refund_amount) as avg_amount
         FROM cases
         WHERE created_at > datetime('now', '-30 days')
         GROUP BY COALESCE(refund_reason, resolution, 'Unknown')
         ORDER BY count DESC
         LIMIT 15`
      ).all();
    } catch (e) { console.log('Root causes skipped:', e.message); }

    // Cases by hour of day (to identify peak times)
    let casesByHour = { results: [] };
    try {
      casesByHour = await env.ANALYTICS_DB.prepare(
        `SELECT strftime('%H', created_at) as hour, COUNT(*) as count
         FROM cases WHERE created_at > datetime('now', '-30 days')
         GROUP BY strftime('%H', created_at) ORDER BY hour`
      ).all();
    } catch (e) { console.log('Cases by hour skipped:', e.message); }

    // Resolution time distribution
    let resolutionDistribution = { results: [] };
    try {
      resolutionDistribution = await env.ANALYTICS_DB.prepare(
        `SELECT
           CASE
             WHEN (julianday(resolved_at) - julianday(created_at)) * 24 < 1 THEN '< 1 hour'
             WHEN (julianday(resolved_at) - julianday(created_at)) * 24 < 4 THEN '1-4 hours'
             WHEN (julianday(resolved_at) - julianday(created_at)) * 24 < 12 THEN '4-12 hours'
             WHEN (julianday(resolved_at) - julianday(created_at)) * 24 < 24 THEN '12-24 hours'
             ELSE '24+ hours'
           END as time_bucket,
           COUNT(*) as count
         FROM cases
         WHERE status = 'completed' AND resolved_at IS NOT NULL
         GROUP BY time_bucket
         ORDER BY
           CASE time_bucket
             WHEN '< 1 hour' THEN 1
             WHEN '1-4 hours' THEN 2
             WHEN '4-12 hours' THEN 3
             WHEN '12-24 hours' THEN 4
             ELSE 5
           END`
      ).all();
    } catch (e) { console.log('Resolution distribution skipped:', e.message); }

    return Response.json({
      totalSessions: totalSessions?.count || 0,
      completedSessions: completedSessions?.count || 0,
      completionRate: totalSessions?.count ? Math.round((completedSessions?.count || 0) / totalSessions.count * 100) : 0,
      totalCases: totalCases?.count || 0,
      casesToday: casesToday?.count || 0,
      casesThisWeek: casesThisWeek?.count || 0,
      casesThisMonth: casesThisMonth?.count || 0,
      pendingCases: pendingCases?.count || 0,
      inProgressCases: inProgressCases?.count || 0,
      completedCases: completedCases?.count || 0,
      staleCases: staleCases?.count || 0,
      casesByType: casesByType.results || [],
      casesByStatus: casesByStatus.results || [],
      resolutionTypes: resolutionTypes.results || [],
      totalRefunds: totalRefunds?.total || 0,
      refundsThisMonth: refundsThisMonth?.total || 0,
      avgRefund: avgRefund?.avg || 0,
      sessionsByDay: sessionsByDay.results || [],
      casesByDay: casesByDay.results || [],
      refundsByDay: refundsByDay.results || [],
      flowTypes: flowTypes.results || [],
      highValueRefunds: highValueRefunds.results || [],
      // Phase 3: Enhanced Analytics
      avgResolutionHours: avgResolutionTime?.avg_hours || 0,
      minResolutionHours: minResolutionTime?.min_hours || 0,
      maxResolutionHours: maxResolutionTime?.max_hours || 0,
      slaCompliant: slaCompliant?.count || 0,
      slaBreached: slaBreached?.count || 0,
      slaComplianceRate: (slaCompliant?.count || 0) + (slaBreached?.count || 0) > 0
        ? Math.round((slaCompliant?.count || 0) / ((slaCompliant?.count || 0) + (slaBreached?.count || 0)) * 100)
        : 0,
      teamPerformance: teamPerformance.results || [],
      rootCauses: rootCauses.results || [],
      casesByHour: casesByHour.results || [],
      resolutionDistribution: resolutionDistribution.results || []
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub analytics error:', error);
    return Response.json({ totalSessions: 0, completedSessions: 0, totalCases: 0 }, { headers: corsHeaders });
  }
}

// ============================================
// HUB API - DUPLICATE CASES
// ============================================

async function handleHubDuplicates(request, env, corsHeaders) {
  try {
    // Find duplicate cases based on same email AND same order number
    // Group cases by email + order_number combination
    const duplicateGroups = await env.ANALYTICS_DB.prepare(`
      SELECT 
        customer_email,
        order_number,
        COUNT(*) as duplicate_count,
        GROUP_CONCAT(case_id) as case_ids,
        GROUP_CONCAT(status) as statuses,
        GROUP_CONCAT(case_type) as case_types,
        MIN(created_at) as first_created,
        MAX(created_at) as last_created
      FROM cases
      WHERE customer_email IS NOT NULL 
        AND order_number IS NOT NULL 
        AND customer_email != ''
        AND order_number != ''
      GROUP BY LOWER(customer_email), order_number
      HAVING COUNT(*) > 1
      ORDER BY duplicate_count DESC, last_created DESC
    `).all();

    const groups = duplicateGroups.results || [];
    
    // Get detailed case info for each duplicate group
    const detailedGroups = await Promise.all(groups.map(async (group) => {
      const caseIds = group.case_ids.split(',');
      const cases = await env.ANALYTICS_DB.prepare(`
        SELECT 
          case_id,
          customer_name,
          customer_email,
          order_number,
          case_type,
          status,
          resolution,
          refund_amount,
          created_at,
          assigned_to
        FROM cases
        WHERE case_id IN (${caseIds.map(() => '?').join(',')})
        ORDER BY created_at DESC
      `).bind(...caseIds).all();

      return {
        customer_email: group.customer_email,
        order_number: group.order_number,
        duplicate_count: group.duplicate_count,
        first_created: group.first_created,
        last_created: group.last_created,
        cases: cases.results || []
      };
    }));

    // Get summary stats
    const totalDuplicateGroups = groups.length;
    const totalDuplicateCases = groups.reduce((sum, g) => sum + g.duplicate_count, 0);

    return Response.json({
      summary: {
        total_duplicate_groups: totalDuplicateGroups,
        total_duplicate_cases: totalDuplicateCases,
        unique_customers_affected: new Set(groups.map(g => g.customer_email.toLowerCase())).size
      },
      groups: detailedGroups
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub duplicates error:', error);
    return Response.json({ 
      summary: { total_duplicate_groups: 0, total_duplicate_cases: 0, unique_customers_affected: 0 },
      groups: [] 
    }, { headers: corsHeaders });
  }
}

// ============================================
// HUB API - ISSUES (TROUBLE REPORTS)
// ============================================

async function handleHubIssues(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const limit = parseInt(url.searchParams.get('limit')) || 50;
    const page = parseInt(url.searchParams.get('page')) || 1;
    const offset = (page - 1) * limit;
    const status = url.searchParams.get('status');
    const dateRange = url.searchParams.get('dateRange');
    const sortBy = url.searchParams.get('sortBy');
    const sortOrder = url.searchParams.get('sortOrder');
    const search = url.searchParams.get('search');

    // Determine which table to use
    let tableName = 'issue_reports';
    let tableExists = true;
    try {
      await env.ANALYTICS_DB.prepare(`SELECT 1 FROM ${tableName} LIMIT 1`).first();
    } catch {
      tableName = 'trouble_reports';
      try {
        await env.ANALYTICS_DB.prepare(`SELECT 1 FROM ${tableName} LIMIT 1`).first();
      } catch {
        tableExists = false;
      }
    }

    if (!tableExists) {
      return Response.json({ issues: [], total: 0, totalPages: 0, page: 1 }, { headers: corsHeaders });
    }

    let query = `SELECT * FROM ${tableName}`;
    let countQuery = `SELECT COUNT(*) as total FROM ${tableName}`;
    const conditions = [];
    const params = [];

    if (status) {
      conditions.push(`status = ?`);
      params.push(status);
    }

    if (dateRange) {
      const now = new Date();
      let startDate;
      if (dateRange === 'today') {
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate());
      } else if (dateRange === 'last_7_days' || dateRange === '7d') {
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 7);
      } else if (dateRange === 'last_30_days' || dateRange === '30d') {
        startDate = new Date(now.getFullYear(), now.getMonth(), now.getDate() - 30);
      }
      if (startDate) {
        conditions.push(`created_at >= ?`);
        params.push(startDate.toISOString());
      }
    }

    if (search) {
      conditions.push(`(report_id LIKE ? OR customer_email LIKE ? OR name LIKE ? OR description LIKE ? OR issue_type LIKE ?)`);
      const searchTerm = `%${search}%`;
      params.push(searchTerm, searchTerm, searchTerm, searchTerm, searchTerm);
    }

    if (conditions.length > 0) {
      const whereClause = ` WHERE ` + conditions.join(' AND ');
      query += whereClause;
      countQuery += whereClause;
    }

    // Sorting
    let orderBy = 'created_at DESC';
    if (sortBy) {
      const allowedSortFields = ['created_at', 'status', 'customer_email', 'name', 'issue_type'];
      if (allowedSortFields.includes(sortBy)) {
        orderBy = `${sortBy} ${sortOrder === 'asc' ? 'ASC' : 'DESC'}`;
      }
    }
    query += ` ORDER BY ${orderBy} LIMIT ? OFFSET ?`;

    // Get total count first
    const countStmt = env.ANALYTICS_DB.prepare(countQuery);
    const countResult = await countStmt.bind(...params).first();
    const total = countResult?.total || 0;
    const totalPages = Math.ceil(total / limit);

    // Get issues
    const stmt = env.ANALYTICS_DB.prepare(query);
    const queryParams = [...params, limit, offset];
    const result = await stmt.bind(...queryParams).all();

    return Response.json({ 
      issues: result.results || [],
      total: total,
      totalPages: totalPages,
      page: page
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub issues error:', error);
    return Response.json({ issues: [], total: 0, totalPages: 0, page: 1 }, { headers: corsHeaders });
  }
}

async function handleHubIssueDetail(reportId, env, corsHeaders) {
  try {
    // Try issue_reports first, fallback to trouble_reports for backwards compatibility
    let result = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM issue_reports WHERE report_id = ?
    `).bind(reportId).first();

    if (!result) {
      result = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM trouble_reports WHERE report_id = ?
    `).bind(reportId).first();
    }

    if (!result) {
      return Response.json({ error: 'Issue not found' }, { status: 404, headers: corsHeaders });
    }

    return Response.json(result, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub issue detail error:', error);
    return Response.json({ error: 'Failed to load issue' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubIssueStatusUpdate(reportId, request, env, corsHeaders) {
  try {
    const { status } = await request.json();

    // Try issue_reports first, fallback to trouble_reports for backwards compatibility
    try {
      await env.ANALYTICS_DB.prepare(`
        UPDATE issue_reports SET status = ? WHERE report_id = ?
      `).bind(status, reportId).run();
    } catch (e) {
    await env.ANALYTICS_DB.prepare(`
      UPDATE trouble_reports SET status = ? WHERE report_id = ?
    `).bind(status, reportId).run();
    }

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub issue status update error:', error);
    return Response.json({ error: 'Failed to update status' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// HUB API - TOKEN VERIFICATION HELPER
// ============================================

async function verifyHubToken(token, env) {
  if (!token) return null;
  
  try {
    const payload = await verifyToken(token);
    if (!payload) return null;

    // Get user details from database
    const user = await env.ANALYTICS_DB.prepare(`
      SELECT id, username, name, role, is_active FROM admin_users WHERE username = ?
    `).bind(payload.username).first();

    if (!user || !user.is_active) return null;
    
    return user;
  } catch (e) {
    console.error('Token verification error:', e);
    return null;
  }
}

// ============================================
// HUB API - SOP LINKS CRUD
// ============================================

async function handleHubSOPList(request, env, corsHeaders) {
  // Check admin permission
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const category = url.searchParams.get('category');

    let query = 'SELECT * FROM sop_links WHERE is_active = 1';
    const params = [];

    if (category) {
      query += ' AND case_type = ?';
      params.push(category);
    }

    query += ' ORDER BY case_type, scenario_name';

    const result = await env.ANALYTICS_DB.prepare(query).bind(...params).all();

    return Response.json({ 
      sops: result.results || [],
      total: result.results?.length || 0
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub SOP list error:', error);
    return Response.json({ error: 'Failed to load SOPs' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubSOPGet(sopId, env, corsHeaders) {
  try {
    const sop = await env.ANALYTICS_DB.prepare(
      'SELECT * FROM sop_links WHERE id = ?'
    ).bind(sopId).first();

    if (!sop) {
      return Response.json({ error: 'SOP not found' }, { status: 404, headers: corsHeaders });
    }

    return Response.json({ sop }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub SOP get error:', error);
    return Response.json({ error: 'Failed to load SOP' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubSOPCreate(request, env, corsHeaders) {
  try {
    // Verify admin role from token
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user || user.role !== 'admin') {
      return Response.json({ error: 'Admin access required' }, { status: 403, headers: corsHeaders });
    }

    const { scenario_key, scenario_name, case_type, sop_url, description } = await request.json();

    if (!scenario_key || !scenario_name || !case_type || !sop_url) {
      return Response.json({ error: 'Missing required fields' }, { status: 400, headers: corsHeaders });
    }

    const result = await env.ANALYTICS_DB.prepare(`
      INSERT INTO sop_links (scenario_key, scenario_name, case_type, sop_url, description, created_by, is_active)
      VALUES (?, ?, ?, ?, ?, ?, 1)
    `).bind(scenario_key, scenario_name, case_type, sop_url, description || '', user.id).run();

    return Response.json({ 
      success: true, 
      id: result.meta.last_row_id 
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub SOP create error:', error);
    if (error.message?.includes('UNIQUE constraint')) {
      return Response.json({ error: 'SOP with this key already exists' }, { status: 400, headers: corsHeaders });
    }
    return Response.json({ error: 'Failed to create SOP' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubSOPUpdate(sopId, request, env, corsHeaders) {
  try {
    // Verify admin role
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user || user.role !== 'admin') {
      return Response.json({ error: 'Admin access required' }, { status: 403, headers: corsHeaders });
    }

    const { scenario_name, case_type, sop_url, description, is_active } = await request.json();

    await env.ANALYTICS_DB.prepare(`
      UPDATE sop_links 
      SET scenario_name = COALESCE(?, scenario_name),
          case_type = COALESCE(?, case_type),
          sop_url = COALESCE(?, sop_url),
          description = COALESCE(?, description),
          is_active = COALESCE(?, is_active),
          updated_by = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      scenario_name || null, 
      case_type || null, 
      sop_url || null, 
      description || null,
      is_active !== undefined ? (is_active ? 1 : 0) : null,
      user.id,
      sopId
    ).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub SOP update error:', error);
    return Response.json({ error: 'Failed to update SOP' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubSOPDelete(sopId, request, env, corsHeaders) {
  try {
    // Verify admin role
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user || user.role !== 'admin') {
      return Response.json({ error: 'Admin access required' }, { status: 403, headers: corsHeaders });
    }

    // Soft delete by setting is_active = 0
    await env.ANALYTICS_DB.prepare(`
      UPDATE sop_links SET is_active = 0, updated_by = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(user.id, sopId).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub SOP delete error:', error);
    return Response.json({ error: 'Failed to delete SOP' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// HUB API - EMAIL TEMPLATES CRUD
// ============================================

async function handleHubEmailTemplatesList(request, env, corsHeaders) {
  // Check admin permission
  const auth = await verifyAdmin(request, env);
  if (auth.error) {
    return Response.json({ error: auth.error }, { status: auth.status, headers: corsHeaders });
  }

  try {
    const url = new URL(request.url);
    const category = url.searchParams.get('category');

    let query = 'SELECT * FROM email_templates WHERE is_active = 1';
    const params = [];

    if (category) {
      query += ' AND category = ?';
      params.push(category);
    }

    query += ' ORDER BY category, template_name';

    const result = await env.ANALYTICS_DB.prepare(query).bind(...params).all();

    // Parse variables JSON for each template
    const templates = (result.results || []).map(t => ({
      ...t,
      variables: t.variables ? JSON.parse(t.variables) : []
    }));

    return Response.json({ 
      templates,
      total: templates.length
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub email templates list error:', error);
    return Response.json({ error: 'Failed to load email templates' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubEmailTemplateGet(templateId, env, corsHeaders) {
  try {
    const template = await env.ANALYTICS_DB.prepare(
      'SELECT * FROM email_templates WHERE id = ?'
    ).bind(templateId).first();

    if (!template) {
      return Response.json({ error: 'Template not found' }, { status: 404, headers: corsHeaders });
    }

    // Parse variables JSON
    template.variables = template.variables ? JSON.parse(template.variables) : [];

    return Response.json({ template }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub email template get error:', error);
    return Response.json({ error: 'Failed to load template' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubEmailTemplateCreate(request, env, corsHeaders) {
  try {
    // Verify admin role
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user || user.role !== 'admin') {
      return Response.json({ error: 'Admin access required' }, { status: 403, headers: corsHeaders });
    }

    const { template_key, template_name, category, subject, body, variables, description } = await request.json();

    if (!template_key || !template_name || !category || !subject || !body) {
      return Response.json({ error: 'Missing required fields' }, { status: 400, headers: corsHeaders });
    }

    const result = await env.ANALYTICS_DB.prepare(`
      INSERT INTO email_templates (template_key, template_name, category, subject, body, variables, description, created_by, is_active)
      VALUES (?, ?, ?, ?, ?, ?, ?, ?, 1)
    `).bind(
      template_key, 
      template_name, 
      category, 
      subject, 
      body, 
      JSON.stringify(variables || []),
      description || '',
      user.id
    ).run();

    return Response.json({ 
      success: true, 
      id: result.meta.last_row_id 
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub email template create error:', error);
    if (error.message?.includes('UNIQUE constraint')) {
      return Response.json({ error: 'Template with this key already exists' }, { status: 400, headers: corsHeaders });
    }
    return Response.json({ error: 'Failed to create template' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubEmailTemplateUpdate(templateId, request, env, corsHeaders) {
  try {
    // Verify admin role
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user || user.role !== 'admin') {
      return Response.json({ error: 'Admin access required' }, { status: 403, headers: corsHeaders });
    }

    const { template_name, category, subject, body, variables, description, is_active } = await request.json();

    await env.ANALYTICS_DB.prepare(`
      UPDATE email_templates 
      SET template_name = COALESCE(?, template_name),
          category = COALESCE(?, category),
          subject = COALESCE(?, subject),
          body = COALESCE(?, body),
          variables = COALESCE(?, variables),
          description = COALESCE(?, description),
          is_active = COALESCE(?, is_active),
          updated_by = ?,
          updated_at = CURRENT_TIMESTAMP
      WHERE id = ?
    `).bind(
      template_name || null,
      category || null,
      subject || null,
      body || null,
      variables ? JSON.stringify(variables) : null,
      description || null,
      is_active !== undefined ? (is_active ? 1 : 0) : null,
      user.id,
      templateId
    ).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub email template update error:', error);
    return Response.json({ error: 'Failed to update template' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubEmailTemplateDelete(templateId, request, env, corsHeaders) {
  try {
    // Verify admin role
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user || user.role !== 'admin') {
      return Response.json({ error: 'Admin access required' }, { status: 403, headers: corsHeaders });
    }

    // Soft delete
    await env.ANALYTICS_DB.prepare(`
      UPDATE email_templates SET is_active = 0, updated_by = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(user.id, templateId).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub email template delete error:', error);
    return Response.json({ error: 'Failed to delete template' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubEmailTemplateRender(templateId, request, env, corsHeaders) {
  try {
    const { case_id } = await request.json();

    // Get template
    const template = await env.ANALYTICS_DB.prepare(
      'SELECT * FROM email_templates WHERE id = ?'
    ).bind(templateId).first();

    if (!template) {
      return Response.json({ error: 'Template not found' }, { status: 404, headers: corsHeaders });
    }

    // Get case data for variable substitution
    const caseData = await env.ANALYTICS_DB.prepare(
      'SELECT * FROM cases WHERE case_id = ?'
    ).bind(case_id).first();

    if (!caseData) {
      return Response.json({ error: 'Case not found' }, { status: 404, headers: corsHeaders });
    }

    // Parse selected_items if present
    let selectedItems = [];
    if (caseData.selected_items) {
      try { selectedItems = JSON.parse(caseData.selected_items); } catch (e) {}
    }

    // Build variable map
    const variables = {
      customer_name: caseData.customer_name || '',
      first_name: caseData.customer_name?.split(' ')[0] || '',
      order_number: caseData.order_number || '',
      refund_amount: caseData.refund_amount ? `$${parseFloat(caseData.refund_amount).toFixed(2)}` : '',
      refund_percent: caseData.refund_percent ? `${caseData.refund_percent}%` : '',
      product_name: selectedItems[0]?.title || 'your product',
      tracking_number: caseData.tracking_number || '',
      case_id: caseData.case_id || '',
      pause_resume_date: caseData.extra_data?.pauseResumeDate || '',
    };

    // Replace variables in subject and body
    let renderedSubject = template.subject;
    let renderedBody = template.body;

    for (const [key, value] of Object.entries(variables)) {
      const regex = new RegExp(`\\{\\{${key}\\}\\}`, 'g');
      renderedSubject = renderedSubject.replace(regex, value);
      renderedBody = renderedBody.replace(regex, value);
    }

    return Response.json({ 
      subject: renderedSubject,
      body: renderedBody,
      template_name: template.template_name
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub email template render error:', error);
    return Response.json({ error: 'Failed to render template' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// HUB API - SAVED VIEWS CRUD
// ============================================

async function handleHubSavedViewsList(request, env, corsHeaders) {
  try {
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
    }

    // Get user's own views + global views
    const result = await env.ANALYTICS_DB.prepare(`
      SELECT * FROM saved_views 
      WHERE user_id = ? OR is_global = 1
      ORDER BY is_global DESC, use_count DESC, created_at DESC
    `).bind(user.username || user.id).all();

    const views = (result.results || []).map(v => ({
      ...v,
      filters: v.filters ? JSON.parse(v.filters) : {},
      is_own: v.user_id === (user.username || user.id)
    }));

    return Response.json({ views }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub saved views list error:', error);
    return Response.json({ views: [] }, { headers: corsHeaders });
  }
}

async function handleHubSavedViewCreate(request, env, corsHeaders) {
  try {
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
    }

    const { name, filters, is_global } = await request.json();

    if (!name || !filters) {
      return Response.json({ error: 'Name and filters are required' }, { status: 400, headers: corsHeaders });
    }

    // Only admins can create global views
    const makeGlobal = is_global && user.role === 'admin';

    const result = await env.ANALYTICS_DB.prepare(`
      INSERT INTO saved_views (name, filters, user_id, is_global, created_by)
      VALUES (?, ?, ?, ?, ?)
    `).bind(
      name,
      JSON.stringify(filters),
      makeGlobal ? null : (user.username || user.id),
      makeGlobal ? 1 : 0,
      user.name || user.username || 'Unknown'
    ).run();

    return Response.json({ 
      success: true, 
      view: {
        id: result.meta?.last_row_id,
        name,
        filters,
        is_global: makeGlobal,
        created_by: user.name || user.username
      }
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub saved view create error:', error);
    return Response.json({ error: 'Failed to create view' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubSavedViewUpdate(viewId, request, env, corsHeaders) {
  try {
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
    }

    const { name, filters } = await request.json();

    // Check ownership (only owner or admin can edit)
    const existing = await env.ANALYTICS_DB.prepare(
      'SELECT * FROM saved_views WHERE id = ?'
    ).bind(viewId).first();

    if (!existing) {
      return Response.json({ error: 'View not found' }, { status: 404, headers: corsHeaders });
    }

    const isOwner = existing.user_id === (user.username || user.id);
    const isAdmin = user.role === 'admin';

    if (!isOwner && !isAdmin) {
      return Response.json({ error: 'Permission denied' }, { status: 403, headers: corsHeaders });
    }

    await env.ANALYTICS_DB.prepare(`
      UPDATE saved_views SET name = ?, filters = ?, updated_at = CURRENT_TIMESTAMP WHERE id = ?
    `).bind(name, JSON.stringify(filters), viewId).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub saved view update error:', error);
    return Response.json({ error: 'Failed to update view' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubSavedViewDelete(viewId, request, env, corsHeaders) {
  try {
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
    }

    // Check ownership
    const existing = await env.ANALYTICS_DB.prepare(
      'SELECT * FROM saved_views WHERE id = ?'
    ).bind(viewId).first();

    if (!existing) {
      return Response.json({ error: 'View not found' }, { status: 404, headers: corsHeaders });
    }

    const isOwner = existing.user_id === (user.username || user.id);
    const isAdmin = user.role === 'admin';

    if (!isOwner && !isAdmin) {
      return Response.json({ error: 'Permission denied' }, { status: 403, headers: corsHeaders });
    }

    await env.ANALYTICS_DB.prepare('DELETE FROM saved_views WHERE id = ?').bind(viewId).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub saved view delete error:', error);
    return Response.json({ error: 'Failed to delete view' }, { status: 500, headers: corsHeaders });
  }
}

async function handleHubSavedViewUse(viewId, env, corsHeaders) {
  try {
    // Increment use count for analytics
    await env.ANALYTICS_DB.prepare(`
      UPDATE saved_views SET use_count = use_count + 1 WHERE id = ?
    `).bind(viewId).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub saved view use error:', error);
    return Response.json({ error: 'Failed to track usage' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// HUB API - FLOW POSITIONS
// ============================================

async function handleFlowPositionsGet(flowId, env, corsHeaders) {
  try {
    if (!env.ANALYTICS_DB) {
      return jsonResponse({ positions: null }, corsHeaders);
    }

    const result = await env.ANALYTICS_DB.prepare(`
      SELECT positions FROM flow_positions WHERE flow_id = ?
    `).bind(flowId).first();

    if (result && result.positions) {
      return jsonResponse({ 
        success: true, 
        positions: JSON.parse(result.positions) 
      }, corsHeaders);
    }

    return jsonResponse({ success: true, positions: null }, corsHeaders);
  } catch (e) {
    console.error('Failed to get flow positions:', e);
    return errorResponse('Failed to load positions', corsHeaders, 500);
  }
}

async function handleFlowPositionsSave(flowId, request, env, corsHeaders) {
  try {
    if (!env.ANALYTICS_DB) {
      return errorResponse('Database not available', corsHeaders, 503);
    }

    const data = await request.json();
    const positions = data.positions || {};
    const user = data.user || 'unknown';

    // Upsert: insert or update
    await env.ANALYTICS_DB.prepare(`
      INSERT INTO flow_positions (flow_id, positions, updated_by, updated_at)
      VALUES (?, ?, ?, datetime('now'))
      ON CONFLICT(flow_id) DO UPDATE SET
        positions = excluded.positions,
        updated_by = excluded.updated_by,
        updated_at = datetime('now')
    `).bind(flowId, JSON.stringify(positions), user).run();

    return jsonResponse({ success: true }, corsHeaders);
  } catch (e) {
    console.error('Failed to save flow positions:', e);
    return errorResponse('Failed to save positions', corsHeaders, 500);
  }
}

async function handleFlowPositionsReset(flowId, env, corsHeaders) {
  try {
    if (!env.ANALYTICS_DB) {
      return errorResponse('Database not available', corsHeaders, 503);
    }

    await env.ANALYTICS_DB.prepare(`
      DELETE FROM flow_positions WHERE flow_id = ?
    `).bind(flowId).run();

    return jsonResponse({ success: true }, corsHeaders);
  } catch (e) {
    console.error('Failed to reset flow positions:', e);
    return errorResponse('Failed to reset positions', corsHeaders, 500);
  }
}

// ============================================
// HUB API - ACTIVITY LOGGING
// ============================================

async function handleHubActivityLog(request, env, corsHeaders) {
  try {
    const authHeader = request.headers.get('Authorization');
    const token = authHeader?.replace('Bearer ', '');
    const user = await verifyHubToken(token, env);

    if (!user) {
      return Response.json({ error: 'Unauthorized' }, { status: 401, headers: corsHeaders });
    }

    const { case_id, activity_type, details } = await request.json();

    if (!case_id || !activity_type) {
      return Response.json({ error: 'Missing case_id or activity_type' }, { status: 400, headers: corsHeaders });
    }

    // Log to case_activity table
    await env.ANALYTICS_DB.prepare(`
      INSERT INTO case_activity (case_id, activity_type, field_name, old_value, new_value, actor, actor_email, source)
      VALUES (?, ?, ?, ?, ?, ?, ?, 'hub')
    `).bind(
      case_id,
      activity_type,
      details?.field_name || null,
      details?.old_value || null,
      details?.new_value ? JSON.stringify(details.new_value) : null,
      user.name || 'Team Member',
      user.username || ''
    ).run();

    // Also log to audit_log for comprehensive tracking
    await env.ANALYTICS_DB.prepare(`
      INSERT INTO audit_log (user_id, user_email, user_name, action_type, action_category, resource_type, resource_id, details)
      VALUES (?, ?, ?, ?, 'cases', 'case', ?, ?)
    `).bind(
      user.id,
      user.username || '',
      user.name || '',
      activity_type,
      case_id,
      JSON.stringify(details || {})
    ).run();

    return Response.json({ success: true }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub activity log error:', error);
    return Response.json({ error: 'Failed to log activity' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// HUB API - UNIFIED SEARCH
// ============================================

async function handleHubUnifiedSearch(request, env, corsHeaders) {
  try {
    const url = new URL(request.url);
    const query = url.searchParams.get('q')?.trim();
    const limit = parseInt(url.searchParams.get('limit') || '5');

    if (!query || query.length < 2) {
      return Response.json({ 
        cases: [], 
        sessions: [], 
        issues: [] 
      }, { headers: corsHeaders });
    }

    const searchPattern = `%${query}%`;

    // Search cases - include resolution and case_type in search
    const casesResult = await env.ANALYTICS_DB.prepare(`
      SELECT case_id, case_type, status, customer_name, customer_email, order_number, resolution, created_at
      FROM cases
      WHERE customer_email LIKE ? 
         OR customer_name LIKE ? 
         OR order_number LIKE ? 
         OR case_id LIKE ?
         OR resolution LIKE ?
         OR case_type LIKE ?
      ORDER BY created_at DESC
      LIMIT ?
    `).bind(searchPattern, searchPattern, searchPattern, searchPattern, searchPattern, searchPattern, limit).all();

    // Search sessions
    let sessionsResult = { results: [] };
    try {
      sessionsResult = await env.ANALYTICS_DB.prepare(`
        SELECT session_id, customer_email, customer_name, flow_type, outcome, session_replay_url, started_at
        FROM sessions
        WHERE customer_email LIKE ? OR customer_name LIKE ? OR flow_type LIKE ? OR outcome LIKE ?
        ORDER BY started_at DESC
        LIMIT ?
      `).bind(searchPattern, searchPattern, searchPattern, searchPattern, limit).all();
    } catch (e) {
      console.error('Sessions search error:', e);
    }

    // Search issues (trouble reports)
    let issuesResult = { results: [] };
    try {
      issuesResult = await env.ANALYTICS_DB.prepare(`
        SELECT report_id, customer_email, issue_type, status, created_at
        FROM issue_reports
        WHERE customer_email LIKE ? OR report_id LIKE ?
        ORDER BY created_at DESC
        LIMIT ?
      `).bind(searchPattern, searchPattern, limit).all();
    } catch (e) {
      // Try trouble_reports as fallback
      try {
        issuesResult = await env.ANALYTICS_DB.prepare(`
          SELECT report_id, customer_email, issue_type, status, created_at
          FROM trouble_reports
          WHERE customer_email LIKE ? OR report_id LIKE ?
          ORDER BY created_at DESC
          LIMIT ?
        `).bind(searchPattern, searchPattern, limit).all();
      } catch (e2) {
        // Table doesn't exist, that's ok
      }
    }

    return Response.json({
      cases: casesResult.results || [],
      sessions: sessionsResult.results || [],
      issues: issuesResult.results || []
    }, { headers: corsHeaders });
  } catch (error) {
    console.error('Hub unified search error:', error);
    return Response.json({ error: 'Search failed' }, { status: 500, headers: corsHeaders });
  }
}

// ============================================
// RESOLUTION HUB HTML
// ============================================
function getResolutionHubHTML() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Resolution Hub | PuppyPad</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Poppins:wght@600;700&display=swap" rel="stylesheet">
  <!-- Satoshi and Space Grotesk fonts for brand aesthetics -->
  <link href="https://fonts.googleapis.com/css2?family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
  <!-- Mermaid.js for flow diagrams -->
  <script src="https://cdn.jsdelivr.net/npm/mermaid@10/dist/mermaid.min.js"></script>
  <!-- React 18 + React Flow for Flow Docs -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <!-- React Flow v11 (has proper UMD bundle) -->
  <script src="https://unpkg.com/reactflow@11.10.4/dist/umd/index.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.4/dist/style.css">
  <script>
    document.addEventListener('DOMContentLoaded', function() {
      mermaid.initialize({
        startOnLoad: false,
        theme: 'base',
        themeVariables: {
          primaryColor: '#A8D8EA',
          primaryTextColor: '#1a365d',
          primaryBorderColor: '#1a365d',
          lineColor: '#94a3b8',
          secondaryColor: '#FFB7C5',
          tertiaryColor: '#E8D5E8',
          fontFamily: 'Inter, sans-serif',
          fontSize: '12px'
        },
        flowchart: {
          curve: 'basis',
          padding: 12,
          nodeSpacing: 30,
          rankSpacing: 35,
          htmlLabels: true,
          useMaxWidth: true
        }
      });
    });
  </script>
  <!-- Hub Styles -->
  <link href="/hub/hub-styles.css" rel="stylesheet">
  <style>
    :root {
      --brand-navy: #1a365d;
      --brand-navy-light: #2c5282;
      --accent-teal: #4fd1c5;
      --accent-coral: #f56565;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-400: #9ca3af;
      --gray-500: #6b7280;
      --gray-600: #4b5563;
      --gray-700: #374151;
      --gray-800: #1f2937;
      --gray-900: #111827;
      --success: #10b981;
      --warning: #f59e0b;
      --error: #ef4444;
      --info: #3b82f6;
      --sidebar-width: 240px;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: 'Satoshi', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
      background: linear-gradient(135deg, #FFF8E7 0%, #FFF5F5 50%, #F0F7FF 100%);
      background-attachment: fixed;
      color: var(--gray-800);
      min-height: 100vh;
    }

    /* Login Screen */
    #loginScreen {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: linear-gradient(135deg, #FFF8E7 0%, #FFF5F5 50%, #F0F7FF 100%);
      z-index: 1000;
      align-items: center;
      justify-content: center;
    }

    .login-container {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 24px;
      padding: 48px;
      box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 
                  0 0 0 1px rgba(255, 255, 255, 0.6),
                  inset 0 1px 0 rgba(255, 255, 255, 0.5);
      width: 100%;
      max-width: 420px;
      animation: slideUpCard 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
      position: relative;
      z-index: 10;
    }
    
    @keyframes slideUpCard {
      from {
        opacity: 0;
        transform: translateY(24px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .login-header {
      text-align: center;
      margin-bottom: 32px;
    }

    .login-header img {
      height: 40px;
      margin-bottom: 16px;
    }

    .login-header h1 {
      font-family: 'Space Grotesk', 'Poppins', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
      margin-bottom: 8px;
    }

    .login-header p {
      color: var(--gray-500);
      font-size: 14px;
    }

    .login-form {
      display: flex;
      flex-direction: column;
      gap: 20px;
    }

    .form-group {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .form-group label {
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-700);
    }

    .form-group input {
      padding: 12px 16px;
      border: 1px solid var(--gray-200);
      border-radius: 8px;
      font-size: 14px;
      transition: all 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--brand-navy);
      box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
    }

    .login-error {
      display: none;
      padding: 12px;
      background: #fee2e2;
      color: #dc2626;
      border-radius: 8px;
      font-size: 14px;
      text-align: center;
    }

    .login-btn {
      width: 100%;
      padding: 14px;
      background: var(--brand-navy);
      color: white;
      border: none;
      border-radius: 8px;
      font-size: 16px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s;
    }

    .login-btn:hover:not(:disabled) {
      background: var(--brand-navy-light);
    }

    .login-btn:active:not(:disabled) {
      transform: scale(0.98);
    }

    .login-btn:disabled {
      opacity: 0.6;
      cursor: not-allowed;
      background: var(--brand-navy);
    }

    /* Layout */
    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* Sidebar */
    .sidebar {
      width: var(--sidebar-width);
      background: #0f172a;
      color: white;
      position: fixed;
      top: 0;
      left: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      z-index: 100;
    }

    .sidebar-header {
      padding: 20px 16px;
      border-bottom: 1px solid rgba(255,255,255,0.1);
    }

    .sidebar-logo {
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .sidebar-logo img {
      height: 24px;
      filter: brightness(0) invert(1);
    }

    .sidebar-logo span {
      font-family: 'Space Grotesk', 'Poppins', sans-serif;
      font-size: 15px;
      font-weight: 600;
    }

    .sidebar-nav {
      flex: 1;
      padding: 16px 0;
      overflow-y: auto;
      /* Modern styled scrollbar */
      scrollbar-width: thin;
      scrollbar-color: rgba(255, 255, 255, 0.15) transparent;
    }

    /* Webkit scrollbar styling for sidebar */
    .sidebar-nav::-webkit-scrollbar {
      width: 6px;
    }

    .sidebar-nav::-webkit-scrollbar-track {
      background: transparent;
      margin: 8px 0;
    }

    .sidebar-nav::-webkit-scrollbar-thumb {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.2) 0%, rgba(255, 255, 255, 0.1) 100%);
      border-radius: 10px;
      border: 1px solid rgba(255, 255, 255, 0.05);
    }

    .sidebar-nav::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(180deg, rgba(255, 255, 255, 0.3) 0%, rgba(255, 255, 255, 0.15) 100%);
    }

    .sidebar-nav::-webkit-scrollbar-corner {
      background: transparent;
    }

    .nav-section {
      margin-bottom: 24px;
    }

    .nav-section-title {
      padding: 8px 16px;
      margin-bottom: 8px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.05em;
      color: #64748b;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 10px;
      padding: 10px 16px;
      color: #94a3b8;
      text-decoration: none;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      width: 100%;
      border: none;
      background: none;
    }

    .nav-item:hover {
      background: #1e293b;
      color: #e2e8f0;
    }

    .nav-item.active {
      background: #1a365d;
      color: white;
    }

    .nav-item svg {
      width: 18px;
      height: 18px;
      flex-shrink: 0;
      opacity: 0.7;
    }

    .nav-item.active svg {
      opacity: 1;
    }

    .nav-item .badge {
      margin-left: auto;
      background: #2c5282;
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 20px;
      text-align: center;
    }

    .nav-item.active .badge {
      background: rgba(255,255,255,0.2);
      color: white;
    }

    .nav-item .badge.urgent {
      background: #ef4444;
      color: white;
    }

    .sidebar-footer {
      padding: 16px;
      border-top: 1px solid rgba(255,255,255,0.1);
    }

    .user-info {
      display: flex;
      align-items: center;
      gap: 10px;
      margin-bottom: 12px;
    }

    .user-avatar {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      background: #2c5282;
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
      color: white;
      flex-shrink: 0;
    }

    .user-details {
      flex: 1;
      min-width: 0;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
      color: white;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    .user-role {
      font-size: 12px;
      color: #94a3b8;
    }

    /* Main Content */
    .main-content {
      flex: 1;
      margin-left: var(--sidebar-width);
      display: flex;
      flex-direction: column;
      position: relative;
      z-index: 2;
    }

    /* Top Header */
    .top-header {
      background: white;
      padding: 16px 32px;
      border-bottom: 1px solid var(--gray-200);
      display: flex;
      justify-content: space-between;
      align-items: center;
      position: sticky;
      top: 0;
      z-index: 50;
    }

    .page-title {
      font-family: 'Space Grotesk', 'Poppins', sans-serif;
      font-size: 28px;
      font-weight: 700;
      color: var(--gray-900);
    }

    .header-actions {
      display: flex;
      align-items: center;
      gap: 16px;
    }

    .search-box {
      display: flex;
      align-items: center;
      background: white;
      border: 1px solid var(--gray-200);
      border-radius: 12px;
      padding: 10px 16px;
      gap: 8px;
      min-width: 280px;
    }

    .search-box input {
      border: none;
      background: none;
      outline: none;
      font-size: 14px;
      width: 100%;
    }

    .search-box svg {
      width: 18px;
      height: 18px;
      color: var(--gray-400);
      stroke-width: 2;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      cursor: pointer;
      transition: all 0.2s;
      border: none;
    }

    .btn-primary {
      background: var(--brand-navy);
      color: white;
    }

    .btn-primary:hover {
      background: var(--brand-navy-light);
    }

    .btn-secondary {
      background: white;
      color: var(--gray-700);
      border: 1px solid var(--gray-200);
    }

    .btn-secondary:hover {
      background: var(--gray-50);
    }

    /* Page Content with Animated Gradient Background */
    .page-content {
      flex: 1;
      padding: 32px;
      position: relative;
      z-index: 2;
      min-height: calc(100vh - 80px);
      /* Background is now provided by animated gradient orbs */
    }

    .page-content > * {
      position: relative;
      z-index: 1;
    }

    .logout-btn:hover {
      background: #1e293b;
      color: white;
      border-color: rgba(255,255,255,0.25);
    }

    /* Stats Grid */
    .stats-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 28px;
    }

    .stat-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 16px;
      padding: 20px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04), 0 0 0 1px rgba(255, 255, 255, 0.5);
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation: slideUpCard 0.4s ease-out backwards;
    }

    .stat-card:nth-child(1) { animation-delay: 0.05s; }
    .stat-card:nth-child(2) { animation-delay: 0.1s; }
    .stat-card:nth-child(3) { animation-delay: 0.15s; }
    .stat-card:nth-child(4) { animation-delay: 0.2s; }

    @keyframes slideUpCard {
      from {
        opacity: 0;
        transform: translateY(24px) scale(0.98);
      }
      to {
        opacity: 1;
        transform: translateY(0) scale(1);
      }
    }

    .stat-card:hover {
      box-shadow: 0 20px 40px rgba(26, 54, 93, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.8);
      transform: translateY(-4px);
    }

    .stat-card.highlight {
      background: linear-gradient(135deg, var(--brand-navy) 0%, var(--brand-navy-light) 100%);
      color: white;
      border: none;
      box-shadow: 0 8px 24px rgba(26, 54, 93, 0.25);
    }

    .stat-card.highlight:hover {
      box-shadow: 0 12px 32px rgba(26, 54, 93, 0.3);
      transform: translateY(-2px);
    }

    .stat-label {
      font-size: 13px;
      font-weight: 600;
      letter-spacing: 0.02em;
      color: var(--gray-500);
      margin-bottom: 8px;
    }

    .stat-card.highlight .stat-label {
      color: rgba(255, 255, 255, 0.9);
    }

    .stat-value {
      font-family: 'Space Grotesk', 'Poppins', sans-serif;
      font-size: 32px;
      font-weight: 700;
      margin-bottom: 4px;
      color: var(--gray-900);
    }

    .stat-card.highlight .stat-value {
      color: white;
    }

    .stat-change {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      margin-top: 4px;
      font-weight: 500;
      color: var(--gray-500);
    }

    .stat-card.highlight .stat-change {
      color: rgba(255, 255, 255, 0.8);
    }

    .stat-change.up {
      color: var(--warning-600);
    }

    .stat-change.down {
      background: rgba(239, 68, 68, 0.1);
      color: var(--error);
    }

    /* Case Category Tabs */
    .category-tabs {
      display: flex;
      gap: 8px;
      margin-bottom: 24px;
      background: white;
      padding: 8px;
      border-radius: 12px;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }

    .category-tab {
      padding: 10px 20px;
      border-radius: 8px;
      font-size: 14px;
      font-weight: 500;
      color: var(--gray-600);
      cursor: pointer;
      transition: all 0.2s;
      border: none;
      background: none;
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .category-tab:hover {
      background: var(--gray-100);
    }

    .category-tab.active {
      background: var(--brand-navy);
      color: white;
    }

    .category-tab .count {
      background: var(--gray-200);
      padding: 2px 8px;
      border-radius: 10px;
      font-size: 12px;
    }

    .category-tab.active .count {
      background: rgba(255,255,255,0.2);
    }

    /* Cases Table - Beautiful Redesign */
    .cases-card {
      background: rgba(255, 255, 255, 0.92);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 20px;
      border: 1px solid rgba(255, 255, 255, 0.6);
      box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(255, 255, 255, 0.5);
      overflow: hidden;
      transition: all 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
      animation: slideUpCard 0.5s ease-out backwards;
      animation-delay: 0.1s;
    }

    .cases-card:hover {
      box-shadow: 0 20px 40px rgba(26, 54, 93, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.8);
      transform: translateY(-3px);
    }

    .cases-header {
      padding: 24px 28px;
      border-bottom: 1px solid rgba(0, 0, 0, 0.06);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255, 255, 255, 0.5);
      backdrop-filter: blur(10px);
    }

    .cases-title {
      font-family: 'Space Grotesk', 'Poppins', sans-serif;
      font-size: 20px;
      font-weight: 700;
      color: var(--gray-900);
      letter-spacing: -0.02em;
    }

    .cases-filters {
      display: flex;
      gap: 12px;
    }

    .filter-select {
      padding: 8px 12px;
      border: 1px solid var(--gray-200);
      border-radius: 6px;
      font-size: 13px;
      color: var(--gray-700);
      background: white;
      cursor: pointer;
    }

    .cases-table {
      width: 100%;
      border-collapse: separate;
      border-spacing: 0;
    }

    .cases-table th,
    .cases-table td {
      padding: 16px 20px;
      text-align: left;
    }

    .cases-table th {
      background: rgba(249, 250, 251, 0.8);
      backdrop-filter: blur(10px);
      font-size: 11px;
      font-weight: 700;
      color: var(--gray-600);
      text-transform: uppercase;
      letter-spacing: 0.08em;
      border-bottom: 2px solid rgba(0, 0, 0, 0.06);
      position: sticky;
      top: 0;
      z-index: 10;
    }

    .cases-table tbody tr {
      cursor: pointer;
      transition: all 0.2s ease;
      background: rgba(255, 255, 255, 0.6);
      border-bottom: 1px solid rgba(0, 0, 0, 0.04);
    }

    .cases-table tbody tr:hover {
      background: rgba(255, 255, 255, 0.9);
      transform: scale(1.001);
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
    }

    .cases-table tbody tr:last-child td {
      border-bottom: none;
    }

    .case-id {
      font-family: 'SF Mono', 'Monaco', monospace;
      font-size: 13px;
      color: var(--brand-navy);
      font-weight: 500;
    }

    .customer-info {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .customer-name {
      font-weight: 600;
      color: var(--gray-900);
      font-size: 14px;
    }

    .customer-email {
      font-size: 12px;
      color: var(--gray-500);
      font-weight: 400;
    }

    .status-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 6px 14px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.01em;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .status-badge.pending {
      background: #fef3c7;
      color: #d97706;
    }

    .status-badge.in-progress {
      background: #dbeafe;
      color: #2563eb;
    }

    .status-badge.completed {
      background: #d1fae5;
      color: #059669;
    }

    .status-badge.cancelled {
      background: #fee2e2;
      color: #dc2626;
    }

    .type-badge {
      padding: 6px 12px;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 600;
      letter-spacing: 0.01em;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
    }

    .type-badge.refund { background: #fee2e2; color: #dc2626; }
    .type-badge.shipping { background: #dbeafe; color: #2563eb; }
    .type-badge.subscription { background: #d1fae5; color: #059669; }
    .type-badge.return { background: #fef3c7; color: #d97706; }
    .type-badge.manual { background: #e5e7eb; color: #374151; }

    .time-ago {
      font-size: 13px;
      color: var(--gray-500);
    }

    /* Pagination - Styles now in hub-styles.css for consistency */

    /* Empty State */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--gray-500);
    }

    .empty-state svg {
      width: 64px;
      height: 64px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    .empty-state h3 {
      font-size: 16px;
      color: var(--gray-700);
      margin-bottom: 8px;
    }

    /* Modern Loading Spinner */
    .loading-spinner {
      display: flex;
      align-items: center;
      justify-content: center;
      padding: 48px;
    }

    .spinner {
      position: relative;
      width: 40px;
      height: 40px;
    }

    .spinner::before {
      content: '';
      position: absolute;
      inset: 0;
      border-radius: 50%;
      border: 3px solid transparent;
      border-top-color: var(--brand-navy);
      border-right-color: rgba(26, 54, 93, 0.25);
      animation: spinner-rotate 0.9s cubic-bezier(0.4, 0, 0.2, 1) infinite;
    }

    .spinner::after {
      content: '';
      position: absolute;
      inset: 6px;
      border-radius: 50%;
      border: 2px solid transparent;
      border-top-color: #a8d8ea;
      border-left-color: rgba(168, 216, 234, 0.35);
      animation: spinner-rotate 0.65s cubic-bezier(0.4, 0, 0.2, 1) infinite reverse;
    }

    @keyframes spinner-rotate {
      0% { transform: rotate(0deg); }
      100% { transform: rotate(360deg); }
    }

    /* Responsive */
    @media (max-width: 1200px) {
      .stats-grid {
        grid-template-columns: repeat(2, 1fr);
      }
    }

    @media (max-width: 768px) {
      .sidebar {
        transform: translateX(-100%);
      }

      .main-content {
        margin-left: 0;
      }

      .stats-grid {
        grid-template-columns: 1fr;
      }

      .page-content {
        padding: 16px;
      }
    }
  </style>
</head>
<body>
  <!-- Login Screen -->
  <div id="loginScreen">
    <!-- Japanese-Style Animated Gradient Background for Login -->
    <div class="login-gradient-orbs" aria-hidden="true">
      <div class="gradient-orb login-orb"></div>
      <div class="gradient-orb login-orb"></div>
      <div class="gradient-orb login-orb"></div>
      <div class="gradient-orb login-orb"></div>
      <div class="gradient-orb login-orb"></div>
    </div>
    <div class="login-noise-overlay" aria-hidden="true"></div>
    
    <div class="login-container">
      <div class="login-header">
        <img src="https://cdn.shopify.com/s/files/1/0433/0510/7612/files/navyblue-logo.svg?v=1754231041" alt="PuppyPad">
        <h1>Resolution Hub</h1>
        <p>Sign in to access the admin dashboard</p>
      </div>
      <form class="login-form" onsubmit="handleLogin(event)">
        <div id="loginError" class="login-error"></div>
        <div class="form-group">
          <label for="loginUsername">Email</label>
          <input type="text" id="loginUsername" name="username" required autocomplete="username">
        </div>
        <div class="form-group">
          <label for="loginPassword">Password</label>
          <input type="password" id="loginPassword" name="password" required autocomplete="current-password">
        </div>
        <button type="submit" class="login-btn">Sign In</button>
      </form>
    </div>
  </div>

  <!-- App Container -->
  <div id="appContainer" class="app-container">
    <!-- Sidebar -->
    <aside class="sidebar">
      <div class="sidebar-header">
        <div class="sidebar-logo">
          <img src="https://cdn.shopify.com/s/files/1/0433/0510/7612/files/navyblue-logo.svg?v=1754231041" alt="PuppyPad">
          <span>Resolution Hub</span>
        </div>
      </div>

      <nav class="sidebar-nav">
        <div class="nav-section">
          <div class="nav-section-title">Overview</div>
          <a href="/hub" class="nav-item" data-page="dashboard">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2V6zM14 6a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2V6zM4 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2H6a2 2 0 01-2-2v-2zM14 16a2 2 0 012-2h2a2 2 0 012 2v2a2 2 0 01-2 2h-2a2 2 0 01-2-2v-2z"></path></svg>
            Dashboard
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Cases</div>
          <a href="/hub/cases" class="nav-item" data-page="cases" data-filter="all">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2"></path></svg>
            All Cases
            <span class="badge" id="allCasesCount">0</span>
          </a>
          <a href="/hub/cases/shipping" class="nav-item" data-page="cases" data-filter="shipping">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 8h14M5 8a2 2 0 110-4h14a2 2 0 110 4M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8m-9 4h4"></path></svg>
            Shipping
            <span class="badge" id="shippingCount">0</span>
          </a>
          <a href="/hub/cases/refund" class="nav-item" data-page="cases" data-filter="refund">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z"></path></svg>
            Refunds
            <span class="badge" id="refundsCount">0</span>
          </a>
          <a href="/hub/cases/return" class="nav-item" data-page="cases" data-filter="return">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 15v-1a4 4 0 00-4-4H8m0 0l3 3m-3-3l3-3m9 14V5a2 2 0 00-2-2H6a2 2 0 00-2 2v16l4-2 4 2 4-2 4 2z"></path></svg>
            Returns
            <span class="badge" id="returnsCount">0</span>
          </a>
          <a href="/hub/cases/subscription" class="nav-item" data-page="cases" data-filter="subscription">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15"></path></svg>
            Subscriptions
            <span class="badge" id="subscriptionsCount">0</span>
          </a>
          <a href="/hub/cases/manual" class="nav-item" data-page="cases" data-filter="manual">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6V4m0 2a2 2 0 100 4m0-4a2 2 0 110 4m-6 8a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4m6 6v10m6-2a2 2 0 100-4m0 4a2 2 0 110-4m0 4v2m0-6V4"></path></svg>
            Manual Review
            <span class="badge" id="manualCount">0</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Activity</div>
          <a href="/hub/sessions" class="nav-item" data-page="sessions">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            Sessions
          </a>
          <a href="/hub/events" class="nav-item" data-page="events">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
            Event Log
          </a>
          <a href="/hub/issues" class="nav-item" data-page="issues">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
            Issue Reports
            <span class="nav-badge" id="issuesCount">0</span>
          </a>
          <a href="/hub/duplicates" class="nav-item" data-page="duplicates">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z"></path></svg>
            Duplicates
            <span class="nav-badge" id="duplicatesCount">0</span>
          </a>
          <a href="/hub/self-resolved" class="nav-item" data-page="self-resolved">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
            Self-Resolved
            <span class="nav-badge" id="selfResolvedCount">0</span>
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Analytics</div>
          <a href="/hub/analytics" class="nav-item" data-page="analytics">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z"></path></svg>
            Performance
          </a>
        </div>

        <div class="nav-section admin-only-section" style="display: none;">
          <div class="nav-section-title">Resources</div>
          <a href="/hub/flow-docs" class="nav-item" target="_blank">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 5a1 1 0 011-1h14a1 1 0 011 1v2a1 1 0 01-1 1H5a1 1 0 01-1-1V5zM4 13a1 1 0 011-1h6a1 1 0 011 1v6a1 1 0 01-1 1H5a1 1 0 01-1-1v-6zM16 13a1 1 0 011-1h2a1 1 0 011 1v6a1 1 0 01-1 1h-2a1 1 0 01-1-1v-6z"></path></svg>
            Flow Docs
          </a>
          <a href="/hub/sop" class="nav-item" data-page="sop">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"></path></svg>
            SOP Links
          </a>
          <a href="/hub/email-templates" class="nav-item" data-page="email-templates">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path></svg>
            Email Templates
          </a>
        </div>

        <div class="nav-section admin-only-section" style="display: none;">
          <div class="nav-section-title">Administration</div>
          <a href="/hub/users" class="nav-item" data-page="users">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M15 21H3v-1a6 6 0 0112 0v1zm0 0h6v-1a6 6 0 00-9-5.197M13 7a4 4 0 11-8 0 4 4 0 018 0z"></path></svg>
            User Management
          </a>
        </div>

        <div class="nav-section">
          <div class="nav-section-title">Account</div>
          <a href="/hub/profile" class="nav-item" data-page="profile">
            <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z"></path></svg>
            Profile Settings
          </a>
        </div>
      </nav>

      <!-- Progress Section -->
      <div class="sidebar-progress" id="sidebarProgress">
        <div class="progress-header">
          <span class="progress-title">Case Progress</span>
          <span class="progress-stats"><span id="progressCompleted">0</span>/<span id="progressTotal">0</span></span>
        </div>
        <div class="progress-bar-container">
          <div class="progress-bar-track">
            <div class="progress-bar-fill" id="progressBarFill" style="width: 0%"></div>
          </div>
        </div>
        <div class="progress-labels">
          <span class="progress-label-pending">
            <span class="progress-dot pending"></span>
            <span id="progressPending">0</span> to-do
          </span>
          <span class="progress-label-completed">
            <span class="progress-dot completed"></span>
            <span id="progressCompletedLabel">0</span> done
          </span>
        </div>
      </div>

      <div class="sidebar-footer">
          <div class="user-info">
          <div class="user-avatar">A</div>
          <div class="user-details">
            <div class="user-name">Admin</div>
            <div class="user-role">Administrator</div>
          </div>
        </div>
        <button class="logout-btn" onclick="handleLogout()" style="width: 100%; display: flex; align-items: center; justify-content: center; gap: 6px; padding: 8px 12px; border: 1px solid rgba(255,255,255,0.15); border-radius: 6px; background: none; color: #94a3b8; font-size: 13px; cursor: pointer; transition: all 0.2s;">
          <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16" stroke-width="2"><path d="M9 21H5a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h4" /><polyline points="16,17 21,12 16,7" /><line x1="21" y1="12" x2="9" y2="12" /></svg>
          Logout
        </button>
      </div>
    </aside>

    <!-- Japanese-Style Animated Gradient Background -->
    <div class="gradient-orbs-container" aria-hidden="true">
      <div class="gradient-orb"></div>
      <div class="gradient-orb"></div>
      <div class="gradient-orb"></div>
      <div class="gradient-orb"></div>
      <div class="gradient-orb"></div>
    </div>

    <!-- Noise Texture Overlay -->
    <div class="noise-overlay" aria-hidden="true"></div>

    <!-- Main Content -->
    <main class="main-content">
      <header class="top-header">
        <h1 class="page-title" id="pageTitle">Dashboard</h1>
        <div class="header-actions">
          <div style="display: flex; gap: 12px; align-items: center; flex-wrap: wrap;">
            <!-- Enhanced Search with Dropdown -->
            <div style="position: relative; flex: 1; min-width: 300px; max-width: 500px;">
              <div class="search-box" id="searchBoxContainer">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                <input type="text" placeholder="Search anything..." id="searchInput" autocomplete="off">
                <button id="clearSearchBtn" style="display: none; background: none; border: none; cursor: pointer; padding: 4px; color: var(--gray-400);" onclick="HubSearch.clear()">
                  <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12"></path></svg>
                </button>
              </div>
              <div id="searchDropdown" class="search-dropdown" style="display: none;"></div>
            </div>

            <!-- Refresh button only in header -->
            <button class="btn btn-secondary" onclick="refreshData()" style="display: flex; align-items: center; gap: 6px; padding: 10px 20px; background: white; border: 1px solid var(--gray-200); border-radius: 12px; font-size: 14px; font-weight: 600; color: var(--gray-700); cursor: pointer; transition: all 0.2s;">
              <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16" stroke-width="2"><polyline points="23,4 23,10 17,10" /><path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10" /></svg>
              Refresh
            </button>
          </div>
        </div>
      </header>

      <div class="page-content">
        <!-- Dashboard View -->
        <div id="dashboardView">
          <div class="stats-grid">
            <div class="stat-card highlight-pending">
              <div class="stat-value" id="statPending">-</div>
              <div class="stat-label">Pending Cases</div>
              <div class="stat-change urgent">Needs attention</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statInProgress">-</div>
              <div class="stat-label">In Progress</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statCompletedToday">-</div>
              <div class="stat-label">Completed Today</div>
            </div>
            <div class="stat-card">
              <div class="stat-value" id="statAvgTime">-</div>
              <div class="stat-label">Avg. Resolution Time</div>
            </div>
          </div>

          <!-- Recent Cases -->
          <div class="cases-card cases-card-enhanced">
            <div class="cases-header">
              <h2 class="cases-title">Recent Cases</h2>
              <button class="btn btn-secondary" onclick="navigateTo('cases', 'all')">View All</button>
            </div>
            <!-- Filters above table - matching cases-filters-bar style -->
            <div class="cases-filters-bar" style="padding: 16px 20px; margin-bottom: 0; border-bottom: 1px solid var(--gray-100);">
              <div class="cases-filters-left">
                <select id="dashboardStatusFilter" class="filter-select-inline" onchange="HubDashboard.filterRecentCases()">
                  <option value="">All Status</option>
                  <option value="pending">Pending</option>
                  <option value="in_progress">In Progress</option>
                  <option value="completed">Completed</option>
                </select>
                <select id="dashboardTypeFilter" class="filter-select-inline" onchange="HubDashboard.filterRecentCases()">
                  <option value="">All Types</option>
                  <option value="refund">Refund</option>
                  <option value="shipping">Shipping</option>
                  <option value="subscription">Subscription</option>
                  <option value="return">Return</option>
                </select>
                <select id="dashboardSortFilter" class="filter-select-inline" onchange="HubDashboard.filterRecentCases()">
                  <option value="newest">Newest First</option>
                  <option value="oldest">Oldest First</option>
                </select>
              </div>
              <div class="cases-filters-right">
                <span id="dashboardResultCount" class="cases-result-count"></span>
              </div>
            </div>
            <table class="cases-table cases-table-enhanced">
              <thead>
                <tr>
                  <th style="width: 40px;"><input type="checkbox" id="dashboardSelectAll" onclick="HubDashboard.toggleSelectAll(this)"></th>
                  <th class="th-customer">CUSTOMER</th>
                  <th class="th-type">TYPE</th>
                  <th class="th-status">STATUS</th>
                  <th class="th-due">DUE</th>
                  <th class="th-resolution">RESOLUTION</th>
                  <th class="th-assignee">ASSIGNEE</th>
                  <th class="th-created">CREATED</th>
                </tr>
              </thead>
              <tbody id="recentCasesBody">
                <tr><td colspan="8" class="loading-spinner"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
          </div>
        </div>

        <!-- Cases View (will be shown/hidden) -->
        <div id="casesView" style="display: none;">
          <!-- Filters Bar Above Table -->
          <div class="cases-filters-bar">
            <div class="cases-filters-left">
              <select id="casesStatusFilter" class="filter-select-inline" onchange="HubFilters.applyFilters()">
                <option value="">All Status</option>
                <option value="pending">Pending</option>
                <option value="in_progress">In Progress</option>
                <option value="completed">Completed</option>
              </select>
              <select id="casesAssigneeFilter" class="filter-select-inline" onchange="HubFilters.applyFilters()">
                <option value="">All Assignees</option>
                <option value="unassigned">Unassigned</option>
              </select>
              <select id="casesDateFilter" class="filter-select-inline" onchange="HubFilters.handleDateFilterChange(this.value)">
                <option value="">All Time</option>
                <option value="today">Today</option>
                <option value="yesterday">Yesterday</option>
                <option value="7d">Last 7 Days</option>
                <option value="30d">Last 30 Days</option>
                <option value="custom">Custom Range...</option>
              </select>
              <!-- Custom Date Range Picker (hidden by default) -->
              <div id="customDateRange" class="custom-date-range" style="display: none;">
                <input type="date" id="dateFrom" class="date-input" onchange="HubFilters.applyFilters()">
                <span class="date-separator">to</span>
                <input type="date" id="dateTo" class="date-input" onchange="HubFilters.applyFilters()">
              </div>
              <select id="casesSortFilter" class="filter-select-inline" onchange="HubFilters.applyFilters()">
                <option value="created_desc">Newest First</option>
                <option value="created_asc">Oldest First</option>
                <option value="due_asc">Due Date</option>
                <option value="status_asc">Status</option>
              </select>
            </div>
            <div class="cases-filters-right">
              <span id="casesResultCount" class="cases-result-count">Loading...</span>
              <button class="btn-save-view" onclick="HubSavedViews.showSaveModal()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="14" height="14"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 5a2 2 0 012-2h10a2 2 0 012 2v16l-7-3.5L5 21V5z"/></svg>
                Save View
              </button>
            </div>
          </div>
          
          <!-- Saved Views Section -->
          <div id="savedViewsSection" class="saved-views-section" style="display: none;">
            <div class="saved-views-label">Saved Views:</div>
            <div id="savedViewsList" class="saved-views-list">
              <!-- Saved views will be rendered here -->
            </div>
          </div>

          <div class="cases-card cases-card-enhanced">
            <table class="cases-table cases-table-enhanced">
              <thead>
                <tr>
                  <th style="width: 40px;">
                    <input type="checkbox" id="selectAllCases" onclick="HubBulkActions.selectAll()">
                  </th>
                  <th class="th-customer">CUSTOMER</th>
                  <th class="th-type">TYPE</th>
                  <th class="th-status">STATUS</th>
                  <th class="th-due">DUE</th>
                  <th class="th-resolution">RESOLUTION</th>
                  <th class="th-assignee">ASSIGNEE</th>
                  <th class="th-created">CREATED</th>
                </tr>
              </thead>
              <tbody id="casesTableBody">
                <tr><td colspan="8" class="loading-spinner"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
            <div id="casesPagination" class="pagination"></div>
          </div>
        </div>

        <!-- Sessions View -->
        <div id="sessionsView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header">
              <h2 class="cases-title">Sessions</h2>
            </div>
            <table class="cases-table sessions-table">
              <thead>
                <tr>
                  <th style="min-width: 160px;">Started</th>
                  <th style="min-width: 200px;">Customer</th>
                  <th style="min-width: 120px;">Order</th>
                  <th style="min-width: 140px;">Flow Type</th>
                  <th style="min-width: 100px;">Status</th>
                  <th style="min-width: 120px;">Recording</th>
                </tr>
              </thead>
              <tbody id="sessionsTableBody">
                <tr><td colspan="6" class="loading-spinner"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
            <div id="sessionsPagination" class="pagination"></div>
          </div>
        </div>

        <!-- Events View -->
        <div id="eventsView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header">
              <h2 class="cases-title">Event Log</h2>
            </div>
            <table class="cases-table events-table">
              <thead>
                <tr>
                  <th style="min-width: 130px;">Session ID</th>
                  <th style="min-width: 120px;">Actor</th>
                  <th style="min-width: 120px;">Event Type</th>
                  <th style="min-width: 160px;">Event Name</th>
                  <th style="min-width: 180px;">Event Data</th>
                  <th style="min-width: 140px;">Created</th>
                </tr>
              </thead>
              <tbody id="eventsTableBody">
                <tr><td colspan="6" class="loading-spinner"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
            <div id="eventsPagination" class="pagination"></div>
          </div>
        </div>

        <!-- Issues View -->
        <div id="issuesView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header">
              <h2 class="cases-title">Issue Reports</h2>
            </div>
            <table class="cases-table issues-table">
              <thead>
                <tr>
                  <th style="min-width: 130px;">Report ID</th>
                  <th style="min-width: 200px;">Customer Email</th>
                  <th style="min-width: 150px;">Issue Type</th>
                  <th style="min-width: 100px;">Status</th>
                  <th style="min-width: 120px;">Created</th>
                  <th style="min-width: 120px;">Recording</th>
                </tr>
              </thead>
              <tbody id="issuesTableBody">
                <tr><td colspan="6" class="loading-spinner"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
            <div id="issuesPagination" class="pagination"></div>
          </div>
        </div>

        <!-- Duplicates View -->
        <div id="duplicatesView" style="display: none;">
          <!-- Summary Stats -->
          <div class="duplicates-summary">
            <div class="duplicate-stat-card">
              <div class="duplicate-stat-value" id="duplicateGroupsCount">0</div>
              <div class="duplicate-stat-label">Duplicate Groups</div>
            </div>
            <div class="duplicate-stat-card">
              <div class="duplicate-stat-value" id="duplicateCasesCount">0</div>
              <div class="duplicate-stat-label">Total Duplicate Cases</div>
            </div>
            <div class="duplicate-stat-card">
              <div class="duplicate-stat-value" id="duplicateCustomersCount">0</div>
              <div class="duplicate-stat-label">Customers Affected</div>
            </div>
          </div>

          <!-- Duplicate Groups List -->
          <div class="cases-card">
            <div class="cases-header">
              <h2 class="cases-title">Duplicate Cases</h2>
              <p class="duplicates-description">Cases with the same email address AND order number</p>
            </div>
            <div id="duplicatesContent">
              <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- Self-Resolved View -->
        <div id="selfResolvedView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header">
              <h2 class="cases-title">Self-Resolved Cases</h2>
              <p style="margin-top: 8px; color: var(--gray-500); font-size: 14px;">Cases where customers were satisfied with information provided and resolved without manual intervention</p>
            </div>
            <div class="cases-filters-bar" style="padding: 16px 20px; margin-bottom: 0; border-bottom: 1px solid var(--gray-100);">
              <div class="cases-filters-left">
                <input type="text" id="selfResolvedSearch" placeholder="Search cases..." class="filter-select-inline" style="min-width: 250px;" oninput="HubSelfResolved.search()">
              </div>
              <div class="cases-filters-right">
                <span id="selfResolvedResultCount" class="cases-result-count">Loading...</span>
              </div>
            </div>
            <table class="cases-table cases-table-enhanced">
              <thead>
                <tr>
                  <th class="th-customer">CUSTOMER</th>
                  <th class="th-type">ISSUE TYPE</th>
                  <th class="th-resolution">RESOLUTION PROVIDED</th>
                  <th class="th-created">RESOLVED</th>
                  <th class="th-status">RECORDING</th>
                </tr>
              </thead>
              <tbody id="selfResolvedTableBody">
                <tr><td colspan="5" class="loading-spinner"><div class="spinner"></div></td></tr>
              </tbody>
            </table>
            <div id="selfResolvedPagination" class="pagination"></div>
          </div>
        </div>

        <!-- Analytics View -->
        <div id="analyticsView" style="display: none;">
          <!-- Row 1: Cases Metrics -->
          <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card">
              <div class="stat-label">Total Cases</div>
              <div class="stat-value" id="analyticsTotalCases">-</div>
              <div class="stat-change" id="analyticsTotalCasesSub">-</div>
            </div>
            <div class="stat-card highlight" style="background: #FEF3C7; border-color: #FCD34D;">
              <div class="stat-label">Pending Cases</div>
              <div class="stat-value" id="analyticsPendingCases">-</div>
              <div class="stat-change" id="analyticsPendingCasesSub">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">In Progress</div>
              <div class="stat-value" id="analyticsInProgress">-</div>
              <div class="stat-change">Being worked on</div>
            </div>
            <div class="stat-card highlight" style="background: #D1FAE5; border-color: #10B981;">
              <div class="stat-label">Completed</div>
              <div class="stat-value" id="analyticsCompletedCases">-</div>
              <div class="stat-change" id="analyticsCompletedSub">-</div>
            </div>
          </div>

          <!-- Row 2: Refunds & Sessions -->
          <div class="stats-grid" style="margin-bottom: 20px;">
            <div class="stat-card highlight" style="background: #1a365d; color: white; border: none;">
              <div class="stat-label" style="color: rgba(255,255,255,0.8);">Total Refunds</div>
              <div class="stat-value" id="analyticsTotalRefunds" style="color: white;">-</div>
              <div class="stat-change" style="color: rgba(255,255,255,0.7);">All time</div>
            </div>
            <div class="stat-card highlight" style="background: #FCE7F3; border-color: #F9A8D4;">
              <div class="stat-label">Refunds (30d)</div>
              <div class="stat-value" id="analyticsRefunds30d">-</div>
              <div class="stat-change">This month</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Avg. Refund</div>
              <div class="stat-value" id="analyticsAvgRefund">-</div>
              <div class="stat-change">Per case</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Total Sessions</div>
              <div class="stat-value" id="analyticsTotalSessions">-</div>
              <div class="stat-change" id="analyticsSessionsSub">-</div>
            </div>
          </div>

          <!-- Row 3: Performance Metrics -->
          <div class="stats-grid" style="margin-bottom: 32px;">
            <div class="stat-card">
              <div class="stat-label">Avg Resolution Time</div>
              <div class="stat-value" id="analyticsAvgResolution">-</div>
              <div class="stat-change" id="analyticsResolutionSub">-</div>
            </div>
            <div class="stat-card highlight" style="background: #D1FAE5; border-color: #10B981;">
              <div class="stat-label">SLA Compliance</div>
              <div class="stat-value" id="analyticsSLACompliance">-</div>
              <div class="stat-change" id="analyticsSLASub">-</div>
            </div>
            <div class="stat-card">
              <div class="stat-label">Active Team Members</div>
              <div class="stat-value" id="analyticsTeamMembers">-</div>
              <div class="stat-change">Last 30 days</div>
            </div>
            <div class="stat-card highlight" style="background: #FEE2E2; border-color: #FCA5A5;">
              <div class="stat-label">Root Cause Categories</div>
              <div class="stat-value" id="analyticsRootCauses">-</div>
              <div class="stat-change">Last 30 days</div>
            </div>
          </div>

          <!-- Charts Row -->
          <div style="display: grid; grid-template-columns: 2fr 1fr; gap: 24px; margin-bottom: 32px;">
            <!-- Cases & Sessions Trend (Line Chart) -->
            <div class="cases-card">
              <div class="cases-header">
                <h2 class="cases-title">Cases & Sessions Trend</h2>
                <select id="analyticsDateRange" style="padding: 6px 12px; border: 1px solid var(--gray-300); border-radius: 6px; font-size: 13px;">
                  <option value="14d">Last 14 Days</option>
                  <option value="30d">Last 30 Days</option>
                  <option value="90d">Last 90 Days</option>
                </select>
              </div>
              <div style="padding: 32px;">
                <div id="analyticsTrendChart" style="min-height: 350px; width: 100%;">
                  <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
              </div>
            </div>

            <!-- Cases by Type (Donut Chart) -->
            <div class="cases-card">
              <div class="cases-header">
                <h2 class="cases-title">Cases by Type</h2>
              </div>
              <div style="padding: 24px;">
                <div id="analyticsCasesByTypeChart" style="min-height: 200px;">
                  <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Lists Row -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px; margin-bottom: 32px;">
            <!-- Resolution Types -->
            <div class="cases-card">
              <div class="cases-header">
                <h2 class="cases-title">Resolution Types</h2>
              </div>
              <div style="padding: 24px;">
                <div id="analyticsResolutionTypes" style="max-height: 400px; overflow-y: auto;">
                  <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
              </div>
            </div>

            <!-- Status Distribution -->
            <div class="cases-card">
              <div class="cases-header">
                <h2 class="cases-title">Status Distribution</h2>
              </div>
              <div style="padding: 24px;">
                <div id="analyticsStatusDistribution" style="max-height: 400px; overflow-y: auto;">
                  <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
              </div>
            </div>

            <!-- Flow Types -->
            <div class="cases-card">
              <div class="cases-header">
                <h2 class="cases-title">Flow Types</h2>
              </div>
              <div style="padding: 24px;">
                <div id="analyticsFlowTypes" style="max-height: 400px; overflow-y: auto;">
                  <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
              </div>
            </div>
          </div>

          <!-- Bottom Row: Team Leaderboard, Root Causes, Resolution Time -->
          <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 24px;">
            <!-- Team Leaderboard -->
            <div class="cases-card">
              <div class="cases-header">
                <h2 class="cases-title">Team Leaderboard</h2>
                <span style="font-size: 12px; color: var(--gray-500);">Last 30 days</span>
              </div>
              <div style="padding: 24px;">
                <div id="analyticsTeamLeaderboard" style="max-height: 300px; overflow-y: auto;">
                  <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
              </div>
            </div>

            <!-- Root Cause Analysis -->
            <div class="cases-card">
              <div class="cases-header">
                <h2 class="cases-title">Root Cause Analysis</h2>
                <span style="font-size: 12px; color: var(--gray-500);">Last 30 days</span>
              </div>
              <div style="padding: 24px;">
                <div id="analyticsRootCauseAnalysis" style="max-height: 300px; overflow-y: auto;">
                  <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
              </div>
            </div>

            <!-- Resolution Time Distribution -->
            <div class="cases-card">
              <div class="cases-header">
                <h2 class="cases-title">Resolution Time Distribution</h2>
              </div>
              <div style="padding: 24px;">
                <div id="analyticsResolutionTimeDist" style="max-height: 300px; overflow-y: auto;">
                  <div class="loading-spinner"><div class="spinner"></div></div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- SOP Links View -->
        <div id="sopView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h2 class="cases-title">SOP Links</h2>
              <button id="addSopBtn" class="btn btn-primary admin-only" onclick="HubSOP.showAddModal()" style="display: none;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Add SOP
              </button>
            </div>
            <!-- Category Tabs -->
            <div style="padding: 16px 24px; border-bottom: 1px solid var(--gray-200); display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="sop-tab active" data-category="" onclick="HubSOP.filterByCategory('')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: #1a365d; color: white; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(30, 41, 59, 0.25);">All</button>
              <button class="sop-tab" data-category="refund" onclick="HubSOP.filterByCategory('refund')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Refunds</button>
              <button class="sop-tab" data-category="return" onclick="HubSOP.filterByCategory('return')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Returns</button>
              <button class="sop-tab" data-category="shipping" onclick="HubSOP.filterByCategory('shipping')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Shipping</button>
              <button class="sop-tab" data-category="subscription" onclick="HubSOP.filterByCategory('subscription')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Subscriptions</button>
              <button class="sop-tab" data-category="manual" onclick="HubSOP.filterByCategory('manual')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Manual</button>
            </div>
            <div id="sopList" style="padding: 24px;">
              <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- Email Templates View -->
        <div id="emailTemplatesView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h2 class="cases-title">Email Templates</h2>
              <button id="addTemplateBtn" class="btn btn-primary admin-only" onclick="HubEmailTemplates.showAddModal()" style="display: none;">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Add Template
              </button>
            </div>
            <!-- Category Tabs -->
            <div style="padding: 16px 24px; border-bottom: 1px solid var(--gray-200); display: flex; gap: 10px; flex-wrap: wrap;">
              <button class="template-tab active" data-category="" onclick="HubEmailTemplates.filterByCategory('')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: #1a365d; color: white; font-size: 14px; font-weight: 600; cursor: pointer; box-shadow: 0 2px 8px rgba(30, 41, 59, 0.25);">All</button>
              <button class="template-tab" data-category="refund" onclick="HubEmailTemplates.filterByCategory('refund')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Refunds</button>
              <button class="template-tab" data-category="return" onclick="HubEmailTemplates.filterByCategory('return')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Returns</button>
              <button class="template-tab" data-category="shipping" onclick="HubEmailTemplates.filterByCategory('shipping')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Shipping</button>
              <button class="template-tab" data-category="subscription" onclick="HubEmailTemplates.filterByCategory('subscription')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Subscriptions</button>
              <button class="template-tab" data-category="manual" onclick="HubEmailTemplates.filterByCategory('manual')" style="padding: 10px 20px; border: 2px solid #e5e7eb; border-radius: 24px; background: white; color: #4b5563; font-size: 14px; font-weight: 600; cursor: pointer;">Manual</button>
            </div>
            <div id="emailTemplatesList" style="padding: 24px;">
              <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- Case Detail View (Full Page) -->
        <div id="caseDetailView" style="display: none;">
          <div id="caseDetailContent">
            <div class="loading-spinner"><div class="spinner"></div></div>
          </div>
        </div>

        <!-- Profile Settings View -->
        <div id="profileView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header">
              <h2 class="cases-title">Profile Settings</h2>
            </div>
            <div id="profileContent" style="padding: 24px;">
              <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- User Management View (Admin Only) -->
        <div id="usersView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header" style="display: flex; justify-content: space-between; align-items: center;">
              <h2 class="cases-title">User Management</h2>
              <button class="btn btn-primary" onclick="HubUsers.showCreateForm()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4v16m8-8H4"></path></svg>
                Create User
              </button>
            </div>
            <div id="usersContent" style="padding: 24px;">
              <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
          </div>
        </div>

        <!-- User Activity Log View -->
        <div id="userActivityView" style="display: none;">
          <div class="cases-card">
            <div class="cases-header" style="display: flex; justify-content: space-between; align-items: center;">
              <div>
                <h2 class="cases-title" id="userActivityTitle">User Activity Log</h2>
                <p style="margin-top: 8px; color: var(--gray-500); font-size: 14px;" id="userActivitySubtitle"></p>
              </div>
              <button class="btn btn-secondary" onclick="HubUserManagement.backToUsers()">
                <svg fill="none" stroke="currentColor" viewBox="0 0 24 24" width="16" height="16"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
                Back to Users
              </button>
            </div>
            <div id="userActivityContent" style="padding: 24px;">
              <div class="loading-spinner"><div class="spinner"></div></div>
            </div>
          </div>
        </div>
      </div>
    </main>
  </div>

  <script>
    // Will add JavaScript in next step
    console.log('Resolution Hub loaded');

    // Simple navigation - handle clicks on nav links
    document.querySelectorAll('.nav-item').forEach(item => {
      item.addEventListener('click', (e) => {
        const page = item.dataset.page;
        const filter = item.dataset.filter;
        
        // Only intercept navigation for links with data-page attribute
        // Links without data-page (like Flow Docs) should navigate normally
        // Also allow links with target="_blank" to navigate normally
        if (page && typeof HubNavigation !== 'undefined' && HubNavigation.goto && !item.hasAttribute('target')) {
          e.preventDefault(); // Prevent default link behavior only for SPA pages
          HubNavigation.goto(page, filter);
        }
        // If no data-page or has target="_blank", let the link navigate normally (e.g., to flow-docs)
      });
    });

    // Simple URL parsing on page load
    function initFromURL() {
      const path = window.location.pathname;
      
      // Parse /hub/cases/shipping -> page: cases, filter: shipping
      if (path.startsWith('/hub/cases/')) {
        const filter = path.split('/hub/cases/')[1].split('/')[0];
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('cases', filter);
        }
      } else if (path === '/hub/cases' || path === '/hub/cases/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('cases', 'all');
        }
      } else if (path === '/hub/sessions' || path === '/hub/sessions/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('sessions');
        }
      } else if (path === '/hub/events' || path === '/hub/events/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('events');
        }
      } else if (path === '/hub/issues' || path === '/hub/issues/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('issues');
        }
      } else if (path === '/hub/duplicates' || path === '/hub/duplicates/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('duplicates');
        }
      } else if (path === '/hub/self-resolved' || path === '/hub/self-resolved/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('self-resolved');
        }
      } else if (path === '/hub/analytics' || path === '/hub/analytics/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('analytics');
        }
      } else if (path === '/hub/sop' || path === '/hub/sop/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('sop');
        }
      } else if (path === '/hub/email-templates' || path === '/hub/email-templates/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('email-templates');
        }
      } else if (path.startsWith('/hub/case/')) {
        const caseId = path.split('/hub/case/')[1].split('/')[0];
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('case-detail', caseId);
        }
      } else if (path === '/hub' || path === '/hub/') {
        if (typeof HubNavigation !== 'undefined' && HubNavigation.goto) {
          HubNavigation.goto('dashboard');
        }
      }
    }

    // Handle browser back/forward buttons
    window.addEventListener('popstate', () => {
      initFromURL();
    });

    // Initialize from URL when page loads (after hub-app.js is loaded)
    if (document.readyState === 'loading') {
      document.addEventListener('DOMContentLoaded', () => {
        setTimeout(initFromURL, 100); // Wait for hub-app.js to load
      });
    } else {
      setTimeout(initFromURL, 100);
    }

    function refreshData() {
      console.log('Refreshing data...');
      // Will implement
    }

    function handleLogout() {
      if (typeof HubAuth !== 'undefined' && HubAuth.logout) {
        HubAuth.logout();
      } else {
        // Fallback if HubAuth not loaded yet
        localStorage.removeItem('hub_token');
        localStorage.removeItem('hub_user');
        window.location.href = '/hub';
      }
    }
  </script>
  <script src="/hub/hub-app.js"></script>
  <script>
    // Cache busting - add timestamp to force reload on every page load
    (function() {
      const timestamp = Date.now();
      const scripts = document.querySelectorAll('script[src*="hub-app.js"]');
      scripts.forEach(el => {
        const url = new URL(el.src, window.location.href);
        url.searchParams.set('v', timestamp);
        el.src = url.pathname + url.search;
      });
    })();
  </script>
</body>
</html>
`;
}

// NOTE: getFlowDocsHTML removed - Flow Documentation is now part of hub-app.js SPA

// Hub CSS Asset

function getHubStylesCSS() {
  return `/**
 * Resolution Hub Styles
 * Premium Japanese-Inspired Design System
 */

/* ============================================
   CSS Variables
   ============================================ */
:root {
  /* ===== Japanese Soft Pastel Colors ===== */
  /* Swapped: Sakura is now blue, Sora is now pink */
  --sakura: #A8D8EA;       /* Sky blue (was cherry blossom pink) */
  --sakura-soft: rgba(168, 216, 234, 0.15);
  --sora: #FFB7C5;         /* Cherry blossom pink (was sky blue) */
  --sora-soft: rgba(255, 183, 197, 0.15);
  --momo: #FFDAB9;         /* Peach */
  --momo-soft: rgba(255, 218, 185, 0.15);
  --matcha: #C8E6C9;       /* Green tea */
  --matcha-soft: rgba(200, 230, 201, 0.15);
  --fuji: #E8D5E8;         /* Wisteria/lavender */
  --fuji-soft: rgba(232, 213, 232, 0.15);
  --kinari: #FFF8E7;       /* Natural off-white */

  /* Animation speeds */
  --gradient-speed: 20s;
  --color-shift-speed: 12s;
  --noise-opacity: 0.035;

  /* Brand Colors */
  --brand-navy: #1a365d;
  --brand-navy-light: #2c5282;
  --brand-navy-soft: #E8EEF4;
  
  /* Colors */
  --primary-50: #eff6ff;
  --primary-100: #dbeafe;
  --primary-500: #1a365d;
  --primary-600: #1a365d;
  --primary-700: #0f172a;

  --success-50: #ecfdf5;
  --success-500: #10b981;
  --success-600: #059669;

  --warning-50: #fffbeb;
  --warning-500: #f59e0b;
  --warning-600: #d97706;

  --error-50: #fef2f2;
  --error-500: #ef4444;
  --error-600: #dc2626;

  --gray-50: #f9fafb;
  --gray-100: #f3f4f6;
  --gray-200: #e5e7eb;
  --gray-300: #d1d5db;
  --gray-400: #9ca3af;
  --gray-500: #6b7280;
  --gray-600: #4b5563;
  --gray-700: #374151;
  --gray-800: #1f2937;
  --gray-900: #111827;

  /* Spacing */
  --spacing-xs: 4px;
  --spacing-sm: 8px;
  --spacing-md: 16px;
  --spacing-lg: 24px;
  --spacing-xl: 32px;

  /* Typography */
  --font-sans: 'Satoshi', 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
  --font-display: 'Space Grotesk', 'Poppins', sans-serif;
  --font-mono: 'SF Mono', SFMono-Regular, Menlo, Monaco, Consolas, monospace;

  /* Shadows - Enhanced with colored tints */
  --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
  --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.08), 0 2px 4px -1px rgba(0, 0, 0, 0.04);
  --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.08), 0 4px 6px -2px rgba(0, 0, 0, 0.04);
  --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.08), 0 10px 10px -5px rgba(0, 0, 0, 0.03);
  --shadow-glass: 0 8px 32px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(255, 255, 255, 0.5);
  --shadow-card-hover: 0 20px 40px rgba(26, 54, 93, 0.12), 0 0 0 1px rgba(255, 255, 255, 0.8);

  /* Borders */
  --radius-sm: 4px;
  --radius-md: 8px;
  --radius-lg: 12px;
  --radius-xl: 16px;
  --radius-2xl: 20px;
  --radius-full: 9999px;

  /* Transitions */
  --transition-fast: 150ms ease;
  --transition-normal: 250ms ease;
  --transition-slow: 350ms ease;
  --transition-bounce: 500ms cubic-bezier(0.34, 1.56, 0.64, 1);

  /* Glassmorphism */
  --glass-bg: rgba(255, 255, 255, 0.85);
  --glass-bg-strong: rgba(255, 255, 255, 0.95);
  --glass-border: rgba(255, 255, 255, 0.6);
  --glass-border-subtle: rgba(0, 0, 0, 0.06);

  /* Hub Background Gradient */
  --gradient-dawn: linear-gradient(135deg, var(--kinari) 0%, #FFF5F5 50%, #F0F7FF 100%);
}

/* ============================================
   Japanese-Style Animated Background
   ============================================ */

/* Container for gradient orbs - positioned behind main content */
.gradient-orbs-container {
  position: fixed;
  top: 0;
  left: 240px; /* Offset for sidebar */
  right: 0;
  bottom: 0;
  z-index: 0;
  overflow: hidden;
  pointer-events: none;
}

.gradient-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.6;
  animation: float var(--gradient-speed) ease-in-out infinite, colorShift var(--color-shift-speed) ease-in-out infinite;
  mix-blend-mode: multiply;
}

.gradient-orb:nth-child(1) {
  width: 50%;
  height: 50%;
  background: var(--sakura);
  top: -15%;
  right: 10%;
  animation-delay: 0s;
}

.gradient-orb:nth-child(2) {
  width: 45%;
  height: 45%;
  background: var(--sora);
  top: 30%;
  left: 5%;
  animation-delay: -4s;
}

.gradient-orb:nth-child(3) {
  width: 40%;
  height: 40%;
  background: var(--momo);
  bottom: -10%;
  right: 20%;
  animation-delay: -8s;
}

.gradient-orb:nth-child(4) {
  width: 35%;
  height: 35%;
  background: var(--matcha);
  top: 50%;
  right: 40%;
  animation-delay: -12s;
}

.gradient-orb:nth-child(5) {
  width: 30%;
  height: 30%;
  background: var(--fuji);
  bottom: 20%;
  left: 30%;
  animation-delay: -6s;
}

/* Noise texture overlay */
.noise-overlay {
  position: fixed;
  top: 0;
  left: 240px; /* Offset for sidebar */
  right: 0;
  bottom: 0;
  z-index: 1;
  pointer-events: none;
  opacity: var(--noise-opacity);
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

/* ============================================
   Login Page Gradient Orbs
   ============================================ */
.login-gradient-orbs {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 0;
  overflow: hidden;
  pointer-events: none;
}

.login-gradient-orbs .gradient-orb.login-orb {
  position: absolute;
  border-radius: 50%;
  filter: blur(80px);
  opacity: 0.6;
  animation: float var(--gradient-speed) ease-in-out infinite, colorShift var(--color-shift-speed) ease-in-out infinite;
  mix-blend-mode: multiply;
}

.login-gradient-orbs .gradient-orb.login-orb:nth-child(1) {
  width: 60%;
  height: 60%;
  background: var(--sakura);
  top: -20%;
  right: -10%;
  animation-delay: 0s;
}

.login-gradient-orbs .gradient-orb.login-orb:nth-child(2) {
  width: 50%;
  height: 50%;
  background: var(--sora);
  top: 40%;
  left: -15%;
  animation-delay: -4s;
}

.login-gradient-orbs .gradient-orb.login-orb:nth-child(3) {
  width: 45%;
  height: 45%;
  background: var(--momo);
  bottom: -15%;
  right: 10%;
  animation-delay: -8s;
}

.login-gradient-orbs .gradient-orb.login-orb:nth-child(4) {
  width: 40%;
  height: 40%;
  background: var(--matcha);
  top: 60%;
  right: 35%;
  animation-delay: -12s;
}

.login-gradient-orbs .gradient-orb.login-orb:nth-child(5) {
  width: 35%;
  height: 35%;
  background: var(--fuji);
  bottom: 30%;
  left: 25%;
  animation-delay: -6s;
}

.login-noise-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  z-index: 1;
  pointer-events: none;
  opacity: var(--noise-opacity);
  background-image: url("data:image/svg+xml,%3Csvg viewBox='0 0 256 256' xmlns='http://www.w3.org/2000/svg'%3E%3Cfilter id='noise'%3E%3CfeTurbulence type='fractalNoise' baseFrequency='0.8' numOctaves='4' stitchTiles='stitch'/%3E%3C/filter%3E%3Crect width='100%25' height='100%25' filter='url(%23noise)'/%3E%3C/svg%3E");
}

/* Float animation for orbs */
@keyframes float {
  0%, 100% {
    transform: translate(0, 0) scale(1) rotate(0deg);
  }
  25% {
    transform: translate(30px, -30px) scale(1.05) rotate(3deg);
  }
  50% {
    transform: translate(-20px, 20px) scale(0.95) rotate(-3deg);
  }
  75% {
    transform: translate(15px, 15px) scale(1.02) rotate(2deg);
  }
}

/* Color shift animation for orbs */
@keyframes colorShift {
  0%, 100% {
    filter: blur(80px) hue-rotate(0deg);
  }
  33% {
    filter: blur(90px) hue-rotate(10deg);
  }
  66% {
    filter: blur(70px) hue-rotate(-8deg);
  }
}

/* Entrance animations */
@keyframes fadeInUp {
  from {
    opacity: 0;
    transform: translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes fadeInDown {
  from {
    opacity: 0;
    transform: translateY(-20px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

@keyframes slideUpCard {
  from {
    opacity: 0;
    transform: translateY(24px) scale(0.98);
  }
  to {
    opacity: 1;
    transform: translateY(0) scale(1);
  }
}

@keyframes scaleIn {
  from {
    opacity: 0;
    transform: scale(0.95);
  }
  to {
    opacity: 1;
    transform: scale(1);
  }
}

@keyframes pulseGlow {
  0%, 100% {
    box-shadow: 0 0 0 0 rgba(26, 54, 93, 0.2);
  }
  50% {
    box-shadow: 0 0 0 8px rgba(26, 54, 93, 0);
  }
}

/* Reduced motion support */
@media (prefers-reduced-motion: reduce) {
  .gradient-orb {
    animation: none;
  }
  
  .animate-in,
  .glass-card,
  .stat-card {
    animation: none !important;
  }
}

/* ============================================
   Base Styles
   ============================================ */
*, *::before, *::after {
  box-sizing: border-box;
}

body {
  font-family: var(--font-sans);
  color: var(--gray-900);
  background: var(--gradient-dawn);
  background-attachment: fixed;
  margin: 0;
  padding: 0;
  -webkit-font-smoothing: antialiased;
  -moz-osx-font-smoothing: grayscale;
}

h1, h2, h3, h4, h5, h6 {
  font-family: var(--font-display);
  font-weight: 700;
}

/* ============================================
   Glassmorphism Components
   ============================================ */

/* Glass Card - Primary container style */
.glass-card {
  background: var(--glass-bg-strong);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-glass);
  transition: all var(--transition-normal);
}

.glass-card:hover {
  box-shadow: var(--shadow-card-hover);
  transform: translateY(-2px);
}

/* Glass card without hover effect */
.glass-card-static {
  background: var(--glass-bg-strong);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid var(--glass-border);
  border-radius: var(--radius-xl);
  box-shadow: var(--shadow-glass);
}

/* Subtle glass for nested elements */
.glass-subtle {
  background: rgba(255, 255, 255, 0.6);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border: 1px solid rgba(255, 255, 255, 0.4);
  border-radius: var(--radius-lg);
}

/* Animated entrance for cards */
.animate-in {
  animation: slideUpCard 0.4s ease-out backwards;
}

.animate-in:nth-child(1) { animation-delay: 0.05s; }
.animate-in:nth-child(2) { animation-delay: 0.1s; }
.animate-in:nth-child(3) { animation-delay: 0.15s; }
.animate-in:nth-child(4) { animation-delay: 0.2s; }
.animate-in:nth-child(5) { animation-delay: 0.25s; }
.animate-in:nth-child(6) { animation-delay: 0.3s; }

/* Japanese pastel accent backgrounds */
.bg-sakura { background: var(--sakura-soft); }
.bg-sora { background: var(--sora-soft); }
.bg-momo { background: var(--momo-soft); }
.bg-matcha { background: var(--matcha-soft); }
.bg-fuji { background: var(--fuji-soft); }

/* ============================================
   Bulk Actions Toolbar
   ============================================ */
.bulk-actions-toolbar {
  display: none;
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  background: var(--gray-800);
  color: white;
  padding: 12px 20px;
  border-radius: var(--radius-lg);
  box-shadow: var(--shadow-xl);
  align-items: center;
  gap: 16px;
  z-index: 100;
  animation: slideUp 0.2s ease;
}

.bulk-actions-toolbar.visible {
  display: flex;
}

@keyframes slideUp {
  from {
    opacity: 0;
    transform: translateX(-50%) translateY(20px);
  }
  to {
    opacity: 1;
    transform: translateX(-50%) translateY(0);
  }
}

.bulk-actions-toolbar .selected-count {
  font-weight: 600;
  padding-right: 16px;
  border-right: 1px solid var(--gray-600);
}

.bulk-actions-toolbar .bulk-btn {
  background: transparent;
  border: none;
  color: white;
  padding: 8px 12px;
  border-radius: var(--radius-sm);
  cursor: pointer;
  font-size: 14px;
  transition: background var(--transition-fast);
}

.bulk-actions-toolbar .bulk-btn:hover {
  background: var(--gray-700);
}

.bulk-actions-toolbar .bulk-btn.danger:hover {
  background: var(--error-600);
}

.bulk-actions-toolbar .bulk-btn-divider {
  width: 1px;
  height: 24px;
  background: var(--gray-600);
}

.bulk-actions-toolbar .bulk-close {
  background: transparent;
  border: none;
  color: var(--gray-400);
  padding: 4px;
  cursor: pointer;
  margin-left: 8px;
}

.bulk-actions-toolbar .bulk-close:hover {
  color: white;
}

/* ============================================
   Saved Views Sidebar
   ============================================ */
.saved-views-section {
  margin-top: 24px;
  padding-top: 16px;
  border-top: 1px solid var(--gray-200);
}

.saved-views-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 0 16px;
  margin-bottom: 8px;
}

.saved-views-header h4 {
  font-size: 12px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.05em;
  color: var(--gray-500);
  margin: 0;
}

.saved-views-header button {
  background: none;
  border: none;
  color: var(--primary-600);
  font-size: 18px;
  cursor: pointer;
  padding: 0;
  line-height: 1;
}

.saved-views-header button:hover {
  color: var(--primary-700);
}

.saved-view-item {
  display: flex;
  align-items: center;
  padding: 10px 16px;
  cursor: pointer;
  transition: background var(--transition-fast);
}

.saved-view-item:hover {
  background: var(--gray-100);
}

.saved-view-item.active {
  background: var(--primary-50);
  border-right: 3px solid var(--primary-500);
}

.saved-view-item .view-name {
  flex: 1;
  font-size: 14px;
  color: var(--gray-700);
}

.saved-view-item .view-default {
  font-size: 11px;
  background: var(--primary-100);
  color: var(--primary-700);
  padding: 2px 6px;
  border-radius: var(--radius-full);
  margin-left: 8px;
}

.saved-view-item .view-delete {
  opacity: 0;
  background: none;
  border: none;
  color: var(--gray-400);
  cursor: pointer;
  padding: 2px 6px;
  font-size: 16px;
  transition: opacity var(--transition-fast);
}

.saved-view-item:hover .view-delete {
  opacity: 1;
}

.saved-view-item .view-delete:hover {
  color: var(--error-500);
}

.empty-views {
  padding: 16px;
  text-align: center;
  color: var(--gray-400);
  font-size: 13px;
}

/* ============================================
   Completion Checklist Modal
   ============================================ */
.checklist-items {
  display: flex;
  flex-direction: column;
  gap: 12px;
}

.checklist-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: background var(--transition-fast);
}

.checklist-item:hover {
  background: var(--gray-100);
}

.checklist-item.required {
  border-left: 3px solid var(--error-500);
}

.checklist-checkbox {
  width: 20px;
  height: 20px;
  accent-color: var(--success-500);
  cursor: pointer;
  flex-shrink: 0;
  margin-top: 2px;
}

.checklist-text {
  flex: 1;
  font-size: 14px;
  color: var(--gray-700);
  line-height: 1.5;
}

.required-badge {
  display: inline-block;
  font-size: 11px;
  background: var(--error-100);
  color: var(--error-700);
  padding: 2px 6px;
  border-radius: var(--radius-full);
  margin-left: 8px;
  vertical-align: middle;
}

.completed-by {
  font-size: 12px;
  color: var(--gray-400);
  white-space: nowrap;
}

/* ============================================
   Keyboard Shortcuts Modal
   ============================================ */
.shortcuts-section {
  margin-bottom: 24px;
}

.shortcuts-section:last-child {
  margin-bottom: 0;
}

.shortcuts-section h4 {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin: 0 0 12px 0;
  padding-bottom: 8px;
  border-bottom: 1px solid var(--gray-200);
}

.shortcut {
  display: flex;
  align-items: center;
  padding: 8px 0;
  font-size: 14px;
  color: var(--gray-600);
}

.shortcut kbd {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 24px;
  height: 24px;
  padding: 0 6px;
  font-family: var(--font-mono);
  font-size: 12px;
  background: var(--gray-100);
  border: 1px solid var(--gray-300);
  border-radius: var(--radius-sm);
  box-shadow: 0 1px 0 var(--gray-300);
  margin-right: 8px;
}

/* Keyboard selection highlight */
.cases-table tbody tr.keyboard-selected {
  outline: 2px solid var(--primary-500);
  outline-offset: -2px;
  background: var(--primary-50);
}

/* ============================================
   User Management
   ============================================ */
.users-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.user-row {
  display: flex;
  align-items: center;
  padding: 12px 16px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  gap: 16px;
}

.user-row-info {
  flex: 1;
}

.user-row-name {
  font-weight: 500;
  color: var(--gray-900);
}

.user-row-meta {
  font-size: 13px;
  color: var(--gray-500);
  margin-top: 2px;
}

.user-row-status {
  font-size: 12px;
  padding: 4px 8px;
  border-radius: var(--radius-full);
}

.user-row-status.active {
  background: var(--success-50);
  color: var(--success-600);
}

.user-row-status.inactive {
  background: var(--gray-100);
  color: var(--gray-500);
}

.user-row-actions {
  display: flex;
  gap: 8px;
}

.btn-icon {
  background: none;
  border: none;
  padding: 4px 8px;
  font-size: 13px;
  color: var(--primary-600);
  cursor: pointer;
  border-radius: var(--radius-sm);
}

.btn-icon:hover {
  background: var(--primary-50);
}

.btn-icon.danger {
  color: var(--error-600);
}

.btn-icon.danger:hover {
  background: var(--error-50);
}

/* ============================================
   Recording Button - Beautiful Watch/Play Style
   ============================================ */
.btn-recording {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: linear-gradient(135deg, var(--primary-50) 0%, var(--sora-soft) 100%);
  border: 1px solid var(--primary-200);
  border-radius: 20px;
  color: var(--primary-700);
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
  white-space: nowrap;
}

.btn-recording:hover {
  background: linear-gradient(135deg, var(--primary-100) 0%, var(--sakura-soft) 100%);
  border-color: var(--primary-400);
  transform: translateY(-1px);
  box-shadow: 0 3px 10px rgba(99, 102, 241, 0.2);
}

.btn-recording svg {
  width: 14px;
  height: 14px;
  fill: currentColor;
}

.btn-recording-disabled {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 14px;
  background: var(--gray-100);
  border: 1px solid var(--gray-200);
  border-radius: 20px;
  color: var(--gray-400);
  font-size: 12px;
  font-weight: 500;
  cursor: not-allowed;
  white-space: nowrap;
}

.btn-recording-disabled svg {
  width: 14px;
  height: 14px;
  fill: currentColor;
  opacity: 0.5;
}

/* Table specific adjustments */
.issues-table td,
.sessions-table td,
.events-table td {
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
  max-width: 250px;
}

.issues-table td:first-child,
.sessions-table td:first-child,
.events-table td:first-child {
  font-family: 'SF Mono', 'Monaco', 'Consolas', monospace;
  font-size: 12px;
  color: var(--gray-600);
}

/* ============================================
   Assignment Queue Table
   ============================================ */
.queue-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.queue-table th {
  text-align: left;
  padding: 12px;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-200);
  font-weight: 600;
  color: var(--gray-600);
}

.queue-table td {
  padding: 12px;
  border-bottom: 1px solid var(--gray-100);
}

.queue-table tbody tr:hover {
  background: var(--gray-50);
}

/* ============================================
   Audit Log Table
   ============================================ */
.audit-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 13px;
}

.audit-table th {
  text-align: left;
  padding: 12px 16px;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-200);
  font-weight: 600;
  color: var(--gray-600);
  position: sticky;
  top: 0;
}

.audit-table td {
  padding: 10px 16px;
  border-bottom: 1px solid var(--gray-100);
  vertical-align: middle;
}

.audit-table tbody tr:hover {
  background: var(--gray-50);
}

.action-badge {
  display: inline-block;
  font-size: 11px;
  padding: 3px 8px;
  border-radius: var(--radius-full);
  font-weight: 500;
}

.action-badge.cases {
  background: var(--primary-100);
  color: var(--primary-700);
}

.action-badge.users {
  background: var(--warning-100);
  color: var(--warning-700);
}

.action-badge.views {
  background: var(--success-100);
  color: var(--success-700);
}

.action-badge.auth {
  background: var(--gray-100);
  color: var(--gray-700);
}

.action-badge.system {
  background: var(--error-100);
  color: var(--error-700);
}

/* ============================================
   Toast Notifications
   ============================================ */
#toastContainer {
  position: fixed;
  bottom: 24px;
  right: 24px;
  z-index: 1000;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.toast {
  padding: 12px 20px;
  border-radius: var(--radius-md);
  font-size: 14px;
  font-weight: 500;
  box-shadow: var(--shadow-lg);
  transform: translateX(100%);
  opacity: 0;
  transition: all var(--transition-normal);
}

.toast.show {
  transform: translateX(0);
  opacity: 1;
}

.toast-success {
  background: var(--success-500);
  color: white;
}

.toast-error {
  background: var(--error-500);
  color: white;
}

.toast-warning {
  background: var(--warning-500);
  color: white;
}

.toast-info {
  background: var(--primary-500);
  color: white;
}

/* ============================================
   Form Elements
   ============================================ */
.form-group {
  margin-bottom: 16px;
}

.form-group label {
  display: block;
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-700);
  margin-bottom: 6px;
}

.form-input {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius-md);
  background: white;
  transition: border-color var(--transition-fast), box-shadow var(--transition-fast);
}

.form-input:focus {
  outline: none;
  border-color: var(--primary-500);
  box-shadow: 0 0 0 3px var(--primary-100);
}

.form-input::placeholder {
  color: var(--gray-400);
}

.error-message {
  color: var(--error-600);
  font-size: 13px;
  margin-top: 8px;
  padding: 8px 12px;
  background: var(--error-50);
  border-radius: var(--radius-sm);
}

/* ============================================
   Buttons
   ============================================ */
.btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  border-radius: var(--radius-md);
  cursor: pointer;
  transition: all var(--transition-fast);
  border: none;
  gap: 8px;
}

.btn-primary {
  background: var(--primary-600);
  color: white;
}

.btn-primary:hover {
  background: var(--primary-700);
}

.btn-secondary {
  background: var(--gray-100);
  color: var(--gray-700);
}

.btn-secondary:hover {
  background: var(--gray-200);
}

.btn-success {
  background: var(--success-600);
  color: white;
}

.btn-success:hover {
  background: var(--success-700);
}

.btn-danger {
  background: var(--error-600);
  color: white;
}

.btn-danger:hover {
  background: var(--error-700);
}

.btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

/* ============================================
   Modal Styles
   ============================================ */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(26, 54, 93, 0.25);
  backdrop-filter: blur(8px);
  -webkit-backdrop-filter: blur(8px);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 200;
  padding: 24px;
  animation: overlayIn 0.2s ease;
}

@keyframes overlayIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.modal-overlay.active {
  display: flex;
}

.modal {
  background: rgba(255, 255, 255, 0.98);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: var(--radius-2xl);
  box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.15), 
              0 0 0 1px rgba(255, 255, 255, 0.6),
              inset 0 1px 0 rgba(255, 255, 255, 0.5);
  max-height: 90vh;
  overflow: hidden;
  display: flex;
  flex-direction: column;
  width: 100%;
  animation: modalIn 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

@keyframes modalIn {
  from {
    opacity: 0;
    transform: scale(0.92) translateY(10px);
  }
  to {
    opacity: 1;
    transform: scale(1) translateY(0);
  }
}

.modal-header {
  display: flex;
  align-items: center;
  justify-content: space-between;
  padding: 20px 24px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.9) 0%, rgba(248, 250, 252, 0.9) 100%);
  position: relative;
}

/* Subtle accent line under header */
.modal-header::after {
  content: '';
  position: absolute;
  bottom: 0;
  left: 0;
  right: 0;
  height: 1px;
  background: linear-gradient(90deg, transparent, var(--sakura), var(--sora), transparent);
  opacity: 0.4;
}

.modal-header-content {
  flex: 1;
}

.modal-title {
  font-size: 18px;
  font-weight: 700;
  font-family: var(--font-display);
  color: var(--gray-900);
}

.modal-close {
  background: none;
  border: none;
  font-size: 24px;
  color: var(--gray-400);
  cursor: pointer;
  padding: 0;
  line-height: 1;
  transition: color var(--transition-fast);
}

.modal-close:hover {
  color: var(--gray-600);
}

.modal-body {
  padding: 24px;
  overflow-y: auto;
}

/* ============================================
   Cases Table
   ============================================ */
.cases-table {
  width: 100%;
  border-collapse: collapse;
  font-size: 14px;
}

.cases-table th {
  text-align: left;
  padding: 12px 16px;
  background: var(--gray-50);
  border-bottom: 2px solid var(--gray-200);
  font-weight: 600;
  font-size: 11px;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--gray-500);
  white-space: nowrap;
}

.cases-table th:first-child {
  width: 40px;
  text-align: center;
}

.cases-table th input[type="checkbox"],
.cases-table td input[type="checkbox"] {
  width: 16px;
  height: 16px;
  cursor: pointer;
  accent-color: var(--brand-navy);
}

.cases-table td {
  padding: 12px 16px;
  border-bottom: 1px solid var(--gray-100);
  vertical-align: middle;
}

.cases-table tbody tr {
  cursor: pointer;
  transition: background var(--transition-fast);
}

.cases-table tbody tr:hover {
  background: var(--gray-50);
}

.case-checkbox {
  width: 18px;
  height: 18px;
  cursor: pointer;
  accent-color: var(--primary-500);
}

.case-id {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--gray-500);
}

.customer-info {
  display: flex;
  flex-direction: column;
}

.customer-name {
  font-weight: 500;
  color: var(--gray-900);
}

.customer-email {
  font-size: 12px;
  color: var(--gray-500);
  margin-top: 2px;
}

.time-ago {
  font-size: 13px;
  color: var(--gray-500);
}

/* ============================================
   Status & Type Badges
   ============================================ */
.status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 5px 12px;
  font-size: 12px;
  font-weight: 600;
  border-radius: var(--radius-full);
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.06);
}

/* Pulse dot for status */
.status-badge::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
  animation: pulseGlow 2s infinite;
}

/* Pending - Momo (peach) */
.status-badge.pending {
  background: linear-gradient(135deg, var(--momo-soft) 0%, rgba(255, 218, 185, 0.3) 100%);
  color: #9a5a2f;
  border: 1px solid rgba(255, 218, 185, 0.4);
}

/* In Progress - Sora (sky blue) */
.status-badge.in-progress {
  background: linear-gradient(135deg, var(--sora-soft) 0%, rgba(168, 216, 234, 0.3) 100%);
  color: #1e6091;
  border: 1px solid rgba(168, 216, 234, 0.4);
}

/* Completed - Matcha (green) */
.status-badge.completed {
  background: linear-gradient(135deg, var(--matcha-soft) 0%, rgba(200, 230, 201, 0.3) 100%);
  color: #2d6a4f;
  border: 1px solid rgba(200, 230, 201, 0.4);
}

/* Overdue - Sakura (pink) */
.status-badge.overdue {
  background: linear-gradient(135deg, var(--sakura-soft) 0%, rgba(255, 183, 197, 0.3) 100%);
  color: #9a2d4a;
  border: 1px solid rgba(255, 183, 197, 0.4);
}

.due-date {
  font-size: 13px;
  color: var(--gray-600);
}

.resolution-text {
  font-size: 13px;
  color: var(--gray-700);
  max-width: 300px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.type-badge {
  display: inline-flex;
  align-items: center;
  padding: 5px 12px;
  font-size: 12px;
  font-weight: 600;
  border-radius: var(--radius-full);
  text-transform: capitalize;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.05);
}

/* Shipping - Sora (sky blue) */
.type-badge.shipping {
  background: linear-gradient(135deg, var(--sora-soft) 0%, rgba(168, 216, 234, 0.3) 100%);
  color: #1e6091;
  border: 1px solid rgba(168, 216, 234, 0.4);
}

/* Refund - Sakura (pink) */
.type-badge.refund {
  background: linear-gradient(135deg, var(--sakura-soft) 0%, rgba(255, 183, 197, 0.3) 100%);
  color: #9a2d4a;
  border: 1px solid rgba(255, 183, 197, 0.4);
}

/* Subscription - Fuji (lavender) */
.type-badge.subscription {
  background: linear-gradient(135deg, var(--fuji-soft) 0%, rgba(232, 213, 232, 0.3) 100%);
  color: #6b4c7a;
  border: 1px solid rgba(232, 213, 232, 0.4);
}

/* Manual - Kinari (cream) */
.type-badge.manual {
  background: linear-gradient(135deg, rgba(255, 248, 231, 0.5) 0%, rgba(255, 248, 231, 0.8) 100%);
  color: var(--gray-600);
  border: 1px solid rgba(0, 0, 0, 0.08);
}

/* Return - Momo (peach) */
.type-badge.return {
  background: linear-gradient(135deg, var(--momo-soft) 0%, rgba(255, 218, 185, 0.3) 100%);
  color: #9a5a2f;
  border: 1px solid rgba(255, 218, 185, 0.4);
}

/* Role Badges */
.type-badge.super-admin {
  background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
  color: white;
  font-weight: 700;
  border: none;
}

.type-badge.admin {
  background: linear-gradient(135deg, #2563eb 0%, #3b82f6 100%);
  color: white;
  border: none;
}

.type-badge.user {
  background: linear-gradient(135deg, #6b7280 0%, #9ca3af 100%);
  color: white;
  border: none;
}

/* ============================================
   Actor Badges (Event Log)
   ============================================ */
.actor-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 4px 10px;
  border-radius: 16px;
  font-size: 12px;
  font-weight: 500;
}

.actor-badge.actor-team {
  background: linear-gradient(135deg, rgba(26, 54, 93, 0.1) 0%, rgba(26, 54, 93, 0.05) 100%);
  color: var(--brand-navy);
  border: 1px solid rgba(26, 54, 93, 0.15);
}

.actor-badge.actor-customer {
  background: linear-gradient(135deg, rgba(168, 216, 234, 0.2) 0%, rgba(168, 216, 234, 0.1) 100%);
  color: #1e6091;
  border: 1px solid rgba(168, 216, 234, 0.3);
}

.actor-avatar {
  display: flex;
  align-items: center;
  justify-content: center;
  width: 20px;
  height: 20px;
  border-radius: 50%;
  background: var(--brand-navy);
  color: white;
  font-size: 9px;
  font-weight: 700;
  letter-spacing: -0.02em;
}

.actor-icon {
  width: 14px;
  height: 14px;
  opacity: 0.8;
}

.actor-name {
  white-space: nowrap;
}

/* ============================================
   Empty States
   ============================================ */
.empty-state {
  text-align: center;
  padding: 48px 24px;
  color: var(--gray-500);
}

.empty-state-icon {
  font-size: 48px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.empty-state-title {
  font-size: 16px;
  font-weight: 500;
  color: var(--gray-700);
  margin-bottom: 8px;
}

.empty-state-text {
  font-size: 14px;
  color: var(--gray-500);
}

/* ============================================
   Pagination (Legacy - now uses .pagination-btn)
   ============================================ */
/* Styles moved to unified .pagination section below */

/* ============================================
   Admin-only Elements
   ============================================ */
.admin-only {
  display: none;
}

/* ============================================
   Loading Indicator
   ============================================ */
.loading-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(255, 255, 255, 0.8);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 500;
}

.loading-overlay.active {
  display: flex;
}

/* Modern Loading Spinner */
.loading-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 40px;
}

.spinner {
  position: relative;
  width: 44px;
  height: 44px;
}

.spinner::before {
  content: '';
  position: absolute;
  inset: 0;
  border-radius: 50%;
  border: 3px solid transparent;
  border-top-color: var(--brand-navy);
  border-right-color: rgba(26, 54, 93, 0.3);
  animation: spinner-rotate 0.9s cubic-bezier(0.4, 0, 0.2, 1) infinite;
}

.spinner::after {
  content: '';
  position: absolute;
  inset: 6px;
  border-radius: 50%;
  border: 2px solid transparent;
  border-top-color: var(--sora);
  border-left-color: rgba(168, 216, 234, 0.4);
  animation: spinner-rotate 0.6s cubic-bezier(0.4, 0, 0.2, 1) infinite reverse;
}

@keyframes spinner-rotate {
  0% {
    transform: rotate(0deg);
  }
  100% {
    transform: rotate(360deg);
  }
}

/* Alternative dot spinner for inline use */
.loading-dots {
  display: inline-flex;
  align-items: center;
  gap: 4px;
}

.loading-dots span {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--brand-navy);
  animation: dot-pulse 1.4s ease-in-out infinite;
}

.loading-dots span:nth-child(1) { animation-delay: 0s; }
.loading-dots span:nth-child(2) { animation-delay: 0.2s; }
.loading-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes dot-pulse {
  0%, 80%, 100% {
    opacity: 0.3;
    transform: scale(0.8);
  }
  40% {
    opacity: 1;
    transform: scale(1);
  }
}

/* Full page loading overlay */
.loading-overlay {
  position: fixed;
  inset: 0;
  background: rgba(255, 255, 255, 0.85);
  backdrop-filter: blur(4px);
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 16px;
  z-index: 9999;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.2s ease, visibility 0.2s ease;
}

.loading-overlay.active {
  opacity: 1;
  visibility: visible;
}

.loading-overlay .spinner {
  width: 56px;
  height: 56px;
}

.loading-overlay .spinner::before {
  border-width: 4px;
}

.loading-overlay .spinner::after {
  inset: 8px;
  border-width: 3px;
}

.loading-text {
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-600);
  letter-spacing: 0.02em;
}

/* ============================================
   Responsive Adjustments
   ============================================ */
@media (max-width: 768px) {
  .bulk-actions-toolbar {
    left: 16px;
    right: 16px;
    transform: none;
    flex-wrap: wrap;
  }

  .modal {
    margin: 16px;
  }

  .cases-table {
    font-size: 13px;
  }

  .cases-table th,
  .cases-table td {
    padding: 10px 12px;
  }

  #toastContainer {
    left: 16px;
    right: 16px;
    bottom: 16px;
  }
}

/* ============================================
   Status Cards in Case Modal
   ============================================ */
.status-cards {
  display: flex;
  gap: 12px;
  margin-bottom: 24px;
}

.status-card {
  flex: 1;
  padding: 12px 16px;
  border: 2px solid var(--gray-200);
  border-radius: var(--radius-md);
  text-align: center;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.status-card:hover {
  border-color: var(--gray-300);
  background: var(--gray-50);
}

.status-card.active {
  border-color: var(--primary-500);
  background: var(--primary-50);
}

.status-card.pending.active {
  border-color: var(--warning-500);
  background: var(--warning-50);
}

.status-card.in-progress.active {
  border-color: var(--primary-500);
  background: var(--primary-50);
}

.status-card.completed.active {
  border-color: var(--success-500);
  background: var(--success-50);
}

.status-card-label {
  font-size: 12px;
  font-weight: 500;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.status-card-value {
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-900);
  margin-top: 4px;
}

/* ============================================
   Deep Link Copy Button
   ============================================ */
.copy-link-btn {
  background: none;
  border: none;
  color: var(--gray-400);
  cursor: pointer;
  padding: 4px;
  border-radius: var(--radius-sm);
  transition: all var(--transition-fast);
}

.copy-link-btn:hover {
  color: var(--primary-600);
  background: var(--primary-50);
}

/* ============================================
   Search Input Enhancements
   ============================================ */
.search-container {
  position: relative;
}

.search-input {
  width: 100%;
  padding: 10px 12px 10px 40px;
  font-size: 14px;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  background: white;
  transition: all var(--transition-fast);
}

.search-input:focus {
  outline: none;
  border-color: var(--primary-500);
  box-shadow: 0 0 0 3px var(--primary-100);
}

.search-icon {
  position: absolute;
  left: 12px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--gray-400);
  pointer-events: none;
}

.search-shortcut {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  font-size: 11px;
  color: var(--gray-400);
  background: var(--gray-100);
  padding: 2px 6px;
  border-radius: var(--radius-sm);
}

/* ============================================
   Mobile Responsive Styles
   ============================================ */

/* Tablet and below (max-width: 1024px) */
@media (max-width: 1024px) {
  .bulk-actions-toolbar {
    left: 16px;
    right: 16px;
    transform: none;
    flex-wrap: wrap;
    gap: 8px;
  }

  .bulk-actions-toolbar .btn {
    padding: 8px 12px;
    font-size: 12px;
  }

  .saved-views-sidebar {
    width: 280px;
  }
}

/* Mobile (max-width: 768px) */
@media (max-width: 768px) {
  /* Sidebar toggle for mobile */
  .sidebar {
    position: fixed;
    z-index: 100;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .sidebar.mobile-open {
    transform: translateX(0);
  }

  .main-content {
    margin-left: 0;
  }

  /* Mobile header with menu button */
  .mobile-header {
    display: flex;
    align-items: center;
    padding: 12px 16px;
    background: white;
    border-bottom: 1px solid var(--gray-200);
  }

  .mobile-menu-btn {
    display: flex;
    align-items: center;
    justify-content: center;
    width: 40px;
    height: 40px;
    border: none;
    background: var(--gray-100);
    border-radius: var(--radius-md);
    cursor: pointer;
  }

  /* Bulk actions mobile */
  .bulk-actions-toolbar {
    bottom: 16px;
    left: 8px;
    right: 8px;
    padding: 10px 12px;
    gap: 8px;
  }

  .bulk-actions-toolbar .selected-count {
    font-size: 13px;
    width: 100%;
    text-align: center;
    margin-bottom: 4px;
  }

  .bulk-actions-toolbar .btn {
    flex: 1;
    min-width: 0;
    padding: 8px;
    font-size: 11px;
  }

  .bulk-actions-toolbar .btn svg {
    display: none;
  }

  /* Cases filters mobile */
  .cases-filters {
    flex-direction: column;
    gap: 8px !important;
  }

  .cases-filters select,
  .cases-filters .search-input-wrapper {
    width: 100% !important;
    max-width: none !important;
  }

  /* Table mobile - horizontal scroll */
  .cases-table {
    display: block;
    overflow-x: auto;
    -webkit-overflow-scrolling: touch;
  }

  .cases-table th,
  .cases-table td {
    min-width: 100px;
    white-space: nowrap;
  }

  /* Modal mobile */
  .modal-overlay {
    padding: 8px;
  }

  .modal {
    border-radius: 12px;
    max-height: 95vh;
  }

  .modal-header {
    padding: 16px;
  }

  .modal-title {
    font-size: 18px;
  }

  .modal-nav {
    gap: 4px;
  }

  .nav-arrow,
  .copy-url-btn {
    width: 32px;
    height: 32px;
  }

  .modal-close {
    width: 32px;
    height: 32px;
    font-size: 20px;
  }

  .modal-grid {
    grid-template-columns: 1fr;
  }

  .modal-main {
    padding: 16px;
    border-right: none;
    border-bottom: 1px solid var(--gray-100);
  }

  .modal-sidebar {
    padding: 16px;
  }

  /* Status cards stack on mobile */
  .status-cards {
    flex-direction: column;
    gap: 8px;
  }

  .status-card {
    padding: 12px;
  }

  /* Info grid mobile */
  .info-grid {
    grid-template-columns: 1fr;
    gap: 8px;
  }

  .info-card {
    padding: 12px;
  }

  /* Saved views sidebar mobile */
  .saved-views-sidebar {
    position: fixed;
    left: 0;
    top: 0;
    bottom: 0;
    width: 100%;
    max-width: 320px;
    z-index: 150;
    transform: translateX(-100%);
    transition: transform 0.3s ease;
  }

  .saved-views-sidebar.mobile-open {
    transform: translateX(0);
  }

  /* Keyboard shortcuts hide on mobile */
  .keyboard-shortcuts-modal {
    display: none !important;
  }

  /* Toast positioning mobile */
  #toastContainer {
    left: 16px;
    right: 16px;
    bottom: 16px;
  }

  .toast {
    max-width: none;
  }

  /* Stats grid mobile */
  .stats-grid {
    grid-template-columns: 1fr;
    gap: 8px;
  }

  .stat-card {
    padding: 12px 16px;
  }

  /* Quick actions mobile */
  .quick-actions {
    gap: 8px;
  }

  .quick-action-btn {
    padding: 12px;
    font-size: 13px;
  }

  /* Timeline mobile */
  .timeline-item {
    padding: 12px;
  }

  .timeline-content {
    font-size: 13px;
  }
}

/* Small mobile (max-width: 480px) */
@media (max-width: 480px) {
  .modal-meta {
    flex-wrap: wrap;
    gap: 8px;
  }

  .modal-case-id {
    font-size: 11px;
  }

  .type-badge,
  .status-badge {
    font-size: 11px;
  }
}

/* ============================================
   ANALYTICS DASHBOARD - PREMIUM STYLING
   ============================================ */

/* Enhanced Stats Grid */
.stats-grid {
  display: grid;
  grid-template-columns: repeat(4, 1fr);
  gap: 20px;
  margin-bottom: 32px;
}

/* Premium Stat Cards */
.stat-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 20px;
  padding: 24px;
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 8px 24px rgba(0, 0, 0, 0.06), 0 2px 8px rgba(0, 0, 0, 0.04);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  position: relative;
  overflow: hidden;
}

.stat-card::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  height: 3px;
  background: linear-gradient(90deg, var(--brand-navy) 0%, var(--brand-navy-light) 100%);
  opacity: 0;
  transition: opacity 0.3s ease;
}

.stat-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 32px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.06);
}

.stat-card:hover::before {
  opacity: 1;
}

.stat-card.highlight {
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.98) 0%, rgba(255, 255, 255, 0.95) 100%);
  border: 2px solid;
  box-shadow: 0 10px 28px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.05);
}

.stat-card.highlight::before {
  opacity: 1;
  height: 4px;
}

/* Stat Card Content - Value first, then label below */
.stat-value {
  font-size: 36px;
  font-weight: 700;
  font-family: var(--font-display);
  color: var(--gray-900);
  line-height: 1.2;
  margin-bottom: 4px;
  -webkit-text-fill-color: var(--gray-900);
}

.stat-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-500);
  letter-spacing: 0.02em;
  margin-bottom: 8px;
  display: flex;
  align-items: center;
  gap: 8px;
}

.stat-change {
  font-size: 12px;
  color: var(--gray-500);
  font-weight: 500;
  margin-top: 4px;
}

/* Urgent stat change - red color for "Needs attention" */
.stat-change.urgent {
  color: #DC2626;
  font-weight: 600;
}

/* Highlight Pending Card - Navy background with white text */
.stat-card.highlight-pending {
  background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
  border: none;
  box-shadow: 0 12px 32px rgba(26, 54, 93, 0.25), 0 4px 12px rgba(26, 54, 93, 0.15);
}

.stat-card.highlight-pending::before {
  opacity: 0;
}

.stat-card.highlight-pending .stat-value {
  color: white;
  -webkit-text-fill-color: white;
}

.stat-card.highlight-pending .stat-label {
  color: rgba(255, 255, 255, 0.8);
}

.stat-card.highlight-pending .stat-change {
  color: rgba(255, 255, 255, 0.7);
}

.stat-card.highlight-pending .stat-change.urgent {
  color: #FCA5A5;
  font-weight: 600;
}

/* Special Highlight Cards */
.stat-card.highlight[style*="background: #1a365d"] {
  background: linear-gradient(135deg, #1a365d 0%, #2c5282 100%);
  color: white;
  border: none;
  box-shadow: 0 12px 32px rgba(26, 54, 93, 0.25), 0 4px 12px rgba(26, 54, 93, 0.15);
}

.stat-card.highlight[style*="background: #1a365d"] .stat-label,
.stat-card.highlight[style*="background: #1a365d"] .stat-value,
.stat-card.highlight[style*="background: #1a365d"] .stat-change {
  color: rgba(255, 255, 255, 0.95);
  -webkit-text-fill-color: rgba(255, 255, 255, 0.95);
  background: none;
}

.stat-card.highlight[style*="background: #FEF3C7"] {
  background: linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%);
  border-color: #FCD34D;
}

/* Yellow card - Pending Cases */
.stat-card.highlight[style*="FEF3C7"] .stat-label,
.stat-card.highlight[style*="FEF3C7"] .stat-value,
.stat-card.highlight[style*="FEF3C7"] .stat-change {
  color: #78350F !important; /* Dark amber for contrast */
}

.stat-card.highlight[style*="FEF3C7"] .stat-value {
  color: #92400E !important; /* Dark amber for contrast */
  font-weight: 800;
}

.stat-card.highlight[style*="FEF3C7"] .stat-label {
  font-weight: 700;
}

.stat-card.highlight[style*="FEF3C7"] .stat-change {
  color: #B45309 !important; /* Medium amber for contrast */
  font-weight: 600;
}

/* Green card - Completed, SLA Compliance */
.stat-card.highlight[style*="D1FAE5"] {
  background: linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%);
  border-color: #10B981;
}

.stat-card.highlight[style*="D1FAE5"] .stat-label,
.stat-card.highlight[style*="D1FAE5"] .stat-value,
.stat-card.highlight[style*="D1FAE5"] .stat-change {
  color: #065F46 !important; /* Dark green for contrast */
}

.stat-card.highlight[style*="D1FAE5"] .stat-value {
  color: #047857 !important; /* Dark green for contrast */
  font-weight: 800;
}

.stat-card.highlight[style*="D1FAE5"] .stat-label {
  font-weight: 700;
}

.stat-card.highlight[style*="D1FAE5"] .stat-change {
  color: #059669 !important; /* Medium green for contrast */
  font-weight: 600;
}

/* Pink card - Refunds (30d) */
.stat-card.highlight[style*="FCE7F3"] {
  background: linear-gradient(135deg, #FCE7F3 0%, #FBCFE8 100%);
  border-color: #F9A8D4;
}

.stat-card.highlight[style*="FCE7F3"] .stat-label,
.stat-card.highlight[style*="FCE7F3"] .stat-value,
.stat-card.highlight[style*="FCE7F3"] .stat-change {
  color: #831843 !important; /* Dark pink for contrast */
}

.stat-card.highlight[style*="FCE7F3"] .stat-value {
  color: #9F1239 !important; /* Dark pink for contrast */
  font-weight: 800;
}

.stat-card.highlight[style*="FCE7F3"] .stat-label {
  font-weight: 700;
}

.stat-card.highlight[style*="FCE7F3"] .stat-change {
  color: #BE185D !important; /* Medium pink for contrast */
  font-weight: 600;
}

/* Red card - Root Cause Categories */
.stat-card.highlight[style*="FEE2E2"] {
  background: linear-gradient(135deg, #FEE2E2 0%, #FECACA 100%);
  border-color: #FCA5A5;
}

.stat-card.highlight[style*="FEE2E2"] .stat-label,
.stat-card.highlight[style*="FEE2E2"] .stat-value,
.stat-card.highlight[style*="FEE2E2"] .stat-change {
  color: #991B1B !important; /* Dark red for contrast */
}

.stat-card.highlight[style*="FEE2E2"] .stat-value {
  color: #B91C1C !important; /* Dark red for contrast */
  font-weight: 800;
}

.stat-card.highlight[style*="FEE2E2"] .stat-label {
  font-weight: 700;
}

.stat-card.highlight[style*="FEE2E2"] .stat-change {
  color: #DC2626 !important; /* Medium red for contrast */
  font-weight: 600;
}

/* ============================================
   Filter & Search Enhancements
   ============================================ */
.filter-select {
  padding: 10px 16px;
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-700);
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  cursor: pointer;
  transition: all var(--transition-fast);
  min-width: 140px;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 12 12'%3E%3Cpath fill='%236b7280' d='M6 9L1 4h10z'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 12px center;
  padding-right: 36px;
}

.filter-select:hover {
  border-color: var(--primary-500);
  box-shadow: 0 0 0 3px var(--primary-50);
}

.filter-select:focus {
  outline: none;
  border-color: var(--primary-500);
  box-shadow: 0 0 0 3px var(--primary-100);
}

/* Enhanced Search with Dropdown */
.search-box {
  position: relative;
}

.search-box input {
  padding-right: 40px;
}

#clearSearchBtn {
  position: absolute;
  right: 12px;
  top: 50%;
  transform: translateY(-50%);
  display: flex;
  align-items: center;
  justify-content: center;
}

#clearSearchBtn:hover {
  color: var(--gray-600);
}

.search-dropdown {
  position: absolute;
  top: calc(100% + 8px);
  left: 0;
  right: 0;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.1), 0 4px 12px rgba(0, 0, 0, 0.05);
  max-height: 400px;
  overflow-y: auto;
  z-index: 1000;
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.search-dropdown-item {
  padding: 12px 16px;
  cursor: pointer;
  border-bottom: 1px solid var(--gray-100);
  transition: background-color var(--transition-fast);
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.search-dropdown-item:last-child {
  border-bottom: none;
}

.search-dropdown-item:hover,
.search-dropdown-item.selected {
  background: var(--primary-50);
}

.search-dropdown-item-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-weight: 600;
  color: var(--gray-900);
  font-size: 14px;
}

.search-dropdown-item-meta {
  font-size: 12px;
  color: var(--gray-600);
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.search-dropdown-item-highlight {
  background: #FEF3C7;
  padding: 0 2px;
  border-radius: 2px;
  font-weight: 600;
}

.search-dropdown-empty {
  padding: 24px;
  text-align: center;
  color: var(--gray-500);
  font-size: 14px;
}

.search-dropdown-loading {
  padding: 24px;
  text-align: center;
  color: var(--gray-500);
  font-size: 14px;
}

/* Unified Search Dropdown Styles */
.search-dropdown-section-title {
  padding: 8px 16px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--gray-500);
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-100);
}

.search-dropdown-item {
  display: flex;
  align-items: flex-start;
  gap: 12px;
  padding: 12px 16px;
  cursor: pointer;
  transition: background 0.15s ease;
  border-bottom: 1px solid var(--gray-100);
}

.search-dropdown-item:last-child {
  border-bottom: none;
}

.search-dropdown-item:hover,
.search-dropdown-item.selected {
  background: var(--gray-50);
}

.search-dropdown-item-icon {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.search-dropdown-item-content {
  flex: 1;
  min-width: 0;
}

.search-dropdown-item-header {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-900);
}

.search-dropdown-item-meta {
  font-size: 12px;
  color: var(--gray-500);
  margin-top: 4px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

.search-dropdown-item-highlight {
  background: var(--warning-100);
  color: var(--warning-700);
  padding: 0 2px;
  border-radius: 2px;
}

/* Active Filter Indicators */
.filter-select:not([value=""]) {
  border-color: var(--primary-500);
  background-color: var(--primary-50);
}

/* Enhanced Chart Cards */
#analyticsView .cases-card {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 24px;
  border: 1px solid rgba(255, 255, 255, 0.8);
  box-shadow: 0 10px 30px rgba(0, 0, 0, 0.08), 0 4px 12px rgba(0, 0, 0, 0.04);
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
  overflow: hidden;
}

#analyticsView .cases-card:hover {
  transform: translateY(-2px);
  box-shadow: 0 15px 40px rgba(0, 0, 0, 0.12), 0 6px 16px rgba(0, 0, 0, 0.06);
}

#analyticsView .cases-header {
  background: linear-gradient(135deg, rgba(249, 250, 251, 0.8) 0%, rgba(255, 255, 255, 0.9) 100%);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-bottom: 1px solid rgba(229, 231, 235, 0.8);
  padding: 20px 28px;
}

#analyticsView .cases-title {
  font-size: 18px;
  font-weight: 700;
  font-family: var(--font-display);
  color: var(--gray-900);
  background: linear-gradient(135deg, var(--gray-900) 0%, var(--gray-700) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

/* Enhanced Chart Styling */
#analyticsView svg {
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.05));
}

#analyticsView svg polyline {
  filter: drop-shadow(0 2px 4px rgba(0, 0, 0, 0.1));
  stroke-linecap: round;
  stroke-linejoin: round;
}

/* List Items Styling */
#analyticsView [id^="analytics"] > div {
  padding: 12px 0;
  border-bottom: 1px solid rgba(229, 231, 235, 0.6);
  transition: all 0.2s ease;
}

#analyticsView [id^="analytics"] > div:hover {
  background: rgba(249, 250, 251, 0.5);
  padding-left: 8px;
  border-radius: 8px;
  margin: 0 -8px;
  padding-right: 8px;
}

#analyticsView [id^="analytics"] > div:last-child {
  border-bottom: none;
}

/* Date Range Selector */
#analyticsDateRange {
  padding: 8px 16px;
  border: 1.5px solid var(--gray-300);
  border-radius: 12px;
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-700);
  background: white;
  cursor: pointer;
  transition: all 0.2s ease;
  font-family: var(--font-sans);
}

#analyticsDateRange:hover {
  border-color: var(--brand-navy-light);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

#analyticsDateRange:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.15);
}

/* Responsive Analytics */
@media (max-width: 1200px) {
  .stats-grid {
    grid-template-columns: repeat(2, 1fr);
  }
  
  #analyticsView .cases-card {
    grid-column: span 2;
  }
}

@media (max-width: 768px) {
  .stats-grid {
    grid-template-columns: 1fr;
  }
  
  #analyticsView .cases-card {
    grid-column: span 1;
  }
  
  .stat-card {
    padding: 20px;
  }
  
  .stat-value {
    font-size: 28px;
  }

  .btn {
    padding: 8px 12px;
    font-size: 13px;
  }

  .btn-sm {
    padding: 6px 10px;
    font-size: 12px;
  }

  /* Hide less important columns on small screens */
  .cases-table .time-ago-col,
  .cases-table td:nth-child(8),
  .cases-table th:nth-child(8) {
    display: none;
  }

  /* Checklist modal mobile */
  .checklist-item {
    padding: 10px;
  }

  .checklist-item label {
    font-size: 13px;
  }
}

/* ============================================
   SOP Links & Email Templates Pages
   ============================================ */

/* Category Tabs */
button.sop-tab,
button.template-tab {
  padding: 10px 20px !important;
  border: 2px solid var(--gray-200) !important;
  border-radius: 24px !important;
  background: white !important;
  color: var(--gray-600) !important;
  font-size: 14px !important;
  font-weight: 600 !important;
  cursor: pointer !important;
  transition: all 0.2s ease !important;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.04) !important;
  font-family: inherit !important;
}

button.sop-tab:hover,
button.template-tab:hover {
  border-color: var(--brand-navy) !important;
  color: var(--brand-navy) !important;
  background: var(--gray-50) !important;
  transform: translateY(-1px) !important;
}

button.sop-tab.active,
button.template-tab.active {
  background: var(--brand-navy) !important;
  border-color: var(--brand-navy) !important;
  color: white !important;
  box-shadow: 0 2px 8px rgba(30, 41, 59, 0.25) !important;
}

button.sop-tab:focus,
button.template-tab:focus {
  outline: none !important;
  box-shadow: 0 0 0 3px rgba(30, 41, 59, 0.15) !important;
}

/* SOP Card */
.sop-card {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  transition: all 0.2s ease;
}

.sop-card:hover {
  border-color: var(--brand-navy-light);
  box-shadow: var(--shadow-md);
}

.sop-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 12px;
}

.sop-card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-900);
  margin: 0;
}

.sop-card-category {
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.sop-card-category.refund { background: #FEE2E2; color: #DC2626; }
.sop-card-category.return { background: #FEF3C7; color: #D97706; }
.sop-card-category.shipping { background: #DBEAFE; color: #2563EB; }
.sop-card-category.subscription { background: #D1FAE5; color: #059669; }
.sop-card-category.manual { background: #E5E7EB; color: #374151; }

.sop-card-description {
  font-size: 14px;
  color: var(--gray-600);
  margin-bottom: 16px;
  line-height: 1.5;
}

.sop-card-actions {
  display: flex;
  gap: 8px;
}

.sop-card-link {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  background: var(--brand-navy);
  color: white;
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  text-decoration: none;
  transition: all 0.2s ease;
}

.sop-card-link:hover {
  background: var(--brand-navy-light);
}

/* Email Template Card */
.template-card {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  padding: 20px;
  margin-bottom: 16px;
  transition: all 0.2s ease;
}

.template-card:hover {
  border-color: var(--brand-navy-light);
  box-shadow: var(--shadow-md);
}

.template-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 8px;
}

.template-card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-900);
  margin: 0;
}

.template-card-subject {
  font-size: 14px;
  color: var(--gray-700);
  margin-bottom: 8px;
  font-weight: 500;
}

.template-card-preview {
  font-size: 13px;
  color: var(--gray-500);
  margin-bottom: 12px;
  line-height: 1.5;
  max-height: 60px;
  overflow: hidden;
  display: -webkit-box;
  -webkit-line-clamp: 3;
  -webkit-box-orient: vertical;
}

.template-card-variables {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
  margin-bottom: 16px;
}

.template-variable {
  padding: 2px 8px;
  background: var(--gray-100);
  border-radius: 4px;
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--gray-600);
}

.template-card-actions {
  display: flex;
  gap: 8px;
}

/* ============================================
   Case Detail Page - Premium Japanese Design
   ============================================ */

.case-detail-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  margin-bottom: 28px;
  padding-bottom: 24px;
  border-bottom: 1px solid rgba(0, 0, 0, 0.06);
  position: relative;
  animation: fadeInDown 0.4s ease;
}

.case-detail-title {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.case-detail-customer-name {
  font-family: var(--font-display);
  font-size: 28px;
  font-weight: 700;
  color: var(--gray-900);
  display: flex;
  align-items: center;
  gap: 12px;
}

.case-detail-email-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  color: var(--gray-500);
}

.case-detail-email-row a {
  color: var(--gray-600);
  text-decoration: none;
}

.case-detail-email-row a:hover {
  color: var(--brand-navy);
  text-decoration: underline;
}

.case-detail-id-row {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 12px;
  color: var(--gray-400);
  font-family: var(--font-mono);
}

.copy-btn {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  width: 24px;
  height: 24px;
  padding: 0;
  background: var(--gray-100);
  border: 1px solid var(--gray-200);
  border-radius: 6px;
  color: var(--gray-500);
  cursor: pointer;
  transition: all 0.2s ease;
}

.copy-btn:hover {
  background: var(--gray-200);
  color: var(--brand-navy);
}

.copy-btn.copied {
  background: var(--success-100);
  border-color: var(--success-200);
  color: var(--success-600);
}

.copy-btn svg {
  width: 14px;
  height: 14px;
}

/* Case Navigation */
.case-nav-buttons {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 16px;
}

.case-nav-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-600);
  cursor: pointer;
  transition: all 0.2s ease;
  text-decoration: none;
}

.case-nav-btn:hover {
  background: var(--gray-50);
  border-color: var(--brand-navy);
  color: var(--brand-navy);
}

.case-nav-btn:disabled {
  opacity: 0.5;
  cursor: not-allowed;
}

.case-nav-btn:disabled:hover {
  background: white;
  border-color: var(--gray-200);
  color: var(--gray-600);
}

.case-nav-btn svg {
  width: 16px;
  height: 16px;
}

.case-nav-divider {
  width: 1px;
  height: 24px;
  background: var(--gray-200);
  margin: 0 4px;
}

/* Status Radio Buttons */
.status-radio-group {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.status-radio-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: var(--radius-lg);
  cursor: pointer;
  transition: all 0.2s ease;
}

.status-radio-item:hover {
  border-color: var(--gray-300);
  background: var(--gray-50);
}

.status-radio-item.selected {
  border-color: var(--brand-navy);
  background: var(--primary-50);
}

.status-radio-item input[type="radio"] {
  display: none;
}

.status-radio-check {
  width: 20px;
  height: 20px;
  border: 2px solid var(--gray-300);
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  transition: all 0.2s ease;
  flex-shrink: 0;
}

.status-radio-item.selected .status-radio-check {
  border-color: var(--brand-navy);
  background: var(--brand-navy);
}

.status-radio-check::after {
  content: '';
  width: 8px;
  height: 8px;
  background: white;
  border-radius: 50%;
  opacity: 0;
  transition: opacity 0.2s ease;
}

.status-radio-item.selected .status-radio-check::after {
  opacity: 1;
}

.status-radio-label {
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-700);
}

.status-radio-item.selected .status-radio-label {
  color: var(--brand-navy);
  font-weight: 600;
}

/* Status indicator colors */
.status-radio-item[data-status="pending"] .status-radio-check {
  border-color: var(--warning-500);
}
.status-radio-item[data-status="pending"].selected .status-radio-check {
  background: var(--warning-500);
}

.status-radio-item[data-status="in_progress"] .status-radio-check {
  border-color: var(--info);
}
.status-radio-item[data-status="in_progress"].selected .status-radio-check {
  background: var(--info);
}

.status-radio-item[data-status="completed"] .status-radio-check {
  border-color: var(--success-500);
}
.status-radio-item[data-status="completed"].selected .status-radio-check {
  background: var(--success-500);
}

.case-detail-id {
  font-family: var(--font-mono);
  font-size: 20px;
  font-weight: 700;
  color: var(--gray-900);
  background: linear-gradient(135deg, var(--gray-900) 0%, var(--brand-navy) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
}

.case-detail-due {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 14px;
  font-weight: 500;
  padding: 6px 12px;
  border-radius: var(--radius-full);
  background: var(--gray-50);
}

.case-detail-due.overdue {
  color: var(--error-600);
  background: var(--sakura-soft);
}

.case-detail-due.warning {
  color: var(--warning-600);
  background: var(--momo-soft);
}

.case-detail-due.ok {
  color: var(--success-600);
  background: var(--matcha-soft);
}

.case-detail-grid {
  display: grid;
  grid-template-columns: 2fr 1fr;
  gap: 28px;
}

.case-detail-main {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

.case-detail-sidebar {
  display: flex;
  flex-direction: column;
  gap: 24px;
}

/* Glass card sections */
.case-detail-section {
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.6);
  border-radius: var(--radius-xl);
  overflow: hidden;
  box-shadow: 0 8px 32px rgba(0, 0, 0, 0.06), 0 0 0 1px rgba(255, 255, 255, 0.5);
  transition: all 0.3s ease;
  animation: slideUpCard 0.4s ease backwards;
}

.case-detail-section:nth-child(1) { animation-delay: 0.1s; }
.case-detail-section:nth-child(2) { animation-delay: 0.15s; }
.case-detail-section:nth-child(3) { animation-delay: 0.2s; }
.case-detail-section:nth-child(4) { animation-delay: 0.25s; }

.case-detail-section:hover {
  box-shadow: 0 12px 40px rgba(0, 0, 0, 0.08), 0 0 0 1px rgba(255, 255, 255, 0.7);
}

.case-detail-section-header {
  padding: 18px 24px;
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.9) 0%, rgba(255, 255, 255, 0.7) 100%);
  border-bottom: 1px solid rgba(0, 0, 0, 0.04);
  font-size: 15px;
  font-weight: 700;
  color: var(--gray-800);
  font-family: var(--font-display);
  display: flex;
  align-items: center;
  gap: 10px;
}

.case-detail-section-content {
  padding: 24px;
}

/* Info Row */
.case-info-row {
  display: flex;
  padding: 12px 0;
  border-bottom: 1px solid var(--gray-100);
}

.case-info-row:last-child {
  border-bottom: none;
}

.case-info-label {
  width: 140px;
  font-size: 13px;
  color: var(--gray-500);
  flex-shrink: 0;
}

.case-info-value {
  font-size: 14px;
  color: var(--gray-900);
  font-weight: 500;
}

.case-info-value a {
  color: var(--brand-navy);
  text-decoration: none;
}

.case-info-value a:hover {
  text-decoration: underline;
}

/* Quick Actions */
.quick-actions-grid {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.quick-action-btn {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
  text-decoration: none;
  width: 100%;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.06);
}

.quick-action-btn:hover {
  background: var(--gray-50);
  border-color: var(--brand-navy);
  color: var(--brand-navy);
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.1);
}

.quick-action-btn svg {
  width: 18px;
  height: 18px;
  opacity: 0.8;
  transition: transform 0.2s ease;
}

.quick-action-btn:hover svg {
  transform: scale(1.1);
}

.quick-action-btn.primary {
  background: linear-gradient(135deg, var(--brand-navy) 0%, var(--brand-navy-light) 100%);
  border: none;
  color: white;
  box-shadow: 0 4px 14px rgba(26, 54, 93, 0.25);
}

.quick-action-btn.primary:hover {
  background: linear-gradient(135deg, var(--brand-navy-light) 0%, #3c6898 100%);
  transform: translateY(-2px);
  box-shadow: 0 6px 20px rgba(26, 54, 93, 0.35);
}

/* Activity Feed */
.activity-feed {
  max-height: 400px;
  overflow-y: auto;
}

.activity-item {
  display: flex;
  gap: 12px;
  padding: 12px 0;
  border-bottom: 1px solid var(--gray-100);
}

.activity-item:last-child {
  border-bottom: none;
}

.activity-icon {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.activity-icon svg {
  width: 16px;
  height: 16px;
  color: var(--gray-500);
}

.activity-content {
  flex: 1;
}

.activity-text {
  font-size: 14px;
  color: var(--gray-700);
  margin-bottom: 4px;
}

.activity-text strong {
  color: var(--gray-900);
}

.activity-time {
  font-size: 12px;
  color: var(--gray-400);
}

/* Comments Section */
.comment-form {
  display: flex;
  gap: 12px;
  margin-top: 16px;
  padding-top: 16px;
  border-top: 1px solid var(--gray-200);
}

.comment-form textarea {
  flex: 1;
  padding: 12px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 14px;
  font-family: var(--font-sans);
  resize: vertical;
  min-height: 80px;
}

.comment-form textarea:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

/* Selected Items List */
.selected-items-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.selected-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 12px;
  background: var(--gray-50);
  border-radius: 8px;
  font-size: 13px;
}

.selected-item-name {
  color: var(--gray-700);
}

.selected-item-qty {
  font-weight: 600;
  color: var(--gray-900);
}

/* Status Dropdown in Case Detail */
.status-select-inline {
  padding: 8px 12px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 14px;
  font-weight: 500;
  cursor: pointer;
  width: 100%;
  background: white;
}

.status-select-inline:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

/* Back Button */
.back-to-cases {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 8px 16px;
  margin-bottom: 20px;
  color: var(--gray-600);
  font-size: 14px;
  cursor: pointer;
  border: none;
  background: none;
  transition: color 0.2s ease;
}

.back-to-cases:hover {
  color: var(--brand-navy);
}

.back-to-cases svg {
  width: 16px;
  height: 16px;
}

/* Modal Improvements for SOP/Template Add/Edit */
.form-group {
  margin-bottom: 20px;
}

.form-group label {
  display: block;
  margin-bottom: 8px;
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-700);
}

.form-group input,
.form-group select,
.form-group textarea {
  width: 100%;
  padding: 10px 14px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 14px;
  font-family: var(--font-sans);
}

.form-group input:focus,
.form-group select:focus,
.form-group textarea:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

.form-group textarea {
  min-height: 120px;
  resize: vertical;
}

/* Empty State */
.empty-state {
  text-align: center;
  padding: 60px 40px;
  color: var(--gray-500);
}

.empty-state svg {
  width: 48px;
  height: 48px;
  color: var(--gray-300);
  margin-bottom: 16px;
}

.empty-state h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 8px;
}

.empty-state p {
  font-size: 14px;
  margin-bottom: 20px;
}

/* Responsive Case Detail */
@media (max-width: 1024px) {
  .case-detail-grid {
    grid-template-columns: 1fr;
  }
  
  .case-detail-sidebar {
    order: -1;
  }
}

/* ============================================
   Enhanced Case Table Styles
   ============================================ */

/* Filters Bar Above Table */
.cases-filters-bar {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 16px 0;
  margin-bottom: 16px;
  gap: 16px;
  flex-wrap: wrap;
}

.cases-filters-left {
  display: flex;
  gap: 12px;
  flex-wrap: wrap;
}

.cases-filters-right {
  display: flex;
  align-items: center;
  gap: 16px;
}

.filter-select-inline {
  padding: 8px 32px 8px 12px;
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-700);
  background: white;
  cursor: pointer;
  transition: all 0.2s ease;
  appearance: none;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' viewBox='0 0 24 24' fill='none' stroke='%236b7280' stroke-width='2'%3E%3Cpath d='M6 9l6 6 6-6'/%3E%3C/svg%3E");
  background-repeat: no-repeat;
  background-position: right 10px center;
  min-width: 130px;
}

.filter-select-inline:hover {
  border-color: var(--gray-300);
}

.filter-select-inline:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

.filter-select-inline:not([value=""]) {
  border-color: var(--brand-navy-light);
  background-color: var(--brand-navy-soft);
}

.cases-result-count {
  font-size: 13px;
  color: var(--gray-500);
  font-weight: 500;
}

/* Custom Date Range Picker */
.custom-date-range {
  display: flex;
  align-items: center;
  gap: 8px;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; transform: translateY(-4px); }
  to { opacity: 1; transform: translateY(0); }
}

.date-input {
  padding: 8px 12px;
  border: 1.5px solid var(--gray-200);
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-700);
  background: white;
  cursor: pointer;
  transition: all 0.2s ease;
  width: 140px;
}

.date-input:hover {
  border-color: var(--gray-300);
}

.date-input:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

.date-separator {
  font-size: 12px;
  color: var(--gray-400);
  font-weight: 500;
}

/* Save View Button */
.btn-save-view {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: transparent;
  border: 1.5px dashed var(--gray-300);
  border-radius: 8px;
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-500);
  cursor: pointer;
  transition: all 0.2s ease;
}

.btn-save-view:hover {
  border-color: var(--brand-navy);
  color: var(--brand-navy);
  background: rgba(26, 54, 93, 0.04);
}

.btn-save-view svg {
  opacity: 0.7;
}

.btn-save-view:hover svg {
  opacity: 1;
}

/* Saved Views Section */
.saved-views-section {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 20px;
  background: linear-gradient(135deg, rgba(168, 216, 234, 0.08) 0%, rgba(255, 183, 197, 0.08) 100%);
  border-bottom: 1px solid var(--gray-100);
  overflow-x: auto;
}

.saved-views-label {
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.03em;
  white-space: nowrap;
}

.saved-views-list {
  display: flex;
  align-items: center;
  gap: 8px;
  flex-wrap: wrap;
}

.saved-view-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 20px;
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-600);
  cursor: pointer;
  transition: all 0.2s ease;
  white-space: nowrap;
}

.saved-view-btn:hover {
  border-color: var(--brand-navy);
  color: var(--brand-navy);
  background: rgba(26, 54, 93, 0.04);
}

.saved-view-btn.active {
  background: var(--brand-navy);
  border-color: var(--brand-navy);
  color: white;
}

.saved-view-btn .view-icon {
  width: 14px;
  height: 14px;
  opacity: 0.7;
}

.saved-view-btn .view-delete {
  width: 14px;
  height: 14px;
  opacity: 0;
  margin-left: 2px;
  transition: opacity 0.15s ease;
}

.saved-view-btn:hover .view-delete {
  opacity: 0.6;
}

.saved-view-btn:hover .view-delete:hover {
  opacity: 1;
  color: var(--error-500);
}

.saved-view-btn.global {
  border-style: solid;
  border-color: var(--brand-gold);
  background: linear-gradient(135deg, rgba(184, 157, 102, 0.08) 0%, rgba(184, 157, 102, 0.04) 100%);
}

.saved-view-btn.global::before {
  content: '';
  width: 6px;
  height: 6px;
  background: var(--brand-gold);
  border-radius: 50%;
  margin-right: 2px;
}

/* Save View Modal */
.save-view-modal {
  max-width: 400px;
}

.save-view-form {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.save-view-input {
  padding: 12px 16px;
  border: 1.5px solid var(--gray-200);
  border-radius: 10px;
  font-size: 14px;
  color: var(--gray-700);
  transition: all 0.2s ease;
}

.save-view-input:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

.save-view-preview {
  padding: 12px 16px;
  background: var(--gray-50);
  border-radius: 10px;
  border: 1px solid var(--gray-100);
}

.save-view-preview-title {
  font-size: 11px;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.03em;
  margin-bottom: 8px;
}

.save-view-preview-filters {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.filter-tag {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  font-size: 12px;
  color: var(--gray-600);
}

.filter-tag-label {
  color: var(--gray-400);
  margin-right: 4px;
}

.save-view-global {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: linear-gradient(135deg, rgba(184, 157, 102, 0.1) 0%, rgba(184, 157, 102, 0.05) 100%);
  border-radius: 10px;
  border: 1px solid rgba(184, 157, 102, 0.3);
}

.save-view-global input[type="checkbox"] {
  width: 18px;
  height: 18px;
  accent-color: var(--brand-gold);
}

.save-view-global-text {
  flex: 1;
}

.save-view-global-title {
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-700);
}

.save-view-global-desc {
  font-size: 12px;
  color: var(--gray-500);
  margin-top: 2px;
}

.save-view-actions {
  display: flex;
  gap: 12px;
  margin-top: 8px;
}

.save-view-actions .btn {
  flex: 1;
}

/* Delete Confirmation Modal */
.delete-confirm-modal {
  max-width: 380px;
  text-align: center;
}

.delete-modal-header {
  flex-direction: column;
  align-items: center;
  gap: 12px;
  padding-bottom: 8px;
  border-bottom: none;
}

.delete-modal-icon {
  margin-bottom: 4px;
}

.delete-modal-body {
  padding: 12px 24px 20px;
}

.delete-modal-body p {
  margin: 0 0 8px 0;
  color: var(--gray-700);
  font-size: 15px;
}

.delete-modal-body p:last-child {
  margin-bottom: 0;
}

.delete-modal-body strong {
  color: var(--gray-900);
}

.delete-modal-subtext {
  font-size: 13px !important;
  color: var(--gray-500) !important;
}

.delete-modal-footer {
  display: flex;
  gap: 12px;
  padding: 16px 24px 24px;
  border-top: none;
}

.delete-modal-footer .btn {
  flex: 1;
  justify-content: center;
}

.btn-danger {
  background: linear-gradient(135deg, #dc3545 0%, #c82333 100%);
  color: white;
  border: none;
  display: inline-flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 10px 20px;
  border-radius: 10px;
  font-weight: 600;
  font-size: 14px;
  cursor: pointer;
  transition: all 0.2s ease;
  box-shadow: 0 2px 8px rgba(220, 53, 69, 0.3);
}

.btn-danger:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(220, 53, 69, 0.4);
  background: linear-gradient(135deg, #c82333 0%, #bd2130 100%);
}

.btn-danger:active {
  transform: translateY(0);
}

.btn-danger svg {
  stroke: white;
}

/* Clickable Assignee Column */
.td-assignee {
  transition: all 0.2s ease;
  position: relative;
}

.assignee-cell {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 6px 10px;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  border: 1px solid transparent;
  background: var(--gray-50);
}

.assignee-cell:hover {
  background: var(--primary-50);
  border-color: var(--primary-200);
  box-shadow: 0 2px 8px rgba(26, 54, 93, 0.1);
}

.assignee-avatar {
  width: 24px;
  height: 24px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--brand-navy) 0%, var(--brand-navy-light) 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  flex-shrink: 0;
}

.assignee-avatar.unassigned {
  background: var(--gray-200);
  color: var(--gray-500);
}

.assignee-name {
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-700);
  white-space: nowrap;
}

.assignee-name.unassigned {
  color: var(--gray-400);
  font-style: italic;
}

.assignee-edit-icon {
  width: 14px;
  height: 14px;
  color: var(--gray-400);
  opacity: 0;
  transition: opacity 0.2s ease;
  flex-shrink: 0;
}

.assignee-cell:hover .assignee-edit-icon {
  opacity: 1;
  color: var(--brand-navy);
}

/* Assignee Dropdown */
.assignee-dropdown {
  position: fixed;
  z-index: 10000;
  min-width: 220px;
  max-width: 280px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.15), 0 2px 10px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--gray-100);
  overflow: hidden;
  animation: dropdownSlideIn 0.2s ease;
}

@keyframes dropdownSlideIn {
  from {
    opacity: 0;
    transform: translateY(-8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.assignee-dropdown-header {
  padding: 12px 16px;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-100);
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--gray-500);
}

.assignee-dropdown-search {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  border-bottom: 1px solid var(--gray-100);
  background: var(--gray-50);
}

.assignee-dropdown-search svg {
  color: var(--gray-400);
  flex-shrink: 0;
}

.assignee-dropdown-search input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 14px;
  color: var(--gray-800);
  outline: none;
}

.assignee-dropdown-search input::placeholder {
  color: var(--gray-400);
}

.assignee-dropdown-list {
  max-height: 280px;
  overflow-y: auto;
  padding: 8px 0;
}

.assignee-dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 16px;
  cursor: pointer;
  transition: all 0.15s ease;
}

.assignee-dropdown-item:hover {
  background: var(--primary-50);
}

.assignee-dropdown-item.selected {
  background: var(--primary-100);
}

.assignee-dropdown-item .assignee-avatar {
  width: 28px;
  height: 28px;
  font-size: 11px;
}

.assignee-dropdown-item-info {
  flex: 1;
  min-width: 0;
}

.assignee-dropdown-item-name {
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-800);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.assignee-dropdown-item-role {
  font-size: 11px;
  color: var(--gray-500);
}

.assignee-dropdown-item-check {
  width: 16px;
  height: 16px;
  color: var(--success-500);
  opacity: 0;
}

.assignee-dropdown-item.selected .assignee-dropdown-item-check {
  opacity: 1;
}

.assignee-dropdown-divider {
  height: 1px;
  background: var(--gray-100);
  margin: 8px 16px;
}

.assignee-dropdown-unassign {
  color: var(--gray-500);
}

.assignee-dropdown-unassign:hover {
  background: var(--gray-50);
}

.assignee-dropdown-unassign .assignee-avatar {
  background: var(--gray-200);
  color: var(--gray-500);
}

/* Enhanced Card */
.cases-card-enhanced {
  background: white;
  border-radius: 16px;
  border: 1px solid var(--gray-200);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.04);
  overflow: hidden;
}

/* Enhanced Table */
.cases-table-enhanced {
  width: 100%;
  border-collapse: collapse;
}

.cases-table-enhanced thead {
  background: var(--gray-50);
  border-bottom: 2px solid var(--gray-200);
}

.cases-table-enhanced thead th {
  padding: 14px 16px;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  color: var(--gray-600);
  text-align: left;
  white-space: nowrap;
}

.cases-table-enhanced tbody tr {
  border-bottom: 1px solid var(--gray-100);
  transition: all 0.15s ease;
  cursor: pointer;
}

.cases-table-enhanced tbody tr:hover {
  background: var(--primary-50);
  box-shadow: inset 3px 0 0 var(--brand-navy);
}

.cases-table-enhanced tbody tr.keyboard-selected {
  background: var(--primary-50);
  box-shadow: inset 3px 0 0 var(--brand-navy);
}

.cases-table-enhanced tbody td {
  padding: 16px;
  font-size: 14px;
  color: var(--gray-700);
  vertical-align: middle;
}

/* Customer cell styling */
.cases-table-enhanced .td-customer {
  min-width: 200px;
}

.td-customer-name {
  font-weight: 600;
  color: var(--gray-900);
  margin-bottom: 2px;
}

.td-customer-email {
  font-size: 12px;
  color: var(--gray-500);
}

/* Type badges */
.cases-table-enhanced .type-badge {
  display: inline-flex;
  align-items: center;
  padding: 4px 10px;
  border-radius: 6px;
  font-size: 12px;
  font-weight: 600;
  text-transform: capitalize;
}

/* Status badges - enhanced */
.cases-table-enhanced .status-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 600;
}

.cases-table-enhanced .status-badge::before {
  content: '';
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
}

/* Due date styling */
.td-due {
  font-weight: 500;
}

.td-due.overdue {
  color: var(--error-600);
  font-weight: 600;
}

.td-due.warning {
  color: var(--warning-600);
}

.td-due.ok {
  color: var(--success-600);
}

/* Resolution cell */
.td-resolution {
  max-width: 200px;
  overflow: hidden;
  text-overflow: ellipsis;
  white-space: nowrap;
}

/* Assignee cell */
.td-assignee-unassigned {
  color: var(--gray-400);
  font-style: italic;
}

/* Time ago styling */
.td-created,
.th-created {
  color: var(--gray-500);
  font-size: 13px;
  min-width: 90px;
  width: 90px;
}

/* Responsive table */
@media (max-width: 1200px) {
  .cases-table-enhanced .th-resolution,
  .cases-table-enhanced .td-resolution {
    display: none;
  }
}

@media (max-width: 900px) {
  .cases-table-enhanced .th-assignee,
  .cases-table-enhanced .td-assignee,
  .cases-table-enhanced .th-due,
  .cases-table-enhanced .td-due {
    display: none;
  }
  
  .cases-filters-bar {
    flex-direction: column;
    align-items: flex-start;
  }
}

/* ============================================
   REDESIGNED ACTIVITY & COMMENTS
   ============================================ */

.activity-section .case-detail-section-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.activity-count {
  font-size: 12px;
  font-weight: 500;
  color: var(--gray-400);
  background: var(--gray-100);
  padding: 4px 10px;
  border-radius: 12px;
}

.activity-feed-redesigned {
  max-height: 400px;
  overflow-y: auto;
  padding-right: 8px;
}

.activity-empty-state {
  text-align: center;
  padding: 40px 20px;
  color: var(--gray-400);
}

.activity-empty-state svg {
  color: var(--gray-300);
  margin-bottom: 12px;
}

.activity-empty-state p {
  font-weight: 500;
  color: var(--gray-500);
  margin-bottom: 4px;
}

.activity-empty-state span {
  font-size: 13px;
}

/* ===== REDESIGNED Activity & Comments ===== */

/* Comment Item - Prominent Design */
.comment-item {
  display: flex;
  gap: 14px;
  padding: 16px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.95) 0%, rgba(248, 250, 252, 0.9) 100%);
  border-radius: 16px;
  border: 1px solid rgba(168, 216, 234, 0.3);
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.04);
  margin-bottom: 12px;
  transition: all 0.2s ease;
}

.comment-item:hover {
  transform: translateY(-1px);
  box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
  border-color: rgba(168, 216, 234, 0.5);
}

.comment-avatar {
  width: 40px;
  height: 40px;
  border-radius: 12px;
  background: linear-gradient(135deg, var(--brand-navy) 0%, #2a3f5f 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 2px 6px rgba(26, 54, 93, 0.2);
}

.comment-avatar span {
  color: white;
  font-size: 14px;
  font-weight: 600;
  letter-spacing: 0.5px;
}

.comment-bubble {
  flex: 1;
  min-width: 0;
}

.comment-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.comment-author {
  font-weight: 600;
  font-size: 14px;
  color: var(--brand-navy);
}

.comment-time {
  font-size: 11px;
  color: var(--gray-400);
  background: var(--gray-100);
  padding: 3px 8px;
  border-radius: 10px;
}

.comment-content {
  font-size: 14px;
  line-height: 1.6;
  color: var(--gray-700);
  background: white;
  padding: 12px 14px;
  border-radius: 10px;
  border: 1px solid var(--gray-100);
}

/* System Activity - Compact & Subtle */
.system-activity {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 6px 12px;
  margin: 2px 0;
  border-radius: 6px;
  background: transparent;
  transition: background 0.15s ease;
}

.system-activity:hover {
  background: rgba(0, 0, 0, 0.02);
}

.activity-icon-small {
  width: 18px;
  height: 18px;
  border-radius: 50%;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.activity-icon-small svg {
  width: 10px;
  height: 10px;
  color: var(--gray-400);
}

.activity-icon-small.status-change {
  background: var(--success-100);
}
.activity-icon-small.status-change svg {
  color: var(--success-600);
}

.activity-icon-small.assigned {
  background: var(--sora);
}
.activity-icon-small.assigned svg {
  color: var(--brand-navy);
}

.activity-icon-small.view-action {
  background: var(--warning-100);
}
.activity-icon-small.view-action svg {
  color: var(--warning-600);
}

.activity-icon-small.copy-action {
  background: var(--sakura);
}
.activity-icon-small.copy-action svg {
  color: var(--brand-navy);
}

.activity-text-inline {
  font-size: 12px;
  color: var(--gray-500);
  line-height: 1.4;
}

.activity-text-inline strong {
  color: var(--gray-600);
  font-weight: 500;
}

.activity-time-inline {
  color: var(--gray-400);
  font-size: 11px;
}

/* ===== Compact Activity Log ===== */
.activity-log-group {
  background: rgba(248, 250, 252, 0.6);
  border-radius: 8px;
  padding: 6px 10px;
  margin-bottom: 12px;
  border-left: 2px solid var(--gray-200);
}

.activity-log-item {
  display: flex;
  align-items: center;
  gap: 8px;
  padding: 5px 0;
  font-size: 12px;
  color: var(--gray-500);
}

.activity-log-item:not(:last-child) {
  border-bottom: 1px dotted var(--gray-150, #e8e8e8);
}

.activity-log-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: var(--gray-300);
  flex-shrink: 0;
}

.activity-log-dot.status-change {
  background: var(--success-500);
}

.activity-log-dot.assigned {
  background: var(--sora);
}

.activity-log-dot.view-action {
  background: var(--warning-500);
}

.activity-log-dot.copy-action {
  background: var(--sakura);
}

.activity-log-text {
  flex: 1;
  color: var(--gray-500);
  line-height: 1.3;
}

.activity-log-text strong {
  color: var(--gray-600);
  font-weight: 500;
}

.activity-log-time {
  font-size: 10px;
  color: var(--gray-400);
  white-space: nowrap;
}

/* Redesigned Comment Form */
.comment-form-redesigned {
  margin-top: 20px;
  padding-top: 20px;
  border-top: 1px solid var(--gray-200);
}

.comment-input-container {
  display: flex;
  gap: 12px;
  margin-bottom: 12px;
}

.comment-input-container .comment-avatar {
  margin-top: 4px;
}

.comment-input-container textarea {
  flex: 1;
  padding: 12px 16px;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  font-size: 14px;
  font-family: var(--font-sans);
  resize: none;
  min-height: 80px;
  transition: border-color 0.2s, box-shadow 0.2s;
}

.comment-input-container textarea:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

.comment-form-actions {
  display: flex;
  justify-content: flex-end;
}

.comment-form-actions .btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
}

/* ============================================
   SOP LINK & EMAIL BTN STYLING
   ============================================ */

.quick-action-btn.sop-link {
  background: var(--brand-navy);
  color: white;
  border: none;
  box-shadow: 0 4px 14px rgba(26, 54, 93, 0.25);
}

.quick-action-btn.sop-link:hover {
  background: var(--brand-navy-light);
  transform: translateX(4px);
  box-shadow: 0 6px 20px rgba(26, 54, 93, 0.35);
}

.quick-action-btn.email-btn {
  background: var(--success-600);
  color: white;
  border: none;
  box-shadow: 0 4px 14px rgba(16, 185, 129, 0.25);
}

.quick-action-btn.email-btn:hover {
  background: var(--success-500);
  transform: translateX(4px);
  box-shadow: 0 6px 20px rgba(16, 185, 129, 0.35);
}

/* ============================================
   EMAIL TEMPLATE MODAL STYLES
   ============================================ */

.email-template-list {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.email-template-card {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  padding: 16px;
}

.email-template-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 8px;
}

.email-template-name {
  font-weight: 600;
  color: var(--gray-800);
}

.email-template-subject {
  font-size: 13px;
  color: var(--gray-600);
  margin-bottom: 8px;
}

.email-template-preview {
  font-size: 12px;
  color: var(--gray-500);
  line-height: 1.5;
  margin-bottom: 12px;
  padding: 8px;
  background: white;
  border-radius: 6px;
  border: 1px solid var(--gray-100);
}

.email-template-card .btn {
  width: 100%;
  justify-content: center;
}

/* ============================================
   SOP PAGE REDESIGN
   ============================================ */

.sop-placeholder-banner {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 16px;
  background: var(--warning-50);
  border: 1px solid var(--warning-200);
  border-radius: 8px;
  margin-bottom: 24px;
  color: var(--warning-700);
  font-size: 13px;
}

.sop-category-section,
.template-category-section {
  margin-bottom: 32px;
}

.sop-category-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 2px solid var(--gray-100);
}

.sop-category-icon {
  font-size: 20px;
}

.sop-category-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-800);
}

.sop-category-count {
  font-size: 12px;
  color: var(--gray-400);
  background: var(--gray-100);
  padding: 4px 10px;
  border-radius: 12px;
  margin-left: auto;
}

.sop-cards-grid,
.template-cards-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
  gap: 16px;
}

.sop-card.placeholder,
.template-card.placeholder {
  border-style: dashed;
  background: var(--gray-25);
}

.sop-card-link.disabled {
  color: var(--gray-400);
  pointer-events: none;
  opacity: 0.6;
}

.template-card {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  padding: 16px;
  transition: box-shadow 0.2s, border-color 0.2s;
}

.template-card:hover {
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  border-color: var(--gray-300);
}

.template-card-header {
  margin-bottom: 12px;
}

.template-card-title {
  font-size: 15px;
  font-weight: 600;
  color: var(--gray-800);
  margin: 0;
}

.template-card-subject {
  font-size: 12px;
  color: var(--gray-600);
  margin-bottom: 8px;
  padding: 8px;
  background: var(--gray-50);
  border-radius: 6px;
}

.template-card-preview {
  font-size: 12px;
  color: var(--gray-500);
  line-height: 1.5;
  margin-bottom: 12px;
  min-height: 50px;
}

.template-card-variables {
  display: flex;
  flex-wrap: wrap;
  align-items: center;
  gap: 6px;
  margin-bottom: 12px;
}

.variables-label {
  font-size: 11px;
  color: var(--gray-400);
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.template-variable {
  display: inline-flex;
  padding: 3px 8px;
  background: var(--primary-50);
  color: var(--primary-700);
  border-radius: 4px;
  font-size: 11px;
  font-family: var(--font-mono);
}

.template-card-actions {
  display: flex;
  gap: 8px;
  flex-wrap: wrap;
}

.btn-sm {
  padding: 6px 12px;
  font-size: 12px;
}

/* ============================================
   SEARCH DROPDOWN - Glass + Japanese Pastel Design
   ============================================ */

/* Search dropdown container */
.search-dropdown {
  background: rgba(255, 255, 255, 0.95);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border: 1px solid rgba(255, 255, 255, 0.6);
  border-radius: var(--radius-xl);
  box-shadow: 0 20px 40px rgba(0, 0, 0, 0.1), 
              0 0 0 1px rgba(255, 255, 255, 0.5),
              inset 0 1px 0 rgba(255, 255, 255, 0.5);
  overflow: hidden;
  animation: scaleIn 0.2s ease;
}

.search-section-header {
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.8px;
  color: var(--gray-500);
  padding: 14px 18px 8px;
  display: flex;
  align-items: center;
  gap: 10px;
  background: linear-gradient(135deg, rgba(248, 250, 252, 0.8) 0%, rgba(255, 255, 255, 0.5) 100%);
}

.search-section-header:not(:first-child) {
  border-top: 1px solid rgba(0, 0, 0, 0.04);
  margin-top: 0;
}

.search-count {
  font-size: 10px;
  font-weight: 600;
  color: var(--brand-navy);
  background: var(--sora-soft);
  padding: 2px 8px;
  border-radius: 10px;
}

.search-result-item {
  padding: 12px 18px;
  cursor: pointer;
  transition: all 0.2s ease;
  border-left: 3px solid transparent;
}

.search-result-item:hover,
.search-result-item.selected {
  background: linear-gradient(135deg, var(--fuji-soft) 0%, rgba(255, 255, 255, 0.6) 100%);
  border-left-color: var(--fuji);
  transform: translateX(2px);
}

.search-result-main {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 4px;
}

.search-result-name {
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-900);
}

/* Highlight matched text with sakura color */
.search-highlight {
  background: linear-gradient(135deg, var(--sakura) 0%, #ffc4d0 100%);
  color: #9a2d4a;
  padding: 1px 4px;
  border-radius: 3px;
  font-weight: 600;
}

.search-result-badge {
  font-size: 10px;
  font-weight: 600;
  text-transform: capitalize;
  padding: 3px 10px;
  border-radius: 6px;
  box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
}

/* Japanese pastel-themed badges */
.search-result-badge.refund {
  background: linear-gradient(135deg, var(--sakura-soft) 0%, rgba(255, 183, 197, 0.3) 100%);
  color: #9a2d4a;
  border: 1px solid rgba(255, 183, 197, 0.4);
}

.search-result-badge.shipping {
  background: linear-gradient(135deg, var(--sora-soft) 0%, rgba(168, 216, 234, 0.3) 100%);
  color: #1e6091;
  border: 1px solid rgba(168, 216, 234, 0.4);
}

.search-result-badge.subscription {
  background: linear-gradient(135deg, var(--fuji-soft) 0%, rgba(232, 213, 232, 0.3) 100%);
  color: #6b4c7a;
  border: 1px solid rgba(232, 213, 232, 0.4);
}

.search-result-badge.return {
  background: linear-gradient(135deg, var(--momo-soft) 0%, rgba(255, 218, 185, 0.3) 100%);
  color: #9a5a2f;
  border: 1px solid rgba(255, 218, 185, 0.4);
}

.search-result-badge.session {
  background: #FEF3C7;
  color: #92400E;
}

.search-result-badge.issue {
  background: #FEE2E2;
  color: #B91C1C;
}

.search-result-status {
  font-size: 10px;
  font-weight: 500;
  padding: 2px 6px;
  border-radius: 4px;
  text-transform: capitalize;
}

.search-result-status.pending {
  background: #FEF3C7;
  color: #92400E;
}

.search-result-status.completed,
.search-result-status.resolved {
  background: #D1FAE5;
  color: #065F46;
}

.search-result-status.in_progress {
  background: #DBEAFE;
  color: #1D4ED8;
}

.search-result-details {
  font-size: 12px;
  color: var(--gray-500);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.search-result-item mark {
  background: #FEF08A;
  color: inherit;
  padding: 0 2px;
  border-radius: 2px;
}

.search-dropdown-empty {
  padding: 32px 24px;
  text-align: center;
  color: var(--gray-400);
  font-size: 13px;
}

/* ============================================
   EMAIL TEMPLATE MODAL & LIVE PREVIEW
   ============================================ */

.email-template-modal {
  max-width: 700px !important;
}

.email-template-modal .modal-body {
  padding: 24px;
}

.template-preview-section {
  background: white;
}

.template-preview-content {
  font-family: inherit;
  line-height: 1.6;
}

.template-variables-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.template-variable-badge {
  display: inline-flex;
  padding: 4px 10px;
  background: var(--primary-100);
  color: var(--primary-700);
  border-radius: 12px;
  font-size: 11px;
  font-family: var(--font-mono);
  font-weight: 500;
}

.case-selector-dropdown {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-size: 14px;
  background: white;
  cursor: pointer;
  transition: all 0.15s ease;
}

.case-selector-dropdown:hover {
  border-color: var(--primary-400);
}

.case-selector-dropdown:focus {
  border-color: var(--primary-500);
  outline: none;
  box-shadow: 0 0 0 3px var(--primary-100);
}

/* ============================================
   ACTIVITY FEED - Japanese Pastel Themed
   ============================================ */

.activity-feed {
  display: flex;
  flex-direction: column;
  gap: 8px;
  padding: 8px;
}

.activity-item {
  display: flex;
  gap: 14px;
  padding: 16px 18px;
  background: rgba(255, 255, 255, 0.7);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
  border-radius: var(--radius-lg);
  border: 1px solid rgba(255, 255, 255, 0.5);
  transition: all 0.25s ease;
  animation: fadeInUp 0.3s ease backwards;
}

.activity-item:nth-child(1) { animation-delay: 0.05s; }
.activity-item:nth-child(2) { animation-delay: 0.1s; }
.activity-item:nth-child(3) { animation-delay: 0.15s; }
.activity-item:nth-child(4) { animation-delay: 0.2s; }
.activity-item:nth-child(5) { animation-delay: 0.25s; }

.activity-item:hover {
  background: rgba(255, 255, 255, 0.9);
  transform: translateX(4px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.06);
}

/* Comment specific styling - Sakura pink accent */
.activity-item.comment {
  background: linear-gradient(135deg, rgba(255, 183, 197, 0.15) 0%, rgba(255, 255, 255, 0.8) 100%);
  border-left: 3px solid var(--sakura);
  border-radius: 0 var(--radius-lg) var(--radius-lg) 0;
}

.activity-item.comment:hover {
  background: linear-gradient(135deg, rgba(255, 183, 197, 0.25) 0%, rgba(255, 255, 255, 0.9) 100%);
}

/* System activity styling - Sora blue accent */
.activity-item.system {
  background: linear-gradient(135deg, rgba(168, 216, 234, 0.1) 0%, rgba(255, 255, 255, 0.6) 100%);
  border: 1px solid rgba(168, 216, 234, 0.3);
}

.activity-item.system:hover {
  background: linear-gradient(135deg, rgba(168, 216, 234, 0.2) 0%, rgba(255, 255, 255, 0.8) 100%);
}

.activity-icon {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  font-size: 15px;
  box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08);
}

/* Comment icon - Sakura gradient */
.activity-icon.comment-icon {
  background: linear-gradient(135deg, var(--sakura) 0%, #ff9eb3 100%);
  color: white;
}

/* Status icon - Matcha gradient */
.activity-icon.status-icon {
  background: linear-gradient(135deg, var(--matcha) 0%, #9fd4a0 100%);
  color: #2d6a4f;
}

/* View icon - Momo gradient */
.activity-icon.view-icon {
  background: linear-gradient(135deg, var(--momo) 0%, #ffc59e 100%);
  color: #9a5a2f;
}

/* Create icon - Sora gradient */
.activity-icon.create-icon {
  background: linear-gradient(135deg, var(--sora) 0%, #8bc4d6 100%);
  color: #1e6091;
}

/* Generic/default icon - Fuji gradient */
.activity-icon.default-icon {
  background: linear-gradient(135deg, var(--fuji) 0%, #d4b8d4 100%);
  color: #6b4c7a;
}

.activity-content {
  flex: 1;
  min-width: 0;
}

.activity-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 6px;
}

.activity-actor {
  font-weight: 600;
  color: var(--gray-900);
  font-size: 14px;
}

.activity-time {
  font-size: 12px;
  color: var(--gray-400);
  font-weight: 500;
}

.activity-text {
  font-size: 14px;
  color: var(--gray-600);
  line-height: 1.5;
  line-height: 1.5;
}

.activity-item.comment .activity-text {
  color: var(--gray-800);
  font-size: 14px;
  padding: 8px 12px;
  background: white;
  border-radius: 6px;
  margin-top: 6px;
  border: 1px solid var(--primary-200);
}

/* Comment Form */
.comment-form {
  display: flex;
  gap: 12px;
  padding: 16px;
  background: var(--gray-50);
  border-radius: 8px;
  margin-top: 16px;
}

.comment-form textarea {
  flex: 1;
  min-height: 60px;
  padding: 12px;
  border: 1px solid var(--gray-300);
  border-radius: 8px;
  font-family: inherit;
  font-size: 14px;
  resize: vertical;
  transition: all 0.15s;
}

.comment-form textarea:focus {
  border-color: var(--primary-500);
  outline: none;
  box-shadow: 0 0 0 3px var(--primary-100);
}

.comment-form textarea::placeholder {
  color: var(--gray-400);
}

/* ============================================
   SOP LINK STYLES
   ============================================ */

.sop-category-section {
  margin-bottom: 24px;
}

.sop-category-header {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: var(--gray-50);
  border-radius: 8px;
  margin-bottom: 12px;
}

.sop-category-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--primary-100);
  color: var(--primary-600);
}

.sop-category-title {
  font-weight: 600;
  color: var(--gray-800);
  font-size: 15px;
}

.sop-category-count {
  font-size: 12px;
  color: var(--gray-500);
  margin-left: auto;
}

.sop-links-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
  gap: 12px;
  padding-left: 48px;
}

.sop-link-card {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 16px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  text-decoration: none;
  color: inherit;
  transition: all 0.15s;
}

.sop-link-card:hover {
  border-color: var(--primary-400);
  background: var(--primary-50);
  transform: translateY(-1px);
  box-shadow: 0 4px 12px rgba(0, 0, 0, 0.08);
}

.sop-link-card.placeholder {
  border-style: dashed;
  opacity: 0.85;
}

.sop-link-icon {
  width: 28px;
  height: 28px;
  border-radius: 6px;
  display: flex;
  align-items: center;
  justify-content: center;
  background: var(--gray-100);
  color: var(--gray-600);
  flex-shrink: 0;
}

.sop-link-content {
  flex: 1;
  min-width: 0;
}

.sop-link-name {
  font-weight: 500;
  font-size: 13px;
  color: var(--gray-800);
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sop-link-desc {
  font-size: 11px;
  color: var(--gray-500);
  margin-top: 2px;
}

/* ============================================
   BULK ACTION BAR
   ============================================ */

.bulk-action-bar {
  position: fixed;
  bottom: 24px;
  left: 50%;
  transform: translateX(-50%);
  z-index: 1000;
  display: flex;
  align-items: center;
  gap: 16px;
  background: var(--brand-navy);
  color: white;
  padding: 12px 24px;
  border-radius: 16px;
  box-shadow: 0 12px 40px rgba(26, 54, 93, 0.4), 0 4px 12px rgba(0, 0, 0, 0.2);
  animation: slideUp 0.3s cubic-bezier(0.34, 1.56, 0.64, 1);
}

.bulk-action-count {
  font-weight: 600;
  font-size: 14px;
  padding-right: 16px;
  border-right: 1px solid rgba(255, 255, 255, 0.2);
}

.bulk-action-buttons {
  display: flex;
  align-items: center;
  gap: 8px;
}

.bulk-btn {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 14px;
  background: rgba(255, 255, 255, 0.1);
  border: none;
  border-radius: 8px;
  color: white;
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  transition: all 0.2s;
}

.bulk-btn:hover {
  background: rgba(255, 255, 255, 0.2);
}

.bulk-btn-cancel {
  display: flex;
  align-items: center;
  gap: 6px;
  padding: 8px 16px;
  border: none;
  background: transparent;
  color: rgba(255, 255, 255, 0.6);
  font-size: 13px;
  font-weight: 500;
  cursor: pointer;
  border-radius: 8px;
  transition: all 0.2s ease;
}

.bulk-btn-cancel svg {
  width: 14px;
  height: 14px;
}

.bulk-btn-cancel:hover {
  color: white;
  background: rgba(255, 255, 255, 0.1);
}

/* Bulk Inline Dropdown */
.bulk-inline-dropdown {
  position: fixed;
  z-index: 10001;
  min-width: 200px;
  max-width: 260px;
  background: white;
  border-radius: 12px;
  box-shadow: 0 10px 40px rgba(0, 0, 0, 0.2), 0 2px 10px rgba(0, 0, 0, 0.1);
  border: 1px solid var(--gray-100);
  overflow: hidden;
  animation: dropdownSlideUp 0.2s ease;
}

@keyframes dropdownSlideUp {
  from {
    opacity: 0;
    transform: translateY(8px);
  }
  to {
    opacity: 1;
    transform: translateY(0);
  }
}

.bulk-inline-dropdown-header {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  border-bottom: 1px solid var(--gray-100);
  background: var(--gray-50);
}

.bulk-inline-dropdown-header svg {
  color: var(--gray-400);
  flex-shrink: 0;
}

.bulk-inline-dropdown-header input {
  flex: 1;
  border: none;
  background: transparent;
  font-size: 14px;
  color: var(--gray-800);
  outline: none;
}

.bulk-inline-dropdown-header input::placeholder {
  color: var(--gray-400);
}

.bulk-inline-dropdown-list {
  max-height: 240px;
  overflow-y: auto;
  padding: 8px 0;
}

.bulk-inline-dropdown-item {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  cursor: pointer;
  transition: all 0.15s ease;
  font-size: 14px;
  color: var(--gray-700);
}

.bulk-inline-dropdown-item:hover {
  background: var(--primary-50);
}

.bulk-assignee-avatar {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: linear-gradient(135deg, var(--brand-navy) 0%, var(--brand-navy-light) 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  text-transform: uppercase;
  flex-shrink: 0;
}

.bulk-assignee-avatar.unassigned {
  background: var(--gray-200);
  color: var(--gray-500);
}

.bulk-status-item .status-dot {
  width: 10px;
  height: 10px;
  border-radius: 50%;
  flex-shrink: 0;
}

.bulk-status-item .status-dot.pending {
  background: var(--warning);
}

.bulk-status-item .status-dot.in-progress {
  background: var(--info);
}

.bulk-status-item .status-dot.completed {
  background: var(--success);
}

/* ============================================
   NAVIGATION BADGE
   ============================================ */

.nav-badge {
  display: inline-flex;
  align-items: center;
  justify-content: center;
  min-width: 20px;
  height: 20px;
  padding: 0 6px;
  background: var(--error);
  color: white;
  font-size: 11px;
  font-weight: 600;
  border-radius: 10px;
  margin-left: auto;
}

.nav-badge:empty,
.nav-badge[data-count="0"] {
  display: none;
}

/* ============================================
   CATEGORY ICON SVG STYLING
   ============================================ */

.category-icon-svg {
  width: 24px;
  height: 24px;
  display: inline-flex;
  align-items: center;
  justify-content: center;
}

.category-icon-svg svg {
  width: 100%;
  height: 100%;
}

/* ============================================
   PAGINATION - Unified styles for all pagination
   ============================================ */

.pagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 20px;
  border-top: 1px solid var(--gray-200);
}

/* Base pagination button styles */
.pagination-btn,
.pagination button {
  display: flex;
  align-items: center;
  justify-content: center;
  min-width: 40px;
  height: 40px;
  padding: 0 14px;
  background: white;
  border: 1px solid var(--gray-300);
  border-radius: 10px;
  color: var(--gray-800);
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  transition: all 0.15s ease;
}

.pagination-btn svg,
.pagination button svg {
  width: 18px;
  height: 18px;
  stroke-width: 2.5;
  color: var(--gray-600);
}

/* Hover state */
.pagination-btn:hover:not(:disabled):not(.active),
.pagination button:hover:not(:disabled):not(.active) {
  background: var(--gray-50);
  border-color: var(--brand-navy);
  color: var(--brand-navy);
}

.pagination-btn:hover:not(:disabled):not(.active) svg,
.pagination button:hover:not(:disabled):not(.active) svg {
  color: var(--brand-navy);
}

/* Disabled state */
.pagination-btn:disabled,
.pagination button:disabled {
  background: var(--gray-100);
  border-color: var(--gray-200);
  color: var(--gray-400);
  cursor: not-allowed;
  opacity: 0.6;
}

.pagination-btn:disabled svg,
.pagination button:disabled svg {
  color: var(--gray-400);
}

/* Active/Selected state - NO shadow, solid navy */
.pagination-btn.active,
.pagination button.active {
  background: var(--brand-navy) !important;
  border-color: var(--brand-navy) !important;
  color: white !important;
  font-weight: 700;
}

.pagination-btn.active:hover,
.pagination button.active:hover {
  background: var(--brand-navy-light) !important;
  border-color: var(--brand-navy-light) !important;
}

.pagination-info {
  font-size: 13px;
  color: var(--gray-600);
  padding: 0 8px;
}

/* Legacy ID-based pagination support */
#casesPagination,
#sessionsPagination,
#eventsPagination,
#issuesPagination {
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  padding: 20px;
  border-top: 1px solid var(--gray-200);
}

/* ============================================
   SIDEBAR PROGRESS BAR
   ============================================ */

.sidebar-progress {
  margin: 16px;
  padding: 16px;
  background: linear-gradient(135deg, rgba(255, 255, 255, 0.08) 0%, rgba(255, 255, 255, 0.04) 100%);
  border-radius: 12px;
  border: 1px solid rgba(255, 255, 255, 0.08);
  backdrop-filter: blur(10px);
  -webkit-backdrop-filter: blur(10px);
}

.progress-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 12px;
}

.progress-title {
  font-size: 12px;
  font-weight: 600;
  letter-spacing: 0.02em;
  color: rgba(255, 255, 255, 0.7);
}

.progress-stats {
  font-size: 14px;
  font-weight: 700;
  color: white;
  font-family: var(--font-mono);
}

.progress-bar-container {
  margin-bottom: 12px;
}

.progress-bar-track {
  height: 8px;
  background: rgba(255, 255, 255, 0.1);
  border-radius: 100px;
  overflow: hidden;
  position: relative;
}

.progress-bar-fill {
  height: 100%;
  background: linear-gradient(90deg, var(--matcha) 0%, #9fd4a0 50%, var(--sora) 100%);
  border-radius: 100px;
  transition: width 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  position: relative;
  box-shadow: 0 0 12px rgba(200, 230, 201, 0.5);
}

.progress-bar-fill::after {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: linear-gradient(
    90deg,
    transparent 0%,
    rgba(255, 255, 255, 0.3) 50%,
    transparent 100%
  );
  animation: progress-shimmer 2s infinite;
}

@keyframes progress-shimmer {
  0% {
    transform: translateX(-100%);
  }
  100% {
    transform: translateX(100%);
  }
}

.progress-labels {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.progress-label-pending,
.progress-label-completed {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 11px;
  color: rgba(255, 255, 255, 0.6);
}

.progress-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
}

.progress-dot.pending {
  background: linear-gradient(135deg, #FDE68A 0%, #F59E0B 100%);
  box-shadow: 0 0 8px rgba(245, 158, 11, 0.4);
}

.progress-dot.completed {
  background: linear-gradient(135deg, var(--matcha) 0%, #6EE7B7 100%);
  box-shadow: 0 0 8px rgba(200, 230, 201, 0.4);
}

/* ============================================
   DUPLICATES PAGE
   ============================================ */

.duplicates-summary {
  display: grid;
  grid-template-columns: repeat(3, 1fr);
  gap: 16px;
  margin-bottom: 24px;
}

.duplicate-stat-card {
  background: rgba(255, 255, 255, 0.9);
  backdrop-filter: blur(20px);
  -webkit-backdrop-filter: blur(20px);
  border-radius: 16px;
  padding: 24px;
  text-align: center;
  border: 1px solid rgba(255, 255, 255, 0.5);
  box-shadow: var(--shadow-sm);
}

.duplicate-stat-value {
  font-size: 32px;
  font-weight: 700;
  color: var(--brand-navy);
  font-family: var(--font-mono);
  line-height: 1;
  margin-bottom: 8px;
}

.duplicate-stat-label {
  font-size: 13px;
  color: var(--gray-500);
  font-weight: 500;
}

.duplicates-description {
  font-size: 14px;
  color: var(--gray-500);
  margin-top: 4px;
  font-weight: 400;
}

/* Duplicate Group Card */
.duplicate-group {
  background: rgba(255, 255, 255, 0.95);
  border-radius: 16px;
  border: 1px solid var(--gray-200);
  margin-bottom: 16px;
  overflow: hidden;
  transition: all 0.2s ease;
}

.duplicate-group:hover {
  box-shadow: var(--shadow-md);
  border-color: var(--sora);
}

.duplicate-group-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  padding: 20px 24px;
  background: linear-gradient(135deg, rgba(168, 216, 234, 0.1) 0%, rgba(255, 183, 197, 0.1) 100%);
  border-bottom: 1px solid var(--gray-100);
  cursor: pointer;
}

.duplicate-group-header:hover {
  background: linear-gradient(135deg, rgba(168, 216, 234, 0.15) 0%, rgba(255, 183, 197, 0.15) 100%);
}

.duplicate-group-info {
  flex: 1;
}

.duplicate-group-customer {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 8px;
}

.duplicate-customer-avatar {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, var(--brand-navy) 0%, #2a3f5f 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  font-weight: 600;
  font-size: 14px;
}

.duplicate-customer-details h3 {
  font-size: 15px;
  font-weight: 600;
  color: var(--gray-800);
  margin: 0 0 2px 0;
}

.duplicate-customer-details span {
  font-size: 13px;
  color: var(--gray-500);
}

.duplicate-order-info {
  display: flex;
  gap: 16px;
  margin-top: 12px;
}

.duplicate-order-badge {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  font-size: 13px;
  color: var(--gray-700);
}

.duplicate-order-badge svg {
  width: 14px;
  height: 14px;
  color: var(--gray-400);
}

.duplicate-group-badge {
  display: flex;
  flex-direction: column;
  align-items: center;
  padding: 12px 16px;
  background: linear-gradient(135deg, var(--warning-100) 0%, var(--warning-50) 100%);
  border-radius: 12px;
  border: 1px solid var(--warning-200);
}

.duplicate-count {
  font-size: 24px;
  font-weight: 700;
  color: var(--warning-700);
  line-height: 1;
}

.duplicate-count-label {
  font-size: 11px;
  color: var(--warning-600);
  font-weight: 500;
  margin-top: 4px;
}

/* Duplicate Cases Table */
.duplicate-cases-table {
  width: 100%;
  border-collapse: collapse;
}

.duplicate-cases-table th {
  text-align: left;
  padding: 12px 16px;
  font-size: 11px;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-200);
}

.duplicate-cases-table td {
  padding: 14px 16px;
  font-size: 13px;
  color: var(--gray-700);
  border-bottom: 1px solid var(--gray-100);
  vertical-align: middle;
}

.duplicate-cases-table tr:last-child td {
  border-bottom: none;
}

.duplicate-cases-table tr:hover td {
  background: rgba(168, 216, 234, 0.05);
}

.duplicate-case-id {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--primary-600);
  cursor: pointer;
}

.duplicate-case-id:hover {
  text-decoration: underline;
}

.duplicate-case-status {
  display: inline-flex;
  padding: 4px 10px;
  border-radius: 12px;
  font-size: 11px;
  font-weight: 600;
}

.duplicate-case-status.pending {
  background: var(--warning-100);
  color: var(--warning-700);
}

.duplicate-case-status.in-progress {
  background: var(--sora);
  color: var(--brand-navy);
}

.duplicate-case-status.completed {
  background: var(--matcha);
  color: var(--success-700);
}

/* Toggle icon */
.duplicate-toggle-icon {
  width: 24px;
  height: 24px;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gray-400);
  transition: transform 0.2s ease;
}

.duplicate-group.expanded .duplicate-toggle-icon {
  transform: rotate(180deg);
}

.duplicate-cases-wrapper {
  display: none;
  padding: 0;
}

.duplicate-group.expanded .duplicate-cases-wrapper {
  display: block;
}

/* Empty state */
.duplicates-empty {
  text-align: center;
  padding: 60px 20px;
  color: var(--gray-400);
}

.duplicates-empty svg {
  width: 64px;
  height: 64px;
  margin-bottom: 16px;
  opacity: 0.5;
}

.duplicates-empty h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--gray-600);
  margin: 0 0 8px 0;
}

.duplicates-empty p {
  font-size: 14px;
  margin: 0;
}

@media (max-width: 768px) {
  .duplicates-summary {
    grid-template-columns: 1fr;
  }
  
  .duplicate-group-header {
    flex-direction: column;
    gap: 16px;
  }
  
  .duplicate-group-badge {
    align-self: flex-start;
  }
}

/* ============================================
   Flow Documentation Styles
   ============================================ */

.flows-page {
  padding: 0;
  max-width: 1400px;
  margin: 0 auto;
}

.flows-breadcrumb {
  margin-bottom: 24px;
}

.flows-back-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 12px 20px;
  background: var(--glass-bg);
  border: 1px solid var(--glass-border-subtle);
  border-radius: var(--radius-full);
  font-size: 14px;
  font-weight: 600;
  color: var(--gray-600);
  cursor: pointer;
  transition: all var(--transition-fast);
  box-shadow: 0 2px 8px rgba(0,0,0,0.04);
}

.flows-back-btn:hover {
  background: white;
  color: var(--brand-navy);
  transform: translateX(-4px);
  box-shadow: 0 4px 12px rgba(0,0,0,0.08);
  box-shadow: var(--shadow-md);
}

.flows-back-btn svg {
  width: 18px;
  height: 18px;
}

.flows-header {
  display: flex;
  align-items: flex-start;
  gap: 24px;
  padding: 40px;
  background: linear-gradient(135deg, var(--glass-bg-strong) 0%, rgba(255,255,255,0.98) 100%);
  border-radius: var(--radius-2xl);
  border: 1px solid var(--glass-border-subtle);
  margin-bottom: 32px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.04), 0 0 40px rgba(168, 216, 234, 0.1);
  position: relative;
  overflow: hidden;
}

.flows-header::before {
  content: '';
  position: absolute;
  top: 0;
  right: 0;
  width: 300px;
  height: 300px;
  background: radial-gradient(circle, var(--sakura) 0%, transparent 70%);
  opacity: 0.08;
  pointer-events: none;
}

.flows-header-icon {
  width: 72px;
  height: 72px;
  border-radius: var(--radius-xl);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  box-shadow: 0 8px 24px rgba(0,0,0,0.08);
}

.flows-header-icon svg {
  width: 36px;
  height: 36px;
}

.flows-header-content {
  flex: 1;
  position: relative;
  z-index: 1;
}

.flows-title {
  font-size: 32px;
  font-weight: 800;
  color: var(--brand-navy);
  margin: 0 0 10px 0;
  font-family: var(--font-display);
  letter-spacing: -0.02em;
}

.flows-subtitle {
  font-size: 16px;
  color: var(--gray-500);
  margin: 0;
  line-height: 1.6;
  max-width: 600px;
}

/* Flow Cards Grid */
.flows-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(400px, 1fr));
  gap: 24px;
}

.flow-card {
  display: flex;
  align-items: center;
  gap: 20px;
  padding: 28px;
  background: var(--glass-bg-strong);
  border: 1px solid var(--glass-border-subtle);
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.flow-card:hover {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.08);
  border-color: var(--flow-color, var(--sakura));
}

.flow-card-icon {
  width: 60px;
  height: 60px;
  border-radius: var(--radius-lg);
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
  transition: transform 0.3s ease;
}

.flow-card:hover .flow-card-icon {
  transform: scale(1.05);
}

.flow-card-icon svg {
  width: 28px;
  height: 28px;
}

.flow-card-content {
  flex: 1;
}

.flow-card-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--gray-800);
  margin: 0 0 6px 0;
}

.flow-card-description {
  font-size: 14px;
  color: var(--gray-500);
  margin: 0 0 12px 0;
}

.flow-card-meta {
  display: flex;
  gap: 16px;
  font-size: 13px;
}

.flow-card-count {
  color: var(--gray-600);
  font-weight: 500;
}

.flow-card-status {
  color: var(--success-600);
  font-weight: 500;
}

.flow-card-arrow {
  color: var(--gray-400);
  transition: transform var(--transition-fast);
}

.flow-card:hover .flow-card-arrow {
  transform: translateX(4px);
  color: var(--flow-color, var(--brand-navy));
}

.flow-card-arrow svg {
  width: 24px;
  height: 24px;
}

/* Subflows Grid */
.subflows-grid {
  display: grid;
  grid-template-columns: repeat(auto-fill, minmax(320px, 1fr));
  gap: 20px;
}

.subflow-card {
  padding: 24px;
  background: var(--glass-bg-strong);
  border: 1px solid var(--glass-border-subtle);
  border-radius: var(--radius-xl);
  cursor: pointer;
  transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
}

.subflow-card:hover:not(.subflow-card-pending) {
  transform: translateY(-4px);
  box-shadow: 0 12px 40px rgba(0,0,0,0.08);
  border-color: var(--flow-color, var(--sakura));
}

.subflow-card-pending {
  opacity: 0.5;
  cursor: default;
  background: var(--gray-50);
}

.subflow-card-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 12px;
  margin-bottom: 12px;
}

.subflow-card-title {
  font-size: 16px;
  font-weight: 600;
  color: var(--gray-800);
  margin: 0;
}

.subflow-badge {
  padding: 4px 10px;
  border-radius: var(--radius-full);
  font-size: 11px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.subflow-badge.documented {
  background: var(--matcha);
  color: #2d5a2e;
}

.subflow-badge.pending {
  background: var(--gray-200);
  color: var(--gray-600);
}

.subflow-card-description {
  font-size: 14px;
  color: var(--gray-500);
  margin: 0 0 16px 0;
  line-height: 1.5;
}

.subflow-card-footer {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding-top: 16px;
  border-top: 1px solid var(--gray-100);
}

.subflow-step-count {
  font-size: 13px;
  color: var(--gray-500);
}

.subflow-view-link {
  font-size: 13px;
  font-weight: 500;
  color: var(--brand-navy);
}

/* Subflow Detail */
.subflow-detail-header {
  padding: 32px;
  background: var(--glass-bg-strong);
  border-radius: var(--radius-xl);
  border: 1px solid var(--glass-border-subtle);
  margin-bottom: 24px;
  border-left: 4px solid var(--flow-color, var(--sakura));
}

.subflow-detail-title {
  font-size: 26px;
  font-weight: 700;
  color: var(--brand-navy);
  margin: 0 0 8px 0;
  font-family: var(--font-display);
}

.subflow-detail-description {
  font-size: 15px;
  color: var(--gray-500);
  margin: 0;
}

/* Flow Steps */
.flow-steps-container {
  display: flex;
  flex-direction: column;
  gap: 0;
}

.flow-step {
  display: flex;
  gap: 24px;
  position: relative;
}

.flow-step-connector {
  display: flex;
  flex-direction: column;
  align-items: center;
  width: 40px;
  flex-shrink: 0;
}

.flow-step-number {
  width: 40px;
  height: 40px;
  border-radius: 50%;
  background: var(--step-color, var(--sakura));
  color: var(--brand-navy);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  font-weight: 700;
  z-index: 1;
}

.flow-step-line {
  width: 2px;
  flex: 1;
  background: linear-gradient(to bottom, var(--step-color, var(--sakura)), var(--gray-200));
  margin: 8px 0;
}

.flow-step-content {
  flex: 1;
  padding: 0 0 40px 0;
  min-width: 0;
}

.flow-step-header {
  display: flex;
  justify-content: space-between;
  align-items: flex-start;
  gap: 16px;
  margin-bottom: 16px;
}

.flow-step-title-section {
  flex: 1;
}

.flow-step-title {
  font-size: 18px;
  font-weight: 600;
  color: var(--gray-800);
  margin: 0 0 8px 0;
}

.flow-step-meta {
  display: flex;
  flex-wrap: wrap;
  gap: 10px;
  align-items: center;
}

.flow-step-persona {
  padding: 4px 12px;
  border-radius: var(--radius-full);
  font-size: 12px;
  font-weight: 600;
}

.flow-step-function {
  font-size: 12px;
  color: var(--gray-500);
  font-family: var(--font-mono);
}

.flow-step-line-num {
  color: var(--gray-400);
}

.flow-step-id {
  font-size: 11px;
  font-family: var(--font-mono);
  color: var(--gray-400);
  background: var(--gray-100);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
}

.flow-step-description {
  font-size: 14px;
  color: var(--gray-600);
  margin: 0 0 16px 0;
  padding: 12px 16px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
}

/* Flow Messages */
.flow-messages {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-bottom: 20px;
}

.flow-message {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.flow-message-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--gray-50);
  border-bottom: 1px solid var(--gray-100);
}

.flow-message-label {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
}

.flow-suggest-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  font-size: 12px;
  font-weight: 500;
  color: var(--gray-600);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.flow-suggest-btn:hover {
  background: var(--brand-navy);
  color: white;
  border-color: var(--brand-navy);
}

.flow-message-content {
  padding: 16px;
  font-size: 14px;
  line-height: 1.6;
  color: var(--gray-700);
}

/* Flow Section Titles */
.flow-section-title {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-600);
  text-transform: uppercase;
  letter-spacing: 0.05em;
  margin: 0 0 12px 0;
}

/* Flow Fields Table */
.flow-fields {
  margin-bottom: 20px;
}

.flow-fields-table {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  overflow: hidden;
}

.flow-fields-row {
  display: grid;
  grid-template-columns: 1.5fr 1fr 0.8fr 2fr;
  gap: 16px;
  padding: 12px 16px;
  font-size: 13px;
}

.flow-fields-header {
  background: var(--gray-50);
  font-weight: 600;
  color: var(--gray-600);
  border-bottom: 1px solid var(--gray-200);
}

.flow-fields-row:not(.flow-fields-header) {
  border-bottom: 1px solid var(--gray-100);
}

.flow-fields-row:last-child {
  border-bottom: none;
}

.flow-field-name {
  font-weight: 500;
  color: var(--gray-800);
}

.flow-field-type {
  font-family: var(--font-mono);
  font-size: 12px;
  color: var(--gray-500);
}

.flow-field-required {
  color: var(--success-600);
  text-align: center;
}

.flow-field-placeholder {
  color: var(--gray-400);
  font-style: italic;
}

/* Flow Buttons */
.flow-buttons {
  margin-bottom: 20px;
}

.flow-buttons-list {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.flow-button-item {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
}

.flow-button-text {
  font-size: 14px;
  font-weight: 500;
}

.flow-button-text.success { color: var(--success-600); }
.flow-button-text.warning { color: var(--warning-600); }
.flow-button-text.primary { color: var(--brand-navy); }
.flow-button-text.secondary { color: var(--gray-600); }

.flow-button-action {
  font-size: 13px;
  color: var(--gray-500);
}

/* Flow API */
.flow-api {
  margin-bottom: 20px;
}

.flow-api-details {
  background: var(--gray-900);
  border-radius: var(--radius-lg);
  padding: 16px;
}

.flow-api-row {
  display: flex;
  gap: 16px;
  padding: 8px 0;
  border-bottom: 1px solid rgba(255,255,255,0.1);
}

.flow-api-row:last-child {
  border-bottom: none;
}

.flow-api-label {
  font-size: 12px;
  color: var(--gray-400);
  width: 80px;
  flex-shrink: 0;
}

.flow-api-value {
  font-size: 13px;
  color: var(--matcha);
  font-family: var(--font-mono);
}

/* Flow Data Stored */
.flow-data-stored {
  margin-bottom: 20px;
}

.flow-data-list {
  margin: 0;
  padding: 0;
  list-style: none;
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.flow-data-list li {
  font-size: 13px;
}

.flow-data-list code {
  background: var(--gray-100);
  padding: 4px 8px;
  border-radius: var(--radius-sm);
  font-family: var(--font-mono);
  font-size: 12px;
}

/* Flow Substeps (Refund Ladder) */
.flow-substeps {
  margin-bottom: 20px;
}

.flow-substeps-timeline {
  display: flex;
  flex-direction: column;
  gap: 16px;
}

.flow-substep {
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  padding: 20px;
}

.flow-substep-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 12px;
}

.flow-substep-badge {
  width: 28px;
  height: 28px;
  border-radius: 50%;
  background: var(--brand-navy);
  color: white;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 13px;
  font-weight: 600;
}

.flow-substep-name {
  font-size: 15px;
  font-weight: 600;
  color: var(--gray-800);
}

.flow-substep-message {
  font-size: 14px;
  line-height: 1.6;
  color: var(--gray-600);
  padding: 12px 16px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  margin-bottom: 12px;
}

.flow-substep-logic {
  font-size: 13px;
  color: var(--gray-600);
  margin-bottom: 12px;
}

.flow-substep-actions {
  display: flex;
  flex-direction: column;
  gap: 8px;
}

.flow-substep-btn {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 14px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
}

.flow-substep-btn .btn-text {
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-700);
}

.flow-substep-btn .btn-action {
  font-size: 12px;
  color: var(--gray-500);
}

.flow-substep-outcomes,
.flow-substep-location {
  display: flex;
  flex-direction: column;
  gap: 12px;
  margin-top: 12px;
}

.flow-substep-outcomes .outcome,
.flow-substep-location .location {
  padding: 12px 16px;
  border-radius: var(--radius-md);
  font-size: 13px;
  line-height: 1.5;
}

.outcome.expired {
  background: var(--error-50);
  border: 1px solid #fecaca;
}

.outcome.valid {
  background: var(--success-50);
  border: 1px solid #a7f3d0;
}

.location.domestic {
  background: var(--sakura-soft);
  border: 1px solid var(--sakura);
}

.location.international {
  background: var(--fuji-soft);
  border: 1px solid var(--fuji);
}

/* Flow Step Outcome & Next */
.flow-step-outcome,
.flow-step-next {
  font-size: 13px;
  padding: 12px 16px;
  border-radius: var(--radius-md);
  margin-top: 12px;
}

.flow-step-outcome {
  background: var(--matcha-soft);
  border: 1px solid var(--matcha);
  color: #2d5a2e;
}

.flow-step-next {
  background: var(--gray-100);
  color: var(--gray-600);
}

/* Flows Edit Modal */
.flows-modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  right: 0;
  bottom: 0;
  background: rgba(0, 0, 0, 0.5);
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  padding: 20px;
}

.flows-modal-overlay.active {
  display: flex;
}

.flows-modal {
  background: white;
  border-radius: var(--radius-xl);
  width: 100%;
  max-width: 560px;
  max-height: 90vh;
  overflow: hidden;
  box-shadow: var(--shadow-xl);
  display: flex;
  flex-direction: column;
}

.flows-modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 20px 24px;
  border-bottom: 1px solid var(--gray-200);
}

.flows-modal-header h3 {
  font-size: 18px;
  font-weight: 600;
  margin: 0;
  color: var(--gray-800);
}

.flows-modal-close {
  width: 36px;
  height: 36px;
  border: none;
  background: var(--gray-100);
  border-radius: var(--radius-md);
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: var(--gray-500);
  transition: all var(--transition-fast);
}

.flows-modal-close:hover {
  background: var(--gray-200);
  color: var(--gray-700);
}

.flows-modal-close svg {
  width: 20px;
  height: 20px;
}

.flows-modal-body {
  padding: 24px;
  overflow-y: auto;
  flex: 1;
}

.flows-edit-preview {
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  padding: 16px;
  margin-bottom: 20px;
  font-size: 13px;
}

.edit-preview-row {
  margin-bottom: 8px;
  color: var(--gray-600);
}

.edit-preview-row strong {
  color: var(--gray-800);
}

.edit-preview-content {
  margin-top: 12px;
  padding: 12px;
  background: white;
  border-radius: var(--radius-sm);
  font-size: 13px;
  line-height: 1.5;
  color: var(--gray-700);
  max-height: 120px;
  overflow-y: auto;
}

.flows-edit-field {
  margin-bottom: 16px;
}

.flows-edit-field label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-700);
  margin-bottom: 8px;
}

.flows-edit-field textarea {
  width: 100%;
  min-height: 100px;
  padding: 12px;
  border: 1px solid var(--gray-300);
  border-radius: var(--radius-md);
  font-size: 14px;
  font-family: inherit;
  resize: vertical;
  transition: border-color var(--transition-fast);
}

.flows-edit-field textarea:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26, 54, 93, 0.1);
}

.flows-modal-footer {
  display: flex;
  justify-content: flex-end;
  gap: 12px;
  padding: 16px 24px;
  border-top: 1px solid var(--gray-200);
  background: var(--gray-50);
}

/* View Toggle Buttons */
.subflow-view-toggle {
  display: flex;
  gap: 8px;
  margin-left: auto;
}

.view-toggle-btn {
  display: inline-flex;
  align-items: center;
  gap: 8px;
  padding: 10px 16px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-lg);
  font-size: 13px;
  font-weight: 500;
  color: var(--gray-600);
  cursor: pointer;
  transition: all var(--transition-fast);
}

.view-toggle-btn:hover {
  background: var(--gray-50);
  border-color: var(--gray-300);
}

.view-toggle-btn.active {
  background: var(--brand-navy);
  color: white;
  border-color: var(--brand-navy);
}

/* Flow Diagram Container */
.flow-diagram-container {
  margin-top: 24px;
}

.flow-diagram-card {
  background: var(--glass-bg-strong);
  border: 1px solid var(--glass-border-subtle);
  border-radius: var(--radius-xl);
  overflow: hidden;
}

.flow-diagram-header {
  padding: 24px;
  border-bottom: 1px solid var(--gray-100);
}

.flow-diagram-header h3 {
  font-size: 18px;
  font-weight: 600;
  color: var(--gray-800);
  margin: 0 0 8px 0;
}

.flow-diagram-header p {
  font-size: 14px;
  color: var(--gray-500);
  margin: 0;
}

.flow-diagram-content {
  padding: 24px;
  background: linear-gradient(135deg, #fafbfc 0%, #fff 100%);
  overflow-x: auto;
}

.mermaid-diagram {
  display: flex;
  justify-content: center;
  min-height: 400px;
}

.mermaid-diagram svg {
  max-width: 100%;
  height: auto;
}

/* Make mermaid nodes more compact */
.mermaid-diagram .node rect,
.mermaid-diagram .node polygon {
  rx: 8;
  ry: 8;
}

.mermaid-diagram .edgeLabel {
  font-size: 11px !important;
}

.mermaid-diagram .nodeLabel {
  font-size: 12px !important;
  font-weight: 500;
}

.flow-diagram-legend {
  padding: 20px 24px;
  background: var(--gray-50);
  border-top: 1px solid var(--gray-100);
}

.flow-diagram-legend h4 {
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-600);
  margin: 0 0 12px 0;
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.legend-items {
  display: flex;
  flex-wrap: wrap;
  gap: 16px;
}

.legend-item {
  display: flex;
  align-items: center;
  gap: 8px;
  font-size: 13px;
  color: var(--gray-600);
}

.legend-color {
  width: 16px;
  height: 16px;
  border-radius: 4px;
}

/* Branch Step Styling */
.flow-step-branch {
  position: relative;
}

.flow-step-branch::before {
  content: '';
  position: absolute;
  left: 20px;
  top: 0;
  width: 2px;
  height: 20px;
  background: var(--step-color);
}

.flow-step-number-branch {
  font-size: 14px;
}

.flow-step-success .flow-step-number {
  background: var(--matcha) !important;
}

.flow-step-refund .flow-step-number {
  background: var(--momo) !important;
}

.flow-step-decision .flow-step-number {
  background: var(--fuji) !important;
}

.flow-branch-point-indicator {
  display: inline-block;
  padding: 8px 16px;
  background: linear-gradient(135deg, var(--fuji-soft) 0%, #f5f0f5 100%);
  border: 1px solid var(--fuji);
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  color: #6a4c93;
  margin-bottom: 16px;
}

.flow-branch-indicator {
  display: inline-block;
  padding: 8px 16px;
  border-radius: var(--radius-md);
  font-size: 13px;
  font-weight: 500;
  margin-bottom: 16px;
}

.flow-branch-indicator.success {
  background: linear-gradient(135deg, var(--matcha-soft) 0%, #f0f5f0 100%);
  border: 1px solid var(--matcha);
  color: #2d5a2e;
}

.flow-branch-indicator.refund {
  background: linear-gradient(135deg, var(--momo-soft) 0%, #fff5f0 100%);
  border: 1px solid var(--momo);
  color: #8b5a2b;
}

.flow-branch-note {
  font-size: 13px;
  font-style: italic;
  color: var(--gray-500);
  margin: 0 0 16px 0;
  padding: 12px 16px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  border-left: 3px solid var(--fuji);
}

/* Enhanced API Section */
.flow-api-explanation {
  padding: 16px;
  background: linear-gradient(135deg, #f0f7ff 0%, #fff 100%);
  border: 1px solid #d0e3ff;
  border-radius: var(--radius-md);
  margin-bottom: 16px;
}

.flow-api-explanation strong {
  display: block;
  font-size: 13px;
  color: var(--brand-navy);
  margin-bottom: 8px;
}

.flow-api-explanation p {
  font-size: 14px;
  color: var(--gray-700);
  margin: 0;
  line-height: 1.6;
}

.flow-api-data-used {
  padding: 16px;
  background: var(--gray-50);
  border-radius: var(--radius-md);
  margin-top: 16px;
}

.flow-api-data-used strong {
  display: block;
  font-size: 13px;
  color: var(--gray-700);
  margin-bottom: 8px;
}

.flow-api-data-used ul {
  margin: 0;
  padding-left: 20px;
}

.flow-api-data-used li {
  font-size: 13px;
  color: var(--gray-600);
  margin-bottom: 4px;
}

.flow-api-prompt {
  margin-top: 16px;
  border: 1px solid var(--gray-200);
  border-radius: var(--radius-md);
  overflow: hidden;
}

.flow-api-prompt-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 12px 16px;
  background: var(--gray-800);
  color: white;
}

.flow-api-prompt-header strong {
  font-size: 13px;
  font-weight: 500;
}

.flow-api-copy-btn {
  display: inline-flex;
  align-items: center;
  gap: 6px;
  padding: 6px 12px;
  background: rgba(255,255,255,0.1);
  border: 1px solid rgba(255,255,255,0.2);
  border-radius: var(--radius-sm);
  font-size: 12px;
  color: white;
  cursor: pointer;
  transition: all var(--transition-fast);
}

.flow-api-copy-btn:hover {
  background: rgba(255,255,255,0.2);
}

.flow-api-prompt-content {
  margin: 0;
  padding: 16px;
  background: var(--gray-900);
  color: var(--matcha);
  font-family: var(--font-mono);
  font-size: 12px;
  line-height: 1.6;
  white-space: pre-wrap;
  word-wrap: break-word;
  max-height: 300px;
  overflow-y: auto;
}

/* ============================================
   CHAT PREVIEW - Visual matching with chat app
   ============================================ */
.chat-preview {
  background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
  border-radius: var(--radius-lg);
  padding: 20px;
  margin: 16px 0;
  border: 1px solid var(--gray-200);
}

.chat-preview-header {
  display: flex;
  align-items: center;
  gap: 8px;
  margin-bottom: 12px;
  padding-bottom: 12px;
  border-bottom: 1px solid var(--gray-200);
}

.chat-preview-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.05em;
}

.chat-preview-phone {
  width: 100%;
  max-width: 380px;
  margin: 0 auto;
  background: white;
  border-radius: 24px;
  box-shadow: 0 8px 32px rgba(0,0,0,0.12);
  overflow: hidden;
  border: 8px solid #1a1a1a;
}

.chat-preview-messages {
  display: flex;
  flex-direction: column;
  gap: 16px;
  padding: 16px;
  min-height: 120px;
  background: linear-gradient(180deg, #f9fafb 0%, #ffffff 100%);
}

/* Bot Message Style */
.chat-msg {
  display: flex;
  gap: 10px;
  max-width: 90%;
  animation: fadeInUp 0.3s ease;
}

.chat-msg.bot {
  align-self: flex-start;
}

.chat-msg.user {
  align-self: flex-end;
  flex-direction: row-reverse;
}

.chat-msg-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  border: 2px solid white;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

.chat-msg-content {
  display: flex;
  flex-direction: column;
  gap: 4px;
}

.chat-msg-sender {
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-600);
}

.chat-msg-sender.amy { color: #FF6B6B; }
.chat-msg-sender.claudia { color: #A78BFA; }
.chat-msg-sender.sarah { color: #F7B733; }

.chat-msg-bubble {
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
  background: white;
  border: 1px solid var(--gray-200);
  color: var(--gray-800);
}

.chat-msg.bot .chat-msg-bubble {
  border-bottom-left-radius: 4px;
}

.chat-msg.user .chat-msg-bubble {
  background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
  color: white;
  border: none;
  border-bottom-right-radius: 4px;
}

/* Form Preview Style */
.chat-form-preview {
  background: white;
  border-radius: 16px;
  padding: 20px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  border: 1px solid var(--gray-200);
  margin: 8px 0;
}

.chat-form-group {
  margin-bottom: 16px;
}

.chat-form-group:last-child {
  margin-bottom: 0;
}

.chat-form-label {
  display: block;
  font-size: 13px;
  font-weight: 600;
  color: var(--gray-600);
  margin-bottom: 6px;
}

.chat-form-input {
  width: 100%;
  padding: 12px 14px;
  font-size: 14px;
  background: var(--gray-50);
  border: 2px solid transparent;
  border-radius: 10px;
  color: var(--gray-400);
  pointer-events: none;
}

.chat-form-input.textarea {
  min-height: 80px;
  resize: none;
}

/* Button Preview Style */
.chat-buttons-preview {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin-top: 12px;
}

.chat-btn-preview {
  padding: 14px 20px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 600;
  text-align: center;
  cursor: default;
}

.chat-btn-preview.primary {
  background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
  color: white;
}

.chat-btn-preview.secondary {
  background: white;
  border: 2px dashed var(--gray-300);
  color: var(--gray-500);
}

.chat-btn-preview.success {
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  color: white;
}

.chat-btn-preview.danger {
  background: var(--gray-100);
  color: var(--gray-600);
}

/* Choice Buttons (Yes/No style) */
.chat-choice-buttons {
  display: flex;
  gap: 10px;
  margin-top: 12px;
}

.chat-choice-btn {
  flex: 1;
  padding: 14px 16px;
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  text-align: center;
  background: white;
  border: 2px solid var(--gray-200);
  color: var(--gray-700);
  transition: all 0.2s ease;
}

.chat-choice-btn:hover {
  border-color: var(--brand-navy);
  background: var(--brand-navy-soft);
}

.chat-choice-btn.positive {
  border-color: #22c55e;
  color: #16a34a;
}

.chat-choice-btn.negative {
  border-color: #f87171;
  color: #dc2626;
}

/* ============================================
   SIMULATOR - Replicated Chat App Components
   These match the exact design from the chat app
   ============================================ */

/* Offer Card - Exact replica from chat app */
.sim-offer-card {
  position: relative;
  background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
  border-radius: 20px;
  padding: 24px 18px;
  color: white;
  text-align: center;
  overflow: hidden;
  box-shadow: 0 12px 20px -5px rgba(0, 0, 0, 0.15), 0 0 30px rgba(26, 54, 93, 0.15);
  margin: 12px auto;
  width: calc(100% - 16px);
  max-width: 280px;
  align-self: center;
}

.sim-offer-card::before {
  content: '';
  position: absolute;
  top: -50%;
  right: -50%;
  width: 100%;
  height: 100%;
  background: radial-gradient(circle, rgba(255,255,255,0.1) 0%, transparent 60%);
  animation: sim-float 6s ease-in-out infinite;
}

.sim-offer-card::after {
  content: '';
  position: absolute;
  bottom: -30%;
  left: -30%;
  width: 80%;
  height: 80%;
  background: radial-gradient(circle, rgba(78, 205, 196, 0.2) 0%, transparent 60%);
  animation: sim-float 8s ease-in-out infinite reverse;
}

@keyframes sim-float {
  0%, 100% { transform: translateY(0) rotate(0deg); }
  50% { transform: translateY(-10px) rotate(3deg); }
}

.sim-offer-icon {
  font-size: 36px;
  margin-bottom: 10px;
  position: relative;
  z-index: 1;
}

.sim-offer-amount {
  font-family: 'Space Grotesk', 'Poppins', sans-serif;
  font-size: 48px;
  font-weight: 800;
  line-height: 1;
  margin-bottom: 4px;
  background: linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%);
  -webkit-background-clip: text;
  -webkit-text-fill-color: transparent;
  background-clip: text;
  position: relative;
  z-index: 1;
}

.sim-offer-value {
  font-size: 16px;
  opacity: 0.9;
  margin-bottom: 6px;
  position: relative;
  z-index: 1;
}

.sim-offer-label {
  font-size: 13px;
  opacity: 0.75;
  margin-bottom: 18px;
  position: relative;
  z-index: 1;
}

.sim-offer-buttons {
  display: flex;
  gap: 10px;
  position: relative;
  z-index: 1;
}

.sim-offer-btn {
  flex: 1;
  padding: 14px 16px;
  border-radius: 12px;
  font-size: 13px;
  font-weight: 700;
  cursor: default;
  border: none;
}

.sim-offer-btn.accept {
  background: white;
  color: #1a365d;
  box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
}

.sim-offer-btn.decline {
  background: rgba(255,255,255,0.15);
  color: white;
  border: 1px solid rgba(255,255,255,0.3);
}

.sim-offer-note {
  font-size: 11px;
  opacity: 0.65;
  margin-top: 14px;
  position: relative;
  z-index: 1;
}

/* Success Card - Exact replica from chat app */
.sim-success-card {
  text-align: center;
  padding: 24px 18px;
  border-radius: 20px;
  background: linear-gradient(135deg, #E8FFF0 0%, #D1FAE5 100%);
  border: 1px solid rgba(34, 197, 94, 0.2);
  animation: sim-success-enter 0.5s cubic-bezier(0.34, 1.56, 0.64, 1);
  margin: 12px auto;
  width: calc(100% - 16px);
  max-width: 280px;
  align-self: center;
}

@keyframes sim-success-enter {
  0% { opacity: 0; transform: scale(0.9); }
  100% { opacity: 1; transform: scale(1); }
}

.sim-success-icon {
  width: 64px;
  height: 64px;
  border-radius: 50%;
  display: flex;
  align-items: center;
  justify-content: center;
  margin: 0 auto 16px;
  font-size: 28px;
  background: linear-gradient(135deg, #22C55E 0%, #16A34A 100%);
  color: white;
  box-shadow: 0 8px 24px rgba(34, 197, 94, 0.4);
}

.sim-success-title {
  font-family: 'Space Grotesk', 'Poppins', sans-serif;
  font-size: 20px;
  font-weight: 700;
  color: #166534;
  margin-bottom: 12px;
}

.sim-success-message {
  font-size: 14px;
  color: #166534;
  line-height: 1.6;
  opacity: 0.9;
}

.sim-success-case-id {
  margin-top: 16px;
  padding: 12px;
  background: rgba(34, 197, 94, 0.15);
  border-radius: 10px;
  font-size: 12px;
  color: #166534;
}

.sim-success-case-id strong {
  display: block;
  font-size: 14px;
  margin-bottom: 4px;
}

/* Progress Indicator */
.sim-progress {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 14px 18px;
  background: white;
  border-radius: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  margin: 10px auto;
  width: calc(100% - 16px);
  max-width: 260px;
  align-self: center;
}

.sim-progress-spinner {
  width: 24px;
  height: 24px;
  border: 3px solid #e5e7eb;
  border-top-color: #1a365d;
  border-radius: 50%;
  animation: sim-spin 0.8s linear infinite;
}

@keyframes sim-spin {
  to { transform: rotate(360deg); }
}

.sim-progress-text {
  font-size: 14px;
  color: #374151;
  font-weight: 500;
}

/* User Response Bubble */
.sim-user-response {
  align-self: flex-end;
  max-width: 80%;
  margin: 8px 8px 8px auto;
}

.sim-user-bubble {
  padding: 12px 16px;
  background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
  color: white;
  border-radius: 16px;
  border-bottom-right-radius: 4px;
  font-size: 14px;
  line-height: 1.4;
}

/* Case Submission Card */
.sim-case-card {
  background: white;
  border-radius: 16px;
  padding: 16px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  border: 1px solid #e5e7eb;
  margin: 10px auto;
  width: calc(100% - 16px);
  max-width: 280px;
  align-self: center;
}

.sim-case-header {
  display: flex;
  align-items: center;
  gap: 12px;
  margin-bottom: 16px;
  padding-bottom: 12px;
  border-bottom: 1px solid #f3f4f6;
}

.sim-case-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  background: linear-gradient(135deg, #A8D8EA 0%, #87CEEB 100%);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.sim-case-title {
  font-size: 14px;
  font-weight: 600;
  color: #1f2937;
}

.sim-case-subtitle {
  font-size: 12px;
  color: #6b7280;
}

.sim-case-details {
  display: flex;
  flex-direction: column;
  gap: 10px;
}

.sim-case-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.sim-case-label {
  font-size: 12px;
  color: #6b7280;
}

.sim-case-value {
  font-size: 12px;
  font-weight: 600;
  color: #1f2937;
}

.sim-case-value.highlight {
  color: #059669;
  background: #ecfdf5;
  padding: 4px 8px;
  border-radius: 6px;
}

/* ============================================
   FLOW SIMULATOR V2 - Complete Redesign
   ============================================ */
.flow-simulator {
  display: grid;
  grid-template-columns: 320px 1fr 320px;
  gap: 24px;
  height: calc(100vh - 200px);
  min-height: 600px;
  margin-top: 20px;
  padding: 0 8px;
}

/* ==========================================
   LEFT PANEL - Flow Steps Navigation
   ========================================== */
.sim-nav {
  background: white;
  border-radius: 20px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.04);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 1px solid rgba(0,0,0,0.06);
}

.sim-nav-header {
  padding: 20px 20px;
  border-bottom: 1px solid var(--gray-100);
  background: linear-gradient(180deg, white 0%, var(--gray-50) 100%);
}

.sim-nav-header h3 {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-900);
  margin: 0;
  letter-spacing: -0.3px;
}

.sim-nav-header p {
  font-size: 12px;
  color: var(--gray-500);
  margin: 6px 0 0 0;
}

/* Branch Selector */
.sim-branch-selector {
  padding: 12px 16px;
  border-bottom: 1px solid var(--gray-100);
  background: var(--gray-50);
}

.sim-branch-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--gray-500);
  text-transform: uppercase;
  letter-spacing: 0.5px;
  margin-bottom: 8px;
}

.sim-branch-options {
  display: flex;
  flex-direction: column;
  gap: 6px;
}

.sim-branch-btn {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 12px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s ease;
  text-align: left;
}

.sim-branch-btn:hover {
  border-color: var(--brand-navy);
  background: var(--brand-navy-soft);
}

.sim-branch-btn.active {
  background: linear-gradient(135deg, var(--brand-navy) 0%, #2c5282 100%);
  border-color: var(--brand-navy);
  color: white;
}

.sim-branch-icon {
  font-size: 16px;
  flex-shrink: 0;
}

.sim-branch-name {
  font-size: 13px;
  font-weight: 500;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sim-nav-list {
  flex: 1;
  overflow-y: auto;
  padding: 8px;
  scroll-behavior: smooth;
}

/* Fix scroll blocking on click */
.sim-nav-list * {
  pointer-events: auto;
}

.sim-nav-section-title {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.1em;
  color: var(--gray-400);
  padding: 16px 12px 8px;
  margin-top: 8px;
  border-top: 1px solid var(--gray-100);
}

.sim-nav-section-title:first-child {
  border-top: none;
  padding-top: 0;
  margin-top: 0;
}

.sim-nav-item {
  display: flex;
  align-items: center;
  gap: 12px;
  padding: 12px 14px;
  border-radius: 12px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  margin-bottom: 4px;
  border: 1px solid transparent;
}

.sim-nav-item:hover {
  background: var(--gray-50);
  border-color: var(--gray-100);
  transform: translateX(4px);
}

.sim-nav-item.active {
  background: linear-gradient(135deg, var(--brand-navy) 0%, #2d4a6d 100%);
  border-color: var(--brand-navy);
  box-shadow: 0 4px 12px rgba(26, 54, 93, 0.25);
}

.sim-nav-item.active .sim-nav-step-num {
  background: rgba(255,255,255,0.2);
  color: white;
  border-color: rgba(255,255,255,0.3);
}

.sim-nav-item.active .sim-nav-step-name {
  color: white;
  font-weight: 600;
}

.sim-nav-item.active .sim-nav-badge {
  background: rgba(255,255,255,0.2);
  color: white;
}

.sim-nav-item.completed .sim-nav-step-num {
  background: #dcfce7;
  color: #166534;
  border-color: #bbf7d0;
}

.sim-nav-step-num {
  width: 26px;
  height: 26px;
  border-radius: 8px;
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 11px;
  font-weight: 700;
  color: var(--gray-500);
  flex-shrink: 0;
}

.sim-nav-step-name {
  font-size: 12px;
  font-weight: 500;
  color: var(--gray-700);
  line-height: 1.3;
  flex: 1;
  white-space: nowrap;
  overflow: hidden;
  text-overflow: ellipsis;
}

.sim-nav-badge {
  font-size: 8px;
  font-weight: 700;
  padding: 3px 6px;
  border-radius: 5px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
  flex-shrink: 0;
}

.sim-nav-badge.success { background: #dcfce7; color: #15803d; }
.sim-nav-badge.refund { background: #fef3c7; color: #b45309; }
.sim-nav-badge.decision { background: #f3e8ff; color: #7c3aed; }

/* ==========================================
   CENTER PANEL - Phone Mockup
   ========================================== */
.sim-phone-container {
  display: flex;
  align-items: center;
  justify-content: center;
  padding: 20px;
  background: transparent;
  position: relative;
  overflow: hidden;
}

/* Background element (kept for potential future use but hidden) */
.sim-phone-bg {
  display: none;
}

/* Phone Device Frame */
.sim-phone {
  width: 100%;
  max-width: 400px;
  height: 100%;
  max-height: 700px;
  background: rgba(255,255,255,0.95);
  border-radius: 24px;
  box-shadow: 0 25px 50px -12px rgba(0,0,0,0.15), 0 0 0 1px rgba(255,255,255,0.5);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  position: relative;
  z-index: 1;
  backdrop-filter: blur(20px);
}

/* Phone Header - Matches Chat App */
.sim-phone-header {
  display: flex;
  align-items: center;
  padding: 14px 16px;
  background: white;
  border-bottom: 1px solid var(--gray-100);
}

.sim-phone-avatar-ring {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  padding: 3px;
  background: linear-gradient(135deg, #FF6B6B 0%, #FF8E53 100%);
  flex-shrink: 0;
}

.sim-phone-avatar-ring.claudia {
  background: linear-gradient(135deg, #A78BFA 0%, #818CF8 100%);
}

.sim-phone-avatar {
  width: 100%;
  height: 100%;
  border-radius: 50%;
  object-fit: cover;
  border: 2px solid white;
}

.sim-phone-info {
  margin-left: 12px;
  flex: 1;
}

.sim-phone-name {
  font-family: 'Space Grotesk', sans-serif;
  font-size: 16px;
  font-weight: 700;
  color: var(--gray-900);
  margin: 0;
}

.sim-phone-status {
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  color: var(--gray-500);
}

.sim-phone-status-dot {
  width: 8px;
  height: 8px;
  border-radius: 50%;
  background: #22c55e;
}

.sim-phone-restart {
  padding: 8px 14px;
  background: var(--gray-100);
  border: none;
  border-radius: 20px;
  font-size: 12px;
  font-weight: 500;
  color: var(--gray-600);
  display: flex;
  align-items: center;
  gap: 6px;
  cursor: default;
}

.sim-phone-restart svg {
  width: 14px;
  height: 14px;
}

/* Phone Chat Area */
.sim-phone-chat {
  flex: 1;
  overflow-y: auto;
  padding: 16px 12px;
  display: flex;
  flex-direction: column;
  gap: 12px;
  align-items: stretch;
}

/* Chat Messages */
.sim-msg {
  display: flex;
  gap: 10px;
  max-width: 88%;
  animation: simMsgIn 0.25s ease;
}

@keyframes simMsgIn {
  from { opacity: 0; transform: translateY(8px); }
  to { opacity: 1; transform: translateY(0); }
}

.sim-msg.bot { align-self: flex-start; }
.sim-msg.user { align-self: flex-end; flex-direction: row-reverse; }

.sim-msg-avatar {
  width: 32px;
  height: 32px;
  border-radius: 50%;
  object-fit: cover;
  flex-shrink: 0;
  border: 2px solid white;
  box-shadow: 0 2px 6px rgba(0,0,0,0.1);
}

.sim-msg-content {
  display: flex;
  flex-direction: column;
  gap: 3px;
}

.sim-msg-sender {
  font-size: 11px;
  font-weight: 600;
  padding-left: 2px;
}

.sim-msg-sender.amy { color: #dc2626; }
.sim-msg-sender.claudia { color: #7c3aed; }

.sim-msg-bubble {
  padding: 12px 16px;
  border-radius: 16px;
  font-size: 14px;
  line-height: 1.5;
  background: white;
  box-shadow: 0 1px 2px rgba(0,0,0,0.06);
  border: 1px solid var(--gray-100);
}

.sim-msg.bot .sim-msg-bubble {
  border-bottom-left-radius: 4px;
}

.sim-msg.user .sim-msg-bubble {
  background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
  color: white;
  border: none;
  border-bottom-right-radius: 4px;
}

/* Form Styling */
.sim-form {
  background: white;
  border-radius: 14px;
  padding: 16px;
  box-shadow: 0 1px 3px rgba(0,0,0,0.06);
  border: 1px solid var(--gray-100);
  margin: 6px 0;
}

.sim-form-group {
  margin-bottom: 12px;
}

.sim-form-group:last-child {
  margin-bottom: 0;
}

.sim-form-label {
  display: block;
  font-size: 12px;
  font-weight: 600;
  color: var(--gray-600);
  margin-bottom: 6px;
}

.sim-form-input {
  width: 100%;
  padding: 10px 12px;
  font-size: 14px;
  background: var(--gray-50);
  border: 2px solid var(--gray-200);
  border-radius: 10px;
  color: var(--gray-400);
}

/* Buttons */
.sim-buttons {
  display: flex;
  flex-direction: column;
  gap: 10px;
  margin: 10px 0;
}

/* Option Buttons - Match actual chat app styling */
.sim-btn {
  width: 100%;
  padding: 14px 16px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  text-align: left;
  box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
  display: flex;
  align-items: center;
  gap: 12px;
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-700);
  cursor: default;
  transition: all 0.2s ease;
}

.sim-btn .btn-icon {
  width: 36px;
  height: 36px;
  border-radius: 8px;
  background: var(--gray-100);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 16px;
  flex-shrink: 0;
}

.sim-btn.primary {
  background: linear-gradient(135deg, #1a365d 0%, #2d3748 100%);
  color: white;
  border: none;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(26, 54, 93, 0.2);
}

.sim-btn.primary .btn-icon {
  background: transparent;
  width: auto;
  height: auto;
  color: white;
}

.sim-btn.secondary {
  background: white;
  border: 1px solid var(--gray-200);
  color: var(--gray-700);
}

.sim-btn.success {
  background: linear-gradient(135deg, #22c55e 0%, #16a34a 100%);
  color: white;
  border: none;
  justify-content: center;
}

/* Phone Footer */
.sim-phone-footer {
  padding: 12px 16px;
  background: white;
  border-top: 1px solid var(--gray-100);
  text-align: center;
}

.sim-phone-trouble {
  font-size: 11px;
  color: var(--gray-400);
  margin-bottom: 8px;
}

.sim-phone-trouble span {
  color: var(--brand-navy);
  text-decoration: underline;
}

.sim-phone-logo {
  height: 20px;
  opacity: 0.6;
}

/* Navigation Footer */
.sim-nav-footer {
  padding: 12px;
  border-top: 1px solid var(--gray-100);
  display: flex;
  gap: 8px;
}

.sim-nav-btn {
  flex: 1;
  padding: 10px;
  border-radius: 8px;
  font-size: 12px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.15s ease;
  border: none;
}

.sim-nav-btn.primary {
  background: var(--brand-navy);
  color: white;
}

.sim-nav-btn.primary:hover {
  background: #2d4a6d;
}

.sim-nav-btn.primary:disabled {
  opacity: 0.4;
  cursor: not-allowed;
}

.sim-nav-btn.secondary {
  background: var(--gray-100);
  color: var(--gray-600);
}

.sim-nav-btn.secondary:hover {
  background: var(--gray-200);
}

.sim-nav-btn svg {
  width: 14px;
  height: 14px;
}

/* ==========================================
   RIGHT PANEL - Step Details
   ========================================== */
.sim-docs {
  background: white;
  border-radius: 20px;
  box-shadow: 0 4px 24px rgba(0,0,0,0.04), 0 1px 2px rgba(0,0,0,0.04);
  display: flex;
  flex-direction: column;
  overflow: hidden;
  border: 1px solid rgba(0,0,0,0.06);
}

.sim-docs-header {
  padding: 20px 20px;
  border-bottom: 1px solid var(--gray-100);
  background: linear-gradient(180deg, white 0%, var(--gray-50) 100%);
}

.sim-docs-header h3 {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-900);
  margin: 0;
  letter-spacing: -0.3px;
}

.sim-docs-step-name {
  font-size: 13px;
  color: var(--brand-navy);
  font-weight: 600;
  margin-top: 6px;
}

.sim-docs-content {
  flex: 1;
  overflow-y: auto;
  padding: 18px;
}

.sim-docs-section {
  margin-bottom: 24px;
}

.sim-docs-section:last-child {
  margin-bottom: 0;
}

.sim-docs-section-title {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--gray-400);
  margin-bottom: 10px;
  display: flex;
  align-items: center;
  gap: 6px;
}

.sim-docs-section-title svg {
  width: 12px;
  height: 12px;
}

/* Editable messages */
.sim-docs-message {
  background: var(--gray-50);
  border-radius: 10px;
  padding: 12px;
  margin-bottom: 10px;
  position: relative;
  border: 1px solid var(--gray-100);
}

.sim-docs-message-label {
  font-size: 10px;
  font-weight: 700;
  color: var(--gray-500);
  margin-bottom: 6px;
  text-transform: uppercase;
  letter-spacing: 0.03em;
}

.sim-docs-message-content {
  font-size: 12px;
  color: var(--gray-600);
  line-height: 1.5;
}

.sim-docs-edit-btn {
  position: absolute;
  top: 8px;
  right: 8px;
  padding: 4px 8px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 6px;
  font-size: 10px;
  font-weight: 600;
  color: var(--gray-400);
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 4px;
  transition: all 0.12s ease;
}

.sim-docs-edit-btn:hover {
  background: var(--brand-navy);
  color: white;
  border-color: var(--brand-navy);
}

.sim-docs-edit-btn svg {
  width: 10px;
  height: 10px;
}

/* Info cards */
.sim-docs-info {
  background: var(--gray-50);
  border-radius: 10px;
  padding: 10px 12px;
  border: 1px solid var(--gray-100);
}

.sim-docs-info-row {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 6px 0;
  border-bottom: 1px solid var(--gray-100);
}

.sim-docs-info-row:last-child {
  border-bottom: none;
}

.sim-docs-info-label {
  font-size: 11px;
  color: var(--gray-500);
}

.sim-docs-info-value {
  font-size: 11px;
  font-weight: 600;
  color: var(--gray-700);
}

.sim-docs-info-value code {
  font-family: var(--font-mono);
  font-size: 10px;
  background: white;
  padding: 2px 5px;
  border-radius: 4px;
  border: 1px solid var(--gray-200);
}

/* API section */
.sim-docs-api {
  background: var(--gray-900);
  border-radius: 8px;
  padding: 10px 12px;
  color: #86efac;
  font-family: var(--font-mono);
  font-size: 10px;
  max-height: 120px;
  overflow-y: auto;
}

/* Data badges */
.sim-docs-data-list {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.sim-docs-data-badge {
  font-size: 10px;
  font-family: var(--font-mono);
  background: #e0f2fe;
  color: #0369a1;
  padding: 3px 7px;
  border-radius: 5px;
}

/* Responsive */
@media (max-width: 768px) {
  .flows-header {
    flex-direction: column;
    padding: 24px;
  }
  
  .flow-card {
    flex-direction: column;
    align-items: flex-start;
    text-align: left;
  }
  
  .flow-card-arrow {
    align-self: flex-end;
  }
  
  .subflows-grid {
    grid-template-columns: 1fr;
  }
  
  .flow-step {
    gap: 16px;
  }
  
  .flow-step-header {
    flex-direction: column;
    gap: 8px;
  }
  
  .flow-fields-row {
    grid-template-columns: 1fr 1fr;
    gap: 8px;
  }
  
  .flow-fields-row span:nth-child(3),
  .flow-fields-row span:nth-child(4) {
    grid-column: span 1;
  }
}

/* ============================================
   REACT FLOW-STYLE DOCUMENTATION VIEWER
   ============================================ */

/* Main container - 3 panel layout */
.flow-viewer {
  display: flex;
  height: calc(100vh - 80px);
  background: linear-gradient(135deg, #fef3e2 0%, #f3e8ff 50%, #dbeafe 100%);
  border-radius: 16px;
  overflow: hidden;
}

/* Left Panel - Flow Selector */
.flow-selector {
  width: 260px;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(12px);
  border-right: 1px solid rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.flow-selector-header {
  padding: 20px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
}

.flow-selector-header h3 {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-900);
  margin: 0 0 12px 0;
  font-family: var(--font-display);
}

.flow-selector-search {
  width: 100%;
  padding: 10px 12px;
  border: 1px solid var(--gray-200);
  border-radius: 10px;
  font-size: 13px;
  background: white;
  transition: all 0.2s;
}

.flow-selector-search:focus {
  outline: none;
  border-color: var(--brand-navy);
  box-shadow: 0 0 0 3px rgba(26,54,93,0.1);
}

.flow-selector-list {
  flex: 1;
  overflow-y: auto;
  padding: 12px;
}

/* Flow tree items */
.flow-tree-section {
  margin-bottom: 8px;
}

.flow-tree-parent {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 12px 14px;
  border-radius: 10px;
  cursor: pointer;
  transition: all 0.2s;
  font-weight: 600;
  font-size: 13px;
  color: var(--gray-700);
}

.flow-tree-parent:hover {
  background: rgba(0,0,0,0.04);
}

.flow-tree-parent.expanded {
  background: rgba(26,54,93,0.08);
  color: var(--brand-navy);
}

.flow-tree-parent-icon {
  width: 32px;
  height: 32px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.flow-tree-parent-icon svg {
  width: 16px;
  height: 16px;
}

.flow-tree-toggle {
  margin-left: auto;
  color: var(--gray-400);
  transition: transform 0.2s;
}

.flow-tree-parent.expanded .flow-tree-toggle {
  transform: rotate(90deg);
}

.flow-tree-children {
  padding-left: 20px;
  display: none;
}

.flow-tree-section.expanded .flow-tree-children {
  display: block;
}

.flow-tree-child {
  display: flex;
  align-items: center;
  gap: 10px;
  padding: 10px 14px;
  margin: 2px 0;
  border-radius: 8px;
  cursor: pointer;
  transition: all 0.2s;
  font-size: 13px;
  color: var(--gray-600);
}

.flow-tree-child:hover {
  background: rgba(0,0,0,0.04);
  color: var(--gray-800);
}

.flow-tree-child.active {
  background: var(--brand-navy);
  color: white;
}

.flow-tree-child-dot {
  width: 6px;
  height: 6px;
  border-radius: 50%;
  background: currentColor;
  opacity: 0.4;
}

.flow-tree-child.active .flow-tree-child-dot {
  background: white;
  opacity: 1;
}

/* Center Panel - Canvas */
.flow-canvas-container {
  flex: 1;
  display: flex;
  flex-direction: column;
  position: relative;
  overflow: hidden;
}

/* Canvas toolbar */
.flow-canvas-toolbar {
  position: absolute;
  top: 16px;
  left: 50%;
  transform: translateX(-50%);
  display: flex;
  gap: 8px;
  z-index: 10;
  background: rgba(255,255,255,0.95);
  padding: 8px 12px;
  border-radius: 12px;
  box-shadow: 0 4px 20px rgba(0,0,0,0.08);
  border: 1px solid rgba(0,0,0,0.06);
}

.flow-canvas-toolbar-btn {
  padding: 8px 12px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  gap: 6px;
  font-size: 12px;
  font-weight: 500;
  color: var(--gray-600);
  transition: all 0.2s;
}

.flow-canvas-toolbar-btn:hover {
  background: var(--gray-100);
  color: var(--gray-900);
}

.flow-canvas-toolbar-btn svg {
  width: 14px;
  height: 14px;
}

.flow-canvas-toolbar-divider {
  width: 1px;
  background: var(--gray-200);
  margin: 0 4px;
}

/* Flow title bar */
.flow-canvas-title {
  position: absolute;
  top: 16px;
  left: 16px;
  background: rgba(255,255,255,0.95);
  padding: 10px 16px;
  border-radius: 10px;
  box-shadow: 0 4px 16px rgba(0,0,0,0.06);
  border: 1px solid rgba(0,0,0,0.06);
  z-index: 10;
  max-width: 280px;
}

.flow-canvas-title h4 {
  font-size: 14px;
  font-weight: 700;
  color: var(--gray-900);
  margin: 0 0 4px 0;
}

.flow-canvas-title p {
  font-size: 11px;
  color: var(--gray-500);
  margin: 0;
}

/* The actual canvas */
.flow-canvas {
  flex: 1;
  position: relative;
  overflow: auto;
  background: 
    radial-gradient(circle at 1px 1px, rgba(0,0,0,0.08) 1px, transparent 0);
  background-size: 20px 20px;
}

.flow-canvas-inner {
  position: relative;
  min-width: 100%;
  min-height: 100%;
  padding: 100px 60px 60px;
}

/* Flow Nodes */
.flow-node {
  position: absolute;
  min-width: 180px;
  max-width: 250px;
  background: white;
  border: 2px solid var(--gray-200);
  border-radius: 12px;
  padding: 14px 16px;
  cursor: pointer;
  transition: all 0.2s cubic-bezier(0.4, 0, 0.2, 1);
  box-shadow: 0 4px 12px rgba(0,0,0,0.06);
}

.flow-node:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 24px rgba(0,0,0,0.1);
}

.flow-node.selected {
  border-width: 2px;
  box-shadow: 0 0 0 4px rgba(var(--node-color-rgb), 0.2);
}

.flow-node-header {
  display: flex;
  align-items: center;
  gap: 10px;
  margin-bottom: 8px;
}

.flow-node-icon {
  width: 28px;
  height: 28px;
  border-radius: 8px;
  display: flex;
  align-items: center;
  justify-content: center;
  flex-shrink: 0;
}

.flow-node-icon svg {
  width: 14px;
  height: 14px;
}

.flow-node-type {
  font-size: 10px;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.04em;
  color: var(--gray-500);
}

.flow-node-content {
  font-size: 12px;
  color: var(--gray-700);
  line-height: 1.4;
  overflow: hidden;
  text-overflow: ellipsis;
  display: -webkit-box;
  -webkit-line-clamp: 2;
  -webkit-box-orient: vertical;
}

/* Node handles (connection points) */
.flow-node-handle {
  position: absolute;
  width: 10px;
  height: 10px;
  border-radius: 50%;
  background: var(--node-color, #3b82f6);
  border: 2px solid white;
  box-shadow: 0 2px 4px rgba(0,0,0,0.15);
}

.flow-node-handle.top {
  top: -5px;
  left: 50%;
  transform: translateX(-50%);
}

.flow-node-handle.bottom {
  bottom: -5px;
  left: 50%;
  transform: translateX(-50%);
}

.flow-node-handle.left {
  left: -5px;
  top: 50%;
  transform: translateY(-50%);
}

.flow-node-handle.right {
  right: -5px;
  top: 50%;
  transform: translateY(-50%);
}

/* Node type colors */
.flow-node[data-type="start"] { --node-color: #22c55e; --node-color-rgb: 34,197,94; }
.flow-node[data-type="message"] { --node-color: #3b82f6; --node-color-rgb: 59,130,246; }
.flow-node[data-type="options"] { --node-color: #8b5cf6; --node-color-rgb: 139,92,246; }
.flow-node[data-type="condition"] { --node-color: #f59e0b; --node-color-rgb: 245,158,11; }
.flow-node[data-type="form"] { --node-color: #10b981; --node-color-rgb: 16,185,129; }
.flow-node[data-type="api"] { --node-color: #ec4899; --node-color-rgb: 236,72,153; }
.flow-node[data-type="ai"] { --node-color: #6366f1; --node-color-rgb: 99,102,241; }
.flow-node[data-type="ladder"] { --node-color: #14b8a6; --node-color-rgb: 20,184,166; }
.flow-node[data-type="offer"] { --node-color: #22c55e; --node-color-rgb: 34,197,94; }
.flow-node[data-type="case"] { --node-color: #f97316; --node-color-rgb: 249,115,22; }
.flow-node[data-type="end"] { --node-color: #ef4444; --node-color-rgb: 239,68,68; }

.flow-node[data-type="start"] .flow-node-icon { background: rgba(34,197,94,0.15); color: #22c55e; }
.flow-node[data-type="message"] .flow-node-icon { background: rgba(59,130,246,0.15); color: #3b82f6; }
.flow-node[data-type="options"] .flow-node-icon { background: rgba(139,92,246,0.15); color: #8b5cf6; }
.flow-node[data-type="condition"] .flow-node-icon { background: rgba(245,158,11,0.15); color: #f59e0b; }
.flow-node[data-type="form"] .flow-node-icon { background: rgba(16,185,129,0.15); color: #10b981; }
.flow-node[data-type="api"] .flow-node-icon { background: rgba(236,72,153,0.15); color: #ec4899; }
.flow-node[data-type="ai"] .flow-node-icon { background: rgba(99,102,241,0.15); color: #6366f1; }
.flow-node[data-type="ladder"] .flow-node-icon { background: rgba(20,184,166,0.15); color: #14b8a6; }
.flow-node[data-type="offer"] .flow-node-icon { background: rgba(34,197,94,0.15); color: #22c55e; }
.flow-node[data-type="case"] .flow-node-icon { background: rgba(249,115,22,0.15); color: #f97316; }
.flow-node[data-type="end"] .flow-node-icon { background: rgba(239,68,68,0.15); color: #ef4444; }

.flow-node.selected {
  border-color: var(--node-color);
}

/* Edge lines (connections) */
.flow-edge {
  position: absolute;
  pointer-events: none;
}

.flow-edge-path {
  fill: none;
  stroke: var(--gray-300);
  stroke-width: 2;
  stroke-dasharray: 5 3;
  animation: flow-edge-dash 1s linear infinite;
}

@keyframes flow-edge-dash {
  to { stroke-dashoffset: -8; }
}

/* MiniMap */
.flow-minimap {
  position: absolute;
  bottom: 16px;
  right: 16px;
  width: 160px;
  height: 100px;
  background: rgba(255,255,255,0.95);
  border-radius: 10px;
  border: 1px solid rgba(0,0,0,0.1);
  box-shadow: 0 4px 16px rgba(0,0,0,0.08);
  overflow: hidden;
  z-index: 10;
}

.flow-minimap-nodes {
  position: relative;
  width: 100%;
  height: 100%;
  padding: 8px;
}

.flow-minimap-node {
  position: absolute;
  width: 8px;
  height: 8px;
  border-radius: 2px;
}

/* Controls */
.flow-controls {
  position: absolute;
  bottom: 16px;
  left: 16px;
  display: flex;
  flex-direction: column;
  gap: 4px;
  z-index: 10;
}

.flow-control-btn {
  width: 36px;
  height: 36px;
  border: none;
  background: rgba(255,255,255,0.95);
  border-radius: 8px;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  box-shadow: 0 2px 8px rgba(0,0,0,0.08);
  transition: all 0.2s;
  color: var(--gray-600);
}

.flow-control-btn:hover {
  background: white;
  color: var(--gray-900);
  box-shadow: 0 4px 12px rgba(0,0,0,0.12);
}

.flow-control-btn svg {
  width: 18px;
  height: 18px;
}

/* Right Panel - Properties */
.flow-properties {
  width: 320px;
  background: rgba(255,255,255,0.92);
  backdrop-filter: blur(12px);
  border-left: 1px solid rgba(0,0,0,0.08);
  display: flex;
  flex-direction: column;
  overflow: hidden;
}

.flow-properties-empty {
  flex: 1;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 40px;
  text-align: center;
  color: var(--gray-400);
}

.flow-properties-empty svg {
  width: 48px;
  height: 48px;
  margin-bottom: 16px;
  opacity: 0.3;
}

.flow-properties-empty p {
  margin: 0 0 4px;
  font-weight: 500;
  color: var(--gray-500);
}

.flow-properties-empty span {
  font-size: 13px;
}

/* Properties header */
.flow-properties-header {
  padding: 20px;
  border-bottom: 1px solid rgba(0,0,0,0.06);
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.flow-properties-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.flow-properties-icon {
  width: 40px;
  height: 40px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

.flow-properties-icon svg {
  width: 20px;
  height: 20px;
}

.flow-properties-title h3 {
  font-size: 15px;
  font-weight: 700;
  color: var(--gray-900);
  margin: 0 0 2px 0;
  text-transform: capitalize;
}

.flow-properties-title span {
  font-size: 11px;
  color: var(--gray-500);
}

.flow-properties-delete {
  padding: 8px;
  border: none;
  background: transparent;
  border-radius: 8px;
  cursor: pointer;
  color: var(--gray-400);
  transition: all 0.2s;
}

.flow-properties-delete:hover {
  background: #fef2f2;
  color: #ef4444;
}

/* Properties content */
.flow-properties-content {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
}

.flow-properties-section {
  margin-bottom: 24px;
}

.flow-properties-section:last-child {
  margin-bottom: 0;
}

.flow-properties-section-title {
  font-size: 10px;
  font-weight: 700;
  text-transform: uppercase;
  letter-spacing: 0.06em;
  color: var(--gray-400);
  margin-bottom: 12px;
}

/* Property fields (read-only) */
.flow-property-field {
  margin-bottom: 14px;
}

.flow-property-field:last-child {
  margin-bottom: 0;
}

.flow-property-label {
  font-size: 11px;
  font-weight: 600;
  color: var(--gray-500);
  margin-bottom: 6px;
  display: block;
}

.flow-property-value {
  padding: 10px 12px;
  background: var(--gray-50);
  border: 1px solid var(--gray-200);
  border-radius: 8px;
  font-size: 13px;
  color: var(--gray-800);
  line-height: 1.5;
}

.flow-property-value.code {
  font-family: var(--font-mono);
  font-size: 11px;
  background: #1e293b;
  color: #86efac;
  border-color: #334155;
}

.flow-property-value.message {
  white-space: pre-wrap;
  max-height: 150px;
  overflow-y: auto;
}

/* Property badges */
.flow-property-badges {
  display: flex;
  flex-wrap: wrap;
  gap: 6px;
}

.flow-property-badge {
  padding: 4px 10px;
  background: #e0f2fe;
  color: #0369a1;
  border-radius: 6px;
  font-size: 11px;
  font-weight: 500;
}

.flow-property-badge.green {
  background: #dcfce7;
  color: #166534;
}

.flow-property-badge.purple {
  background: #f3e8ff;
  color: #7c3aed;
}

.flow-property-badge.orange {
  background: #ffedd5;
  color: #c2410c;
}

/* Simulate button */
.flow-simulate-btn {
  width: 100%;
  padding: 14px;
  background: var(--brand-navy);
  color: white;
  border: none;
  border-radius: 10px;
  font-size: 14px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
  transition: all 0.2s;
  margin-top: 20px;
}

.flow-simulate-btn:hover {
  background: #2d4a6d;
  transform: translateY(-1px);
}

.flow-simulate-btn svg {
  width: 18px;
  height: 18px;
}

/* ============================================
   SIMULATOR POPUP MODAL
   ============================================ */
.flow-simulator-modal {
  position: fixed;
  inset: 0;
  background: rgba(0,0,0,0.6);
  backdrop-filter: blur(4px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  animation: fadeIn 0.2s ease;
}

@keyframes fadeIn {
  from { opacity: 0; }
  to { opacity: 1; }
}

.flow-simulator-container {
  width: 100%;
  max-width: 420px;
  height: 700px;
  max-height: 90vh;
  background: white;
  border-radius: 24px;
  display: flex;
  flex-direction: column;
  overflow: hidden;
  box-shadow: 0 25px 80px rgba(0,0,0,0.25);
  animation: slideUp 0.3s ease;
}

@keyframes slideUp {
  from { transform: translateY(20px); opacity: 0; }
  to { transform: translateY(0); opacity: 1; }
}

/* Simulator header */
.flow-simulator-header {
  padding: 16px 20px;
  background: linear-gradient(135deg, var(--brand-navy) 0%, #2d4a6d 100%);
  color: white;
  display: flex;
  align-items: center;
  justify-content: space-between;
}

.flow-simulator-header-left {
  display: flex;
  align-items: center;
  gap: 12px;
}

.flow-simulator-avatar {
  width: 44px;
  height: 44px;
  border-radius: 50%;
  background: rgba(255,255,255,0.2);
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 20px;
}

.flow-simulator-info h4 {
  font-size: 15px;
  font-weight: 600;
  margin: 0 0 2px 0;
}

.flow-simulator-info p {
  font-size: 12px;
  opacity: 0.8;
  margin: 0;
}

.flow-simulator-close {
  width: 36px;
  height: 36px;
  border: none;
  background: rgba(255,255,255,0.15);
  border-radius: 50%;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  color: white;
  transition: all 0.2s;
}

.flow-simulator-close:hover {
  background: rgba(255,255,255,0.25);
}

.flow-simulator-close svg {
  width: 20px;
  height: 20px;
}

/* Simulator messages */
.flow-simulator-messages {
  flex: 1;
  overflow-y: auto;
  padding: 20px;
  background: linear-gradient(180deg, #fef7ed 0%, #fef3e2 50%, #f3e8ff 100%);
}

.flow-simulator-message {
  margin-bottom: 16px;
  animation: messageIn 0.3s ease;
}

@keyframes messageIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

.flow-simulator-message.bot {
  display: flex;
  gap: 10px;
}

.flow-simulator-message.user {
  display: flex;
  justify-content: flex-end;
}

.flow-simulator-persona-avatar {
  width: 36px;
  height: 36px;
  border-radius: 50%;
  flex-shrink: 0;
  display: flex;
  align-items: center;
  justify-content: center;
  font-size: 14px;
  color: white;
  font-weight: 600;
}

.flow-simulator-persona-avatar.amy {
  background: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
}

.flow-simulator-persona-avatar.claudia {
  background: linear-gradient(135deg, #8b5cf6 0%, #a78bfa 100%);
}

.flow-simulator-persona-avatar.sarah {
  background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
}

.flow-simulator-bubble {
  max-width: 280px;
  padding: 14px 16px;
  border-radius: 18px;
  font-size: 14px;
  line-height: 1.5;
}

.flow-simulator-bubble.bot {
  background: white;
  border-radius: 18px 18px 18px 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.flow-simulator-bubble.user {
  background: var(--brand-navy);
  color: white;
  border-radius: 18px 18px 4px 18px;
}

/* Options in simulator */
.flow-simulator-options {
  display: flex;
  flex-direction: column;
  gap: 8px;
  margin-top: 12px;
}

.flow-simulator-option {
  padding: 12px 16px;
  background: white;
  border: 1px solid var(--gray-200);
  border-radius: 12px;
  font-size: 14px;
  font-weight: 500;
  color: var(--gray-700);
  cursor: pointer;
  transition: all 0.2s;
  text-align: left;
}

.flow-simulator-option:hover {
  border-color: var(--brand-navy);
  background: #f8fafc;
}

/* Typing indicator */
.flow-simulator-typing {
  display: flex;
  gap: 10px;
  padding: 12px 0;
}

.flow-simulator-typing-dots {
  display: flex;
  gap: 4px;
  padding: 12px 16px;
  background: white;
  border-radius: 18px 18px 18px 4px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
}

.flow-simulator-typing-dots span {
  width: 8px;
  height: 8px;
  background: var(--gray-300);
  border-radius: 50%;
  animation: typing-bounce 1.4s infinite;
}

.flow-simulator-typing-dots span:nth-child(2) { animation-delay: 0.2s; }
.flow-simulator-typing-dots span:nth-child(3) { animation-delay: 0.4s; }

@keyframes typing-bounce {
  0%, 60%, 100% { transform: translateY(0); }
  30% { transform: translateY(-6px); }
}

/* Simulator footer */
.flow-simulator-footer {
  padding: 16px 20px;
  border-top: 1px solid var(--gray-100);
  display: flex;
  gap: 8px;
}

.flow-simulator-footer-btn {
  flex: 1;
  padding: 12px;
  border: none;
  border-radius: 10px;
  font-size: 13px;
  font-weight: 600;
  cursor: pointer;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 6px;
  transition: all 0.2s;
}

.flow-simulator-footer-btn.secondary {
  background: var(--gray-100);
  color: var(--gray-700);
}

.flow-simulator-footer-btn.secondary:hover {
  background: var(--gray-200);
}

.flow-simulator-footer-btn.primary {
  background: var(--brand-navy);
  color: white;
}

.flow-simulator-footer-btn.primary:hover {
  background: #2d4a6d;
}

.flow-simulator-footer-btn svg {
  width: 16px;
  height: 16px;
}

/* ============================================
   React Flow Documentation Styles
   ============================================ */

/* React Flow container overrides */
.react-flow {
  background: transparent !important;
}

.react-flow__background {
  background: transparent !important;
}

.react-flow__controls {
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
  border-radius: 8px;
  overflow: hidden;
}

.react-flow__controls-button {
  background: white;
  border: none;
  border-bottom: 1px solid #e5e7eb;
}

.react-flow__controls-button:last-child {
  border-bottom: none;
}

.react-flow__controls-button:hover {
  background: #f9fafb;
}

/* Edge styling */
.react-flow__edge-path {
  stroke: #94a3b8;
  stroke-width: 2;
}

.react-flow__edge.selected .react-flow__edge-path {
  stroke: #3b82f6;
}

/* Mini map */
.react-flow__minimap {
  background: rgba(255,255,255,0.9);
  border-radius: 8px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.1);
}

/* Flow docs specific styling */
#flowsContent {
  min-height: calc(100vh - 200px);
}

#flowsContent .loading-spinner {
  display: flex;
  align-items: center;
  justify-content: center;
  min-height: 400px;
}
`;
}

// Hub JS Asset

function getHubAppJS() {
  return "/**\n * Resolution Hub Application\n * Modular, maintainable hub for PuppyPad Resolution cases\n */\n\n// ============================================\n// CONFIGURATION\n// ============================================\n// Auto-detect API base URL based on environment\n// If on Pages domain, use Worker domain for API calls\n// If on Worker domain or localhost, use same origin\nconst getApiBase = () => {\n  const hostname = window.location.hostname;\n  \n  // If we're on Pages domain, use Worker domain for API\n  if (hostname.includes('pages.dev') || hostname.includes('pages.cloudflare.com')) {\n    return 'https://puppypad-resolution-worker.gulfam.workers.dev';\n  }\n  \n  // If on Worker domain or localhost, use same origin\n  return '';\n};\n\nconst HubConfig = {\n  API_BASE: getApiBase(),\n  REFRESH_INTERVAL: 30000, // 30 seconds\n  MAX_BULK_SELECT: 100,\n  ITEMS_PER_PAGE: 15 // Changed from 50 to 15 for better pagination\n};\n\n// ============================================\n// GLOBAL HELPERS\n// ============================================\nconst HubHelpers = {\n  // Format name with proper capitalization (First Last)\n  formatName(name) {\n    if (!name) return 'Unknown';\n    return name.split(' ')\n      .map(part => part.charAt(0).toUpperCase() + part.slice(1).toLowerCase())\n      .join(' ');\n  },\n  \n  // Escape HTML\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// STATE MANAGEMENT\n// ============================================\nconst HubState = {\n  // User - Initialize from localStorage immediately so bulk actions work\n  currentUser: (() => {\n    try { return JSON.parse(localStorage.getItem('hub_user')); } catch { return null; }\n  })(),\n  token: localStorage.getItem('hub_token'),\n\n  // Cases\n  cases: [],\n  currentCase: null,\n  currentCaseIndex: -1,\n  selectedCaseIds: new Set(),\n\n  // Filters\n  currentFilter: 'all',\n  currentStatus: null,\n  currentSearch: '',\n  currentAssignee: '',\n  currentDateRange: '',\n  currentSortBy: 'created_desc',\n  casesPage: 1,  // Renamed from currentPage to avoid conflict with navigation\n  totalPages: 1,\n\n  // Issue Reports filters\n  issuesStatus: '',\n  issuesSearch: '',\n  issuesDateRange: '',\n  issuesSortBy: 'created_desc',\n  issuesPage: 1,\n  issuesTotalPages: 1,\n\n  // Views\n  savedViews: [],\n  currentView: null,\n\n  // Assignment\n  assignmentQueue: [],\n\n  // UI\n  currentPage: 'dashboard',\n  isLoading: false,\n  keySequence: '', // For combo shortcuts like 'g' then 'd'\n  keySequenceTimeout: null\n};\n\n// ============================================\n// API CLIENT\n// ============================================\nconst HubAPI = {\n  async request(endpoint, options = {}) {\n    const headers = {\n      'Content-Type': 'application/json',\n      ...options.headers\n    };\n\n    if (HubState.token) {\n      headers['Authorization'] = `Bearer ${HubState.token}`;\n    }\n\n    const response = await fetch(`${HubConfig.API_BASE}${endpoint}`, {\n      ...options,\n      headers\n    });\n\n    if (response.status === 401) {\n      // Don't auto-logout for non-critical endpoints (views, saved-views)\n      // These can fail silently without disrupting the user session\n      const nonCriticalEndpoints = ['/hub/api/views', '/hub/api/saved-views'];\n      const isNonCritical = nonCriticalEndpoints.some(ep => endpoint.startsWith(ep));\n      \n      if (!isNonCritical) {\n      HubAuth.logout();\n      }\n      throw new Error('Session expired');\n    }\n\n    return response;\n  },\n\n  async get(endpoint) {\n    const response = await this.request(endpoint);\n    return response.json();\n  },\n\n  async post(endpoint, data) {\n    const response = await this.request(endpoint, {\n      method: 'POST',\n      body: JSON.stringify(data)\n    });\n    return response.json();\n  },\n\n  async put(endpoint, data) {\n    const response = await this.request(endpoint, {\n      method: 'PUT',\n      body: JSON.stringify(data)\n    });\n    return response.json();\n  },\n\n  async delete(endpoint) {\n    const response = await this.request(endpoint, { method: 'DELETE' });\n    return response.json();\n  }\n};\n\n// ============================================\n// AUTHENTICATION\n// ============================================\nconst HubAuth = {\n  init() {\n    const token = localStorage.getItem('hub_token');\n    const user = localStorage.getItem('hub_user');\n\n    if (token && user) {\n      HubState.token = token;\n      HubState.currentUser = JSON.parse(user);\n\n      // Check if password change required\n      if (HubState.currentUser.mustChangePassword) {\n        this.showChangePasswordModal(true);\n      }\n\n      // Show/hide admin-only sections\n      this.updateAdminVisibility();\n\n      return true;\n    }\n    return false;\n  },\n\n  async login(username, password) {\n    try {\n      if (!username || !password) {\n        return { success: false, error: 'Please enter both email and password' };\n      }\n\n      const response = await fetch(`${HubConfig.API_BASE}/admin/api/login`, {\n        method: 'POST',\n        headers: { 'Content-Type': 'application/json' },\n        body: JSON.stringify({ username, password })\n      });\n\n      // Check if response is OK before parsing JSON\n      if (!response.ok) {\n        const errorText = await response.text();\n        let errorData;\n        try {\n          errorData = JSON.parse(errorText);\n        } catch {\n          errorData = { error: `Server error: ${response.status}` };\n        }\n        return { success: false, error: errorData.error || 'Login failed' };\n      }\n\n      const data = await response.json();\n\n      if (data.success) {\n        HubState.token = data.token;\n        HubState.currentUser = data.user;\n        \n        // Show/hide admin-only sections\n        HubAuth.updateAdminVisibility();\n        localStorage.setItem('hub_token', data.token);\n        localStorage.setItem('hub_user', JSON.stringify(data.user));\n\n        if (data.user.mustChangePassword) {\n          this.showChangePasswordModal(true);\n        }\n\n        // Show/hide admin-only sections\n        this.updateAdminVisibility();\n\n        return { success: true };\n      }\n\n      return { success: false, error: data.error || 'Login failed' };\n    } catch (e) {\n      console.error('Login error:', e);\n      return { success: false, error: e.message || 'Network error. Please check your connection.' };\n    }\n  },\n\n  logout() {\n    HubState.token = null;\n    HubState.currentUser = null;\n    localStorage.removeItem('hub_token');\n    localStorage.removeItem('hub_user');\n    HubUI.showLoginScreen();\n  },\n\n  isAdmin() {\n    return HubState.currentUser?.role === 'admin' || HubState.currentUser?.role === 'super_admin';\n  },\n\n  isSuperAdmin() {\n    return HubState.currentUser?.role === 'super_admin';\n  },\n\n  updateAdminVisibility() {\n    const isAdmin = this.isAdmin();\n    const adminSections = document.querySelectorAll('.admin-only-section');\n    adminSections.forEach(section => {\n      section.style.display = isAdmin ? 'block' : 'none';\n    });\n  },\n\n  showChangePasswordModal(required = false) {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"changePasswordModal\">\n        <div class=\"modal\" style=\"max-width: 400px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\" style=\"font-size: 18px;\">\n                ${required ? 'Password Change Required' : 'Change Password'}\n              </div>\n            </div>\n            ${!required ? '<button class=\"modal-close\" onclick=\"HubAuth.closeChangePasswordModal()\">&times;</button>' : ''}\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            ${required ? '<p style=\"margin-bottom: 16px; color: var(--gray-600);\">You must change your password before continuing.</p>' : ''}\n            ${!required ? `\n              <div class=\"form-group\">\n                <label>Current Password</label>\n                <input type=\"password\" id=\"currentPassword\" class=\"form-input\">\n              </div>\n            ` : ''}\n            <div class=\"form-group\">\n              <label>New Password</label>\n              <input type=\"password\" id=\"newPassword\" class=\"form-input\" placeholder=\"Minimum 6 characters\">\n            </div>\n            <div class=\"form-group\">\n              <label>Confirm New Password</label>\n              <input type=\"password\" id=\"confirmPassword\" class=\"form-input\">\n            </div>\n            <div id=\"passwordError\" class=\"error-message\" style=\"display: none;\"></div>\n            <button class=\"btn btn-primary\" style=\"width: 100%; margin-top: 16px;\" onclick=\"HubAuth.changePassword(${required})\">\n              Change Password\n            </button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async changePassword(required) {\n    const currentPassword = document.getElementById('currentPassword')?.value;\n    const newPassword = document.getElementById('newPassword').value;\n    const confirmPassword = document.getElementById('confirmPassword').value;\n    const errorEl = document.getElementById('passwordError');\n\n    if (newPassword !== confirmPassword) {\n      errorEl.textContent = 'Passwords do not match';\n      errorEl.style.display = 'block';\n      return;\n    }\n\n    if (newPassword.length < 6) {\n      errorEl.textContent = 'Password must be at least 6 characters';\n      errorEl.style.display = 'block';\n      return;\n    }\n\n    try {\n      const result = await HubAPI.post('/hub/api/change-password', {\n        currentPassword,\n        newPassword\n      });\n\n      if (result.success) {\n        HubState.currentUser.mustChangePassword = false;\n        localStorage.setItem('hub_user', JSON.stringify(HubState.currentUser));\n        this.closeChangePasswordModal();\n        HubUI.showToast('Password changed successfully', 'success');\n      } else {\n        errorEl.textContent = result.error || 'Failed to change password';\n        errorEl.style.display = 'block';\n      }\n    } catch (e) {\n      errorEl.textContent = 'Network error';\n      errorEl.style.display = 'block';\n    }\n  },\n\n  closeChangePasswordModal() {\n    document.getElementById('changePasswordModal')?.remove();\n  }\n};\n\n// ============================================\n// BULK ACTIONS\n// ============================================\nconst HubBulkActions = {\n  toggleSelect(caseId) {\n    if (HubState.selectedCaseIds.has(caseId)) {\n      HubState.selectedCaseIds.delete(caseId);\n    } else {\n      if (HubState.selectedCaseIds.size >= HubConfig.MAX_BULK_SELECT) {\n        HubUI.showToast(`Maximum ${HubConfig.MAX_BULK_SELECT} cases can be selected`, 'warning');\n        return;\n      }\n      HubState.selectedCaseIds.add(caseId);\n    }\n    this.updateUI();\n  },\n\n  selectAll() {\n    // Use HubState.cases first, fallback to window.allCases or window.casesList (inline script sources)\n    const cases = HubState.cases.length > 0 ? HubState.cases : (window.allCases || window.casesList || []);\n    const visibleIds = cases.slice(0, HubConfig.MAX_BULK_SELECT).map(c => c.case_id);\n    visibleIds.forEach(id => HubState.selectedCaseIds.add(id));\n    this.updateUI();\n  },\n\n  deselectAll() {\n    HubState.selectedCaseIds.clear();\n    this.updateUI();\n  },\n\n  updateBulkActionBar() {\n    const count = HubState.selectedCaseIds.size;\n    let bar = document.getElementById('casesBulkBar');\n    \n    if (count === 0) {\n      if (bar) bar.remove();\n      return;\n    }\n\n    if (!bar) {\n      bar = document.createElement('div');\n      bar.id = 'casesBulkBar';\n      bar.className = 'bulk-action-bar';\n      document.body.appendChild(bar);\n    }\n\n    bar.innerHTML = `\n      <div class=\"bulk-action-count\">${count} case${count > 1 ? 's' : ''} selected</div>\n      <div class=\"bulk-action-buttons\">\n        <button onclick=\"HubBulkActions.showInlineAssignDropdown(event)\" class=\"bulk-btn\" id=\"bulkAssignBtn\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\"/></svg>\n          Assign\n        </button>\n        <button onclick=\"HubBulkActions.showInlineStatusDropdown(event)\" class=\"bulk-btn\" id=\"bulkStatusBtn\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"/></svg>\n          Change Status\n        </button>\n        <button onclick=\"HubBulkActions.exportCSV()\" class=\"bulk-btn\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"/></svg>\n          Export\n        </button>\n        <button onclick=\"HubBulkActions.deselectAll()\" class=\"bulk-btn-cancel\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"/></svg>\n          Cancel\n        </button>\n      </div>\n    `;\n  },\n\n  // Stores caseIds passed to modal for later use\n  pendingBulkCaseIds: null,\n  activeInlineDropdown: null,\n\n  closeInlineDropdown() {\n    const dropdown = document.getElementById('bulkInlineDropdown');\n    if (dropdown) dropdown.remove();\n    this.activeInlineDropdown = null;\n    document.removeEventListener('click', this.handleInlineDropdownOutsideClick);\n  },\n\n  handleInlineDropdownOutsideClick(e) {\n    const dropdown = document.getElementById('bulkInlineDropdown');\n    if (dropdown && !dropdown.contains(e.target) && !e.target.closest('.bulk-btn')) {\n      HubBulkActions.closeInlineDropdown();\n    }\n  },\n\n  showInlineAssignDropdown(event, source = 'cases') {\n    event.stopPropagation();\n    this.closeInlineDropdown();\n    \n    const caseIds = source === 'dashboard' \n      ? Array.from(HubDashboard.selectedDashboardCases) \n      : Array.from(HubState.selectedCaseIds);\n    \n    if (caseIds.length === 0) return;\n    this.pendingBulkCaseIds = caseIds;\n    this.pendingBulkSource = source;\n    \n    const rect = event.currentTarget.getBoundingClientRect();\n    \n    HubUsers.load().then(() => {\n      const getInitials = (name) => {\n        if (!name) return '?';\n        return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();\n      };\n\n      const html = `\n        <div class=\"bulk-inline-dropdown\" id=\"bulkInlineDropdown\" style=\"bottom: ${window.innerHeight - rect.top + 8}px; left: ${rect.left}px;\">\n          <div class=\"bulk-inline-dropdown-header\">\n            <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\"/></svg>\n            <input type=\"text\" placeholder=\"Search team...\" oninput=\"HubBulkActions.filterInlineAssignees(this.value)\" onclick=\"event.stopPropagation()\">\n          </div>\n          <div class=\"bulk-inline-dropdown-list\" id=\"bulkAssigneeList\">\n            <div class=\"bulk-inline-dropdown-item\" onclick=\"HubBulkActions.applyBulkAssign(null)\">\n              <div class=\"bulk-assignee-avatar unassigned\">\n                <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"14\" height=\"14\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\"/></svg>\n              </div>\n              <span>Unassigned</span>\n            </div>\n            ${HubUsers.users.filter(u => u.is_active).map(u => `\n              <div class=\"bulk-inline-dropdown-item\" data-name=\"${HubUsers.escapeHtml(u.name.toLowerCase())}\" onclick=\"HubBulkActions.applyBulkAssign(${u.id}, '${HubUsers.escapeHtml(u.name)}')\">\n                <div class=\"bulk-assignee-avatar\">${getInitials(u.name)}</div>\n                <span>${HubUsers.escapeHtml(u.name)}</span>\n              </div>\n            `).join('')}\n          </div>\n        </div>\n      `;\n      \n      document.body.insertAdjacentHTML('beforeend', html);\n      this.activeInlineDropdown = document.getElementById('bulkInlineDropdown');\n      \n      setTimeout(() => {\n        document.addEventListener('click', this.handleInlineDropdownOutsideClick);\n      }, 10);\n    });\n  },\n\n  filterInlineAssignees(query) {\n    const items = document.querySelectorAll('#bulkAssigneeList .bulk-inline-dropdown-item[data-name]');\n    const lowerQuery = query.toLowerCase().trim();\n    \n    items.forEach(item => {\n      const name = item.dataset.name || '';\n      item.style.display = name.includes(lowerQuery) ? 'flex' : 'none';\n    });\n  },\n\n  async applyBulkAssign(userId, userName = null) {\n    this.closeInlineDropdown();\n    const caseIds = this.pendingBulkCaseIds;\n    const source = this.pendingBulkSource || 'cases';\n    this.pendingBulkCaseIds = null;\n    \n    if (!caseIds || caseIds.length === 0) return;\n    \n    HubUI.showLoading();\n    try {\n      const result = await HubAPI.post('/hub/api/cases/bulk-assign', { caseIds, userId });\n      if (result.success) {\n        HubUI.showToast(`Assigned ${caseIds.length} case${caseIds.length > 1 ? 's' : ''} to ${userName || 'Unassigned'}`, 'success');\n        this.deselectAll();\n        if (source === 'dashboard') {\n          HubDashboard.clearSelection();\n          HubDashboard.load();\n        } else {\n          HubCases.loadCases(HubState.casesPage);\n        }\n      } else {\n        HubUI.showToast(result.error || 'Assign failed', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to assign cases', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  showInlineStatusDropdown(event, source = 'cases') {\n    event.stopPropagation();\n    this.closeInlineDropdown();\n    \n    const caseIds = source === 'dashboard' \n      ? Array.from(HubDashboard.selectedDashboardCases) \n      : Array.from(HubState.selectedCaseIds);\n    \n    if (caseIds.length === 0) return;\n    this.pendingBulkCaseIds = caseIds;\n    this.pendingBulkSource = source;\n    \n    const rect = event.currentTarget.getBoundingClientRect();\n    \n    const html = `\n      <div class=\"bulk-inline-dropdown\" id=\"bulkInlineDropdown\" style=\"bottom: ${window.innerHeight - rect.top + 8}px; left: ${rect.left}px;\">\n        <div class=\"bulk-inline-dropdown-list\" style=\"padding-top: 8px;\">\n          <div class=\"bulk-inline-dropdown-item bulk-status-item\" onclick=\"HubBulkActions.applyInlineStatus('pending')\">\n            <span class=\"status-dot pending\"></span>\n            <span>Pending</span>\n          </div>\n          <div class=\"bulk-inline-dropdown-item bulk-status-item\" onclick=\"HubBulkActions.applyInlineStatus('in_progress')\">\n            <span class=\"status-dot in-progress\"></span>\n            <span>In Progress</span>\n          </div>\n          <div class=\"bulk-inline-dropdown-item bulk-status-item\" onclick=\"HubBulkActions.applyInlineStatus('completed')\">\n            <span class=\"status-dot completed\"></span>\n            <span>Completed</span>\n          </div>\n        </div>\n      </div>\n    `;\n    \n    document.body.insertAdjacentHTML('beforeend', html);\n    this.activeInlineDropdown = document.getElementById('bulkInlineDropdown');\n    \n    setTimeout(() => {\n      document.addEventListener('click', this.handleInlineDropdownOutsideClick);\n    }, 10);\n  },\n\n  async applyInlineStatus(status) {\n    this.closeInlineDropdown();\n    const caseIds = this.pendingBulkCaseIds;\n    const source = this.pendingBulkSource || 'cases';\n    this.pendingBulkCaseIds = null;\n    \n    if (!caseIds || caseIds.length === 0) return;\n    \n    HubUI.showLoading();\n    try {\n      const result = await HubAPI.post('/hub/api/cases/bulk-status', { caseIds, status });\n      if (result.success) {\n        const statusLabel = status.replace('_', ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n        HubUI.showToast(`Updated ${caseIds.length} case${caseIds.length > 1 ? 's' : ''} to ${statusLabel}`, 'success');\n        this.deselectAll();\n        if (source === 'dashboard') {\n          HubDashboard.clearSelection();\n          HubDashboard.load();\n        } else {\n          HubCases.loadCases(HubState.casesPage);\n        }\n        HubDashboard.loadStats();\n      } else {\n        HubUI.showToast(result.error || 'Update failed', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to update status', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  showStatusModal(caseIds = null) {\n    // Use passed caseIds or fall back to HubState.selectedCaseIds\n    const ids = caseIds || Array.from(HubState.selectedCaseIds);\n    const count = ids.length;\n    if (count === 0) return;\n    \n    // Store for later use in applyBulkStatus\n    this.pendingBulkCaseIds = ids;\n\n    const html = `\n      <div class=\"modal-overlay active\" id=\"bulkStatusModal\">\n        <div class=\"modal\" style=\"max-width: 400px;\">\n          <div class=\"modal-header\">\n            <h3>Change Status (${count} case${count > 1 ? 's' : ''})</h3>\n            <button class=\"modal-close\" onclick=\"document.getElementById('bulkStatusModal').remove()\">Ã—</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <div class=\"status-radio-group\" id=\"bulkStatusRadioGroup\">\n              <label class=\"status-radio-item\" data-status=\"pending\" onclick=\"HubBulkActions.selectStatusRadio(this, 'pending')\">\n                <input type=\"radio\" name=\"bulkStatus\" value=\"pending\">\n                <span class=\"status-radio-check\"></span>\n                <span class=\"status-radio-label\">Pending</span>\n              </label>\n              <label class=\"status-radio-item\" data-status=\"in_progress\" onclick=\"HubBulkActions.selectStatusRadio(this, 'in_progress')\">\n                <input type=\"radio\" name=\"bulkStatus\" value=\"in_progress\">\n                <span class=\"status-radio-check\"></span>\n                <span class=\"status-radio-label\">In Progress</span>\n              </label>\n              <label class=\"status-radio-item\" data-status=\"completed\" onclick=\"HubBulkActions.selectStatusRadio(this, 'completed')\">\n                <input type=\"radio\" name=\"bulkStatus\" value=\"completed\">\n                <span class=\"status-radio-check\"></span>\n                <span class=\"status-radio-label\">Completed</span>\n              </label>\n            </div>\n            <div style=\"display: flex; justify-content: flex-end; gap: 12px; margin-top: 24px;\">\n              <button class=\"btn btn-secondary\" onclick=\"document.getElementById('bulkStatusModal').remove()\">Cancel</button>\n              <button class=\"btn btn-primary\" onclick=\"HubBulkActions.applyBulkStatus()\">Apply</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  selectStatusRadio(element, status) {\n    // Remove selected class from all items\n    document.querySelectorAll('#bulkStatusRadioGroup .status-radio-item').forEach(item => {\n      item.classList.remove('selected');\n    });\n    // Add selected class to clicked item\n    element.classList.add('selected');\n    // Check the radio input\n    element.querySelector('input[type=\"radio\"]').checked = true;\n  },\n\n  applyBulkStatus() {\n    const selected = document.querySelector('#bulkStatusModal input[name=\"bulkStatus\"]:checked');\n    if (!selected) {\n      HubUI.showToast('Please select a status', 'warning');\n      return;\n    }\n    document.getElementById('bulkStatusModal')?.remove();\n    \n    // Use pendingBulkCaseIds if set, otherwise use HubState.selectedCaseIds\n    const caseIds = this.pendingBulkCaseIds || Array.from(HubState.selectedCaseIds);\n    this.pendingBulkCaseIds = null; // Clear after use\n    this.updateStatusWithIds(selected.value, caseIds);\n  },\n\n  async updateStatusWithIds(status, caseIds) {\n    if (!caseIds || caseIds.length === 0) {\n      HubUI.showToast('No cases selected', 'warning');\n      return;\n    }\n\n    try {\n      HubUI.showLoading();\n      const result = await HubAPI.post('/hub/api/bulk/status', {\n        caseIds: caseIds,\n        status,\n        actor: HubState.currentUser?.name || 'team_member',\n        actor_email: HubState.currentUser?.email || ''\n      });\n\n      if (result.success) {\n        HubUI.showToast(result.message || `Updated ${caseIds.length} cases to ${status}`, 'success');\n        this.deselectAll();\n        // Clear dashboard selection too\n        if (HubDashboard.selectedDashboardCases) {\n          HubDashboard.selectedDashboardCases.clear();\n          HubDashboard.updateBulkActionBar();\n        }\n        // Refresh current view and stats\n        if (HubState.currentPage === 'dashboard') {\n          HubDashboard.load();\n        } else if (HubState.currentPage === 'cases') {\n          HubCases.loadCases(HubState.casesPage);\n          // Also refresh dashboard stats for the progress bar\n          HubDashboard.loadStats();\n        }\n      } else {\n        HubUI.showToast(result.error || 'Update failed', 'error');\n      }\n    } catch (e) {\n      console.error('Bulk status update error:', e);\n      HubUI.showToast('Failed to update cases', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  exportCSV() {\n    const cases = HubState.cases.filter(c => HubState.selectedCaseIds.has(c.case_id));\n    if (cases.length === 0) {\n      HubUI.showToast('No cases selected', 'warning');\n      return;\n    }\n    \n    const headers = ['Case ID', 'Customer Name', 'Customer Email', 'Type', 'Status', 'Resolution', 'Created'];\n    const rows = cases.map(c => [\n      c.case_id,\n      c.customer_name || '',\n      c.customer_email || '',\n      c.case_type || '',\n      c.status || '',\n      c.resolution || '',\n      c.created_at || ''\n    ]);\n    const csv = [headers, ...rows].map(r => r.map(cell => `\"${(cell || '').toString().replace(/\"/g, '\"\"')}\"`).join(',')).join('\\n');\n    \n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `cases-export-${new Date().toISOString().split('T')[0]}.csv`;\n    a.click();\n    URL.revokeObjectURL(url);\n    HubUI.showToast(`Exported ${cases.length} cases`, 'success');\n  },\n\n  updateUI() {\n    const count = HubState.selectedCaseIds.size;\n    const toolbar = document.getElementById('bulkActionsToolbar');\n    \n    // Update floating bulk action bar\n    this.updateBulkActionBar();\n    \n    // Update checkboxes\n    document.querySelectorAll('.case-checkbox').forEach(cb => {\n      cb.checked = HubState.selectedCaseIds.has(cb.dataset.caseId);\n    });\n    \n    // Update select all checkbox\n    const selectAll = document.getElementById('selectAllCases');\n    if (selectAll) {\n      const allChecked = HubState.cases.length > 0 && HubState.cases.every(c => HubState.selectedCaseIds.has(c.case_id));\n      selectAll.checked = allChecked;\n    }\n\n    // Add null check for toolbar\n    if (toolbar) {\n      if (count > 0) {\n        toolbar.style.display = 'flex';\n        const countEl = document.getElementById('selectedCount');\n        if (countEl) countEl.textContent = `${count} selected`;\n      } else {\n        toolbar.style.display = 'none';\n      }\n    }\n\n    // Update checkboxes\n    document.querySelectorAll('.case-checkbox').forEach(cb => {\n      cb.checked = HubState.selectedCaseIds.has(cb.dataset.caseId);\n    });\n\n    // Update select all checkbox\n    const selectAllCb = document.getElementById('selectAllCases');\n    if (selectAllCb) {\n      const allCases = window.allCases || window.casesList || HubState.cases || [];\n      selectAllCb.checked = count > 0 && count >= allCases.length;\n    }\n  },\n\n  async updateStatus(status) {\n    if (HubState.selectedCaseIds.size === 0) return;\n\n    // If completing, show checklist first\n    if (status === 'completed') {\n      this.showBulkChecklistModal();\n      return;\n    }\n\n    try {\n      HubUI.showLoading();\n      const result = await HubAPI.post('/hub/api/bulk/status', {\n        caseIds: Array.from(HubState.selectedCaseIds),\n        status,\n        actor: HubState.currentUser?.name || 'team_member',\n        actor_email: HubState.currentUser?.email || ''\n      });\n\n      if (result.success) {\n        HubUI.showToast(result.message, 'success');\n        this.deselectAll();\n        // Use inline script's loadCasesView if available, otherwise HubCases.loadCases\n        if (typeof loadCasesView === 'function') {\n          loadCasesView();\n        } else if (typeof HubCases !== 'undefined') {\n          HubCases.loadCases();\n        }\n      } else {\n        HubUI.showToast(result.error || 'Update failed', 'error');\n      }\n    } catch (e) {\n      console.error('Bulk update error:', e);\n      HubUI.showToast('Failed to update cases: ' + (e.message || 'Unknown error'), 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  async assign(userId) {\n    if (!HubAuth.isAdmin()) {\n      HubUI.showToast('Admin access required', 'error');\n      return;\n    }\n\n    try {\n      HubUI.showLoading();\n      const result = await HubAPI.post('/hub/api/bulk/assign', {\n        caseIds: Array.from(HubState.selectedCaseIds),\n        assignToUserId: userId\n      });\n\n      if (result.success) {\n        HubUI.showToast(result.message, 'success');\n        this.deselectAll();\n        // Use inline script's loadCasesView if available\n        if (typeof loadCasesView === 'function') {\n          loadCasesView();\n        } else if (typeof HubCases !== 'undefined') {\n          HubCases.loadCases();\n        }\n      } else {\n        HubUI.showToast(result.error || 'Assign failed', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to assign cases: ' + (e.message || 'Unknown error'), 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  async assignWithIds(userId, caseIds) {\n    if (!caseIds || caseIds.length === 0) {\n      HubUI.showToast('No cases selected', 'warning');\n      return;\n    }\n\n    try {\n      HubUI.showLoading();\n      const result = await HubAPI.post('/hub/api/bulk/assign', {\n        caseIds: caseIds,\n        assignToUserId: userId\n      });\n\n      if (result.success) {\n        HubUI.showToast(result.message || `Assigned ${caseIds.length} cases`, 'success');\n        this.deselectAll();\n        // Clear dashboard selection too\n        if (HubDashboard.selectedDashboardCases) {\n          HubDashboard.selectedDashboardCases.clear();\n          HubDashboard.updateBulkActionBar();\n        }\n        // Refresh current view\n        if (HubState.currentPage === 'dashboard') {\n          HubDashboard.load();\n        } else if (HubState.currentPage === 'cases') {\n          HubCases.loadCases(HubState.casesPage);\n        }\n      } else {\n        HubUI.showToast(result.error || 'Assign failed', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to assign cases: ' + (e.message || 'Unknown error'), 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  showAssignModal() {\n    // Will be populated with users list\n    HubUsers.showAssignModal(Array.from(HubState.selectedCaseIds));\n  },\n\n  async addComment() {\n    const comment = prompt('Enter comment to add to all selected cases:');\n    if (!comment) return;\n\n    try {\n      HubUI.showLoading();\n      const result = await HubAPI.post('/hub/api/bulk/comment', {\n        caseIds: Array.from(HubState.selectedCaseIds),\n        comment\n      });\n\n      if (result.success) {\n        HubUI.showToast(result.message, 'success');\n      } else {\n        HubUI.showToast(result.error, 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to add comments', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  async exportCSV() {\n    try {\n      const response = await HubAPI.request('/hub/api/bulk/export', {\n        method: 'POST',\n        body: JSON.stringify({\n          caseIds: HubState.selectedCaseIds.size > 0 ? Array.from(HubState.selectedCaseIds) : null\n        })\n      });\n\n      const blob = await response.blob();\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `cases-export-${new Date().toISOString().split('T')[0]}.csv`;\n      a.click();\n      URL.revokeObjectURL(url);\n\n      HubUI.showToast('Export downloaded', 'success');\n    } catch (e) {\n      HubUI.showToast('Failed to export', 'error');\n    }\n  },\n\n  showBulkChecklistModal() {\n    // For bulk completion, show a simple confirmation\n    const html = `\n      <div class=\"modal-overlay active\" id=\"bulkChecklistModal\">\n        <div class=\"modal\" style=\"max-width: 500px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\" style=\"font-size: 18px;\">Complete ${HubState.selectedCaseIds.size} Cases</div>\n            </div>\n            <button class=\"modal-close\" onclick=\"document.getElementById('bulkChecklistModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <p style=\"margin-bottom: 16px;\">Are you sure you want to mark ${HubState.selectedCaseIds.size} cases as completed?</p>\n            <p style=\"margin-bottom: 24px; color: var(--gray-500); font-size: 14px;\">\n              Make sure you have actioned all resolutions before completing.\n            </p>\n            <div style=\"display: flex; gap: 12px; justify-content: flex-end;\">\n              <button class=\"btn btn-secondary\" onclick=\"document.getElementById('bulkChecklistModal').remove()\">Cancel</button>\n              <button class=\"btn btn-primary\" onclick=\"HubBulkActions.confirmBulkComplete()\">Complete All</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async confirmBulkComplete() {\n    document.getElementById('bulkChecklistModal')?.remove();\n\n    try {\n      HubUI.showLoading();\n      const result = await HubAPI.post('/hub/api/bulk/status', {\n        caseIds: Array.from(HubState.selectedCaseIds),\n        status: 'completed',\n        actor: HubState.currentUser?.name || 'team_member',\n        actor_email: HubState.currentUser?.email || ''\n      });\n\n      if (result.success) {\n        HubUI.showToast(result.message, 'success');\n        this.deselectAll();\n        // Use inline script's loadCasesView if available\n        if (typeof loadCasesView === 'function') {\n          loadCasesView();\n        } else if (typeof HubCases !== 'undefined') {\n          HubCases.loadCases();\n        }\n      } else {\n        HubUI.showToast(result.error || 'Complete failed', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to complete cases: ' + (e.message || 'Unknown error'), 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  }\n};\n\n// ============================================\n// SAVED VIEWS\n// ============================================\nconst HubViews = {\n  async load() {\n    // Only load views if user is authenticated\n    if (!HubState.token) {\n      console.log('Skipping views load - not authenticated');\n      return;\n    }\n    try {\n      const result = await HubAPI.get('/hub/api/views');\n      if (result.success) {\n        HubState.savedViews = result.views || [];\n        this.renderSidebar();\n      }\n    } catch (e) {\n      // Silently fail for views - not critical\n      console.warn('Failed to load views:', e.message);\n      HubState.savedViews = [];\n    }\n  },\n\n  renderSidebar() {\n    const container = document.getElementById('savedViewsContainer') || document.getElementById('savedViewsList');\n    if (!container) return;\n\n    if (HubState.savedViews.length === 0) {\n      container.innerHTML = '<div class=\"empty-views\">No saved views</div>';\n      return;\n    }\n\n    container.innerHTML = HubState.savedViews.map(view => `\n      <div class=\"saved-view-item ${HubState.currentView?.id === view.id ? 'active' : ''}\"\n           onclick=\"HubViews.apply(${view.id})\" data-view-id=\"${view.id}\">\n        <span class=\"view-name\">${this.escapeHtml(view.name)}</span>\n        ${view.is_default ? '<span class=\"view-default\">Default</span>' : ''}\n        <button class=\"view-delete\" onclick=\"event.stopPropagation(); HubViews.delete(${view.id})\" title=\"Delete view\">\n          &times;\n        </button>\n      </div>\n    `).join('');\n  },\n\n  async save() {\n    const name = prompt('Enter a name for this view:');\n    if (!name) return;\n\n    const filters = {\n      status: HubState.currentStatus,\n      caseType: HubState.currentFilter,\n      search: HubState.currentSearch\n    };\n\n    try {\n      const result = await HubAPI.post('/hub/api/views', {\n        name,\n        filters,\n        isDefault: false\n      });\n\n      if (result.success) {\n        HubUI.showToast('View saved', 'success');\n        this.load();\n      } else {\n        HubUI.showToast(result.error, 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to save view', 'error');\n    }\n  },\n\n  async apply(viewId) {\n    const view = HubState.savedViews.find(v => v.id === viewId);\n    if (!view) return;\n\n    const filters = JSON.parse(view.filters);\n    HubState.currentView = view;\n    HubState.currentStatus = filters.status;\n    HubState.currentFilter = filters.caseType || 'all';\n    HubState.currentSearch = filters.search || '';\n\n    // Update UI\n    document.getElementById('searchInput').value = HubState.currentSearch;\n    this.renderSidebar();\n    HubCases.loadCases();\n  },\n\n  async delete(viewId) {\n    if (!confirm('Delete this saved view?')) return;\n\n    try {\n      const result = await HubAPI.delete(`/hub/api/views/${viewId}`);\n      if (result.success) {\n        HubUI.showToast('View deleted', 'success');\n        if (HubState.currentView?.id === viewId) {\n          HubState.currentView = null;\n        }\n        this.load();\n      } else {\n        HubUI.showToast(result.error, 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to delete view', 'error');\n    }\n  },\n\n  escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// COMPLETION CHECKLIST\n// ============================================\nconst HubChecklist = {\n  async showForCase(caseId) {\n    try {\n      const result = await HubAPI.get(`/hub/api/case/${caseId}/checklist`);\n\n      if (!result.success || !result.checklist || result.checklist.length === 0) {\n        // No checklist items, just complete\n        return { canComplete: true, items: [] };\n      }\n\n      return new Promise((resolve) => {\n        this.showModal(caseId, result.checklist, resolve);\n      });\n    } catch (e) {\n      console.error('Failed to get checklist:', e);\n      return { canComplete: true, items: [] };\n    }\n  },\n\n  showModal(caseId, items, resolve) {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"checklistModal\">\n        <div class=\"modal\" style=\"max-width: 500px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px; background: linear-gradient(135deg, #059669 0%, #10b981 100%);\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\" style=\"font-size: 18px;\">Completion Checklist</div>\n              <div style=\"font-size: 13px; opacity: 0.9; margin-top: 4px;\">Verify all items before completing</div>\n            </div>\n            <button class=\"modal-close\" onclick=\"HubChecklist.cancel()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <div class=\"checklist-items\">\n              ${items.map((item, idx) => `\n                <label class=\"checklist-item ${item.is_required ? 'required' : ''}\">\n                  <input type=\"checkbox\"\n                         class=\"checklist-checkbox\"\n                         data-item-id=\"${item.id}\"\n                         ${item.isCompleted ? 'checked' : ''}>\n                  <span class=\"checklist-text\">\n                    ${this.escapeHtml(item.checklist_item)}\n                    ${item.is_required ? '<span class=\"required-badge\">Required</span>' : ''}\n                  </span>\n                  ${item.completedBy ? `<span class=\"completed-by\">by ${this.escapeHtml(item.completedBy)}</span>` : ''}\n                </label>\n              `).join('')}\n            </div>\n            <div id=\"checklistError\" class=\"error-message\" style=\"display: none; margin-top: 16px;\"></div>\n            <div style=\"display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;\">\n              <button class=\"btn btn-secondary\" onclick=\"HubChecklist.cancel()\">Cancel</button>\n              <button class=\"btn btn-primary\" onclick=\"HubChecklist.confirm('${caseId}')\" style=\"background: #059669;\">\n                Complete Case\n              </button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n\n    document.body.insertAdjacentHTML('beforeend', html);\n\n    // Store resolve function\n    this._resolve = resolve;\n    this._caseId = caseId;\n  },\n\n  async confirm(caseId) {\n    const checkboxes = document.querySelectorAll('.checklist-checkbox');\n    const requiredItems = document.querySelectorAll('.checklist-item.required .checklist-checkbox');\n    const uncheckedRequired = Array.from(requiredItems).filter(cb => !cb.checked);\n\n    if (uncheckedRequired.length > 0) {\n      const errorEl = document.getElementById('checklistError');\n      errorEl.textContent = 'Please complete all required items';\n      errorEl.style.display = 'block';\n      return;\n    }\n\n    // Save checklist completions\n    for (const cb of checkboxes) {\n      await HubAPI.post('/hub/api/checklist/complete', {\n        caseId,\n        checklistItemId: parseInt(cb.dataset.itemId),\n        completed: cb.checked\n      });\n    }\n\n    document.getElementById('checklistModal')?.remove();\n\n    if (this._resolve) {\n      this._resolve({ canComplete: true });\n      this._resolve = null;\n    }\n  },\n\n  cancel() {\n    document.getElementById('checklistModal')?.remove();\n    if (this._resolve) {\n      this._resolve({ canComplete: false });\n      this._resolve = null;\n    }\n  },\n\n  escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// KEYBOARD SHORTCUTS\n// ============================================\nconst HubKeyboard = {\n  init() {\n    document.addEventListener('keydown', this.handleKeydown.bind(this));\n  },\n\n  handleKeydown(e) {\n    // Ignore if typing in input\n    if (e.target.matches('input, textarea, select')) {\n      if (e.key === 'Escape') {\n        e.target.blur();\n      }\n      return;\n    }\n\n    const key = e.key.toLowerCase();\n\n    // Handle key sequences (g+d, g+c, etc.)\n    if (HubState.keySequence) {\n      this.handleSequence(HubState.keySequence + key, e);\n      HubState.keySequence = '';\n      clearTimeout(HubState.keySequenceTimeout);\n      return;\n    }\n\n    // Start sequence for 'g', 'f', 'b'\n    if (['g', 'f', 'b'].includes(key) && !e.ctrlKey && !e.metaKey) {\n      HubState.keySequence = key;\n      HubState.keySequenceTimeout = setTimeout(() => {\n        HubState.keySequence = '';\n      }, 1000);\n      return;\n    }\n\n    // Single key shortcuts\n    this.handleSingleKey(key, e);\n  },\n\n  handleSequence(seq, e) {\n    const actions = {\n      // Navigation: g + key\n      'gd': () => HubNavigation.goto('dashboard'),\n      'gc': () => HubNavigation.goto('cases'),\n      'ga': () => HubNavigation.goto('analytics'),\n      'gs': () => HubNavigation.goto('sessions'),\n      'gu': () => HubAuth.isAdmin() && HubUsers.showManagement(),\n      'gl': () => HubAuth.isAdmin() && HubEnhancedAuditLog.show(),\n      'gq': () => HubAuth.isAdmin() && HubAssignment.showQueue(),\n\n      // Filters: f + key\n      'fp': () => HubCases.setStatusFilter('pending'),\n      'fi': () => HubCases.setStatusFilter('in_progress'),\n      'fc': () => HubCases.setStatusFilter('completed'),\n      'fa': () => HubCases.setStatusFilter(null),\n\n      // Bulk: b + key\n      'bs': () => HubState.selectedCaseIds.size > 0 && this.showBulkStatusMenu(),\n      'ba': () => HubState.selectedCaseIds.size > 0 && HubBulkActions.showAssignModal(),\n      'bc': () => HubState.selectedCaseIds.size > 0 && HubBulkActions.addComment(),\n      'be': () => HubBulkActions.exportCSV()\n    };\n\n    if (actions[seq]) {\n      e.preventDefault();\n      actions[seq]();\n    }\n  },\n\n  handleSingleKey(key, e) {\n    const modalOpen = document.querySelector('.modal-overlay.active');\n\n    // Global shortcuts\n    if (key === '?') {\n      e.preventDefault();\n      this.showHelp();\n      return;\n    }\n\n    if (key === '/' && !modalOpen) {\n      e.preventDefault();\n      document.getElementById('searchInput')?.focus();\n      return;\n    }\n\n    if (key === 'escape') {\n      if (modalOpen) {\n        HubUI.closeModal();\n      }\n      return;\n    }\n\n    if (key === 'r' && !modalOpen) {\n      e.preventDefault();\n      HubUI.refresh();\n      return;\n    }\n\n    // Case list shortcuts\n    if (!modalOpen && HubState.currentPage === 'cases') {\n      if (key === 'j') {\n        e.preventDefault();\n        this.selectNextCase();\n        return;\n      }\n      if (key === 'k') {\n        e.preventDefault();\n        this.selectPrevCase();\n        return;\n      }\n      if (key === 'enter') {\n        e.preventDefault();\n        this.openSelectedCase();\n        return;\n      }\n      if (key === 'x') {\n        e.preventDefault();\n        if (e.shiftKey) {\n          HubBulkActions.selectAll();\n        } else {\n          this.toggleSelectedCase();\n        }\n        return;\n      }\n    }\n\n    // Case modal shortcuts\n    if (modalOpen && HubState.currentCase) {\n      if (key === '1') {\n        e.preventDefault();\n        HubCases.updateStatus('pending');\n        return;\n      }\n      if (key === '2') {\n        e.preventDefault();\n        HubCases.updateStatus('in_progress');\n        return;\n      }\n      if (key === '3') {\n        e.preventDefault();\n        HubCases.updateStatus('completed');\n        return;\n      }\n      if (key === '[') {\n        e.preventDefault();\n        HubCases.navigateCase('prev');\n        return;\n      }\n      if (key === ']') {\n        e.preventDefault();\n        HubCases.navigateCase('next');\n        return;\n      }\n      if (key === 'c') {\n        e.preventDefault();\n        document.getElementById('commentInput')?.focus();\n        return;\n      }\n      if (key === 'e') {\n        e.preventDefault();\n        this.copyEmail();\n        return;\n      }\n      if (key === 'o') {\n        e.preventDefault();\n        HubCases.openShopifyOrder();\n        return;\n      }\n    }\n  },\n\n  selectNextCase() {\n    const rows = document.querySelectorAll('.cases-table tbody tr');\n    const currentIdx = Array.from(rows).findIndex(r => r.classList.contains('keyboard-selected'));\n    const nextIdx = Math.min(currentIdx + 1, rows.length - 1);\n\n    rows.forEach(r => r.classList.remove('keyboard-selected'));\n    rows[nextIdx]?.classList.add('keyboard-selected');\n    rows[nextIdx]?.scrollIntoView({ block: 'nearest' });\n  },\n\n  selectPrevCase() {\n    const rows = document.querySelectorAll('.cases-table tbody tr');\n    const currentIdx = Array.from(rows).findIndex(r => r.classList.contains('keyboard-selected'));\n    const prevIdx = Math.max(currentIdx - 1, 0);\n\n    rows.forEach(r => r.classList.remove('keyboard-selected'));\n    rows[prevIdx]?.classList.add('keyboard-selected');\n    rows[prevIdx]?.scrollIntoView({ block: 'nearest' });\n  },\n\n  openSelectedCase() {\n    const selected = document.querySelector('.cases-table tbody tr.keyboard-selected');\n    if (selected) {\n      selected.click();\n    }\n  },\n\n  toggleSelectedCase() {\n    const selected = document.querySelector('.cases-table tbody tr.keyboard-selected');\n    if (selected) {\n      const checkbox = selected.querySelector('.case-checkbox');\n      if (checkbox) {\n        HubBulkActions.toggleSelect(checkbox.dataset.caseId);\n      }\n    }\n  },\n\n  copyEmail() {\n    const email = HubState.currentCase?.customer_email;\n    if (email) {\n      navigator.clipboard.writeText(email);\n      HubUI.showToast('Email copied', 'success');\n    }\n  },\n\n  showHelp() {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"helpModal\">\n        <div class=\"modal\" style=\"max-width: 600px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\" style=\"font-size: 18px;\">Keyboard Shortcuts</div>\n            </div>\n            <button class=\"modal-close\" onclick=\"document.getElementById('helpModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px; max-height: 60vh; overflow-y: auto;\">\n            <div class=\"shortcuts-section\">\n              <h4>Global</h4>\n              <div class=\"shortcut\"><kbd>?</kbd> Show help</div>\n              <div class=\"shortcut\"><kbd>/</kbd> Focus search</div>\n              <div class=\"shortcut\"><kbd>R</kbd> Refresh</div>\n              <div class=\"shortcut\"><kbd>Esc</kbd> Close modal</div>\n            </div>\n            <div class=\"shortcuts-section\">\n              <h4>Navigation</h4>\n              <div class=\"shortcut\"><kbd>G</kbd> then <kbd>D</kbd> Dashboard</div>\n              <div class=\"shortcut\"><kbd>G</kbd> then <kbd>C</kbd> Cases</div>\n              <div class=\"shortcut\"><kbd>G</kbd> then <kbd>A</kbd> Analytics</div>\n            </div>\n            <div class=\"shortcuts-section\">\n              <h4>Case List</h4>\n              <div class=\"shortcut\"><kbd>J</kbd> / <kbd>K</kbd> Navigate up/down</div>\n              <div class=\"shortcut\"><kbd>Enter</kbd> Open case</div>\n              <div class=\"shortcut\"><kbd>X</kbd> Toggle select</div>\n              <div class=\"shortcut\"><kbd>Shift+X</kbd> Select all</div>\n            </div>\n            <div class=\"shortcuts-section\">\n              <h4>Case Modal</h4>\n              <div class=\"shortcut\"><kbd>1</kbd> Set Pending</div>\n              <div class=\"shortcut\"><kbd>2</kbd> Set In Progress</div>\n              <div class=\"shortcut\"><kbd>3</kbd> Set Completed</div>\n              <div class=\"shortcut\"><kbd>[</kbd> / <kbd>]</kbd> Prev/Next case</div>\n              <div class=\"shortcut\"><kbd>C</kbd> Add comment</div>\n              <div class=\"shortcut\"><kbd>E</kbd> Copy email</div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  showBulkStatusMenu() {\n    // Simple prompt for now\n    const status = prompt('Enter status (pending, in_progress, completed):');\n    if (status && ['pending', 'in_progress', 'completed'].includes(status)) {\n      HubBulkActions.updateStatus(status);\n    }\n  }\n};\n\n// ============================================\n// USER MANAGEMENT (Admin)\n// ============================================\nconst HubUsers = {\n  users: [],\n\n  async load() {\n    if (!HubAuth.isAdmin()) return;\n\n    try {\n      const result = await HubAPI.get('/hub/api/users');\n      if (result.success) {\n        this.users = result.users;\n      }\n    } catch (e) {\n      console.error('Failed to load users:', e);\n    }\n  },\n\n  // Render user management into usersView container (for navigation)\n  async show() {\n    const view = document.getElementById('usersView');\n    if (!view) return;\n\n    if (!HubAuth.isAdmin()) {\n      view.innerHTML = '<div class=\"empty-state\"><p>Admin access required to view this page.</p></div>';\n      return;\n    }\n\n    const content = document.getElementById('usersContent');\n    if (content) {\n      content.innerHTML = '<div class=\"spinner\" style=\"margin: 40px auto;\"></div>';\n    } else {\n      view.innerHTML = '<div class=\"spinner\" style=\"margin: 40px auto;\"></div>';\n    }\n    \n    await this.load();\n\n    const html = `\n      <table class=\"cases-table cases-table-enhanced\">\n        <thead>\n          <tr>\n            <th>USER</th>\n            <th>ROLE</th>\n            <th>STATUS</th>\n            <th>LAST LOGIN</th>\n            <th>CREATED</th>\n            <th style=\"text-align: right;\">ACTIONS</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${this.users.length ? this.users.map(u => {\n            const roleLabel = u.role === 'super_admin' ? 'Super Admin' : u.role === 'admin' ? 'Admin' : 'User';\n            const roleBadge = u.role === 'super_admin' ? 'super-admin' : u.role === 'admin' ? 'admin' : 'user';\n            const lastLogin = u.last_login ? new Date(u.last_login).toLocaleDateString() : 'Never';\n            const created = u.created_at ? new Date(u.created_at).toLocaleDateString() : '-';\n            return `\n              <tr>\n                <td>\n                  <div class=\"customer-info\">\n                    <div class=\"customer-name\">${this.escapeHtml(u.name)}</div>\n                    <div class=\"customer-email\">${this.escapeHtml(u.email || u.username)}</div>\n                  </div>\n                </td>\n                <td><span class=\"type-badge ${roleBadge}\">${roleLabel}</span></td>\n                <td><span class=\"status-badge ${u.is_active ? 'completed' : 'cancelled'}\">${u.is_active ? 'Active' : 'Inactive'}</span></td>\n                <td class=\"time-ago\">${lastLogin}</td>\n                <td class=\"time-ago\">${created}</td>\n                <td style=\"text-align: right;\">\n                  <div style=\"display: flex; gap: 8px; justify-content: flex-end;\">\n                    <button class=\"btn btn-secondary\" style=\"padding: 6px 12px; font-size: 12px;\" onclick=\"HubUserManagement.viewActivity(${u.id})\">\n                      Activity Log\n                    </button>\n                    <button class=\"btn btn-secondary\" style=\"padding: 6px 12px; font-size: 12px;\" onclick=\"HubUsers.showResetPasswordModal(${u.id}, '${this.escapeHtml(u.name)}')\">\n                      Reset Password\n                    </button>\n                    ${HubState.currentUser && u.id !== HubState.currentUser.id ? `\n                      <button class=\"btn btn-secondary\" style=\"padding: 6px 12px; font-size: 12px;\" onclick=\"HubUsers.confirmDelete(${u.id}, '${this.escapeHtml(u.name)}')\">\n                        Delete\n                      </button>\n                    ` : ''}\n                  </div>\n                </td>\n              </tr>\n            `;\n          }).join('') : '<tr><td colspan=\"6\" class=\"empty-state\">No users found.</td></tr>'}\n        </tbody>\n      </table>\n    `;\n\n    if (content) {\n      content.innerHTML = html;\n    } else {\n      view.innerHTML = html;\n    }\n  },\n\n  showManagement() {\n    if (!HubAuth.isAdmin()) {\n      HubUI.showToast('Admin access required', 'error');\n      return;\n    }\n\n    this.load().then(() => {\n      const html = `\n        <div class=\"modal-overlay active\" id=\"userManagementModal\">\n          <div class=\"modal\" style=\"max-width: 700px;\">\n            <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n              <div class=\"modal-header-content\">\n                <div class=\"modal-title\" style=\"font-size: 18px;\">User Management</div>\n              </div>\n              <button class=\"modal-close\" onclick=\"document.getElementById('userManagementModal').remove()\">&times;</button>\n            </div>\n            <div class=\"modal-body\" style=\"padding: 24px;\">\n              <div style=\"display: flex; justify-content: space-between; margin-bottom: 16px;\">\n                <h4>Team Members</h4>\n                <button class=\"btn btn-primary\" onclick=\"HubUsers.showCreateForm()\">Add User</button>\n              </div>\n              <div class=\"users-list\">\n                ${this.users.map(u => `\n                  <div class=\"user-row\">\n                    <div class=\"user-row-info\">\n                      <div class=\"user-row-name\">${this.escapeHtml(u.name)}</div>\n                      <div class=\"user-row-meta\">${u.username} &bull; ${u.role}</div>\n                    </div>\n                    <div class=\"user-row-status ${u.is_active ? 'active' : 'inactive'}\">\n                      ${u.is_active ? 'Active' : 'Inactive'}\n                    </div>\n                    <div class=\"user-row-actions\">\n                      <button class=\"btn-icon\" onclick=\"HubUsers.edit(${u.id})\" title=\"Edit\">Edit</button>\n                      ${u.id !== HubState.currentUser.id ? `\n                        <button class=\"btn-icon danger\" onclick=\"HubUsers.delete(${u.id})\" title=\"Delete\">Delete</button>\n                      ` : ''}\n                    </div>\n                  </div>\n                `).join('')}\n              </div>\n            </div>\n          </div>\n        </div>\n      `;\n      document.body.insertAdjacentHTML('beforeend', html);\n    });\n  },\n\n  showCreateForm() {\n    const isSuperAdmin = HubAuth.isSuperAdmin();\n    const roleOptions = isSuperAdmin \n      ? '<option value=\"user\">User</option><option value=\"admin\">Admin</option>'\n      : '<option value=\"user\">User</option>';\n    \n    const html = `\n      <div class=\"modal-overlay active\" id=\"createUserModal\" style=\"z-index: 210;\">\n        <div class=\"modal\" style=\"max-width: 400px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\" style=\"font-size: 18px;\">Create User</div>\n            </div>\n            <button class=\"modal-close\" onclick=\"document.getElementById('createUserModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <div class=\"form-group\">\n              <label>Email Address</label>\n              <input type=\"email\" id=\"newUserEmail\" class=\"form-input\" placeholder=\"user@example.com\" required>\n            </div>\n            <div class=\"form-group\">\n              <label>Username (for login)</label>\n              <input type=\"text\" id=\"newUserUsername\" class=\"form-input\" placeholder=\"username\" required>\n              <p style=\"font-size: 12px; color: var(--gray-500); margin-top: 4px;\">This is what the user will use to log in.</p>\n            </div>\n            <div class=\"form-group\">\n              <label>Display Name</label>\n              <input type=\"text\" id=\"newUserName\" class=\"form-input\" placeholder=\"John Doe\" required>\n            </div>\n            <div class=\"form-group\">\n              <label>Role</label>\n              <select id=\"newUserRole\" class=\"form-input\">\n                ${roleOptions}\n              </select>\n              ${!isSuperAdmin ? '<p style=\"font-size: 12px; color: var(--gray-500); margin-top: 4px;\">Only super admins can create admin accounts.</p>' : ''}\n            </div>\n            <div class=\"form-group\">\n              <label>Password</label>\n              <input type=\"password\" id=\"newUserPassword\" class=\"form-input\" placeholder=\"Minimum 6 characters\" required>\n              <p style=\"font-size: 12px; color: var(--gray-500); margin-top: 4px;\">User can change this after logging in.</p>\n            </div>\n            <div id=\"createUserError\" class=\"error-message\" style=\"display: none;\"></div>\n            <button class=\"btn btn-primary\" style=\"width: 100%; margin-top: 16px;\" onclick=\"HubUsers.create()\">\n              Create User\n            </button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async create() {\n    const email = document.getElementById('newUserEmail').value;\n    const username = document.getElementById('newUserUsername').value;\n    const name = document.getElementById('newUserName').value;\n    const role = document.getElementById('newUserRole').value;\n    const password = document.getElementById('newUserPassword').value;\n    const errorEl = document.getElementById('createUserError');\n\n    if (!email || !username || !name || !password) {\n      errorEl.textContent = 'All fields are required';\n      errorEl.style.display = 'block';\n      return;\n    }\n\n    if (password.length < 6) {\n      errorEl.textContent = 'Password must be at least 6 characters';\n      errorEl.style.display = 'block';\n      return;\n    }\n\n    try {\n      const result = await HubAPI.post('/hub/api/users', { username, email, name, role, password });\n\n      if (result.success) {\n        document.getElementById('createUserModal').remove();\n        \n        // Show credentials in a more visible way\n        const credentialsHtml = `\n          <div class=\"modal-overlay active\" id=\"userCredentialsModal\" style=\"z-index: 220;\">\n            <div class=\"modal\" style=\"max-width: 500px;\">\n              <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n                <div class=\"modal-header-content\">\n                  <div class=\"modal-title\" style=\"font-size: 18px;\">User Created Successfully</div>\n                </div>\n                <button class=\"modal-close\" onclick=\"document.getElementById('userCredentialsModal').remove()\">&times;</button>\n              </div>\n              <div class=\"modal-body\" style=\"padding: 24px;\">\n                <p style=\"margin-bottom: 16px;\">Share these credentials with the user:</p>\n                <div style=\"background: var(--gray-50); padding: 16px; border-radius: 8px; margin-bottom: 16px;\">\n                  <div style=\"margin-bottom: 8px;\"><strong>Email:</strong> ${email}</div>\n                  <div style=\"margin-bottom: 8px;\"><strong>Username:</strong> ${username}</div>\n                  <div><strong>Password:</strong> ${password}</div>\n                </div>\n                <p style=\"font-size: 12px; color: var(--gray-500); margin-bottom: 16px;\">The user can log in and change their password after first login.</p>\n                <button class=\"btn btn-primary\" style=\"width: 100%;\" onclick=\"document.getElementById('userCredentialsModal').remove(); HubUsers.show();\">\n                  Done\n                </button>\n              </div>\n            </div>\n          </div>\n        `;\n        document.body.insertAdjacentHTML('beforeend', credentialsHtml);\n        \n        // Refresh user list\n        const modal = document.getElementById('userManagementModal');\n        if (modal) modal.remove();\n        this.show();\n      } else {\n        errorEl.textContent = result.error;\n        errorEl.style.display = 'block';\n      }\n    } catch (e) {\n      errorEl.textContent = 'Failed to create user';\n      errorEl.style.display = 'block';\n    }\n  },\n\n  async delete(userId) {\n    if (!confirm('Are you sure you want to delete this user?')) return;\n\n    try {\n      const result = await HubAPI.delete(`/hub/api/users/${userId}`);\n      if (result.success) {\n        HubUI.showToast('User deleted', 'success');\n        const modal = document.getElementById('userManagementModal');\n        if (modal) modal.remove();\n        this.show(); // Refresh the users view\n      } else {\n        HubUI.showToast(result.error, 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to delete user', 'error');\n    }\n  },\n\n  confirmDelete(userId, userName) {\n    const modal = document.createElement('div');\n    modal.className = 'modal-overlay active';\n    modal.id = 'confirmDeleteModal';\n    modal.innerHTML = `\n      <div class=\"modal\" style=\"max-width: 400px;\">\n        <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n          <div class=\"modal-title\" style=\"font-size: 18px;\">Delete User</div>\n          <button class=\"modal-close\" onclick=\"document.getElementById('confirmDeleteModal').remove()\">&times;</button>\n        </div>\n        <div class=\"modal-body\" style=\"padding: 24px;\">\n          <p style=\"margin-bottom: 20px;\">Are you sure you want to delete <strong>${userName}</strong>? This action cannot be undone.</p>\n          <div style=\"display: flex; gap: 12px; justify-content: flex-end;\">\n            <button class=\"btn btn-secondary\" onclick=\"document.getElementById('confirmDeleteModal').remove()\">Cancel</button>\n            <button class=\"btn btn-danger\" onclick=\"HubUsers.executeDelete(${userId})\">Delete User</button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.appendChild(modal);\n  },\n\n  async executeDelete(userId) {\n    try {\n      const result = await HubAPI.delete(`/hub/api/users/${userId}`);\n      if (result.success) {\n        HubUI.showToast('User deleted', 'success');\n        document.getElementById('confirmDeleteModal').remove();\n        this.show(); // Refresh the users view\n      } else {\n        HubUI.showToast(result.error, 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to delete user', 'error');\n    }\n  },\n\n  showResetPasswordModal(userId, userName) {\n    const modal = document.createElement('div');\n    modal.className = 'modal-overlay active';\n    modal.id = 'resetPasswordModal';\n    modal.innerHTML = `\n      <div class=\"modal\" style=\"max-width: 400px;\">\n        <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n          <div class=\"modal-title\" style=\"font-size: 18px;\">Reset Password</div>\n          <button class=\"modal-close\" onclick=\"document.getElementById('resetPasswordModal').remove()\">&times;</button>\n        </div>\n        <div class=\"modal-body\" style=\"padding: 24px;\">\n          <p style=\"margin-bottom: 16px;\">Reset password for <strong>${userName}</strong></p>\n          <div class=\"form-group\">\n            <label>New Password</label>\n            <input type=\"password\" id=\"resetNewPassword\" class=\"form-input\" placeholder=\"Enter new password (min 6 chars)\">\n          </div>\n          <div class=\"form-group\">\n            <label>Confirm Password</label>\n            <input type=\"password\" id=\"resetConfirmPassword\" class=\"form-input\" placeholder=\"Confirm new password\">\n          </div>\n          <div id=\"resetPasswordError\" class=\"error-message\" style=\"display: none;\"></div>\n          <p style=\"font-size: 12px; color: var(--gray-500); margin-top: 12px;\">User will be required to change their password on next login.</p>\n          <div style=\"display: flex; gap: 12px; justify-content: flex-end; margin-top: 20px;\">\n            <button class=\"btn btn-secondary\" onclick=\"document.getElementById('resetPasswordModal').remove()\">Cancel</button>\n            <button class=\"btn btn-primary\" onclick=\"HubUsers.executeResetPassword(${userId})\">Reset Password</button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.appendChild(modal);\n  },\n\n  async executeResetPassword(userId) {\n    const newPassword = document.getElementById('resetNewPassword').value;\n    const confirmPassword = document.getElementById('resetConfirmPassword').value;\n    const errorEl = document.getElementById('resetPasswordError');\n\n    errorEl.style.display = 'none';\n\n    if (!newPassword || newPassword.length < 6) {\n      errorEl.textContent = 'Password must be at least 6 characters';\n      errorEl.style.display = 'block';\n      return;\n    }\n\n    if (newPassword !== confirmPassword) {\n      errorEl.textContent = 'Passwords do not match';\n      errorEl.style.display = 'block';\n      return;\n    }\n\n    try {\n      const result = await HubAPI.post(`/hub/api/users/${userId}/reset-password`, { newPassword });\n      if (result.success) {\n        HubUI.showToast('Password reset successfully', 'success');\n        document.getElementById('resetPasswordModal').remove();\n      } else {\n        errorEl.textContent = result.error || 'Failed to reset password';\n        errorEl.style.display = 'block';\n      }\n    } catch (e) {\n      errorEl.textContent = 'Network error. Please try again.';\n      errorEl.style.display = 'block';\n    }\n  },\n\n  pendingAssignCaseIds: null,\n  activeDropdown: null,\n\n  showAssignModal(caseIds) {\n    // For bulk actions, still use modal since there's no click position\n    this.pendingAssignCaseIds = caseIds;\n    \n    this.load().then(() => {\n      const html = `\n        <div class=\"modal-overlay active\" id=\"assignModal\">\n          <div class=\"modal\" style=\"max-width: 400px;\">\n            <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n              <div class=\"modal-header-content\">\n                <div class=\"modal-title\" style=\"font-size: 18px;\">Assign ${caseIds.length} Case${caseIds.length > 1 ? 's' : ''}</div>\n              </div>\n              <button class=\"modal-close\" onclick=\"document.getElementById('assignModal').remove()\">&times;</button>\n            </div>\n            <div class=\"modal-body\" style=\"padding: 24px;\">\n              <div class=\"form-group\">\n                <label>Assign to</label>\n                <select id=\"assignToUser\" class=\"form-input\">\n                  <option value=\"\">Unassign</option>\n                  ${this.users.filter(u => u.is_active).map(u => `\n                    <option value=\"${u.id}\">${this.escapeHtml(u.name)}</option>\n                  `).join('')}\n                </select>\n              </div>\n              <div style=\"display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;\">\n                <button class=\"btn btn-secondary\" onclick=\"document.getElementById('assignModal').remove()\">Cancel</button>\n                <button class=\"btn btn-primary\" onclick=\"HubUsers.confirmAssign()\">Assign</button>\n              </div>\n            </div>\n          </div>\n        </div>\n      `;\n      document.body.insertAdjacentHTML('beforeend', html);\n    });\n  },\n\n  showAssignDropdown(event, caseIds, currentAssignee) {\n    event.stopPropagation();\n    \n    // Close any existing dropdown\n    this.closeDropdown();\n    \n    // Store caseIds for later use\n    this.pendingAssignCaseIds = caseIds;\n    \n    // Get click position\n    const rect = event.currentTarget.getBoundingClientRect();\n    \n    this.load().then(() => {\n      const getInitials = (name) => {\n        if (!name) return '?';\n        return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();\n      };\n\n      const html = `\n        <div class=\"assignee-dropdown\" id=\"assigneeDropdown\" style=\"top: ${rect.bottom + 4}px; left: ${Math.min(rect.left, window.innerWidth - 280)}px;\">\n          <div class=\"assignee-dropdown-search\">\n            <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z\"/></svg>\n            <input type=\"text\" id=\"assigneeSearchInput\" placeholder=\"Search team members...\" oninput=\"HubUsers.filterAssigneeDropdown(this.value)\" onclick=\"event.stopPropagation()\">\n          </div>\n          <div class=\"assignee-dropdown-list\" id=\"assigneeDropdownList\">\n            <div class=\"assignee-dropdown-item assignee-dropdown-unassign ${!currentAssignee ? 'selected' : ''}\" data-name=\"unassigned\" onclick=\"HubUsers.selectAssignee(null)\">\n              <div class=\"assignee-avatar unassigned\">\n                <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"14\" height=\"14\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M18.364 18.364A9 9 0 005.636 5.636m12.728 12.728A9 9 0 015.636 5.636m12.728 12.728L5.636 5.636\"/></svg>\n              </div>\n              <div class=\"assignee-dropdown-item-info\">\n                <div class=\"assignee-dropdown-item-name\">Unassigned</div>\n                <div class=\"assignee-dropdown-item-role\">Remove assignment</div>\n              </div>\n              <svg class=\"assignee-dropdown-item-check\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"/></svg>\n            </div>\n            <div class=\"assignee-dropdown-divider\"></div>\n            ${this.users.filter(u => u.is_active).map(u => `\n              <div class=\"assignee-dropdown-item ${currentAssignee === u.name ? 'selected' : ''}\" data-name=\"${this.escapeHtml(u.name.toLowerCase())}\" onclick=\"HubUsers.selectAssignee(${u.id}, '${this.escapeHtml(u.name)}')\">\n                <div class=\"assignee-avatar\">${getInitials(u.name)}</div>\n                <div class=\"assignee-dropdown-item-info\">\n                  <div class=\"assignee-dropdown-item-name\">${this.escapeHtml(u.name)}</div>\n                  <div class=\"assignee-dropdown-item-role\">${this.escapeHtml(u.role || 'Team Member')}</div>\n                </div>\n                <svg class=\"assignee-dropdown-item-check\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"/></svg>\n              </div>\n            `).join('')}\n          </div>\n        </div>\n      `;\n      \n      document.body.insertAdjacentHTML('beforeend', html);\n      this.activeDropdown = document.getElementById('assigneeDropdown');\n      \n      // Focus search input\n      setTimeout(() => {\n        const searchInput = document.getElementById('assigneeSearchInput');\n        if (searchInput) searchInput.focus();\n      }, 50);\n      \n      // Close dropdown when clicking outside\n      setTimeout(() => {\n        document.addEventListener('click', this.handleOutsideClick);\n      }, 10);\n    });\n  },\n\n  filterAssigneeDropdown(query) {\n    const list = document.getElementById('assigneeDropdownList');\n    if (!list) return;\n    \n    const items = list.querySelectorAll('.assignee-dropdown-item');\n    const divider = list.querySelector('.assignee-dropdown-divider');\n    const lowerQuery = query.toLowerCase().trim();\n    \n    let visibleUserCount = 0;\n    \n    items.forEach(item => {\n      const name = item.dataset.name || '';\n      if (name === 'unassigned') {\n        // Always show unassigned option when query is empty\n        item.style.display = lowerQuery === '' ? 'flex' : 'none';\n      } else {\n        const matches = name.includes(lowerQuery);\n        item.style.display = matches ? 'flex' : 'none';\n        if (matches) visibleUserCount++;\n      }\n    });\n    \n    // Hide divider if searching\n    if (divider) {\n      divider.style.display = lowerQuery === '' ? 'block' : 'none';\n    }\n  },\n\n  handleOutsideClick(e) {\n    const dropdown = document.getElementById('assigneeDropdown');\n    if (dropdown && !dropdown.contains(e.target)) {\n      HubUsers.closeDropdown();\n    }\n  },\n\n  closeDropdown() {\n    const dropdown = document.getElementById('assigneeDropdown');\n    if (dropdown) {\n      dropdown.remove();\n    }\n    this.activeDropdown = null;\n    document.removeEventListener('click', this.handleOutsideClick);\n  },\n\n  async selectAssignee(userId, userName) {\n    this.closeDropdown();\n    const caseIds = this.pendingAssignCaseIds || Array.from(HubState.selectedCaseIds);\n    this.pendingAssignCaseIds = null;\n    \n    await HubBulkActions.assignWithIds(userId, caseIds);\n  },\n\n  async confirmAssign() {\n    const userId = document.getElementById('assignToUser').value;\n    const caseIds = this.pendingAssignCaseIds || Array.from(HubState.selectedCaseIds);\n    this.pendingAssignCaseIds = null; // Clear after use\n    \n    document.getElementById('assignModal').remove();\n    await HubBulkActions.assignWithIds(userId ? parseInt(userId) : null, caseIds);\n  },\n\n  // Helper to render the assignee cell with the new design\n  renderAssigneeCell(caseId, assignedTo) {\n    const getInitials = (name) => {\n      if (!name) return '?';\n      return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();\n    };\n    \n    const isUnassigned = !assignedTo;\n    const displayName = assignedTo || 'Unassigned';\n    const initials = isUnassigned ? '?' : getInitials(assignedTo);\n    \n    return `\n      <div class=\"assignee-cell\" onclick=\"event.stopPropagation(); HubUsers.showAssignDropdown(event, ['${caseId}'], ${assignedTo ? \"'\" + this.escapeHtml(assignedTo) + \"'\" : 'null'})\">\n        <div class=\"assignee-avatar ${isUnassigned ? 'unassigned' : ''}\">${isUnassigned ? '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"12\" height=\"12\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\"/></svg>' : initials}</div>\n        <span class=\"assignee-name ${isUnassigned ? 'unassigned' : ''}\">${this.escapeHtml(displayName)}</span>\n        <svg class=\"assignee-edit-icon\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 9l-7 7-7-7\"/></svg>\n      </div>\n    `;\n  },\n\n  escapeHtml(text) {\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// ASSIGNMENT QUEUE (Admin)\n// ============================================\nconst HubAssignment = {\n  async showQueue() {\n    if (!HubAuth.isAdmin()) {\n      HubUI.showToast('Admin access required', 'error');\n      return;\n    }\n\n    try {\n      const result = await HubAPI.get('/hub/api/assignment-queue');\n      const queue = result.queue || [];\n\n      const html = `\n        <div class=\"modal-overlay active\" id=\"assignmentQueueModal\">\n          <div class=\"modal\" style=\"max-width: 600px;\">\n            <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n              <div class=\"modal-header-content\">\n                <div class=\"modal-title\" style=\"font-size: 18px;\">Assignment Queue (Round Robin)</div>\n              </div>\n              <button class=\"modal-close\" onclick=\"document.getElementById('assignmentQueueModal').remove()\">&times;</button>\n            </div>\n            <div class=\"modal-body\" style=\"padding: 24px;\">\n              <p style=\"margin-bottom: 16px; color: var(--gray-500);\">\n                Configure which team members receive auto-assigned cases.\n              </p>\n              ${queue.length > 0 ? `\n                <table class=\"queue-table\">\n                  <thead>\n                    <tr>\n                      <th>User</th>\n                      <th>Case Type</th>\n                      <th>Load</th>\n                      <th>Active</th>\n                    </tr>\n                  </thead>\n                  <tbody>\n                    ${queue.map(q => `\n                      <tr>\n                        <td>${q.user_name}</td>\n                        <td>${q.case_type || 'All'}</td>\n                        <td>${q.current_load} / ${q.max_load}</td>\n                        <td>\n                          <input type=\"checkbox\" ${q.is_active ? 'checked' : ''}\n                                 onchange=\"HubAssignment.toggleActive(${q.id}, this.checked)\">\n                        </td>\n                      </tr>\n                    `).join('')}\n                  </tbody>\n                </table>\n              ` : '<p>No users in assignment queue. Add users to enable auto-assignment.</p>'}\n              <button class=\"btn btn-secondary\" style=\"margin-top: 16px;\" onclick=\"HubAssignment.recalculate()\">\n                Recalculate Loads\n              </button>\n            </div>\n          </div>\n        </div>\n      `;\n      document.body.insertAdjacentHTML('beforeend', html);\n    } catch (e) {\n      HubUI.showToast('Failed to load assignment queue', 'error');\n    }\n  },\n\n  async toggleActive(queueId, isActive) {\n    // Implementation would update the queue entry\n  },\n\n  async recalculate() {\n    try {\n      const result = await HubAPI.post('/hub/api/assignment/recalculate', {});\n      if (result.success) {\n        HubUI.showToast('Loads recalculated', 'success');\n        document.getElementById('assignmentQueueModal').remove();\n        this.showQueue();\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to recalculate', 'error');\n    }\n  }\n};\n\n// ============================================\n// CASES\n// ============================================\n// ============================================\n// ENHANCED SEARCH WITH DROPDOWN\n// ============================================\nconst HubSearch = {\n  searchTimeout: null,\n  searchResults: [],\n  selectedIndex: -1,\n\n  init() {\n    const searchInput = document.getElementById('searchInput');\n    const searchDropdown = document.getElementById('searchDropdown');\n    const clearBtn = document.getElementById('clearSearchBtn');\n\n    if (!searchInput) return;\n\n    // Update placeholder based on current page\n    this.updatePlaceholder();\n\n    // Debounced search\n    searchInput.addEventListener('input', (e) => {\n      const query = e.target.value.trim();\n      \n      if (query.length === 0) {\n        this.hideDropdown();\n        clearBtn.style.display = 'none';\n        const currentPage = HubState.currentPage;\n        if (currentPage === 'issues') {\n          HubState.issuesSearch = '';\n          HubIssues.load(1);\n        } else {\n          HubState.currentSearch = '';\n          HubFilters.applyFilters();\n        }\n        return;\n      }\n\n      clearBtn.style.display = 'block';\n      \n      clearTimeout(this.searchTimeout);\n      this.searchTimeout = setTimeout(() => {\n        this.performSearch(query);\n      }, 300);\n    });\n\n    // Keyboard navigation\n    searchInput.addEventListener('keydown', (e) => {\n      if (e.key === 'ArrowDown') {\n        e.preventDefault();\n        this.selectedIndex = Math.min(this.selectedIndex + 1, this.searchResults.length - 1);\n        this.highlightSelected();\n      } else if (e.key === 'ArrowUp') {\n        e.preventDefault();\n        this.selectedIndex = Math.max(this.selectedIndex - 1, -1);\n        this.highlightSelected();\n      } else if (e.key === 'Enter') {\n        e.preventDefault();\n        if (this.selectedIndex >= 0 && this.searchResults[this.selectedIndex]) {\n          const context = HubState.currentPage === 'issues' ? 'issues' : 'cases';\n          this.selectResult(this.searchResults[this.selectedIndex], context);\n        } else {\n          // Apply search directly\n          const currentPage = HubState.currentPage;\n          if (currentPage === 'issues') {\n            HubState.issuesSearch = searchInput.value.trim();\n            HubIssues.load(1);\n          } else {\n            HubState.currentSearch = searchInput.value.trim();\n            HubFilters.applyFilters();\n          }\n          this.hideDropdown();\n        }\n      } else if (e.key === 'Escape') {\n        this.hideDropdown();\n      }\n    });\n\n    // Click outside to close\n    document.addEventListener('click', (e) => {\n      if (!searchInput.contains(e.target) && !searchDropdown?.contains(e.target)) {\n        this.hideDropdown();\n      }\n    });\n  },\n\n  async performSearch(query) {\n    if (query.length < 2) {\n      this.hideDropdown();\n      return;\n    }\n\n    const dropdown = document.getElementById('searchDropdown');\n    if (!dropdown) return;\n\n    dropdown.innerHTML = '<div class=\"search-dropdown-loading\">Searching...</div>';\n    dropdown.style.display = 'block';\n    this.selectedIndex = -1;\n\n    try {\n      // Use unified search API for grouped results\n      const result = await HubAPI.get(`/hub/api/search?q=${encodeURIComponent(query)}&limit=5`);\n      this.unifiedResults = {\n        cases: result.cases || [],\n        sessions: result.sessions || [],\n        issues: result.issues || []\n      };\n      // Flatten results for keyboard navigation\n      this.searchResults = [\n        ...this.unifiedResults.cases.map(c => ({ ...c, _type: 'case' })),\n        ...this.unifiedResults.sessions.map(s => ({ ...s, _type: 'session' })),\n        ...this.unifiedResults.issues.map(i => ({ ...i, _type: 'issue' }))\n      ];\n      this.renderUnifiedDropdown(query);\n    } catch (e) {\n      console.error('Search error:', e);\n      dropdown.innerHTML = '<div class=\"search-dropdown-empty\">Search failed. Try again.</div>';\n    }\n  },\n\n  renderUnifiedDropdown(query) {\n    const dropdown = document.getElementById('searchDropdown');\n    if (!dropdown) return;\n\n    const { cases, sessions, issues } = this.unifiedResults;\n    const hasResults = cases.length > 0 || sessions.length > 0 || issues.length > 0;\n\n    if (!hasResults) {\n      dropdown.innerHTML = '<div class=\"search-dropdown-empty\">No results found for \"' + this.escapeHtml(query) + '\"</div>';\n      return;\n    }\n\n    const highlightText = (text) => {\n      if (!text || !query) return this.escapeHtml(text || '');\n      const escaped = query.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&');\n      const regex = new RegExp('(' + escaped + ')', 'gi');\n      return this.escapeHtml(text).replace(regex, '<mark>$1</mark>');\n    };\n\n    let html = '';\n    let flatIndex = 0;\n\n    // Cases section\n    if (cases.length > 0) {\n      html += `<div class=\"search-section-header\">Cases <span class=\"search-count\">${cases.length}</span></div>`;\n      html += cases.map((c) => {\n        const idx = flatIndex++;\n        return `\n          <div class=\"search-result-item ${idx === this.selectedIndex ? 'selected' : ''}\" \n               onclick=\"HubSearch.selectUnifiedResult('case', '${c.case_id}')\"\n               data-index=\"${idx}\">\n            <div class=\"search-result-main\">\n              <span class=\"search-result-name\">${highlightText(c.customer_name || 'Unknown')}</span>\n              <span class=\"search-result-badge ${c.case_type}\">${c.case_type}</span>\n              <span class=\"search-result-status ${c.status}\">${c.status || 'pending'}</span>\n            </div>\n            <div class=\"search-result-details\">\n              ${highlightText(c.customer_email || '')} ${c.order_number ? 'â€¢ ' + c.order_number : ''}\n            </div>\n          </div>\n        `;\n      }).join('');\n    }\n\n    // Sessions section\n    if (sessions.length > 0) {\n      html += `<div class=\"search-section-header\">Sessions <span class=\"search-count\">${sessions.length}</span></div>`;\n      html += sessions.map((s) => {\n        const idx = flatIndex++;\n        const timeAgo = this.timeAgo(s.started_at);\n        return `\n          <div class=\"search-result-item ${idx === this.selectedIndex ? 'selected' : ''}\" \n               onclick=\"HubSearch.selectUnifiedResult('session', '${s.session_id}')\"\n               data-index=\"${idx}\">\n            <div class=\"search-result-main\">\n              <span class=\"search-result-name\">${highlightText(s.customer_name || s.customer_email || 'Unknown')}</span>\n              <span class=\"search-result-badge session\">${s.flow_type || 'Session'}</span>\n            </div>\n            <div class=\"search-result-details\">\n              ${highlightText(s.customer_email || '')} â€¢ ${s.outcome || ''} â€¢ ${timeAgo}\n            </div>\n          </div>\n        `;\n      }).join('');\n    }\n\n    // Issues section\n    if (issues.length > 0) {\n      html += `<div class=\"search-section-header\">Issues <span class=\"search-count\">${issues.length}</span></div>`;\n      html += issues.map((i) => {\n        const idx = flatIndex++;\n        return `\n          <div class=\"search-result-item ${idx === this.selectedIndex ? 'selected' : ''}\" \n               onclick=\"HubSearch.selectUnifiedResult('issue', '${i.report_id}')\"\n               data-index=\"${idx}\">\n            <div class=\"search-result-main\">\n              <span class=\"search-result-name\">${highlightText(i.customer_email || 'Unknown')}</span>\n              <span class=\"search-result-badge issue\">${i.issue_type || 'Issue'}</span>\n              <span class=\"search-result-status ${i.status}\">${i.status || 'pending'}</span>\n            </div>\n            <div class=\"search-result-details\">\n              ${i.description ? highlightText(i.description.substring(0, 60) + '...') : ''}\n            </div>\n          </div>\n        `;\n      }).join('');\n    }\n\n    dropdown.innerHTML = html;\n  },\n\n  selectUnifiedResult(type, id) {\n    this.hideDropdown();\n    document.getElementById('searchInput').value = '';\n    \n    if (type === 'case') {\n      HubNavigation.goto('case-detail', id);\n    } else if (type === 'session') {\n      // Find session and open replay URL if available\n      const session = this.unifiedResults?.sessions?.find(s => s.session_id === id);\n      if (session?.session_replay_url) {\n        window.open(session.session_replay_url, '_blank');\n      } else {\n        HubNavigation.goto('sessions');\n      }\n    } else if (type === 'issue') {\n      HubNavigation.goto('issues');\n      // Could implement issue detail view later\n    }\n  },\n\n  timeAgo(timestamp) {\n    if (!timestamp) return '';\n    const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);\n    if (seconds < 60) return 'Just now';\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\n    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;\n    return new Date(timestamp).toLocaleDateString();\n  },\n\n  renderDropdown(context = 'cases') {\n    const dropdown = document.getElementById('searchDropdown');\n    if (!dropdown) return;\n\n    if (this.searchResults.length === 0) {\n      dropdown.innerHTML = '<div class=\"search-dropdown-empty\">No results found</div>';\n      return;\n    }\n\n    const query = document.getElementById('searchInput')?.value.trim().toLowerCase() || '';\n    \n    if (context === 'issues') {\n      // Render issues search results\n      dropdown.innerHTML = this.searchResults.map((item, idx) => {\n        const highlightText = (text) => {\n          if (!text || !query) return this.escapeHtml(text || '');\n          const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')})`, 'gi');\n          return this.escapeHtml(text).replace(regex, '<span class=\"search-dropdown-item-highlight\">$1</span>');\n        };\n\n        return `\n          <div class=\"search-dropdown-item ${idx === this.selectedIndex ? 'selected' : ''}\" \n               onclick=\"HubSearch.selectResult(${JSON.stringify(item).replace(/\"/g, '&quot;')}, 'issues')\"\n               data-index=\"${idx}\">\n            <div class=\"search-dropdown-item-header\">\n              ${highlightText(item.customer_email || 'Unknown')}\n              <span style=\"font-size: 11px; color: var(--gray-500);\">${item.report_id?.substring(0, 8) || ''}</span>\n            </div>\n            <div class=\"search-dropdown-item-meta\">\n              <span>${highlightText(item.issue_type || '')}</span>\n              <span>${item.status || ''}</span>\n              ${item.name ? `<span>${highlightText(item.name)}</span>` : ''}\n            </div>\n          </div>\n        `;\n      }).join('');\n    } else {\n      // Render cases search results (default)\n      dropdown.innerHTML = this.searchResults.map((item, idx) => {\n        const highlightText = (text) => {\n          if (!text || !query) return this.escapeHtml(text || '');\n          const regex = new RegExp(`(${query.replace(/[.*+?^${}()|[\\]\\\\]/g, '\\\\$&')})`, 'gi');\n          return this.escapeHtml(text).replace(regex, '<span class=\"search-dropdown-item-highlight\">$1</span>');\n        };\n\n        return `\n          <div class=\"search-dropdown-item ${idx === this.selectedIndex ? 'selected' : ''}\" \n               onclick=\"HubSearch.selectResult(${JSON.stringify(item).replace(/\"/g, '&quot;')}, 'cases')\"\n               data-index=\"${idx}\">\n            <div class=\"search-dropdown-item-header\">\n              ${highlightText(item.customer_name || 'Unknown Customer')}\n              <span style=\"font-size: 11px; color: var(--gray-500);\">${item.case_id?.substring(0, 8)}</span>\n            </div>\n            <div class=\"search-dropdown-item-meta\">\n              <span>${highlightText(item.customer_email || '')}</span>\n              <span>${item.case_type || ''}</span>\n              <span>${item.status || ''}</span>\n              ${item.order_number ? `<span>Order: ${highlightText(item.order_number)}</span>` : ''}\n              ${item.resolution ? `<span>${highlightText(item.resolution.substring(0, 50))}...</span>` : ''}\n            </div>\n          </div>\n        `;\n      }).join('');\n    }\n  },\n\n  highlightSelected() {\n    const items = document.querySelectorAll('.search-dropdown-item');\n    items.forEach((item, idx) => {\n      if (idx === this.selectedIndex) {\n        item.classList.add('selected');\n        item.scrollIntoView({ block: 'nearest' });\n      } else {\n        item.classList.remove('selected');\n      }\n    });\n  },\n\n  selectResult(result, context = 'cases') {\n    const searchInput = document.getElementById('searchInput');\n    if (context === 'issues') {\n      searchInput.value = result.customer_email || result.name || '';\n      HubState.issuesSearch = result.customer_email || result.name || '';\n      this.hideDropdown();\n      HubIssues.load(1);\n      \n      // Optionally open the issue\n      if (result.report_id) {\n        setTimeout(() => HubIssues.openIssue(result.report_id), 100);\n      }\n    } else {\n      searchInput.value = result.customer_name || result.customer_email || '';\n      HubState.currentSearch = result.customer_name || result.customer_email || '';\n      this.hideDropdown();\n      HubFilters.applyFilters();\n      \n      // Optionally open the case\n      if (result.case_id) {\n        setTimeout(() => HubCases.openCase(result.case_id), 100);\n      }\n    }\n  },\n\n  hideDropdown() {\n    const dropdown = document.getElementById('searchDropdown');\n    if (dropdown) dropdown.style.display = 'none';\n    this.selectedIndex = -1;\n    this.searchResults = [];\n  },\n\n  clear() {\n    const searchInput = document.getElementById('searchInput');\n    const clearBtn = document.getElementById('clearSearchBtn');\n    if (searchInput) {\n      searchInput.value = '';\n      const currentPage = HubState.currentPage;\n      if (currentPage === 'issues') {\n        HubState.issuesSearch = '';\n        HubIssues.load(1);\n      } else {\n        HubState.currentSearch = '';\n        HubFilters.applyFilters();\n      }\n      clearBtn.style.display = 'none';\n      this.hideDropdown();\n    }\n  },\n\n  updatePlaceholder() {\n    const searchInput = document.getElementById('searchInput');\n    const assigneeFilter = document.getElementById('assigneeFilter');\n    const statusFilter = document.getElementById('statusFilter');\n    const sortBy = document.getElementById('sortBy');\n    \n    if (!searchInput) return;\n\n    const currentPage = HubState.currentPage;\n    if (currentPage === 'issues') {\n      searchInput.placeholder = 'Search issues: email, name, report ID, description...';\n      // Hide assignee filter for issues\n      if (assigneeFilter) assigneeFilter.style.display = 'none';\n      // Update status filter options for issues\n      if (statusFilter) {\n        statusFilter.innerHTML = `\n          <option value=\"\">All Status</option>\n          <option value=\"pending\">Pending</option>\n          <option value=\"in_progress\">In Progress</option>\n          <option value=\"resolved\">Resolved</option>\n        `;\n      }\n      // Update sort options for issues\n      if (sortBy) {\n        sortBy.innerHTML = `\n          <option value=\"created_desc\">Newest First</option>\n          <option value=\"created_asc\">Oldest First</option>\n          <option value=\"status_asc\">Status (A-Z)</option>\n          <option value=\"status_desc\">Status (Z-A)</option>\n          <option value=\"customer_email_asc\">Email (A-Z)</option>\n          <option value=\"customer_email_desc\">Email (Z-A)</option>\n          <option value=\"issue_type_asc\">Issue Type (A-Z)</option>\n          <option value=\"issue_type_desc\">Issue Type (Z-A)</option>\n        `;\n      }\n    } else {\n      searchInput.placeholder = 'Search anything: name, email, case ID, order, resolution...';\n      // Show assignee filter for cases\n      if (assigneeFilter) assigneeFilter.style.display = 'block';\n      // Update status filter options for cases\n      if (statusFilter) {\n        statusFilter.innerHTML = `\n          <option value=\"\">All Status</option>\n          <option value=\"pending\">Pending</option>\n          <option value=\"in_progress\">In Progress</option>\n          <option value=\"completed\">Completed</option>\n          <option value=\"overdue\">Overdue</option>\n        `;\n      }\n      // Update sort options for cases\n      if (sortBy) {\n        sortBy.innerHTML = `\n          <option value=\"created_desc\">Newest First</option>\n          <option value=\"created_asc\">Oldest First</option>\n          <option value=\"due_asc\">Due Date (Earliest)</option>\n          <option value=\"due_desc\">Due Date (Latest)</option>\n          <option value=\"customer_name_asc\">Customer (A-Z)</option>\n          <option value=\"customer_name_desc\">Customer (Z-A)</option>\n          <option value=\"status_asc\">Status (A-Z)</option>\n          <option value=\"status_desc\">Status (Z-A)</option>\n          <option value=\"case_type_asc\">Type (A-Z)</option>\n          <option value=\"case_type_desc\">Type (Z-A)</option>\n          <option value=\"assigned_to_asc\">Assignee (A-Z)</option>\n          <option value=\"assigned_to_desc\">Assignee (Z-A)</option>\n        `;\n      }\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// FILTERS & SORTING\n// ============================================\nconst HubFilters = {\n  init() {\n    // Load saved filter state from URL or localStorage\n    const urlParams = new URLSearchParams(window.location.search);\n    const savedFilters = localStorage.getItem('hub_filters');\n    \n    if (savedFilters) {\n      try {\n        const filters = JSON.parse(savedFilters);\n        // Use the inline filter IDs (casesStatusFilter, etc.)\n        const statusEl = document.getElementById('casesStatusFilter');\n        const assigneeEl = document.getElementById('casesAssigneeFilter');\n        const dateEl = document.getElementById('casesDateFilter');\n        const sortEl = document.getElementById('casesSortFilter');\n        \n        if (filters.status && statusEl) statusEl.value = filters.status;\n        if (filters.assignee && assigneeEl) assigneeEl.value = filters.assignee;\n        if (filters.dateRange && dateEl) dateEl.value = filters.dateRange;\n        if (filters.sortBy && sortEl) sortEl.value = filters.sortBy;\n        \n        // Handle custom date range\n        if (filters.dateRange === 'custom') {\n          this.handleDateFilterChange('custom');\n          if (filters.dateFrom) document.getElementById('dateFrom').value = filters.dateFrom;\n          if (filters.dateTo) document.getElementById('dateTo').value = filters.dateTo;\n        }\n      } catch (e) {\n        console.error('Failed to load saved filters:', e);\n      }\n    }\n\n    // Load saved views (only after login)\n    if (HubState.token) {\n      HubSavedViews.load();\n    }\n  },\n\n  handleDateFilterChange(value) {\n    const customDateRange = document.getElementById('customDateRange');\n    if (value === 'custom') {\n      // Show custom date picker\n      if (customDateRange) {\n        customDateRange.style.display = 'flex';\n        // Set default dates (last 30 days)\n        const today = new Date();\n        const thirtyDaysAgo = new Date(today);\n        thirtyDaysAgo.setDate(today.getDate() - 30);\n        \n        document.getElementById('dateFrom').value = thirtyDaysAgo.toISOString().split('T')[0];\n        document.getElementById('dateTo').value = today.toISOString().split('T')[0];\n      }\n    } else {\n      // Hide custom date picker\n      if (customDateRange) {\n        customDateRange.style.display = 'none';\n      }\n      this.applyFilters();\n    }\n  },\n\n  applyFilters() {\n    const currentPage = HubState.currentPage;\n    \n    if (currentPage === 'issues') {\n      // Apply issue filters\n      const status = document.getElementById('statusFilter')?.value || '';\n      const dateRange = document.getElementById('dateRangeFilter')?.value || '';\n      const sortBy = document.getElementById('sortBy')?.value || 'created_desc';\n\n      // Save filters\n      localStorage.setItem('hub_issues_filters', JSON.stringify({\n        status, dateRange, sortBy\n      }));\n\n      // Update state\n      HubState.issuesStatus = status;\n      HubState.issuesDateRange = dateRange;\n      HubState.issuesSortBy = sortBy;\n\n      // Reload issues\n      HubIssues.load(1);\n    } else {\n      // Apply case filters (default) - check both inline and header filters\n      const status = document.getElementById('casesStatusFilter')?.value || document.getElementById('statusFilter')?.value || '';\n      const assignee = document.getElementById('casesAssigneeFilter')?.value || document.getElementById('assigneeFilter')?.value || '';\n      let dateRange = document.getElementById('casesDateFilter')?.value || document.getElementById('dateRangeFilter')?.value || '';\n      const sortBy = document.getElementById('casesSortFilter')?.value || document.getElementById('sortBy')?.value || 'created_desc';\n      const search = HubState.currentSearch || '';\n\n      // Handle custom date range\n      let dateFrom = null;\n      let dateTo = null;\n      if (dateRange === 'custom') {\n        dateFrom = document.getElementById('dateFrom')?.value || null;\n        dateTo = document.getElementById('dateTo')?.value || null;\n      }\n\n      // Save filters\n      localStorage.setItem('hub_filters', JSON.stringify({\n        status, assignee, dateRange, sortBy, dateFrom, dateTo\n      }));\n\n      // Update state\n      HubState.currentStatus = status;\n      HubState.currentAssignee = assignee;\n      HubState.currentDateRange = dateRange;\n      HubState.currentDateFrom = dateFrom;\n      HubState.currentDateTo = dateTo;\n      HubState.currentSortBy = sortBy;\n\n      // Sync inline filters with header filters\n      this.syncFilters();\n\n      // Clear active saved view (user modified filters)\n      HubSavedViews.clearActive();\n\n      // Reload cases\n      HubCases.loadCases(1);\n    }\n  },\n\n  syncFilters() {\n    // Sync inline filters with header filters\n    const headerStatus = document.getElementById('statusFilter');\n    const inlineStatus = document.getElementById('casesStatusFilter');\n    if (headerStatus && inlineStatus && headerStatus.value !== inlineStatus.value) {\n      if (document.activeElement === headerStatus) {\n        inlineStatus.value = headerStatus.value;\n      } else if (document.activeElement === inlineStatus) {\n        headerStatus.value = inlineStatus.value;\n      }\n    }\n\n    const headerAssignee = document.getElementById('assigneeFilter');\n    const inlineAssignee = document.getElementById('casesAssigneeFilter');\n    if (headerAssignee && inlineAssignee && headerAssignee.value !== inlineAssignee.value) {\n      if (document.activeElement === headerAssignee) {\n        inlineAssignee.value = headerAssignee.value;\n      } else if (document.activeElement === inlineAssignee) {\n        headerAssignee.value = inlineAssignee.value;\n      }\n    }\n  },\n\n  getFilterParams() {\n    const params = {\n      status: HubState.currentStatus || '',\n      assignee: HubState.currentAssignee || '',\n      dateRange: HubState.currentDateRange || '',\n      sortBy: HubState.currentSortBy || 'created_desc',\n      search: HubState.currentSearch || ''\n    };\n\n    // Add custom date range if applicable\n    if (HubState.currentDateRange === 'custom') {\n      params.dateFrom = HubState.currentDateFrom || '';\n      params.dateTo = HubState.currentDateTo || '';\n    }\n\n    return params;\n  },\n\n  getCurrentFilters() {\n    return {\n      status: document.getElementById('casesStatusFilter')?.value || '',\n      assignee: document.getElementById('casesAssigneeFilter')?.value || '',\n      dateRange: document.getElementById('casesDateFilter')?.value || '',\n      dateFrom: document.getElementById('dateFrom')?.value || '',\n      dateTo: document.getElementById('dateTo')?.value || '',\n      sortBy: document.getElementById('casesSortFilter')?.value || 'created_desc',\n      type: HubState.currentFilter || 'all'\n    };\n  },\n\n  setFilters(filters) {\n    if (filters.status) {\n      const statusEl = document.getElementById('casesStatusFilter');\n      if (statusEl) statusEl.value = filters.status;\n    }\n    if (filters.assignee) {\n      const assigneeEl = document.getElementById('casesAssigneeFilter');\n      if (assigneeEl) assigneeEl.value = filters.assignee;\n    }\n    if (filters.dateRange) {\n      const dateEl = document.getElementById('casesDateFilter');\n      if (dateEl) dateEl.value = filters.dateRange;\n      \n      // Handle custom date range\n      if (filters.dateRange === 'custom') {\n        this.handleDateFilterChange('custom');\n        if (filters.dateFrom) document.getElementById('dateFrom').value = filters.dateFrom;\n        if (filters.dateTo) document.getElementById('dateTo').value = filters.dateTo;\n      } else {\n        const customDateRange = document.getElementById('customDateRange');\n        if (customDateRange) customDateRange.style.display = 'none';\n      }\n    }\n    if (filters.sortBy) {\n      const sortEl = document.getElementById('casesSortFilter');\n      if (sortEl) sortEl.value = filters.sortBy;\n    }\n  }\n};\n\n// ============================================\n// SAVED VIEWS\n// ============================================\nconst HubSavedViews = {\n  views: [],\n  activeViewId: null,\n\n  async load() {\n    // Only load saved views if user is authenticated\n    if (!HubState.token) {\n      console.log('Skipping saved views load - not authenticated');\n      return;\n    }\n    try {\n      const result = await HubAPI.get('/hub/api/saved-views');\n      this.views = result.views || [];\n      this.render();\n    } catch (e) {\n      // Silently fail for saved views - not critical for app functionality\n      console.warn('Failed to load saved views:', e.message);\n      this.views = [];\n    }\n  },\n\n  render() {\n    const section = document.getElementById('savedViewsSection');\n    const list = document.getElementById('savedViewsList');\n    \n    if (!section || !list) return;\n\n    if (this.views.length === 0) {\n      section.style.display = 'none';\n      return;\n    }\n\n    section.style.display = 'flex';\n    \n    list.innerHTML = this.views.map(view => {\n      const isActive = this.activeViewId === view.id;\n      const isGlobal = view.is_global;\n      const isOwn = view.is_own;\n      \n      return `\n        <button class=\"saved-view-btn ${isActive ? 'active' : ''} ${isGlobal ? 'global' : ''}\" \n                onclick=\"HubSavedViews.apply(${view.id})\"\n                title=\"${isGlobal ? 'Shared view (visible to all)' : 'Personal view'}\">\n          <span>${this.escapeHtml(view.name)}</span>\n          ${isOwn || HubAuth.isAdmin() ? `\n            <svg class=\"view-delete\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" \n                 onclick=\"event.stopPropagation(); HubSavedViews.delete(${view.id})\">\n              <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"/>\n            </svg>\n          ` : ''}\n        </button>\n      `;\n    }).join('');\n  },\n\n  async apply(viewId) {\n    const view = this.views.find(v => v.id === viewId);\n    if (!view) return;\n\n    // Set active view\n    this.activeViewId = viewId;\n    \n    // Apply filters\n    HubFilters.setFilters(view.filters);\n    \n    // Navigate to case type if specified\n    if (view.filters.type && view.filters.type !== 'all') {\n      HubNavigation.goto('cases', view.filters.type);\n    } else {\n      HubFilters.applyFilters();\n    }\n\n    // Track usage\n    try {\n      await HubAPI.post(`/hub/api/saved-views/${viewId}/use`);\n    } catch (e) { /* ignore */ }\n\n    // Re-render to show active state\n    this.render();\n  },\n\n  clearActive() {\n    this.activeViewId = null;\n    this.render();\n  },\n\n  showSaveModal() {\n    const filters = HubFilters.getCurrentFilters();\n    const isAdmin = HubAuth.isAdmin();\n\n    // Build filter preview\n    const filterTags = [];\n    if (filters.status) filterTags.push(`<span class=\"filter-tag\"><span class=\"filter-tag-label\">Status:</span> ${filters.status}</span>`);\n    if (filters.assignee) filterTags.push(`<span class=\"filter-tag\"><span class=\"filter-tag-label\">Assignee:</span> ${filters.assignee}</span>`);\n    if (filters.dateRange) {\n      let dateLabel = filters.dateRange;\n      if (filters.dateRange === 'custom' && filters.dateFrom && filters.dateTo) {\n        dateLabel = `${filters.dateFrom} to ${filters.dateTo}`;\n      }\n      filterTags.push(`<span class=\"filter-tag\"><span class=\"filter-tag-label\">Date:</span> ${dateLabel}</span>`);\n    }\n    if (filters.sortBy) filterTags.push(`<span class=\"filter-tag\"><span class=\"filter-tag-label\">Sort:</span> ${filters.sortBy.replace('_', ' ')}</span>`);\n    if (filters.type && filters.type !== 'all') filterTags.push(`<span class=\"filter-tag\"><span class=\"filter-tag-label\">Type:</span> ${filters.type}</span>`);\n\n    const html = `\n      <div class=\"modal-overlay active\" id=\"saveViewModal\">\n        <div class=\"modal save-view-modal\">\n          <div class=\"modal-header\">\n            <div class=\"modal-title\">Save Current Filters as View</div>\n            <button class=\"modal-close\" onclick=\"document.getElementById('saveViewModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\">\n            <div class=\"save-view-form\">\n              <input type=\"text\" id=\"viewNameInput\" class=\"save-view-input\" placeholder=\"Enter view name (e.g., Urgent Refunds, My Pending Cases)\" autofocus>\n              \n              <div class=\"save-view-preview\">\n                <div class=\"save-view-preview-title\">Filters to Save</div>\n                <div class=\"save-view-preview-filters\">\n                  ${filterTags.length > 0 ? filterTags.join('') : '<span class=\"filter-tag\">No filters applied</span>'}\n                </div>\n              </div>\n              \n              ${isAdmin ? `\n                <div class=\"save-view-global\">\n                  <input type=\"checkbox\" id=\"viewGlobalCheck\">\n                  <div class=\"save-view-global-text\">\n                    <div class=\"save-view-global-title\">Share with all users</div>\n                    <div class=\"save-view-global-desc\">Make this view available to everyone on the team</div>\n                  </div>\n                </div>\n              ` : ''}\n              \n              <div class=\"save-view-actions\">\n                <button class=\"btn btn-secondary\" onclick=\"document.getElementById('saveViewModal').remove()\">Cancel</button>\n                <button class=\"btn btn-primary\" onclick=\"HubSavedViews.save()\">Save View</button>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n    \n    document.body.insertAdjacentHTML('beforeend', html);\n    document.getElementById('viewNameInput').focus();\n  },\n\n  async save() {\n    const nameInput = document.getElementById('viewNameInput');\n    const name = nameInput?.value.trim();\n    \n    if (!name) {\n      HubUI.showToast('Please enter a view name', 'error');\n      return;\n    }\n\n    const filters = HubFilters.getCurrentFilters();\n    const isGlobal = document.getElementById('viewGlobalCheck')?.checked || false;\n\n    try {\n      const result = await HubAPI.post('/hub/api/saved-views', {\n        name,\n        filters,\n        is_global: isGlobal\n      });\n\n      if (result.success) {\n        HubUI.showToast(`View \"${name}\" saved successfully`, 'success');\n        document.getElementById('saveViewModal')?.remove();\n        \n        // Reload views\n        await this.load();\n        this.activeViewId = result.view?.id;\n        this.render();\n      } else {\n        HubUI.showToast(result.error || 'Failed to save view', 'error');\n      }\n    } catch (e) {\n      console.error('Failed to save view:', e);\n      HubUI.showToast('Failed to save view', 'error');\n    }\n  },\n\n  async delete(viewId) {\n    // Find the view to show its name\n    const view = this.views.find(v => v.id === viewId);\n    const viewName = view ? view.name : 'this view';\n    \n    // Show custom confirmation modal\n    this.showDeleteConfirmation(viewId, viewName);\n  },\n\n  showDeleteConfirmation(viewId, viewName) {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"deleteViewModal\">\n        <div class=\"modal delete-confirm-modal\">\n          <div class=\"modal-header delete-modal-header\">\n            <svg width=\"48\" height=\"48\" viewBox=\"0 0 24 24\" fill=\"none\" class=\"delete-modal-icon\">\n              <circle cx=\"12\" cy=\"12\" r=\"10\" stroke=\"var(--color-momo)\" stroke-width=\"2\" fill=\"var(--color-momo-light, rgba(255, 182, 193, 0.2))\"/>\n              <path d=\"M12 8v4m0 4h.01\" stroke=\"var(--color-momo)\" stroke-width=\"2\" stroke-linecap=\"round\"/>\n            </svg>\n            <div class=\"modal-title\">Delete Saved View</div>\n          </div>\n          <div class=\"modal-body delete-modal-body\">\n            <p>Are you sure you want to delete <strong>\"${this.escapeHtml(viewName)}\"</strong>?</p>\n            <p class=\"delete-modal-subtext\">This action cannot be undone.</p>\n          </div>\n          <div class=\"modal-footer delete-modal-footer\">\n            <button class=\"btn btn-secondary\" onclick=\"document.getElementById('deleteViewModal').remove()\">\n              Cancel\n            </button>\n            <button class=\"btn btn-danger\" onclick=\"HubSavedViews.confirmDelete(${viewId})\">\n              <svg width=\"16\" height=\"16\" viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\">\n                <path d=\"M3 6h18M8 6V4a2 2 0 012-2h4a2 2 0 012 2v2m3 0v14a2 2 0 01-2 2H7a2 2 0 01-2-2V6h14zM10 11v6M14 11v6\"/>\n              </svg>\n              Delete View\n            </button>\n          </div>\n        </div>\n      </div>\n    `;\n    \n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async confirmDelete(viewId) {\n    // Remove the modal\n    const modal = document.getElementById('deleteViewModal');\n    if (modal) modal.remove();\n\n    try {\n      const result = await HubAPI.delete(`/hub/api/saved-views/${viewId}`);\n      \n      if (result.success) {\n        HubUI.showToast('View deleted', 'success');\n        this.views = this.views.filter(v => v.id !== viewId);\n        if (this.activeViewId === viewId) this.activeViewId = null;\n        this.render();\n      } else {\n        HubUI.showToast(result.error || 'Failed to delete view', 'error');\n      }\n    } catch (e) {\n      console.error('Failed to delete view:', e);\n      HubUI.showToast('Failed to delete view', 'error');\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\nconst HubCases = {\n  // Cache for formatted case details (to avoid repeated API calls)\n  _formattedDetailsCache: new Map(),\n\n  // Helper function to get formatted case details from OpenAI\n  async getFormattedDetails(caseData) {\n    if (!caseData || !caseData.case_id) {\n      console.warn('getFormattedDetails: Missing caseData or case_id');\n      return { issueReason: null, resolution: null };\n    }\n\n    // Check cache first\n    const cacheKey = caseData.case_id;\n    if (this._formattedDetailsCache.has(cacheKey)) {\n      console.log('getFormattedDetails: Using cached result for case', caseData.case_id);\n      return this._formattedDetailsCache.get(cacheKey);\n    }\n\n    console.log('ðŸ” OpenAI: Fetching formatted details for case', caseData.case_id);\n    console.log('ðŸ“¦ OpenAI: Case data being sent:', {\n      case_id: caseData.case_id,\n      case_type: caseData.case_type,\n      resolution: caseData.resolution,\n      extra_data: caseData.extra_data,\n      actionType: caseData.actionType || (caseData.extra_data?.actionType),\n      newFrequency: caseData.newFrequency || (caseData.extra_data?.newFrequency),\n      previousFrequency: caseData.previousFrequency || (caseData.extra_data?.previousFrequency),\n      notes: caseData.notes || (caseData.extra_data?.notes),\n    });\n\n    try {\n      const response = await fetch('/hub/api/format-case-details', {\n        method: 'POST',\n        headers: {\n          'Content-Type': 'application/json',\n        },\n        body: JSON.stringify(caseData),\n      });\n\n      if (!response.ok) {\n        const errorText = await response.text();\n        console.error('âŒ OpenAI API response not OK:', response.status, errorText);\n        throw new Error(`Failed to format case details: ${response.status}`);\n      }\n\n      const result = await response.json();\n      console.log('âœ… OpenAI: Received response:', result);\n      \n      if (result.success) {\n        const formatted = {\n          issueReason: result.issueReason || null,\n          resolution: result.resolution || null\n        };\n        console.log('âœ… OpenAI: Formatted details:', formatted);\n        // Cache the result\n        this._formattedDetailsCache.set(cacheKey, formatted);\n        return formatted;\n      } else {\n        console.warn('âš ï¸ OpenAI: Formatting failed, result:', result);\n        throw new Error('Formatting failed');\n      }\n    } catch (error) {\n      console.error('âŒ Error formatting case details:', error);\n      // Return fallback values\n      return { issueReason: null, resolution: null };\n    }\n  },\n\n  // Pre-fetch formatted details for multiple cases (in batches)\n  async preFetchFormattedDetails(cases) {\n    if (!cases || cases.length === 0) return;\n\n    // Process in batches of 5 to avoid overwhelming the API\n    const batchSize = 5;\n    for (let i = 0; i < cases.length; i += batchSize) {\n      const batch = cases.slice(i, i + batchSize);\n      const promises = batch.map(async (c) => {\n        try {\n          const formatted = await this.getFormattedDetails(c);\n          // Store on case object for synchronous access\n          c._formattedIssueReason = formatted.issueReason;\n          c._formattedResolution = formatted.resolution;\n        } catch (e) {\n          console.error(`Failed to format case ${c.case_id}:`, e);\n        }\n      });\n      await Promise.all(promises);\n      \n      // Re-render after each batch to show updated data\n      if (i + batchSize < cases.length) {\n        this.renderCasesList();\n      }\n    }\n    \n    // Final render after all batches\n    this.renderCasesList();\n  },\n\n  async loadCases(page = 1) {\n    HubUI.showLoading();\n\n    try {\n      let url = `/hub/api/cases?page=${page}&limit=${HubConfig.ITEMS_PER_PAGE}`;\n\n      if (HubState.currentFilter && HubState.currentFilter !== 'all') {\n        url += `&type=${HubState.currentFilter}`;\n      }\n      if (HubState.currentStatus) {\n        url += `&status=${HubState.currentStatus}`;\n      }\n      if (HubState.currentAssignee) {\n        url += `&assignee=${encodeURIComponent(HubState.currentAssignee)}`;\n      }\n      if (HubState.currentDateRange) {\n        url += `&dateRange=${HubState.currentDateRange}`;\n      }\n      if (HubState.currentSortBy) {\n        const [field, order] = HubState.currentSortBy.split('_');\n        url += `&sortBy=${field}&sortOrder=${order}`;\n      }\n      if (HubState.currentSearch) {\n        url += `&search=${encodeURIComponent(HubState.currentSearch)}`;\n      }\n\n      const result = await HubAPI.get(url);\n      HubState.cases = result.cases || [];\n      HubState.casesPage = page;\n      HubState.totalPages = result.totalPages || 1;\n      HubState.totalCases = result.total || HubState.cases.length; // Store total for result count\n\n      // Update navigation counts if provided\n      if (result.counts) {\n        this.updateNavigationCounts(result.counts);\n      }\n\n      // Load assignees for filter dropdown\n      if (result.assignees) {\n        this.updateAssigneeFilter(result.assignees);\n      }\n\n      // Pre-fetch formatted details for all cases (in background, don't block rendering)\n      this.preFetchFormattedDetails(HubState.cases);\n\n      this.renderCasesList();\n    } catch (e) {\n      console.error('Failed to load cases:', e);\n      HubUI.showToast('Failed to load cases', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  updateAssigneeFilter(assignees) {\n    // Update both header and inline assignee filters\n    const filters = [\n      document.getElementById('assigneeFilter'),\n      document.getElementById('casesAssigneeFilter')\n    ].filter(Boolean);\n\n    const uniqueAssignees = [...new Set(assignees.filter(a => a && a !== 'Unassigned'))];\n\n    filters.forEach(assigneeFilter => {\n      // Keep \"All Assignees\" and \"Unassigned\" options\n      const currentValue = assigneeFilter.value;\n      assigneeFilter.innerHTML = '<option value=\"\">All Assignees</option><option value=\"unassigned\">Unassigned</option>';\n      \n      // Add unique assignees\n      uniqueAssignees.forEach(assignee => {\n        const option = document.createElement('option');\n        option.value = assignee;\n        option.textContent = assignee;\n        assigneeFilter.appendChild(option);\n      });\n\n      // Restore selection\n      if (currentValue) {\n        assigneeFilter.value = currentValue;\n      }\n    });\n  },\n\n  renderCasesList() {\n    const container = document.getElementById('casesTableBody');\n    if (!container) return;\n\n    // Update result count\n    const resultCount = document.getElementById('casesResultCount');\n    if (resultCount) {\n      const total = HubState.totalCases || HubState.cases.length;\n      resultCount.textContent = `${total} case${total !== 1 ? 's' : ''} found`;\n    }\n\n    if (HubState.cases.length === 0) {\n      container.innerHTML = `\n        <tr>\n          <td colspan=\"8\" class=\"empty-state\">\n            <div style=\"padding: 40px; text-align: center;\">\n              <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"48\" height=\"48\" style=\"color: var(--gray-300); margin-bottom: 16px;\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2\"></path></svg>\n              <h3 style=\"color: var(--gray-700); margin-bottom: 8px;\">No cases found</h3>\n              <p style=\"color: var(--gray-500); font-size: 14px;\">Try adjusting your filters or search query</p>\n            </div>\n          </td>\n        </tr>\n      `;\n      return;\n    }\n\n    container.innerHTML = HubState.cases.map((c, idx) => {\n      // Calculate due date (24 hours from creation)\n      const createdDate = new Date(c.created_at);\n      const dueDate = new Date(createdDate.getTime() + (24 * 60 * 60 * 1000));\n      const now = new Date();\n      const isOverdue = now > dueDate && c.status !== 'completed';\n      const hoursLeft = Math.max(0, Math.round((dueDate - now) / (1000 * 60 * 60)));\n      const dueClass = isOverdue ? 'overdue' : hoursLeft < 8 ? 'warning' : 'ok';\n      \n      // Format resolution text - use pre-fetched formatted resolution if available\n      const resolutionText = c._formattedResolution || this.formatResolutionSync(c) || 'Pending Review';\n      const statusClass = c.status ? c.status.replace('_', '-') : 'pending';\n      \n      return `\n      <tr onclick=\"HubCases.openCase('${c.case_id}')\" data-case-id=\"${c.case_id}\">\n        <td>\n          <input type=\"checkbox\" class=\"case-checkbox\" data-case-id=\"${c.case_id}\"\n                 onclick=\"event.stopPropagation(); HubBulkActions.toggleSelect('${c.case_id}')\"\n                 ${HubState.selectedCaseIds.has(c.case_id) ? 'checked' : ''}>\n        </td>\n        <td class=\"td-customer\">\n          <div class=\"td-customer-name\">${HubHelpers.formatName(c.customer_name)}</div>\n          <div class=\"td-customer-email\">${this.escapeHtml(c.customer_email || '-')}</div>\n        </td>\n        <td><span class=\"type-badge ${c.case_type}\">${c.case_type}</span></td>\n        <td><span class=\"status-badge ${statusClass}\">${this.formatStatus(c.status)}</span></td>\n        <td class=\"td-due ${dueClass}\">\n          ${isOverdue ? 'Overdue' : hoursLeft + 'h left'}\n        </td>\n        <td class=\"td-resolution\">${this.escapeHtml(resolutionText)}</td>\n        <td class=\"td-assignee\">${HubUsers.renderAssigneeCell(c.case_id, c.assigned_to)}</td>\n        <td class=\"td-created\">${this.timeAgo(c.created_at)}</td>\n      </tr>\n    `;\n    }).join('');\n\n    this.renderPagination();\n  },\n\n  updateNavigationCounts(counts) {\n    const badgeMap = {\n      'all': 'allCasesCount',\n      'shipping': 'shippingCount',\n      'refund': 'refundsCount',\n      'return': 'returnsCount',\n      'subscription': 'subscriptionsCount',\n      'manual': 'manualCount'\n    };\n\n    Object.keys(badgeMap).forEach(key => {\n      const badgeId = badgeMap[key];\n      const badge = document.getElementById(badgeId);\n      if (badge) {\n        badge.textContent = counts[key] || 0;\n      }\n    });\n  },\n\n  renderPagination() {\n    const container = document.getElementById('casesPagination');\n    if (!container) return;\n\n    const totalPages = HubState.totalPages;\n    const currentPage = HubState.casesPage;\n    \n    if (totalPages <= 1) {\n      container.innerHTML = '';\n      return;\n    }\n\n    let html = '<div class=\"pagination\">';\n    \n    // Previous button\n    html += `<button class=\"pagination-btn\" onclick=\"HubCases.loadCases(${currentPage - 1})\" ${currentPage <= 1 ? 'disabled' : ''}>\n      <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\"/></svg>\n    </button>`;\n    \n    // Page numbers\n    const maxVisible = 5;\n    let startPage = Math.max(1, currentPage - Math.floor(maxVisible / 2));\n    let endPage = Math.min(totalPages, startPage + maxVisible - 1);\n    \n    if (endPage - startPage < maxVisible - 1) {\n      startPage = Math.max(1, endPage - maxVisible + 1);\n    }\n\n    if (startPage > 1) {\n      html += `<button class=\"pagination-btn\" onclick=\"HubCases.loadCases(1)\">1</button>`;\n      if (startPage > 2) html += `<span class=\"pagination-info\">...</span>`;\n    }\n\n    for (let i = startPage; i <= endPage; i++) {\n      html += `<button class=\"pagination-btn ${i === currentPage ? 'active' : ''}\" onclick=\"HubCases.loadCases(${i})\">${i}</button>`;\n    }\n\n    if (endPage < totalPages) {\n      if (endPage < totalPages - 1) html += `<span class=\"pagination-info\">...</span>`;\n      html += `<button class=\"pagination-btn\" onclick=\"HubCases.loadCases(${totalPages})\">${totalPages}</button>`;\n    }\n    \n    // Next button\n    html += `<button class=\"pagination-btn\" onclick=\"HubCases.loadCases(${currentPage + 1})\" ${currentPage >= totalPages ? 'disabled' : ''}>\n      <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\"/></svg>\n    </button>`;\n    \n    html += '</div>';\n\n    container.innerHTML = html;\n  },\n\n  async openCase(caseId) {\n    // Navigate to full-page case detail view\n        HubState.currentCaseIndex = HubState.cases.findIndex(c => c.case_id === caseId);\n    HubNavigation.goto('case-detail', caseId);\n  },\n\n  async updateStatus(status) {\n    if (!HubState.currentCase) return;\n\n    // If completing, show checklist first\n    if (status === 'completed') {\n      const result = await HubChecklist.showForCase(HubState.currentCase.case_id);\n      if (!result.canComplete) return;\n    }\n\n    try {\n      const result = await HubAPI.put(`/hub/api/case/${HubState.currentCase.case_id}/status`, { status });\n\n      if (result.success) {\n        HubState.currentCase.status = status;\n        HubUI.updateCaseModalStatus(status);\n        HubUI.showToast(`Status updated to ${status}`, 'success');\n\n        // Refresh cases list\n        this.loadCases(HubState.casesPage);\n      } else {\n        HubUI.showToast(result.error, 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to update status', 'error');\n    }\n  },\n\n  navigateCase(direction) {\n    const newIndex = direction === 'prev'\n      ? HubState.currentCaseIndex - 1\n      : HubState.currentCaseIndex + 1;\n\n    if (newIndex >= 0 && newIndex < HubState.cases.length) {\n      this.openCase(HubState.cases[newIndex].case_id);\n    }\n  },\n\n  setStatusFilter(status) {\n    HubState.currentStatus = status;\n    this.loadCases(1);\n  },\n\n  openShopifyOrder() {\n    if (HubState.currentCase?.order_url) {\n      window.open(HubState.currentCase.order_url, '_blank');\n    }\n  },\n\n  formatStatus(status) {\n    return status.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n  },\n\n  timeAgo(timestamp) {\n    const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);\n\n    if (seconds < 60) return 'Just now';\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\n    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;\n\n    return new Date(timestamp).toLocaleDateString();\n  },\n\n  formatDueDate(dueDate) {\n    const now = new Date();\n    const diffMs = dueDate - now;\n    const diffHours = Math.floor(diffMs / (1000 * 60 * 60));\n    \n    if (diffHours < 0) return 'Overdue';\n    if (diffHours < 24) return `${diffHours}h left`;\n    const diffDays = Math.floor(diffHours / 24);\n    return `${diffDays}d left`;\n  },\n\n  // Synchronous fallback formatting (used when OpenAI data not yet available)\n  formatResolutionSync(caseData) {\n    if (!caseData || !caseData.resolution) return null;\n    \n    const resolution = caseData.resolution;\n    const resolutionMap = {\n      'full_refund': 'Process full refund',\n      'partial_20': 'Process 20% partial refund',\n      'partial_30': 'Process 30% partial refund',\n      'partial_50': 'Process 50% partial refund',\n      'reship_missing_item': 'Reship missing item',\n      'reship_missing_item_bonus': 'Reship missing item with bonus',\n      'subscription_paused': 'Subscription paused',\n      'subscription_cancelled': 'Subscription cancelled',\n      'subscription_updated': 'Subscription updated',\n      'discount_applied': 'Discount applied',\n      'manual_assistance': 'Manual assistance required'\n    };\n    \n    const partialMatch = resolution.match(/^partial_(\\d+)$/);\n    if (partialMatch) {\n      return `Process ${partialMatch[1]}% partial refund`;\n    }\n    \n    const partialReshipMatch = resolution.match(/^partial_(\\d+)_reship$/);\n    if (partialReshipMatch) {\n      return `Process ${partialReshipMatch[1]}% refund + reship`;\n    }\n    \n    return resolutionMap[resolution] || resolution.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n  },\n\n  // Async version for getting formatted resolution (used when needed immediately)\n  async formatResolution(caseData) {\n    if (!caseData || !caseData.resolution) return null;\n    \n    // Get formatted details from OpenAI (with caching)\n    const formatted = await this.getFormattedDetails(caseData);\n    \n    // Return OpenAI-generated resolution if available, otherwise fallback\n    if (formatted.resolution) {\n      return formatted.resolution;\n    }\n    \n    // Fallback to basic formatting if OpenAI fails\n    return this.formatResolutionSync(caseData);\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// NAVIGATION\n// ============================================\nconst HubNavigation = {\n  goto(page, filter = null) {\n    HubState.currentPage = page;\n    HubState.currentFilter = filter || null;\n\n    // Update nav items\n    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));\n    const selector = filter\n      ? `.nav-item[data-page=\"${page}\"][data-filter=\"${filter}\"]`\n      : `.nav-item[data-page=\"${page}\"]`;\n    document.querySelector(selector)?.classList.add('active');\n\n    // Update page title dynamically based on page and filter\n    const pageTitle = this.getPageTitle(page, filter);\n    const pageTitleEl = document.getElementById('pageTitle');\n    if (pageTitleEl) {\n      pageTitleEl.textContent = pageTitle;\n    }\n\n    // Update search placeholder and filter UI based on current page\n    if (HubSearch.updatePlaceholder) {\n      HubSearch.updatePlaceholder();\n    }\n\n    // Update URL with slug\n    this.updateURL(page, filter);\n\n    // Show/hide views - map page names to view IDs\n    const viewMap = {\n      'dashboard': 'dashboardView',\n      'cases': 'casesView',\n      'sessions': 'sessionsView',\n      'events': 'eventsView',\n      'issues': 'issuesView',\n      'duplicates': 'duplicatesView',\n      'self-resolved': 'selfResolvedView',\n      'analytics': 'analyticsView',\n      'audit': 'auditView',\n      'users': 'usersView',\n      'sop': 'sopView',\n      'email-templates': 'emailTemplatesView',\n      'case-detail': 'caseDetailView',\n      'profile': 'profileView'\n    };\n    \n    Object.entries(viewMap).forEach(([pageName, viewId]) => {\n      const el = document.getElementById(viewId);\n      if (el) el.style.display = pageName === page ? 'block' : 'none';\n    });\n\n    // Load data when switching to self-resolved page\n    if (page === 'self-resolved' && typeof HubSelfResolved !== 'undefined' && HubSelfResolved.loadCases) {\n      HubSelfResolved.loadCases();\n    }\n\n    // Hide header filters on pages that have their own filters or don't need them\n    const headerFilters = document.getElementById('headerFilters');\n    if (headerFilters) {\n      // Show header filters only on dashboard, hide on cases (uses inline filters) and other pages\n      const pagesWithHeaderFilters = ['dashboard'];\n      headerFilters.style.display = pagesWithHeaderFilters.includes(page) ? 'flex' : 'none';\n    }\n\n    // Load data\n    if (page === 'cases') {\n      HubState.currentFilter = filter || 'all';\n      HubCases.loadCases();\n      // Also load stats to update sidebar progress\n      HubDashboard.loadStats();\n    } else if (page === 'dashboard') {\n      HubDashboard.load();\n    } else if (page === 'sessions') {\n      HubSessions.load();\n    } else if (page === 'events') {\n      HubEvents.load();\n    } else if (page === 'issues') {\n      HubIssues.load();\n    } else if (page === 'duplicates') {\n      HubDuplicates.load();\n    } else if (page === 'analytics') {\n      HubAnalytics.load();\n    } else if (page === 'audit') {\n      HubEnhancedAuditLog.show();\n    } else if (page === 'users') {\n      HubUsers.show();\n    } else if (page === 'sop') {\n      HubSOP.load();\n    } else if (page === 'email-templates') {\n      HubEmailTemplates.load();\n    } else if (page === 'case-detail') {\n      // filter here is actually the caseId\n      HubCaseDetail.load(filter);\n    } else if (page === 'profile') {\n      HubProfile.load();\n    }\n  },\n\n  getPageTitle(page, filter) {\n    // Base titles\n    const baseTitles = {\n      dashboard: 'Dashboard',\n      cases: 'Cases',\n      sessions: 'Sessions',\n      events: 'Event Log',\n      issues: 'Issue Reports',\n      duplicates: 'Duplicates',\n      'self-resolved': 'Self-Resolved',\n      analytics: 'Performance',\n      audit: 'Audit Log',\n      users: 'User Management',\n      flows: 'Flow Documentation',\n      sop: 'SOP Links',\n      'email-templates': 'Email Templates',\n      'case-detail': 'Case Details',\n      'profile': 'Profile Settings'\n    };\n\n    // If cases page with filter, show filter name\n    if (page === 'cases' && filter && filter !== 'all') {\n      const filterTitles = {\n        shipping: 'Shipping',\n        refund: 'Refunds',\n        return: 'Returns',\n        subscription: 'Subscriptions',\n        manual: 'Manual Review'\n      };\n      return filterTitles[filter] || baseTitles[page];\n    }\n\n    return baseTitles[page] || 'Dashboard';\n  },\n\n  // Simple URL update - just update the browser URL without complex state management\n  updateURL(page, filter) {\n    let path = '/hub';\n    \n    if (page === 'dashboard') {\n      path = '/hub';\n    } else if (page === 'cases') {\n      path = filter && filter !== 'all' ? `/hub/cases/${filter}` : '/hub/cases';\n    } else if (page === 'sessions') {\n      path = '/hub/sessions';\n    } else if (page === 'events') {\n      path = '/hub/events';\n    } else if (page === 'issues') {\n      path = '/hub/issues';\n    } else if (page === 'duplicates') {\n      path = '/hub/duplicates';\n    } else if (page === 'self-resolved') {\n      path = '/hub/self-resolved';\n    } else if (page === 'analytics') {\n      path = '/hub/analytics';\n    } else if (page === 'audit') {\n      path = '/hub/audit';\n    } else if (page === 'users') {\n      path = '/hub/users';\n    } else if (page === 'sop') {\n      path = '/hub/sop';\n    } else if (page === 'email-templates') {\n      path = '/hub/email-templates';\n    } else if (page === 'case-detail') {\n      path = `/hub/case/${filter}`;\n    }\n\n    // Update URL without reload\n    if (window.history && window.history.pushState) {\n      window.history.pushState({ page, filter }, '', path);\n    }\n  }\n};\n\n// ============================================\n// SESSIONS\n// ============================================\nconst HubSessions = {\n  async load(page = 1) {\n    HubUI.showLoading();\n    try {\n      const result = await HubAPI.get(`/hub/api/sessions?page=${page}&limit=${HubConfig.ITEMS_PER_PAGE}`);\n      this.renderSessionsList(result.sessions || []);\n      this.renderPagination(result.total || 0, result.sessions?.length || 0, page, HubConfig.ITEMS_PER_PAGE);\n    } catch (e) {\n      console.error('Failed to load sessions:', e);\n      HubUI.showToast('Failed to load sessions', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  renderSessionsList(sessions) {\n    const container = document.getElementById('sessionsTableBody');\n    if (!container) return;\n\n    if (sessions.length === 0) {\n      container.innerHTML = `<tr><td colspan=\"6\" class=\"empty-state\">No sessions found</td></tr>`;\n      return;\n    }\n\n    container.innerHTML = sessions.map(s => {\n      const startedAt = s.started_at || s.created_at;\n      const customerName = s.customer_name || s.customer_email || 'Anonymous';\n      const orderNumber = s.order_number || 'N/A';\n      const flowType = s.flow_type || 'N/A';\n      const completed = s.ended_at ? true : false;\n      const recordingUrl = s.session_replay_url || null;\n      \n      // Recording button with play icon\n      const recordingBtn = recordingUrl \n        ? `<a href=\"${recordingUrl}\" target=\"_blank\" class=\"btn-recording\">\n            <svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M8 5v14l11-7z\"/></svg>\n            Watch\n           </a>`\n        : `<span class=\"btn-recording-disabled\">\n            <svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M8 5v14l11-7z\"/></svg>\n            No Recording\n           </span>`;\n\n      return `\n        <tr>\n          <td>${this.formatDate(startedAt)}</td>\n          <td>\n            <div class=\"customer-info\">\n              <span class=\"customer-name\">${this.escapeHtml(customerName)}</span>\n              ${s.customer_email ? `<span class=\"customer-email\">${this.escapeHtml(s.customer_email)}</span>` : ''}\n            </div>\n          </td>\n          <td>${this.escapeHtml(orderNumber)}</td>\n          <td><span class=\"type-badge\">${this.escapeHtml(flowType)}</span></td>\n          <td><span class=\"status-badge ${completed ? 'completed' : 'in-progress'}\">${completed ? 'Completed' : 'In Progress'}</span></td>\n          <td>${recordingBtn}</td>\n        </tr>\n      `;\n    }).join('');\n  },\n\n  renderPagination(total, currentCount, currentPage, limit) {\n    const container = document.getElementById('sessionsPagination');\n    if (!container) return;\n\n    const totalPages = Math.ceil(total / limit);\n    if (totalPages <= 1) {\n      container.innerHTML = '';\n      return;\n    }\n\n    let html = '';\n    if (currentPage > 1) {\n      html += `<button onclick=\"HubSessions.load(${currentPage - 1})\">Previous</button>`;\n    }\n    html += `<span>Page ${currentPage} of ${totalPages}</span>`;\n    if (currentPage < totalPages) {\n      html += `<button onclick=\"HubSessions.load(${currentPage + 1})\">Next</button>`;\n    }\n    container.innerHTML = html;\n  },\n\n  formatDate(timestamp) {\n    if (!timestamp) return '-';\n    try {\n      return new Date(timestamp).toLocaleString('en-US', {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric',\n        hour: '2-digit',\n        minute: '2-digit'\n      });\n    } catch {\n      return '-';\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// EVENTS\n// ============================================\nconst HubEvents = {\n  async load(page = 1) {\n    HubUI.showLoading();\n    try {\n      const result = await HubAPI.get(`/hub/api/events?page=${page}&limit=${HubConfig.ITEMS_PER_PAGE}&offset=${(page - 1) * HubConfig.ITEMS_PER_PAGE}`);\n      this.renderEventsList(result.events || []);\n      this.renderPagination(result.total || 0, result.events?.length || 0, page, HubConfig.ITEMS_PER_PAGE);\n    } catch (e) {\n      console.error('Failed to load events:', e);\n      HubUI.showToast('Failed to load events', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  renderEventsList(events) {\n    const container = document.getElementById('eventsTableBody');\n    if (!container) return;\n\n    if (events.length === 0) {\n      container.innerHTML = `<tr><td colspan=\"6\" class=\"empty-state\">No events found</td></tr>`;\n      return;\n    }\n\n    container.innerHTML = events.map(e => {\n      const eventData = e.event_data ? (typeof e.event_data === 'string' ? e.event_data : JSON.stringify(e.event_data)) : '{}';\n      const truncatedData = eventData.length > 50 ? eventData.substring(0, 50) + '...' : eventData;\n      \n      // Determine actor - if from chat app show \"Customer\", otherwise show the actor name\n      const isHubEvent = e.actor || e.actor_email || (e.event_type === 'Status_change') || (e.event_type === 'Assignment');\n      const actorDisplay = this.renderActor(e);\n      \n      return `\n        <tr>\n          <td><code style=\"font-size: 12px; color: var(--gray-600);\">${this.escapeHtml((e.session_id || '').substring(0, 12))}...</code></td>\n          <td>${actorDisplay}</td>\n          <td><span class=\"type-badge\">${this.escapeHtml(e.event_type || 'N/A')}</span></td>\n          <td>${this.escapeHtml(e.event_name || 'N/A')}</td>\n          <td><code style=\"font-size: 11px; color: var(--gray-500); max-width: 180px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">${this.escapeHtml(truncatedData)}</code></td>\n          <td class=\"time-ago\">${this.formatDate(e.created_at)}</td>\n        </tr>\n      `;\n    }).join('');\n  },\n\n  renderActor(event) {\n    // Check if this is a hub-originated event (has actor info or is a status change type)\n    const isHubAction = event.actor || event.actor_email || \n                        ['Status_change', 'Assignment', 'Comment', 'status_change', 'assignment'].includes(event.event_type);\n    \n    if (isHubAction && (event.actor || event.actor_email)) {\n      // Hub team member action\n      const name = event.actor || event.actor_email?.split('@')[0] || 'Team';\n      const initials = name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();\n      return `\n        <div class=\"actor-badge actor-team\" title=\"${this.escapeHtml(event.actor_email || name)}\">\n          <span class=\"actor-avatar\">${initials}</span>\n          <span class=\"actor-name\">${this.escapeHtml(name.split(' ')[0])}</span>\n        </div>\n      `;\n    } else {\n      // Customer action from chat app\n      return `\n        <div class=\"actor-badge actor-customer\">\n          <svg class=\"actor-icon\" fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"14\" height=\"14\">\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\"/>\n          </svg>\n          <span class=\"actor-name\">Customer</span>\n        </div>\n      `;\n    }\n  },\n\n  renderPagination(total, currentCount, currentPage, limit) {\n    const container = document.getElementById('eventsPagination');\n    if (!container) return;\n\n    const totalPages = Math.ceil(total / limit);\n    if (totalPages <= 1) {\n      container.innerHTML = '';\n      return;\n    }\n\n    let html = '';\n    if (currentPage > 1) {\n      html += `<button onclick=\"HubEvents.load(${currentPage - 1})\">Previous</button>`;\n    }\n    html += `<span>Page ${currentPage} of ${totalPages}</span>`;\n    if (currentPage < totalPages) {\n      html += `<button onclick=\"HubEvents.load(${currentPage + 1})\">Next</button>`;\n    }\n    container.innerHTML = html;\n  },\n\n  formatDate(timestamp) {\n    if (!timestamp) return '-';\n    try {\n      return new Date(timestamp).toLocaleString('en-US', {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric',\n        hour: '2-digit',\n        minute: '2-digit'\n      });\n    } catch {\n      return '-';\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// ISSUES (ISSUE REPORTS - renamed from trouble_reports)\n// ============================================\nconst HubIssues = {\n  async load(page = 1) {\n    HubUI.showLoading();\n    try {\n      let url = `/hub/api/issues?page=${page}&limit=50`;\n\n      // Add filters\n      if (HubState.issuesStatus) {\n        url += `&status=${encodeURIComponent(HubState.issuesStatus)}`;\n      }\n      if (HubState.issuesDateRange) {\n        url += `&dateRange=${encodeURIComponent(HubState.issuesDateRange)}`;\n      }\n      if (HubState.issuesSortBy) {\n        const [field, order] = HubState.issuesSortBy.split('_');\n        url += `&sortBy=${field}&sortOrder=${order}`;\n      }\n      if (HubState.issuesSearch) {\n        url += `&search=${encodeURIComponent(HubState.issuesSearch)}`;\n      }\n\n      const result = await HubAPI.get(url);\n      this.renderIssues(result.issues || []);\n      this.renderPagination(result.total || 0, result.issues?.length || 0, page, 50);\n      HubState.issuesPage = page;\n      HubState.issuesTotalPages = result.totalPages || 1;\n    } catch (e) {\n      console.error('Failed to load issues:', e);\n      HubUI.showToast('Failed to load issues', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  renderIssues(issues) {\n    const container = document.getElementById('issuesTableBody');\n    if (!container) return;\n\n    if (issues.length === 0) {\n      container.innerHTML = `\n        <tr>\n          <td colspan=\"6\" class=\"empty-state\">No issues found</td>\n        </tr>\n      `;\n      return;\n    }\n\n    container.innerHTML = issues.map(issue => {\n      const statusClass = issue.status === 'resolved' ? 'completed' : issue.status === 'in_progress' ? 'in-progress' : 'pending';\n      const recordingUrl = issue.session_replay_url || null;\n      \n      // Recording button with play icon\n      const recordingBtn = recordingUrl \n        ? `<a href=\"${recordingUrl}\" target=\"_blank\" class=\"btn-recording\" onclick=\"event.stopPropagation();\">\n            <svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M8 5v14l11-7z\"/></svg>\n            Watch\n           </a>`\n        : `<span class=\"btn-recording-disabled\">\n            <svg viewBox=\"0 0 24 24\" fill=\"currentColor\"><path d=\"M8 5v14l11-7z\"/></svg>\n            No Recording\n           </span>`;\n      \n      return `\n        <tr onclick=\"HubIssues.openIssue('${issue.report_id}')\" style=\"cursor: pointer;\">\n          <td>${this.escapeHtml(issue.report_id || '-')}</td>\n          <td>${this.escapeHtml(issue.customer_email || '-')}</td>\n          <td>${this.escapeHtml(issue.issue_type || '-')}</td>\n          <td><span class=\"status-badge ${statusClass}\">${this.formatStatus(issue.status || 'pending')}</span></td>\n          <td>${this.timeAgo(issue.created_at)}</td>\n          <td>${recordingBtn}</td>\n        </tr>\n      `;\n    }).join('');\n  },\n\n  renderPagination(total, currentCount, currentPage, limit) {\n    const container = document.getElementById('issuesPagination');\n    if (!container) return;\n\n    const totalPages = Math.ceil(total / limit);\n    if (totalPages <= 1) {\n      container.innerHTML = '';\n      return;\n    }\n\n    let html = '';\n    if (currentPage > 1) {\n      html += `<button onclick=\"HubIssues.load(${currentPage - 1})\">Previous</button>`;\n    }\n    html += `<span>Page ${currentPage} of ${totalPages}</span>`;\n    if (currentPage < totalPages) {\n      html += `<button onclick=\"HubIssues.load(${currentPage + 1})\">Next</button>`;\n    }\n    container.innerHTML = html;\n  },\n\n  applyFilters() {\n    // Get filter values from UI\n    const statusFilter = document.getElementById('issuesStatusFilter');\n    const dateRangeFilter = document.getElementById('issuesDateRangeFilter');\n    const sortByFilter = document.getElementById('issuesSortBy');\n\n    if (statusFilter) HubState.issuesStatus = statusFilter.value || '';\n    if (dateRangeFilter) HubState.issuesDateRange = dateRangeFilter.value || '';\n    if (sortByFilter) HubState.issuesSortBy = sortByFilter.value || 'created_desc';\n\n    // Reload issues\n    this.load(1);\n  },\n\n  async openIssue(reportId) {\n    try {\n      const result = await HubAPI.get(`/hub/api/issues/${reportId}`);\n      if (result.report_id) {\n        // Show issue in a modal or detail view\n        HubUI.showToast('Issue details loaded', 'info');\n        // TODO: Implement issue detail modal\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to load issue', 'error');\n    }\n  },\n\n  formatStatus(status) {\n    return status.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n  },\n\n  timeAgo(timestamp) {\n    if (!timestamp) return '-';\n    const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);\n\n    if (seconds < 60) return 'Just now';\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\n    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;\n\n    return new Date(timestamp).toLocaleDateString();\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// ANALYTICS / PERFORMANCE\n// ============================================\nconst HubAnalytics = {\n  async load() {\n    HubUI.showLoading();\n    try {\n      const result = await HubAPI.get('/hub/api/analytics');\n      \n      // Update Row 1: Cases Metrics\n      if (document.getElementById('analyticsTotalCases')) {\n        document.getElementById('analyticsTotalCases').textContent = result.totalCases || 0;\n        document.getElementById('analyticsTotalCasesSub').textContent = `${result.casesToday || 0} today`;\n      }\n      if (document.getElementById('analyticsPendingCases')) {\n        const pending = result.pendingCases || 0;\n        const stale = result.staleCases || 0;\n        document.getElementById('analyticsPendingCases').textContent = pending;\n        document.getElementById('analyticsPendingCasesSub').textContent = `${stale} overdue (24h+)`;\n      }\n      if (document.getElementById('analyticsInProgress')) {\n        document.getElementById('analyticsInProgress').textContent = result.inProgressCases || 0;\n      }\n      if (document.getElementById('analyticsCompletedCases')) {\n        const completed = result.completedCases || 0;\n        const total = result.totalCases || 0;\n        const rate = total > 0 ? Math.round((completed / total) * 100) : 0;\n        document.getElementById('analyticsCompletedCases').textContent = completed;\n        document.getElementById('analyticsCompletedSub').textContent = `${rate}% resolution rate`;\n      }\n\n      // Update Row 2: Refunds & Sessions\n      if (document.getElementById('analyticsTotalRefunds')) {\n        document.getElementById('analyticsTotalRefunds').textContent = this.formatCurrency(result.totalRefunds || 0);\n      }\n      if (document.getElementById('analyticsRefunds30d')) {\n        document.getElementById('analyticsRefunds30d').textContent = this.formatCurrency(result.refundsThisMonth || 0);\n      }\n      if (document.getElementById('analyticsAvgRefund')) {\n        document.getElementById('analyticsAvgRefund').textContent = this.formatCurrency(result.avgRefund || 0);\n      }\n      if (document.getElementById('analyticsTotalSessions')) {\n        const sessions = result.totalSessions || 0;\n        const completed = result.completedSessions || 0;\n        const rate = sessions > 0 ? Math.round((completed / sessions) * 100) : 0;\n        document.getElementById('analyticsTotalSessions').textContent = sessions;\n        document.getElementById('analyticsSessionsSub').textContent = `${rate}% completion`;\n      }\n\n      // Update Row 3: Performance Metrics\n      if (document.getElementById('analyticsAvgResolution')) {\n        const avg = result.avgResolutionHours || 0;\n        const min = result.minResolutionHours || 0;\n        const max = result.maxResolutionHours || 0;\n        document.getElementById('analyticsAvgResolution').textContent = this.formatHours(avg);\n        document.getElementById('analyticsResolutionSub').textContent = `Min: ${this.formatHours(min)} Max: ${this.formatHours(max)}`;\n      }\n      if (document.getElementById('analyticsSLACompliance')) {\n        const rate = result.slaComplianceRate || 0;\n        const compliant = result.slaCompliant || 0;\n        const breached = result.slaBreached || 0;\n        document.getElementById('analyticsSLACompliance').textContent = `${rate}%`;\n        document.getElementById('analyticsSLASub').textContent = `${compliant} met ${breached} breached (24h)`;\n      }\n      if (document.getElementById('analyticsTeamMembers')) {\n        const teamCount = new Set((result.teamPerformance || []).map(t => t.user_name)).size;\n        document.getElementById('analyticsTeamMembers').textContent = teamCount;\n      }\n      if (document.getElementById('analyticsRootCauses')) {\n        document.getElementById('analyticsRootCauses').textContent = (result.rootCauses || []).length;\n      }\n\n      // Render detailed analytics\n      console.log('Analytics data received:', result);\n      this.renderAnalytics(result);\n    } catch (e) {\n      console.error('Failed to load analytics:', e);\n      HubUI.showToast('Failed to load analytics', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  renderAnalytics(data) {\n    console.log('Rendering analytics with data:', data);\n    \n    try {\n      // Render Cases & Sessions Trend Chart\n      this.renderTrendChart(data);\n      \n      // Render Cases by Type Donut Chart\n      this.renderDonutChart(data);\n      \n      // Render Resolution Types List\n      this.renderResolutionTypes(data);\n      \n      // Render Status Distribution\n      this.renderStatusDistribution(data);\n      \n      // Render Flow Types\n      this.renderFlowTypes(data);\n      \n      // Render Team Leaderboard\n      this.renderTeamLeaderboard(data);\n      \n      // Render Root Cause Analysis\n      this.renderRootCauseAnalysis(data);\n      \n      // Render Resolution Time Distribution\n      this.renderResolutionTimeDistribution(data);\n      \n      // Apply dark text colors to colored stat cards for better readability\n      this.applyStatCardTextColors();\n    } catch (e) {\n      console.error('Error rendering analytics:', e);\n      HubUI.showToast('Error rendering analytics data', 'error');\n    }\n  },\n\n  applyStatCardTextColors() {\n    // Yellow card - Pending Cases\n    const pendingCard = document.querySelector('.stat-card.highlight[style*=\"FEF3C7\"]');\n    if (pendingCard) {\n      const label = pendingCard.querySelector('.stat-label');\n      const value = pendingCard.querySelector('.stat-value');\n      const change = pendingCard.querySelector('.stat-change');\n      if (label) label.style.color = '#78350F';\n      if (value) value.style.color = '#92400E';\n      if (change) change.style.color = '#B45309';\n    }\n\n    // Green card - Completed, SLA Compliance\n    const completedCards = document.querySelectorAll('.stat-card.highlight[style*=\"D1FAE5\"]');\n    completedCards.forEach(card => {\n      const label = card.querySelector('.stat-label');\n      const value = card.querySelector('.stat-value');\n      const change = card.querySelector('.stat-change');\n      if (label) label.style.color = '#065F46';\n      if (value) value.style.color = '#047857';\n      if (change) change.style.color = '#059669';\n    });\n\n    // Pink card - Refunds (30d)\n    const refundsCard = document.querySelector('.stat-card.highlight[style*=\"FCE7F3\"]');\n    if (refundsCard) {\n      const label = refundsCard.querySelector('.stat-label');\n      const value = refundsCard.querySelector('.stat-value');\n      const change = refundsCard.querySelector('.stat-change');\n      if (label) label.style.color = '#831843';\n      if (value) value.style.color = '#9F1239';\n      if (change) change.style.color = '#BE185D';\n    }\n\n    // Red card - Root Cause Categories\n    const rootCauseCard = document.querySelector('.stat-card.highlight[style*=\"FEE2E2\"]');\n    if (rootCauseCard) {\n      const label = rootCauseCard.querySelector('.stat-label');\n      const value = rootCauseCard.querySelector('.stat-value');\n      const change = rootCauseCard.querySelector('.stat-change');\n      if (label) label.style.color = '#991B1B';\n      if (value) value.style.color = '#B91C1C';\n      if (change) change.style.color = '#DC2626';\n    }\n  },\n\n  renderTrendChart(data) {\n    const container = document.getElementById('analyticsTrendChart');\n    if (!container) {\n      console.error('analyticsTrendChart container not found');\n      return;\n    }\n\n    const casesByDay = data.casesByDay || [];\n    const sessionsByDay = data.sessionsByDay || [];\n    console.log('Rendering trend chart - casesByDay:', casesByDay, 'sessionsByDay:', sessionsByDay);\n\n    if (casesByDay.length === 0 && sessionsByDay.length === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500); text-align: center; padding: 40px;\">No data available</p>';\n      return;\n    }\n\n    // Combine and sort by date\n    const allDates = new Set([...casesByDay.map(c => c.date), ...sessionsByDay.map(s => s.date)]);\n    const sortedDates = Array.from(allDates).sort();\n\n    const maxValue = Math.max(\n      ...casesByDay.map(c => c.count || 0),\n      ...sessionsByDay.map(s => s.count || 0),\n      1\n    );\n\n    const chartHeight = 300;\n    const chartWidth = 800;\n    const padding = 50;\n    const barWidth = (chartWidth - padding * 2) / Math.max(sortedDates.length, 1);\n\n    let svg = `<svg width=\"100%\" height=\"${chartHeight}\" viewBox=\"0 0 ${chartWidth} ${chartHeight}\" style=\"overflow: visible;\">`;\n    \n    // Draw grid lines\n    for (let i = 0; i <= 5; i++) {\n      const y = padding + (chartHeight - padding * 2) * (i / 5);\n      svg += `<line x1=\"${padding}\" y1=\"${y}\" x2=\"${chartWidth - padding}\" y2=\"${y}\" stroke=\"var(--gray-200)\" stroke-width=\"1\"/>`;\n    }\n\n    // Helper function to create smooth curve using cubic bezier (Catmull-Rom spline approximation)\n    const createSmoothPath = (points) => {\n      if (points.length < 2) return '';\n      if (points.length === 2) {\n        return `M ${points[0].x} ${points[0].y} L ${points[1].x} ${points[1].y}`;\n      }\n      \n      let path = `M ${points[0].x} ${points[0].y}`;\n      \n      for (let i = 0; i < points.length - 1; i++) {\n        const p0 = points[Math.max(0, i - 1)];\n        const p1 = points[i];\n        const p2 = points[i + 1];\n        const p3 = points[Math.min(points.length - 1, i + 2)];\n        \n        // Calculate control points for smooth curve\n        const cp1x = p1.x + (p2.x - p0.x) / 6;\n        const cp1y = p1.y + (p2.y - p0.y) / 6;\n        const cp2x = p2.x - (p3.x - p1.x) / 6;\n        const cp2y = p2.y - (p3.y - p1.y) / 6;\n        \n        path += ` C ${cp1x} ${cp1y}, ${cp2x} ${cp2y}, ${p2.x} ${p2.y}`;\n      }\n      \n      return path;\n    };\n\n    // Draw cases line with smooth curve\n    if (casesByDay.length > 0) {\n      const casePoints = sortedDates.map((date, idx) => {\n        const caseData = casesByDay.find(c => c.date === date);\n        const x = padding + idx * barWidth + barWidth / 2;\n        const y = chartHeight - padding - ((caseData?.count || 0) / maxValue) * (chartHeight - padding * 2);\n        return { x, y, value: caseData?.count || 0 };\n      });\n\n      // Create smooth path\n      const smoothPath = createSmoothPath(casePoints);\n      \n      // Add area fill under line\n      const areaPath = smoothPath + ` L ${chartWidth - padding},${chartHeight - padding} L ${padding},${chartHeight - padding} Z`;\n      \n      svg += `<defs>\n        <linearGradient id=\"casesGradient\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n          <stop offset=\"0%\" style=\"stop-color:#1a365d;stop-opacity:0.25\" />\n          <stop offset=\"100%\" style=\"stop-color:#1a365d;stop-opacity:0.03\" />\n        </linearGradient>\n      </defs>`;\n      svg += `<path d=\"${areaPath}\" fill=\"url(#casesGradient)\"/>`;\n      svg += `<path d=\"${smoothPath}\" fill=\"none\" stroke=\"#1a365d\" stroke-width=\"3.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>`;\n      \n      // Add dots on line\n      casePoints.forEach((point) => {\n        svg += `<circle cx=\"${point.x}\" cy=\"${point.y}\" r=\"5\" fill=\"#1a365d\" stroke=\"white\" stroke-width=\"2.5\" opacity=\"0.9\"/>`;\n      });\n    }\n\n    // Draw sessions line with smooth curve\n    if (sessionsByDay.length > 0) {\n      const sessionPoints = sortedDates.map((date, idx) => {\n        const sessionData = sessionsByDay.find(s => s.date === date);\n        const x = padding + idx * barWidth + barWidth / 2;\n        const y = chartHeight - padding - ((sessionData?.count || 0) / maxValue) * (chartHeight - padding * 2);\n        return { x, y, value: sessionData?.count || 0 };\n      });\n\n      // Create smooth path\n      const smoothPath = createSmoothPath(sessionPoints);\n      \n      // Add area fill under line\n      const areaPath = smoothPath + ` L ${chartWidth - padding},${chartHeight - padding} L ${padding},${chartHeight - padding} Z`;\n      \n      svg += `<defs>\n        <linearGradient id=\"sessionsGradient\" x1=\"0%\" y1=\"0%\" x2=\"0%\" y2=\"100%\">\n          <stop offset=\"0%\" style=\"stop-color:#10B981;stop-opacity:0.25\" />\n          <stop offset=\"100%\" style=\"stop-color:#10B981;stop-opacity:0.03\" />\n        </linearGradient>\n      </defs>`;\n      svg += `<path d=\"${areaPath}\" fill=\"url(#sessionsGradient)\"/>`;\n      svg += `<path d=\"${smoothPath}\" fill=\"none\" stroke=\"#10B981\" stroke-width=\"3.5\" stroke-linecap=\"round\" stroke-linejoin=\"round\"/>`;\n      \n      // Add dots on line\n      sessionPoints.forEach((point) => {\n        svg += `<circle cx=\"${point.x}\" cy=\"${point.y}\" r=\"5\" fill=\"#10B981\" stroke=\"white\" stroke-width=\"2.5\" opacity=\"0.9\"/>`;\n      });\n    }\n\n    // Draw Y-axis labels\n    for (let i = 0; i <= 5; i++) {\n      const y = padding + (chartHeight - padding * 2) * (i / 5);\n      const value = Math.round(maxValue * (1 - i / 5));\n      svg += `<text x=\"${padding - 10}\" y=\"${y + 4}\" text-anchor=\"end\" font-size=\"11\" font-weight=\"500\" fill=\"var(--gray-500)\">${value}</text>`;\n    }\n\n    // Draw date labels\n    sortedDates.forEach((date, idx) => {\n      const x = padding + idx * barWidth + barWidth / 2;\n      try {\n        // Handle both date strings and Date objects\n        const dateObj = typeof date === 'string' ? new Date(date + 'T00:00:00') : date;\n        const dateStr = dateObj.toLocaleDateString('en-US', { month: 'short', day: 'numeric' });\n        svg += `<text x=\"${x}\" y=\"${chartHeight - 15}\" text-anchor=\"middle\" font-size=\"11\" font-weight=\"500\" fill=\"var(--gray-600)\">${dateStr}</text>`;\n      } catch (e) {\n        console.error('Error formatting date:', date, e);\n        svg += `<text x=\"${x}\" y=\"${chartHeight - 15}\" text-anchor=\"middle\" font-size=\"11\" font-weight=\"500\" fill=\"var(--gray-600)\">${date}</text>`;\n      }\n    });\n\n    svg += '</svg>';\n\n    container.innerHTML = svg;\n  },\n\n  renderDonutChart(data) {\n    const container = document.getElementById('analyticsCasesByTypeChart');\n    if (!container) {\n      console.error('analyticsCasesByTypeChart container not found');\n      return;\n    }\n\n    const casesByType = data.casesByType || [];\n    console.log('Rendering donut chart - casesByType:', casesByType);\n    if (casesByType.length === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500); text-align: center; padding: 40px;\">No data available</p>';\n      return;\n    }\n\n    const total = casesByType.reduce((sum, item) => sum + (item.count || 0), 0);\n    if (total === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500); text-align: center; padding: 40px;\">No data available</p>';\n      return;\n    }\n\n    // Use brand colors with gradients\n    const colors = [\n      'url(#donutGradient1)', // Red gradient\n      'url(#donutGradient2)', // Blue gradient  \n      'url(#donutGradient3)', // Green gradient\n      'url(#donutGradient4)', // Amber gradient\n      'url(#donutGradient5)'  // Purple gradient\n    ];\n    const colorStops = [\n      { start: '#EF4444', end: '#F87171' },\n      { start: '#1a365d', end: '#2c5282' },\n      { start: '#10B981', end: '#34D399' },\n      { start: '#F59E0B', end: '#FBBF24' },\n      { start: '#8B5CF6', end: '#A78BFA' }\n    ];\n    const size = 180;\n    const radius = size / 2 - 12;\n    const center = size / 2;\n\n    let svg = `<svg width=\"${size}\" height=\"${size}\" viewBox=\"0 0 ${size} ${size}\" style=\"display: block; margin: 0 auto; filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.1));\">`;\n    \n    // Add gradient definitions\n    svg += '<defs>';\n    colorStops.forEach((stop, idx) => {\n      svg += `<linearGradient id=\"donutGradient${idx + 1}\" x1=\"0%\" y1=\"0%\" x2=\"100%\" y2=\"100%\">\n        <stop offset=\"0%\" style=\"stop-color:${stop.start};stop-opacity:1\" />\n        <stop offset=\"100%\" style=\"stop-color:${stop.end};stop-opacity:1\" />\n      </linearGradient>`;\n    });\n    svg += '</defs>';\n    \n    let currentAngle = -90;\n    casesByType.forEach((item, idx) => {\n      const value = item.count || 0;\n      const percentage = (value / total) * 100;\n      const angle = (percentage / 100) * 360;\n      \n      const x1 = center + radius * Math.cos((currentAngle * Math.PI) / 180);\n      const y1 = center + radius * Math.sin((currentAngle * Math.PI) / 180);\n      const x2 = center + radius * Math.cos(((currentAngle + angle) * Math.PI) / 180);\n      const y2 = center + radius * Math.sin(((currentAngle + angle) * Math.PI) / 180);\n      \n      const largeArc = angle > 180 ? 1 : 0;\n      \n      svg += `<path d=\"M ${center} ${center} L ${x1} ${y1} A ${radius} ${radius} 0 ${largeArc} 1 ${x2} ${y2} Z\" fill=\"${colors[idx % colors.length]}\" stroke=\"white\" stroke-width=\"3\" opacity=\"0.95\"/>`;\n      \n      currentAngle += angle;\n    });\n\n    // Center circle with gradient background\n    svg += `<circle cx=\"${center}\" cy=\"${center}\" r=\"${radius - 20}\" fill=\"white\" opacity=\"0.9\"/>`;\n    \n    // Center text with better styling\n    svg += `<text x=\"${center}\" y=\"${center - 8}\" text-anchor=\"middle\" font-size=\"28\" font-weight=\"700\" font-family=\"Space Grotesk, sans-serif\" fill=\"#1a365d\">${total}</text>`;\n    svg += `<text x=\"${center}\" y=\"${center + 12}\" text-anchor=\"middle\" font-size=\"13\" font-weight=\"600\" fill=\"#6b7280\">Total Cases</text>`;\n\n    svg += '</svg>';\n\n    // Add enhanced legend\n    const legend = casesByType.map((item, idx) => `\n      <div style=\"display: flex; align-items: center; gap: 10px; margin-bottom: 10px; padding: 8px 12px; border-radius: 8px; transition: all 0.2s ease; cursor: pointer;\" \n           onmouseover=\"this.style.background='rgba(249, 250, 251, 0.8)'\" \n           onmouseout=\"this.style.background='transparent'\">\n        <div style=\"width: 16px; height: 16px; background: linear-gradient(135deg, ${colorStops[idx % colorStops.length].start} 0%, ${colorStops[idx % colorStops.length].end} 100%); border-radius: 4px; box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\"></div>\n        <span style=\"font-size: 13px; font-weight: 500; color: var(--gray-700); flex: 1;\">${this.escapeHtml(item.case_type || 'Unknown')}</span>\n        <span style=\"font-size: 14px; font-weight: 700; color: var(--gray-900); font-family: 'Space Grotesk', sans-serif;\">${item.count || 0}</span>\n      </div>\n    `).join('');\n\n    container.innerHTML = `<div style=\"text-align: center; margin-bottom: 24px;\">${svg}</div><div style=\"margin-top: 24px; padding: 0 8px;\">${legend}</div>`;\n  },\n\n  renderResolutionTypes(data) {\n    const container = document.getElementById('analyticsResolutionTypes');\n    if (!container) return;\n\n    const types = (data.resolutionTypes || []).slice(0, 10);\n    if (types.length === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500);\">No data available</p>';\n      return;\n    }\n\n    container.innerHTML = types.map((r, idx) => `\n      <div style=\"padding: 14px 16px; border-bottom: 1px solid rgba(229, 231, 235, 0.5); border-radius: 12px; margin-bottom: 8px; background: ${idx % 2 === 0 ? 'rgba(249, 250, 251, 0.5)' : 'transparent'}; transition: all 0.2s ease;\">\n        <div style=\"font-size: 13px; font-weight: 500; color: var(--gray-700); margin-bottom: 8px; line-height: 1.4;\">${this.escapeHtml(r.resolution || 'Unknown')}</div>\n        <div style=\"display: flex; justify-content: space-between; align-items: center;\">\n          <span style=\"font-size: 20px; font-weight: 700; font-family: 'Space Grotesk', sans-serif; color: var(--brand-navy);\">${r.count || 0}</span>\n          ${r.total_refund ? `<span style=\"font-size: 13px; font-weight: 600; color: var(--success-600); padding: 4px 10px; background: rgba(16, 185, 129, 0.1); border-radius: 6px;\">${this.formatCurrency(r.total_refund)}</span>` : ''}\n        </div>\n      </div>\n    `).join('');\n  },\n\n  renderStatusDistribution(data) {\n    const container = document.getElementById('analyticsStatusDistribution');\n    if (!container) {\n      console.error('analyticsStatusDistribution container not found');\n      return;\n    }\n\n    const statuses = data.casesByStatus || [];\n    console.log('Rendering status distribution - statuses:', statuses);\n    if (statuses.length === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500);\">No data available</p>';\n      return;\n    }\n\n    const maxCount = Math.max(...statuses.map(s => s.count || 0));\n    const colors = { 'completed': '#D1FAE5', 'in_progress': '#DBEAFE', 'pending': '#FEF3C7' };\n\n    container.innerHTML = statuses.map(s => {\n      const status = s.status || 'unknown';\n      const count = s.count || 0;\n      const width = maxCount > 0 ? (count / maxCount) * 100 : 0;\n      const color = colors[status] || 'var(--gray-100)';\n      const statusColors = {\n        'completed': { bg: 'linear-gradient(135deg, #D1FAE5 0%, #A7F3D0 100%)', text: '#059669', bar: '#10B981' },\n        'in_progress': { bg: 'linear-gradient(135deg, #DBEAFE 0%, #BFDBFE 100%)', text: '#2563EB', bar: '#3B82F6' },\n        'pending': { bg: 'linear-gradient(135deg, #FEF3C7 0%, #FDE68A 100%)', text: '#D97706', bar: '#F59E0B' }\n      };\n      const statusStyle = statusColors[status] || { bg: 'var(--gray-100)', text: 'var(--gray-700)', bar: 'var(--gray-400)' };\n      \n      return `\n        <div style=\"margin-bottom: 16px; padding: 14px 16px; background: ${statusStyle.bg}; border-radius: 12px; border: 1px solid rgba(255, 255, 255, 0.5);\">\n          <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 10px;\">\n            <span style=\"font-size: 13px; font-weight: 600; color: ${statusStyle.text}; text-transform: capitalize;\">${this.escapeHtml(status.replace('_', ' '))}</span>\n            <span style=\"font-size: 18px; font-weight: 700; font-family: 'Space Grotesk', sans-serif; color: ${statusStyle.text};\">${count}</span>\n          </div>\n          <div style=\"width: 100%; height: 10px; background: rgba(255, 255, 255, 0.6); border-radius: 6px; overflow: hidden; box-shadow: inset 0 2px 4px rgba(0, 0, 0, 0.1);\">\n            <div style=\"width: ${width}%; height: 100%; background: ${statusStyle.bar}; border-radius: 6px; transition: width 0.5s cubic-bezier(0.4, 0, 0.2, 1); box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);\"></div>\n          </div>\n        </div>\n      `;\n    }).join('');\n  },\n\n  renderFlowTypes(data) {\n    const container = document.getElementById('analyticsFlowTypes');\n    if (!container) {\n      console.error('analyticsFlowTypes container not found');\n      return;\n    }\n\n    const flows = data.flowTypes || [];\n    console.log('Rendering flow types - flows:', flows);\n    if (flows.length === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500);\">No data available</p>';\n      return;\n    }\n\n    container.innerHTML = flows.map((f, idx) => `\n      <div style=\"padding: 14px 16px; border-bottom: 1px solid rgba(229, 231, 235, 0.5); border-radius: 12px; margin-bottom: 8px; background: ${idx % 2 === 0 ? 'rgba(249, 250, 251, 0.5)' : 'transparent'}; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease;\">\n        <span style=\"font-size: 13px; font-weight: 500; color: var(--gray-700);\">${this.escapeHtml(f.flow_type || 'Unknown')}</span>\n        <span style=\"font-size: 16px; font-weight: 700; font-family: 'Space Grotesk', sans-serif; color: var(--brand-navy); padding: 4px 12px; background: rgba(26, 54, 93, 0.1); border-radius: 8px;\">${f.count || 0}</span>\n      </div>\n    `).join('');\n  },\n\n  renderTeamLeaderboard(data) {\n    const container = document.getElementById('analyticsTeamLeaderboard');\n    if (!container) {\n      console.error('analyticsTeamLeaderboard container not found');\n      return;\n    }\n\n    const team = data.teamPerformance || [];\n    console.log('Rendering team leaderboard - team:', team);\n    if (team.length === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500);\">No data available</p>';\n      return;\n    }\n\n    container.innerHTML = team.map((t, idx) => `\n      <div style=\"padding: 16px; border-bottom: 1px solid rgba(229, 231, 235, 0.5); border-radius: 12px; margin-bottom: 12px; background: ${idx % 2 === 0 ? 'rgba(249, 250, 251, 0.5)' : 'transparent'}; transition: all 0.2s ease;\">\n        <div style=\"display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px;\">\n          <span style=\"font-size: 14px; font-weight: 600; color: var(--gray-900); font-family: 'Space Grotesk', sans-serif;\">${this.escapeHtml(t.user_name || 'Unassigned')}</span>\n          <span style=\"font-size: 18px; font-weight: 700; color: var(--brand-navy); padding: 4px 12px; background: rgba(26, 54, 93, 0.1); border-radius: 8px;\">${t.cases_completed || 0}</span>\n        </div>\n        <div style=\"display: flex; gap: 16px; font-size: 12px; color: var(--gray-600);\">\n          <span style=\"display: flex; align-items: center; gap: 4px;\">\n            <span style=\"font-weight: 600;\">â±</span>\n            ${this.formatHours(t.avg_resolution_hours || 0)} avg\n          </span>\n          <span style=\"display: flex; align-items: center; gap: 4px; color: var(--success-600);\">\n            <span style=\"font-weight: 600; width: 18px; height: 18px; display: inline-flex;\"><svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M16 8h-6a2 2 0 100 4h4a2 2 0 110 4H8\"/><path d=\"M12 18V6\"/></svg></span>\n            ${this.formatCurrency(t.total_refunds || 0)}\n          </span>\n        </div>\n      </div>\n    `).join('');\n  },\n\n  renderRootCauseAnalysis(data) {\n    const container = document.getElementById('analyticsRootCauseAnalysis');\n    if (!container) {\n      console.error('analyticsRootCauseAnalysis container not found');\n      return;\n    }\n\n    const causes = data.rootCauses || [];\n    console.log('Rendering root cause analysis - causes:', causes);\n    if (causes.length === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500);\">No data</p>';\n      return;\n    }\n\n    container.innerHTML = causes.slice(0, 10).map((c, idx) => `\n      <div style=\"padding: 14px 16px; border-bottom: 1px solid rgba(229, 231, 235, 0.5); border-radius: 12px; margin-bottom: 8px; background: ${idx % 2 === 0 ? 'rgba(254, 242, 242, 0.5)' : 'transparent'}; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease;\">\n        <span style=\"font-size: 13px; font-weight: 500; color: var(--gray-700); flex: 1; margin-right: 12px;\">${this.escapeHtml(c.reason || 'Unknown')}</span>\n        <span style=\"font-size: 16px; font-weight: 700; font-family: 'Space Grotesk', sans-serif; color: var(--error-600); padding: 4px 12px; background: rgba(239, 68, 68, 0.1); border-radius: 8px; white-space: nowrap;\">${c.count || 0}</span>\n      </div>\n    `).join('');\n  },\n\n  renderResolutionTimeDistribution(data) {\n    const container = document.getElementById('analyticsResolutionTimeDist');\n    if (!container) {\n      console.error('analyticsResolutionTimeDist container not found');\n      return;\n    }\n\n    const dist = data.resolutionDistribution || [];\n    console.log('Rendering resolution time distribution - dist:', dist);\n    if (dist.length === 0) {\n      container.innerHTML = '<p style=\"color: var(--gray-500);\">No data available</p>';\n      return;\n    }\n\n    container.innerHTML = dist.map((d, idx) => `\n      <div style=\"padding: 14px 16px; border-bottom: 1px solid rgba(229, 231, 235, 0.5); border-radius: 12px; margin-bottom: 8px; background: ${idx % 2 === 0 ? 'rgba(249, 250, 251, 0.5)' : 'transparent'}; display: flex; justify-content: space-between; align-items: center; transition: all 0.2s ease;\">\n        <span style=\"font-size: 13px; font-weight: 500; color: var(--gray-700);\">${this.escapeHtml(d.time_bucket || 'Unknown')}</span>\n        <span style=\"font-size: 16px; font-weight: 700; font-family: 'Space Grotesk', sans-serif; color: var(--brand-navy); padding: 4px 12px; background: rgba(26, 54, 93, 0.1); border-radius: 8px;\">${d.count || 0}</span>\n      </div>\n    `).join('');\n  },\n\n  formatCurrency(amount) {\n    if (!amount || amount === 0) return '$0.00';\n    return new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' }).format(amount);\n  },\n\n  formatHours(hours) {\n    if (!hours || hours === 0) return '-';\n    if (hours < 24) return `${Math.round(hours * 10) / 10}h`;\n    return `${Math.round((hours / 24) * 10) / 10}d`;\n  },\n\n  formatDate(timestamp) {\n    if (!timestamp) return '-';\n    try {\n      return new Date(timestamp).toLocaleDateString('en-US', {\n        year: 'numeric',\n        month: 'short',\n        day: 'numeric'\n      });\n    } catch {\n      return '-';\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// SELF-RESOLVED PAGE\n// Cases where customers were satisfied with information provided\n// ============================================\nconst HubSelfResolved = {\n  currentPage: 1,\n  totalPages: 1,\n  searchTerm: '',\n\n  async loadCases(page = 1) {\n    this.currentPage = page;\n    const tbody = document.getElementById('selfResolvedTableBody');\n    if (!tbody) return;\n\n    tbody.innerHTML = '<tr><td colspan=\"5\" class=\"loading-spinner\"><div class=\"spinner\"></div></td></tr>';\n\n    try {\n      const params = new URLSearchParams({\n        page: page,\n        limit: 50,\n      });\n      if (this.searchTerm) {\n        params.append('search', this.searchTerm);\n      }\n\n      const headers = { 'Content-Type': 'application/json' };\n      if (HubState.token) {\n        headers['Authorization'] = `Bearer ${HubState.token}`;\n      }\n\n      const response = await fetch(`${HubConfig.API_BASE}/hub/api/self-resolved?${params}`, { headers });\n      if (!response.ok) throw new Error('Failed to load self-resolved cases');\n\n      const data = await response.json();\n      this.totalPages = data.totalPages || 1;\n      \n      this.renderCases(data.cases || []);\n      this.updateResultCount(data.total || 0);\n      this.renderPagination();\n\n      // Update badge count\n      const badge = document.getElementById('selfResolvedCount');\n      if (badge) badge.textContent = data.total || 0;\n    } catch (error) {\n      console.error('Error loading self-resolved cases:', error);\n      tbody.innerHTML = '<tr><td colspan=\"5\" style=\"text-align:center;padding:40px;color:var(--gray-500);\">Failed to load self-resolved cases</td></tr>';\n      if (error.message?.includes('no such column')) {\n        tbody.innerHTML = '<tr><td colspan=\"5\" style=\"text-align:center;padding:40px;color:var(--gray-500);\">Self-resolved feature not available. Run migration 007_self_resolved.sql</td></tr>';\n      }\n    }\n  },\n\n  renderCases(cases) {\n    const tbody = document.getElementById('selfResolvedTableBody');\n    if (!tbody) return;\n\n    if (cases.length === 0) {\n      tbody.innerHTML = '<tr><td colspan=\"5\" style=\"text-align:center;padding:40px;color:var(--gray-500);\">No self-resolved cases found</td></tr>';\n      return;\n    }\n\n    tbody.innerHTML = cases.map(c => {\n      const customerInfo = c.customer_name || c.customer_email || 'Unknown';\n      const customerEmail = c.customer_email ? `<div style=\"font-size:12px;color:var(--gray-500);\">${this.escapeHtml(c.customer_email)}</div>` : '';\n      const issueType = this.formatIssueType(c.issue_type || c.case_type || 'general');\n      const resolution = this.formatResolution(c.resolution || 'satisfied_with_info');\n      const resolvedDate = this.formatDate(c.created_at || c.resolved_at);\n      const recordingLink = c.session_replay_url \n        ? `<a href=\"${this.escapeHtml(c.session_replay_url)}\" target=\"_blank\" style=\"color:var(--brand-navy);text-decoration:none;\">View Recording</a>`\n        : '-';\n\n      return `\n        <tr style=\"cursor:default;\">\n          <td>\n            <div class=\"customer-info\">\n              <div class=\"customer-name\">${this.escapeHtml(customerInfo)}</div>\n              ${customerEmail}\n            </div>\n          </td>\n          <td><span class=\"type-badge\">${this.escapeHtml(issueType)}</span></td>\n          <td>Customer satisfied - no resolution needed</td>\n          <td><span class=\"time-ago\">${resolvedDate}</span></td>\n          <td>${recordingLink}</td>\n        </tr>\n      `;\n    }).join('');\n  },\n\n  formatIssueType(issueType) {\n    if (!issueType) return 'General Inquiry';\n    return issueType.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n  },\n\n  formatResolution(resolution) {\n    // Self-resolved cases don't have resolutions - they're just records\n    return 'Customer satisfied - no resolution needed';\n  },\n\n  formatDate(timestamp) {\n    if (!timestamp) return '-';\n    const date = new Date(timestamp);\n    const now = new Date();\n    const diffMs = now - date;\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n    const diffDays = Math.floor(diffMs / 86400000);\n\n    if (diffMins < 1) return 'Just now';\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffHours < 24) return `${diffHours}h ago`;\n    if (diffDays < 7) return `${diffDays}d ago`;\n    return date.toLocaleDateString('en-US', { month: 'short', day: 'numeric', year: 'numeric' });\n  },\n\n  updateResultCount(total) {\n    const countEl = document.getElementById('selfResolvedResultCount');\n    if (countEl) {\n      countEl.textContent = `${total} ${total === 1 ? 'case' : 'cases'}`;\n    }\n  },\n\n  renderPagination() {\n    const paginationEl = document.getElementById('selfResolvedPagination');\n    if (!paginationEl) return;\n\n    if (this.totalPages <= 1) {\n      paginationEl.innerHTML = '';\n      return;\n    }\n\n    let html = '<div class=\"pagination-controls\">';\n    if (this.currentPage > 1) {\n      html += `<button onclick=\"HubSelfResolved.loadCases(${this.currentPage - 1})\" class=\"pagination-btn\">Previous</button>`;\n    }\n    html += `<span class=\"pagination-info\">Page ${this.currentPage} of ${this.totalPages}</span>`;\n    if (this.currentPage < this.totalPages) {\n      html += `<button onclick=\"HubSelfResolved.loadCases(${this.currentPage + 1})\" class=\"pagination-btn\">Next</button>`;\n    }\n    html += '</div>';\n    paginationEl.innerHTML = html;\n  },\n\n  search() {\n    const searchInput = document.getElementById('selfResolvedSearch');\n    if (searchInput) {\n      this.searchTerm = searchInput.value.trim();\n      this.loadCases(1);\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// DUPLICATES PAGE\n// ============================================\nconst HubDuplicates = {\n  data: null,\n\n  async load() {\n    HubUI.showLoading();\n    try {\n      const headers = { 'Content-Type': 'application/json' };\n      if (HubState.token) {\n        headers['Authorization'] = `Bearer ${HubState.token}`;\n      }\n      const response = await fetch('/hub/api/duplicates', { headers });\n      \n      if (!response.ok) throw new Error('Failed to load duplicates');\n      \n      this.data = await response.json();\n      this.render();\n      this.updateBadge();\n    } catch (error) {\n      console.error('Error loading duplicates:', error);\n      HubUI.showToast('Failed to load duplicate cases', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  updateBadge() {\n    const badge = document.getElementById('duplicatesCount');\n    if (badge && this.data) {\n      badge.textContent = this.data.summary.total_duplicate_groups || 0;\n    }\n  },\n\n  render() {\n    // Update summary stats\n    document.getElementById('duplicateGroupsCount').textContent = this.data.summary.total_duplicate_groups || 0;\n    document.getElementById('duplicateCasesCount').textContent = this.data.summary.total_duplicate_cases || 0;\n    document.getElementById('duplicateCustomersCount').textContent = this.data.summary.unique_customers_affected || 0;\n\n    const container = document.getElementById('duplicatesContent');\n    \n    if (!this.data.groups || this.data.groups.length === 0) {\n      container.innerHTML = `\n        <div class=\"duplicates-empty\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\">\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1.5\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"></path>\n          </svg>\n          <h3>No Duplicate Cases Found</h3>\n          <p>Great news! There are no cases with the same email and order number.</p>\n        </div>\n      `;\n      return;\n    }\n\n    container.innerHTML = this.data.groups.map((group, index) => {\n      const initials = this.getInitials(group.cases[0]?.customer_name || group.customer_email);\n      const casesHtml = this.renderCasesTable(group.cases);\n      \n      return `\n        <div class=\"duplicate-group\" id=\"duplicate-group-${index}\">\n          <div class=\"duplicate-group-header\" onclick=\"HubDuplicates.toggleGroup(${index})\">\n            <div class=\"duplicate-group-info\">\n              <div class=\"duplicate-group-customer\">\n                <div class=\"duplicate-customer-avatar\">${initials}</div>\n                <div class=\"duplicate-customer-details\">\n                  <h3>${this.escapeHtml(group.cases[0]?.customer_name || 'Unknown')}</h3>\n                  <span>${this.escapeHtml(group.customer_email)}</span>\n                </div>\n              </div>\n              <div class=\"duplicate-order-info\">\n                <div class=\"duplicate-order-badge\">\n                  <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z\"></path></svg>\n                  Order: ${this.escapeHtml(group.order_number || 'N/A')}\n                </div>\n                <div class=\"duplicate-order-badge\">\n                  <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>\n                  First: ${this.formatDate(group.first_created)}\n                </div>\n                <div class=\"duplicate-order-badge\">\n                  <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>\n                  Last: ${this.formatDate(group.last_created)}\n                </div>\n              </div>\n            </div>\n            <div class=\"duplicate-group-badge\">\n              <span class=\"duplicate-count\">${group.duplicate_count}</span>\n              <span class=\"duplicate-count-label\">duplicates</span>\n            </div>\n            <div class=\"duplicate-toggle-icon\">\n              <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"20\" height=\"20\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M19 9l-7 7-7-7\"></path></svg>\n            </div>\n          </div>\n          <div class=\"duplicate-cases-wrapper\">\n            ${casesHtml}\n          </div>\n        </div>\n      `;\n    }).join('');\n  },\n\n  renderCasesTable(cases) {\n    return `\n      <table class=\"duplicate-cases-table\">\n        <thead>\n          <tr>\n            <th>Case ID</th>\n            <th>Type</th>\n            <th>Status</th>\n            <th>Resolution</th>\n            <th>Refund</th>\n            <th>Assigned</th>\n            <th>Created</th>\n          </tr>\n        </thead>\n        <tbody>\n          ${cases.map(c => `\n            <tr>\n              <td>\n                <span class=\"duplicate-case-id\" onclick=\"HubNavigation.openCase('${c.case_id}')\">${c.case_id}</span>\n              </td>\n              <td><span class=\"type-badge\">${this.escapeHtml(c.case_type || '-')}</span></td>\n              <td>\n                <span class=\"duplicate-case-status ${this.getStatusClass(c.status)}\">\n                  ${this.formatStatus(c.status)}\n                </span>\n              </td>\n              <td>${this.escapeHtml(c.resolution || '-')}</td>\n              <td>${c.refund_amount ? '$' + parseFloat(c.refund_amount).toFixed(2) : '-'}</td>\n              <td>${this.escapeHtml(c.assigned_to || 'Unassigned')}</td>\n              <td>${this.formatDate(c.created_at)}</td>\n            </tr>\n          `).join('')}\n        </tbody>\n      </table>\n    `;\n  },\n\n  toggleGroup(index) {\n    const group = document.getElementById(`duplicate-group-${index}`);\n    if (group) {\n      group.classList.toggle('expanded');\n    }\n  },\n\n  getInitials(name) {\n    if (!name) return '?';\n    return name.split(' ').map(n => n[0]).join('').substring(0, 2).toUpperCase();\n  },\n\n  getStatusClass(status) {\n    if (status === 'completed') return 'completed';\n    if (status === 'in_progress') return 'in-progress';\n    return 'pending';\n  },\n\n  formatStatus(status) {\n    if (!status) return 'Pending';\n    return status.replace(/_/g, ' ').replace(/\\b\\w/g, l => l.toUpperCase());\n  },\n\n  formatDate(dateStr) {\n    if (!dateStr) return '-';\n    try {\n      const date = new Date(dateStr);\n      return date.toLocaleDateString('en-US', { \n        month: 'short', \n        day: 'numeric',\n        year: date.getFullYear() !== new Date().getFullYear() ? 'numeric' : undefined\n      });\n    } catch {\n      return dateStr;\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\nconst HubSOP = {\n  sops: [],\n  currentCategory: '',\n\n  async load() {\n    HubUI.showLoading();\n    try {\n      const url = this.currentCategory \n        ? `/hub/api/sop?category=${this.currentCategory}` \n        : '/hub/api/sop';\n      const result = await HubAPI.get(url);\n      this.sops = result.sops || [];\n      this.render();\n      \n      // Show add button for admins\n      const addBtn = document.getElementById('addSopBtn');\n      if (addBtn) {\n        addBtn.style.display = HubAuth.isAdmin() ? 'inline-flex' : 'none';\n      }\n    } catch (e) {\n      console.error('Failed to load SOPs:', e);\n      HubUI.showToast('Failed to load SOP links', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  getPlaceholderSOPs() {\n    return [\n      // Refund SOPs\n      { id: 'p1', scenario_name: 'Full Refund Process', case_type: 'refund', sop_url: '#', description: 'Step-by-step guide for processing full refunds for dissatisfied customers' },\n      { id: 'p2', scenario_name: 'Partial Refund - Product Quality Issue', case_type: 'refund', sop_url: '#', description: 'How to process partial refunds when customer reports quality issues' },\n      { id: 'p3', scenario_name: 'Partial Refund - Dog Not Using Product', case_type: 'refund', sop_url: '#', description: 'Handling refunds when the dog is not using the PuppyPad' },\n      { id: 'p4', scenario_name: 'Refund - Changed Mind', case_type: 'refund', sop_url: '#', description: 'Process for customers who simply changed their mind' },\n      \n      // Shipping SOPs\n      { id: 'p5', scenario_name: 'Missing Package - Reship Process', case_type: 'shipping', sop_url: '#', description: 'How to handle and reship missing packages' },\n      { id: 'p6', scenario_name: 'Wrong Item Received', case_type: 'shipping', sop_url: '#', description: 'Steps for when customer receives incorrect items' },\n      { id: 'p7', scenario_name: 'Damaged In Transit', case_type: 'shipping', sop_url: '#', description: 'Handling products damaged during shipping' },\n      { id: 'p8', scenario_name: 'Address Update / Redirect', case_type: 'shipping', sop_url: '#', description: 'How to update shipping address for in-transit orders' },\n      \n      // Subscription SOPs\n      { id: 'p9', scenario_name: 'Pause Subscription', case_type: 'subscription', sop_url: '#', description: 'How to pause a subscription in Checkout Champ' },\n      { id: 'p10', scenario_name: 'Cancel Subscription', case_type: 'subscription', sop_url: '#', description: 'Complete cancellation process for subscriptions' },\n      { id: 'p11', scenario_name: 'Change Delivery Frequency', case_type: 'subscription', sop_url: '#', description: 'Modifying subscription frequency (weekly, monthly, etc.)' },\n      { id: 'p12', scenario_name: 'Too Much Product - Reduce Shipment', case_type: 'subscription', sop_url: '#', description: 'Adjusting subscription for customers with excess product' },\n      \n      // Return SOPs\n      { id: 'p13', scenario_name: 'Return for Refund', case_type: 'return', sop_url: '#', description: 'Full return process with refund' },\n      { id: 'p14', scenario_name: 'Return for Exchange', case_type: 'return', sop_url: '#', description: 'Processing exchanges for different products/sizes' }\n    ];\n  },\n\n  render() {\n    const container = document.getElementById('sopList');\n    if (!container) return;\n\n    // Use placeholder SOPs if none exist\n    const sopsToRender = this.sops.length > 0 ? this.sops : this.getPlaceholderSOPs();\n    const isPlaceholder = this.sops.length === 0;\n    \n    // Filter by category if set\n    const filteredSOPs = this.currentCategory \n      ? sopsToRender.filter(s => s.case_type === this.currentCategory)\n      : sopsToRender;\n\n    if (filteredSOPs.length === 0) {\n      container.innerHTML = `\n        <div class=\"empty-state\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path></svg>\n          <h3>No SOP Links Found</h3>\n          <p>Add SOP links to help your team access procedures quickly.</p>\n          ${HubAuth.isAdmin() ? '<button class=\"btn btn-primary\" onclick=\"HubSOP.showAddModal()\">Add First SOP</button>' : ''}\n        </div>\n      `;\n      return;\n    }\n\n    // Group SOPs by case type\n    const grouped = {};\n    filteredSOPs.forEach(sop => {\n      if (!grouped[sop.case_type]) grouped[sop.case_type] = [];\n      grouped[sop.case_type].push(sop);\n    });\n\n    const categoryLabels = {\n      'refund': { label: 'Refund Procedures', icon: '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M16 8h-6a2 2 0 100 4h4a2 2 0 110 4H8\"/><path d=\"M12 18V6\"/></svg>', color: '#ef4444' },\n      'shipping': { label: 'Shipping & Delivery', icon: '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z\"/><polyline points=\"3.27,6.96 12,12.01 20.73,6.96\"/><line x1=\"12\" y1=\"22.08\" x2=\"12\" y2=\"12\"/></svg>', color: '#3b82f6' },\n      'subscription': { label: 'Subscription Management', icon: '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M23 4v6h-6\"/><path d=\"M1 20v-6h6\"/><path d=\"M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15\"/></svg>', color: '#8b5cf6' },\n      'return': { label: 'Returns & Exchanges', icon: '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z\"/><polyline points=\"9,22 9,12 15,12 15,22\"/></svg>', color: '#f59e0b' }\n    };\n\n    let html = '';\n    \n    if (isPlaceholder) {\n      html += `\n        <div class=\"sop-placeholder-banner\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"20\" height=\"20\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>\n          <span>These are placeholder SOPs. Click Edit to add your actual SOP links.</span>\n        </div>\n      `;\n    }\n\n    Object.entries(grouped).forEach(([caseType, sops]) => {\n      const cat = categoryLabels[caseType] || { label: caseType, icon: 'ðŸ“‹', color: '#6b7280' };\n      html += `\n        <div class=\"sop-category-section\">\n          <div class=\"sop-category-header\">\n            <span class=\"sop-category-icon\">${cat.icon}</span>\n            <span class=\"sop-category-title\">${cat.label}</span>\n            <span class=\"sop-category-count\">${sops.length} SOPs</span>\n          </div>\n          <div class=\"sop-cards-grid\">\n            ${sops.map(sop => `\n              <div class=\"sop-card ${isPlaceholder && sop.sop_url === '#' ? 'placeholder' : ''}\">\n                <div class=\"sop-card-header\">\n                  <h3 class=\"sop-card-title\">${this.escapeHtml(sop.scenario_name)}</h3>\n                </div>\n                ${sop.description ? `<p class=\"sop-card-description\">${this.escapeHtml(sop.description)}</p>` : ''}\n                <div class=\"sop-card-actions\">\n                  ${sop.sop_url !== '#' ? `\n                    <a href=\"${sop.sop_url}\" target=\"_blank\" class=\"sop-card-link\" onclick=\"HubSOP.logClick('${sop.id}', '${this.escapeHtml(sop.scenario_name)}')\">\n                      <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10 6H6a2 2 0 00-2 2v10a2 2 0 002 2h10a2 2 0 002-2v-4M14 4h6m0 0v6m0-6L10 14\"></path></svg>\n                      Open SOP\n                    </a>\n                  ` : `\n                    <span class=\"sop-card-link disabled\">\n                      <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z\"></path></svg>\n                      Link Not Set\n                    </span>\n                  `}\n                  ${HubAuth.isAdmin() && !isPlaceholder ? `\n                    <button class=\"btn btn-secondary btn-sm\" onclick=\"HubSOP.showEditModal(${sop.id})\">Edit</button>\n                    <button class=\"btn btn-secondary btn-sm\" style=\"color: var(--error-600);\" onclick=\"HubSOP.delete(${sop.id})\">Delete</button>\n                  ` : ''}\n                  ${HubAuth.isAdmin() && isPlaceholder ? `\n                    <button class=\"btn btn-primary btn-sm\" onclick=\"HubSOP.createFromPlaceholder('${sop.scenario_name}', '${sop.case_type}', '${this.escapeHtml(sop.description || '')}')\">\n                      Add Link\n                    </button>\n                  ` : ''}\n                </div>\n              </div>\n            `).join('')}\n          </div>\n        </div>\n      `;\n    });\n\n    container.innerHTML = html;\n  },\n\n  createFromPlaceholder(name, caseType, description) {\n    // Pre-fill the add modal with placeholder data\n    this.showAddModal();\n    setTimeout(() => {\n      document.getElementById('sopName').value = name;\n      document.getElementById('sopCaseType').value = caseType;\n      document.getElementById('sopDescription').value = description;\n      document.getElementById('sopUrl').focus();\n    }, 100);\n  },\n\n  filterByCategory(category) {\n    this.currentCategory = category;\n    \n    // Update tab states\n    document.querySelectorAll('.sop-tab').forEach(tab => {\n      tab.classList.toggle('active', tab.dataset.category === category);\n    });\n    \n    this.load();\n  },\n\n  async logClick(sopId, sopName) {\n    // Log activity if there's a current case\n    if (HubState.currentCase) {\n      try {\n        await HubAPI.post('/hub/api/activity', {\n          case_id: HubState.currentCase.case_id,\n          activity_type: 'clicked_sop',\n          details: { sop_id: sopId, sop_name: sopName }\n        });\n      } catch (e) {\n        // Silent fail for activity logging\n      }\n    }\n  },\n\n  showAddModal() {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"sopModal\">\n        <div class=\"modal\" style=\"max-width: 500px;\">\n          <div class=\"modal-header\">\n            <h2 class=\"modal-title\">Add SOP Link</h2>\n            <button class=\"modal-close\" onclick=\"document.getElementById('sopModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <div class=\"form-group\">\n              <label>Scenario Key *</label>\n              <input type=\"text\" id=\"sopKey\" placeholder=\"e.g., refund_partial_20\">\n            </div>\n            <div class=\"form-group\">\n              <label>Scenario Name *</label>\n              <input type=\"text\" id=\"sopName\" placeholder=\"e.g., Partial Refund 20%\">\n            </div>\n            <div class=\"form-group\">\n              <label>Category *</label>\n              <select id=\"sopCategory\">\n                <option value=\"refund\">Refund</option>\n                <option value=\"return\">Return</option>\n                <option value=\"shipping\">Shipping</option>\n                <option value=\"subscription\">Subscription</option>\n                <option value=\"manual\">Manual</option>\n              </select>\n            </div>\n            <div class=\"form-group\">\n              <label>SOP URL *</label>\n              <input type=\"url\" id=\"sopUrl\" placeholder=\"https://...\">\n            </div>\n            <div class=\"form-group\">\n              <label>Description</label>\n              <textarea id=\"sopDescription\" rows=\"3\" placeholder=\"Brief description...\"></textarea>\n            </div>\n          </div>\n          <div class=\"modal-footer\" style=\"padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px;\">\n            <button class=\"btn btn-secondary\" onclick=\"document.getElementById('sopModal').remove()\">Cancel</button>\n            <button class=\"btn btn-primary\" onclick=\"HubSOP.save()\">Save</button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async showEditModal(sopId) {\n    const sop = this.sops.find(s => s.id === sopId);\n    if (!sop) return;\n\n    const html = `\n      <div class=\"modal-overlay active\" id=\"sopModal\">\n        <div class=\"modal\" style=\"max-width: 500px;\">\n          <div class=\"modal-header\">\n            <h2 class=\"modal-title\">Edit SOP Link</h2>\n            <button class=\"modal-close\" onclick=\"document.getElementById('sopModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <input type=\"hidden\" id=\"sopEditId\" value=\"${sop.id}\">\n            <div class=\"form-group\">\n              <label>Scenario Name *</label>\n              <input type=\"text\" id=\"sopName\" value=\"${this.escapeHtml(sop.scenario_name)}\">\n            </div>\n            <div class=\"form-group\">\n              <label>Category *</label>\n              <select id=\"sopCategory\">\n                ${['refund', 'return', 'shipping', 'subscription', 'manual'].map(c =>\n                  `<option value=\"${c}\" ${sop.case_type === c ? 'selected' : ''}>${c.charAt(0).toUpperCase() + c.slice(1)}</option>`\n                ).join('')}\n              </select>\n            </div>\n            <div class=\"form-group\">\n              <label>SOP URL *</label>\n              <input type=\"url\" id=\"sopUrl\" value=\"${this.escapeHtml(sop.sop_url)}\">\n            </div>\n            <div class=\"form-group\">\n              <label>Description</label>\n              <textarea id=\"sopDescription\" rows=\"3\">${this.escapeHtml(sop.description || '')}</textarea>\n            </div>\n          </div>\n          <div class=\"modal-footer\" style=\"padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px;\">\n            <button class=\"btn btn-secondary\" onclick=\"document.getElementById('sopModal').remove()\">Cancel</button>\n            <button class=\"btn btn-primary\" onclick=\"HubSOP.update()\">Save Changes</button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async save() {\n    const data = {\n      scenario_key: document.getElementById('sopKey')?.value.trim(),\n      scenario_name: document.getElementById('sopName')?.value.trim(),\n      case_type: document.getElementById('sopCategory')?.value,\n      sop_url: document.getElementById('sopUrl')?.value.trim(),\n      description: document.getElementById('sopDescription')?.value.trim()\n    };\n\n    if (!data.scenario_key || !data.scenario_name || !data.sop_url) {\n      HubUI.showToast('Please fill in all required fields', 'error');\n      return;\n    }\n\n    try {\n      const result = await HubAPI.post('/hub/api/sop', data);\n      if (result.success) {\n        HubUI.showToast('SOP link added successfully', 'success');\n        document.getElementById('sopModal')?.remove();\n        this.load();\n      } else {\n        HubUI.showToast(result.error || 'Failed to add SOP', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to add SOP', 'error');\n    }\n  },\n\n  async update() {\n    const sopId = document.getElementById('sopEditId')?.value;\n    const data = {\n      scenario_name: document.getElementById('sopName')?.value.trim(),\n      case_type: document.getElementById('sopCategory')?.value,\n      sop_url: document.getElementById('sopUrl')?.value.trim(),\n      description: document.getElementById('sopDescription')?.value.trim()\n    };\n\n    if (!data.scenario_name || !data.sop_url) {\n      HubUI.showToast('Please fill in all required fields', 'error');\n      return;\n    }\n\n    try {\n      const result = await HubAPI.put(`/hub/api/sop/${sopId}`, data);\n      if (result.success) {\n        HubUI.showToast('SOP link updated successfully', 'success');\n        document.getElementById('sopModal')?.remove();\n        this.load();\n      } else {\n        HubUI.showToast(result.error || 'Failed to update SOP', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to update SOP', 'error');\n    }\n  },\n\n  async delete(sopId) {\n    if (!confirm('Are you sure you want to delete this SOP link?')) return;\n\n    try {\n      const result = await HubAPI.delete(`/hub/api/sop/${sopId}`);\n      if (result.success) {\n        HubUI.showToast('SOP link deleted', 'success');\n        this.load();\n      } else {\n        HubUI.showToast(result.error || 'Failed to delete SOP', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to delete SOP', 'error');\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// EMAIL TEMPLATES PAGE\n// ============================================\nconst HubEmailTemplates = {\n  templates: [],\n  currentCategory: '',\n\n  async load() {\n    HubUI.showLoading();\n    try {\n      const url = this.currentCategory \n        ? `/hub/api/email-templates?category=${this.currentCategory}` \n        : '/hub/api/email-templates';\n      const result = await HubAPI.get(url);\n      this.templates = result.templates || [];\n      this.render();\n      \n      // Show add button for admins\n      const addBtn = document.getElementById('addTemplateBtn');\n      if (addBtn) {\n        addBtn.style.display = HubAuth.isAdmin() ? 'inline-flex' : 'none';\n      }\n    } catch (e) {\n      console.error('Failed to load email templates:', e);\n      HubUI.showToast('Failed to load email templates', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  getPlaceholderTemplates() {\n    return [\n      // Refund Templates\n      {\n        id: 'pt1',\n        template_name: 'Full Refund Confirmation',\n        category: 'refund',\n        subject: 'Your Refund Has Been Processed - Order {{order_number}}',\n        body: `Hi {{customer_name}},\n\nGreat news! Your refund of {{refund_amount}} has been processed for order {{order_number}}.\n\nPlease allow 5-10 business days for the refund to appear in your account, depending on your bank.\n\nIf you have any questions, feel free to reply to this email.\n\nThank you for your patience!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name', 'order_number', 'refund_amount']\n      },\n      {\n        id: 'pt2',\n        template_name: 'Partial Refund - Quality Issue',\n        category: 'refund',\n        subject: 'Partial Refund Processed - Order {{order_number}}',\n        body: `Hi {{customer_name}},\n\nWe're sorry to hear about the quality issue you experienced with your order.\n\nWe've processed a partial refund of {{refund_amount}} for order {{order_number}} as a gesture of goodwill.\n\nThe refund should appear in your account within 5-10 business days.\n\nWe truly appreciate your feedback as it helps us improve our products!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name', 'order_number', 'refund_amount']\n      },\n      {\n        id: 'pt3',\n        template_name: 'Partial Refund - Dog Not Using',\n        category: 'refund',\n        subject: 'We Understand - Partial Refund for Order {{order_number}}',\n        body: `Hi {{customer_name}},\n\nWe understand that every pup is different, and sometimes it takes time for them to adjust to new products.\n\nAs discussed, we've processed a partial refund of {{refund_amount}} for your order {{order_number}}.\n\nHere are some tips that might help:\n- Place the PuppyPad in a familiar spot\n- Use positive reinforcement when your dog shows interest\n- Give it a few more days for them to get comfortable\n\nIf you have any questions, we're here to help!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name', 'order_number', 'refund_amount']\n      },\n      \n      // Shipping Templates\n      {\n        id: 'pt4',\n        template_name: 'Reship Confirmation',\n        category: 'shipping',\n        subject: 'Your Replacement Order is On the Way! - Order {{order_number}}',\n        body: `Hi {{customer_name}},\n\nGood news! We've shipped a replacement for your order {{order_number}}.\n\nYou should receive tracking information within 24-48 hours once the shipment is processed by our carrier.\n\nWe sincerely apologize for any inconvenience and appreciate your patience!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name', 'order_number']\n      },\n      {\n        id: 'pt5',\n        template_name: 'Missing Item - Investigation',\n        category: 'shipping',\n        subject: 'Update on Your Missing Item - Order {{order_number}}',\n        body: `Hi {{customer_name}},\n\nWe're currently investigating the missing item from your order {{order_number}}.\n\nOur team is working with the carrier to locate your package. We'll provide an update within 48 hours with either tracking information or a replacement shipment.\n\nThank you for your patience!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name', 'order_number']\n      },\n      \n      // Subscription Templates\n      {\n        id: 'pt6',\n        template_name: 'Subscription Paused',\n        category: 'subscription',\n        subject: 'Your PuppyPad Subscription Has Been Paused',\n        body: `Hi {{customer_name}},\n\nAs requested, we've paused your PuppyPad subscription.\n\nYour subscription will remain paused until you're ready to resume. You can reactivate it anytime by:\n- Logging into your account at puppypad.com\n- Replying to this email\n- Contacting our support team\n\nWe'll be here when you're ready to continue!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name']\n      },\n      {\n        id: 'pt7',\n        template_name: 'Subscription Cancelled',\n        category: 'subscription',\n        subject: 'Your PuppyPad Subscription Has Been Cancelled',\n        body: `Hi {{customer_name}},\n\nYour PuppyPad subscription has been cancelled as requested.\n\nWe're sorry to see you go! If there's anything we could have done better, we'd love to hear your feedback.\n\nYou're always welcome back - just visit puppypad.com to restart your subscription anytime.\n\nThank you for being a PuppyPad customer!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name']\n      },\n      {\n        id: 'pt8',\n        template_name: 'Subscription Frequency Changed',\n        category: 'subscription',\n        subject: 'Your Subscription Has Been Updated',\n        body: `Hi {{customer_name}},\n\nWe've updated your subscription delivery frequency as requested.\n\nYour new delivery schedule: {{resolution}}\n\nYour next shipment will be scheduled according to this new frequency.\n\nIf you need any further adjustments, just let us know!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name', 'resolution']\n      },\n      \n      // Return Templates\n      {\n        id: 'pt9',\n        template_name: 'Return Instructions',\n        category: 'return',\n        subject: 'Return Instructions - Order {{order_number}}',\n        body: `Hi {{customer_name}},\n\nYour return request for order {{order_number}} has been approved!\n\nPlease ship the items back to:\nPuppyPad Returns\n[Your Return Address Here]\n\nImportant notes:\n- Please include your order number inside the package\n- Use a trackable shipping method\n- Items must be returned within 14 days\n\nOnce we receive and process your return, your refund of {{refund_amount}} will be issued within 5-7 business days.\n\nThank you!\n\nBest regards,\nThe PuppyPad Team`,\n        variables: ['customer_name', 'order_number', 'refund_amount']\n      }\n    ];\n  },\n\n  render() {\n    const container = document.getElementById('emailTemplatesList');\n    if (!container) return;\n\n    // Use placeholder templates if none exist\n    const templatesToRender = this.templates.length > 0 ? this.templates : this.getPlaceholderTemplates();\n    const isPlaceholder = this.templates.length === 0;\n\n    // Filter by category if set\n    const filteredTemplates = this.currentCategory \n      ? templatesToRender.filter(t => t.category === this.currentCategory)\n      : templatesToRender;\n\n    if (filteredTemplates.length === 0) {\n      container.innerHTML = `\n        <div class=\"empty-state\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\"></path></svg>\n          <h3>No Email Templates Found</h3>\n          <p>Add email templates to help your team respond quickly.</p>\n          ${HubAuth.isAdmin() ? '<button class=\"btn btn-primary\" onclick=\"HubEmailTemplates.showAddModal()\">Add First Template</button>' : ''}\n        </div>\n      `;\n      return;\n    }\n\n    // Group templates by category\n    const grouped = {};\n    filteredTemplates.forEach(template => {\n      if (!grouped[template.category]) grouped[template.category] = [];\n      grouped[template.category].push(template);\n    });\n\n    const categoryLabels = {\n      'refund': { label: 'Refund Confirmations', icon: '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><circle cx=\"12\" cy=\"12\" r=\"10\"/><path d=\"M16 8h-6a2 2 0 100 4h4a2 2 0 110 4H8\"/><path d=\"M12 18V6\"/></svg>', color: '#ef4444' },\n      'shipping': { label: 'Shipping & Delivery', icon: '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M21 16V8a2 2 0 00-1-1.73l-7-4a2 2 0 00-2 0l-7 4A2 2 0 003 8v8a2 2 0 001 1.73l7 4a2 2 0 002 0l7-4A2 2 0 0021 16z\"/><polyline points=\"3.27,6.96 12,12.01 20.73,6.96\"/><line x1=\"12\" y1=\"22.08\" x2=\"12\" y2=\"12\"/></svg>', color: '#3b82f6' },\n      'subscription': { label: 'Subscription Updates', icon: '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M23 4v6h-6\"/><path d=\"M1 20v-6h6\"/><path d=\"M3.51 9a9 9 0 0114.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0020.49 15\"/></svg>', color: '#8b5cf6' },\n      'return': { label: 'Returns & Exchanges', icon: '<svg viewBox=\"0 0 24 24\" fill=\"none\" stroke=\"currentColor\" stroke-width=\"2\" stroke-linecap=\"round\" stroke-linejoin=\"round\"><path d=\"M3 9l9-7 9 7v11a2 2 0 01-2 2H5a2 2 0 01-2-2z\"/><polyline points=\"9,22 9,12 15,12 15,22\"/></svg>', color: '#f59e0b' }\n    };\n\n    let html = '';\n    \n    if (isPlaceholder) {\n      html += `\n        <div class=\"sop-placeholder-banner\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"20\" height=\"20\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>\n          <span>These are placeholder templates with dynamic variables. Edit to customize for your brand.</span>\n        </div>\n      `;\n    }\n\n    Object.entries(grouped).forEach(([category, templates]) => {\n      const cat = categoryLabels[category] || { label: category, icon: 'ðŸ“‹', color: '#6b7280' };\n      html += `\n        <div class=\"template-category-section\">\n          <div class=\"sop-category-header\">\n            <span class=\"sop-category-icon\">${cat.icon}</span>\n            <span class=\"sop-category-title\">${cat.label}</span>\n            <span class=\"sop-category-count\">${templates.length} templates</span>\n          </div>\n          <div class=\"template-cards-grid\">\n            ${templates.map(template => `\n              <div class=\"template-card ${isPlaceholder ? 'placeholder' : ''}\">\n                <div class=\"template-card-header\">\n                  <h3 class=\"template-card-title\">${this.escapeHtml(template.template_name)}</h3>\n                </div>\n                <div class=\"template-card-preview\">${this.escapeHtml(template.body.substring(0, 150))}...</div>\n                <div class=\"template-card-variables\">\n                  <span class=\"variables-label\">Variables:</span>\n                  ${(template.variables || []).map(v => `<span class=\"template-variable\">{{${v}}}</span>`).join('')}\n                </div>\n                <div class=\"template-card-actions\">\n                  <button class=\"btn btn-primary btn-sm\" onclick=\"HubEmailTemplates.${isPlaceholder ? 'copyPlaceholder' : 'copyToClipboard'}('${template.id}')\">\n                    <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"14\" height=\"14\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\"></path></svg>\n                    Copy\n                  </button>\n                  <button class=\"btn btn-secondary btn-sm\" onclick=\"HubEmailTemplates.${isPlaceholder ? 'previewPlaceholder' : 'preview'}('${template.id}')\">Preview</button>\n                  ${HubAuth.isAdmin() && !isPlaceholder ? `\n                    <button class=\"btn btn-secondary btn-sm\" onclick=\"HubEmailTemplates.showEditModal(${template.id})\">Edit</button>\n                  ` : ''}\n                </div>\n              </div>\n            `).join('')}\n          </div>\n        </div>\n      `;\n    });\n\n    container.innerHTML = html;\n  },\n\n  copyPlaceholder(templateId) {\n    const templates = this.getPlaceholderTemplates();\n    const template = templates.find(t => t.id === templateId);\n    if (!template) return;\n\n    navigator.clipboard.writeText(template.body).then(() => {\n      HubUI.showToast('Template copied! Variables will need to be replaced manually.', 'success');\n    }).catch(() => {\n      HubUI.showToast('Failed to copy template', 'error');\n    });\n  },\n\n  async previewPlaceholder(templateId) {\n    const templates = this.getPlaceholderTemplates();\n    const template = templates.find(t => t.id === templateId);\n    if (!template) return;\n\n    // Fetch cases for this template's category\n    let relatedCases = [];\n    try {\n      const response = await HubAPI.get('/hub/api/cases/by-category?category=' + encodeURIComponent(template.category) + '&limit=15');\n      relatedCases = response.cases || [];\n    } catch (e) {\n      console.warn('Could not load related cases:', e);\n    }\n\n    const casesDropdownOptions = relatedCases.length > 0 \n      ? relatedCases.map(c => `<option value=\"${c.case_id}\">${c.customer_name || 'Unknown'} - ${c.order_number || 'N/A'} (${c.status})</option>`).join('')\n      : '<option value=\"\">No cases available for this category</option>';\n\n    const html = `\n      <div class=\"modal-overlay active\" id=\"templatePreviewModal\">\n        <div class=\"modal email-template-modal\" style=\"max-width: 700px;\">\n          <div class=\"modal-header\">\n            <h2 class=\"modal-title\">${this.escapeHtml(template.template_name)}</h2>\n            <button class=\"modal-close\" onclick=\"document.getElementById('templatePreviewModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <!-- Template Preview Section -->\n            <div class=\"template-preview-section\">\n              <div id=\"previewBody\" class=\"template-preview-content\" style=\"padding: 20px; background: var(--gray-50); border-radius: 8px; white-space: pre-wrap; font-size: 14px; line-height: 1.7; max-height: 350px; overflow-y: auto;\">\n${this.escapeHtml(template.body)}\n              </div>\n            </div>\n            \n            <!-- Variables Info -->\n            <div style=\"margin-top: 16px; padding: 12px; background: var(--primary-50); border-radius: 8px; border: 1px solid var(--primary-200);\">\n              <strong style=\"color: var(--primary-700); font-size: 13px;\">Dynamic Variables:</strong>\n              <div class=\"template-variables-list\" style=\"display: flex; flex-wrap: wrap; gap: 6px; margin-top: 8px;\">\n                ${(template.variables || []).map(v => `<span class=\"template-variable-badge\">{{${v}}}</span>`).join('')}\n              </div>\n            </div>\n\n            <!-- Live Preview Section -->\n            <div style=\"margin-top: 20px; padding-top: 20px; border-top: 1px solid var(--gray-200);\">\n              <strong style=\"color: var(--gray-700); font-size: 14px;\">ðŸ“‹ Live Preview with Real Case Data</strong>\n              <p style=\"font-size: 12px; color: var(--gray-500); margin-top: 4px; margin-bottom: 12px;\">\n                Select a case below to see how the email would look with actual customer data.\n              </p>\n              <select id=\"livePreviewCaseSelect\" class=\"case-selector-dropdown\" onchange=\"HubEmailTemplates.updateLivePreview('${template.id}', this.value)\" style=\"width: 100%; padding: 10px 12px; border: 1px solid var(--gray-300); border-radius: 8px; font-size: 14px; background: white;\">\n                <option value=\"\">-- Select a case for live preview --</option>\n                ${casesDropdownOptions}\n              </select>\n            </div>\n          </div>\n          <div class=\"modal-footer\" style=\"padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;\">\n            <span id=\"previewStatus\" style=\"font-size: 12px; color: var(--gray-500);\">Showing template with variables</span>\n            <button class=\"btn btn-primary\" onclick=\"HubEmailTemplates.copyTemplateBody('${template.id}'); document.getElementById('templatePreviewModal').remove();\">Copy Template</button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n    \n    // Store selected case data for copy function\n    this.currentPreviewCaseData = null;\n  },\n\n  copyTemplateBody(templateId) {\n    const templates = this.getPlaceholderTemplates();\n    const template = templates.find(t => t.id === templateId);\n    if (!template) return;\n\n    let textToCopy = template.body;\n    \n    // If we have case data loaded, use the rendered version\n    if (this.currentPreviewCaseData) {\n      textToCopy = this.renderTemplateWithCase(template.body, this.currentPreviewCaseData);\n    }\n    \n    navigator.clipboard.writeText(textToCopy).then(() => {\n      HubUI.showToast('Email template copied!', 'success');\n    }).catch(() => {\n      HubUI.showToast('Failed to copy template', 'error');\n    });\n  },\n\n  renderTemplateWithCase(body, caseData) {\n    // Use first name only for more personal greeting\n    const firstName = (caseData.customer_name || 'Valued Customer').split(' ')[0];\n    const replacements = {\n      'customer_name': firstName,\n      'customer_first_name': firstName,\n      'order_number': caseData.order_number || 'N/A',\n      'refund_amount': caseData.refund_amount ? '$' + parseFloat(caseData.refund_amount).toFixed(2) : '$0.00',\n      'resolution': caseData.resolution || 'your request',\n      'case_id': caseData.case_id || '',\n      'case_type': caseData.case_type || '',\n      'tracking_number': caseData.tracking_number || 'N/A',\n      'new_tracking_number': caseData.new_tracking_number || 'N/A',\n      'discount_code': caseData.discount_code || 'PUPPYPAD10',\n      'discount_amount': caseData.discount_amount || '10%',\n      'pause_date': caseData.pause_date || 'your requested date',\n      'resume_date': caseData.resume_date || 'when you\\'re ready'\n    };\n\n    let rendered = body;\n    Object.entries(replacements).forEach(([key, value]) => {\n      const regex = new RegExp('\\\\{\\\\{' + key + '\\\\}\\\\}', 'g');\n      rendered = rendered.replace(regex, value);\n    });\n    return rendered;\n  },\n\n  async updateLivePreview(templateId, caseId) {\n    const templates = this.getPlaceholderTemplates();\n    const template = templates.find(t => t.id === templateId);\n    if (!template) return;\n\n    const previewBody = document.getElementById('previewBody');\n    const previewStatus = document.getElementById('previewStatus');\n\n    if (!caseId) {\n      // Reset to template with variables\n      previewBody.innerHTML = this.escapeHtml(template.body);\n      previewStatus.textContent = 'Showing template with variables';\n      previewStatus.style.color = 'var(--gray-500)';\n      this.currentPreviewCaseData = null;\n      return;\n    }\n\n    previewStatus.textContent = 'Loading case data...';\n    previewStatus.style.color = 'var(--primary-600)';\n\n    try {\n      // Fetch case data\n      const response = await HubAPI.get('/hub/api/case/' + caseId);\n      \n      // Handle both direct response and nested response\n      const caseData = response.case || response;\n      \n      // Store for copy function\n      this.currentPreviewCaseData = caseData;\n      \n      // Render the template\n      const renderedBody = this.renderTemplateWithCase(template.body, caseData);\n\n      previewBody.innerHTML = this.escapeHtml(renderedBody);\n      previewStatus.innerHTML = 'âœ“ Showing live preview for <strong>' + this.escapeHtml(caseData.customer_name || 'Unknown') + '</strong>';\n      previewStatus.style.color = 'var(--success-600)';\n    } catch (e) {\n      console.error('Failed to load case data:', e);\n      previewStatus.textContent = 'Failed to load case data';\n      previewStatus.style.color = 'var(--error-600)';\n      this.currentPreviewCaseData = null;\n    }\n  },\n\n  filterByCategory(category) {\n    this.currentCategory = category;\n    \n    // Update tab states\n    document.querySelectorAll('.template-tab').forEach(tab => {\n      tab.classList.toggle('active', tab.dataset.category === category);\n    });\n    \n    this.load();\n  },\n\n  async copyToClipboard(templateId) {\n    const template = this.templates.find(t => t.id === templateId);\n    if (!template) return;\n\n    const textToCopy = `Subject: ${template.subject}\\n\\n${template.body}`;\n    \n    try {\n      await navigator.clipboard.writeText(textToCopy);\n      HubUI.showToast('Template copied to clipboard', 'success');\n    } catch (e) {\n      // Fallback for older browsers\n      const textarea = document.createElement('textarea');\n      textarea.value = textToCopy;\n      document.body.appendChild(textarea);\n      textarea.select();\n      document.execCommand('copy');\n      document.body.removeChild(textarea);\n      HubUI.showToast('Template copied to clipboard', 'success');\n    }\n  },\n\n  preview(templateId) {\n    const template = this.templates.find(t => t.id === templateId);\n    if (!template) return;\n\n    const html = `\n      <div class=\"modal-overlay active\" id=\"templatePreviewModal\">\n        <div class=\"modal\" style=\"max-width: 600px;\">\n          <div class=\"modal-header\">\n            <h2 class=\"modal-title\">${this.escapeHtml(template.template_name)}</h2>\n            <button class=\"modal-close\" onclick=\"document.getElementById('templatePreviewModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <div style=\"margin-bottom: 16px;\">\n              <strong style=\"color: var(--gray-600);\">Subject:</strong>\n              <div style=\"padding: 12px; background: var(--gray-50); border-radius: 8px; margin-top: 8px;\">\n                ${this.escapeHtml(template.subject)}\n              </div>\n            </div>\n            <div>\n              <strong style=\"color: var(--gray-600);\">Body:</strong>\n              <div style=\"padding: 16px; background: var(--gray-50); border-radius: 8px; margin-top: 8px; white-space: pre-wrap; font-size: 14px; line-height: 1.6;\">\n${this.escapeHtml(template.body)}\n              </div>\n            </div>\n            <div style=\"margin-top: 16px;\">\n              <strong style=\"color: var(--gray-600);\">Variables:</strong>\n              <div style=\"display: flex; flex-wrap: wrap; gap: 8px; margin-top: 8px;\">\n                ${(template.variables || []).map(v => `<span class=\"template-variable\">{{${v}}}</span>`).join('')}\n              </div>\n            </div>\n          </div>\n          <div class=\"modal-footer\" style=\"padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end;\">\n            <button class=\"btn btn-primary\" onclick=\"HubEmailTemplates.copyToClipboard(${template.id}); document.getElementById('templatePreviewModal').remove();\">Copy Template</button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  showAddModal() {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"templateModal\">\n        <div class=\"modal\" style=\"max-width: 600px;\">\n          <div class=\"modal-header\">\n            <h2 class=\"modal-title\">Add Email Template</h2>\n            <button class=\"modal-close\" onclick=\"document.getElementById('templateModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px; max-height: 70vh; overflow-y: auto;\">\n            <div class=\"form-group\">\n              <label>Template Key *</label>\n              <input type=\"text\" id=\"templateKey\" placeholder=\"e.g., refund_confirmation\">\n            </div>\n            <div class=\"form-group\">\n              <label>Template Name *</label>\n              <input type=\"text\" id=\"templateName\" placeholder=\"e.g., Refund Confirmation\">\n            </div>\n            <div class=\"form-group\">\n              <label>Category *</label>\n              <select id=\"templateCategory\">\n                <option value=\"refund\">Refund</option>\n                <option value=\"return\">Return</option>\n                <option value=\"shipping\">Shipping</option>\n                <option value=\"subscription\">Subscription</option>\n                <option value=\"manual\">Manual</option>\n              </select>\n            </div>\n            <div class=\"form-group\">\n              <label>Subject *</label>\n              <input type=\"text\" id=\"templateSubject\" placeholder=\"Use {{variables}} for dynamic content\">\n            </div>\n            <div class=\"form-group\">\n              <label>Body *</label>\n              <textarea id=\"templateBody\" rows=\"10\" placeholder=\"Use {{variables}} like {{first_name}}, {{order_number}}, {{refund_amount}}\"></textarea>\n            </div>\n            <div class=\"form-group\">\n              <label>Description</label>\n              <input type=\"text\" id=\"templateDescription\" placeholder=\"When to use this template\">\n            </div>\n          </div>\n          <div class=\"modal-footer\" style=\"padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px;\">\n            <button class=\"btn btn-secondary\" onclick=\"document.getElementById('templateModal').remove()\">Cancel</button>\n            <button class=\"btn btn-primary\" onclick=\"HubEmailTemplates.save()\">Save</button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async showEditModal(templateId) {\n    const template = this.templates.find(t => t.id === templateId);\n    if (!template) return;\n\n    const html = `\n      <div class=\"modal-overlay active\" id=\"templateModal\">\n        <div class=\"modal\" style=\"max-width: 600px;\">\n          <div class=\"modal-header\">\n            <h2 class=\"modal-title\">Edit Email Template</h2>\n            <button class=\"modal-close\" onclick=\"document.getElementById('templateModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px; max-height: 70vh; overflow-y: auto;\">\n            <input type=\"hidden\" id=\"templateEditId\" value=\"${template.id}\">\n            <div class=\"form-group\">\n              <label>Template Name *</label>\n              <input type=\"text\" id=\"templateName\" value=\"${this.escapeHtml(template.template_name)}\">\n            </div>\n            <div class=\"form-group\">\n              <label>Category *</label>\n              <select id=\"templateCategory\">\n                ${['refund', 'return', 'shipping', 'subscription', 'manual'].map(c =>\n                  `<option value=\"${c}\" ${template.category === c ? 'selected' : ''}>${c.charAt(0).toUpperCase() + c.slice(1)}</option>`\n                ).join('')}\n              </select>\n            </div>\n            <div class=\"form-group\">\n              <label>Subject *</label>\n              <input type=\"text\" id=\"templateSubject\" value=\"${this.escapeHtml(template.subject)}\">\n            </div>\n            <div class=\"form-group\">\n              <label>Body *</label>\n              <textarea id=\"templateBody\" rows=\"10\">${this.escapeHtml(template.body)}</textarea>\n            </div>\n            <div class=\"form-group\">\n              <label>Description</label>\n              <input type=\"text\" id=\"templateDescription\" value=\"${this.escapeHtml(template.description || '')}\">\n            </div>\n          </div>\n          <div class=\"modal-footer\" style=\"padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end; gap: 12px;\">\n            <button class=\"btn btn-secondary\" onclick=\"document.getElementById('templateModal').remove()\">Cancel</button>\n            <button class=\"btn btn-primary\" onclick=\"HubEmailTemplates.update()\">Save Changes</button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  extractVariables(text) {\n    const matches = text.match(/\\{\\{(\\w+)\\}\\}/g) || [];\n    return [...new Set(matches.map(m => m.replace(/\\{\\{|\\}\\}/g, '')))];\n  },\n\n  async save() {\n    const body = document.getElementById('templateBody')?.value.trim() || '';\n    const subject = document.getElementById('templateSubject')?.value.trim() || '';\n    const variables = [...new Set([...this.extractVariables(subject), ...this.extractVariables(body)])];\n\n    const data = {\n      template_key: document.getElementById('templateKey')?.value.trim(),\n      template_name: document.getElementById('templateName')?.value.trim(),\n      category: document.getElementById('templateCategory')?.value,\n      subject,\n      body,\n      variables,\n      description: document.getElementById('templateDescription')?.value.trim()\n    };\n\n    if (!data.template_key || !data.template_name || !data.subject || !data.body) {\n      HubUI.showToast('Please fill in all required fields', 'error');\n      return;\n    }\n\n    try {\n      const result = await HubAPI.post('/hub/api/email-templates', data);\n      if (result.success) {\n        HubUI.showToast('Email template added successfully', 'success');\n        document.getElementById('templateModal')?.remove();\n        this.load();\n      } else {\n        HubUI.showToast(result.error || 'Failed to add template', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to add template', 'error');\n    }\n  },\n\n  async update() {\n    const templateId = document.getElementById('templateEditId')?.value;\n    const body = document.getElementById('templateBody')?.value.trim() || '';\n    const subject = document.getElementById('templateSubject')?.value.trim() || '';\n    const variables = [...new Set([...this.extractVariables(subject), ...this.extractVariables(body)])];\n\n    const data = {\n      template_name: document.getElementById('templateName')?.value.trim(),\n      category: document.getElementById('templateCategory')?.value,\n      subject,\n      body,\n      variables,\n      description: document.getElementById('templateDescription')?.value.trim()\n    };\n\n    if (!data.template_name || !data.subject || !data.body) {\n      HubUI.showToast('Please fill in all required fields', 'error');\n      return;\n    }\n\n    try {\n      const result = await HubAPI.put(`/hub/api/email-templates/${templateId}`, data);\n      if (result.success) {\n        HubUI.showToast('Email template updated successfully', 'success');\n        document.getElementById('templateModal')?.remove();\n        this.load();\n      } else {\n        HubUI.showToast(result.error || 'Failed to update template', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to update template', 'error');\n    }\n  },\n\n  async delete(templateId) {\n    if (!confirm('Are you sure you want to delete this email template?')) return;\n\n    try {\n      const result = await HubAPI.delete(`/hub/api/email-templates/${templateId}`);\n      if (result.success) {\n        HubUI.showToast('Email template deleted', 'success');\n        this.load();\n      } else {\n        HubUI.showToast(result.error || 'Failed to delete template', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to delete template', 'error');\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// CASE DETAIL PAGE (Full Page View)\n// ============================================\nconst HubCaseDetail = {\n  caseData: null,\n  activities: [],\n  comments: [],\n  sopLink: null,\n  emailTemplates: [],\n  shopifyOrder: null,\n\n  async load(caseId) {\n    if (!caseId) {\n      HubNavigation.goto('cases');\n      return;\n    }\n\n    HubUI.showLoading();\n    try {\n      const result = await HubAPI.get(`/hub/api/case/${caseId}`);\n      if (!result.case) {\n        HubUI.showToast('Case not found', 'error');\n        HubNavigation.goto('cases');\n        return;\n      }\n\n      this.caseData = result.case;\n      this.activities = result.activities || [];\n      this.comments = result.comments || [];\n      this.sopLink = result.sop_link;\n      this.emailTemplates = result.email_templates || [];\n      this.shopifyOrder = result.shopify_order;\n\n      // Store in HubState for keyboard shortcuts etc\n      HubState.currentCase = this.caseData;\n\n      // Fetch formatted details from OpenAI (in background, don't block initial render)\n      console.log('ðŸ” HubCaseDetail.load: About to call loadFormattedDetails for case:', this.caseData.case_id);\n      this.loadFormattedDetails().catch(err => {\n        console.error('âŒ HubCaseDetail.load: Error calling loadFormattedDetails:', err);\n      });\n\n      this.render();\n    } catch (e) {\n      console.error('Failed to load case:', e);\n      HubUI.showToast('Failed to load case details', 'error');\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  render() {\n    const container = document.getElementById('caseDetailContent');\n    if (!container || !this.caseData) return;\n\n    const c = this.caseData;\n    const dueDate = c.due_date ? new Date(c.due_date) : null;\n    const isOverdue = c.is_overdue;\n    const hoursLeft = dueDate ? Math.max(0, Math.round((dueDate - new Date()) / (1000 * 60 * 60))) : null;\n\n    // Get prev/next case info\n    const currentIndex = HubState.currentCaseIndex;\n    const prevCase = currentIndex > 0 ? HubState.cases[currentIndex - 1] : null;\n    const nextCase = currentIndex < HubState.cases.length - 1 ? HubState.cases[currentIndex + 1] : null;\n\n    container.innerHTML = `\n      <!-- Case Navigation -->\n      <div class=\"case-nav-buttons\">\n        <button class=\"case-nav-btn\" onclick=\"HubNavigation.goto('cases')\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M10 19l-7-7m0 0l7-7m-7 7h18\"></path></svg>\n          Back to Cases\n        </button>\n        <span class=\"case-nav-divider\"></span>\n        <button class=\"case-nav-btn\" onclick=\"HubCases.navigateCase('prev')\" ${!prevCase ? 'disabled' : ''}>\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 19l-7-7 7-7\"></path></svg>\n          Previous\n        </button>\n        <button class=\"case-nav-btn\" onclick=\"HubCases.navigateCase('next')\" ${!nextCase ? 'disabled' : ''}>\n          Next\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 5l7 7-7 7\"></path></svg>\n        </button>\n      </div>\n\n      <!-- Case Header - Customer Name as Title -->\n      <div class=\"case-detail-header\">\n          <div class=\"case-detail-title\">\n            <div class=\"case-detail-customer-name\">\n              ${HubHelpers.formatName(c.customer_name)}\n              <span class=\"status-badge ${(c.status || 'pending').replace('_', '-')}\">${this.formatStatus(c.status)}</span>\n              ${c.resolved_in_app ? '' : `<span class=\"type-badge ${c.case_type || ''}\">${c.case_type || 'N/A'}</span>`}\n            </div>\n          <div class=\"case-detail-email-row\">\n            <a href=\"mailto:${c.customer_email}\">${this.escapeHtml(c.customer_email || '-')}</a>\n            <button class=\"copy-btn\" onclick=\"HubCaseDetail.copyToClipboard('${this.escapeHtml(c.customer_email || '')}', this)\" title=\"Copy email\">\n              <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\"></path></svg>\n            </button>\n          </div>\n          <div class=\"case-detail-id-row\">\n            <span>Case ID: ${this.escapeHtml(c.case_id)}</span>\n            <button class=\"copy-btn\" onclick=\"HubCaseDetail.copyToClipboard('${this.escapeHtml(c.case_id)}', this)\" title=\"Copy case ID\">\n              <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 16H6a2 2 0 01-2-2V6a2 2 0 012-2h8a2 2 0 012 2v2m-6 12h8a2 2 0 002-2v-8a2 2 0 00-2-2h-8a2 2 0 00-2 2v8a2 2 0 002 2z\"></path></svg>\n            </button>\n          </div>\n        </div>\n        <div class=\"case-detail-due ${isOverdue ? 'overdue' : hoursLeft < 8 ? 'warning' : 'ok'}\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 8v4l3 3m6-3a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>\n          ${isOverdue ? 'Overdue' : hoursLeft !== null ? hoursLeft + 'h left' : 'No due date'}\n        </div>\n      </div>\n\n      <!-- Main Grid -->\n      <div class=\"case-detail-grid\">\n        <!-- Left Column - Main Info -->\n        <div class=\"case-detail-main\">\n          <!-- Order Details -->\n          <div class=\"case-detail-section\">\n            <div class=\"case-detail-section-header\">Order Details</div>\n            <div class=\"case-detail-section-content\">\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Order Number</div>\n                <div class=\"case-info-value\">\n                  ${c.order_url ? `<a href=\"${c.order_url}\" target=\"_blank\">${this.escapeHtml(c.order_number || '-')}</a>` : this.escapeHtml(c.order_number || '-')}\n                </div>\n              </div>\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Order Date</div>\n                <div class=\"case-info-value\">${c.order_date ? this.formatDate(c.order_date) : '-'}</div>\n              </div>\n              ${this.shopifyOrder ? `\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Financial Status</div>\n                <div class=\"case-info-value\">${this.escapeHtml(this.shopifyOrder.financial_status || '-')}</div>\n              </div>\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Fulfillment</div>\n                <div class=\"case-info-value\">${this.escapeHtml(this.shopifyOrder.fulfillment_status || 'Unfulfilled')}</div>\n              </div>\n              ` : ''}\n              ${c.tracking_number ? `\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Tracking</div>\n                <div class=\"case-info-value\">${this.escapeHtml(c.tracking_number)}</div>\n              </div>\n              ` : ''}\n            </div>\n          </div>\n\n          <!-- Issue & Resolution -->\n          <div class=\"case-detail-section\">\n            <div class=\"case-detail-section-header\">Issue & Resolution</div>\n            <div class=\"case-detail-section-content\">\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Issue Reason</div>\n                <div class=\"case-info-value\">${this.formatIssueReason(c)}</div>\n              </div>\n              ${c.resolved_in_app ? '' : `\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Case Type</div>\n                <div class=\"case-info-value\"><span class=\"type-badge ${c.case_type || ''}\">${c.case_type || 'N/A'}</span></div>\n              </div>\n              `}\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Resolution</div>\n                <div class=\"case-info-value\">${this.formatResolution(c)}</div>\n              </div>\n              ${c.refund_amount ? `\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Refund Amount</div>\n                <div class=\"case-info-value\" style=\"font-weight: 600; color: var(--success-600);\">$${parseFloat(c.refund_amount).toFixed(2)}</div>\n              </div>\n              ` : ''}\n              ${c.selected_items && c.selected_items.length > 0 ? `\n              <div style=\"margin-top: 16px;\">\n                <div class=\"case-info-label\" style=\"margin-bottom: 8px;\">Selected Items</div>\n                <div class=\"selected-items-list\">\n                  ${c.selected_items.map(item => `\n                    <div class=\"selected-item\">\n                      <span class=\"selected-item-name\">${this.escapeHtml(item.title || item.name || 'Unknown Item')}</span>\n                      <span class=\"selected-item-qty\">x${item.quantity || 1}</span>\n                    </div>\n                  `).join('')}\n                </div>\n              </div>\n              ` : ''}\n            </div>\n          </div>\n\n          <!-- Activity & Comments -->\n          <div class=\"case-detail-section activity-section\">\n            <div class=\"case-detail-section-header\">\n              <span>Activity & Comments</span>\n              <span class=\"activity-count\">${(this.activities.length + this.comments.length)} items</span>\n            </div>\n            <div class=\"case-detail-section-content\">\n              <div class=\"activity-feed-redesigned\">\n                ${this.renderActivitiesRedesigned()}\n              </div>\n              <form class=\"comment-form-redesigned\" onsubmit=\"HubCaseDetail.addComment(event)\">\n                <div class=\"comment-input-container\">\n                  <div class=\"comment-avatar\">\n                    <span>${(HubState.currentUser?.name || 'T').charAt(0).toUpperCase()}</span>\n                  </div>\n                  <textarea id=\"newCommentText\" placeholder=\"Write a comment...\" rows=\"2\"></textarea>\n                </div>\n                <div class=\"comment-form-actions\">\n                  <button type=\"submit\" class=\"btn btn-primary\">\n                    <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 19l9 2-9-18-9 18 9-2zm0 0v-8\"></path></svg>\n                    Post Comment\n                  </button>\n                </div>\n              </form>\n            </div>\n          </div>\n        </div>\n\n        <!-- Right Column - Quick Actions -->\n        <div class=\"case-detail-sidebar\">\n          <!-- Status Update -->\n          <div class=\"case-detail-section\">\n            <div class=\"case-detail-section-header\">Status</div>\n            <div class=\"case-detail-section-content\">\n              <div class=\"status-radio-group\">\n                <label class=\"status-radio-item ${c.status === 'pending' ? 'selected' : ''}\" data-status=\"pending\" onclick=\"HubCaseDetail.selectStatus('pending', this)\">\n                  <input type=\"radio\" name=\"caseStatus\" value=\"pending\" ${c.status === 'pending' ? 'checked' : ''}>\n                  <span class=\"status-radio-check\"></span>\n                  <span class=\"status-radio-label\">Pending</span>\n                </label>\n                <label class=\"status-radio-item ${c.status === 'in_progress' ? 'selected' : ''}\" data-status=\"in_progress\" onclick=\"HubCaseDetail.selectStatus('in_progress', this)\">\n                  <input type=\"radio\" name=\"caseStatus\" value=\"in_progress\" ${c.status === 'in_progress' ? 'checked' : ''}>\n                  <span class=\"status-radio-check\"></span>\n                  <span class=\"status-radio-label\">In Progress</span>\n                </label>\n                <label class=\"status-radio-item ${c.status === 'completed' ? 'selected' : ''}\" data-status=\"completed\" onclick=\"HubCaseDetail.selectStatus('completed', this)\">\n                  <input type=\"radio\" name=\"caseStatus\" value=\"completed\" ${c.status === 'completed' ? 'checked' : ''}>\n                  <span class=\"status-radio-check\"></span>\n                  <span class=\"status-radio-label\">Completed</span>\n                </label>\n              </div>\n            </div>\n          </div>\n\n          <!-- Quick Actions -->\n          <div class=\"case-detail-section\">\n            <div class=\"case-detail-section-header\">Quick Actions</div>\n            <div class=\"case-detail-section-content\">\n              <div class=\"quick-actions-grid\">\n                ${c.order_url ? `\n                <a href=\"${c.order_url}\" target=\"_blank\" class=\"quick-action-btn\" onclick=\"HubCaseDetail.logActivity('viewed_shopify_order')\">\n                  <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 11V7a4 4 0 00-8 0v4M5 9h14l1 12H4L5 9z\"></path></svg>\n                  View Shopify Order\n                </a>\n                ` : ''}\n                \n                ${c.session_replay_url ? `\n                <a href=\"${c.session_replay_url}\" target=\"_blank\" class=\"quick-action-btn\" onclick=\"HubCaseDetail.logActivity('viewed_session_recording')\">\n                  <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 10l4.553-2.276A1 1 0 0121 8.618v6.764a1 1 0 01-1.447.894L15 14M5 18h8a2 2 0 002-2V8a2 2 0 00-2-2H5a2 2 0 00-2 2v8a2 2 0 002 2z\"></path></svg>\n                  View Session Recording\n                </a>\n                ` : ''}\n                \n                ${c.checkout_champ_url ? `\n                <a href=\"${c.checkout_champ_url}\" target=\"_blank\" class=\"quick-action-btn\" onclick=\"HubCaseDetail.logActivity('viewed_subscription')\">\n                  <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m0 0a8.003 8.003 0 01-15.357-2m15.357 2H15\"></path></svg>\n                  View Subscription\n                </a>\n                ` : ''}\n                \n                ${c.resolved_in_app ? '' : `\n                <!-- SOP Link -->\n                <a href=\"${this.sopLink?.sop_url || '/hub/sop'}\" target=\"_blank\" class=\"quick-action-btn sop-link\" onclick=\"HubCaseDetail.logActivity('clicked_sop', {sop_name: '${this.escapeHtml(this.sopLink?.scenario_name || c.case_type || '')}'})\">\n                  <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path></svg>\n                  ${this.sopLink ? `View SOP: ${this.escapeHtml(this.sopLink.scenario_name)}` : `View ${c.case_type || 'SOPs'}`}\n                </a>\n\n                <!-- Copy Email Template -->\n                <button class=\"quick-action-btn email-btn\" onclick=\"HubCaseDetail.showEmailTemplateModal()\">\n                  <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z\"></path></svg>\n                  Copy Email Template\n                </button>\n                `}\n              </div>\n            </div>\n          </div>\n\n          <!-- Case Meta -->\n          <div class=\"case-detail-section\">\n            <div class=\"case-detail-section-header\">Case Information</div>\n            <div class=\"case-detail-section-content\">\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Case ID</div>\n                <div class=\"case-info-value\" style=\"font-family: var(--font-mono); font-size: 12px;\">${this.escapeHtml(c.case_id)}</div>\n              </div>\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Created</div>\n                <div class=\"case-info-value\">${this.formatDate(c.created_at)}</div>\n              </div>\n              <div class=\"case-info-row\">\n                <div class=\"case-info-label\">Assigned To</div>\n                <div class=\"case-info-value\">${HubUsers.renderAssigneeCell(c.case_id, c.assigned_to)}</div>\n              </div>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n  },\n\n  // Load formatted details from OpenAI for the current case\n  async loadFormattedDetails() {\n    console.log('ðŸš€ loadFormattedDetails: Function called');\n    console.log('ðŸ“‹ loadFormattedDetails: this.caseData:', this.caseData);\n    \n    if (!this.caseData) {\n      console.warn('âš ï¸ loadFormattedDetails: No caseData available');\n      return;\n    }\n\n    if (!this.caseData.case_id) {\n      console.warn('âš ï¸ loadFormattedDetails: caseData exists but no case_id:', this.caseData);\n      return;\n    }\n\n    console.log('ðŸ”„ loadFormattedDetails: Loading formatted details for case:', this.caseData.case_id);\n    console.log('ðŸ“¦ loadFormattedDetails: Case type:', this.caseData.case_type, 'Resolution:', this.caseData.resolution);\n    console.log('ðŸ“¦ loadFormattedDetails: extra_data:', this.caseData.extra_data);\n    \n    try {\n      console.log('ðŸ“ž loadFormattedDetails: Calling HubCases.getFormattedDetails...');\n      const formatted = await HubCases.getFormattedDetails(this.caseData);\n      console.log('âœ… loadFormattedDetails: Received formatted details:', formatted);\n      \n      // Store on caseData for synchronous access\n      this.caseData._formattedIssueReason = formatted.issueReason;\n      this.caseData._formattedResolution = formatted.resolution;\n      console.log('ðŸ’¾ loadFormattedDetails: Stored formatted details on caseData');\n      \n      // Re-render to show updated details\n      console.log('ðŸ”„ loadFormattedDetails: Re-rendering...');\n      this.render();\n      console.log('âœ… loadFormattedDetails: Re-render complete');\n    } catch (e) {\n      console.error('âŒ loadFormattedDetails: Failed to load formatted details:', e);\n      console.error('âŒ loadFormattedDetails: Error stack:', e.stack);\n    }\n  },\n\n  formatIssueReason(c) {\n    // Use OpenAI-generated issue reason if available\n    if (c._formattedIssueReason) {\n      return c._formattedIssueReason;\n    }\n\n    // Fallback to basic formatting\n    const issueReasonMap = {\n      'quality_issue': 'Product quality issue',\n      'not_as_described': 'Product not as described',\n      'dog_not_using': 'My dog is not using the product',\n      'not_working': 'Product not working as expected',\n      'changed_mind': 'Changed my mind',\n      'found_cheaper': 'Found cheaper alternative',\n      'duplicate_order': 'Duplicate order',\n      'not_received': \"Haven't received my order\",\n      'tracking_issue': 'Tracking not updating',\n      'wrong_address': 'Shipped to wrong address',\n      'damaged_shipping': 'Damaged during shipping',\n      'missing_item': 'Missing item from order',\n      'wrong_item': 'Received wrong item',\n      'pause_subscription': 'Want to pause my subscription',\n      'cancel_subscription': 'Want to cancel subscription',\n      'change_frequency': 'Change delivery frequency',\n      'update_address': 'Update shipping address',\n      'too_much_product': 'Receiving too much product',\n      'return_exchange': 'Want to return for exchange',\n      'return_refund': 'Want to return for refund'\n    };\n    \n    const category = c.category || '';\n    const caseType = c.case_type || '';\n    const resolution = c.resolution || '';\n    \n    if (issueReasonMap[category]) {\n      return issueReasonMap[category];\n    }\n    \n    if (resolution.toLowerCase().includes('quality')) return 'Product quality issue';\n    if (resolution.toLowerCase().includes('not using')) return 'My dog is not using it';\n    if (resolution.toLowerCase().includes('pause')) return 'Want to pause subscription';\n    if (resolution.toLowerCase().includes('cancel')) return 'Want to cancel subscription';\n    if (resolution.toLowerCase().includes('missing')) return 'Missing item from order';\n    if (resolution.toLowerCase().includes('reship')) return \"Haven't received my order\";\n    \n    const defaultReasons = {\n      'refund': 'Requesting a refund',\n      'return': 'Want to return product',\n      'shipping': 'Issue with shipping/delivery',\n      'subscription': 'Subscription management request',\n      'manual': 'Requires manual review'\n    };\n    \n    return defaultReasons[caseType] || category || 'General inquiry';\n  },\n\n  renderActivities() {\n    // Keep old method for backwards compatibility\n    return this.renderActivitiesRedesigned();\n  },\n\n  renderActivitiesRedesigned() {\n    // Combine activities and comments, sorted by date (newest first)\n    const allActivities = [\n      ...this.activities.map(a => ({ ...a, _type: 'activity' })),\n      ...this.comments.map(c => ({ ...c, _type: 'comment', created_at: c.created_at }))\n    ].sort((a, b) => new Date(b.created_at) - new Date(a.created_at));\n\n    if (allActivities.length === 0) {\n      return `\n        <div class=\"activity-empty-state\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"48\" height=\"48\">\n            <path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"1.5\" d=\"M8 12h.01M12 12h.01M16 12h.01M21 12c0 4.418-4.03 8-9 8a9.863 9.863 0 01-4.255-.949L3 20l1.395-3.72C3.512 15.042 3 13.574 3 12c0-4.418 4.03-8 9-8s9 3.582 9 8z\"></path>\n          </svg>\n          <p>No activity yet</p>\n          <span>Comments and actions will appear here</span>\n        </div>\n      `;\n    }\n\n    // Group consecutive activities together, keep comments separate\n    let result = '';\n    let activityBuffer = [];\n    \n    const flushActivityBuffer = () => {\n      if (activityBuffer.length === 0) return '';\n      const grouped = activityBuffer.map(item => `\n        <div class=\"activity-log-item\">\n          <span class=\"activity-log-dot ${this.getActivityIconClass(item.activity_type)}\"></span>\n          <span class=\"activity-log-text\">${this.formatActivityTextCompact(item)}</span>\n          <span class=\"activity-log-time\">${this.timeAgo(item.created_at)}</span>\n        </div>\n      `).join('');\n      activityBuffer = [];\n      return `<div class=\"activity-log-group\">${grouped}</div>`;\n    };\n\n    allActivities.slice(0, 20).forEach(item => {\n      if (item._type === 'comment') {\n        // Flush any buffered activities first\n        result += flushActivityBuffer();\n        // Render comment prominently\n        const initials = (item.author_name || 'TM').split(' ').map(n => n[0]).join('').substring(0,2).toUpperCase();\n        result += `\n          <div class=\"comment-item\">\n            <div class=\"comment-avatar\">\n              <span>${initials}</span>\n            </div>\n            <div class=\"comment-bubble\">\n              <div class=\"comment-header\">\n                <span class=\"comment-author\">${this.escapeHtml(item.author_name || 'Team Member')}</span>\n                <span class=\"comment-time\">${this.timeAgo(item.created_at)}</span>\n              </div>\n              <div class=\"comment-content\">${this.escapeHtml(item.content)}</div>\n            </div>\n          </div>\n        `;\n      } else {\n        // Buffer activities to group them\n        activityBuffer.push(item);\n      }\n    });\n    \n    // Flush any remaining activities\n    result += flushActivityBuffer();\n    \n    return result;\n  },\n\n  formatActivityTextCompact(item) {\n    const authorName = item.author_name || 'System';\n    const firstName = authorName.split(' ')[0];\n    const details = item.details ? JSON.parse(item.details) : {};\n    \n    switch (item.activity_type) {\n      case 'status_changed':\n        const newStatus = details.new_status || details.status || 'updated';\n        return `<strong>${firstName}</strong> â†’ ${newStatus.replace('_', ' ')}`;\n      case 'assigned':\n        return `<strong>${firstName}</strong> assigned case`;\n      case 'viewed_shopify_order':\n        return `<strong>${firstName}</strong> viewed order`;\n      case 'viewed_session_recording':\n        return `<strong>${firstName}</strong> viewed recording`;\n      case 'clicked_sop':\n        return `<strong>${firstName}</strong> viewed SOP`;\n      case 'copied_email_template':\n        return `<strong>${firstName}</strong> copied template`;\n      case 'comment_added':\n        return `<strong>${firstName}</strong> commented`;\n      default:\n        return `<strong>${firstName}</strong>: ${item.activity_type?.replace(/_/g, ' ') || 'action'}`;\n    }\n  },\n\n  getActivityIconClass(type) {\n    const classes = {\n      'status_changed': 'status-change',\n      'assigned': 'assigned',\n      'viewed_shopify_order': 'view-action',\n      'viewed_session_recording': 'view-action',\n      'clicked_sop': 'view-action',\n      'copied_email_template': 'copy-action'\n    };\n    return classes[type] || '';\n  },\n\n  getActivityIcon(type) {\n    const icons = {\n      'status_changed': '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"12\" height=\"12\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>',\n      'assigned': '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"12\" height=\"12\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\"></path></svg>',\n      'viewed_shopify_order': '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"12\" height=\"12\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M15 12a3 3 0 11-6 0 3 3 0 016 0z\"></path><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M2.458 12C3.732 7.943 7.523 5 12 5c4.478 0 8.268 2.943 9.542 7-1.274 4.057-5.064 7-9.542 7-4.477 0-8.268-2.943-9.542-7z\"></path></svg>',\n      'viewed_session_recording': '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"12\" height=\"12\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M14.752 11.168l-3.197-2.132A1 1 0 0010 9.87v4.263a1 1 0 001.555.832l3.197-2.132a1 1 0 000-1.664z\"></path><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M21 12a9 9 0 11-18 0 9 9 0 0118 0z\"></path></svg>',\n      'clicked_sop': '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"12\" height=\"12\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12h6m-6 4h6m2 5H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"></path></svg>',\n      'copied_email_template': '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"12\" height=\"12\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\"></path></svg>'\n    };\n    return icons[type] || '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"12\" height=\"12\"><circle cx=\"12\" cy=\"12\" r=\"3\"></circle></svg>';\n  },\n\n  showEmailTemplateModal() {\n    const c = this.caseData;\n    if (!c) return;\n\n    // Get the SINGLE matching template based on resolution\n    const template = this.getEmailTemplateForResolution(c);\n    \n    // Pre-fill the template with actual case data\n    const filledBody = this.fillTemplateVariables(template.body, c);\n    \n    const html = `\n      <div class=\"modal-overlay active\" id=\"emailTemplateModal\" onclick=\"if(event.target.id==='emailTemplateModal')this.remove()\">\n        <div class=\"modal\" style=\"max-width: 650px;\">\n          <div class=\"modal-header\">\n            <h3>${this.escapeHtml(template.name)}</h3>\n            <button class=\"modal-close\" onclick=\"document.getElementById('emailTemplateModal').remove()\">Ã—</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px; max-height: 400px; overflow-y: auto;\">\n            <div style=\"font-size: 14px; line-height: 1.7; color: var(--gray-800); white-space: pre-line;\">${this.escapeHtml(filledBody)}</div>\n          </div>\n          <div style=\"padding: 16px 24px; background: var(--gray-50); border-top: 1px solid var(--gray-200); display: flex; justify-content: flex-end;\">\n            <button class=\"btn btn-primary\" onclick=\"HubCaseDetail.copyFilledTemplate()\" style=\"display: flex; align-items: center; gap: 8px;\">\n              <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M8 5H6a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2v-1M8 5a2 2 0 002 2h2a2 2 0 002-2M8 5a2 2 0 012-2h2a2 2 0 012 2m0 0h2a2 2 0 012 2v3m2 4H10m0 0l3-3m-3 3l3 3\"></path></svg>\n              Copy to Clipboard\n            </button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  fillTemplateVariables(text, c) {\n    // Use first name only for more personal greeting\n    const firstName = (c.customer_name || 'Valued Customer').split(' ')[0];\n    return text\n      .replace(/\\{\\{customer_name\\}\\}/g, firstName)\n      .replace(/\\{\\{order_number\\}\\}/g, c.order_number || '')\n      .replace(/\\{\\{refund_amount\\}\\}/g, c.refund_amount ? '$' + parseFloat(c.refund_amount).toFixed(2) : '')\n      .replace(/\\{\\{resolution\\}\\}/g, c.resolution || '')\n      .replace(/\\{\\{customer_email\\}\\}/g, c.customer_email || '');\n  },\n\n  getEmailTemplateForResolution(c) {\n    const resolution = (c.resolution || '').toLowerCase().replace(/_/g, ' ');\n    const caseType = c.case_type || 'refund';\n    \n    // Determine the single best template based on resolution\n    if (caseType === 'refund') {\n      if (resolution.includes('full refund') || resolution.includes('full') && !resolution.includes('partial')) {\n        return {\n          id: 'refund_full',\n          name: 'Full Refund Confirmation',\n          subject: 'Your Refund Has Been Processed - Order {{order_number}}',\n          body: `Hi {{customer_name}},\n\nGreat news! Your refund of {{refund_amount}} has been processed for order {{order_number}}.\n\nPlease allow 5-10 business days for the refund to appear in your account, depending on your bank.\n\nIf you have any questions, feel free to reply to this email.\n\nThank you for your patience!\n\nBest regards,\nThe PuppyPad Team`\n        };\n      } else {\n        // Default to partial refund for any other refund scenario\n        return {\n          id: 'refund_partial',\n          name: 'Partial Refund Confirmation',\n          subject: 'Partial Refund Processed - Order {{order_number}}',\n          body: `Hi {{customer_name}},\n\nWe've processed a partial refund of {{refund_amount}} for your order {{order_number}}.\n\nPlease allow 5-10 business days for the refund to appear in your account.\n\nThank you for your understanding!\n\nBest regards,\nThe PuppyPad Team`\n        };\n      }\n    } else if (caseType === 'shipping') {\n      if (resolution.includes('reship')) {\n        return {\n          id: 'reship_confirmation',\n          name: 'Reship Confirmation',\n          subject: 'Your Replacement Order is On the Way! - Order {{order_number}}',\n          body: `Hi {{customer_name}},\n\nGood news! We've shipped a replacement for your order {{order_number}}.\n\nYou'll receive tracking information shortly once the shipment is processed.\n\nWe apologize for any inconvenience and appreciate your patience!\n\nBest regards,\nThe PuppyPad Team`\n        };\n      } else {\n        return {\n          id: 'tracking_update',\n          name: 'Shipping Update',\n          subject: 'Update on Your Order {{order_number}}',\n          body: `Hi {{customer_name}},\n\nWe wanted to give you an update on your order {{order_number}}.\n\nIf you need any assistance, please don't hesitate to reach out.\n\nBest regards,\nThe PuppyPad Team`\n        };\n      }\n    } else if (caseType === 'subscription') {\n      if (resolution.includes('pause')) {\n        return {\n          id: 'sub_paused',\n          name: 'Subscription Paused Confirmation',\n          subject: 'Your PuppyPad Subscription Has Been Paused',\n          body: `Hi {{customer_name}},\n\nAs requested, we've paused your PuppyPad subscription.\n\nYour subscription will remain paused until you're ready to resume. You can reactivate it anytime from your account or by contacting us.\n\nWe'll be here when you're ready to continue!\n\nBest regards,\nThe PuppyPad Team`\n        };\n      } else {\n        return {\n          id: 'sub_cancelled',\n          name: 'Subscription Cancelled Confirmation',\n          subject: 'Your PuppyPad Subscription Has Been Cancelled',\n          body: `Hi {{customer_name}},\n\nYour PuppyPad subscription has been cancelled as requested.\n\nWe're sorry to see you go! If there's anything we could have done better, we'd love to hear your feedback.\n\nYou're always welcome back anytime.\n\nBest regards,\nThe PuppyPad Team`\n        };\n      }\n    } else if (caseType === 'return') {\n      return {\n        id: 'return_approved',\n        name: 'Return Approved',\n        subject: 'Your Return Has Been Approved - Order {{order_number}}',\n        body: `Hi {{customer_name}},\n\nYour return request for order {{order_number}} has been approved!\n\nPlease ship the items back to:\nPuppyPad Returns\n[Return Address]\n\nOnce we receive and process your return, your refund will be issued within 5-7 business days.\n\nThank you!\n\nBest regards,\nThe PuppyPad Team`\n      };\n    }\n    \n    // Default generic template\n    return {\n      id: 'generic',\n      name: 'Resolution Confirmation',\n      subject: 'Update on Your Request - Order {{order_number}}',\n      body: `Hi {{customer_name}},\n\nWe've resolved your request regarding order {{order_number}}.\n\nIf you have any questions, feel free to reach out.\n\nBest regards,\nThe PuppyPad Team`\n    };\n  },\n\n  copyFilledTemplate() {\n    const c = this.caseData;\n    const template = this.getEmailTemplateForResolution(c);\n    \n    const filledBody = this.fillTemplateVariables(template.body, c);\n    \n    navigator.clipboard.writeText(filledBody).then(() => {\n      HubUI.showToast('Email copied to clipboard!', 'success');\n      document.getElementById('emailTemplateModal')?.remove();\n      this.logActivity('copied_email_template', { template_name: template.name });\n    }).catch(() => {\n      HubUI.showToast('Failed to copy template', 'error');\n    });\n  },\n\n  formatActivityText(activity) {\n    const actorName = activity.actor || activity.actor_email || 'System';\n    switch (activity.activity_type) {\n      case 'status_changed':\n        return `<strong>${this.escapeHtml(actorName)}</strong> changed status to <strong>${activity.new_value}</strong>`;\n      case 'clicked_sop':\n        return `<strong>${this.escapeHtml(actorName)}</strong> viewed SOP`;\n      case 'copied_email_template':\n        return `<strong>${this.escapeHtml(actorName)}</strong> copied email template`;\n      case 'viewed_session_recording':\n        return `<strong>${this.escapeHtml(actorName)}</strong> viewed session recording`;\n      case 'viewed_shopify_order':\n        return `<strong>${this.escapeHtml(actorName)}</strong> viewed Shopify order`;\n      case 'assigned':\n        return `<strong>${this.escapeHtml(actorName)}</strong> assigned to ${activity.new_value}`;\n      default:\n        return `<strong>${this.escapeHtml(actorName)}</strong>: ${activity.activity_type}`;\n    }\n  },\n\n  async updateStatus(newStatus) {\n    try {\n      const result = await HubAPI.put(`/hub/api/case/${this.caseData.case_id}/status`, {\n        status: newStatus,\n        actor: HubState.currentUser?.name,\n        actor_email: HubState.currentUser?.email\n      });\n\n      if (result.success) {\n        this.caseData.status = newStatus;\n        HubUI.showToast(`Status updated to ${newStatus}`, 'success');\n        // Refresh to get updated activities\n        this.load(this.caseData.case_id);\n      } else {\n        HubUI.showToast(result.error || 'Failed to update status', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to update status', 'error');\n    }\n  },\n\n  selectStatus(status, element) {\n    // Update visual selection\n    const group = element.closest('.status-radio-group');\n    if (group) {\n      group.querySelectorAll('.status-radio-item').forEach(item => {\n        item.classList.remove('selected');\n      });\n    }\n    element.classList.add('selected');\n    \n    // Trigger status update\n    this.updateStatus(status);\n  },\n\n  async copyToClipboard(text, button) {\n    try {\n      await navigator.clipboard.writeText(text);\n      \n      // Visual feedback\n      button.classList.add('copied');\n      const originalHTML = button.innerHTML;\n      button.innerHTML = '<svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M5 13l4 4L19 7\"></path></svg>';\n      \n      HubUI.showToast('Copied to clipboard!', 'success');\n      \n      // Reset after delay\n      setTimeout(() => {\n        button.classList.remove('copied');\n        button.innerHTML = originalHTML;\n      }, 2000);\n    } catch (e) {\n      HubUI.showToast('Failed to copy', 'error');\n    }\n  },\n\n  async addComment(event) {\n    event.preventDefault();\n    const textarea = document.getElementById('newCommentText');\n    const content = textarea?.value.trim();\n\n    if (!content) return;\n\n    try {\n      const result = await HubAPI.post(`/hub/api/case/${this.caseData.case_id}/comments`, {\n        content,\n        author_name: HubState.currentUser?.name || 'Team Member',\n        author_email: HubState.currentUser?.email || ''\n      });\n\n      if (result.success) {\n        textarea.value = '';\n        HubUI.showToast('Comment added', 'success');\n        this.load(this.caseData.case_id);\n      } else {\n        HubUI.showToast(result.error || 'Failed to add comment', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to add comment', 'error');\n    }\n  },\n\n  async logActivity(activityType, details = {}) {\n    try {\n      await HubAPI.post('/hub/api/activity', {\n        case_id: this.caseData.case_id,\n        activity_type: activityType,\n        details\n      });\n    } catch (e) {\n      // Silent fail for activity logging\n    }\n  },\n\n  async copyEmailTemplate(templateId, templateName) {\n    try {\n      const result = await HubAPI.post(`/hub/api/email-templates/${templateId}/render`, {\n        case_id: this.caseData.case_id\n      });\n\n      if (result.subject && result.body) {\n        const textToCopy = `Subject: ${result.subject}\\n\\n${result.body}`;\n        await navigator.clipboard.writeText(textToCopy);\n        HubUI.showToast('Email template copied with case data', 'success');\n        this.logActivity('copied_email_template', { template_name: templateName });\n      } else {\n        HubUI.showToast('Failed to render template', 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to copy template', 'error');\n    }\n  },\n\n  formatStatus(status) {\n    if (!status) return 'Pending';\n    return status.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n  },\n\n  formatResolution(c) {\n    // Use OpenAI-generated resolution if available\n    if (c._formattedResolution) {\n      return c._formattedResolution;\n    }\n\n    // Fallback to basic formatting\n    const resolution = c.resolution || c;\n    if (!resolution) return 'Pending Review';\n    \n    const resolutionMap = {\n      'full_refund': 'Process Full Refund',\n      'partial_20': 'Process 20% Partial Refund',\n      'partial_30': 'Process 30% Partial Refund',\n      'partial_50': 'Process 50% Partial Refund',\n      'reship_missing_item': 'Reship Missing Item',\n      'subscription_paused': 'Subscription Paused',\n      'subscription_cancelled': 'Subscription Cancelled',\n      'manual_assistance': 'Manual Assistance Required'\n    };\n\n    return resolutionMap[resolution] || resolution.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n  },\n\n  formatDate(timestamp) {\n    if (!timestamp) return '-';\n    return new Date(timestamp).toLocaleDateString('en-US', {\n      year: 'numeric',\n      month: 'short',\n      day: 'numeric',\n      hour: '2-digit',\n      minute: '2-digit'\n    });\n  },\n\n  timeAgo(timestamp) {\n    const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);\n    if (seconds < 60) return 'Just now';\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\n    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;\n    return new Date(timestamp).toLocaleDateString();\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// DASHBOARD\n// ============================================\nconst HubDashboard = {\n  async load() {\n    HubUI.showLoading();\n    try {\n      // Load stats\n      const result = await HubAPI.get('/hub/api/stats');\n\n      document.getElementById('statPending').textContent = result.pending || 0;\n      document.getElementById('statInProgress').textContent = result.inProgress || 0;\n      document.getElementById('statCompletedToday').textContent = result.completedToday || 0;\n      document.getElementById('statAvgTime').textContent = result.avgTime || '-';\n\n      // Update sidebar progress bar\n      this.updateSidebarProgress(result);\n\n      // Update sidebar counts - use correct element IDs\n      const typeToElementId = {\n        'all': 'allCasesCount',\n        'shipping': 'shippingCount',\n        'refund': 'refundCount',\n        'return': 'returnCount',\n        'subscription': 'subscriptionsCount', // Note: plural in HTML\n        'manual': 'manualCount'\n      };\n      \n      Object.entries(typeToElementId).forEach(([type, elementId]) => {\n        const el = document.getElementById(elementId);\n        if (el) el.textContent = result[type] || 0;\n      });\n\n      // Load issue reports count for the badge\n      this.loadIssuesCount();\n\n      // Load recent cases\n      await this.loadRecentCases();\n    } catch (e) {\n      console.error('Failed to load dashboard:', e);\n      HubUI.showToast('Failed to load dashboard stats', 'error');\n      // Still try to load recent cases even if stats fail\n      await this.loadRecentCases();\n    } finally {\n      HubUI.hideLoading();\n    }\n  },\n\n  updateSidebarProgress(stats) {\n    const pending = stats.pending || 0;\n    const inProgress = stats.inProgress || 0;\n    const completed = stats.completed || 0; // ALL completed cases, not just today\n    \n    // Merge pending and inProgress together as \"work to do\"\n    const workToDo = pending + inProgress;\n    const total = workToDo + completed; // Now matches \"All Cases\" count\n\n    // Update stats text\n    const progressCompleted = document.getElementById('progressCompleted');\n    const progressTotal = document.getElementById('progressTotal');\n    const progressPending = document.getElementById('progressPending');\n    const progressCompletedLabel = document.getElementById('progressCompletedLabel');\n    const progressBarFill = document.getElementById('progressBarFill');\n\n    if (progressCompleted) progressCompleted.textContent = completed;\n    if (progressTotal) progressTotal.textContent = total;\n    if (progressPending) progressPending.textContent = workToDo; // Shows pending + inProgress combined\n    if (progressCompletedLabel) progressCompletedLabel.textContent = completed;\n\n    // Calculate and animate progress bar\n    const percentage = total > 0 ? Math.round((completed / total) * 100) : 0;\n    if (progressBarFill) {\n      progressBarFill.style.width = `${percentage}%`;\n    }\n  },\n\n  // Separate function to load stats and update sidebar progress\n  async loadStats() {\n    try {\n      const result = await HubAPI.get('/hub/api/stats');\n      this.updateSidebarProgress(result);\n      \n      // Update sidebar counts - include 'return' type\n      // Note: Element IDs use different naming convention for some types\n      const typeToElementId = {\n        'all': 'allCasesCount',\n        'shipping': 'shippingCount',\n        'refund': 'refundCount',\n        'return': 'returnCount',\n        'subscription': 'subscriptionsCount', // Note: plural in HTML\n        'manual': 'manualCount'\n      };\n      \n      Object.entries(typeToElementId).forEach(([type, elementId]) => {\n        const el = document.getElementById(elementId);\n        if (el) el.textContent = result[type] || 0;\n      });\n      \n      // Also load issue reports count for the badge\n      this.loadIssuesCount();\n      \n      // Load duplicates count\n      this.loadDuplicatesCount();\n      \n      return result;\n    } catch (e) {\n      console.error('Failed to load stats:', e);\n    }\n  },\n  \n  async loadDuplicatesCount() {\n    try {\n      const response = await fetch('/hub/api/duplicates', {\n        headers: {\n          'Content-Type': 'application/json',\n          'Authorization': `Bearer ${HubState.token}`\n        }\n      });\n      if (response.ok) {\n        const data = await response.json();\n        const badge = document.getElementById('duplicatesCount');\n        if (badge) {\n          const count = data.summary?.total_duplicate_groups || 0;\n          badge.textContent = count;\n        }\n      }\n    } catch (e) {\n      console.error('Failed to load duplicates count:', e);\n    }\n  },\n\n  async loadIssuesCount() {\n    try {\n      const result = await HubAPI.get('/hub/api/issues?page=1&limit=1&status=pending');\n      const badge = document.getElementById('issuesCount');\n      if (badge) {\n        const count = result.total || 0;\n        badge.textContent = count;\n        badge.style.display = count > 0 ? 'inline-flex' : 'none';\n      }\n    } catch (e) {\n      console.error('Failed to load issues count:', e);\n    }\n  },\n\n  recentCases: [],\n  selectedDashboardCases: new Set(),\n  \n  async loadRecentCases() {\n    const container = document.getElementById('recentCasesBody');\n    if (!container) return;\n\n    // Show loading spinner\n    container.innerHTML = '<tr><td colspan=\"7\" class=\"loading-spinner\"><div class=\"spinner\"></div></td></tr>';\n\n    try {\n      const result = await HubAPI.get('/hub/api/cases?page=1&limit=15');\n      this.recentCases = result.cases || [];\n      this.renderRecentCases(this.recentCases);\n    } catch (e) {\n      console.error('Failed to load recent cases:', e);\n      container.innerHTML = '<tr><td colspan=\"7\" class=\"empty-state\">Failed to load recent cases</td></tr>';\n    }\n  },\n\n  filterRecentCases() {\n    const statusFilter = document.getElementById('dashboardStatusFilter')?.value || '';\n    const typeFilter = document.getElementById('dashboardTypeFilter')?.value || '';\n    const sortFilter = document.getElementById('dashboardSortFilter')?.value || 'newest';\n\n    let filtered = [...this.recentCases];\n\n    if (statusFilter) {\n      filtered = filtered.filter(c => c.status === statusFilter);\n    }\n    if (typeFilter) {\n      filtered = filtered.filter(c => c.case_type === typeFilter);\n    }\n    \n    if (sortFilter === 'oldest') {\n      filtered.sort((a, b) => new Date(a.created_at) - new Date(b.created_at));\n    } else {\n      filtered.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));\n    }\n\n    this.renderRecentCases(filtered);\n  },\n\n  toggleSelectAll(checkbox) {\n    const checkboxes = document.querySelectorAll('#recentCasesBody input[type=\"checkbox\"]');\n    checkboxes.forEach(cb => {\n      cb.checked = checkbox.checked;\n      const caseId = cb.dataset.caseId;\n      if (caseId) {\n        if (checkbox.checked) {\n          this.selectedDashboardCases.add(caseId);\n        } else {\n          this.selectedDashboardCases.delete(caseId);\n        }\n      }\n    });\n    this.updateBulkActionBar();\n  },\n\n  toggleDashboardSelect(caseId) {\n    if (this.selectedDashboardCases.has(caseId)) {\n      this.selectedDashboardCases.delete(caseId);\n    } else {\n      this.selectedDashboardCases.add(caseId);\n    }\n    this.updateBulkActionBar();\n  },\n\n  updateBulkActionBar() {\n    const count = this.selectedDashboardCases.size;\n    let bar = document.getElementById('dashboardBulkBar');\n    \n    if (count === 0) {\n      if (bar) bar.remove();\n      return;\n    }\n\n    if (!bar) {\n      bar = document.createElement('div');\n      bar.id = 'dashboardBulkBar';\n      bar.className = 'bulk-action-bar';\n      document.body.appendChild(bar);\n    }\n\n    bar.innerHTML = `\n      <div class=\"bulk-action-count\">${count} case${count > 1 ? 's' : ''} selected</div>\n      <div class=\"bulk-action-buttons\">\n        <button onclick=\"HubBulkActions.showInlineAssignDropdown(event, 'dashboard')\" class=\"bulk-btn\" id=\"dashboardBulkAssignBtn\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M16 7a4 4 0 11-8 0 4 4 0 018 0zM12 14a7 7 0 00-7 7h14a7 7 0 00-7-7z\"/></svg>\n          Assign\n        </button>\n        <button onclick=\"HubBulkActions.showInlineStatusDropdown(event, 'dashboard')\" class=\"bulk-btn\" id=\"dashboardBulkStatusBtn\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z\"/></svg>\n          Change Status\n        </button>\n        <button onclick=\"HubDashboard.bulkExport()\" class=\"bulk-btn\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M12 10v6m0 0l-3-3m3 3l3-3m2 8H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z\"/></svg>\n          Export\n        </button>\n        <button onclick=\"HubDashboard.clearSelection()\" class=\"bulk-btn-cancel\">\n          <svg fill=\"none\" stroke=\"currentColor\" viewBox=\"0 0 24 24\" width=\"16\" height=\"16\"><path stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"M6 18L18 6M6 6l12 12\"/></svg>\n          Cancel\n        </button>\n      </div>\n    `;\n  },\n\n  clearSelection() {\n    this.selectedDashboardCases.clear();\n    document.querySelectorAll('#recentCasesBody input[type=\"checkbox\"]').forEach(cb => cb.checked = false);\n    const selectAll = document.getElementById('dashboardSelectAll');\n    if (selectAll) selectAll.checked = false;\n    this.updateBulkActionBar();\n  },\n\n  async bulkAssign() {\n    HubBulkActions.showAssignModal(Array.from(this.selectedDashboardCases));\n  },\n\n  async bulkStatus() {\n    HubBulkActions.showStatusModal(Array.from(this.selectedDashboardCases));\n  },\n\n  async bulkExport() {\n    const cases = this.recentCases.filter(c => this.selectedDashboardCases.has(c.case_id));\n    const csv = this.exportToCSV(cases);\n    const blob = new Blob([csv], { type: 'text/csv' });\n    const url = URL.createObjectURL(blob);\n    const a = document.createElement('a');\n    a.href = url;\n    a.download = `cases-export-${new Date().toISOString().split('T')[0]}.csv`;\n    a.click();\n    URL.revokeObjectURL(url);\n    HubUI.showToast(`Exported ${cases.length} cases`, 'success');\n  },\n\n  exportToCSV(cases) {\n    const headers = ['Case ID', 'Customer Name', 'Customer Email', 'Type', 'Status', 'Resolution', 'Created'];\n    const rows = cases.map(c => [\n      c.case_id,\n      c.customer_name || '',\n      c.customer_email || '',\n      c.case_type || '',\n      c.status || '',\n      c.resolution || '',\n      c.created_at || ''\n    ]);\n    return [headers, ...rows].map(r => r.map(cell => `\"${(cell || '').replace(/\"/g, '\"\"')}\"`).join(',')).join('\\n');\n  },\n\n  renderRecentCases(cases) {\n    const container = document.getElementById('recentCasesBody');\n    if (!container) return;\n\n    if (cases.length === 0) {\n      container.innerHTML = '<tr><td colspan=\"8\" class=\"empty-state\">No recent cases</td></tr>';\n      return;\n    }\n\n    container.innerHTML = cases.map(c => {\n      const statusClass = c.status ? c.status.replace('_', '-') : 'pending';\n      \n      // Calculate due date (24 hours from creation) - same as All Cases\n      const createdDate = new Date(c.created_at);\n      const dueDate = new Date(createdDate.getTime() + (24 * 60 * 60 * 1000));\n      const now = new Date();\n      const isOverdue = now > dueDate && c.status !== 'completed';\n      const hoursLeft = Math.max(0, Math.round((dueDate - now) / (1000 * 60 * 60)));\n      const dueClass = isOverdue ? 'overdue' : hoursLeft < 8 ? 'warning' : 'ok';\n      \n      // Format resolution to match All Cases - use pre-fetched formatted resolution if available\n      const resolutionText = c._formattedResolution || HubCases.formatResolutionSync ? HubCases.formatResolutionSync(c) : (c.resolution || 'Pending Review');\n      \n      return `\n        <tr onclick=\"HubCases.openCase('${c.case_id}')\" style=\"cursor: pointer;\">\n          <td onclick=\"event.stopPropagation();\">\n            <input type=\"checkbox\" data-case-id=\"${c.case_id}\" \n                   onclick=\"HubDashboard.toggleDashboardSelect('${c.case_id}')\"\n                   ${this.selectedDashboardCases.has(c.case_id) ? 'checked' : ''}>\n          </td>\n          <td class=\"td-customer\">\n            <div class=\"td-customer-name\">${HubHelpers.formatName(c.customer_name)}</div>\n            <div class=\"td-customer-email\">${this.escapeHtml(c.customer_email || '-')}</div>\n          </td>\n          <td><span class=\"type-badge ${c.case_type || ''}\">${this.escapeHtml(c.case_type || '-')}</span></td>\n          <td><span class=\"status-badge ${statusClass}\">${this.formatStatus(c.status || 'pending')}</span></td>\n          <td class=\"td-due ${dueClass}\">${isOverdue ? 'Overdue' : hoursLeft + 'h left'}</td>\n          <td class=\"td-resolution\">${this.escapeHtml(resolutionText)}</td>\n          <td class=\"td-assignee\">${HubUsers.renderAssigneeCell(c.case_id, c.assigned_to)}</td>\n          <td class=\"td-created\">${this.timeAgo(c.created_at)}</td>\n        </tr>\n      `;\n    }).join('');\n  },\n\n  formatStatus(status) {\n    return status.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n  },\n\n  timeAgo(timestamp) {\n    if (!timestamp) return '-';\n    const seconds = Math.floor((Date.now() - new Date(timestamp)) / 1000);\n\n    if (seconds < 60) return 'Just now';\n    if (seconds < 3600) return `${Math.floor(seconds / 60)}m ago`;\n    if (seconds < 86400) return `${Math.floor(seconds / 3600)}h ago`;\n    if (seconds < 604800) return `${Math.floor(seconds / 86400)}d ago`;\n\n    return new Date(timestamp).toLocaleDateString();\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// UI UTILITIES\n// ============================================\nconst HubUI = {\n  init() {\n    // NOTE: Nav item event listeners are handled by inline script's navigateTo\n    // Do NOT add duplicate listeners here - it causes race conditions where\n    // both handlers fire and HubCases.renderCasesList overwrites the correct table\n\n    // NOTE: Search is handled by inline script's caseSearchInput and debounceSearch\n    // The inline script has a different search input (caseSearchInput) that works\n    // with the correct table structure\n\n    // Modal close on overlay click\n    document.getElementById('caseModal')?.addEventListener('click', (e) => {\n      if (e.target.id === 'caseModal') this.closeModal();\n    });\n  },\n\n  showLoginScreen() {\n    const loginScreen = document.getElementById('loginScreen');\n    const appContainer = document.getElementById('appContainer');\n    if (loginScreen) loginScreen.style.display = 'flex';\n    if (appContainer) appContainer.style.display = 'none';\n  },\n\n  showApp() {\n    const loginScreen = document.getElementById('loginScreen');\n    const appContainer = document.getElementById('appContainer');\n    if (loginScreen) loginScreen.style.display = 'none';\n    if (appContainer) appContainer.style.display = 'flex';\n\n    // Update user info in sidebar\n    const userName = HubState.currentUser?.name || 'User';\n    const userRole = HubState.currentUser?.role || 'user';\n\n    const userNameEl = document.querySelector('.user-name');\n    const userRoleEl = document.querySelector('.user-role');\n    const userAvatarEl = document.querySelector('.user-avatar');\n\n    if (userNameEl) userNameEl.textContent = userName;\n    if (userRoleEl) userRoleEl.textContent = userRole === 'admin' ? 'Administrator' : 'Team Member';\n    if (userAvatarEl) userAvatarEl.textContent = userName.charAt(0).toUpperCase();\n\n    // Show/hide admin nav items\n    document.querySelectorAll('.admin-only').forEach(el => {\n      el.style.display = HubAuth.isAdmin() ? 'block' : 'none';\n    });\n  },\n\n  showCaseModal(caseData) {\n    // Implementation would render the full case modal\n    // This is a simplified version\n    const modal = document.getElementById('caseModal');\n    if (modal) {\n      modal.classList.add('active');\n      // Populate modal with case data...\n    }\n  },\n\n  closeModal() {\n    document.querySelectorAll('.modal-overlay.active').forEach(m => {\n      m.classList.remove('active');\n    });\n    HubState.currentCase = null;\n  },\n\n  updateCaseModalStatus(status) {\n    document.querySelectorAll('.status-card').forEach(card => {\n      card.classList.remove('active');\n      if (card.classList.contains(status.replace('_', '-'))) {\n        card.classList.add('active');\n      }\n    });\n  },\n\n  showLoading() {\n    HubState.isLoading = true;\n    // Show loading indicator\n  },\n\n  hideLoading() {\n    HubState.isLoading = false;\n    // Hide loading indicator\n  },\n\n  showToast(message, type = 'info') {\n    const toast = document.createElement('div');\n    toast.className = `toast toast-${type}`;\n    toast.textContent = message;\n\n    const container = document.getElementById('toastContainer') || document.body;\n    container.appendChild(toast);\n\n    setTimeout(() => toast.classList.add('show'), 10);\n    setTimeout(() => {\n      toast.classList.remove('show');\n      setTimeout(() => toast.remove(), 300);\n    }, 3000);\n  },\n\n  refresh() {\n    if (HubState.currentPage === 'dashboard') {\n      HubDashboard.load();\n    } else if (HubState.currentPage === 'cases') {\n      HubCases.loadCases(HubState.casesPage);\n    }\n    HubUI.showToast('Refreshed', 'success');\n  },\n\n  copyToClipboard(text) {\n    navigator.clipboard.writeText(text).then(() => {\n      this.showToast('Copied to clipboard', 'success');\n    });\n  }\n};\n\n// ============================================\n// INITIALIZATION\n// ============================================\nconst HubApp = {\n  async init() {\n    // Check authentication\n    if (HubAuth.init()) {\n      HubUI.showApp();\n      HubUI.init();\n      HubKeyboard.init();\n      HubViews.load();\n      HubSearch.init();\n      HubFilters.init();\n\n      // IMPORTANT: Load stats immediately to populate sidebar counts\n      // This ensures case type counts (Refunds, Subscriptions, etc.) appear right after login\n      await HubDashboard.loadStats();\n\n      // Navigate based on current URL or default to dashboard\n      this.initFromURL();\n\n      // Check URL for case deep link\n      this.handleDeepLink();\n    } else {\n      HubUI.showLoginScreen();\n    }\n  },\n\n  // Parse URL and navigate to appropriate page\n  initFromURL() {\n    const path = window.location.pathname;\n    \n    if (path.startsWith('/hub/cases/')) {\n      const filter = path.split('/hub/cases/')[1].split('/')[0];\n      HubNavigation.goto('cases', filter);\n    } else if (path === '/hub/cases' || path === '/hub/cases/') {\n      HubNavigation.goto('cases', 'all');\n    } else if (path === '/hub/sessions' || path === '/hub/sessions/') {\n      HubNavigation.goto('sessions');\n    } else if (path === '/hub/events' || path === '/hub/events/') {\n      HubNavigation.goto('events');\n    } else if (path === '/hub/issues' || path === '/hub/issues/') {\n      HubNavigation.goto('issues');\n    } else if (path === '/hub/duplicates' || path === '/hub/duplicates/') {\n      HubNavigation.goto('duplicates');\n    } else if (path === '/hub/analytics' || path === '/hub/analytics/') {\n      HubNavigation.goto('analytics');\n    } else if (path === '/hub/sop' || path === '/hub/sop/') {\n      HubNavigation.goto('sop');\n    } else if (path === '/hub/email-templates' || path === '/hub/email-templates/') {\n      HubNavigation.goto('email-templates');\n    } else if (path.startsWith('/hub/case/')) {\n      const caseId = path.split('/hub/case/')[1].split('/')[0];\n      HubNavigation.goto('case-detail', caseId);\n    } else {\n      // Default to dashboard\n      HubNavigation.goto('dashboard');\n    }\n  },\n\n  handleDeepLink() {\n    const params = new URLSearchParams(window.location.search);\n    const caseId = params.get('case');\n\n    if (caseId) {\n      HubNavigation.goto('cases', 'all');\n      setTimeout(() => HubCases.openCase(caseId), 500);\n    }\n    // URL parsing is now handled by inline script in hub.html\n  }\n};\n\n// ============================================\n// PHASE 2: SOP LINK MANAGEMENT (Admin)\n// ============================================\nconst HubSOPLinks = {\n  links: [],\n\n  async show() {\n    if (!HubAuth.isAdmin()) {\n      HubUI.showToast('Admin access required', 'error');\n      return;\n    }\n\n    await this.load();\n\n    const caseTypes = [...new Set(this.links.map(l => l.case_type))];\n\n    const html = `\n      <div class=\"modal-overlay active\" id=\"sopManagementModal\">\n        <div class=\"modal\" style=\"max-width: 900px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\" style=\"font-size: 18px;\">SOP Link Management</div>\n              <div style=\"font-size: 13px; color: var(--gray-500); margin-top: 4px;\">\n                Configure Standard Operating Procedure links for each case scenario\n              </div>\n            </div>\n            <button class=\"modal-close\" onclick=\"document.getElementById('sopManagementModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 0; max-height: 70vh; overflow-y: auto;\">\n            <div style=\"padding: 16px 24px; border-bottom: 1px solid var(--gray-200); display: flex; justify-content: space-between; align-items: center;\">\n              <div style=\"display: flex; gap: 12px;\">\n                <select id=\"sopCaseTypeFilter\" class=\"form-input\" style=\"width: 150px;\" onchange=\"HubSOPLinks.filterByType(this.value)\">\n                  <option value=\"\">All Types</option>\n                  ${['refund', 'return', 'shipping', 'subscription', 'manual'].map(t =>\n                    `<option value=\"${t}\">${t.charAt(0).toUpperCase() + t.slice(1)}</option>`\n                  ).join('')}\n                </select>\n              </div>\n              <button class=\"btn btn-primary\" onclick=\"HubSOPLinks.showCreateForm()\">Add SOP Link</button>\n            </div>\n            <table class=\"sop-table\" style=\"width: 100%;\">\n              <thead>\n                <tr>\n                  <th style=\"padding: 12px 24px;\">Scenario</th>\n                  <th>Case Type</th>\n                  <th>URL</th>\n                  <th>Status</th>\n                  <th style=\"width: 100px;\">Actions</th>\n                </tr>\n              </thead>\n              <tbody id=\"sopLinksTableBody\">\n                ${this.renderRows(this.links)}\n              </tbody>\n            </table>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  renderRows(links) {\n    if (links.length === 0) {\n      return '<tr><td colspan=\"5\" class=\"empty-state\">No SOP links configured</td></tr>';\n    }\n\n    return links.map(link => `\n      <tr data-case-type=\"${link.case_type}\">\n        <td style=\"padding: 12px 24px;\">\n          <div style=\"font-weight: 500;\">${this.escapeHtml(link.scenario_name)}</div>\n          <div style=\"font-size: 12px; color: var(--gray-500);\">${link.scenario_key}</div>\n        </td>\n        <td><span class=\"type-badge ${link.case_type}\">${link.case_type}</span></td>\n        <td>\n          <a href=\"${link.sop_url}\" target=\"_blank\" style=\"color: var(--primary-600); text-decoration: none; max-width: 250px; display: block; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">\n            ${this.escapeHtml(link.sop_url)}\n          </a>\n        </td>\n        <td>\n          <span class=\"status-badge ${link.is_active ? 'completed' : 'pending'}\">\n            ${link.is_active ? 'Active' : 'Inactive'}\n          </span>\n        </td>\n        <td>\n          <button class=\"btn-icon\" onclick=\"HubSOPLinks.edit(${link.id})\">Edit</button>\n          <button class=\"btn-icon danger\" onclick=\"HubSOPLinks.delete(${link.id})\">Delete</button>\n        </td>\n      </tr>\n    `).join('');\n  },\n\n  async load() {\n    try {\n      const result = await HubAPI.get('/hub/api/admin/sop-links');\n      if (result.success) {\n        this.links = result.links;\n      }\n    } catch (e) {\n      console.error('Failed to load SOP links:', e);\n    }\n  },\n\n  filterByType(caseType) {\n    const rows = document.querySelectorAll('#sopLinksTableBody tr[data-case-type]');\n    rows.forEach(row => {\n      if (!caseType || row.dataset.caseType === caseType) {\n        row.style.display = '';\n      } else {\n        row.style.display = 'none';\n      }\n    });\n  },\n\n  showCreateForm() {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"sopFormModal\" style=\"z-index: 210;\">\n        <div class=\"modal\" style=\"max-width: 500px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\">Add SOP Link</div>\n            </div>\n            <button class=\"modal-close\" onclick=\"document.getElementById('sopFormModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <div class=\"form-group\">\n              <label>Scenario Key</label>\n              <input type=\"text\" id=\"sopScenarioKey\" class=\"form-input\" placeholder=\"e.g., refund_partial, shipping_lost\">\n              <div style=\"font-size: 12px; color: var(--gray-500); margin-top: 4px;\">Unique identifier (lowercase, underscores)</div>\n            </div>\n            <div class=\"form-group\">\n              <label>Scenario Name</label>\n              <input type=\"text\" id=\"sopScenarioName\" class=\"form-input\" placeholder=\"e.g., Partial Refund\">\n            </div>\n            <div class=\"form-group\">\n              <label>Case Type</label>\n              <select id=\"sopCaseType\" class=\"form-input\">\n                <option value=\"refund\">Refund</option>\n                <option value=\"return\">Return</option>\n                <option value=\"shipping\">Shipping</option>\n                <option value=\"subscription\">Subscription</option>\n                <option value=\"manual\">Manual</option>\n              </select>\n            </div>\n            <div class=\"form-group\">\n              <label>SOP URL</label>\n              <input type=\"url\" id=\"sopUrl\" class=\"form-input\" placeholder=\"https://docs.example.com/sop/...\">\n            </div>\n            <div class=\"form-group\">\n              <label>Description (optional)</label>\n              <textarea id=\"sopDescription\" class=\"form-input\" rows=\"2\" placeholder=\"Brief description of this SOP\"></textarea>\n            </div>\n            <div id=\"sopFormError\" class=\"error-message\" style=\"display: none;\"></div>\n            <div style=\"display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;\">\n              <button class=\"btn btn-secondary\" onclick=\"document.getElementById('sopFormModal').remove()\">Cancel</button>\n              <button class=\"btn btn-primary\" onclick=\"HubSOPLinks.create()\">Create</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async create() {\n    const scenarioKey = document.getElementById('sopScenarioKey').value.trim();\n    const scenarioName = document.getElementById('sopScenarioName').value.trim();\n    const caseType = document.getElementById('sopCaseType').value;\n    const sopUrl = document.getElementById('sopUrl').value.trim();\n    const description = document.getElementById('sopDescription').value.trim();\n    const errorEl = document.getElementById('sopFormError');\n\n    if (!scenarioKey || !scenarioName || !sopUrl) {\n      errorEl.textContent = 'Please fill in all required fields';\n      errorEl.style.display = 'block';\n      return;\n    }\n\n    try {\n      const result = await HubAPI.post('/hub/api/admin/sop-links', {\n        scenarioKey,\n        scenarioName,\n        caseType,\n        sopUrl,\n        description\n      });\n\n      if (result.success) {\n        document.getElementById('sopFormModal').remove();\n        HubUI.showToast('SOP link created', 'success');\n        // Refresh the list\n        document.getElementById('sopManagementModal').remove();\n        this.show();\n      } else {\n        errorEl.textContent = result.error;\n        errorEl.style.display = 'block';\n      }\n    } catch (e) {\n      errorEl.textContent = 'Failed to create SOP link';\n      errorEl.style.display = 'block';\n    }\n  },\n\n  edit(id) {\n    const link = this.links.find(l => l.id === id);\n    if (!link) return;\n\n    const html = `\n      <div class=\"modal-overlay active\" id=\"sopFormModal\" style=\"z-index: 210;\">\n        <div class=\"modal\" style=\"max-width: 500px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\">Edit SOP Link</div>\n            </div>\n            <button class=\"modal-close\" onclick=\"document.getElementById('sopFormModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <div class=\"form-group\">\n              <label>Scenario Key</label>\n              <input type=\"text\" class=\"form-input\" value=\"${this.escapeHtml(link.scenario_key)}\" disabled style=\"background: var(--gray-100);\">\n            </div>\n            <div class=\"form-group\">\n              <label>Scenario Name</label>\n              <input type=\"text\" id=\"sopScenarioName\" class=\"form-input\" value=\"${this.escapeHtml(link.scenario_name)}\">\n            </div>\n            <div class=\"form-group\">\n              <label>SOP URL</label>\n              <input type=\"url\" id=\"sopUrl\" class=\"form-input\" value=\"${this.escapeHtml(link.sop_url)}\">\n            </div>\n            <div class=\"form-group\">\n              <label>Description</label>\n              <textarea id=\"sopDescription\" class=\"form-input\" rows=\"2\">${this.escapeHtml(link.description || '')}</textarea>\n            </div>\n            <div class=\"form-group\">\n              <label style=\"display: flex; align-items: center; gap: 8px;\">\n                <input type=\"checkbox\" id=\"sopIsActive\" ${link.is_active ? 'checked' : ''}>\n                Active\n              </label>\n            </div>\n            <div id=\"sopFormError\" class=\"error-message\" style=\"display: none;\"></div>\n            <div style=\"display: flex; gap: 12px; justify-content: flex-end; margin-top: 24px;\">\n              <button class=\"btn btn-secondary\" onclick=\"document.getElementById('sopFormModal').remove()\">Cancel</button>\n              <button class=\"btn btn-primary\" onclick=\"HubSOPLinks.update(${id})\">Save</button>\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  async update(id) {\n    const scenarioName = document.getElementById('sopScenarioName').value.trim();\n    const sopUrl = document.getElementById('sopUrl').value.trim();\n    const description = document.getElementById('sopDescription').value.trim();\n    const isActive = document.getElementById('sopIsActive').checked;\n    const errorEl = document.getElementById('sopFormError');\n\n    try {\n      const result = await HubAPI.put(`/hub/api/admin/sop-links/${id}`, {\n        scenarioName,\n        sopUrl,\n        description,\n        isActive\n      });\n\n      if (result.success) {\n        document.getElementById('sopFormModal').remove();\n        HubUI.showToast('SOP link updated', 'success');\n        document.getElementById('sopManagementModal').remove();\n        this.show();\n      } else {\n        errorEl.textContent = result.error;\n        errorEl.style.display = 'block';\n      }\n    } catch (e) {\n      errorEl.textContent = 'Failed to update SOP link';\n      errorEl.style.display = 'block';\n    }\n  },\n\n  async delete(id) {\n    if (!confirm('Are you sure you want to delete this SOP link?')) return;\n\n    try {\n      const result = await HubAPI.delete(`/hub/api/admin/sop-links/${id}`);\n      if (result.success) {\n        HubUI.showToast('SOP link deleted', 'success');\n        document.getElementById('sopManagementModal').remove();\n        this.show();\n      } else {\n        HubUI.showToast(result.error, 'error');\n      }\n    } catch (e) {\n      HubUI.showToast('Failed to delete SOP link', 'error');\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\n// ============================================\n// PHASE 2: ENHANCED AUDIT LOG (Admin)\n// ============================================\nconst HubEnhancedAuditLog = {\n  currentPage: 1,\n  filters: {},\n  availableFilters: { categories: [], actionTypes: [] },\n\n  async show() {\n    const view = document.getElementById('auditView');\n    if (!view) return;\n\n    if (!HubAuth.isAdmin()) {\n      view.innerHTML = '<div class=\"empty-state\"><p>Admin access required to view this page.</p></div>';\n      return;\n    }\n\n    view.innerHTML = '<div class=\"spinner\" style=\"margin: 40px auto;\"></div>';\n    const result = await this.load(1);\n\n    view.innerHTML = `\n      <div class=\"cases-card\">\n        <div class=\"cases-header\">\n          <h2 class=\"cases-title\">Audit Log</h2>\n          <button class=\"btn btn-secondary\" onclick=\"HubEnhancedAuditLog.export()\">Export CSV</button>\n        </div>\n        <!-- Filters -->\n        <div style=\"padding: 16px 24px; border-bottom: 1px solid var(--gray-200); display: flex; gap: 12px; flex-wrap: wrap; align-items: center;\">\n          <select id=\"auditCategoryFilter\" class=\"form-input\" style=\"width: 140px;\" onchange=\"HubEnhancedAuditLog.applyFilters()\">\n            <option value=\"\">All Categories</option>\n            ${this.availableFilters.categories.map(c =>\n              `<option value=\"${c}\">${c}</option>`\n            ).join('')}\n          </select>\n          <select id=\"auditActionFilter\" class=\"form-input\" style=\"width: 180px;\" onchange=\"HubEnhancedAuditLog.applyFilters()\">\n            <option value=\"\">All Actions</option>\n            ${this.availableFilters.actionTypes.map(a =>\n              `<option value=\"${a}\">${a.replace(/_/g, ' ')}</option>`\n            ).join('')}\n          </select>\n          <input type=\"date\" id=\"auditStartDate\" class=\"form-input\" style=\"width: 140px;\" onchange=\"HubEnhancedAuditLog.applyFilters()\">\n          <input type=\"date\" id=\"auditEndDate\" class=\"form-input\" style=\"width: 140px;\" onchange=\"HubEnhancedAuditLog.applyFilters()\">\n          <input type=\"text\" id=\"auditSearch\" class=\"form-input\" style=\"width: 180px;\" placeholder=\"Search...\" onkeyup=\"HubEnhancedAuditLog.debounceSearch(this.value)\">\n        </div>\n        <!-- Table -->\n        <div style=\"max-height: 60vh; overflow-y: auto;\">\n          <table class=\"audit-table\">\n            <thead>\n              <tr>\n                <th style=\"padding: 12px 24px; position: sticky; top: 0; background: var(--gray-50);\">Time</th>\n                <th style=\"position: sticky; top: 0; background: var(--gray-50);\">User</th>\n                <th style=\"position: sticky; top: 0; background: var(--gray-50);\">Action</th>\n                <th style=\"position: sticky; top: 0; background: var(--gray-50);\">Resource</th>\n                <th style=\"position: sticky; top: 0; background: var(--gray-50);\">Details</th>\n              </tr>\n            </thead>\n            <tbody id=\"auditLogTableBody\">\n              ${this.renderRows(result.logs)}\n            </tbody>\n          </table>\n        </div>\n        <!-- Pagination -->\n        <div id=\"auditPagination\" style=\"padding: 16px 24px; border-top: 1px solid var(--gray-200); display: flex; justify-content: center; align-items: center; gap: 16px;\">\n          ${this.renderPagination(result.pagination)}\n        </div>\n      </div>\n    `;\n  },\n\n  renderRows(logs) {\n    if (!logs || logs.length === 0) {\n      return '<tr><td colspan=\"5\" class=\"empty-state\">No audit entries found</td></tr>';\n    }\n\n    return logs.map(log => `\n      <tr>\n        <td style=\"padding: 10px 24px; white-space: nowrap;\">${this.formatTime(log.created_at)}</td>\n        <td>\n          <div style=\"font-weight: 500;\">${log.user_name || 'System'}</div>\n          <div style=\"font-size: 12px; color: var(--gray-500);\">${log.user_email || ''}</div>\n        </td>\n        <td>\n          <span class=\"action-badge ${log.action_category}\">${log.action_type.replace(/_/g, ' ')}</span>\n        </td>\n        <td>\n          ${log.resource_type ? `<span style=\"font-size: 12px; color: var(--gray-600);\">${log.resource_type}</span>` : '-'}\n          ${log.resource_id ? `<br><span style=\"font-size: 11px; font-family: monospace; color: var(--gray-500);\">${log.resource_id}</span>` : ''}\n        </td>\n        <td style=\"max-width: 200px;\">\n          ${log.old_value || log.new_value ? `\n            <button class=\"btn-icon\" onclick=\"HubEnhancedAuditLog.showDetails(${JSON.stringify(log).replace(/\"/g, '&quot;')})\">\n              View\n            </button>\n          ` : '-'}\n        </td>\n      </tr>\n    `).join('');\n  },\n\n  renderPagination(pagination) {\n    if (!pagination) return '';\n\n    let html = '';\n    if (pagination.page > 1) {\n      html += `<button class=\"btn btn-secondary\" onclick=\"HubEnhancedAuditLog.goToPage(${pagination.page - 1})\">Previous</button>`;\n    }\n    html += `<span>Page ${pagination.page} of ${pagination.totalPages} (${pagination.total} entries)</span>`;\n    if (pagination.page < pagination.totalPages) {\n      html += `<button class=\"btn btn-secondary\" onclick=\"HubEnhancedAuditLog.goToPage(${pagination.page + 1})\">Next</button>`;\n    }\n    return html;\n  },\n\n  async load(page = 1) {\n    try {\n      let url = `/hub/api/admin/audit-log?page=${page}&limit=50`;\n\n      if (this.filters.category) url += `&category=${this.filters.category}`;\n      if (this.filters.actionType) url += `&actionType=${this.filters.actionType}`;\n      if (this.filters.startDate) url += `&startDate=${this.filters.startDate}`;\n      if (this.filters.endDate) url += `&endDate=${this.filters.endDate}`;\n      if (this.filters.search) url += `&search=${encodeURIComponent(this.filters.search)}`;\n\n      const result = await HubAPI.get(url);\n\n      if (result.success) {\n        this.currentPage = page;\n        this.availableFilters = result.filters;\n        return result;\n      }\n      return { logs: [], pagination: { page: 1, total: 0, totalPages: 1 } };\n    } catch (e) {\n      console.error('Failed to load audit log:', e);\n      return { logs: [], pagination: { page: 1, total: 0, totalPages: 1 } };\n    }\n  },\n\n  async applyFilters() {\n    this.filters = {\n      category: document.getElementById('auditCategoryFilter').value,\n      actionType: document.getElementById('auditActionFilter').value,\n      startDate: document.getElementById('auditStartDate').value,\n      endDate: document.getElementById('auditEndDate').value,\n      search: document.getElementById('auditSearch').value\n    };\n\n    const result = await this.load(1);\n    document.getElementById('auditLogTableBody').innerHTML = this.renderRows(result.logs);\n    document.getElementById('auditPagination').innerHTML = this.renderPagination(result.pagination);\n  },\n\n  debounceSearch: (function() {\n    let timeout;\n    return function(value) {\n      clearTimeout(timeout);\n      timeout = setTimeout(() => {\n        HubEnhancedAuditLog.filters.search = value;\n        HubEnhancedAuditLog.applyFilters();\n      }, 300);\n    };\n  })(),\n\n  async goToPage(page) {\n    const result = await this.load(page);\n    document.getElementById('auditLogTableBody').innerHTML = this.renderRows(result.logs);\n    document.getElementById('auditPagination').innerHTML = this.renderPagination(result.pagination);\n  },\n\n  showDetails(log) {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"auditDetailModal\" style=\"z-index: 210;\">\n        <div class=\"modal\" style=\"max-width: 600px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px;\">\n            <div class=\"modal-title\">Audit Details</div>\n            <button class=\"modal-close\" onclick=\"document.getElementById('auditDetailModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <div style=\"display: grid; gap: 16px;\">\n              <div>\n                <div style=\"font-size: 12px; color: var(--gray-500); margin-bottom: 4px;\">Action</div>\n                <div style=\"font-weight: 500;\">${log.action_type.replace(/_/g, ' ')}</div>\n              </div>\n              <div>\n                <div style=\"font-size: 12px; color: var(--gray-500); margin-bottom: 4px;\">User</div>\n                <div>${log.user_name || 'System'} ${log.user_email ? `(${log.user_email})` : ''}</div>\n              </div>\n              <div>\n                <div style=\"font-size: 12px; color: var(--gray-500); margin-bottom: 4px;\">Time</div>\n                <div>${new Date(log.created_at).toLocaleString()}</div>\n              </div>\n              ${log.old_value ? `\n                <div>\n                  <div style=\"font-size: 12px; color: var(--gray-500); margin-bottom: 4px;\">Previous Value</div>\n                  <pre style=\"background: var(--gray-50); padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 12px;\">${this.formatJSON(log.old_value)}</pre>\n                </div>\n              ` : ''}\n              ${log.new_value ? `\n                <div>\n                  <div style=\"font-size: 12px; color: var(--gray-500); margin-bottom: 4px;\">New Value</div>\n                  <pre style=\"background: var(--gray-50); padding: 12px; border-radius: 8px; overflow-x: auto; font-size: 12px;\">${this.formatJSON(log.new_value)}</pre>\n                </div>\n              ` : ''}\n              ${log.ip_address ? `\n                <div>\n                  <div style=\"font-size: 12px; color: var(--gray-500); margin-bottom: 4px;\">IP Address</div>\n                  <div style=\"font-family: monospace;\">${log.ip_address}</div>\n                </div>\n              ` : ''}\n            </div>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  formatJSON(str) {\n    try {\n      return JSON.stringify(JSON.parse(str), null, 2);\n    } catch {\n      return str;\n    }\n  },\n\n  async export() {\n    try {\n      const startDate = document.getElementById('auditStartDate').value ||\n        new Date(Date.now() - 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];\n      const endDate = document.getElementById('auditEndDate').value ||\n        new Date().toISOString().split('T')[0];\n\n      const response = await HubAPI.request(`/hub/api/admin/audit-log/export?startDate=${startDate}&endDate=${endDate}`);\n      const blob = await response.blob();\n      const url = URL.createObjectURL(blob);\n      const a = document.createElement('a');\n      a.href = url;\n      a.download = `audit-log-${startDate}-to-${endDate}.csv`;\n      a.click();\n      URL.revokeObjectURL(url);\n\n      HubUI.showToast('Audit log exported', 'success');\n    } catch (e) {\n      HubUI.showToast('Failed to export audit log', 'error');\n    }\n  },\n\n  formatTime(timestamp) {\n    const date = new Date(timestamp);\n    const now = new Date();\n    const diffMs = now - date;\n    const diffMins = Math.floor(diffMs / 60000);\n    const diffHours = Math.floor(diffMs / 3600000);\n\n    if (diffMins < 1) return 'Just now';\n    if (diffMins < 60) return `${diffMins}m ago`;\n    if (diffHours < 24) return `${diffHours}h ago`;\n\n    return date.toLocaleDateString() + ' ' + date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });\n  }\n};\n\n// ============================================\n// PHASE 2: RESOLUTION VALIDATION\n// ============================================\nconst HubValidation = {\n  async validateBeforeComplete(caseData) {\n    try {\n      const result = await HubAPI.post('/hub/api/validate-resolution', {\n        caseId: caseData.case_id,\n        caseType: caseData.case_type,\n        resolution: caseData.resolution,\n        refundAmount: caseData.refund_amount,\n        orderTotal: caseData.order_total\n      });\n\n      if (!result.valid) {\n        this.showValidationModal(result);\n        return false;\n      }\n\n      if (result.warnings && result.warnings.length > 0) {\n        return await this.showWarningsModal(result.warnings);\n      }\n\n      return true;\n    } catch (e) {\n      console.error('Validation error:', e);\n      // Allow to proceed if validation fails\n      return true;\n    }\n  },\n\n  showValidationModal(result) {\n    const html = `\n      <div class=\"modal-overlay active\" id=\"validationModal\">\n        <div class=\"modal\" style=\"max-width: 500px;\">\n          <div class=\"modal-header\" style=\"padding: 20px 24px; background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%); color: white;\">\n            <div class=\"modal-header-content\">\n              <div class=\"modal-title\" style=\"font-size: 18px; color: white;\">Cannot Complete Case</div>\n            </div>\n            <button class=\"modal-close\" style=\"color: white;\" onclick=\"document.getElementById('validationModal').remove()\">&times;</button>\n          </div>\n          <div class=\"modal-body\" style=\"padding: 24px;\">\n            <p style=\"margin-bottom: 16px;\">Please resolve the following issues before completing this case:</p>\n            <ul style=\"margin: 0; padding-left: 20px;\">\n              ${result.errors.map(e => `<li style=\"margin-bottom: 8px; color: var(--error-600);\">${e}</li>`).join('')}\n            </ul>\n            ${result.warnings && result.warnings.length > 0 ? `\n              <div style=\"margin-top: 16px; padding-top: 16px; border-top: 1px solid var(--gray-200);\">\n                <p style=\"font-weight: 500; margin-bottom: 8px;\">Warnings:</p>\n                <ul style=\"margin: 0; padding-left: 20px;\">\n                  ${result.warnings.map(w => `<li style=\"margin-bottom: 8px; color: var(--warning-600);\">${w}</li>`).join('')}\n                </ul>\n              </div>\n            ` : ''}\n            <button class=\"btn btn-primary\" style=\"width: 100%; margin-top: 24px;\" onclick=\"document.getElementById('validationModal').remove()\">\n              Understood\n            </button>\n          </div>\n        </div>\n      </div>\n    `;\n    document.body.insertAdjacentHTML('beforeend', html);\n  },\n\n  showWarningsModal(warnings) {\n    return new Promise((resolve) => {\n      const html = `\n        <div class=\"modal-overlay active\" id=\"warningsModal\">\n          <div class=\"modal\" style=\"max-width: 500px;\">\n            <div class=\"modal-header\" style=\"padding: 20px 24px; background: linear-gradient(135deg, #d97706 0%, #f59e0b 100%); color: white;\">\n              <div class=\"modal-header-content\">\n                <div class=\"modal-title\" style=\"font-size: 18px; color: white;\">Review Warnings</div>\n              </div>\n              <button class=\"modal-close\" style=\"color: white;\" onclick=\"HubValidation.resolveWarnings(false)\">&times;</button>\n            </div>\n            <div class=\"modal-body\" style=\"padding: 24px;\">\n              <p style=\"margin-bottom: 16px;\">Please review these warnings before proceeding:</p>\n              <ul style=\"margin: 0; padding-left: 20px;\">\n                ${warnings.map(w => `<li style=\"margin-bottom: 8px; color: var(--warning-700);\">${w}</li>`).join('')}\n              </ul>\n              <div style=\"display: flex; gap: 12px; margin-top: 24px;\">\n                <button class=\"btn btn-secondary\" style=\"flex: 1;\" onclick=\"HubValidation.resolveWarnings(false)\">\n                  Cancel\n                </button>\n                <button class=\"btn btn-primary\" style=\"flex: 1;\" onclick=\"HubValidation.resolveWarnings(true)\">\n                  Proceed Anyway\n                </button>\n              </div>\n            </div>\n          </div>\n        </div>\n      `;\n      document.body.insertAdjacentHTML('beforeend', html);\n\n      this._warningsResolve = resolve;\n    });\n  },\n\n  resolveWarnings(proceed) {\n    document.getElementById('warningsModal')?.remove();\n    if (this._warningsResolve) {\n      this._warningsResolve(proceed);\n      this._warningsResolve = null;\n    }\n  }\n};\n\n// Auto-initialize when DOM is ready\nif (document.readyState === 'loading') {\n  document.addEventListener('DOMContentLoaded', () => HubApp.init());\n} else {\n  HubApp.init();\n}\n\n// Export for global access\nwindow.HubApp = HubApp;\nwindow.HubAuth = HubAuth;\nwindow.HubCases = HubCases;\nwindow.HubCaseDetail = HubCaseDetail;\nwindow.HubBulkActions = HubBulkActions;\nwindow.HubViews = HubViews;\nwindow.HubChecklist = HubChecklist;\nwindow.HubUsers = HubUsers;\n\n// User Management with Activity Logs\nconst HubUserManagement = {\n  currentUserId: null,\n\n  async viewActivity(userId) {\n    this.currentUserId = userId;\n    \n    // Hide users view, show activity view\n    document.getElementById('usersView').style.display = 'none';\n    document.getElementById('userActivityView').style.display = 'block';\n    \n    // Update navigation\n    document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));\n    \n    // Load user info and activity\n    await this.loadActivity(userId);\n  },\n\n  async loadActivity(userId, page = 1) {\n    const content = document.getElementById('userActivityContent');\n    if (!content) return;\n\n    content.innerHTML = '<div class=\"spinner\" style=\"margin: 40px auto;\"></div>';\n\n    try {\n      const result = await HubAPI.get(`/hub/api/users/${userId}/activity?page=${page}&limit=50`);\n      \n      if (result.success) {\n        const user = result.user;\n        document.getElementById('userActivityTitle').textContent = `Activity Log: ${user.name}`;\n        document.getElementById('userActivitySubtitle').textContent = `${user.username} â€¢ ${result.pagination.total} total activities`;\n\n        const logs = result.logs || [];\n        \n        if (logs.length === 0) {\n          content.innerHTML = '<div class=\"empty-state\"><p>No activity found for this user.</p></div>';\n          return;\n        }\n\n        const formatDate = (dateStr) => {\n          const date = new Date(dateStr);\n          return date.toLocaleString();\n        };\n\n        const formatAction = (log) => {\n          const actionType = log.action_type || '';\n          const actionCategory = log.action_category || '';\n          const details = log.details ? (typeof log.details === 'string' ? JSON.parse(log.details) : log.details) : {};\n          \n          let actionText = actionType.replace(/_/g, ' ').replace(/\\b\\w/g, c => c.toUpperCase());\n          \n          if (log.resource_type && log.resource_id) {\n            actionText += ` ${log.resource_type} ${log.resource_id}`;\n          }\n          \n          return actionText;\n        };\n\n        content.innerHTML = `\n          <table class=\"cases-table cases-table-enhanced\">\n            <thead>\n              <tr>\n                <th>TIME</th>\n                <th>ACTION</th>\n                <th>CATEGORY</th>\n                <th>DETAILS</th>\n                <th>IP ADDRESS</th>\n              </tr>\n            </thead>\n            <tbody>\n              ${logs.map(log => `\n                <tr>\n                  <td class=\"time-ago\">${formatDate(log.created_at)}</td>\n                  <td>${formatAction(log)}</td>\n                  <td><span class=\"type-badge\">${log.action_category || 'N/A'}</span></td>\n                  <td style=\"max-width: 300px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap;\">\n                    ${log.details ? JSON.stringify(typeof log.details === 'string' ? JSON.parse(log.details) : log.details).substring(0, 100) : '-'}\n                  </td>\n                  <td class=\"time-ago\">${log.ip_address || '-'}</td>\n                </tr>\n              `).join('')}\n            </tbody>\n          </table>\n          ${result.pagination.totalPages > 1 ? `\n            <div class=\"pagination\" style=\"margin-top: 24px;\">\n              ${result.pagination.page > 1 ? `<button class=\"btn btn-secondary\" onclick=\"HubUserManagement.loadActivity(${userId}, ${result.pagination.page - 1})\">Previous</button>` : ''}\n              <span style=\"margin: 0 16px;\">Page ${result.pagination.page} of ${result.pagination.totalPages}</span>\n              ${result.pagination.page < result.pagination.totalPages ? `<button class=\"btn btn-secondary\" onclick=\"HubUserManagement.loadActivity(${userId}, ${result.pagination.page + 1})\">Next</button>` : ''}\n            </div>\n          ` : ''}\n        `;\n      } else {\n        content.innerHTML = `<div class=\"empty-state\"><p>${result.error || 'Failed to load activity log'}</p></div>`;\n      }\n    } catch (e) {\n      console.error('Failed to load activity:', e);\n      content.innerHTML = '<div class=\"empty-state\"><p>Failed to load activity log</p></div>';\n    }\n  },\n\n  backToUsers() {\n    document.getElementById('userActivityView').style.display = 'none';\n    document.getElementById('usersView').style.display = 'block';\n    this.currentUserId = null;\n    HubUsers.show();\n  },\n\n  showCreateModal() {\n    HubUsers.showCreateForm();\n  }\n};\n\nwindow.HubUserManagement = HubUserManagement;\nwindow.HubAssignment = HubAssignment;\nwindow.HubUI = HubUI;\nwindow.HubNavigation = HubNavigation;\nwindow.HubKeyboard = HubKeyboard;\nwindow.HubSessions = HubSessions;\nwindow.HubEvents = HubEvents;\nwindow.HubIssues = HubIssues;\nwindow.HubDuplicates = HubDuplicates;\nwindow.HubSelfResolved = HubSelfResolved;\nwindow.HubAnalytics = HubAnalytics;\nwindow.HubFilters = HubFilters;\nwindow.HubSavedViews = HubSavedViews;\n// Phase 2 exports\nwindow.HubSOPLinks = HubSOPLinks;\nwindow.HubEnhancedAuditLog = HubEnhancedAuditLog;\nwindow.HubValidation = HubValidation;\n\n// ============================================\n// GLOBAL WRAPPER FUNCTIONS\n// These provide backwards compatibility with HTML onclick handlers\n// ============================================\n\n// Navigation - Don't override inline script's navigateTo which handles view structure\n// window.showPage = (page, filter) => HubNavigation.goto(page, filter);\n// window.navigateTo = (page, filter) => HubNavigation.goto(page, filter);\n\n// Cases - Don't override inline script functions\n// The inline script's openCase shows full-page detail view (not modal)\n// The inline script's loadCasesView creates correct table structure with 8 columns\n// HubCases functions have different column structure (includes case_id, missing Due/Resolution)\n// window.openCase = (caseId) => HubCases.openCase(caseId);  // Inline uses full-page view\n// window.closeCase = () => HubCases.closeDetail();\n// window.loadCasesView = () => HubCases.loadCases();\nwindow.updateCaseStatus = (status) => HubCases.updateStatus(status);\nwindow.navigateCase = (direction) => HubCases.navigateCase(direction);\n\n// Bulk Actions\nwindow.toggleCaseSelect = (caseId) => HubBulkActions.toggleSelect(caseId);\nwindow.selectAllCases = () => HubBulkActions.selectAll();\nwindow.deselectAllCases = () => HubBulkActions.deselectAll();\nwindow.bulkUpdateStatus = (status) => HubBulkActions.updateStatus(status);\n\n// Auth\nwindow.handleLogin = async (event) => {\n  event.preventDefault();\n  const errorEl = document.getElementById('loginError');\n  const submitBtn = event.target.querySelector('button[type=\"submit\"]');\n  const username = document.getElementById('loginUsername')?.value?.trim();\n  const password = document.getElementById('loginPassword')?.value;\n\n  // Clear previous errors\n  if (errorEl) {\n    errorEl.style.display = 'none';\n    errorEl.textContent = '';\n  }\n\n  // Disable button during login\n  const originalBtnText = submitBtn?.textContent || 'Sign In';\n  if (submitBtn) {\n    submitBtn.disabled = true;\n    submitBtn.textContent = 'Signing in...';\n  }\n\n  try {\n    const result = await HubAuth.login(username, password);\n    \n    if (result.success) {\n      // Hide error on success\n      if (errorEl) {\n        errorEl.style.display = 'none';\n      }\n      // Reset button before init (in case init takes time)\n      if (submitBtn) {\n        submitBtn.disabled = false;\n        submitBtn.textContent = originalBtnText;\n      }\n      // Initialize app after successful login\n      await HubApp.init();\n    } else {\n      // Show error\n      if (errorEl) {\n        errorEl.textContent = result.error || 'Login failed. Please check your credentials.';\n        errorEl.style.display = 'block';\n      }\n      // Re-enable button\n      if (submitBtn) {\n        submitBtn.disabled = false;\n        submitBtn.textContent = originalBtnText;\n      }\n    }\n  } catch (error) {\n    console.error('Login error:', error);\n    if (errorEl) {\n      errorEl.textContent = 'An unexpected error occurred. Please try again.';\n      errorEl.style.display = 'block';\n    }\n    // Re-enable button\n    if (submitBtn) {\n      submitBtn.disabled = false;\n      submitBtn.textContent = originalBtnText;\n    }\n  }\n};\nwindow.logout = () => HubAuth.logout();\n\n// ============================================\n// PROFILE SETTINGS\n// ============================================\nconst HubProfile = {\n  async load() {\n    try {\n      const result = await HubAPI.get('/hub/api/profile');\n      if (result.success && result.user) {\n        this.render(result.user);\n      } else {\n        HubUI.showToast('Failed to load profile', 'error');\n        document.getElementById('profileContent').innerHTML = '<div style=\"padding: 24px; text-align: center; color: var(--gray-500);\">Failed to load profile</div>';\n      }\n    } catch (e) {\n      console.error('Profile load error:', e);\n      HubUI.showToast('Failed to load profile', 'error');\n      document.getElementById('profileContent').innerHTML = '<div style=\"padding: 24px; text-align: center; color: var(--gray-500);\">Failed to load profile</div>';\n    }\n  },\n\n  render(user) {\n    const html = `\n      <div style=\"max-width: 600px;\">\n        <div style=\"margin-bottom: 32px;\">\n          <h3 style=\"font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);\">Account Information</h3>\n          <p style=\"font-size: 14px; color: var(--gray-500);\">Update your account details and password</p>\n        </div>\n\n        <form id=\"profileForm\" onsubmit=\"HubProfile.handleSubmit(event)\" style=\"display: flex; flex-direction: column; gap: 24px;\">\n          <!-- Name Field -->\n          <div>\n            <label style=\"display: block; font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;\">\n              Full Name *\n            </label>\n            <input \n              type=\"text\" \n              id=\"profileName\" \n              value=\"${this.escapeHtml(user.name || '')}\" \n              required\n              style=\"width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white;\"\n              placeholder=\"Your full name\"\n            >\n          </div>\n\n          <!-- Email/Username Field -->\n          <div>\n            <label style=\"display: block; font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;\">\n              Email / Username *\n            </label>\n            <input \n              type=\"email\" \n              id=\"profileEmail\" \n              value=\"${this.escapeHtml(user.username || '')}\" \n              required\n              style=\"width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white;\"\n              placeholder=\"your.email@example.com\"\n            >\n            <p style=\"font-size: 12px; color: var(--gray-500); margin-top: 6px;\">This is used for login</p>\n          </div>\n\n          <!-- Role Display (Read-only) -->\n          <div>\n            <label style=\"display: block; font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;\">\n              Role\n            </label>\n            <input \n              type=\"text\" \n              value=\"${this.escapeHtml(user.role || 'user')}\" \n              disabled\n              style=\"width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: var(--gray-50); color: var(--gray-600); cursor: not-allowed;\"\n            >\n          </div>\n\n          <div style=\"border-top: 1px solid var(--border-color); padding-top: 24px; margin-top: 8px;\">\n            <h3 style=\"font-size: 18px; font-weight: 600; margin-bottom: 8px; color: var(--text-primary);\">Change Password</h3>\n            <p style=\"font-size: 14px; color: var(--gray-500); margin-bottom: 24px;\">Leave blank if you don't want to change your password</p>\n\n            <!-- Current Password -->\n            <div style=\"margin-bottom: 16px;\">\n              <label style=\"display: block; font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;\">\n                Current Password\n              </label>\n              <input \n                type=\"password\" \n                id=\"profileCurrentPassword\" \n                style=\"width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white;\"\n                placeholder=\"Enter current password to change\"\n              >\n            </div>\n\n            <!-- New Password -->\n            <div style=\"margin-bottom: 16px;\">\n              <label style=\"display: block; font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;\">\n                New Password\n              </label>\n              <input \n                type=\"password\" \n                id=\"profileNewPassword\" \n                minlength=\"6\"\n                style=\"width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white;\"\n                placeholder=\"Enter new password (min 6 characters)\"\n              >\n            </div>\n\n            <!-- Confirm New Password -->\n            <div>\n              <label style=\"display: block; font-size: 13px; font-weight: 500; color: var(--text-primary); margin-bottom: 8px;\">\n                Confirm New Password\n              </label>\n              <input \n                type=\"password\" \n                id=\"profileConfirmPassword\" \n                minlength=\"6\"\n                style=\"width: 100%; padding: 12px 16px; border: 1px solid var(--border-color); border-radius: 8px; font-size: 14px; background: white;\"\n                placeholder=\"Confirm new password\"\n              >\n            </div>\n          </div>\n\n          <!-- Submit Button -->\n          <div style=\"display: flex; gap: 12px; margin-top: 8px;\">\n            <button \n              type=\"submit\" \n              class=\"btn btn-primary\"\n              style=\"flex: 1;\"\n            >\n              Save Changes\n            </button>\n            <button \n              type=\"button\" \n              class=\"btn btn-secondary\"\n              onclick=\"HubProfile.resetForm()\"\n            >\n              Reset\n            </button>\n          </div>\n        </form>\n      </div>\n    `;\n\n    document.getElementById('profileContent').innerHTML = html;\n    this.currentUser = user;\n  },\n\n  async handleSubmit(event) {\n    event.preventDefault();\n\n    const name = document.getElementById('profileName').value.trim();\n    const email = document.getElementById('profileEmail').value.trim();\n    const currentPassword = document.getElementById('profileCurrentPassword').value;\n    const newPassword = document.getElementById('profileNewPassword').value;\n    const confirmPassword = document.getElementById('profileConfirmPassword').value;\n\n    // Validate email\n    if (!email || !email.includes('@')) {\n      HubUI.showToast('Please enter a valid email address', 'error');\n      return;\n    }\n\n    // If password fields are filled, validate them\n    if (newPassword || currentPassword || confirmPassword) {\n      if (!currentPassword) {\n        HubUI.showToast('Current password is required to change password', 'error');\n        return;\n      }\n      if (!newPassword || newPassword.length < 6) {\n        HubUI.showToast('New password must be at least 6 characters', 'error');\n        return;\n      }\n      if (newPassword !== confirmPassword) {\n        HubUI.showToast('New passwords do not match', 'error');\n        return;\n      }\n    }\n\n    try {\n      const payload = {\n        name,\n        email,\n        ...(newPassword && { currentPassword, newPassword })\n      };\n\n      const result = await HubAPI.put('/hub/api/profile', payload);\n\n      if (result.success) {\n        HubUI.showToast('Profile updated successfully', 'success');\n        \n        // Update stored user data\n        if (HubState.currentUser) {\n          HubState.currentUser.name = name;\n          HubState.currentUser.username = email;\n          localStorage.setItem('hub_user', JSON.stringify(HubState.currentUser));\n        }\n\n        // Clear password fields\n        document.getElementById('profileCurrentPassword').value = '';\n        document.getElementById('profileNewPassword').value = '';\n        document.getElementById('profileConfirmPassword').value = '';\n\n        // Reload profile to get updated data\n        this.load();\n      } else {\n        HubUI.showToast(result.error || 'Failed to update profile', 'error');\n      }\n    } catch (e) {\n      console.error('Profile update error:', e);\n      HubUI.showToast('Failed to update profile', 'error');\n    }\n  },\n\n  resetForm() {\n    if (this.currentUser) {\n      document.getElementById('profileName').value = this.currentUser.name || '';\n      document.getElementById('profileEmail').value = this.currentUser.username || '';\n      document.getElementById('profileCurrentPassword').value = '';\n      document.getElementById('profileNewPassword').value = '';\n      document.getElementById('profileConfirmPassword').value = '';\n    }\n  },\n\n  escapeHtml(text) {\n    if (!text) return '';\n    const div = document.createElement('div');\n    div.textContent = text;\n    return div.innerHTML;\n  }\n};\n\nwindow.HubProfile = HubProfile;\n\n// UI\nwindow.showToast = (message, type) => HubUI.showToast(message, type);\nwindow.refresh = () => HubUI.refresh();\nwindow.closeModal = () => HubUI.closeModal();\n\n// Users\nwindow.showUserManagement = () => HubUsers.showManagement();\nwindow.assignCase = (userId, userName) => HubUsers.assignToUser(userId, userName);\n\n// Views\nwindow.saveView = () => HubViews.save();\nwindow.applyView = (viewId) => HubViews.apply(viewId);\nwindow.deleteView = (viewId) => HubViews.delete(viewId);\n\n// Assignment\nwindow.showAssignmentQueue = () => HubAssignment.showQueue();\n\n// Audit Log\nwindow.showAuditLog = () => HubEnhancedAuditLog.show();\n\n// Profile modal wrapper\nwindow.showProfileModal = () => {\n  const user = HubState.currentUser || {};\n  HubUI.showModal(`\n    <div class=\"modal-header\" style=\"padding:20px 24px;\">\n      <div class=\"modal-title\" style=\"font-size:18px;\">Edit Profile</div>\n      <button class=\"modal-close\" onclick=\"closeModal()\">&times;</button>\n    </div>\n    <div class=\"modal-body\" style=\"padding:24px;\">\n      <div class=\"form-group\">\n        <label>Display Name</label>\n        <input type=\"text\" id=\"profileName\" class=\"form-input\" value=\"${user.name || ''}\" placeholder=\"Your name\">\n      </div>\n      <div class=\"form-group\">\n        <label>Email Address</label>\n        <input type=\"email\" id=\"profileEmail\" class=\"form-input\" value=\"${user.username || ''}\" readonly>\n      </div>\n      <button class=\"btn btn-primary\" style=\"width:100%;margin-top:16px;\" onclick=\"updateProfile()\">Save Changes</button>\n    </div>\n  `);\n};\n\nwindow.updateProfile = async () => {\n  const name = document.getElementById('profileName')?.value;\n  if (name && HubState.currentUser) {\n    HubState.currentUser.name = name;\n    localStorage.setItem('hub_user', JSON.stringify(HubState.currentUser));\n    HubUI.showToast('Profile updated', 'success');\n    HubUI.closeModal();\n    // Update sidebar display\n    const userNameEl = document.querySelector('.user-name');\n    const avatarEl = document.querySelector('.user-avatar');\n    if (userNameEl) userNameEl.textContent = name;\n    if (avatarEl) avatarEl.textContent = name.charAt(0).toUpperCase();\n  }\n};\n\n// Filter helpers\nwindow.filterSessions = (filter) => {\n  window.currentSessionFilter = filter;\n  // Update tab buttons\n  document.querySelectorAll('[id^=\"tab\"]').forEach(btn => {\n    btn.classList.remove('btn-primary');\n    btn.classList.add('btn-secondary');\n  });\n  const activeTab = document.getElementById('tab' + filter.charAt(0).toUpperCase() + filter.slice(1));\n  if (activeTab) {\n    activeTab.classList.remove('btn-secondary');\n    activeTab.classList.add('btn-primary');\n  }\n  // Re-render sessions with filter\n  if (typeof renderFilteredSessions === 'function') {\n    renderFilteredSessions(filter);\n  }\n};\n\n// Utility functions\nwindow.formatDate = (d) => {\n  if (!d) return '-';\n  try {\n    return new Date(d).toLocaleDateString('en-US', {year:'numeric',month:'short',day:'numeric',hour:'2-digit',minute:'2-digit'});\n  } catch { return '-'; }\n};\n\nwindow.timeAgo = (timestamp) => {\n  if (!timestamp) return '-';\n  const now = Date.now();\n  const date = new Date(timestamp).getTime();\n  const diff = now - date;\n  const minutes = Math.floor(diff / 60000);\n  const hours = Math.floor(diff / 3600000);\n  const days = Math.floor(diff / 86400000);\n  if (minutes < 1) return 'Just now';\n  if (minutes < 60) return minutes + 'm ago';\n  if (hours < 24) return hours + 'h ago';\n  if (days < 7) return days + 'd ago';\n  return formatDate(timestamp);\n};\n\nwindow.escapeHtml = (text) => {\n  if (!text) return '';\n  const div = document.createElement('div');\n  div.textContent = text;\n  return div.innerHTML;\n};\n";
}

// Flow Docs React JS Asset

function getFlowDocsReactJS() {
  return "/**\n * Flow Documentation - React Flow Canvas\n * Uses React 18 + React Flow via CDN for interactive flow visualization\n * Integrates with main hub sidebar\n */\n\n(function initFlowDocs() {\n  // Wait for React and ReactDOM\n  if (typeof React === 'undefined' || typeof ReactDOM === 'undefined') {\n    setTimeout(initFlowDocs, 100);\n    return;\n  }\n\n  const { useState, useCallback, useEffect, useMemo, useRef } = React;\n\n  // Check if React Flow is loaded\n  let ReactFlowLoaded = typeof window.ReactFlow !== 'undefined';\n  let ReactFlowComponent, Controls, Background, MiniMap, useNodesState, useEdgesState, Handle, Position, MarkerType;\n\n  if (ReactFlowLoaded) {\n    ({ ReactFlow: ReactFlowComponent, Controls, Background, MiniMap, useNodesState, useEdgesState, Handle, Position, MarkerType } = window.ReactFlow);\n  }\n\n  // ============================================\n  // SVG ICONS\n  // ============================================\n  const Icons = {\n    Play: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'currentColor', stroke: 'none' },\n      React.createElement('polygon', { points: '5 3 19 12 5 21 5 3' })\n    ),\n    MessageSquare: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('path', { d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z' })\n    ),\n    List: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('line', { x1: 8, y1: 6, x2: 21, y2: 6 }),\n      React.createElement('line', { x1: 8, y1: 12, x2: 21, y2: 12 }),\n      React.createElement('line', { x1: 8, y1: 18, x2: 21, y2: 18 }),\n      React.createElement('line', { x1: 3, y1: 6, x2: 3.01, y2: 6 }),\n      React.createElement('line', { x1: 3, y1: 12, x2: 3.01, y2: 12 }),\n      React.createElement('line', { x1: 3, y1: 18, x2: 3.01, y2: 18 })\n    ),\n    GitBranch: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('line', { x1: 6, y1: 3, x2: 6, y2: 15 }),\n      React.createElement('circle', { cx: 18, cy: 6, r: 3 }),\n      React.createElement('circle', { cx: 6, cy: 18, r: 3 }),\n      React.createElement('path', { d: 'M18 9a9 9 0 0 1-9 9' })\n    ),\n    Zap: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('polygon', { points: '13 2 3 14 12 14 11 22 21 10 12 10 13 2' })\n    ),\n    Bot: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('rect', { x: 3, y: 11, width: 18, height: 10, rx: 2 }),\n      React.createElement('circle', { cx: 12, cy: 5, r: 2 }),\n      React.createElement('path', { d: 'M12 7v4' }),\n      React.createElement('line', { x1: 8, y1: 16, x2: 8, y2: 16 }),\n      React.createElement('line', { x1: 16, y1: 16, x2: 16, y2: 16 })\n    ),\n    Gift: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('polyline', { points: '20 12 20 22 4 22 4 12' }),\n      React.createElement('rect', { x: 2, y: 7, width: 20, height: 5 }),\n      React.createElement('line', { x1: 12, y1: 22, x2: 12, y2: 7 }),\n      React.createElement('path', { d: 'M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z' }),\n      React.createElement('path', { d: 'M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z' })\n    ),\n    FolderOpen: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('path', { d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' }),\n      React.createElement('path', { d: 'M2 10h20' })\n    ),\n    FileText: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }),\n      React.createElement('polyline', { points: '14 2 14 8 20 8' }),\n      React.createElement('line', { x1: 16, y1: 13, x2: 8, y2: 13 }),\n      React.createElement('line', { x1: 16, y1: 17, x2: 8, y2: 17 }),\n      React.createElement('polyline', { points: '10 9 9 9 8 9' })\n    ),\n    Flag: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('path', { d: 'M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z' }),\n      React.createElement('line', { x1: 4, y1: 22, x2: 4, y2: 15 })\n    ),\n    ArrowLeft: () => React.createElement('svg', { width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('line', { x1: 19, y1: 12, x2: 5, y2: 12 }),\n      React.createElement('polyline', { points: '12 19 5 12 12 5' })\n    ),\n    ChevronRight: () => React.createElement('svg', { width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('polyline', { points: '9 18 15 12 9 6' })\n    ),\n    Settings: () => React.createElement('svg', { width: 24, height: 24, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },\n      React.createElement('circle', { cx: 12, cy: 12, r: 3 }),\n      React.createElement('path', { d: 'M19.4 15a1.65 1.65 0 0 0 .33 1.82l.06.06a2 2 0 0 1 0 2.83 2 2 0 0 1-2.83 0l-.06-.06a1.65 1.65 0 0 0-1.82-.33 1.65 1.65 0 0 0-1 1.51V21a2 2 0 0 1-2 2 2 2 0 0 1-2-2v-.09A1.65 1.65 0 0 0 9 19.4a1.65 1.65 0 0 0-1.82.33l-.06.06a2 2 0 0 1-2.83 0 2 2 0 0 1 0-2.83l.06-.06a1.65 1.65 0 0 0 .33-1.82 1.65 1.65 0 0 0-1.51-1H3a2 2 0 0 1-2-2 2 2 0 0 1 2-2h.09A1.65 1.65 0 0 0 4.6 9a1.65 1.65 0 0 0-.33-1.82l-.06-.06a2 2 0 0 1 0-2.83 2 2 0 0 1 2.83 0l.06.06a1.65 1.65 0 0 0 1.82.33H9a1.65 1.65 0 0 0 1-1.51V3a2 2 0 0 1 2-2 2 2 0 0 1 2 2v.09a1.65 1.65 0 0 0 1 1.51 1.65 1.65 0 0 0 1.82-.33l.06-.06a2 2 0 0 1 2.83 0 2 2 0 0 1 0 2.83l-.06.06a1.65 1.65 0 0 0-.33 1.82V9a1.65 1.65 0 0 0 1.51 1H21a2 2 0 0 1 2 2 2 2 0 0 1-2 2h-.09a1.65 1.65 0 0 0-1.51 1z' })\n    )\n  };\n\n  // Node colors\n  const nodeColors = {\n    start: '#22c55e',\n    message: '#3b82f6',\n    options: '#8b5cf6',\n    condition: '#f59e0b',\n    api: '#ec4899',\n    ai: '#6366f1',\n    offer: '#14b8a6',\n    case: '#f97316',\n    form: '#10b981',\n    end: '#ef4444',\n    subflow: '#8b5cf6'\n  };\n\n  // ============================================\n  // FLOW DATA\n  // ============================================\n  const FLOW_DATA = {\n    parentFlows: [\n      { \n        id: 'help_with_order', \n        name: 'Help With My Order', \n        icon: 'ðŸ“¦',\n        color: '#8b5cf6', \n        description: 'Complete flow for order issues including refunds, returns, and complaints',\n        tags: ['ðŸ’­ Changed', 'ðŸ• Dog', 'ðŸ’” Damaged', 'ðŸ˜• Other'],\n        subflows: ['changed_mind', 'dog_not_using', 'quality_issue', 'other_reason'],\n        entryNodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'opts1', type: 'options', position: { x: 350, y: 120 }, data: { prompt: \"What's going on with your order?\", options: [{ label: 'Changed my mind' }, { label: 'Dog not using it' }, { label: 'Quality issue' }, { label: 'Other reason' }] } },\n          { id: 'sub1', type: 'subflow', position: { x: 50, y: 320 }, data: { name: 'Changed My Mind', slug: 'changed_mind' } },\n          { id: 'sub2', type: 'subflow', position: { x: 300, y: 320 }, data: { name: 'Dog Not Using', slug: 'dog_not_using' } },\n          { id: 'sub3', type: 'subflow', position: { x: 550, y: 320 }, data: { name: 'Quality Issue', slug: 'quality_issue' } },\n          { id: 'sub4', type: 'subflow', position: { x: 300, y: 480 }, data: { name: 'Other Reason', slug: 'other_reason' } }\n        ],\n        entryEdges: [\n          { id: 'e1', source: 'start', target: 'opts1', animated: true },\n          { id: 'e2', source: 'opts1', target: 'sub1', sourceHandle: 'opt-0', animated: true },\n          { id: 'e3', source: 'opts1', target: 'sub2', sourceHandle: 'opt-1', animated: true },\n          { id: 'e4', source: 'opts1', target: 'sub3', sourceHandle: 'opt-2', animated: true },\n          { id: 'e5', source: 'opts1', target: 'sub4', sourceHandle: 'opt-3', animated: true }\n        ]\n      },\n      { \n        id: 'track_order', \n        name: 'Track My Order', \n        icon: 'ðŸšš',\n        color: '#3b82f6', \n        description: 'Help customers track their order status and shipping updates',\n        tags: ['ðŸ“ Track'],\n        subflows: ['tracking_status'],\n        entryNodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'sub1', type: 'subflow', position: { x: 350, y: 140 }, data: { name: 'Check Tracking Status', slug: 'tracking_status' } }\n        ],\n        entryEdges: [\n          { id: 'e1', source: 'start', target: 'sub1', animated: true }\n        ]\n      },\n      { \n        id: 'manage_subscription', \n        name: 'Manage My Subscription', \n        icon: 'ðŸ”„',\n        color: '#10b981', \n        description: 'Help customers manage their subscription, billing, and delivery preferences',\n        tags: ['â¸ï¸ Pause', 'âŒ Cancel', 'ðŸ”„ Change'],\n        subflows: ['pause_subscription', 'cancel_subscription', 'change_frequency'],\n        entryNodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'opts1', type: 'options', position: { x: 350, y: 120 }, data: { prompt: 'What would you like to do?', options: [{ label: 'Pause subscription' }, { label: 'Cancel subscription' }, { label: 'Change frequency' }] } },\n          { id: 'sub1', type: 'subflow', position: { x: 100, y: 320 }, data: { name: 'Pause Subscription', slug: 'pause_subscription' } },\n          { id: 'sub2', type: 'subflow', position: { x: 350, y: 320 }, data: { name: 'Cancel Subscription', slug: 'cancel_subscription' } },\n          { id: 'sub3', type: 'subflow', position: { x: 600, y: 320 }, data: { name: 'Change Frequency', slug: 'change_frequency' } }\n        ],\n        entryEdges: [\n          { id: 'e1', source: 'start', target: 'opts1', animated: true },\n          { id: 'e2', source: 'opts1', target: 'sub1', sourceHandle: 'opt-0', animated: true },\n          { id: 'e3', source: 'opts1', target: 'sub2', sourceHandle: 'opt-1', animated: true },\n          { id: 'e4', source: 'opts1', target: 'sub3', sourceHandle: 'opt-2', animated: true }\n        ]\n      }\n    ],\n    subflows: {\n      changed_mind: {\n        id: 'changed_mind',\n        parentId: 'help_with_order',\n        name: 'Changed My Mind',\n        description: 'Customer wants a refund because they changed their mind',\n        nodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'msg1', type: 'message', position: { x: 350, y: 120 }, data: { persona: 'amy', content: \"I understand, and I appreciate you being upfront about it. Let me see what options we have for you!\" } },\n          { id: 'api1', type: 'api', position: { x: 350, y: 280 }, data: { service: 'Shopify', endpoint: 'checkGuarantee' } },\n          { id: 'cond1', type: 'condition', position: { x: 350, y: 420 }, data: { variable: 'guaranteeStatus', operator: 'equals', value: 'active' } },\n          { id: 'offer1', type: 'offer', position: { x: 150, y: 580 }, data: { percent: 20, label: 'Keep product' } },\n          { id: 'offer2', type: 'offer', position: { x: 150, y: 740 }, data: { percent: 30, label: 'Keep product' } },\n          { id: 'offer3', type: 'offer', position: { x: 150, y: 900 }, data: { percent: 40, label: 'Keep product' } },\n          { id: 'case1', type: 'case', position: { x: 150, y: 1060 }, data: { type: 'refund', priority: 'normal' } },\n          { id: 'msg2', type: 'message', position: { x: 550, y: 580 }, data: { persona: 'amy', content: \"I'm sorry, but our 90-day guarantee has expired for this order. However, I can still help!\" } },\n          { id: 'end1', type: 'end', position: { x: 350, y: 1200 }, data: { title: 'Thank You!', showSurvey: true } }\n        ],\n        edges: [\n          { id: 'e1', source: 'start', target: 'msg1', animated: true },\n          { id: 'e2', source: 'msg1', target: 'api1', animated: true },\n          { id: 'e3', source: 'api1', target: 'cond1', animated: true },\n          { id: 'e4', source: 'cond1', target: 'offer1', sourceHandle: 'yes', label: 'Within 90 days', animated: true },\n          { id: 'e5', source: 'cond1', target: 'msg2', sourceHandle: 'no', label: 'Expired', animated: true },\n          { id: 'e6', source: 'offer1', target: 'offer2', sourceHandle: 'decline', label: 'Decline', animated: true },\n          { id: 'e7', source: 'offer1', target: 'case1', sourceHandle: 'accept', label: 'Accept', animated: true },\n          { id: 'e8', source: 'offer2', target: 'offer3', sourceHandle: 'decline', label: 'Decline', animated: true },\n          { id: 'e9', source: 'offer2', target: 'case1', sourceHandle: 'accept', label: 'Accept', animated: true },\n          { id: 'e10', source: 'offer3', target: 'case1', sourceHandle: 'decline', label: 'Decline', animated: true },\n          { id: 'e11', source: 'offer3', target: 'case1', sourceHandle: 'accept', label: 'Accept', animated: true },\n          { id: 'e12', source: 'case1', target: 'end1', animated: true },\n          { id: 'e13', source: 'msg2', target: 'end1', animated: true }\n        ]\n      },\n      dog_not_using: {\n        id: 'dog_not_using',\n        parentId: 'help_with_order',\n        name: 'Dog Not Using Product',\n        description: 'Customer reports their dog is not using the PuppyPad',\n        nodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'msg1', type: 'message', position: { x: 350, y: 120 }, data: { persona: 'amy', content: \"I'm sorry to hear that! Our trainer Claudia has some tips that might help.\" } },\n          { id: 'ai1', type: 'ai', position: { x: 350, y: 280 }, data: { persona: 'claudia', prompt: 'Generate training tips', model: 'gpt-4o-mini' } },\n          { id: 'opts1', type: 'options', position: { x: 350, y: 440 }, data: { prompt: 'Did the tips help?', options: [{ label: 'Yes, thanks!' }, { label: 'Still having issues' }] } },\n          { id: 'end1', type: 'end', position: { x: 150, y: 620 }, data: { title: 'Great!', showSurvey: true } },\n          { id: 'offer1', type: 'offer', position: { x: 550, y: 620 }, data: { percent: 30, label: 'Keep product' } },\n          { id: 'case1', type: 'case', position: { x: 550, y: 780 }, data: { type: 'refund' } },\n          { id: 'end2', type: 'end', position: { x: 550, y: 920 }, data: { title: 'Case Created', showSurvey: true } }\n        ],\n        edges: [\n          { id: 'e1', source: 'start', target: 'msg1', animated: true },\n          { id: 'e2', source: 'msg1', target: 'ai1', animated: true },\n          { id: 'e3', source: 'ai1', target: 'opts1', animated: true },\n          { id: 'e4', source: 'opts1', target: 'end1', sourceHandle: 'opt-0', animated: true },\n          { id: 'e5', source: 'opts1', target: 'offer1', sourceHandle: 'opt-1', animated: true },\n          { id: 'e6', source: 'offer1', target: 'case1', animated: true },\n          { id: 'e7', source: 'case1', target: 'end2', animated: true }\n        ]\n      },\n      quality_issue: {\n        id: 'quality_issue',\n        parentId: 'help_with_order',\n        name: 'Quality / Material Issue',\n        description: 'Customer notices quality or material differences',\n        nodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'msg1', type: 'message', position: { x: 350, y: 120 }, data: { persona: 'amy', content: \"I'm so sorry about that! Can you upload some photos so we can take a look?\" } },\n          { id: 'upload1', type: 'form', position: { x: 350, y: 280 }, data: { formType: 'Photo Upload', label: 'Upload Photos' } },\n          { id: 'case1', type: 'case', position: { x: 350, y: 440 }, data: { type: 'quality', priority: 'high' } },\n          { id: 'msg2', type: 'message', position: { x: 350, y: 600 }, data: { persona: 'amy', content: \"Thanks for those photos. I've created a priority case for our quality team to review.\" } },\n          { id: 'end1', type: 'end', position: { x: 350, y: 760 }, data: { title: 'Case Submitted', showSurvey: true } }\n        ],\n        edges: [\n          { id: 'e1', source: 'start', target: 'msg1', animated: true },\n          { id: 'e2', source: 'msg1', target: 'upload1', animated: true },\n          { id: 'e3', source: 'upload1', target: 'case1', animated: true },\n          { id: 'e4', source: 'case1', target: 'msg2', animated: true },\n          { id: 'e5', source: 'msg2', target: 'end1', animated: true }\n        ]\n      },\n      other_reason: {\n        id: 'other_reason',\n        parentId: 'help_with_order',\n        name: 'Other Reason',\n        description: 'Customer has a different issue not covered by other options',\n        nodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'msg1', type: 'message', position: { x: 350, y: 120 }, data: { persona: 'amy', content: \"I'd love to help! Can you tell me more about what's going on?\" } },\n          { id: 'form1', type: 'form', position: { x: 350, y: 280 }, data: { formType: 'Form', label: 'Describe Issue' } },\n          { id: 'ai1', type: 'ai', position: { x: 350, y: 440 }, data: { persona: 'amy', prompt: 'Analyze issue and provide response', model: 'gpt-4o' } },\n          { id: 'end1', type: 'end', position: { x: 350, y: 600 }, data: { title: 'Thanks!', showSurvey: true } }\n        ],\n        edges: [\n          { id: 'e1', source: 'start', target: 'msg1', animated: true },\n          { id: 'e2', source: 'msg1', target: 'form1', animated: true },\n          { id: 'e3', source: 'form1', target: 'ai1', animated: true },\n          { id: 'e4', source: 'ai1', target: 'end1', animated: true }\n        ]\n      },\n      tracking_status: {\n        id: 'tracking_status',\n        parentId: 'track_order',\n        name: 'Check Tracking Status',\n        description: 'Customer wants to see where their order is',\n        nodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'form1', type: 'form', position: { x: 350, y: 120 }, data: { formType: 'Form', label: 'Find Your Order' } },\n          { id: 'api1', type: 'api', position: { x: 350, y: 280 }, data: { service: 'Shopify', endpoint: 'lookupOrder' } },\n          { id: 'api2', type: 'api', position: { x: 350, y: 440 }, data: { service: 'ParcelPanel', endpoint: 'getTracking' } },\n          { id: 'msg1', type: 'message', position: { x: 350, y: 600 }, data: { persona: 'amy', content: \"Here's your tracking info! Your package is {{trackingStatus}}.\" } },\n          { id: 'end1', type: 'end', position: { x: 350, y: 760 }, data: { title: 'All done!', showSurvey: true } }\n        ],\n        edges: [\n          { id: 'e1', source: 'start', target: 'form1', animated: true },\n          { id: 'e2', source: 'form1', target: 'api1', animated: true },\n          { id: 'e3', source: 'api1', target: 'api2', animated: true },\n          { id: 'e4', source: 'api2', target: 'msg1', animated: true },\n          { id: 'e5', source: 'msg1', target: 'end1', animated: true }\n        ]\n      },\n      cancel_subscription: {\n        id: 'cancel_subscription',\n        parentId: 'manage_subscription',\n        name: 'Cancel Subscription',\n        description: 'Customer wants to cancel their subscription',\n        nodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'msg1', type: 'message', position: { x: 350, y: 120 }, data: { persona: 'amy', content: \"I'm sorry to see you go! Before we cancel, may I ask why?\" } },\n          { id: 'opts1', type: 'options', position: { x: 350, y: 280 }, data: { prompt: 'Reason for canceling?', options: [{ label: 'Too expensive' }, { label: 'Dog passed away' }, { label: 'Moving' }, { label: 'Other' }] } },\n          { id: 'offer1', type: 'offer', position: { x: 50, y: 480 }, data: { percent: 20, label: '20% off next 3 months' } },\n          { id: 'case1', type: 'case', position: { x: 250, y: 480 }, data: { type: 'subscription', priority: 'high', note: 'Pet loss - handle sensitively' } },\n          { id: 'msg2', type: 'message', position: { x: 450, y: 480 }, data: { persona: 'amy', content: \"No problem! I'll process your cancellation.\" } },\n          { id: 'api1', type: 'api', position: { x: 650, y: 480 }, data: { service: 'Shopify', endpoint: 'cancelSubscription' } },\n          { id: 'end1', type: 'end', position: { x: 350, y: 680 }, data: { title: 'Subscription Updated', showSurvey: true } }\n        ],\n        edges: [\n          { id: 'e1', source: 'start', target: 'msg1', animated: true },\n          { id: 'e2', source: 'msg1', target: 'opts1', animated: true },\n          { id: 'e3', source: 'opts1', target: 'offer1', sourceHandle: 'opt-0', label: 'Too expensive', animated: true },\n          { id: 'e4', source: 'opts1', target: 'case1', sourceHandle: 'opt-1', label: 'Pet loss', animated: true },\n          { id: 'e5', source: 'opts1', target: 'msg2', sourceHandle: 'opt-2', label: 'Moving', animated: true },\n          { id: 'e6', source: 'opts1', target: 'api1', sourceHandle: 'opt-3', label: 'Other', animated: true },\n          { id: 'e7', source: 'offer1', target: 'end1', animated: true },\n          { id: 'e8', source: 'case1', target: 'end1', animated: true },\n          { id: 'e9', source: 'msg2', target: 'end1', animated: true },\n          { id: 'e10', source: 'api1', target: 'end1', animated: true }\n        ]\n      },\n      pause_subscription: {\n        id: 'pause_subscription',\n        parentId: 'manage_subscription',\n        name: 'Pause Subscription',\n        description: 'Customer wants to temporarily pause deliveries',\n        nodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'msg1', type: 'message', position: { x: 350, y: 120 }, data: { persona: 'amy', content: \"No problem! How long would you like to pause?\" } },\n          { id: 'opts1', type: 'options', position: { x: 350, y: 280 }, data: { prompt: 'Pause duration', options: [{ label: '1 month' }, { label: '2 months' }, { label: '3 months' }] } },\n          { id: 'api1', type: 'api', position: { x: 350, y: 480 }, data: { service: 'Shopify', endpoint: 'pauseSubscription' } },\n          { id: 'msg2', type: 'message', position: { x: 350, y: 640 }, data: { persona: 'amy', content: \"Done! Your subscription is paused. We'll resume on {{resumeDate}}.\" } },\n          { id: 'end1', type: 'end', position: { x: 350, y: 800 }, data: { title: 'Paused!', showSurvey: true } }\n        ],\n        edges: [\n          { id: 'e1', source: 'start', target: 'msg1', animated: true },\n          { id: 'e2', source: 'msg1', target: 'opts1', animated: true },\n          { id: 'e3', source: 'opts1', target: 'api1', animated: true },\n          { id: 'e4', source: 'api1', target: 'msg2', animated: true },\n          { id: 'e5', source: 'msg2', target: 'end1', animated: true }\n        ]\n      },\n      change_frequency: {\n        id: 'change_frequency',\n        parentId: 'manage_subscription',\n        name: 'Change Delivery Frequency',\n        description: 'Customer wants to adjust how often they receive deliveries',\n        nodes: [\n          { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Start' } },\n          { id: 'api1', type: 'api', position: { x: 350, y: 120 }, data: { service: 'Shopify', endpoint: 'getSubscription' } },\n          { id: 'msg1', type: 'message', position: { x: 350, y: 280 }, data: { persona: 'amy', content: \"Your current frequency is {{currentFrequency}}. What would you like to change it to?\" } },\n          { id: 'opts1', type: 'options', position: { x: 350, y: 440 }, data: { prompt: 'New frequency', options: [{ label: 'Every 2 weeks' }, { label: 'Every month' }, { label: 'Every 6 weeks' }, { label: 'Every 2 months' }] } },\n          { id: 'api2', type: 'api', position: { x: 350, y: 640 }, data: { service: 'Shopify', endpoint: 'updateFrequency' } },\n          { id: 'end1', type: 'end', position: { x: 350, y: 800 }, data: { title: 'Updated!', showSurvey: true } }\n        ],\n        edges: [\n          { id: 'e1', source: 'start', target: 'api1', animated: true },\n          { id: 'e2', source: 'api1', target: 'msg1', animated: true },\n          { id: 'e3', source: 'msg1', target: 'opts1', animated: true },\n          { id: 'e4', source: 'opts1', target: 'api2', animated: true },\n          { id: 'e5', source: 'api2', target: 'end1', animated: true }\n        ]\n      }\n    }\n  };\n\n  // ============================================\n  // CUSTOM NODE COMPONENTS (React Flow)\n  // ============================================\n  const createNodeComponents = () => {\n    if (!ReactFlowLoaded) return {};\n\n    const StartNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: {\n          padding: '16px 32px',\n          borderRadius: '12px',\n          background: '#22c55e',\n          color: 'white',\n          fontWeight: 600,\n          fontSize: '15px',\n          display: 'flex',\n          alignItems: 'center',\n          justifyContent: 'center',\n          gap: '10px',\n          boxShadow: selected ? '0 0 0 2px #22c55e, 0 0 0 4px rgba(34, 197, 94, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)',\n          minWidth: '140px',\n          cursor: 'pointer'\n        }\n      },\n        React.createElement(Icons.Play, null),\n        React.createElement('span', null, 'Start'),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#16a34a', width: '10px', height: '10px', border: '2px solid white' } })\n      );\n    };\n\n    const MessageNode = ({ data, selected }) => {\n      const personas = { amy: 'Amy', claudia: 'Claudia', sarah: 'Sarah' };\n      return React.createElement('div', {\n        style: {\n          padding: '16px',\n          borderRadius: '12px',\n          background: 'white',\n          border: selected ? '2px solid #3b82f6' : '2px solid #e5e7eb',\n          boxShadow: selected ? '0 0 0 2px rgba(59, 130, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)',\n          minWidth: '200px',\n          maxWidth: '280px',\n          cursor: 'pointer'\n        }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#3b82f6', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },\n          React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#3b82f6' } }, React.createElement(Icons.MessageSquare, null)),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, personas[data.persona] || 'Amy')\n        ),\n        React.createElement('p', { style: { fontSize: '14px', color: '#374151', lineHeight: '1.5', margin: 0 } }, data.content || 'Hello! How can I help you today?'),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#3b82f6', width: '10px', height: '10px', border: '2px solid white' } })\n      );\n    };\n\n    const OptionsNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #8b5cf6' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(139, 92, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', maxWidth: '280px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },\n          React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#8b5cf6' } }, React.createElement(Icons.List, null)),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Options')\n        ),\n        React.createElement('p', { style: { fontSize: '14px', color: '#374151', marginBottom: '12px', fontWeight: 500 } }, data.prompt || 'What would you like to do?'),\n        (data.options || []).slice(0, 3).map((opt, i) => React.createElement('div', { key: i, style: { fontSize: '12px', color: '#6b7280', padding: '8px 12px', background: '#f9fafb', borderRadius: '6px', marginBottom: '6px', border: '1px solid #e5e7eb' } }, opt.label)),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } })\n      );\n    };\n\n    const ConditionNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #f59e0b' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(245, 158, 11, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#f59e0b', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },\n          React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#f59e0b' } }, React.createElement(Icons.GitBranch, null)),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Condition')\n        ),\n        React.createElement('p', { style: { fontSize: '13px', color: '#6b7280', fontFamily: 'monospace', margin: 0 } }, data.variable || '{{variable}}'),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'yes', style: { background: '#22c55e', width: '10px', height: '10px', border: '2px solid white', left: '30%' } }),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'no', style: { background: '#ef4444', width: '10px', height: '10px', border: '2px solid white', left: '70%' } })\n      );\n    };\n\n    const ApiNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #ec4899' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(236, 72, 153, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#ec4899', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },\n          React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#fce7f3', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#ec4899' } }, React.createElement(Icons.Zap, null)),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'API Call')\n        ),\n        React.createElement('p', { style: { fontSize: '13px', color: '#374151', margin: 0 } }, `${data.service || 'Shopify'}, ${data.endpoint || 'lookup'}`),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#ec4899', width: '10px', height: '10px', border: '2px solid white' } })\n      );\n    };\n\n    const AiNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #6366f1' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(99, 102, 241, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#6366f1', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },\n          React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#e0e7ff', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#6366f1' } }, React.createElement(Icons.Bot, null)),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'AI Response')\n        ),\n        React.createElement('p', { style: { fontSize: '13px', color: '#374151', margin: 0 } }, 'GPT-powered reply'),\n        React.createElement('p', { style: { fontSize: '11px', color: '#9ca3af', marginTop: '4px' } }, data.model || 'gpt-4o-mini'),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#6366f1', width: '10px', height: '10px', border: '2px solid white' } })\n      );\n    };\n\n    const OfferNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '20px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #14b8a6' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(20, 184, 166, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '220px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#14b8a6', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' } },\n          React.createElement('div', { style: { width: '32px', height: '32px', borderRadius: '50%', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#14b8a6' } }, React.createElement(Icons.Gift, null)),\n          React.createElement('span', { style: { fontSize: '14px', fontWeight: 500, color: '#14b8a6' } }, 'Offer Card')\n        ),\n        React.createElement('p', { style: { fontSize: '28px', fontWeight: 700, color: '#10b981', margin: 0 } }, `${data.percent || 20}% Refund`),\n        React.createElement('p', { style: { fontSize: '14px', color: '#6b7280', marginTop: '6px', marginBottom: '16px' } }, data.label || 'Keep product'),\n        React.createElement('div', { style: { display: 'flex', justifyContent: 'space-around', paddingTop: '12px', borderTop: '1px solid #f3f4f6' } },\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Accept'),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Decline')\n        ),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'accept', style: { background: '#22c55e', width: '12px', height: '12px', border: '2px solid white', left: '25%' } }),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'decline', style: { background: '#ef4444', width: '12px', height: '12px', border: '2px solid white', left: '75%' } })\n      );\n    };\n\n    const CaseNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #f97316' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(249, 115, 22, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#f97316', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },\n          React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ffedd5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#f97316' } }, React.createElement(Icons.FolderOpen, null)),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Create Case')\n        ),\n        React.createElement('p', { style: { fontSize: '13px', color: '#374151', margin: 0 } }, 'Submit to Hub'),\n        React.createElement('p', { style: { fontSize: '11px', color: '#9ca3af', marginTop: '4px' } }, `Type: ${data.type || 'refund'}`),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#f97316', width: '10px', height: '10px', border: '2px solid white' } })\n      );\n    };\n\n    const FormNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #10b981' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(16, 185, 129, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },\n          React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#10b981' } }, React.createElement(Icons.FileText, null)),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, data.formType || 'Form')\n        ),\n        React.createElement('p', { style: { fontSize: '13px', color: '#374151', margin: 0 } }, data.label || 'Collect user input'),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } })\n      );\n    };\n\n    const EndNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '16px 20px', borderRadius: '12px', background: '#ef4444', border: selected ? '2px solid #dc2626' : '2px solid #ef4444', boxShadow: selected ? '0 0 0 3px rgba(239, 68, 68, 0.3), 0 10px 15px -3px rgba(0,0,0,0.15)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#fca5a5', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },\n          React.createElement('div', { style: { color: 'white' } }, React.createElement(Icons.Flag, null)),\n          React.createElement('span', { style: { fontSize: '14px', fontWeight: 600, color: 'white' } }, 'End')\n        ),\n        React.createElement('p', { style: { fontSize: '15px', color: 'rgba(255,255,255,0.9)', margin: 0, fontWeight: 500 } }, data.title || 'Thank You!')\n      );\n    };\n\n    const SubflowNode = ({ data, selected }) => {\n      return React.createElement('div', {\n        style: { padding: '16px 20px', borderRadius: '12px', background: 'white', border: selected ? '2px dashed #8b5cf6' : '2px dashed #c4b5fd', boxShadow: selected ? '0 0 0 2px rgba(139, 92, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 4px 6px -1px rgba(0,0,0,0.05)', minWidth: '220px', cursor: 'pointer' }\n      },\n        React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } }),\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },\n          React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#8b5cf6' } },\n            React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },\n              React.createElement('path', { d: 'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71' }),\n              React.createElement('path', { d: 'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71' })\n            )\n          ),\n          React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#8b5cf6' } }, 'Subflow')\n        ),\n        React.createElement('p', { style: { fontSize: '15px', fontWeight: 600, color: '#374151', margin: 0 } }, data.name || 'Go to Subflow'),\n        React.createElement('p', { style: { fontSize: '12px', color: '#8b5cf6', marginTop: '6px' } }, 'Click to view â†’'),\n        React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } })\n      );\n    };\n\n    return { start: StartNode, message: MessageNode, options: OptionsNode, condition: ConditionNode, api: ApiNode, ai: AiNode, offer: OfferNode, case: CaseNode, form: FormNode, end: EndNode, subflow: SubflowNode };\n  };\n\n  // ============================================\n  // LEFT PANEL - SUBFLOW NAVIGATION\n  // ============================================\n  const LeftPanel = ({ parentFlow, currentSubflow, subflows, viewingEntry, onSelectSubflow, onSelectEntry, onBackToParent }) => {\n    return React.createElement('div', { \n      style: { width: '260px', background: 'rgba(255,255,255,0.95)', backdropFilter: 'blur(8px)', borderRight: '1px solid #e5e7eb', display: 'flex', flexDirection: 'column', flexShrink: 0 } \n    },\n      React.createElement('div', { style: { padding: '16px', borderBottom: '1px solid #e5e7eb' } },\n        React.createElement('button', { onClick: onBackToParent, style: { display: 'flex', alignItems: 'center', gap: '8px', padding: '8px 12px', background: 'transparent', border: 'none', cursor: 'pointer', fontSize: '14px', color: '#6b7280', marginBottom: '12px' } }, \n          React.createElement(Icons.ArrowLeft, null), 'Back to Hub'\n        ),\n        React.createElement('div', { style: { padding: '12px', background: '#f9fafb', borderRadius: '8px', border: '1px solid #e5e7eb' } },\n          React.createElement('div', { style: { fontSize: '14px', fontWeight: 600, color: '#111827' } }, parentFlow?.name),\n          React.createElement('div', { style: { fontSize: '12px', color: '#6b7280', marginTop: '4px' } }, `Viewing: ${currentSubflow?.name}`)\n        )\n      ),\n      React.createElement('div', { style: { flex: 1, overflowY: 'auto', padding: '12px' } },\n        React.createElement('div', { style: { fontSize: '10px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#9ca3af', marginBottom: '8px', paddingLeft: '8px' } }, 'Entry Flow'),\n        React.createElement('div', {\n          onClick: onSelectEntry,\n          style: { display: 'flex', alignItems: 'center', gap: '10px', padding: '12px', borderRadius: '8px', cursor: 'pointer', marginBottom: '16px', background: viewingEntry ? `${parentFlow?.color}15` : 'transparent', border: viewingEntry ? `1px solid ${parentFlow?.color}40` : '1px solid transparent' }\n        },\n          React.createElement('div', { style: { width: '8px', height: '8px', borderRadius: '50%', background: viewingEntry ? parentFlow?.color : '#d1d5db' } }),\n          React.createElement('div', { style: { flex: 1 } },\n            React.createElement('div', { style: { fontSize: '13px', fontWeight: viewingEntry ? 600 : 500, color: viewingEntry ? '#111827' : '#374151' } }, 'Entry Flow'),\n            React.createElement('div', { style: { fontSize: '11px', color: '#9ca3af', marginTop: '2px' } }, `${parentFlow?.entryNodes?.length || 0} nodes`)\n          )\n        ),\n        React.createElement('div', { style: { fontSize: '10px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.05em', color: '#9ca3af', marginBottom: '8px', paddingLeft: '8px' } }, 'Sub-flows'),\n        subflows.map(subflow => \n          React.createElement('div', {\n            key: subflow.id,\n            onClick: () => onSelectSubflow(subflow),\n            style: { display: 'flex', alignItems: 'center', gap: '10px', padding: '12px', borderRadius: '8px', cursor: 'pointer', marginBottom: '4px', background: !viewingEntry && currentSubflow?.id === subflow.id ? `${parentFlow?.color}15` : 'transparent', border: !viewingEntry && currentSubflow?.id === subflow.id ? `1px solid ${parentFlow?.color}40` : '1px solid transparent' }\n          },\n            React.createElement('div', { style: { width: '8px', height: '8px', borderRadius: '50%', background: !viewingEntry && currentSubflow?.id === subflow.id ? parentFlow?.color : '#d1d5db' } }),\n            React.createElement('div', { style: { flex: 1, minWidth: 0 } },\n              React.createElement('div', { style: { fontSize: '13px', fontWeight: !viewingEntry && currentSubflow?.id === subflow.id ? 600 : 500, color: !viewingEntry && currentSubflow?.id === subflow.id ? '#111827' : '#374151', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis' } }, subflow.name),\n              React.createElement('div', { style: { fontSize: '11px', color: '#9ca3af', marginTop: '2px' } }, `${subflow.nodes?.length || 0} nodes`)\n            )\n          )\n        )\n      )\n    );\n  };\n\n  // ============================================\n  // PROPERTIES PANEL\n  // ============================================\n  const PropertiesPanel = ({ selectedNode }) => {\n    if (!selectedNode) {\n      return React.createElement('div', { style: { padding: '40px 24px', textAlign: 'center', color: '#9ca3af' } },\n        React.createElement('div', { style: { width: '64px', height: '64px', background: '#f3f4f6', borderRadius: '50%', display: 'flex', alignItems: 'center', justifyContent: 'center', margin: '0 auto 16px', color: '#9ca3af' } },\n          React.createElement('svg', { width: 32, height: 32, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },\n            React.createElement('circle', { cx: 12, cy: 12, r: 10 }),\n            React.createElement('path', { d: 'M9.09 9a3 3 0 0 1 5.83 1c0 2-3 3-3 3' }),\n            React.createElement('line', { x1: 12, y1: 17, x2: 12.01, y2: 17 })\n          )\n        ),\n        React.createElement('p', { style: { fontSize: '14px' } }, 'Select a node'),\n        React.createElement('p', { style: { fontSize: '12px', color: '#9ca3af', marginTop: '4px' } }, 'Click on any node in the canvas to view its properties and details')\n      );\n    }\n\n    const getIcon = () => {\n      const iconMap = { message: Icons.MessageSquare, options: Icons.List, condition: Icons.GitBranch, api: Icons.Zap, ai: Icons.Bot, offer: Icons.Gift, case: Icons.FolderOpen, form: Icons.FileText, end: Icons.Flag, start: Icons.Play };\n      const IconComp = iconMap[selectedNode.type] || Icons.Play;\n      return React.createElement(IconComp);\n    };\n\n    return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', height: '100%' } },\n      React.createElement('div', { style: { padding: '20px', borderBottom: '1px solid #f3f4f6' } },\n        React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },\n          React.createElement('div', { style: { width: '40px', height: '40px', borderRadius: '10px', background: (nodeColors[selectedNode.type] || '#94a3b8') + '15', display: 'flex', alignItems: 'center', justifyContent: 'center', color: nodeColors[selectedNode.type] || '#94a3b8' } }, getIcon()),\n          React.createElement('div', null,\n            React.createElement('h3', { style: { fontSize: '16px', fontWeight: 600, margin: 0, textTransform: 'capitalize', color: '#111827' } }, selectedNode.type === 'ai' ? 'AI Response' : selectedNode.type + ' Node'),\n            React.createElement('p', { style: { fontSize: '12px', color: '#9ca3af', margin: 0, marginTop: '2px' } }, `ID: ${selectedNode.id}`)\n          )\n        )\n      ),\n      React.createElement('div', { style: { flex: 1, padding: '20px', overflowY: 'auto' } },\n        React.createElement('div', { style: { marginBottom: '16px' } },\n          React.createElement('span', { style: { display: 'inline-block', padding: '4px 10px', background: (nodeColors[selectedNode.type] || '#94a3b8') + '15', color: nodeColors[selectedNode.type] || '#94a3b8', borderRadius: '6px', fontSize: '12px', fontWeight: 500, textTransform: 'uppercase', letterSpacing: '0.5px' } }, selectedNode.type)\n        ),\n        selectedNode.data?.persona && React.createElement('div', { style: { marginBottom: '16px' } },\n          React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' } }, 'Persona'),\n          React.createElement('div', { style: { padding: '12px 14px', background: '#f9fafb', borderRadius: '10px', fontSize: '14px', border: '1px solid #e5e7eb' } }, selectedNode.data.persona === 'amy' ? 'Amy (Support)' : selectedNode.data.persona === 'claudia' ? 'Claudia (Trainer)' : selectedNode.data.persona)\n        ),\n        selectedNode.data?.content && React.createElement('div', { style: { marginBottom: '16px' } },\n          React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' } }, 'Message'),\n          React.createElement('div', { style: { padding: '12px 14px', background: '#f9fafb', borderRadius: '10px', fontSize: '14px', border: '1px solid #e5e7eb', lineHeight: '1.5' } }, selectedNode.data.content)\n        ),\n        selectedNode.data?.service && React.createElement('div', { style: { marginBottom: '16px' } },\n          React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' } }, 'API Integration'),\n          React.createElement('div', { style: { padding: '12px 14px', background: '#f9fafb', borderRadius: '10px', fontSize: '13px', border: '1px solid #e5e7eb', fontFamily: 'monospace' } }, `${selectedNode.data.service} / ${selectedNode.data.endpoint}`)\n        ),\n        selectedNode.data?.percent && React.createElement('div', { style: { marginBottom: '16px' } },\n          React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase', letterSpacing: '0.5px' } }, 'Offer'),\n          React.createElement('div', { style: { padding: '16px', background: '#d1fae5', borderRadius: '10px', border: '1px solid #10b981' } },\n            React.createElement('div', { style: { fontSize: '24px', fontWeight: 700, color: '#10b981' } }, `${selectedNode.data.percent}% Refund`),\n            React.createElement('div', { style: { fontSize: '13px', color: '#047857', marginTop: '4px' } }, selectedNode.data.label)\n          )\n        )\n      )\n    );\n  };\n\n  // ============================================\n  // FLOW CANVAS COMPONENT (React Flow)\n  // ============================================\n  const FlowCanvas = ({ subflow, parentFlow, allSubflows, viewingEntry, onSelectSubflow, onSelectEntry, onSubflowNodeClick, onBackToFlows }) => {\n    if (!ReactFlowLoaded) {\n      return React.createElement('div', { style: { display: 'flex', alignItems: 'center', justifyContent: 'center', height: '100%', color: '#6b7280' } },\n        React.createElement('p', null, 'Loading React Flow...')\n      );\n    }\n\n    const nodeTypes = useMemo(() => createNodeComponents(), []);\n    const [nodes, setNodes, onNodesChange] = useNodesState(subflow.nodes || []);\n    const [edges, setEdges, onEdgesChange] = useEdgesState(subflow.edges || []);\n    const [selectedNode, setSelectedNode] = useState(null);\n\n    useEffect(() => {\n      setNodes(subflow.nodes || []);\n      setEdges(subflow.edges || []);\n      setSelectedNode(null);\n    }, [subflow.id]);\n\n    const onNodeClick = useCallback((event, node) => {\n      setSelectedNode(node);\n      if (node.type === 'subflow' && node.data?.slug) {\n        onSubflowNodeClick(node.data.slug);\n      }\n    }, [onSubflowNodeClick]);\n\n    const defaultEdgeOptions = { type: 'smoothstep', animated: true, style: { strokeWidth: 2, stroke: '#94a3b8' }, markerEnd: { type: MarkerType.ArrowClosed, color: '#94a3b8' } };\n\n    return React.createElement('div', { style: { display: 'flex', height: '100%' } },\n      React.createElement(LeftPanel, {\n        parentFlow: parentFlow,\n        currentSubflow: subflow,\n        subflows: allSubflows,\n        viewingEntry: viewingEntry,\n        onSelectSubflow: onSelectSubflow,\n        onSelectEntry: onSelectEntry,\n        onBackToParent: onBackToFlows\n      }),\n      React.createElement('div', { style: { flex: 1, display: 'flex', flexDirection: 'column', background: 'linear-gradient(135deg, #fef7f0 0%, #fdf2f8 25%, #f5f3ff 50%, #eff6ff 75%, #f0fdf4 100%)' } },\n        React.createElement('div', { style: { flex: 1 } },\n          React.createElement(ReactFlowComponent, {\n            nodes: nodes,\n            edges: edges,\n            onNodesChange: onNodesChange,\n            onEdgesChange: onEdgesChange,\n            onNodeClick: onNodeClick,\n            nodeTypes: nodeTypes,\n            defaultEdgeOptions: defaultEdgeOptions,\n            fitView: true,\n            fitViewOptions: { padding: 0.2 }\n          },\n            React.createElement(Background, { variant: 'dots', gap: 20, size: 1, color: '#e2e8f0' }),\n            React.createElement(Controls, null),\n            React.createElement(MiniMap, { nodeColor: (n) => nodeColors[n.type] || '#94a3b8', maskColor: 'rgba(255,255,255,0.8)' })\n          )\n        )\n      ),\n      React.createElement('div', { style: { width: '320px', background: 'rgba(255,255,255,0.98)', backdropFilter: 'blur(8px)', borderLeft: '1px solid #e5e7eb', display: 'flex', flexDirection: 'column', flexShrink: 0 } },\n        React.createElement(PropertiesPanel, { selectedNode: selectedNode })\n      )\n    );\n  };\n\n  // ============================================\n  // FLOW SETTINGS (Main Entry View)\n  // ============================================\n  const FlowSettings = ({ onSelectParent }) => {\n    const cardStyle = { background: 'white', borderRadius: '16px', border: '1px solid #e5e7eb', padding: '24px', cursor: 'pointer', transition: 'all 0.2s', boxShadow: '0 2px 8px rgba(0,0,0,0.04)' };\n\n    return React.createElement('div', { style: { padding: '32px', height: '100%', overflow: 'auto' } },\n      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '16px', marginBottom: '8px' } },\n        React.createElement(Icons.Settings, { style: { width: '32px', height: '32px', color: '#6b7280' } }),\n        React.createElement('h1', { style: { fontSize: '28px', fontWeight: 600, color: '#111827', margin: 0, fontFamily: \"'Space Grotesk', sans-serif\" } }, 'Flow Settings')\n      ),\n      React.createElement('p', { style: { color: '#6b7280', marginBottom: '32px' } }, 'Configure what customers see and experience in each flow'),\n      React.createElement('div', { style: { display: 'grid', gridTemplateColumns: 'repeat(auto-fill, minmax(320px, 1fr))', gap: '20px' } },\n        FLOW_DATA.parentFlows.map(flow => \n          React.createElement('div', {\n            key: flow.id,\n            style: cardStyle,\n            onClick: () => onSelectParent(flow),\n            onMouseEnter: e => { e.currentTarget.style.borderColor = flow.color; e.currentTarget.style.boxShadow = `0 8px 24px ${flow.color}20`; e.currentTarget.style.transform = 'translateY(-2px)'; },\n            onMouseLeave: e => { e.currentTarget.style.borderColor = '#e5e7eb'; e.currentTarget.style.boxShadow = '0 2px 8px rgba(0,0,0,0.04)'; e.currentTarget.style.transform = 'translateY(0)'; }\n          },\n            React.createElement('div', { style: { display: 'flex', alignItems: 'flex-start', gap: '16px' } },\n              React.createElement('div', { style: { width: '56px', height: '56px', background: `${flow.color}15`, borderRadius: '14px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '24px', flexShrink: 0 } }, flow.icon),\n              React.createElement('div', { style: { flex: 1 } },\n                React.createElement('div', { style: { fontWeight: 600, fontSize: '16px', marginBottom: '4px' } }, flow.name),\n                React.createElement('div', { style: { fontSize: '14px', color: '#6b7280', marginBottom: '12px' } }, flow.description),\n                React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '6px' } },\n                  (flow.tags || []).map((tag, i) => React.createElement('span', { key: i, style: { padding: '4px 8px', background: '#f3f4f6', borderRadius: '6px', fontSize: '12px', color: '#6b7280' } }, tag))\n                )\n              )\n            ),\n            React.createElement('div', { style: { marginTop: '16px', paddingTop: '16px', borderTop: '1px solid #f3f4f6', display: 'flex', justifyContent: 'flex-end', alignItems: 'center' } },\n              React.createElement('div', { style: { width: '32px', height: '32px', background: '#f3f4f6', borderRadius: '8px', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#6b7280' } },\n                React.createElement(Icons.ChevronRight, null)\n              )\n            )\n          )\n        )\n      )\n    );\n  };\n\n  // ============================================\n  // MAIN APP COMPONENT\n  // ============================================\n  const FlowDocsApp = () => {\n    const [view, setView] = useState('settings');\n    const [selectedParent, setSelectedParent] = useState(null);\n    const [selectedSubflow, setSelectedSubflow] = useState(null);\n    const [viewingEntry, setViewingEntry] = useState(false);\n\n    const handleSelectParent = (parent) => {\n      setSelectedParent(parent);\n      const firstSubflowId = parent.subflows[0];\n      const firstSubflow = FLOW_DATA.subflows[firstSubflowId];\n      setSelectedSubflow(firstSubflow);\n      setViewingEntry(false);\n      setView('canvas');\n    };\n\n    const handleSelectSubflow = (subflow) => {\n      setSelectedSubflow(subflow);\n      setViewingEntry(false);\n    };\n\n    const handleSelectEntry = () => {\n      setSelectedSubflow({ id: 'entry', name: 'Entry Flow', nodes: selectedParent.entryNodes, edges: selectedParent.entryEdges });\n      setViewingEntry(true);\n    };\n\n    const handleSubflowNodeClick = (slug) => {\n      const subflow = FLOW_DATA.subflows[slug];\n      if (subflow) {\n        setSelectedSubflow(subflow);\n        setViewingEntry(false);\n      }\n    };\n\n    const handleBackToFlows = () => {\n      setSelectedParent(null);\n      setSelectedSubflow(null);\n      setViewingEntry(false);\n      setView('settings');\n    };\n\n    const allSubflows = selectedParent ? selectedParent.subflows.map(id => FLOW_DATA.subflows[id]).filter(Boolean) : [];\n\n    if (view === 'canvas' && selectedSubflow && selectedParent) {\n      return React.createElement(FlowCanvas, {\n        subflow: selectedSubflow,\n        parentFlow: selectedParent,\n        allSubflows: allSubflows,\n        viewingEntry: viewingEntry,\n        onSelectSubflow: handleSelectSubflow,\n        onSelectEntry: handleSelectEntry,\n        onSubflowNodeClick: handleSubflowNodeClick,\n        onBackToFlows: handleBackToFlows\n      });\n    }\n\n    return React.createElement(FlowSettings, { onSelectParent: handleSelectParent });\n  };\n\n  // ============================================\n  // MOUNT THE APP\n  // ============================================\n  window.FlowDocsReact = {\n    mount: function(container) {\n      if (!container) {\n        console.error('FlowDocsReact: No container provided');\n        return;\n      }\n      const root = ReactDOM.createRoot(container);\n      root.render(React.createElement(FlowDocsApp));\n      return root;\n    },\n    unmount: function(root) {\n      if (root) {\n        root.unmount();\n      }\n    }\n  };\n\n  console.log('FlowDocsReact loaded and ready (React Flow version)');\n})();\n";
}

// Flow Docs HTML Asset

function getFlowDocsHTML() {
  return `<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flow Documentation | PuppyPad Resolution Hub</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- React Flow v11 -->
  <script src="https://unpkg.com/reactflow@11.10.4/dist/umd/index.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.4/dist/style.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
    }
    
    h1, h2, h3, h4 {
      font-family: 'Space Grotesk', sans-serif;
    }
    
    #root {
      height: 100vh;
    }
    
    /* React Flow handle styling */
    .react-flow__handle {
      width: 10px !important;
      height: 10px !important;
      border-radius: 50% !important;
      border: 2px solid white !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
    }
    
    .react-flow__handle-top {
      top: -5px !important;
    }
    
    .react-flow__handle-bottom {
      bottom: -5px !important;
    }
    
    .react-flow__edge-path {
      stroke-width: 2px;
    }
    
    .react-flow__edge.animated path {
      stroke-dasharray: 5;
      animation: dashdraw 0.5s linear infinite;
    }
    
    @keyframes dashdraw {
      from { stroke-dashoffset: 10; }
      to { stroke-dashoffset: 0; }
    }
    
    .react-flow__background {
      background-color: transparent !important;
    }
    
    .react-flow__minimap {
      background: rgba(255,255,255,0.9) !important;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .react-flow__controls {
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
    }
    
    .react-flow__controls-button {
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .react-flow__controls-button:hover {
      background: #f9fafb;
    }

    /* Flow card styles */
    .flow-card {
      background: rgba(255, 255, 255, 0.95);
      backdrop-filter: blur(20px);
      -webkit-backdrop-filter: blur(20px);
      border-radius: 14px;
      border: 1px solid rgba(0, 0, 0, 0.06);
      padding: 16px 18px;
      cursor: pointer;
      transition: all 0.25s cubic-bezier(0.4, 0, 0.2, 1);
      margin-bottom: 10px;
      box-shadow: 0 1px 3px rgba(0, 0, 0, 0.04);
    }
    
    .flow-card:hover {
      border-color: rgba(26, 54, 93, 0.15);
      box-shadow: 0 4px 16px rgba(26, 54, 93, 0.08);
      transform: translateY(-2px);
      background: rgba(255, 255, 255, 1);
    }
    
    .flow-card.active {
      border-color: #1a365d;
      background: linear-gradient(135deg, rgba(26, 54, 93, 0.08) 0%, rgba(26, 54, 93, 0.04) 100%);
      box-shadow: 0 4px 16px rgba(26, 54, 93, 0.12);
    }
    
    .flow-card.parent {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
    }
    
    .flow-card.parent:hover {
      background: rgba(255, 255, 255, 0.95);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    (function() {
      const { useState, useCallback, useEffect, useMemo } = React;
      const { 
        ReactFlow: ReactFlowComponent, 
        Controls, 
        Background, 
        MiniMap,
        useNodesState, 
        useEdgesState,
        Handle,
        Position,
        MarkerType
      } = window.ReactFlow;

      // ============================================
      // SVG ICONS
      // ============================================
      const Icons = {
        Play: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'currentColor', stroke: 'none' },
          React.createElement('polygon', { points: '5 3 19 12 5 21 5 3' })
        ),
        MessageSquare: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z' })
        ),
        List: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('line', { x1: 8, y1: 6, x2: 21, y2: 6 }),
          React.createElement('line', { x1: 8, y1: 12, x2: 21, y2: 12 }),
          React.createElement('line', { x1: 8, y1: 18, x2: 21, y2: 18 }),
          React.createElement('line', { x1: 3, y1: 6, x2: 3.01, y2: 6 }),
          React.createElement('line', { x1: 3, y1: 12, x2: 3.01, y2: 12 }),
          React.createElement('line', { x1: 3, y1: 18, x2: 3.01, y2: 18 })
        ),
        GitBranch: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('line', { x1: 6, y1: 3, x2: 6, y2: 15 }),
          React.createElement('circle', { cx: 18, cy: 6, r: 3 }),
          React.createElement('circle', { cx: 6, cy: 18, r: 3 }),
          React.createElement('path', { d: 'M18 9a9 9 0 0 1-9 9' })
        ),
        Zap: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polygon', { points: '13 2 3 14 12 14 11 22 21 10 12 10 13 2' })
        ),
        Bot: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('rect', { x: 3, y: 11, width: 18, height: 10, rx: 2 }),
          React.createElement('circle', { cx: 12, cy: 5, r: 2 }),
          React.createElement('path', { d: 'M12 7v4' }),
          React.createElement('line', { x1: 8, y1: 16, x2: 8, y2: 16 }),
          React.createElement('line', { x1: 16, y1: 16, x2: 16, y2: 16 })
        ),
        Gift: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polyline', { points: '20 12 20 22 4 22 4 12' }),
          React.createElement('rect', { x: 2, y: 7, width: 20, height: 5 }),
          React.createElement('line', { x1: 12, y1: 22, x2: 12, y2: 7 }),
          React.createElement('path', { d: 'M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z' }),
          React.createElement('path', { d: 'M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z' })
        ),
        FolderOpen: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' }),
          React.createElement('path', { d: 'M2 10h20' })
        ),
        FileText: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }),
          React.createElement('polyline', { points: '14 2 14 8 20 8' }),
          React.createElement('line', { x1: 16, y1: 13, x2: 8, y2: 13 }),
          React.createElement('line', { x1: 16, y1: 17, x2: 8, y2: 17 }),
          React.createElement('polyline', { points: '10 9 9 9 8 9' })
        ),
        Flag: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z' }),
          React.createElement('line', { x1: 4, y1: 22, x2: 4, y2: 15 })
        ),
        ArrowLeft: () => React.createElement('svg', { width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('line', { x1: 19, y1: 12, x2: 5, y2: 12 }),
          React.createElement('polyline', { points: '12 19 5 12 12 5' })
        ),
        ChevronRight: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polyline', { points: '9 18 15 12 9 6' })
        ),
        ChevronDown: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polyline', { points: '6 9 12 15 18 9' })
        ),
        Eye: () => React.createElement('svg', { width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z' }),
          React.createElement('circle', { cx: 12, cy: 12, r: 3 })
        ),
        Layers: () => React.createElement('svg', { width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polygon', { points: '12 2 2 7 12 12 22 7 12 2' }),
          React.createElement('polyline', { points: '2 17 12 22 22 17' }),
          React.createElement('polyline', { points: '2 12 12 17 22 12' })
        ),
        Chat: () => React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z' })
        ),
        Package: () => React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M21 16V8a2 2 0 0 0-1-1.73l-7-4a2 2 0 0 0-2 0l-7 4A2 2 0 0 0 3 8v8a2 2 0 0 0 1 1.73l7 4a2 2 0 0 0 2 0l7-4A2 2 0 0 0 21 16z' }),
          React.createElement('polyline', { points: '3.27 6.96 12 12.01 20.73 6.96' }),
          React.createElement('line', { x1: 12, y1: 22.08, x2: 12, y2: 12 })
        ),
        Refresh: () => React.createElement('svg', { width: 20, height: 20, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polyline', { points: '23 4 23 10 17 10' }),
          React.createElement('polyline', { points: '1 20 1 14 7 14' }),
          React.createElement('path', { d: 'M3.51 9a9 9 0 0 1 14.85-3.36L23 10M1 14l4.64 4.36A9 9 0 0 0 20.49 15' })
        )
      };

      // Node colors - expanded for new node types
      const nodeColors = {
        start: '#22c55e',
        message: '#3b82f6',
        options: '#8b5cf6',
        condition: '#f59e0b',
        api: '#ec4899',
        ai: '#6366f1',
        offer: '#14b8a6',
        case: '#f97316',
        form: '#10b981',
        end: '#ef4444',
        subflow: '#8b5cf6',
        timeCheck: '#0ea5e9',
        guaranteeCheck: '#8b5cf6',
        managerDelay: '#f97316',
        evidence: '#06b6d4',
        tracking: '#0284c7',
        input: '#10b981',
        delay: '#f59e0b'
      };

      // ============================================
      // COMPREHENSIVE FLOW DATA - All 3 Parent Flows + 11 Intent Subflows
      // ============================================
      // âš ï¸ SYNC REMINDER: This data must match app.js exactly!
      // - Messages must match message text in app.js functions
      // - Form fields must match form rendering in app.js
      // - Persona roles must match PERSONAS constant in app.js
      // - See SYNC_CHECKLIST.md for update instructions
      // ============================================
      const FLOW_DATA = {
        parentFlows: [
          { 
            id: 'help_with_order', 
            name: 'Help With My Order', 
            icon: React.createElement(Icons.Chat, { width: 22, height: 22 }),
            color: '#8b5cf6', 
            description: 'Customer needs assistance with an existing order - refunds, returns, issues',
            subflows: ['dog_not_using', 'changed_mind', 'not_met_expectations', 'ordered_mistake', 'missing_item', 'wrong_item', 'damaged', 'charged_unexpectedly', 'not_received', 'quality_difference', 'other_reason', 'change_order', 'existing_case_check', 'unfulfilled_order_handling'],
            entryNodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 600, y: 0 }, data: { label: 'Customer clicks Help With Order' } },
              { id: 'msg1', type: 'message', position: { x: 550, y: 350 }, data: { persona: 'amy', content: "Hi! I'm Amy from PuppyPad. I can sort this out with you right here so you don't have to go back and forth over email. Just enter your details below. ðŸ™‚" } },
              { id: 'form1', type: 'form', position: { x: 550, y: 700 }, data: { formType: 'Customer Lookup', label: 'Email or Order Number', fields: ['email', 'orderNumber'] } },
              { id: 'api1', type: 'api', position: { x: 550, y: 1050 }, data: { service: 'Shopify', endpoint: '/api/lookup', description: 'Find customer orders by email or order number', request: '{ email, orderNumber }', response: '{ orders[], customer }' } },
              { id: 'cond1', type: 'condition', position: { x: 550, y: 1400 }, data: { variable: 'orders.length', operator: '>', value: '0', yesLabel: 'Found', noLabel: 'Not Found' } },
              // Found branch - left side (300px offset)
              { id: 'subflow_existing_case', type: 'subflow', position: { x: 250, y: 1750 }, data: { name: 'Existing Case Check', slug: 'existing_case_check', nodeCount: 6 } },
              { id: 'subflow_unfulfilled', type: 'subflow', position: { x: 250, y: 2100 }, data: { name: 'Unfulfilled Order Handling', slug: 'unfulfilled_order_handling', nodeCount: 10 } },
              { id: 'itemSelect', type: 'form', position: { x: 250, y: 2450 }, data: { formType: 'Item Selection', label: 'Which items need help?', description: 'Customer selects affected items from their order' } },
              // Not found branch - right side (300px offset)
              { id: 'deepSearch', type: 'form', position: { x: 850, y: 1750 }, data: { formType: 'Deep Search', label: 'More details needed', fields: ['firstName', 'lastName', 'address1', 'country'] } },
              // Intent options
              { id: 'opts1', type: 'options', position: { x: 250, y: 2800 }, data: { prompt: "Got it! What's going on with your order?", options: [
                { label: "My dog isn't using it", icon: 'ðŸ•' },
                { label: 'I changed my mind', icon: 'ðŸ’­' },
                { label: "It didn't meet expectations", icon: 'ðŸ˜•' },
                { label: 'Ordered by mistake', icon: 'ðŸ”„' },
                { label: 'Something was missing', icon: 'ðŸ“¦' },
                { label: 'Wrong item received', icon: 'ðŸ”€' },
                { label: 'Order arrived damaged', icon: 'ðŸ’”' },
                { label: 'Charged unexpectedly', icon: 'ðŸ’³' },
                { label: "Haven't received order", icon: 'ðŸšš' },
                { label: 'Quality difference', icon: 'ðŸ”' },
                { label: 'Other reason', icon: 'â“' }
              ] } },
              // Intent subflows - Row 1 (500px horizontal spacing between each)
              { id: 'sub1', type: 'subflow', position: { x: -500, y: 3200 }, data: { name: 'Dog Not Using', slug: 'dog_not_using', nodeCount: 15 } },
              { id: 'sub2', type: 'subflow', position: { x: 0, y: 3200 }, data: { name: 'Changed Mind', slug: 'changed_mind', nodeCount: 23 } },
              { id: 'sub3', type: 'subflow', position: { x: 500, y: 3200 }, data: { name: 'Not Met Expectations', slug: 'not_met_expectations', nodeCount: 10 } },
              { id: 'sub4', type: 'subflow', position: { x: 1000, y: 3200 }, data: { name: 'Ordered Mistake', slug: 'ordered_mistake', nodeCount: 10 } },
              // Intent subflows - Row 2 (400px vertical from row 1)
              { id: 'sub5', type: 'subflow', position: { x: -500, y: 3600 }, data: { name: 'Missing Item', slug: 'missing_item', nodeCount: 12 } },
              { id: 'sub6', type: 'subflow', position: { x: 0, y: 3600 }, data: { name: 'Wrong Item', slug: 'wrong_item', nodeCount: 10 } },
              { id: 'sub7', type: 'subflow', position: { x: 500, y: 3600 }, data: { name: 'Damaged', slug: 'damaged', nodeCount: 11 } },
              { id: 'sub8', type: 'subflow', position: { x: 1000, y: 3600 }, data: { name: 'Charged Unexpectedly', slug: 'charged_unexpectedly', nodeCount: 27 } },
              // Intent subflows - Row 3 (400px vertical from row 2)
              { id: 'sub9', type: 'subflow', position: { x: -500, y: 4000 }, data: { name: 'Not Received', slug: 'not_received', nodeCount: 18 } },
              { id: 'sub10', type: 'subflow', position: { x: 0, y: 4000 }, data: { name: 'Quality Difference', slug: 'quality_difference', nodeCount: 25 } },
              { id: 'sub11', type: 'subflow', position: { x: 500, y: 4000 }, data: { name: 'Other Reason', slug: 'other_reason', nodeCount: 8 } }
            ],
            entryEdges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'api1', animated: true },
              { id: 'e4', source: 'api1', target: 'cond1', animated: true },
              { id: 'e5', source: 'cond1', target: 'subflow_existing_case', sourceHandle: 'yes', label: 'Orders found', animated: true },
              { id: 'e6', source: 'cond1', target: 'deepSearch', sourceHandle: 'no', label: 'Not found', animated: true },
              { id: 'e7', source: 'subflow_existing_case', target: 'subflow_unfulfilled', label: 'No existing case', animated: true },
              { id: 'e8', source: 'subflow_unfulfilled', target: 'itemSelect', label: 'Fulfilled or >10h', animated: true },
              { id: 'e9', source: 'itemSelect', target: 'opts1', animated: true },
              { id: 'e10', source: 'deepSearch', target: 'api1', label: 'Retry search', animated: true },
              { id: 'e11', source: 'opts1', target: 'sub1', label: 'Dog not using', animated: true },
              { id: 'e12', source: 'opts1', target: 'sub2', label: 'Changed mind', animated: true },
              { id: 'e13', source: 'opts1', target: 'sub3', label: 'Not met expectations', animated: true },
              { id: 'e14', source: 'opts1', target: 'sub4', label: 'Ordered mistake', animated: true },
              { id: 'e15', source: 'opts1', target: 'sub5', label: 'Missing item', animated: true },
              { id: 'e16', source: 'opts1', target: 'sub6', label: 'Wrong item', animated: true },
              { id: 'e17', source: 'opts1', target: 'sub7', label: 'Damaged', animated: true },
              { id: 'e18', source: 'opts1', target: 'sub8', label: 'Charged', animated: true },
              { id: 'e19', source: 'opts1', target: 'sub9', label: 'Not received', animated: true },
              { id: 'e20', source: 'opts1', target: 'sub10', label: 'Quality', animated: true },
              { id: 'e21', source: 'opts1', target: 'sub11', label: 'Other', animated: true }
            ]
          },
          { 
            id: 'track_order', 
            name: 'Track My Order', 
            icon: React.createElement(Icons.Package, { width: 22, height: 22 }),
            color: '#3b82f6', 
            description: 'Customer wants to check order status and tracking information',
            subflows: ['tracking_flow'],
            entryNodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Customer clicks Track Order' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "Hi! I'm Amy. Let me help you track your order â€” just enter your details below and I'll pull it right up. ðŸ“¦" } },
              { id: 'sub1', type: 'subflow', position: { x: 450, y: 700 }, data: { name: 'Order Tracking Flow', slug: 'tracking_flow', nodeCount: 65 } }
            ],
            entryEdges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'sub1', animated: true }
            ]
          },
          { 
            id: 'manage_subscription', 
            name: 'Manage My Subscription', 
            icon: React.createElement(Icons.Refresh, { width: 22, height: 22 }),
            color: '#10b981', 
            description: 'Customer wants to pause, cancel, or modify their subscription',
            subflows: ['pause_subscription', 'cancel_subscription', 'subscription_ladder', 'change_frequency'],
            entryNodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Customer clicks Manage Subscription' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "Hi! I'm Amy. I'll help you manage your subscription â€” just enter your details below to get started. ðŸ”„" } },
              { id: 'form1', type: 'form', position: { x: 450, y: 700 }, data: { formType: 'Customer Lookup', label: 'Find Your Subscription' } },
              { id: 'api1', type: 'api', position: { x: 450, y: 1050 }, data: { service: 'Shopify', endpoint: '/api/subscriptions', description: 'Find active subscriptions', request: '{ email }', response: '{ subscriptions[] }' } },
              { id: 'opts1', type: 'options', position: { x: 450, y: 1400 }, data: { prompt: 'What would you like to do with your subscription?', options: [{ label: 'Pause subscription', icon: 'â¸ï¸' }, { label: 'Cancel subscription', icon: 'âŒ' }, { label: 'Change delivery schedule', icon: 'ðŸ“…' }, { label: 'Change shipping address', icon: 'ðŸ“' }] } },
              { id: 'sub1', type: 'subflow', position: { x: -50, y: 1800 }, data: { name: 'Pause Subscription', slug: 'pause_subscription', nodeCount: 8 } },
              { id: 'sub2', type: 'subflow', position: { x: 450, y: 1800 }, data: { name: 'Cancel Subscription', slug: 'cancel_subscription', nodeCount: 15 } },
              { id: 'sub3', type: 'subflow', position: { x: 950, y: 1800 }, data: { name: 'Change Frequency', slug: 'change_frequency', nodeCount: 10 } },
              { id: 'sub4', type: 'subflow', position: { x: 1450, y: 1800 }, data: { name: 'Change Address', slug: 'change_address', nodeCount: 8 } }
            ],
            entryEdges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'api1', animated: true },
              { id: 'e4', source: 'api1', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'sub1', sourceHandle: 'opt-0', label: 'Pause', animated: true },
              { id: 'e6', source: 'opts1', target: 'sub2', sourceHandle: 'opt-1', label: 'Cancel', animated: true },
              { id: 'e7', source: 'opts1', target: 'sub3', sourceHandle: 'opt-2', label: 'Schedule', animated: true },
              { id: 'e8', source: 'opts1', target: 'sub4', sourceHandle: 'opt-3', label: 'Address', animated: true }
            ]
          }
        ],
        subflows: {
          // DOG NOT USING - Claudia AI Tips Flow (Expanded with satisfaction check and refund ladder)
          dog_not_using: {
            id: 'dog_not_using',
            parentId: 'help_with_order',
            name: 'Dog Not Using Product',
            description: 'Customer reports their dog is not using the PuppyPad - handled by trainer Claudia with personalized tips, satisfaction check, then INLINE refund ladder (20%â†’30%â†’40%â†’50%â†’full)',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Dog Not Using Flow' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "I understand â€” the main reason you purchased this was to solve your problem, and we want to make sure it works for you! ðŸ•<br><br>Let me get some details about your pup so we can help." } },
              { id: 'form1', type: 'form', position: { x: 450, y: 700 }, data: { formType: 'Dog Info Form', label: 'Tell us about your dog', fields: ['dogName', 'dogBreed', 'dogAge', 'methodsTried'], description: 'Supports multiple dogs with Add Another Dog button' } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "Thanks for sharing! I'm connecting you with our dog trainer, Claudia. She's amazing at this! ðŸ¾â¤ï¸" } },
              { id: 'ai1', type: 'ai', position: { x: 450, y: 1400 }, data: { 
                persona: 'claudia', 
                model: 'gpt-4o',
                temperature: 0.75,
                maxTokens: 1000,
                scenarioType: 'dog_tips',
                systemPrompt: "You are Claudia, a compassionate dog trainer who specializes in dog behavior. The PuppyPad is infused with pheromones that naturally attract dogs. Give breed-specific and age-appropriate advice. ALWAYS use the dog's actual name throughout.",
                userPromptTemplate: "Dog: {{dogName}} ({{dogBreed}}, {{dogAge}}). What they've tried: {{methodsTried}}. Write warm HTML response with personalized tips."
              } },
              { id: 'msg_claudia_tips', type: 'message', position: { x: 450, y: 1750 }, data: { persona: 'claudia', content: "{{aiGeneratedTips}}" } },
              { id: 'msg_amy_back', type: 'message', position: { x: 450, y: 2100 }, data: { persona: 'amy', content: "Did Claudia's tips help? Are you happy to give these a try?" } },
              // Satisfaction check - 300px offset for branches
              { id: 'satisfaction_check', type: 'form', position: { x: 450, y: 2450 }, data: { formType: 'Satisfaction Buttons', label: 'Satisfaction Check', options: ['Yes, I\\'ll try these!', 'No, I need more help'] } },
              // Happy path - left branch
              { id: 'msg_happy', type: 'message', position: { x: -100, y: 2800 }, data: { persona: 'amy', content: "That's great to hear! ðŸŽ‰ Give it a go and remember â€” consistency is key. You've got this!<br><br>Is there anything else I can help you with?" } },
              { id: 'opts_anything_else', type: 'options', position: { x: -100, y: 3150 }, data: { prompt: 'Anything else?', options: [{ label: "No, I'm all set!", icon: 'âœ…' }, { label: 'Yes, something else', icon: 'ðŸ”„' }] } },
              { id: 'end_happy', type: 'end', position: { x: -400, y: 3500 }, data: { title: 'Tips Accepted!', showSurvey: true } },
              { id: 'end_home', type: 'end', position: { x: 200, y: 3500 }, data: { title: 'Back to Home', showSurvey: false } },
              
              // ========== INLINE REFUND LADDER (right branch) ==========
              // 90-day guarantee check
              { id: 'cond_guarantee', type: 'condition', position: { x: 900, y: 2800 }, data: { variable: 'guarantee.eligible', operator: '===', value: 'true', yesLabel: 'Within 90 days', noLabel: 'Expired' } },
              { id: 'msg_guarantee_expired', type: 'message', position: { x: 1300, y: 3150 }, data: { persona: 'amy', content: "I really wish I could help with a refund, but the 90-day guarantee period has expired. Let me create a case for our team to review." } },
              { id: 'case_guarantee_expired', type: 'case', position: { x: 1300, y: 3500 }, data: { type: 'refund', subtype: 'guarantee_expired', priority: 'normal' } },
              { id: 'end_guarantee_expired', type: 'end', position: { x: 1300, y: 3850 }, data: { title: 'Case for Review', showSurvey: true } },
              
              // STEP 1: 20% offer
              { id: 'offer_20', type: 'offer', position: { x: 600, y: 3150 }, data: { percent: 20, label: '20% Refund', message: "I understand. As a valued customer, I'd like to offer you a <strong>20% partial refund ({{refundAmount20}})</strong> while you keep the product." } },
              { id: 'opts_20', type: 'options', position: { x: 600, y: 3500 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 20%', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: 300, y: 3850 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20', type: 'end', position: { x: 300, y: 4200 }, data: { title: '20% Refund!', showSurvey: true } },
              
              // STEP 2: 30% offer
              { id: 'offer_30', type: 'offer', position: { x: 600, y: 3850 }, data: { percent: 30, label: '30% Refund', message: "I really want to make this right. Let me offer you a <strong>30% refund ({{refundAmount30}})</strong> â€” that's a significant amount back." } },
              { id: 'opts_30', type: 'options', position: { x: 600, y: 4200 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: 300, y: 4550 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30', type: 'end', position: { x: 300, y: 4900 }, data: { title: '30% Refund!', showSurvey: true } },
              
              // Manager delay 1
              { id: 'msg_manager1', type: 'message', position: { x: 600, y: 4550 }, data: { persona: 'amy', content: "Let me check with my manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 600, y: 4900 }, data: { duration: 8000, message: 'Checking with manager...' } },
              
              // STEP 3: 40% offer
              { id: 'offer_40', type: 'offer', position: { x: 600, y: 5250 }, data: { percent: 40, label: '40% Refund (Manager Approved)', message: "Great news! My manager approved a <strong>40% refund ({{refundAmount40}})</strong> for you." } },
              { id: 'opts_40', type: 'options', position: { x: 600, y: 5600 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: 300, y: 5950 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40', type: 'end', position: { x: 300, y: 6300 }, data: { title: '40% Refund!', showSurvey: true } },
              
              // Manager delay 2
              { id: 'msg_manager2', type: 'message', position: { x: 600, y: 5950 }, data: { persona: 'amy', content: "Let me speak with my manager one more time..." } },
              { id: 'delay2', type: 'delay', position: { x: 600, y: 6300 }, data: { duration: 8000, message: 'Final manager check...' } },
              
              // STEP 4: 50% offer (final)
              { id: 'offer_50', type: 'offer', position: { x: 600, y: 6650 }, data: { percent: 50, label: '50% Maximum Offer', message: "My manager approved our <strong>maximum: 50% refund ({{refundAmount50}})</strong>. This is the very best we can do." } },
              { id: 'opts_50', type: 'options', position: { x: 600, y: 7000 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: 300, y: 7350 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50', type: 'end', position: { x: 300, y: 7700 }, data: { title: '50% Refund!', showSurvey: true } },
              
              // STEP 5: Full refund
              { id: 'msg_full_refund', type: 'message', position: { x: 600, y: 7350 }, data: { persona: 'amy', content: "I understand. I'll process a full refund for you. Expect 3-5 business days." } },
              { id: 'case_full', type: 'case', position: { x: 600, y: 7700 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 600, y: 8050 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'ai1', animated: true },
              { id: 'e5', source: 'ai1', target: 'msg_claudia_tips', animated: true },
              { id: 'e6', source: 'msg_claudia_tips', target: 'msg_amy_back', animated: true },
              { id: 'e7', source: 'msg_amy_back', target: 'satisfaction_check', animated: true },
              { id: 'e8', source: 'satisfaction_check', target: 'msg_happy', sourceHandle: 'opt-0', label: 'Yes, will try!', animated: true },
              { id: 'e9', source: 'satisfaction_check', target: 'cond_guarantee', sourceHandle: 'opt-1', label: 'Need more help', animated: true },
              { id: 'e10', source: 'msg_happy', target: 'opts_anything_else', animated: true },
              { id: 'e11', source: 'opts_anything_else', target: 'end_happy', sourceHandle: 'opt-0', label: 'All set', animated: true },
              { id: 'e12', source: 'opts_anything_else', target: 'end_home', sourceHandle: 'opt-1', label: 'Something else', animated: true },
              // Guarantee check
              { id: 'e13', source: 'cond_guarantee', target: 'offer_20', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e14', source: 'cond_guarantee', target: 'msg_guarantee_expired', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e15', source: 'msg_guarantee_expired', target: 'case_guarantee_expired', animated: true },
              { id: 'e16', source: 'case_guarantee_expired', target: 'end_guarantee_expired', animated: true },
              // 20% ladder
              { id: 'e17', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e18', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e19', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e20', source: 'case_20', target: 'end_20', animated: true },
              // 30% ladder
              { id: 'e21', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e22', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e23', source: 'opts_30', target: 'msg_manager1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e24', source: 'case_30', target: 'end_30', animated: true },
              // Manager delay 1 â†’ 40%
              { id: 'e25', source: 'msg_manager1', target: 'delay1', animated: true },
              { id: 'e26', source: 'delay1', target: 'offer_40', animated: true },
              // 40% ladder
              { id: 'e27', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e28', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e29', source: 'opts_40', target: 'msg_manager2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e30', source: 'case_40', target: 'end_40', animated: true },
              // Manager delay 2 â†’ 50%
              { id: 'e31', source: 'msg_manager2', target: 'delay2', animated: true },
              { id: 'e32', source: 'delay2', target: 'offer_50', animated: true },
              // 50% ladder
              { id: 'e33', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e34', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e35', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e36', source: 'case_50', target: 'end_50', animated: true },
              // Full refund
              { id: 'e37', source: 'msg_full_refund', target: 'case_full', animated: true },
              { id: 'e38', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          // CHANGED MIND - AI Persuasion + Satisfaction Check + INLINE Refund Ladder
          changed_mind: {
            id: 'changed_mind',
            parentId: 'help_with_order',
            name: 'Changed My Mind',
            description: 'Customer wants a refund - AI persuasion, satisfaction check, then INLINE refund ladder (20%â†’30%â†’40%â†’50%â†’full)',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 600, y: 0 }, data: { label: 'Changed Mind Flow' } },
              { id: 'msg1', type: 'message', position: { x: 550, y: 350 }, data: { persona: 'amy', content: "No problem! Can you tell me a bit more about why you changed your mind? This helps me understand how to best help you." } },
              { id: 'input1', type: 'form', position: { x: 550, y: 700 }, data: { formType: 'Text Input', label: 'Tell us more...', placeholder: 'What made you change your mind?' } },
              { id: 'ai1', type: 'ai', position: { x: 550, y: 1050 }, data: { 
                persona: 'amy', 
                model: 'gpt-4o-mini',
                temperature: 0.7,
                maxTokens: 800,
                scenarioType: 'changed_mind',
                systemPrompt: "You are Amy, a warm customer support specialist. Identify WHY they changed their mind (pet loss, dog trained, impulse buy, too many, found elsewhere, moving, timing, financial, misunderstood, vague). Respond appropriately to each reason. Be warm but don't mention refunds.",
                userPromptTemplate: "Customer: {{customerName}}. Their message: {{customerMessage}}. Products ordered: {{orderItems}}"
              } },
              { id: 'msg_ai_response', type: 'message', position: { x: 550, y: 1400 }, data: { persona: 'amy', content: "{{aiGeneratedResponse}}" } },
              // Satisfaction check
              { id: 'opts_satisfaction', type: 'options', position: { x: 550, y: 1750 }, data: { prompt: 'Does this help? Would you like to keep your order?', options: [{ label: "Yes, I'll keep it!", icon: 'âœ¨' }, { label: "No, I still want a refund", icon: 'ðŸ’°' }] } },
              // Keep order - left branch
              { id: 'msg_keep', type: 'message', position: { x: 100, y: 2100 }, data: { persona: 'amy', content: "Wonderful! Thank you so much for giving us a chance. ðŸ’œ Is there anything else I can help you with?" } },
              { id: 'end_keep', type: 'end', position: { x: 100, y: 2450 }, data: { title: 'Order Kept!', showSurvey: true } },
              
              // ========== INLINE REFUND LADDER (right branch) ==========
              { id: 'cond_guarantee', type: 'condition', position: { x: 950, y: 2100 }, data: { variable: 'guarantee.eligible', operator: '===', value: 'true', yesLabel: 'Within 90 days', noLabel: 'Expired' } },
              { id: 'msg_guarantee_expired', type: 'message', position: { x: 1350, y: 2450 }, data: { persona: 'amy', content: "I really wish I could help, but the 90-day guarantee period has expired. Let me create a case for review." } },
              { id: 'case_guarantee_expired', type: 'case', position: { x: 1350, y: 2800 }, data: { type: 'refund', subtype: 'guarantee_expired', priority: 'normal' } },
              { id: 'end_guarantee_expired', type: 'end', position: { x: 1350, y: 3150 }, data: { title: 'Case for Review', showSurvey: true } },
              // 20% offer
              { id: 'offer_20', type: 'offer', position: { x: 650, y: 2450 }, data: { percent: 20, label: '20% Refund', message: "I'd like to offer you a <strong>20% partial refund ({{refundAmount20}})</strong> while you keep the product." } },
              { id: 'opts_20', type: 'options', position: { x: 650, y: 2800 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 20%', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: 350, y: 3150 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20', type: 'end', position: { x: 350, y: 3500 }, data: { title: '20% Refund!', showSurvey: true } },
              // 30% offer
              { id: 'offer_30', type: 'offer', position: { x: 650, y: 3150 }, data: { percent: 30, label: '30% Refund', message: "Let me offer you a <strong>30% refund ({{refundAmount30}})</strong>." } },
              { id: 'opts_30', type: 'options', position: { x: 650, y: 3500 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: 350, y: 3850 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30', type: 'end', position: { x: 350, y: 4200 }, data: { title: '30% Refund!', showSurvey: true } },
              // Manager delay 1
              { id: 'msg_manager1', type: 'message', position: { x: 650, y: 3850 }, data: { persona: 'amy', content: "Let me check with my manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 650, y: 4200 }, data: { duration: 8000, message: 'Checking with manager...' } },
              // 40% offer
              { id: 'offer_40', type: 'offer', position: { x: 650, y: 4550 }, data: { percent: 40, label: '40% Refund', message: "My manager approved a <strong>40% refund ({{refundAmount40}})</strong>." } },
              { id: 'opts_40', type: 'options', position: { x: 650, y: 4900 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: 350, y: 5250 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40', type: 'end', position: { x: 350, y: 5600 }, data: { title: '40% Refund!', showSurvey: true } },
              // Manager delay 2
              { id: 'msg_manager2', type: 'message', position: { x: 650, y: 5250 }, data: { persona: 'amy', content: "Let me speak with my manager one more time..." } },
              { id: 'delay2', type: 'delay', position: { x: 650, y: 5600 }, data: { duration: 8000, message: 'Final manager check...' } },
              // 50% offer
              { id: 'offer_50', type: 'offer', position: { x: 650, y: 5950 }, data: { percent: 50, label: '50% Maximum', message: "Our <strong>maximum: 50% refund ({{refundAmount50}})</strong>. This is the best we can do." } },
              { id: 'opts_50', type: 'options', position: { x: 650, y: 6300 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: 350, y: 6650 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50', type: 'end', position: { x: 350, y: 7000 }, data: { title: '50% Refund!', showSurvey: true } },
              // Full refund
              { id: 'msg_full_refund', type: 'message', position: { x: 650, y: 6650 }, data: { persona: 'amy', content: "I'll process a full refund. Expect 3-5 business days." } },
              { id: 'case_full', type: 'case', position: { x: 650, y: 7000 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 650, y: 7350 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'input1', animated: true },
              { id: 'e3', source: 'input1', target: 'ai1', animated: true },
              { id: 'e4', source: 'ai1', target: 'msg_ai_response', animated: true },
              { id: 'e5', source: 'msg_ai_response', target: 'opts_satisfaction', animated: true },
              { id: 'e6', source: 'opts_satisfaction', target: 'msg_keep', sourceHandle: 'opt-0', label: 'Keep order', animated: true },
              { id: 'e7', source: 'opts_satisfaction', target: 'cond_guarantee', sourceHandle: 'opt-1', label: 'Want refund', animated: true },
              { id: 'e8', source: 'msg_keep', target: 'end_keep', animated: true },
              // Guarantee check
              { id: 'e9', source: 'cond_guarantee', target: 'offer_20', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e10', source: 'cond_guarantee', target: 'msg_guarantee_expired', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e11', source: 'msg_guarantee_expired', target: 'case_guarantee_expired', animated: true },
              { id: 'e12', source: 'case_guarantee_expired', target: 'end_guarantee_expired', animated: true },
              // 20% ladder
              { id: 'e13', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e14', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e15', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e16', source: 'case_20', target: 'end_20', animated: true },
              // 30% ladder
              { id: 'e17', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e18', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e19', source: 'opts_30', target: 'msg_manager1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e20', source: 'case_30', target: 'end_30', animated: true },
              // Manager delay 1
              { id: 'e21', source: 'msg_manager1', target: 'delay1', animated: true },
              { id: 'e22', source: 'delay1', target: 'offer_40', animated: true },
              // 40% ladder
              { id: 'e23', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e24', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e25', source: 'opts_40', target: 'msg_manager2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e26', source: 'case_40', target: 'end_40', animated: true },
              // Manager delay 2
              { id: 'e27', source: 'msg_manager2', target: 'delay2', animated: true },
              { id: 'e28', source: 'delay2', target: 'offer_50', animated: true },
              // 50% ladder
              { id: 'e29', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e30', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e31', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e32', source: 'case_50', target: 'end_50', animated: true },
              // Full refund
              { id: 'e33', source: 'msg_full_refund', target: 'case_full', animated: true },
              { id: 'e34', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          // NOT MET EXPECTATIONS - AI Response + Satisfaction Check + INLINE Refund Ladder
          not_met_expectations: {
            id: 'not_met_expectations',
            parentId: 'help_with_order',
            name: 'Not Met Expectations',
            description: 'Customer disappointed - AI response, satisfaction check, then INLINE refund ladder (20%â†’30%â†’40%â†’50%â†’full)',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Not Met Expectations' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "I'm really sorry to hear that ðŸ˜” We always want our products to exceed expectations. Could you share what specifically didn't meet your expectations?" } },
              { id: 'input1', type: 'form', position: { x: 450, y: 700 }, data: { formType: 'Text Input', label: 'What disappointed you?', placeholder: 'Tell us what didn\\'t meet expectations...' } },
              { id: 'ai1', type: 'ai', position: { x: 450, y: 1050 }, data: { persona: 'amy', model: 'gpt-4o-mini', scenarioType: 'changed_mind', systemPrompt: 'Respond to customer disappointment with empathy and product benefits. Address their specific concern.' } },
              { id: 'msg_ai_response', type: 'message', position: { x: 450, y: 1400 }, data: { persona: 'amy', content: "{{aiGeneratedResponse}}" } },
              // Satisfaction check
              { id: 'opts_satisfaction', type: 'options', position: { x: 450, y: 1750 }, data: { prompt: 'Does this help at all?', options: [{ label: "Yes, I'll give it another try", icon: 'âœ¨' }, { label: "No, I'd like a refund", icon: 'ðŸ’°' }] } },
              // Keep trying - left branch
              { id: 'msg_thanks', type: 'message', position: { x: 50, y: 2100 }, data: { persona: 'amy', content: "Thank you so much for giving us another chance! ðŸ’œ Is there anything else I can help you with?" } },
              { id: 'end_keep', type: 'end', position: { x: 50, y: 2450 }, data: { title: 'Giving it another try!', showSurvey: true } },
              
              // ========== INLINE REFUND LADDER (right branch) ==========
              { id: 'cond_guarantee', type: 'condition', position: { x: 850, y: 2100 }, data: { variable: 'guarantee.eligible', operator: '===', value: 'true', yesLabel: 'Within 90 days', noLabel: 'Expired' } },
              { id: 'msg_guarantee_expired', type: 'message', position: { x: 1250, y: 2450 }, data: { persona: 'amy', content: "The 90-day guarantee has expired. Let me create a case for review." } },
              { id: 'case_guarantee_expired', type: 'case', position: { x: 1250, y: 2800 }, data: { type: 'refund', subtype: 'guarantee_expired', priority: 'normal' } },
              { id: 'end_guarantee_expired', type: 'end', position: { x: 1250, y: 3150 }, data: { title: 'Case for Review', showSurvey: true } },
              // 20% offer
              { id: 'offer_20', type: 'offer', position: { x: 550, y: 2450 }, data: { percent: 20, label: '20% Refund', message: "I'd like to offer you a <strong>20% partial refund ({{refundAmount20}})</strong>." } },
              { id: 'opts_20', type: 'options', position: { x: 550, y: 2800 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 20%', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: 250, y: 3150 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20', type: 'end', position: { x: 250, y: 3500 }, data: { title: '20% Refund!', showSurvey: true } },
              // 30% offer
              { id: 'offer_30', type: 'offer', position: { x: 550, y: 3150 }, data: { percent: 30, label: '30% Refund', message: "Let me offer you a <strong>30% refund ({{refundAmount30}})</strong>." } },
              { id: 'opts_30', type: 'options', position: { x: 550, y: 3500 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: 250, y: 3850 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30', type: 'end', position: { x: 250, y: 4200 }, data: { title: '30% Refund!', showSurvey: true } },
              // Manager delay 1
              { id: 'msg_manager1', type: 'message', position: { x: 550, y: 3850 }, data: { persona: 'amy', content: "Let me check with my manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 550, y: 4200 }, data: { duration: 8000, message: 'Checking with manager...' } },
              // 40% offer
              { id: 'offer_40', type: 'offer', position: { x: 550, y: 4550 }, data: { percent: 40, label: '40% Refund', message: "My manager approved a <strong>40% refund ({{refundAmount40}})</strong>." } },
              { id: 'opts_40', type: 'options', position: { x: 550, y: 4900 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: 250, y: 5250 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40', type: 'end', position: { x: 250, y: 5600 }, data: { title: '40% Refund!', showSurvey: true } },
              // Manager delay 2
              { id: 'msg_manager2', type: 'message', position: { x: 550, y: 5250 }, data: { persona: 'amy', content: "One more check with my manager..." } },
              { id: 'delay2', type: 'delay', position: { x: 550, y: 5600 }, data: { duration: 8000, message: 'Final check...' } },
              // 50% offer
              { id: 'offer_50', type: 'offer', position: { x: 550, y: 5950 }, data: { percent: 50, label: '50% Maximum', message: "Our <strong>maximum: 50% refund ({{refundAmount50}})</strong>." } },
              { id: 'opts_50', type: 'options', position: { x: 550, y: 6300 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: 250, y: 6650 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50', type: 'end', position: { x: 250, y: 7000 }, data: { title: '50% Refund!', showSurvey: true } },
              // Full refund
              { id: 'msg_full_refund', type: 'message', position: { x: 550, y: 6650 }, data: { persona: 'amy', content: "I'll process a full refund. Expect 3-5 business days." } },
              { id: 'case_full', type: 'case', position: { x: 550, y: 7000 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 550, y: 7350 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'input1', animated: true },
              { id: 'e3', source: 'input1', target: 'ai1', animated: true },
              { id: 'e4', source: 'ai1', target: 'msg_ai_response', animated: true },
              { id: 'e5', source: 'msg_ai_response', target: 'opts_satisfaction', animated: true },
              { id: 'e6', source: 'opts_satisfaction', target: 'msg_thanks', sourceHandle: 'opt-0', label: 'Try again', animated: true },
              { id: 'e7', source: 'opts_satisfaction', target: 'cond_guarantee', sourceHandle: 'opt-1', label: 'Want refund', animated: true },
              { id: 'e8', source: 'msg_thanks', target: 'end_keep', animated: true },
              // Guarantee check
              { id: 'e9', source: 'cond_guarantee', target: 'offer_20', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e10', source: 'cond_guarantee', target: 'msg_guarantee_expired', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e11', source: 'msg_guarantee_expired', target: 'case_guarantee_expired', animated: true },
              { id: 'e12', source: 'case_guarantee_expired', target: 'end_guarantee_expired', animated: true },
              // 20% ladder
              { id: 'e13', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e14', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e15', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e16', source: 'case_20', target: 'end_20', animated: true },
              // 30% ladder
              { id: 'e17', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e18', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e19', source: 'opts_30', target: 'msg_manager1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e20', source: 'case_30', target: 'end_30', animated: true },
              // Manager delay 1
              { id: 'e21', source: 'msg_manager1', target: 'delay1', animated: true },
              { id: 'e22', source: 'delay1', target: 'offer_40', animated: true },
              // 40% ladder
              { id: 'e23', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e24', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e25', source: 'opts_40', target: 'msg_manager2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e26', source: 'case_40', target: 'end_40', animated: true },
              // Manager delay 2
              { id: 'e27', source: 'msg_manager2', target: 'delay2', animated: true },
              { id: 'e28', source: 'delay2', target: 'offer_50', animated: true },
              // 50% ladder
              { id: 'e29', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e30', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e31', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e32', source: 'case_50', target: 'end_50', animated: true },
              // Full refund
              { id: 'e33', source: 'msg_full_refund', target: 'case_full', animated: true },
              { id: 'e34', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          // ORDERED BY MISTAKE - Change Order or Refund Ladder
          ordered_mistake: {
            id: 'ordered_mistake',
            parentId: 'help_with_order',
            name: 'Ordered by Mistake',
            description: 'Customer accidentally ordered - can change order (with used/unused check) or INLINE refund ladder (20%â†’30%â†’40%â†’50%â†’full)',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Ordered by Mistake' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "No worries! Would you like to change your order to something else, or would you prefer a refund?" } },
              { id: 'opts1', type: 'options', position: { x: 450, y: 700 }, data: { prompt: 'What would you like to do?', options: [{ label: 'Change my order', icon: 'ðŸ”„' }, { label: 'I want a refund', icon: 'ðŸ’°' }] } },
              // Change order branch - left side (keep as subflow for order changes)
              { id: 'subflow_change_order', type: 'subflow', position: { x: 50, y: 1050 }, data: { name: 'Change Order Flow', slug: 'change_order', nodeCount: 12, description: 'Text input â†’ Used check â†’ 20% refund + swap OR return swap' } },
              { id: 'end_change', type: 'end', position: { x: 50, y: 1400 }, data: { title: 'Order Change Requested', showSurvey: true } },
              
              // ========== INLINE REFUND LADDER (right branch) ==========
              { id: 'cond_guarantee', type: 'condition', position: { x: 850, y: 1050 }, data: { variable: 'guarantee.eligible', operator: '===', value: 'true', yesLabel: 'Within 90 days', noLabel: 'Expired' } },
              { id: 'msg_guarantee_expired', type: 'message', position: { x: 1250, y: 1400 }, data: { persona: 'amy', content: "The 90-day guarantee has expired. Let me create a case for review." } },
              { id: 'case_guarantee_expired', type: 'case', position: { x: 1250, y: 1750 }, data: { type: 'refund', subtype: 'guarantee_expired', priority: 'normal' } },
              { id: 'end_guarantee_expired', type: 'end', position: { x: 1250, y: 2100 }, data: { title: 'Case for Review', showSurvey: true } },
              // 20% offer
              { id: 'offer_20', type: 'offer', position: { x: 550, y: 1400 }, data: { percent: 20, label: '20% Refund', message: "I'd like to offer you a <strong>20% partial refund ({{refundAmount20}})</strong>." } },
              { id: 'opts_20', type: 'options', position: { x: 550, y: 1750 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 20%', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: 250, y: 2100 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20', type: 'end', position: { x: 250, y: 2450 }, data: { title: '20% Refund!', showSurvey: true } },
              // 30% offer
              { id: 'offer_30', type: 'offer', position: { x: 550, y: 2100 }, data: { percent: 30, label: '30% Refund', message: "Let me offer you a <strong>30% refund ({{refundAmount30}})</strong>." } },
              { id: 'opts_30', type: 'options', position: { x: 550, y: 2450 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: 250, y: 2800 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30', type: 'end', position: { x: 250, y: 3150 }, data: { title: '30% Refund!', showSurvey: true } },
              // Manager delay 1
              { id: 'msg_manager1', type: 'message', position: { x: 550, y: 2800 }, data: { persona: 'amy', content: "Let me check with my manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 550, y: 3150 }, data: { duration: 8000, message: 'Checking with manager...' } },
              // 40% offer
              { id: 'offer_40', type: 'offer', position: { x: 550, y: 3500 }, data: { percent: 40, label: '40% Refund', message: "My manager approved a <strong>40% refund ({{refundAmount40}})</strong>." } },
              { id: 'opts_40', type: 'options', position: { x: 550, y: 3850 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: 250, y: 4200 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40', type: 'end', position: { x: 250, y: 4550 }, data: { title: '40% Refund!', showSurvey: true } },
              // Manager delay 2
              { id: 'msg_manager2', type: 'message', position: { x: 550, y: 4200 }, data: { persona: 'amy', content: "One more check with my manager..." } },
              { id: 'delay2', type: 'delay', position: { x: 550, y: 4550 }, data: { duration: 8000, message: 'Final check...' } },
              // 50% offer
              { id: 'offer_50', type: 'offer', position: { x: 550, y: 4900 }, data: { percent: 50, label: '50% Maximum', message: "Our <strong>maximum: 50% refund ({{refundAmount50}})</strong>." } },
              { id: 'opts_50', type: 'options', position: { x: 550, y: 5250 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: 250, y: 5600 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50', type: 'end', position: { x: 250, y: 5950 }, data: { title: '50% Refund!', showSurvey: true } },
              // Full refund
              { id: 'msg_full_refund', type: 'message', position: { x: 550, y: 5600 }, data: { persona: 'amy', content: "I'll process a full refund. Expect 3-5 business days." } },
              { id: 'case_full', type: 'case', position: { x: 550, y: 5950 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 550, y: 6300 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e3', source: 'opts1', target: 'subflow_change_order', sourceHandle: 'opt-0', label: 'Change order', animated: true },
              { id: 'e4', source: 'opts1', target: 'cond_guarantee', sourceHandle: 'opt-1', label: 'Want refund', animated: true },
              { id: 'e5', source: 'subflow_change_order', target: 'end_change', animated: true },
              // Guarantee check
              { id: 'e6', source: 'cond_guarantee', target: 'offer_20', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e7', source: 'cond_guarantee', target: 'msg_guarantee_expired', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e8', source: 'msg_guarantee_expired', target: 'case_guarantee_expired', animated: true },
              { id: 'e9', source: 'case_guarantee_expired', target: 'end_guarantee_expired', animated: true },
              // 20% ladder
              { id: 'e10', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e11', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e12', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e13', source: 'case_20', target: 'end_20', animated: true },
              // 30% ladder
              { id: 'e14', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e15', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e16', source: 'opts_30', target: 'msg_manager1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e17', source: 'case_30', target: 'end_30', animated: true },
              // Manager delay 1
              { id: 'e18', source: 'msg_manager1', target: 'delay1', animated: true },
              { id: 'e19', source: 'delay1', target: 'offer_40', animated: true },
              // 40% ladder
              { id: 'e20', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e21', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e22', source: 'opts_40', target: 'msg_manager2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e23', source: 'case_40', target: 'end_40', animated: true },
              // Manager delay 2
              { id: 'e24', source: 'msg_manager2', target: 'delay2', animated: true },
              { id: 'e25', source: 'delay2', target: 'offer_50', animated: true },
              // 50% ladder
              { id: 'e26', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e27', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e28', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e29', source: 'case_50', target: 'end_50', animated: true },
              // Full refund
              { id: 'e30', source: 'msg_full_refund', target: 'case_full', animated: true },
              { id: 'e31', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          // MISSING ITEM - Photo Upload, Description, Reship with Bonus OR Refund
          missing_item: {
            id: 'missing_item',
            parentId: 'help_with_order',
            name: 'Missing Item',
            description: 'Something was missing from the order - shows order list, photo upload, description, then reship with bonus or refund option',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Missing Item Flow' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "I'm so sorry to hear something was missing from your order!<br><br>Let me help sort this out for you. Here's what should have been in your package:<br><br>{{orderItemsList}}<br><br>First, could you upload a photo of everything you actually received? Please include the packaging too... this helps our team investigate what happened." } },
              { id: 'evidence1', type: 'form', position: { x: 450, y: 700 }, data: { formType: 'Photo Upload', label: 'Upload photo of package/items received', acceptTypes: 'image/*', multiple: true } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "Thanks for those photos!<br><br>Now, please describe exactly what was missing from your order. Include as much detail as possible... for example, how many items were missing, which specific products, any damage to the packaging, etc." } },
              { id: 'input1', type: 'form', position: { x: 450, y: 1400 }, data: { formType: 'Text Input', label: 'Describe missing items', placeholder: 'e.g., I only received 4 pads instead of 6, the Beige PuppyPad was completely missing...' } },
              { id: 'msg3', type: 'message', position: { x: 450, y: 1750 }, data: { persona: 'amy', content: "Thank you for letting us know. I've noted everything down and our team will look into this.<br><br>To make things right, we'd love to reship the missing items to you... and as an apology for the trouble, we'll include an extra item on us!<br><br>Our team will review your case within 1-2 days and get your missing items shipped out.<br><br>Would you like us to go ahead with this?" } },
              { id: 'opts1', type: 'options', position: { x: 450, y: 2100 }, data: { prompt: 'Would you like us to reship?', options: [{ label: 'Yes, send my missing items', icon: 'ðŸ“¦' }, { label: "No, I'd like a different solution", icon: 'ðŸ”„' }] } },
              // Reship with bonus - left branch
              { id: 'case_reship', type: 'case', position: { x: 100, y: 2450 }, data: { type: 'reship', subtype: 'reship_missing_item_bonus', priority: 'high', includeBonus: true, note: 'Reship missing items + bonus item for inconvenience' } },
              { id: 'msg_reship_success', type: 'message', position: { x: 100, y: 2800 }, data: { persona: 'amy', content: "Our team will review your case within 1-2 days and ship your missing items plus a bonus item for the inconvenience.<br><br>You'll receive an email with tracking details once it ships!" } },
              { id: 'end_reship', type: 'end', position: { x: 100, y: 3150 }, data: { title: 'Missing Items Case Created!', showSurvey: true } },
              // Refund alternative - right branch
              { id: 'msg_refund_option', type: 'message', position: { x: 800, y: 2450 }, data: { persona: 'amy', content: "No problem at all, I understand.<br><br>We can also provide a refund for the missing items. Here's how it works... our team will review your case and calculate the refund amount based on what was missing.<br><br>Just a heads up... if your missing item was part of a bundle deal, the refund will be calculated based on the bundle pricing rather than individual item prices.<br><br>Our team typically reviews cases within 1-2 days. During this time, they'll also investigate what went wrong so we can prevent this from happening again.<br><br>Would you like to proceed with the refund?" } },
              { id: 'opts_refund', type: 'options', position: { x: 800, y: 2800 }, data: { prompt: 'Proceed with refund?', options: [{ label: 'Yes, request a refund', icon: 'ðŸ’°' }, { label: 'Actually, just send the items', icon: 'ðŸ“¦' }] } },
              { id: 'case_refund', type: 'case', position: { x: 600, y: 3150 }, data: { type: 'refund', subtype: 'refund_missing_item', priority: 'normal', note: 'Refund for missing items (team to calculate based on bundle pricing)' } },
              { id: 'msg_refund_success', type: 'message', position: { x: 600, y: 3500 }, data: { persona: 'amy', content: "Our team will review your case and calculate the refund for your missing items within 1-2 days.<br><br>Once approved, expect 3-5 business days for the refund to appear in your account." } },
              { id: 'end_refund', type: 'end', position: { x: 600, y: 3850 }, data: { title: 'Refund Request Submitted!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'evidence1', animated: true },
              { id: 'e3', source: 'evidence1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'input1', animated: true },
              { id: 'e5', source: 'input1', target: 'msg3', animated: true },
              { id: 'e6', source: 'msg3', target: 'opts1', animated: true },
              { id: 'e7', source: 'opts1', target: 'case_reship', sourceHandle: 'opt-0', label: 'Reship', animated: true },
              { id: 'e8', source: 'opts1', target: 'msg_refund_option', sourceHandle: 'opt-1', label: 'Different solution', animated: true },
              { id: 'e9', source: 'case_reship', target: 'msg_reship_success', animated: true },
              { id: 'e10', source: 'msg_reship_success', target: 'end_reship', animated: true },
              { id: 'e11', source: 'msg_refund_option', target: 'opts_refund', animated: true },
              { id: 'e12', source: 'opts_refund', target: 'case_refund', sourceHandle: 'opt-0', label: 'Refund', animated: true },
              { id: 'e13', source: 'opts_refund', target: 'case_reship', sourceHandle: 'opt-1', label: 'Send items instead', animated: true },
              { id: 'e14', source: 'case_refund', target: 'msg_refund_success', animated: true },
              { id: 'e15', source: 'msg_refund_success', target: 'end_refund', animated: true }
            ]
          },

          // WRONG ITEM - Description, Photo Upload, Reship Correct Item
          wrong_item: {
            id: 'wrong_item',
            parentId: 'help_with_order',
            name: 'Wrong Item Received',
            description: 'Customer received wrong item - description, photo upload, then reship correct item (keep wrong one)',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Wrong Item Flow' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "I'm so sorry about that mix-up! ðŸ˜” Could you tell me what you received versus what you ordered?" } },
              { id: 'form1', type: 'form', position: { x: 450, y: 700 }, data: { formType: 'Text Input', label: 'Describe what you received', placeholder: 'e.g., I ordered the Large Blue PuppyPad but received a Medium Beige one...' } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "Got it. Please upload a photo of what you received so we can verify and fix this quickly." } },
              { id: 'evidence1', type: 'form', position: { x: 450, y: 1400 }, data: { formType: 'Photo Upload', label: 'Upload photo of received item', multiple: true } },
              { id: 'msg3', type: 'message', position: { x: 450, y: 1750 }, data: { persona: 'amy', content: "Thank you! We'll ship out the correct item right away. You can keep the wrong item â€” no need to return it!" } },
              { id: 'case1', type: 'case', position: { x: 450, y: 2100 }, data: { type: 'reship', subtype: 'wrong_item', priority: 'high', keepWrongItem: true, note: 'Reship correct item - customer keeps wrong item' } },
              { id: 'msg_success', type: 'message', position: { x: 450, y: 2450 }, data: { persona: 'amy', content: "I've created a case to ship the correct item to you. You'll receive tracking information via email once it ships.<br><br>Is there anything else I can help you with?" } },
              { id: 'end1', type: 'end', position: { x: 450, y: 2800 }, data: { title: 'Correct Item Shipping!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'evidence1', animated: true },
              { id: 'e5', source: 'evidence1', target: 'msg3', animated: true },
              { id: 'e6', source: 'msg3', target: 'case1', animated: true },
              { id: 'e7', source: 'case1', target: 'msg_success', animated: true },
              { id: 'e8', source: 'msg_success', target: 'end1', animated: true }
            ]
          },

          // DAMAGED - Photo Upload, Replacement OR Refund
          damaged: {
            id: 'damaged',
            parentId: 'help_with_order',
            name: 'Order Arrived Damaged',
            description: 'Package or product arrived damaged - photo evidence required, then replacement or refund',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Damaged Order Flow' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "Oh no, I'm so sorry your order arrived damaged! ðŸ’” That's definitely not the experience we want for you. Can you upload some photos of the damage?" } },
              { id: 'evidence1', type: 'form', position: { x: 450, y: 700 }, data: { formType: 'Photo Upload', label: 'Upload photos of damage', description: 'Photos of package and/or product damage', multiple: true } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "Thank you for those photos. I've documented everything. Would you like us to send a replacement, or would you prefer a refund?" } },
              { id: 'opts1', type: 'options', position: { x: 450, y: 1400 }, data: { prompt: 'How would you like us to resolve this?', options: [{ label: 'Send a replacement', icon: 'ðŸ“¦' }, { label: 'Process a refund', icon: 'ðŸ’°' }] } },
              // Replacement - left branch
              { id: 'case_replacement', type: 'case', position: { x: 100, y: 1750 }, data: { type: 'reship', subtype: 'damaged', priority: 'high', note: 'Replace damaged items' } },
              { id: 'msg_replacement', type: 'message', position: { x: 100, y: 2100 }, data: { persona: 'amy', content: "I've created a case to send a replacement. You'll receive tracking information via email once it ships." } },
              { id: 'end_replacement', type: 'end', position: { x: 100, y: 2450 }, data: { title: 'Replacement Ordered!', showSurvey: true } },
              // Refund - right branch
              { id: 'case_refund', type: 'case', position: { x: 800, y: 1750 }, data: { type: 'refund', subtype: 'damaged', priority: 'high', note: 'Full refund for damaged items' } },
              { id: 'msg_refund', type: 'message', position: { x: 800, y: 2100 }, data: { persona: 'amy', content: "I've processed a full refund for you. Expect 3-5 business days for the refund to appear in your account." } },
              { id: 'end_refund', type: 'end', position: { x: 800, y: 2450 }, data: { title: 'Refund Processed!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'evidence1', animated: true },
              { id: 'e3', source: 'evidence1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'case_replacement', sourceHandle: 'opt-0', label: 'Replacement', animated: true },
              { id: 'e6', source: 'opts1', target: 'case_refund', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              { id: 'e7', source: 'case_replacement', target: 'msg_replacement', animated: true },
              { id: 'e8', source: 'msg_replacement', target: 'end_replacement', animated: true },
              { id: 'e9', source: 'case_refund', target: 'msg_refund', animated: true },
              { id: 'e10', source: 'msg_refund', target: 'end_refund', animated: true }
            ]
          },

          // CHARGED UNEXPECTEDLY - Full Branching with Delivery Status Checks (350px spacing)
          charged_unexpectedly: {
            id: 'charged_unexpectedly',
            parentId: 'help_with_order',
            name: 'Charged Unexpectedly',
            description: 'Customer was charged unexpectedly - delivery status check, 20% offer first, then INLINE refund ladder (30%â†’40%â†’50%â†’full) for each branch',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 700, y: 0 }, data: { label: 'Unexpected Charge Flow' } },
              { id: 'msg1', type: 'message', position: { x: 650, y: 350 }, data: { persona: 'amy', content: "I completely understand â€” unexpected charges can be confusing! ðŸ’³<br><br>This can happen for a few reasons: sometimes a family member places an order as a gift, it could be a subscription renewal you forgot about, or perhaps an order from a while back that slipped your mind.<br><br>Either way, I'm here to help sort this out for you! Let me pull up your order details." } },
              { id: 'api1', type: 'api', position: { x: 650, y: 700 }, data: { service: 'Shopify', endpoint: '/api/orders/recent-charges', description: 'Look up recent charges for customer', request: '{ email }', response: '{ orders[] }' } },
              { id: 'msg2', type: 'message', position: { x: 650, y: 1050 }, data: { persona: 'amy', content: "Here's what I found:<br><br><strong>Order:</strong> {{orderNumber}}<br><strong>Date:</strong> {{orderDate}}<br><strong>Total Charged:</strong> {{totalPrice}}<br><br><strong>Items:</strong><br>{{itemsList}}<br><br>Is this the charge you're referring to?" } },
              { id: 'opts1', type: 'options', position: { x: 650, y: 1400 }, data: { prompt: 'Is this the charge?', options: [{ label: "Yes, this is it", icon: 'âœ…' }, { label: "No, I don't recognize this", icon: 'âŒ' }] } },
              
              // Confirmed branch - left side
              { id: 'msg3', type: 'message', position: { x: 200, y: 1750 }, data: { persona: 'amy', content: "Got it! So you see the order, but you're saying you didn't place it yourself? Let me check the delivery status..." } },
              { id: 'api2', type: 'api', position: { x: 200, y: 2100 }, data: { service: 'ParcelPanel', endpoint: '/api/tracking', description: 'Check delivery status', request: '{ orderNumber }', response: '{ tracking, status }' } },
              { id: 'cond1', type: 'condition', position: { x: 200, y: 2450 }, data: { variable: 'tracking.status', operator: 'includes', value: 'delivered', yesLabel: 'Delivered', noLabel: 'Not Delivered' } },
              
              // ========== DELIVERED BRANCH with inline ladder ==========
              { id: 'msg4', type: 'message', position: { x: -200, y: 2800 }, data: { persona: 'amy', content: "I can see this order has been <strong>delivered</strong>! ðŸ“¦ Since you have the products, would you like a <strong>20% refund ({{refundAmount20}})</strong>?" } },
              { id: 'offer1_delivered', type: 'offer', position: { x: -200, y: 3150 }, data: { percent: 20, label: '20% + keep products', message: "20% refund for confusion" } },
              { id: 'opts_delivered', type: 'options', position: { x: -200, y: 3500 }, data: { prompt: 'What would you like to do?', options: [{ label: "Accept 20%", icon: 'âœ…' }, { label: "Higher refund", icon: 'ðŸ’°' }] } },
              { id: 'case_20_delivered', type: 'case', position: { x: -500, y: 3850 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20_delivered', type: 'end', position: { x: -500, y: 4200 }, data: { title: '20% Refund!', showSurvey: true } },
              // 30% (skipping 20% since already offered)
              { id: 'offer_30_delivered', type: 'offer', position: { x: -200, y: 3850 }, data: { percent: 30, label: '30% Refund', message: "<strong>30% refund ({{refundAmount30}})</strong>" } },
              { id: 'opts_30_delivered', type: 'options', position: { x: -200, y: 4200 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30_delivered', type: 'case', position: { x: -500, y: 4550 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30_delivered', type: 'end', position: { x: -500, y: 4900 }, data: { title: '30% Refund!', showSurvey: true } },
              { id: 'msg_mgr1_delivered', type: 'message', position: { x: -200, y: 4550 }, data: { persona: 'amy', content: "Checking with manager..." } },
              { id: 'delay1_delivered', type: 'delay', position: { x: -200, y: 4900 }, data: { duration: 8000, message: 'Manager check...' } },
              { id: 'offer_40_delivered', type: 'offer', position: { x: -200, y: 5250 }, data: { percent: 40, label: '40% Refund', message: "<strong>40% refund ({{refundAmount40}})</strong>" } },
              { id: 'opts_40_delivered', type: 'options', position: { x: -200, y: 5600 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40_delivered', type: 'case', position: { x: -500, y: 5950 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40_delivered', type: 'end', position: { x: -500, y: 6300 }, data: { title: '40% Refund!', showSurvey: true } },
              { id: 'msg_mgr2_delivered', type: 'message', position: { x: -200, y: 5950 }, data: { persona: 'amy', content: "Final manager check..." } },
              { id: 'delay2_delivered', type: 'delay', position: { x: -200, y: 6300 }, data: { duration: 8000, message: 'Final check...' } },
              { id: 'offer_50_delivered', type: 'offer', position: { x: -200, y: 6650 }, data: { percent: 50, label: '50% Maximum', message: "<strong>Maximum 50% refund</strong>" } },
              { id: 'opts_50_delivered', type: 'options', position: { x: -200, y: 7000 }, data: { prompt: 'Best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund', icon: 'ðŸ’°' }] } },
              { id: 'case_50_delivered', type: 'case', position: { x: -500, y: 7350 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50_delivered', type: 'end', position: { x: -500, y: 7700 }, data: { title: '50% Refund!', showSurvey: true } },
              { id: 'msg_full_delivered', type: 'message', position: { x: -200, y: 7350 }, data: { persona: 'amy', content: "Full refund processing..." } },
              { id: 'case_full_delivered', type: 'case', position: { x: -200, y: 7700 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full_delivered', type: 'end', position: { x: -200, y: 8050 }, data: { title: 'Full Refund!', showSurvey: true } },
              
              // ========== NOT DELIVERED BRANCH with inline ladder ==========
              { id: 'msg5', type: 'message', position: { x: 600, y: 2800 }, data: { persona: 'amy', content: "I see this order hasn't been delivered yet! ðŸ“¦ I'll give you a <strong>20% refund ({{refundAmount20}})</strong> and you keep it when it arrives." } },
              { id: 'offer1_not_delivered', type: 'offer', position: { x: 600, y: 3150 }, data: { percent: 20, label: '20% + keep order', message: "20% refund - keep order" } },
              { id: 'opts_not_delivered', type: 'options', position: { x: 600, y: 3500 }, data: { prompt: 'What would you like to do?', options: [{ label: "Accept 20%", icon: 'âœ…' }, { label: "Higher refund", icon: 'ðŸ’°' }] } },
              { id: 'case_20_not_delivered', type: 'case', position: { x: 300, y: 3850 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20_not_delivered', type: 'end', position: { x: 300, y: 4200 }, data: { title: '20% Refund!', showSurvey: true } },
              // 30% (skipping 20%)
              { id: 'offer_30_not_delivered', type: 'offer', position: { x: 600, y: 3850 }, data: { percent: 30, label: '30% Refund', message: "<strong>30% refund</strong>" } },
              { id: 'opts_30_not_delivered', type: 'options', position: { x: 600, y: 4200 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30_not_delivered', type: 'case', position: { x: 300, y: 4550 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30_not_delivered', type: 'end', position: { x: 300, y: 4900 }, data: { title: '30% Refund!', showSurvey: true } },
              { id: 'msg_mgr1_not_delivered', type: 'message', position: { x: 600, y: 4550 }, data: { persona: 'amy', content: "Checking with manager..." } },
              { id: 'delay1_not_delivered', type: 'delay', position: { x: 600, y: 4900 }, data: { duration: 8000, message: 'Manager check...' } },
              { id: 'offer_40_not_delivered', type: 'offer', position: { x: 600, y: 5250 }, data: { percent: 40, label: '40% Refund', message: "<strong>40% refund</strong>" } },
              { id: 'opts_40_not_delivered', type: 'options', position: { x: 600, y: 5600 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40_not_delivered', type: 'case', position: { x: 300, y: 5950 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40_not_delivered', type: 'end', position: { x: 300, y: 6300 }, data: { title: '40% Refund!', showSurvey: true } },
              { id: 'msg_mgr2_not_delivered', type: 'message', position: { x: 600, y: 5950 }, data: { persona: 'amy', content: "Final manager check..." } },
              { id: 'delay2_not_delivered', type: 'delay', position: { x: 600, y: 6300 }, data: { duration: 8000, message: 'Final check...' } },
              { id: 'offer_50_not_delivered', type: 'offer', position: { x: 600, y: 6650 }, data: { percent: 50, label: '50% Maximum', message: "<strong>Maximum 50% refund</strong>" } },
              { id: 'opts_50_not_delivered', type: 'options', position: { x: 600, y: 7000 }, data: { prompt: 'Best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund', icon: 'ðŸ’°' }] } },
              { id: 'case_50_not_delivered', type: 'case', position: { x: 300, y: 7350 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50_not_delivered', type: 'end', position: { x: 300, y: 7700 }, data: { title: '50% Refund!', showSurvey: true } },
              { id: 'msg_full_not_delivered', type: 'message', position: { x: 600, y: 7350 }, data: { persona: 'amy', content: "Full refund processing..." } },
              { id: 'case_full_not_delivered', type: 'case', position: { x: 600, y: 7700 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full_not_delivered', type: 'end', position: { x: 600, y: 8050 }, data: { title: 'Full Refund!', showSurvey: true } },
              
              // ========== NOT RECOGNIZED BRANCH with inline ladder ==========
              { id: 'msg6', type: 'message', position: { x: 1200, y: 1750 }, data: { persona: 'amy', content: "I understand â€” it can be confusing when you don't recognize a charge! ðŸ¤” Let me tell you about what's in this order..." } },
              { id: 'api3', type: 'api', position: { x: 1200, y: 2100 }, data: { service: 'AI', endpoint: '/api/ai-response', description: 'Generate product benefits pitch', request: '{ scenarioType: "product_benefits_pitch" }', response: '{ messages[] }' } },
              { id: 'msg7', type: 'message', position: { x: 1200, y: 2450 }, data: { persona: 'amy', content: "{{aiGeneratedProductPitch}}" } },
              { id: 'opts_not_recognized', type: 'options', position: { x: 1200, y: 2800 }, data: { prompt: 'What would you like to do?', options: [{ label: "I'll keep the order", icon: 'âœ…' }, { label: "I still want a refund", icon: 'ðŸ’°' }] } },
              { id: 'end_keep_order', type: 'end', position: { x: 900, y: 3150 }, data: { title: 'Order Kept', showSurvey: true } },
              // Full inline ladder for not recognized
              { id: 'cond_guarantee_nr', type: 'condition', position: { x: 1200, y: 3150 }, data: { variable: 'guarantee.eligible', operator: '===', value: 'true', yesLabel: 'Within 90 days', noLabel: 'Expired' } },
              { id: 'msg_expired_nr', type: 'message', position: { x: 1500, y: 3500 }, data: { persona: 'amy', content: "The 90-day guarantee has expired." } },
              { id: 'case_expired_nr', type: 'case', position: { x: 1500, y: 3850 }, data: { type: 'refund', subtype: 'guarantee_expired', priority: 'normal' } },
              { id: 'end_expired_nr', type: 'end', position: { x: 1500, y: 4200 }, data: { title: 'Case for Review', showSurvey: true } },
              { id: 'offer_20_nr', type: 'offer', position: { x: 1200, y: 3500 }, data: { percent: 20, label: '20% Refund', message: "<strong>20% refund</strong>" } },
              { id: 'opts_20_nr', type: 'options', position: { x: 1200, y: 3850 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 20%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20_nr', type: 'case', position: { x: 900, y: 4200 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20_nr', type: 'end', position: { x: 900, y: 4550 }, data: { title: '20% Refund!', showSurvey: true } },
              { id: 'offer_30_nr', type: 'offer', position: { x: 1200, y: 4200 }, data: { percent: 30, label: '30% Refund', message: "<strong>30% refund</strong>" } },
              { id: 'opts_30_nr', type: 'options', position: { x: 1200, y: 4550 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30_nr', type: 'case', position: { x: 900, y: 4900 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30_nr', type: 'end', position: { x: 900, y: 5250 }, data: { title: '30% Refund!', showSurvey: true } },
              { id: 'msg_mgr1_nr', type: 'message', position: { x: 1200, y: 4900 }, data: { persona: 'amy', content: "Manager check..." } },
              { id: 'delay1_nr', type: 'delay', position: { x: 1200, y: 5250 }, data: { duration: 8000, message: 'Checking...' } },
              { id: 'offer_40_nr', type: 'offer', position: { x: 1200, y: 5600 }, data: { percent: 40, label: '40% Refund', message: "<strong>40% refund</strong>" } },
              { id: 'opts_40_nr', type: 'options', position: { x: 1200, y: 5950 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40_nr', type: 'case', position: { x: 900, y: 6300 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40_nr', type: 'end', position: { x: 900, y: 6650 }, data: { title: '40% Refund!', showSurvey: true } },
              { id: 'msg_mgr2_nr', type: 'message', position: { x: 1200, y: 6300 }, data: { persona: 'amy', content: "Final check..." } },
              { id: 'delay2_nr', type: 'delay', position: { x: 1200, y: 6650 }, data: { duration: 8000, message: 'Final...' } },
              { id: 'offer_50_nr', type: 'offer', position: { x: 1200, y: 7000 }, data: { percent: 50, label: '50% Maximum', message: "<strong>Maximum 50%</strong>" } },
              { id: 'opts_50_nr', type: 'options', position: { x: 1200, y: 7350 }, data: { prompt: 'Best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund', icon: 'ðŸ’°' }] } },
              { id: 'case_50_nr', type: 'case', position: { x: 900, y: 7700 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50_nr', type: 'end', position: { x: 900, y: 8050 }, data: { title: '50% Refund!', showSurvey: true } },
              { id: 'msg_full_nr', type: 'message', position: { x: 1200, y: 7700 }, data: { persona: 'amy', content: "Full refund processing..." } },
              { id: 'case_full_nr', type: 'case', position: { x: 1200, y: 8050 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full_nr', type: 'end', position: { x: 1200, y: 8400 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'api1', animated: true },
              { id: 'e3', source: 'api1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'msg3', sourceHandle: 'opt-0', label: 'Yes, this is it', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg6', sourceHandle: 'opt-1', label: "Don't recognize", animated: true },
              // Confirmed branch
              { id: 'e7', source: 'msg3', target: 'api2', animated: true },
              { id: 'e8', source: 'api2', target: 'cond1', animated: true },
              { id: 'e9', source: 'cond1', target: 'msg4', sourceHandle: 'yes', label: 'Delivered', animated: true },
              { id: 'e10', source: 'cond1', target: 'msg5', sourceHandle: 'no', label: 'Not delivered', animated: true },
              // Delivered inline ladder
              { id: 'e11', source: 'msg4', target: 'offer1_delivered', animated: true },
              { id: 'e12', source: 'offer1_delivered', target: 'opts_delivered', animated: true },
              { id: 'e13', source: 'opts_delivered', target: 'case_20_delivered', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e14', source: 'opts_delivered', target: 'offer_30_delivered', sourceHandle: 'opt-1', label: 'Higher', animated: true },
              { id: 'e15', source: 'case_20_delivered', target: 'end_20_delivered', animated: true },
              { id: 'e16', source: 'offer_30_delivered', target: 'opts_30_delivered', animated: true },
              { id: 'e17', source: 'opts_30_delivered', target: 'case_30_delivered', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e18', source: 'opts_30_delivered', target: 'msg_mgr1_delivered', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e19', source: 'case_30_delivered', target: 'end_30_delivered', animated: true },
              { id: 'e20', source: 'msg_mgr1_delivered', target: 'delay1_delivered', animated: true },
              { id: 'e21', source: 'delay1_delivered', target: 'offer_40_delivered', animated: true },
              { id: 'e22', source: 'offer_40_delivered', target: 'opts_40_delivered', animated: true },
              { id: 'e23', source: 'opts_40_delivered', target: 'case_40_delivered', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e24', source: 'opts_40_delivered', target: 'msg_mgr2_delivered', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e25', source: 'case_40_delivered', target: 'end_40_delivered', animated: true },
              { id: 'e26', source: 'msg_mgr2_delivered', target: 'delay2_delivered', animated: true },
              { id: 'e27', source: 'delay2_delivered', target: 'offer_50_delivered', animated: true },
              { id: 'e28', source: 'offer_50_delivered', target: 'opts_50_delivered', animated: true },
              { id: 'e29', source: 'opts_50_delivered', target: 'case_50_delivered', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e30', source: 'opts_50_delivered', target: 'msg_full_delivered', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e31', source: 'case_50_delivered', target: 'end_50_delivered', animated: true },
              { id: 'e32', source: 'msg_full_delivered', target: 'case_full_delivered', animated: true },
              { id: 'e33', source: 'case_full_delivered', target: 'end_full_delivered', animated: true },
              // Not Delivered inline ladder
              { id: 'e34', source: 'msg5', target: 'offer1_not_delivered', animated: true },
              { id: 'e35', source: 'offer1_not_delivered', target: 'opts_not_delivered', animated: true },
              { id: 'e36', source: 'opts_not_delivered', target: 'case_20_not_delivered', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e37', source: 'opts_not_delivered', target: 'offer_30_not_delivered', sourceHandle: 'opt-1', label: 'Higher', animated: true },
              { id: 'e38', source: 'case_20_not_delivered', target: 'end_20_not_delivered', animated: true },
              { id: 'e39', source: 'offer_30_not_delivered', target: 'opts_30_not_delivered', animated: true },
              { id: 'e40', source: 'opts_30_not_delivered', target: 'case_30_not_delivered', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e41', source: 'opts_30_not_delivered', target: 'msg_mgr1_not_delivered', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e42', source: 'case_30_not_delivered', target: 'end_30_not_delivered', animated: true },
              { id: 'e43', source: 'msg_mgr1_not_delivered', target: 'delay1_not_delivered', animated: true },
              { id: 'e44', source: 'delay1_not_delivered', target: 'offer_40_not_delivered', animated: true },
              { id: 'e45', source: 'offer_40_not_delivered', target: 'opts_40_not_delivered', animated: true },
              { id: 'e46', source: 'opts_40_not_delivered', target: 'case_40_not_delivered', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e47', source: 'opts_40_not_delivered', target: 'msg_mgr2_not_delivered', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e48', source: 'case_40_not_delivered', target: 'end_40_not_delivered', animated: true },
              { id: 'e49', source: 'msg_mgr2_not_delivered', target: 'delay2_not_delivered', animated: true },
              { id: 'e50', source: 'delay2_not_delivered', target: 'offer_50_not_delivered', animated: true },
              { id: 'e51', source: 'offer_50_not_delivered', target: 'opts_50_not_delivered', animated: true },
              { id: 'e52', source: 'opts_50_not_delivered', target: 'case_50_not_delivered', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e53', source: 'opts_50_not_delivered', target: 'msg_full_not_delivered', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e54', source: 'case_50_not_delivered', target: 'end_50_not_delivered', animated: true },
              { id: 'e55', source: 'msg_full_not_delivered', target: 'case_full_not_delivered', animated: true },
              { id: 'e56', source: 'case_full_not_delivered', target: 'end_full_not_delivered', animated: true },
              // Not Recognized inline ladder
              { id: 'e57', source: 'msg6', target: 'api3', animated: true },
              { id: 'e58', source: 'api3', target: 'msg7', animated: true },
              { id: 'e59', source: 'msg7', target: 'opts_not_recognized', animated: true },
              { id: 'e60', source: 'opts_not_recognized', target: 'end_keep_order', sourceHandle: 'opt-0', label: 'Keep order', animated: true },
              { id: 'e61', source: 'opts_not_recognized', target: 'cond_guarantee_nr', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              { id: 'e62', source: 'cond_guarantee_nr', target: 'offer_20_nr', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e63', source: 'cond_guarantee_nr', target: 'msg_expired_nr', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e64', source: 'msg_expired_nr', target: 'case_expired_nr', animated: true },
              { id: 'e65', source: 'case_expired_nr', target: 'end_expired_nr', animated: true },
              { id: 'e66', source: 'offer_20_nr', target: 'opts_20_nr', animated: true },
              { id: 'e67', source: 'opts_20_nr', target: 'case_20_nr', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e68', source: 'opts_20_nr', target: 'offer_30_nr', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e69', source: 'case_20_nr', target: 'end_20_nr', animated: true },
              { id: 'e70', source: 'offer_30_nr', target: 'opts_30_nr', animated: true },
              { id: 'e71', source: 'opts_30_nr', target: 'case_30_nr', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e72', source: 'opts_30_nr', target: 'msg_mgr1_nr', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e73', source: 'case_30_nr', target: 'end_30_nr', animated: true },
              { id: 'e74', source: 'msg_mgr1_nr', target: 'delay1_nr', animated: true },
              { id: 'e75', source: 'delay1_nr', target: 'offer_40_nr', animated: true },
              { id: 'e76', source: 'offer_40_nr', target: 'opts_40_nr', animated: true },
              { id: 'e77', source: 'opts_40_nr', target: 'case_40_nr', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e78', source: 'opts_40_nr', target: 'msg_mgr2_nr', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e79', source: 'case_40_nr', target: 'end_40_nr', animated: true },
              { id: 'e80', source: 'msg_mgr2_nr', target: 'delay2_nr', animated: true },
              { id: 'e81', source: 'delay2_nr', target: 'offer_50_nr', animated: true },
              { id: 'e82', source: 'offer_50_nr', target: 'opts_50_nr', animated: true },
              { id: 'e83', source: 'opts_50_nr', target: 'case_50_nr', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e84', source: 'opts_50_nr', target: 'msg_full_nr', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e85', source: 'case_50_nr', target: 'end_50_nr', animated: true },
              { id: 'e86', source: 'msg_full_nr', target: 'case_full_nr', animated: true },
              { id: 'e87', source: 'case_full_nr', target: 'end_full_nr', animated: true }
            ]
          },

          // NOT RECEIVED - With Shipping Ladder
          not_received: {
            id: 'not_received',
            parentId: 'help_with_order',
            name: 'Haven\\'t Received Order',
            description: 'Order not received - check tracking then shipping ladder (refund + reship)',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Not Received Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Let me check the tracking status for your order..." } },
              { id: 'api1', type: 'api', position: { x: 350, y: 330 }, data: { service: 'ParcelPanel', endpoint: '/api/tracking', description: 'Get real-time tracking status' } },
              { id: 'cond1', type: 'condition', position: { x: 350, y: 510 }, data: { variable: 'trackingStatus', operator: '===', value: 'delivered', yesLabel: 'Delivered', noLabel: 'In Transit' } },
              { id: 'msg2', type: 'message', position: { x: 100, y: 730 }, data: { persona: 'amy', content: "I can see this order has been delivered! ðŸ“¦ Since you have the products, would you like to keep them and I'll give you a 20% refund for all this confusion?" } },
              { id: 'msg3', type: 'message', position: { x: 600, y: 730 }, data: { persona: 'amy', content: "I see this order hasn't been delivered yet! ðŸ“¦ Here's what I can do: I'll give you a 20% refund for all this confusion, and you can keep the order when it arrives." } },
              { id: 'offer1', type: 'offer', position: { x: 350, y: 950 }, data: { percent: 20, label: 'Keep product + reship', message: "20% refund PLUS we'll reship your order free of charge!" } },
              { id: 'offer2', type: 'offer', position: { x: 350, y: 1170 }, data: { percent: 30, label: 'Keep product + reship', message: "30% refund AND a free reship." } },
              { id: 'delay1', type: 'delay', position: { x: 350, y: 1390 }, data: { duration: 8000, message: 'Checking with manager...' } },
              { id: 'offer3', type: 'offer', position: { x: 350, y: 1590 }, data: { percent: 40, label: 'Keep product + reship', message: "Manager approved: 40% refund PLUS a free reship!", needsManagerApproval: true } },
              { id: 'delay2', type: 'delay', position: { x: 350, y: 1810 }, data: { duration: 8000, message: 'Final manager check...' } },
              { id: 'offer4', type: 'offer', position: { x: 350, y: 2010 }, data: { percent: 50, label: 'Maximum offer + reship', message: "Maximum offer: 50% refund PLUS a free reship!", needsManagerApproval: true, isFinal: true } },
              { id: 'case1', type: 'case', position: { x: 100, y: 2210 }, data: { type: 'shipping', subtype: 'partial_refund_reship', priority: 'normal' } },
              { id: 'case2', type: 'case', position: { x: 600, y: 2210 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end1', type: 'end', position: { x: 350, y: 2410 }, data: { title: 'Resolution Complete', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'api1', animated: true },
              { id: 'e3', source: 'api1', target: 'cond1', animated: true },
              { id: 'e4', source: 'cond1', target: 'msg2', sourceHandle: 'yes', label: 'Delivered', animated: true },
              { id: 'e5', source: 'cond1', target: 'msg3', sourceHandle: 'no', label: 'Not delivered', animated: true },
              { id: 'e6', source: 'msg2', target: 'offer1', animated: true },
              { id: 'e7', source: 'msg3', target: 'offer1', animated: true },
              { id: 'e8', source: 'offer1', target: 'case1', sourceHandle: 'accept', label: 'Accept', animated: true },
              { id: 'e9', source: 'offer1', target: 'offer2', sourceHandle: 'decline', label: 'Decline', animated: true },
              { id: 'e10', source: 'offer2', target: 'case1', sourceHandle: 'accept', animated: true },
              { id: 'e11', source: 'offer2', target: 'delay1', sourceHandle: 'decline', animated: true },
              { id: 'e12', source: 'delay1', target: 'offer3', animated: true },
              { id: 'e13', source: 'offer3', target: 'case1', sourceHandle: 'accept', animated: true },
              { id: 'e14', source: 'offer3', target: 'delay2', sourceHandle: 'decline', animated: true },
              { id: 'e15', source: 'delay2', target: 'offer4', animated: true },
              { id: 'e16', source: 'offer4', target: 'case1', sourceHandle: 'accept', animated: true },
              { id: 'e17', source: 'offer4', target: 'case2', sourceHandle: 'decline', label: 'Full refund', animated: true },
              { id: 'e18', source: 'case1', target: 'end1', animated: true },
              { id: 'e19', source: 'case2', target: 'end1', animated: true }
            ]
          },

          // QUALITY DIFFERENCE
          // QUALITY DIFFERENCE - Full Flow with 350px spacing, keep/pay more/refund branches, used/unused checks
          quality_difference: {
            id: 'quality_difference',
            parentId: 'help_with_order',
            name: 'Quality Difference',
            description: 'Customer ordered more and received different quality - comparison card, keep/pay more/refund options with used/unused check and US/Canada return logic',
            nodes: [
              // Main flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 700, y: 0 }, data: { label: 'Quality Difference Flow' } },
              { id: 'msg1', type: 'message', position: { x: 650, y: 350 }, data: { persona: 'amy', content: "I understand â€” it can be frustrating when product quality varies between orders!<br><br>Here's the thing: during different production batches, slight variations can occur. However, all our products still meet our quality standards.<br><br>Let me show you what you've received so we can compare..." } },
              { id: 'api1', type: 'api', position: { x: 650, y: 700 }, data: { service: 'Shopify', endpoint: '/api/orders', description: 'Get order details for comparison', request: '{ orderNumber }', response: '{ items[], totalPrice }' } },
              { id: 'display1', type: 'display', position: { x: 650, y: 1050 }, data: { type: 'comparison_card', label: 'Order Comparison', showPreviousOrder: true, showCurrentOrder: true } },
              { id: 'msg2', type: 'message', position: { x: 650, y: 1400 }, data: { persona: 'amy', content: "I totally get it! Here's what we can offer:<br><br>You can keep what you have (since it still works!), or if you'd like the premium version, you can pay the difference. We can also process a refund if you prefer." } },
              { id: 'opts1', type: 'options', position: { x: 650, y: 1750 }, data: { prompt: 'What would you like to do?', options: [{ label: 'Keep what I have', icon: 'âœ…' }, { label: 'Pay difference for premium', icon: 'ðŸ’³' }, { label: 'Process a refund', icon: 'ðŸ’°' }] } },
              
              // Keep branch - left (500px offset)
              { id: 'msg_keep', type: 'message', position: { x: 100, y: 2100 }, data: { persona: 'amy', content: "Great choice! We appreciate your understanding. Is there anything else I can help you with?" } },
              { id: 'end_keep', type: 'end', position: { x: 100, y: 2450 }, data: { title: 'Keeping Order', showSurvey: true } },
              
              // Pay more branch - center
              { id: 'msg_pay', type: 'message', position: { x: 650, y: 2100 }, data: { persona: 'amy', content: "Perfect! Before we proceed â€” have you opened/used the products you received?" } },
              { id: 'opts_pay_used', type: 'options', position: { x: 650, y: 2450 }, data: { prompt: 'Have you used them?', options: [{ label: 'No, still sealed', icon: 'ðŸ“¦' }, { label: 'Yes, I opened them', icon: 'âœ…' }] } },
              
              // Pay more - unused (left of pay branch)
              { id: 'msg_pay_unused', type: 'message', position: { x: 350, y: 2800 }, data: { persona: 'amy', content: "How many items would you like to exchange for the premium version?<br><br>The price difference is: {{priceDifference}} per item" } },
              { id: 'form_pay_qty', type: 'form', position: { x: 350, y: 3150 }, data: { formType: 'Quantity Selector', label: 'Select quantity', min: 1, max: '{{maxItems}}' } },
              { id: 'case_pay_unused', type: 'case', position: { x: 350, y: 3500 }, data: { type: 'exchange', subtype: 'quality_upgrade', priority: 'normal', returnRequired: true, note: 'Return current items, send premium + charge difference' } },
              { id: 'msg_pay_unused_done', type: 'message', position: { x: 350, y: 3850 }, data: { persona: 'amy', content: "I've set this up for you. Our team will send you a prepaid return label. Once we receive your items, we'll ship the premium versions and charge the difference.<br><br>Expect the return label via email shortly!" } },
              { id: 'end_pay_unused', type: 'end', position: { x: 350, y: 4200 }, data: { title: 'Upgrade Request Created', showSurvey: true } },
              
              // Pay more - used (right of pay branch)
              { id: 'msg_pay_used', type: 'message', position: { x: 950, y: 2800 }, data: { persona: 'amy', content: "No problem! Since they've been opened, here's how we can help:<br><br>You can order the premium version with a special discount, and keep your current ones as backups!<br><br>How many premium items would you like?" } },
              { id: 'form_pay_used_qty', type: 'form', position: { x: 950, y: 3150 }, data: { formType: 'Quantity Selector', label: 'Select quantity', min: 1 } },
              { id: 'case_pay_used', type: 'case', position: { x: 950, y: 3500 }, data: { type: 'order', subtype: 'quality_upgrade_discount', priority: 'normal', note: 'Send premium version with discount - keep current items' } },
              { id: 'msg_pay_used_done', type: 'message', position: { x: 950, y: 3850 }, data: { persona: 'amy', content: "Wonderful! I've placed the order with your special discount. You'll receive an email confirmation shortly. The premium items will ship within 1-2 business days." } },
              { id: 'end_pay_used', type: 'end', position: { x: 950, y: 4200 }, data: { title: 'Discounted Order Created', showSurvey: true } },
              
              // Refund branch - right side (500px offset)
              { id: 'msg_refund', type: 'message', position: { x: 1300, y: 2100 }, data: { persona: 'amy', content: "I understand! Before we proceed with the refund â€” have you opened/used the products?" } },
              { id: 'opts_refund_used', type: 'options', position: { x: 1300, y: 2450 }, data: { prompt: 'Have you used them?', options: [{ label: 'No, still sealed', icon: 'ðŸ“¦' }, { label: 'Yes, I opened them', icon: 'âœ…' }] } },
              
              // Refund - unused: US/Canada check
              { id: 'cond_us_canada', type: 'condition', position: { x: 1100, y: 2800 }, data: { variable: 'customer.country', operator: 'in', value: '["US", "CA"]', yesLabel: 'US/Canada', noLabel: 'International' } },
              { id: 'msg_refund_unused_us', type: 'message', position: { x: 850, y: 3150 }, data: { persona: 'amy', content: "Since you're in the US/Canada, we'll send you a prepaid return label. Once we receive the items, we'll process your full refund.<br><br>You'll receive the return label via email shortly!" } },
              { id: 'case_refund_unused_us', type: 'case', position: { x: 850, y: 3500 }, data: { type: 'refund', subtype: 'full_with_return', priority: 'normal', returnRequired: true, note: 'Full refund - return items (US/Canada)' } },
              { id: 'end_refund_unused_us', type: 'end', position: { x: 850, y: 3850 }, data: { title: 'Return Initiated', showSurvey: true } },
              { id: 'msg_refund_unused_intl', type: 'message', position: { x: 1350, y: 3150 }, data: { persona: 'amy', content: "Since international return shipping is expensive, you can keep the items and we'll process a full refund for you.<br><br>Expect 3-5 business days for the refund to appear in your account." } },
              { id: 'case_refund_unused_intl', type: 'case', position: { x: 1350, y: 3500 }, data: { type: 'refund', subtype: 'full_keep_items', priority: 'normal', note: 'Full refund - keep items (international)' } },
              { id: 'end_refund_unused_intl', type: 'end', position: { x: 1350, y: 3850 }, data: { title: 'Refund Processed', showSurvey: true } },
              
              // Refund - used: quantity then INLINE refund ladder
              { id: 'msg_refund_used', type: 'message', position: { x: 1600, y: 2800 }, data: { persona: 'amy', content: "Since the items have been opened/used, we can offer you a partial refund. How many items would you like to get a refund for?" } },
              { id: 'form_refund_qty', type: 'form', position: { x: 1600, y: 3150 }, data: { formType: 'Quantity Selector', label: 'Select quantity', min: 1, max: '{{maxItems}}' } },
              // INLINE REFUND LADDER for used items
              { id: 'offer_20', type: 'offer', position: { x: 1600, y: 3500 }, data: { percent: 20, label: '20% Refund', message: "I'd like to offer you a <strong>20% partial refund ({{refundAmount20}})</strong>." } },
              { id: 'opts_20', type: 'options', position: { x: 1600, y: 3850 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 20%', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: 1300, y: 4200 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20', type: 'end', position: { x: 1300, y: 4550 }, data: { title: '20% Refund!', showSurvey: true } },
              { id: 'offer_30', type: 'offer', position: { x: 1600, y: 4200 }, data: { percent: 30, label: '30% Refund', message: "Let me offer you a <strong>30% refund ({{refundAmount30}})</strong>." } },
              { id: 'opts_30', type: 'options', position: { x: 1600, y: 4550 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: 1300, y: 4900 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30', type: 'end', position: { x: 1300, y: 5250 }, data: { title: '30% Refund!', showSurvey: true } },
              { id: 'msg_manager1', type: 'message', position: { x: 1600, y: 4900 }, data: { persona: 'amy', content: "Let me check with my manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 1600, y: 5250 }, data: { duration: 8000, message: 'Checking with manager...' } },
              { id: 'offer_40', type: 'offer', position: { x: 1600, y: 5600 }, data: { percent: 40, label: '40% Refund', message: "My manager approved a <strong>40% refund ({{refundAmount40}})</strong>." } },
              { id: 'opts_40', type: 'options', position: { x: 1600, y: 5950 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: 1300, y: 6300 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40', type: 'end', position: { x: 1300, y: 6650 }, data: { title: '40% Refund!', showSurvey: true } },
              { id: 'msg_manager2', type: 'message', position: { x: 1600, y: 6300 }, data: { persona: 'amy', content: "One more check with my manager..." } },
              { id: 'delay2', type: 'delay', position: { x: 1600, y: 6650 }, data: { duration: 8000, message: 'Final check...' } },
              { id: 'offer_50', type: 'offer', position: { x: 1600, y: 7000 }, data: { percent: 50, label: '50% Maximum', message: "Our <strong>maximum: 50% refund ({{refundAmount50}})</strong>." } },
              { id: 'opts_50', type: 'options', position: { x: 1600, y: 7350 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: 1300, y: 7700 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50', type: 'end', position: { x: 1300, y: 8050 }, data: { title: '50% Refund!', showSurvey: true } },
              { id: 'msg_full_refund', type: 'message', position: { x: 1600, y: 7700 }, data: { persona: 'amy', content: "I'll process a full refund. Expect 3-5 business days." } },
              { id: 'case_full', type: 'case', position: { x: 1600, y: 8050 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 1600, y: 8400 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'api1', animated: true },
              { id: 'e3', source: 'api1', target: 'display1', animated: true },
              { id: 'e4', source: 'display1', target: 'msg2', animated: true },
              { id: 'e5', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg_keep', sourceHandle: 'opt-0', label: 'Keep', animated: true },
              { id: 'e7', source: 'opts1', target: 'msg_pay', sourceHandle: 'opt-1', label: 'Pay more', animated: true },
              { id: 'e8', source: 'opts1', target: 'msg_refund', sourceHandle: 'opt-2', label: 'Refund', animated: true },
              // Keep branch
              { id: 'e9', source: 'msg_keep', target: 'end_keep', animated: true },
              // Pay more branch
              { id: 'e10', source: 'msg_pay', target: 'opts_pay_used', animated: true },
              { id: 'e11', source: 'opts_pay_used', target: 'msg_pay_unused', sourceHandle: 'opt-0', label: 'Unused', animated: true },
              { id: 'e12', source: 'opts_pay_used', target: 'msg_pay_used', sourceHandle: 'opt-1', label: 'Used', animated: true },
              { id: 'e13', source: 'msg_pay_unused', target: 'form_pay_qty', animated: true },
              { id: 'e14', source: 'form_pay_qty', target: 'case_pay_unused', animated: true },
              { id: 'e15', source: 'case_pay_unused', target: 'msg_pay_unused_done', animated: true },
              { id: 'e16', source: 'msg_pay_unused_done', target: 'end_pay_unused', animated: true },
              { id: 'e17', source: 'msg_pay_used', target: 'form_pay_used_qty', animated: true },
              { id: 'e18', source: 'form_pay_used_qty', target: 'case_pay_used', animated: true },
              { id: 'e19', source: 'case_pay_used', target: 'msg_pay_used_done', animated: true },
              { id: 'e20', source: 'msg_pay_used_done', target: 'end_pay_used', animated: true },
              // Refund branch
              { id: 'e21', source: 'msg_refund', target: 'opts_refund_used', animated: true },
              { id: 'e22', source: 'opts_refund_used', target: 'cond_us_canada', sourceHandle: 'opt-0', label: 'Unused', animated: true },
              { id: 'e23', source: 'opts_refund_used', target: 'msg_refund_used', sourceHandle: 'opt-1', label: 'Used', animated: true },
              { id: 'e24', source: 'cond_us_canada', target: 'msg_refund_unused_us', sourceHandle: 'yes', label: 'US/CA', animated: true },
              { id: 'e25', source: 'cond_us_canada', target: 'msg_refund_unused_intl', sourceHandle: 'no', label: 'International', animated: true },
              { id: 'e26', source: 'msg_refund_unused_us', target: 'case_refund_unused_us', animated: true },
              { id: 'e27', source: 'case_refund_unused_us', target: 'end_refund_unused_us', animated: true },
              { id: 'e28', source: 'msg_refund_unused_intl', target: 'case_refund_unused_intl', animated: true },
              { id: 'e29', source: 'case_refund_unused_intl', target: 'end_refund_unused_intl', animated: true },
              // Used items refund ladder
              { id: 'e30', source: 'msg_refund_used', target: 'form_refund_qty', animated: true },
              { id: 'e31', source: 'form_refund_qty', target: 'offer_20', animated: true },
              { id: 'e32', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e33', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e34', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e35', source: 'case_20', target: 'end_20', animated: true },
              { id: 'e36', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e37', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e38', source: 'opts_30', target: 'msg_manager1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e39', source: 'case_30', target: 'end_30', animated: true },
              { id: 'e40', source: 'msg_manager1', target: 'delay1', animated: true },
              { id: 'e41', source: 'delay1', target: 'offer_40', animated: true },
              { id: 'e42', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e43', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e44', source: 'opts_40', target: 'msg_manager2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e45', source: 'case_40', target: 'end_40', animated: true },
              { id: 'e46', source: 'msg_manager2', target: 'delay2', animated: true },
              { id: 'e47', source: 'delay2', target: 'offer_50', animated: true },
              { id: 'e48', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e49', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e50', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e51', source: 'case_50', target: 'end_50', animated: true },
              { id: 'e52', source: 'msg_full_refund', target: 'case_full', animated: true },
              { id: 'e53', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          // OTHER REASON - 350px spacing
          other_reason: {
            id: 'other_reason',
            parentId: 'help_with_order',
            name: 'Other Reason',
            description: 'Customer has a different issue - free text input, then INLINE refund ladder (20%â†’30%â†’40%â†’50%â†’full)',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Other Reason Flow' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "No problem â€” tell me what's going on and I'll do my best to help:" } },
              { id: 'input1', type: 'form', position: { x: 450, y: 700 }, data: { formType: 'Text Input', label: 'Describe your issue...', placeholder: 'Tell us what happened' } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "Thank you for explaining. I understand this is frustrating. Let me see what options I have for you." } },
              
              // ========== INLINE REFUND LADDER ==========
              { id: 'cond_guarantee', type: 'condition', position: { x: 450, y: 1400 }, data: { variable: 'guarantee.eligible', operator: '===', value: 'true', yesLabel: 'Within 90 days', noLabel: 'Expired' } },
              { id: 'msg_guarantee_expired', type: 'message', position: { x: 850, y: 1750 }, data: { persona: 'amy', content: "The 90-day guarantee has expired. Let me create a case for review." } },
              { id: 'case_guarantee_expired', type: 'case', position: { x: 850, y: 2100 }, data: { type: 'refund', subtype: 'guarantee_expired', priority: 'normal' } },
              { id: 'end_guarantee_expired', type: 'end', position: { x: 850, y: 2450 }, data: { title: 'Case for Review', showSurvey: true } },
              // 20% offer
              { id: 'offer_20', type: 'offer', position: { x: 150, y: 1750 }, data: { percent: 20, label: '20% Refund', message: "I'd like to offer you a <strong>20% partial refund ({{refundAmount20}})</strong>." } },
              { id: 'opts_20', type: 'options', position: { x: 150, y: 2100 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 20%', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: -150, y: 2450 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'end_20', type: 'end', position: { x: -150, y: 2800 }, data: { title: '20% Refund!', showSurvey: true } },
              // 30% offer
              { id: 'offer_30', type: 'offer', position: { x: 150, y: 2450 }, data: { percent: 30, label: '30% Refund', message: "Let me offer you a <strong>30% refund ({{refundAmount30}})</strong>." } },
              { id: 'opts_30', type: 'options', position: { x: 150, y: 2800 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: -150, y: 3150 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal' } },
              { id: 'end_30', type: 'end', position: { x: -150, y: 3500 }, data: { title: '30% Refund!', showSurvey: true } },
              // Manager delay 1
              { id: 'msg_manager1', type: 'message', position: { x: 150, y: 3150 }, data: { persona: 'amy', content: "Let me check with my manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 150, y: 3500 }, data: { duration: 8000, message: 'Checking with manager...' } },
              // 40% offer
              { id: 'offer_40', type: 'offer', position: { x: 150, y: 3850 }, data: { percent: 40, label: '40% Refund', message: "My manager approved a <strong>40% refund ({{refundAmount40}})</strong>." } },
              { id: 'opts_40', type: 'options', position: { x: 150, y: 4200 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: -150, y: 4550 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal' } },
              { id: 'end_40', type: 'end', position: { x: -150, y: 4900 }, data: { title: '40% Refund!', showSurvey: true } },
              // Manager delay 2
              { id: 'msg_manager2', type: 'message', position: { x: 150, y: 4550 }, data: { persona: 'amy', content: "One more check with my manager..." } },
              { id: 'delay2', type: 'delay', position: { x: 150, y: 4900 }, data: { duration: 8000, message: 'Final check...' } },
              // 50% offer
              { id: 'offer_50', type: 'offer', position: { x: 150, y: 5250 }, data: { percent: 50, label: '50% Maximum', message: "Our <strong>maximum: 50% refund ({{refundAmount50}})</strong>." } },
              { id: 'opts_50', type: 'options', position: { x: 150, y: 5600 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: -150, y: 5950 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal' } },
              { id: 'end_50', type: 'end', position: { x: -150, y: 6300 }, data: { title: '50% Refund!', showSurvey: true } },
              // Full refund
              { id: 'msg_full_refund', type: 'message', position: { x: 150, y: 5950 }, data: { persona: 'amy', content: "I'll process a full refund. Expect 3-5 business days." } },
              { id: 'case_full', type: 'case', position: { x: 150, y: 6300 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 150, y: 6650 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'input1', animated: true },
              { id: 'e3', source: 'input1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'cond_guarantee', animated: true },
              // Guarantee check
              { id: 'e5', source: 'cond_guarantee', target: 'offer_20', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e6', source: 'cond_guarantee', target: 'msg_guarantee_expired', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e7', source: 'msg_guarantee_expired', target: 'case_guarantee_expired', animated: true },
              { id: 'e8', source: 'case_guarantee_expired', target: 'end_guarantee_expired', animated: true },
              // 20% ladder
              { id: 'e9', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e10', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e11', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e12', source: 'case_20', target: 'end_20', animated: true },
              // 30% ladder
              { id: 'e13', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e14', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e15', source: 'opts_30', target: 'msg_manager1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e16', source: 'case_30', target: 'end_30', animated: true },
              // Manager delay 1
              { id: 'e17', source: 'msg_manager1', target: 'delay1', animated: true },
              { id: 'e18', source: 'delay1', target: 'offer_40', animated: true },
              // 40% ladder
              { id: 'e19', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e20', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e21', source: 'opts_40', target: 'msg_manager2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e22', source: 'case_40', target: 'end_40', animated: true },
              // Manager delay 2
              { id: 'e23', source: 'msg_manager2', target: 'delay2', animated: true },
              { id: 'e24', source: 'delay2', target: 'offer_50', animated: true },
              // 50% ladder
              { id: 'e25', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e26', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e27', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e28', source: 'case_50', target: 'end_50', animated: true },
              // Full refund
              { id: 'e29', source: 'msg_full_refund', target: 'case_full', animated: true },
              { id: 'e30', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          // TRACKING FLOW - Full status-based conditionals with 350px vertical, 500px horizontal spacing
          tracking_flow: {
            id: 'tracking_flow',
            parentId: 'track_order',
            name: 'Order Tracking Flow',
            description: 'Customer lookup â†’ Shopify API â†’ ParcelPanel tracking â†’ Status-based conditionals (delivered, in_transit, pending, failed_attempt, pickup, exception) with time windows',
            nodes: [
              // Main entry flow - 350px vertical spacing
              { id: 'start', type: 'start', position: { x: 800, y: 0 }, data: { label: 'Tracking Flow' } },
              { id: 'form1', type: 'form', position: { x: 750, y: 350 }, data: { formType: 'Customer Lookup', label: 'Find Your Order', fields: ['email', 'orderNumber'] } },
              { id: 'api1', type: 'api', position: { x: 750, y: 700 }, data: { service: 'Shopify', endpoint: '/api/lookup', description: 'Find customer orders', request: '{ email, orderNumber }', response: '{ orders[], fulfillments[] }' } },
              { id: 'cond1', type: 'condition', position: { x: 750, y: 1050 }, data: { variable: 'orders.length', operator: '>', value: '0', yesLabel: 'Found', noLabel: 'Not Found' } },
              
              // Order Found â†’ Get tracking
              { id: 'api2', type: 'api', position: { x: 450, y: 1400 }, data: { service: 'ParcelPanel', endpoint: '/api/tracking', description: 'Get real-time tracking from carriers', request: '{ trackingNumber }', response: '{ status, daysInTransit, isInternational, location, estimatedDelivery, events[] }' } },
              
              // Status routing - main branch point (status check tree)
              { id: 'cond_status_delivered', type: 'condition', position: { x: 450, y: 1750 }, data: { variable: 'tracking.status', operator: '===', value: 'delivered', yesLabel: 'Delivered', noLabel: 'Other Status' } },
              { id: 'cond_status_in_transit', type: 'condition', position: { x: 450, y: 2100 }, data: { variable: 'tracking.status', operator: '===', value: 'in_transit', yesLabel: 'In Transit', noLabel: 'Other' } },
              { id: 'cond_status_out_delivery', type: 'condition', position: { x: 950, y: 2100 }, data: { variable: 'tracking.status', operator: '===', value: 'out_for_delivery', yesLabel: 'Out for Delivery', noLabel: 'Other' } },
              { id: 'cond_status_pending', type: 'condition', position: { x: 1450, y: 2100 }, data: { variable: 'tracking.status', operator: '===', value: 'pending', yesLabel: 'Pending', noLabel: 'Other' } },
              { id: 'cond_status_failed', type: 'condition', position: { x: 1950, y: 2100 }, data: { variable: 'tracking.status', operator: '===', value: 'failed_attempt', yesLabel: 'Failed Attempt', noLabel: 'Other' } },
              { id: 'cond_status_pickup', type: 'condition', position: { x: 2450, y: 2100 }, data: { variable: 'tracking.status', operator: 'includes', value: 'pickup', yesLabel: 'Pickup', noLabel: 'Other' } },
              { id: 'cond_status_exception', type: 'condition', position: { x: 2950, y: 2100 }, data: { variable: 'tracking.status', operator: '===', value: 'exception', yesLabel: 'Exception', noLabel: 'Unknown' } },
              
              // ========== DELIVERED BRANCH ==========
              { id: 'msg_delivered', type: 'message', position: { x: -200, y: 2100 }, data: { persona: 'amy', content: "According to tracking, your order was delivered on <strong>{{deliveryDate}}</strong>.<br><br>Before we investigate, could you please double-check these common locations?<br><br>â€¢ <strong>Neighbors</strong> - Sometimes packages are left next door<br>â€¢ <strong>Family/household members</strong> - Someone may have brought it inside<br>â€¢ <strong>Safe spots</strong> - Behind pillars, under mats, in bushes<br>â€¢ <strong>Front desk/mailroom</strong> - If you live in an apartment or building<br>â€¢ <strong>Garage or side door</strong> - Carriers sometimes leave packages there" } },
              { id: 'opts_delivered', type: 'options', position: { x: -200, y: 2450 }, data: { prompt: 'What would you like to do?', options: [{ label: "I've checked all these places", icon: 'ðŸ”' }, { label: "Give me time to check", icon: 'â°' }, { label: "I found it!", icon: 'âœ…' }] } },
              { id: 'subflow_delivered_not_received', type: 'subflow', position: { x: -500, y: 2800 }, data: { name: 'Delivered Not Received', slug: 'delivered_not_received', nodeCount: 8, description: 'Investigation â†’ reship/refund options' } },
              { id: 'end_delivered_found', type: 'end', position: { x: 100, y: 2800 }, data: { title: 'Package Found!', showSurvey: true } },
              { id: 'end_waiting_check', type: 'end', position: { x: -200, y: 2800 }, data: { title: 'Thanks! Check and let us know', showSurvey: false } },
              
              // ========== IN TRANSIT BRANCH - Days in Transit checks ==========
              { id: 'cond_transit_15plus', type: 'condition', position: { x: -200, y: 2450 }, data: { variable: 'tracking.daysInTransit', operator: '>=', value: '15', yesLabel: '15+ days', noLabel: '<15 days' } },
              { id: 'cond_transit_6to14', type: 'condition', position: { x: 100, y: 2800 }, data: { variable: 'tracking.daysInTransit', operator: '>=', value: '6', yesLabel: '6-14 days', noLabel: '0-5 days' } },
              
              // In Transit - 15+ days (Extended Transit subflow)
              { id: 'subflow_extended_transit', type: 'subflow', position: { x: -500, y: 2800 }, data: { name: 'Extended Transit', slug: 'extended_transit', nodeCount: 12, description: 'Shipping refund ladder with reship offers' } },
              
              // In Transit - 6-14 days (Sarah Voice Note)
              { id: 'msg_sarah_voice', type: 'message', position: { x: -100, y: 3150 }, data: { persona: 'sarah', content: "Your package has been in transit for {{daysInTransit}} days now. Our CX lead Sarah has a quick update for you..." } },
              { id: 'audio_sarah', type: 'form', position: { x: -100, y: 3500 }, data: { formType: 'Audio Player', label: 'Sarah Voice Note', description: 'Waveform audio player with Sarah reassurance message' } },
              { id: 'opts_sarah', type: 'options', position: { x: -100, y: 3850 }, data: { prompt: 'How can I help?', options: [{ label: "I'll wait a bit longer", icon: 'â³' }, { label: "I have a concern", icon: 'âš ï¸' }] } },
              { id: 'subflow_extended_from_voice', type: 'subflow', position: { x: 200, y: 4200 }, data: { name: 'Extended Transit', slug: 'extended_transit', nodeCount: 12 } },
              { id: 'end_waiting_sarah', type: 'end', position: { x: -400, y: 4200 }, data: { title: 'Thanks for your patience!', showSurvey: true } },
              
              // In Transit - 0-5 days (Normal) with international check
              { id: 'cond_international', type: 'condition', position: { x: 400, y: 3150 }, data: { variable: 'tracking.isInternational', operator: '===', value: 'true', yesLabel: 'International', noLabel: 'Domestic' } },
              { id: 'msg_in_transit_domestic', type: 'message', position: { x: 200, y: 3500 }, data: { persona: 'amy', content: "Your order is currently <strong>in transit</strong> and has been shipping for {{daysInTransit}} day(s). Delivery typically takes 5-10 business days. Expected delivery: <strong>{{estimatedDelivery}}</strong><br><br>It's still within the normal delivery window â€” your package is on its way!" } },
              { id: 'msg_in_transit_intl', type: 'message', position: { x: 600, y: 3500 }, data: { persona: 'amy', content: "Your order is currently <strong>in transit</strong> and has been shipping for {{daysInTransit}} day(s). Since this is shipping from our international warehouse, it can sometimes take an additional 5 business days. Expected delivery: <strong>{{estimatedDelivery}}</strong><br><br>It's still within the normal delivery window â€” your package is on its way!" } },
              { id: 'opts_in_transit', type: 'options', position: { x: 400, y: 3850 }, data: { prompt: 'What would you like to do?', options: [{ label: "Okay, I'll wait", icon: 'â³' }, { label: "I have a concern", icon: 'âš ï¸' }] } },
              { id: 'subflow_extended_from_normal', type: 'subflow', position: { x: 600, y: 4200 }, data: { name: 'Extended Transit', slug: 'extended_transit', nodeCount: 12 } },
              { id: 'end_waiting_normal', type: 'end', position: { x: 200, y: 4200 }, data: { title: 'Thanks for your patience!', showSurvey: true } },
              
              // ========== OUT FOR DELIVERY BRANCH ==========
              { id: 'msg_out_for_delivery', type: 'message', position: { x: 950, y: 2450 }, data: { persona: 'amy', content: "Great news! Your package is <strong>out for delivery today</strong>. It should arrive within the next few hours. Expected delivery: <strong>{{estimatedDelivery}}</strong>" } },
              { id: 'cond_out_intl', type: 'condition', position: { x: 950, y: 2800 }, data: { variable: 'tracking.isInternational', operator: '===', value: 'true', yesLabel: 'International', noLabel: 'Domestic' } },
              { id: 'msg_out_intl', type: 'message', position: { x: 1200, y: 3150 }, data: { persona: 'amy', content: "Your order is shipping from our international warehouse, which can sometimes take a bit longer but it's on its way to you!" } },
              { id: 'opts_out_delivery', type: 'options', position: { x: 950, y: 3500 }, data: { prompt: 'What would you like to do?', options: [{ label: "Perfect, I'll wait", icon: 'âœ…' }, { label: "It's been out for delivery for days", icon: 'âš ï¸' }] } },
              { id: 'case_stuck_out_delivery', type: 'case', position: { x: 1200, y: 3850 }, data: { type: 'shipping', subtype: 'stuck_out_for_delivery', priority: 'high', note: 'Package stuck in out for delivery status' } },
              { id: 'end_waiting_out', type: 'end', position: { x: 700, y: 3850 }, data: { title: 'Enjoy your delivery!', showSurvey: true } },
              
              // ========== PENDING BRANCH ==========
              { id: 'msg_pending', type: 'message', position: { x: 1450, y: 2450 }, data: { persona: 'amy', content: "Your order is currently being prepared for shipment. The carrier has received the shipping information but hasn't picked up the package yet.<br><br>This typically happens within 1-2 business days of placing your order." } },
              { id: 'cond_pending_days', type: 'condition', position: { x: 1450, y: 2800 }, data: { variable: 'tracking.daysInTransit', operator: '>', value: '3', yesLabel: '>3 days', noLabel: 'â‰¤3 days' } },
              { id: 'msg_pending_long', type: 'message', position: { x: 1700, y: 3150 }, data: { persona: 'amy', content: "However, I notice it's been a few days. Would you like me to look into this for you?" } },
              { id: 'opts_pending_long', type: 'options', position: { x: 1700, y: 3500 }, data: { prompt: 'What would you like to do?', options: [{ label: "Yes, please investigate", icon: 'ðŸ”' }, { label: "I'll wait a bit longer", icon: 'â³' }] } },
              { id: 'case_pending_investigate', type: 'case', position: { x: 1950, y: 3850 }, data: { type: 'shipping', subtype: 'pending_too_long', priority: 'normal', note: 'Investigate why order is stuck in pending' } },
              { id: 'end_waiting_pending_long', type: 'end', position: { x: 1450, y: 3850 }, data: { title: 'Thanks for your patience!', showSurvey: true } },
              { id: 'opts_pending_normal', type: 'options', position: { x: 1200, y: 3150 }, data: { prompt: 'What would you like to do?', options: [{ label: "Got it, I'll wait", icon: 'âœ…' }, { label: "I need to cancel instead", icon: 'âŒ' }] } },
              { id: 'case_pending_cancel', type: 'case', position: { x: 1450, y: 3500 }, data: { type: 'refund', subtype: 'order_cancellation', priority: 'normal', note: 'Cancel order before shipment' } },
              { id: 'end_waiting_pending', type: 'end', position: { x: 950, y: 3500 }, data: { title: 'Order processing soon!', showSurvey: true } },
              
              // ========== FAILED ATTEMPT BRANCH ==========
              { id: 'msg_failed_attempt', type: 'message', position: { x: 1950, y: 2450 }, data: { persona: 'amy', content: "The carrier attempted to deliver your package but was unsuccessful. This could be due to:<br><br>â€¢ No one available to sign<br>â€¢ Address access issues<br>â€¢ Weather conditions<br><br>They'll typically try again within 1-2 business days." } },
              { id: 'opts_failed_attempt', type: 'options', position: { x: 1950, y: 2800 }, data: { prompt: 'What would you like to do?', options: [{ label: "I'll be home next time", icon: 'ðŸ ' }, { label: "I need to change my address", icon: 'ðŸ“' }, { label: "They've tried multiple times", icon: 'âš ï¸' }] } },
              { id: 'end_waiting_failed', type: 'end', position: { x: 1700, y: 3150 }, data: { title: 'Ready for redelivery!', showSurvey: true } },
              { id: 'subflow_failed_address', type: 'subflow', position: { x: 1950, y: 3150 }, data: { name: 'Failed Attempt - Address Change', slug: 'failed_attempt_address', nodeCount: 6, description: 'Address form â†’ case creation' } },
              { id: 'subflow_multiple_failed', type: 'subflow', position: { x: 2200, y: 3150 }, data: { name: 'Multiple Failed Attempts', slug: 'multiple_failed_attempts', nodeCount: 8, description: 'Reship or refund options' } },
              
              // ========== PICKUP BRANCH ==========
              { id: 'msg_pickup', type: 'message', position: { x: 2450, y: 2450 }, data: { persona: 'amy', content: "Good news! Your package has arrived and is ready for you." } },
              { id: 'api_pickup_parse', type: 'api', position: { x: 2450, y: 2800 }, data: { service: 'AI', endpoint: '/api/parse-pickup-location', description: 'Parse pickup location from tracking data using AI', request: '{ tracking, checkpoints, shippingAddress }', response: '{ pickupLocationName, displayCarrier, lastMileTrackingNumber }' } },
              { id: 'msg_pickup_location', type: 'message', position: { x: 2450, y: 3150 }, data: { persona: 'amy', content: "Your package is ready for pickup at:<br><br><strong>{{pickupLocationName}}</strong><br><br>Please bring a valid ID when you go to pick it up." } },
              { id: 'opts_pickup', type: 'options', position: { x: 2450, y: 3500 }, data: { prompt: 'What would you like to do?', options: [{ label: "Thanks, I'll pick it up", icon: 'âœ…' }, { label: "Package not at pickup location", icon: 'âŒ' }] } },
              { id: 'end_waiting_pickup', type: 'end', position: { x: 2200, y: 3850 }, data: { title: 'Enjoy your pickup!', showSurvey: true } },
              { id: 'subflow_pickup_not_there', type: 'subflow', position: { x: 2700, y: 3850 }, data: { name: 'Pickup Not There', slug: 'pickup_not_there', nodeCount: 10, description: 'Pickup attempt form â†’ case creation' } },
              
              // ========== EXCEPTION BRANCH with INLINE refund ladder ==========
              { id: 'msg_exception', type: 'message', position: { x: 2950, y: 2450 }, data: { persona: 'amy', content: "I see there's an issue with your package delivery. Let me help you figure out what's going on." } },
              { id: 'opts_exception', type: 'options', position: { x: 2950, y: 2800 }, data: { prompt: 'What would you like to do?', options: [{ label: "Investigate and reship", icon: 'ðŸ”' }, { label: "I'd prefer a refund", icon: 'ðŸ’°' }] } },
              { id: 'subflow_exception_investigate', type: 'subflow', position: { x: 2650, y: 3150 }, data: { name: 'Exception Investigation', slug: 'exception_investigation', nodeCount: 30, description: 'Investigation â†’ reship (has inline refund ladder)' } },
              // INLINE shipping refund ladder for exception
              { id: 'offer_20_exc', type: 'offer', position: { x: 3250, y: 3150 }, data: { percent: 20, label: '20% + Reship', message: "<strong>20% refund + free reship</strong>" } },
              { id: 'opts_20_exc', type: 'options', position: { x: 3250, y: 3500 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 20%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20_exc', type: 'case', position: { x: 2950, y: 3850 }, data: { type: 'refund', subtype: 'partial_20_reship', priority: 'normal' } },
              { id: 'subflow_reship_20_exc', type: 'subflow', position: { x: 2950, y: 4200 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_20_exc', type: 'end', position: { x: 2950, y: 4550 }, data: { title: '20% + Reship!', showSurvey: true } },
              { id: 'offer_30_exc', type: 'offer', position: { x: 3250, y: 3850 }, data: { percent: 30, label: '30% + Reship', message: "<strong>30% + reship</strong>" } },
              { id: 'opts_30_exc', type: 'options', position: { x: 3250, y: 4200 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30_exc', type: 'case', position: { x: 2950, y: 4550 }, data: { type: 'refund', subtype: 'partial_30_reship', priority: 'normal' } },
              { id: 'subflow_reship_30_exc', type: 'subflow', position: { x: 2950, y: 4900 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_30_exc', type: 'end', position: { x: 2950, y: 5250 }, data: { title: '30% + Reship!', showSurvey: true } },
              { id: 'msg_mgr1_exc', type: 'message', position: { x: 3250, y: 4550 }, data: { persona: 'amy', content: "Checking with manager..." } },
              { id: 'delay1_exc', type: 'delay', position: { x: 3250, y: 4900 }, data: { duration: 8000, message: 'Manager check...' } },
              { id: 'offer_40_exc', type: 'offer', position: { x: 3250, y: 5250 }, data: { percent: 40, label: '40% + Reship', message: "<strong>40% + reship</strong>" } },
              { id: 'opts_40_exc', type: 'options', position: { x: 3250, y: 5600 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40_exc', type: 'case', position: { x: 2950, y: 5950 }, data: { type: 'refund', subtype: 'partial_40_reship', priority: 'normal' } },
              { id: 'subflow_reship_40_exc', type: 'subflow', position: { x: 2950, y: 6300 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_40_exc', type: 'end', position: { x: 2950, y: 6650 }, data: { title: '40% + Reship!', showSurvey: true } },
              { id: 'msg_mgr2_exc', type: 'message', position: { x: 3250, y: 5950 }, data: { persona: 'amy', content: "Final manager check..." } },
              { id: 'delay2_exc', type: 'delay', position: { x: 3250, y: 6300 }, data: { duration: 8000, message: 'Final check...' } },
              { id: 'offer_50_exc', type: 'offer', position: { x: 3250, y: 6650 }, data: { percent: 50, label: '50% Max + Reship', message: "<strong>Maximum 50% + reship</strong>" } },
              { id: 'opts_50_exc', type: 'options', position: { x: 3250, y: 7000 }, data: { prompt: 'Best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund', icon: 'ðŸ’°' }] } },
              { id: 'case_50_exc', type: 'case', position: { x: 2950, y: 7350 }, data: { type: 'refund', subtype: 'partial_50_reship', priority: 'normal' } },
              { id: 'subflow_reship_50_exc', type: 'subflow', position: { x: 2950, y: 7700 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_50_exc', type: 'end', position: { x: 2950, y: 8050 }, data: { title: '50% + Reship!', showSurvey: true } },
              { id: 'msg_full_exc', type: 'message', position: { x: 3250, y: 7350 }, data: { persona: 'amy', content: "Full refund processing..." } },
              { id: 'case_full_exc', type: 'case', position: { x: 3250, y: 7700 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full_exc', type: 'end', position: { x: 3250, y: 8050 }, data: { title: 'Full Refund!', showSurvey: true } },
              
              // ========== NOT FOUND BRANCH ==========
              { id: 'msg_not_found', type: 'message', position: { x: 1100, y: 1400 }, data: { persona: 'amy', content: "I couldn't find an order with those details. Let's try searching with more information." } },
              { id: 'form2', type: 'form', position: { x: 1100, y: 1750 }, data: { formType: 'Deep Search', label: 'Additional Details', fields: ['firstName', 'lastName', 'address1', 'country'] } },
              
              // End nodes
              { id: 'end_tracking_complete', type: 'end', position: { x: 2950, y: 3500 }, data: { title: 'Tracking Complete!', showSurvey: true } }
            ],
            edges: [
              // Main entry
              { id: 'e1', source: 'start', target: 'form1', animated: true },
              { id: 'e2', source: 'form1', target: 'api1', animated: true },
              { id: 'e3', source: 'api1', target: 'cond1', animated: true },
              { id: 'e4', source: 'cond1', target: 'api2', sourceHandle: 'yes', label: 'Order found', animated: true },
              { id: 'e5', source: 'cond1', target: 'msg_not_found', sourceHandle: 'no', label: 'Not found', animated: true },
              { id: 'e6', source: 'msg_not_found', target: 'form2', animated: true },
              { id: 'e7', source: 'form2', target: 'api1', label: 'Retry search', animated: true },
              
              // Status routing chain
              { id: 'e8', source: 'api2', target: 'cond_status_delivered', animated: true },
              { id: 'e9', source: 'cond_status_delivered', target: 'msg_delivered', sourceHandle: 'yes', label: 'Delivered', animated: true },
              { id: 'e10', source: 'cond_status_delivered', target: 'cond_status_in_transit', sourceHandle: 'no', animated: true },
              { id: 'e11', source: 'cond_status_in_transit', target: 'cond_transit_15plus', sourceHandle: 'yes', label: 'In Transit', animated: true },
              { id: 'e12', source: 'cond_status_in_transit', target: 'cond_status_out_delivery', sourceHandle: 'no', animated: true },
              { id: 'e13', source: 'cond_status_out_delivery', target: 'msg_out_for_delivery', sourceHandle: 'yes', label: 'Out for Delivery', animated: true },
              { id: 'e14', source: 'cond_status_out_delivery', target: 'cond_status_pending', sourceHandle: 'no', animated: true },
              { id: 'e15', source: 'cond_status_pending', target: 'msg_pending', sourceHandle: 'yes', label: 'Pending', animated: true },
              { id: 'e16', source: 'cond_status_pending', target: 'cond_status_failed', sourceHandle: 'no', animated: true },
              { id: 'e17', source: 'cond_status_failed', target: 'msg_failed_attempt', sourceHandle: 'yes', label: 'Failed Attempt', animated: true },
              { id: 'e18', source: 'cond_status_failed', target: 'cond_status_pickup', sourceHandle: 'no', animated: true },
              { id: 'e19', source: 'cond_status_pickup', target: 'msg_pickup', sourceHandle: 'yes', label: 'Pickup', animated: true },
              { id: 'e20', source: 'cond_status_pickup', target: 'cond_status_exception', sourceHandle: 'no', animated: true },
              { id: 'e21', source: 'cond_status_exception', target: 'msg_exception', sourceHandle: 'yes', label: 'Exception', animated: true },
              
              // Delivered branch
              { id: 'e22', source: 'msg_delivered', target: 'opts_delivered', animated: true },
              { id: 'e23', source: 'opts_delivered', target: 'subflow_delivered_not_received', sourceHandle: 'opt-0', label: 'Checked all places', animated: true },
              { id: 'e24', source: 'opts_delivered', target: 'end_waiting_check', sourceHandle: 'opt-1', label: 'Give me time', animated: true },
              { id: 'e25', source: 'opts_delivered', target: 'end_delivered_found', sourceHandle: 'opt-2', label: 'Found it', animated: true },
              
              // In Transit - days in transit checks
              { id: 'e26', source: 'cond_transit_15plus', target: 'subflow_extended_transit', sourceHandle: 'yes', label: '15+ days', animated: true },
              { id: 'e27', source: 'cond_transit_15plus', target: 'cond_transit_6to14', sourceHandle: 'no', label: '<15 days', animated: true },
              { id: 'e28', source: 'cond_transit_6to14', target: 'msg_sarah_voice', sourceHandle: 'yes', label: '6-14 days', animated: true },
              { id: 'e29', source: 'cond_transit_6to14', target: 'cond_international', sourceHandle: 'no', label: '0-5 days', animated: true },
              { id: 'e30', source: 'msg_sarah_voice', target: 'audio_sarah', animated: true },
              { id: 'e31', source: 'audio_sarah', target: 'opts_sarah', animated: true },
              { id: 'e32', source: 'opts_sarah', target: 'end_waiting_sarah', sourceHandle: 'opt-0', label: 'Wait longer', animated: true },
              { id: 'e33', source: 'opts_sarah', target: 'subflow_extended_from_voice', sourceHandle: 'opt-1', label: 'Have concern', animated: true },
              { id: 'e34', source: 'cond_international', target: 'msg_in_transit_intl', sourceHandle: 'yes', label: 'International', animated: true },
              { id: 'e35', source: 'cond_international', target: 'msg_in_transit_domestic', sourceHandle: 'no', label: 'Domestic', animated: true },
              { id: 'e36', source: 'msg_in_transit_domestic', target: 'opts_in_transit', animated: true },
              { id: 'e37', source: 'msg_in_transit_intl', target: 'opts_in_transit', animated: true },
              { id: 'e38', source: 'opts_in_transit', target: 'end_waiting_normal', sourceHandle: 'opt-0', label: 'Wait', animated: true },
              { id: 'e39', source: 'opts_in_transit', target: 'subflow_extended_from_normal', sourceHandle: 'opt-1', label: 'Have concern', animated: true },
              
              // Out for Delivery
              { id: 'e40', source: 'msg_out_for_delivery', target: 'cond_out_intl', animated: true },
              { id: 'e41', source: 'cond_out_intl', target: 'msg_out_intl', sourceHandle: 'yes', label: 'International', animated: true },
              { id: 'e42', source: 'msg_out_intl', target: 'opts_out_delivery', animated: true },
              { id: 'e43', source: 'cond_out_intl', target: 'opts_out_delivery', sourceHandle: 'no', animated: true },
              { id: 'e44', source: 'opts_out_delivery', target: 'end_waiting_out', sourceHandle: 'opt-0', label: 'Wait', animated: true },
              { id: 'e45', source: 'opts_out_delivery', target: 'case_stuck_out_delivery', sourceHandle: 'opt-1', label: 'Stuck for days', animated: true },
              
              // Pending
              { id: 'e46', source: 'msg_pending', target: 'cond_pending_days', animated: true },
              { id: 'e47', source: 'cond_pending_days', target: 'msg_pending_long', sourceHandle: 'yes', label: '>3 days', animated: true },
              { id: 'e48', source: 'cond_pending_days', target: 'opts_pending_normal', sourceHandle: 'no', label: 'â‰¤3 days', animated: true },
              { id: 'e49', source: 'msg_pending_long', target: 'opts_pending_long', animated: true },
              { id: 'e50', source: 'opts_pending_long', target: 'case_pending_investigate', sourceHandle: 'opt-0', label: 'Investigate', animated: true },
              { id: 'e51', source: 'opts_pending_long', target: 'end_waiting_pending_long', sourceHandle: 'opt-1', label: 'Wait', animated: true },
              { id: 'e52', source: 'opts_pending_normal', target: 'end_waiting_pending', sourceHandle: 'opt-0', label: 'Wait', animated: true },
              { id: 'e53', source: 'opts_pending_normal', target: 'case_pending_cancel', sourceHandle: 'opt-1', label: 'Cancel', animated: true },
              
              // Failed Attempt
              { id: 'e54', source: 'msg_failed_attempt', target: 'opts_failed_attempt', animated: true },
              { id: 'e55', source: 'opts_failed_attempt', target: 'end_waiting_failed', sourceHandle: 'opt-0', label: 'Wait', animated: true },
              { id: 'e56', source: 'opts_failed_attempt', target: 'subflow_failed_address', sourceHandle: 'opt-1', label: 'Change address', animated: true },
              { id: 'e57', source: 'opts_failed_attempt', target: 'subflow_multiple_failed', sourceHandle: 'opt-2', label: 'Multiple attempts', animated: true },
              
              // Pickup
              { id: 'e58', source: 'msg_pickup', target: 'api_pickup_parse', animated: true },
              { id: 'e59', source: 'api_pickup_parse', target: 'msg_pickup_location', animated: true },
              { id: 'e60', source: 'msg_pickup_location', target: 'opts_pickup', animated: true },
              { id: 'e61', source: 'opts_pickup', target: 'end_waiting_pickup', sourceHandle: 'opt-0', label: 'Pick it up', animated: true },
              { id: 'e62', source: 'opts_pickup', target: 'subflow_pickup_not_there', sourceHandle: 'opt-1', label: 'Not there', animated: true },
              
              // Exception with inline ladder
              { id: 'e63', source: 'msg_exception', target: 'opts_exception', animated: true },
              { id: 'e64', source: 'opts_exception', target: 'subflow_exception_investigate', sourceHandle: 'opt-0', label: 'Investigate', animated: true },
              { id: 'e65', source: 'opts_exception', target: 'offer_20_exc', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              // 20% + reship
              { id: 'e66', source: 'offer_20_exc', target: 'opts_20_exc', animated: true },
              { id: 'e67', source: 'opts_20_exc', target: 'case_20_exc', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e68', source: 'opts_20_exc', target: 'offer_30_exc', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e69', source: 'case_20_exc', target: 'subflow_reship_20_exc', animated: true },
              { id: 'e70', source: 'subflow_reship_20_exc', target: 'end_20_exc', animated: true },
              // 30% + reship
              { id: 'e71', source: 'offer_30_exc', target: 'opts_30_exc', animated: true },
              { id: 'e72', source: 'opts_30_exc', target: 'case_30_exc', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e73', source: 'opts_30_exc', target: 'msg_mgr1_exc', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e74', source: 'case_30_exc', target: 'subflow_reship_30_exc', animated: true },
              { id: 'e75', source: 'subflow_reship_30_exc', target: 'end_30_exc', animated: true },
              // Manager delay 1
              { id: 'e76', source: 'msg_mgr1_exc', target: 'delay1_exc', animated: true },
              { id: 'e77', source: 'delay1_exc', target: 'offer_40_exc', animated: true },
              // 40% + reship
              { id: 'e78', source: 'offer_40_exc', target: 'opts_40_exc', animated: true },
              { id: 'e79', source: 'opts_40_exc', target: 'case_40_exc', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e80', source: 'opts_40_exc', target: 'msg_mgr2_exc', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e81', source: 'case_40_exc', target: 'subflow_reship_40_exc', animated: true },
              { id: 'e82', source: 'subflow_reship_40_exc', target: 'end_40_exc', animated: true },
              // Manager delay 2
              { id: 'e83', source: 'msg_mgr2_exc', target: 'delay2_exc', animated: true },
              { id: 'e84', source: 'delay2_exc', target: 'offer_50_exc', animated: true },
              // 50% + reship
              { id: 'e85', source: 'offer_50_exc', target: 'opts_50_exc', animated: true },
              { id: 'e86', source: 'opts_50_exc', target: 'case_50_exc', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e87', source: 'opts_50_exc', target: 'msg_full_exc', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e88', source: 'case_50_exc', target: 'subflow_reship_50_exc', animated: true },
              { id: 'e89', source: 'subflow_reship_50_exc', target: 'end_50_exc', animated: true },
              // Full refund
              { id: 'e90', source: 'msg_full_exc', target: 'case_full_exc', animated: true },
              { id: 'e91', source: 'case_full_exc', target: 'end_full_exc', animated: true }
            ]
          },

          // SUBSCRIPTION FLOWS
          pause_subscription: {
            id: 'pause_subscription',
            parentId: 'manage_subscription',
            name: 'Pause Subscription',
            description: 'Customer wants to temporarily pause deliveries - duration selection then API call',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Pause Subscription' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 170 }, data: { persona: 'amy', content: "No problem! How long would you like to pause your subscription?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 370 }, data: { prompt: 'Select pause duration', options: [{ label: '1 month', icon: 'ðŸ“…' }, { label: '2 months', icon: 'ðŸ“…' }, { label: '3 months', icon: 'ðŸ“…' }] } },
              { id: 'api1', type: 'api', position: { x: 350, y: 590 }, data: { service: 'Shopify', endpoint: '/api/subscriptions/pause', description: 'Pause subscription for selected duration', request: '{ subscriptionId, pauseDuration }', response: '{ success, resumeDate }' } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 790 }, data: { persona: 'amy', content: "Done! Your subscription is now paused. We'll automatically resume on {{resumeDate}}. You'll get a reminder email before then!" } },
              { id: 'end1', type: 'end', position: { x: 350, y: 990 }, data: { title: 'Subscription Paused!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e3', source: 'opts1', target: 'api1', animated: true },
              { id: 'e4', source: 'api1', target: 'msg2', animated: true },
              { id: 'e5', source: 'msg2', target: 'end1', animated: true }
            ]
          },

          cancel_subscription: {
            id: 'cancel_subscription',
            parentId: 'manage_subscription',
            name: 'Cancel Subscription',
            description: 'Customer wants to cancel - reason selection with special handling + retention offers',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Cancel Subscription' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 170 }, data: { persona: 'amy', content: "I'm sorry to see you go! Before we cancel, may I ask why you're looking to cancel?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 390 }, data: { prompt: 'Reason for canceling?', options: [{ label: 'Too expensive', icon: 'ðŸ’°' }, { label: 'Dog passed away', icon: 'ðŸŒˆ' }, { label: 'Moving', icon: 'ðŸ ' }, { label: 'Dog no longer needs it', icon: 'ðŸ•' }, { label: 'Other reason', icon: 'â“' }] } },
              { id: 'offer1', type: 'offer', position: { x: 50, y: 650 }, data: { percent: 20, label: '20% off next 3 months', message: "I understand budget can be tight. What if I offer you 20% off your next 3 shipments?", forFuture: true } },
              { id: 'case1', type: 'case', position: { x: 250, y: 650 }, data: { type: 'subscription', subtype: 'pet_loss', priority: 'high', note: 'Pet loss - handle with sensitivity and compassion' } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 650 }, data: { persona: 'amy', content: "Good luck with your move! I'll process your cancellation right away." } },
              { id: 'msg3', type: 'message', position: { x: 650, y: 650 }, data: { persona: 'amy', content: "That's great that your pup is doing well! I'll cancel your subscription, but feel free to come back if you ever need us again." } },
              { id: 'input1', type: 'form', position: { x: 850, y: 650 }, data: { formType: 'Text Input', label: 'Tell us more...' } },
              { id: 'api1', type: 'api', position: { x: 450, y: 890 }, data: { service: 'Shopify', endpoint: '/api/subscriptions/cancel', description: 'Cancel subscription', request: '{ subscriptionId, reason }', response: '{ success }' } },
              { id: 'end1', type: 'end', position: { x: 350, y: 1110 }, data: { title: 'Subscription Updated', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e3', source: 'opts1', target: 'offer1', label: 'Too expensive', animated: true },
              { id: 'e4', source: 'opts1', target: 'case1', label: 'Pet loss', animated: true },
              { id: 'e5', source: 'opts1', target: 'msg2', label: 'Moving', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg3', label: 'No longer needs', animated: true },
              { id: 'e7', source: 'opts1', target: 'input1', label: 'Other', animated: true },
              { id: 'e8', source: 'offer1', target: 'api1', animated: true },
              { id: 'e9', source: 'case1', target: 'end1', animated: true },
              { id: 'e10', source: 'msg2', target: 'api1', animated: true },
              { id: 'e11', source: 'msg3', target: 'api1', animated: true },
              { id: 'e12', source: 'input1', target: 'api1', animated: true },
              { id: 'e13', source: 'api1', target: 'end1', animated: true }
            ]
          },

          // CHANGE ORDER - 350px vertical spacing with used/unused branches
          change_order: {
            id: 'change_order',
            parentId: 'help_with_order',
            name: 'Change Order (Unfulfilled)',
            description: 'Customer wants to change their order within 10-hour unfulfilled window - text input, used/unused check, then 20% refund or return swap',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Change Order Flow' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "Sure! What would you like instead? Tell me what product, size, or color you'd prefer:" } },
              { id: 'form1', type: 'form', position: { x: 450, y: 700 }, data: { formType: 'Text Input', label: 'What would you like instead?', fields: ['changeOrderDetails'] } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "Got it! I'll create a case for our team to swap your order. Has your current product been used?" } },
              { id: 'opts1', type: 'options', position: { x: 450, y: 1400 }, data: { prompt: 'Has your product been used?', options: [{ label: "Yes, used", icon: 'âœ…' }, { label: "No, unused", icon: 'âŒ' }] } },
              // Used branch - 300px offset left
              { id: 'msg3_used', type: 'message', position: { x: 100, y: 1750 }, data: { persona: 'amy', content: "Since it's been used, we'll send you the new item and give you a <strong>20% refund</strong> as well. You can keep the used one!" } },
              { id: 'case1', type: 'case', position: { x: 100, y: 2100 }, data: { type: 'shipping', subtype: 'order_change_used_20_percent', priority: 'normal', note: 'Order change - product used, 20% refund + new item' } },
              { id: 'end1', type: 'end', position: { x: 100, y: 2450 }, data: { title: 'Order Change + 20% Refund!', showSurvey: true } },
              // Unused branch - 300px offset right
              { id: 'msg3_unused', type: 'message', position: { x: 800, y: 1750 }, data: { persona: 'amy', content: "Great! Once you ship back the item using a carrier of your choice, we'll send out your new order. Just reply to your confirmation email with the tracking number so we can monitor the return. Free of charge!" } },
              { id: 'case2', type: 'case', position: { x: 800, y: 2100 }, data: { type: 'shipping', subtype: 'order_change_return_swap', priority: 'normal', note: 'Order change - product unused, return swap' } },
              { id: 'end2', type: 'end', position: { x: 800, y: 2450 }, data: { title: 'Return Swap Initiated!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'msg3_used', sourceHandle: 'opt-0', label: 'Used', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg3_unused', sourceHandle: 'opt-1', label: 'Unused', animated: true },
              { id: 'e7', source: 'msg3_used', target: 'case1', animated: true },
              { id: 'e8', source: 'msg3_unused', target: 'case2', animated: true },
              { id: 'e9', source: 'case1', target: 'end1', animated: true },
              { id: 'e10', source: 'case2', target: 'end2', animated: true }
            ]
          },

          // CHANGE FREQUENCY - 350px vertical spacing
          change_frequency: {
            id: 'change_frequency',
            parentId: 'manage_subscription',
            name: 'Change Delivery Frequency',
            description: 'Customer wants to adjust delivery frequency - get current, show options, update via API',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Change Frequency' } },
              { id: 'api1', type: 'api', position: { x: 450, y: 350 }, data: { service: 'Shopify', endpoint: '/api/subscriptions/current', description: 'Get current subscription details', response: '{ currentFrequency, nextDelivery }' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 700 }, data: { persona: 'amy', content: "Your current delivery frequency is {{currentFrequency}}. What would you like to change it to?" } },
              { id: 'opts1', type: 'options', position: { x: 450, y: 1050 }, data: { prompt: 'Select new frequency', options: [{ label: 'Every 2 weeks', icon: 'ðŸ“…' }, { label: 'Every month', icon: 'ðŸ“…' }, { label: 'Every 6 weeks', icon: 'ðŸ“…' }, { label: 'Every 2 months', icon: 'ðŸ“…' }] } },
              { id: 'api2', type: 'api', position: { x: 450, y: 1400 }, data: { service: 'Shopify', endpoint: '/api/subscriptions/update-frequency', description: 'Update subscription frequency', request: '{ subscriptionId, newFrequency }', response: '{ success, nextDelivery }' } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 1750 }, data: { persona: 'amy', content: "Perfect! I've updated your delivery frequency. Your next delivery will be on {{nextDelivery}}." } },
              { id: 'end1', type: 'end', position: { x: 450, y: 2100 }, data: { title: 'Frequency Updated!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'api1', animated: true },
              { id: 'e2', source: 'api1', target: 'msg1', animated: true },
              { id: 'e3', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e4', source: 'opts1', target: 'api2', animated: true },
              { id: 'e5', source: 'api2', target: 'msg2', animated: true },
              { id: 'e6', source: 'msg2', target: 'end1', animated: true }
            ]
          },

          // ============================================
          // DETAILED TRACKING SUBFLOWS
          // ============================================
          
          // EXTENDED TRANSIT - 350px vertical spacing
          extended_transit: {
            id: 'extended_transit',
            parentId: 'track_order',
            name: 'Extended Transit (15+ Days)',
            description: 'Package in transit for 15+ days - explanation, then reship or INLINE shipping refund ladder (20%+reship â†’ 30%+reship â†’ 40%+reship â†’ 50%+reship â†’ full)',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Extended Transit Flow' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "I see your package has been in transit for <strong>{{daysInTransit}} days</strong> â€” that's definitely longer than expected, and I completely understand your frustration." } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 700 }, data: { persona: 'amy', content: "There could be a few reasons why this has happened:<br><br><strong>1. International warehouse shipping:</strong> Due to high demand, your order may have shipped from one of our international warehouses instead of a local one. We try to keep all our warehouses stocked, but sometimes items go out of stock locally.<br><br><strong>2. Address issues:</strong> Sometimes there are problems with the delivery address â€” a missing apartment number, incorrect postcode, or the carrier couldn't access the location.<br><br><strong>3. Customs or carrier delays:</strong> Packages can get held up in customs processing or experience unexpected carrier delays along the route." } },
              { id: 'msg3', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "Whatever the reason, {{daysInTransit}} days is too long and we want to make this right for you.<br><br>Here's the thing â€” we don't charge you for shipping, so if we reship your order, we'll likely lose money on both the shipping costs and the product itself. But your satisfaction matters more to us, and we want to make sure you receive your order." } },
              { id: 'msg4', type: 'message', position: { x: 450, y: 1400 }, data: { persona: 'amy', content: "So here's what I can offer you:" } },
              { id: 'opts1', type: 'options', position: { x: 450, y: 1750 }, data: { prompt: 'How would you like to proceed?', options: [{ label: "Reship my order (free)", icon: 'ðŸ“¦' }, { label: "I'd prefer a refund", icon: 'ðŸ’°' }] } },
              // Reship branch - left
              { id: 'subflow_reship', type: 'subflow', position: { x: 50, y: 2100 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8, description: 'Address form â†’ case creation â†’ confirmation' } },
              { id: 'end_reship', type: 'end', position: { x: 50, y: 2450 }, data: { title: 'Reship Requested!', showSurvey: true } },
              
              // ========== INLINE SHIPPING REFUND LADDER (right branch) ==========
              // 20% + reship offer
              { id: 'offer_20', type: 'offer', position: { x: 850, y: 2100 }, data: { percent: 20, label: '20% + Reship', message: "How about a <strong>20% refund ({{refundAmount20}}) PLUS we'll reship your order</strong> free?" } },
              { id: 'opts_20', type: 'options', position: { x: 850, y: 2450 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 20% + reship', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: 550, y: 2800 }, data: { type: 'refund', subtype: 'partial_20_reship', priority: 'normal' } },
              { id: 'subflow_reship_20', type: 'subflow', position: { x: 550, y: 3150 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_20', type: 'end', position: { x: 550, y: 3500 }, data: { title: '20% + Reship!', showSurvey: true } },
              // 30% + reship offer
              { id: 'offer_30', type: 'offer', position: { x: 850, y: 2800 }, data: { percent: 30, label: '30% + Reship', message: "Let me offer you a <strong>30% refund ({{refundAmount30}}) AND a free reship</strong>." } },
              { id: 'opts_30', type: 'options', position: { x: 850, y: 3150 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30% + reship', icon: 'âœ…' }, { label: 'Still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: 550, y: 3500 }, data: { type: 'refund', subtype: 'partial_30_reship', priority: 'normal' } },
              { id: 'subflow_reship_30', type: 'subflow', position: { x: 550, y: 3850 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_30', type: 'end', position: { x: 550, y: 4200 }, data: { title: '30% + Reship!', showSurvey: true } },
              // Manager delay
              { id: 'msg_manager1', type: 'message', position: { x: 850, y: 3500 }, data: { persona: 'amy', content: "Let me check with my manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 850, y: 3850 }, data: { duration: 8000, message: 'Checking with manager...' } },
              // 40% + reship offer
              { id: 'offer_40', type: 'offer', position: { x: 850, y: 4200 }, data: { percent: 40, label: '40% + Reship', message: "My manager approved <strong>40% refund ({{refundAmount40}}) PLUS free reship</strong>." } },
              { id: 'opts_40', type: 'options', position: { x: 850, y: 4550 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40% + reship', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: 550, y: 4900 }, data: { type: 'refund', subtype: 'partial_40_reship', priority: 'normal' } },
              { id: 'subflow_reship_40', type: 'subflow', position: { x: 550, y: 5250 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_40', type: 'end', position: { x: 550, y: 5600 }, data: { title: '40% + Reship!', showSurvey: true } },
              // Manager delay 2
              { id: 'msg_manager2', type: 'message', position: { x: 850, y: 4900 }, data: { persona: 'amy', content: "One more check with my manager..." } },
              { id: 'delay2', type: 'delay', position: { x: 850, y: 5250 }, data: { duration: 8000, message: 'Final check...' } },
              // 50% + reship offer
              { id: 'offer_50', type: 'offer', position: { x: 850, y: 5600 }, data: { percent: 50, label: '50% Maximum + Reship', message: "Our <strong>maximum: 50% refund ({{refundAmount50}}) PLUS free reship</strong>." } },
              { id: 'opts_50', type: 'options', position: { x: 850, y: 5950 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50% + reship', icon: 'âœ…' }, { label: 'Full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: 550, y: 6300 }, data: { type: 'refund', subtype: 'partial_50_reship', priority: 'normal' } },
              { id: 'subflow_reship_50', type: 'subflow', position: { x: 550, y: 6650 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_50', type: 'end', position: { x: 550, y: 7000 }, data: { title: '50% + Reship!', showSurvey: true } },
              // Full refund
              { id: 'msg_full_refund', type: 'message', position: { x: 850, y: 6300 }, data: { persona: 'amy', content: "I'll process a full refund. Expect 3-5 business days." } },
              { id: 'case_full', type: 'case', position: { x: 850, y: 6650 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 850, y: 7000 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'msg3', animated: true },
              { id: 'e4', source: 'msg3', target: 'msg4', animated: true },
              { id: 'e5', source: 'msg4', target: 'opts1', animated: true },
              { id: 'e6', source: 'opts1', target: 'subflow_reship', sourceHandle: 'opt-0', label: 'Reship', animated: true },
              { id: 'e7', source: 'opts1', target: 'offer_20', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              { id: 'e8', source: 'subflow_reship', target: 'end_reship', animated: true },
              // 20% + reship
              { id: 'e9', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e10', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e11', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e12', source: 'case_20', target: 'subflow_reship_20', animated: true },
              { id: 'e13', source: 'subflow_reship_20', target: 'end_20', animated: true },
              // 30% + reship
              { id: 'e14', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e15', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e16', source: 'opts_30', target: 'msg_manager1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e17', source: 'case_30', target: 'subflow_reship_30', animated: true },
              { id: 'e18', source: 'subflow_reship_30', target: 'end_30', animated: true },
              // Manager delay 1
              { id: 'e19', source: 'msg_manager1', target: 'delay1', animated: true },
              { id: 'e20', source: 'delay1', target: 'offer_40', animated: true },
              // 40% + reship
              { id: 'e21', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e22', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e23', source: 'opts_40', target: 'msg_manager2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e24', source: 'case_40', target: 'subflow_reship_40', animated: true },
              { id: 'e25', source: 'subflow_reship_40', target: 'end_40', animated: true },
              // Manager delay 2
              { id: 'e26', source: 'msg_manager2', target: 'delay2', animated: true },
              { id: 'e27', source: 'delay2', target: 'offer_50', animated: true },
              // 50% + reship
              { id: 'e28', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e29', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e30', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e31', source: 'case_50', target: 'subflow_reship_50', animated: true },
              { id: 'e32', source: 'subflow_reship_50', target: 'end_50', animated: true },
              // Full refund
              { id: 'e33', source: 'msg_full_refund', target: 'case_full', animated: true },
              { id: 'e34', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          // DELIVERED NOT RECEIVED - 350px vertical spacing
          delivered_not_received: {
            id: 'delivered_not_received',
            parentId: 'track_order',
            name: 'Delivered But Not Received',
            description: 'Customer says package was marked delivered but they didn\\'t receive it - investigation explanation, then reship or check again',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Delivered Not Received' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "I understand this is frustrating. Let me create a case for our team to investigate with the carrier." } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 700 }, data: { persona: 'amy', content: "We'll contact the carrier and review:<br>â€¢ Security camera footage from delivery day<br>â€¢ Scan records to see when package arrived<br>â€¢ Staff logs and handover records<br>â€¢ The carrier will file a police report as part of their missing package process" } },
              { id: 'msg3', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "Your local police may reach out to you for a statement since you're the intended recipient. This helps if they need to pull CCTV footage or follow up. We want to make this right, so while that's happening, we can reship your order. Would you like us to proceed?" } },
              { id: 'opts1', type: 'options', position: { x: 450, y: 1400 }, data: { prompt: 'What would you like to do?', options: [{ label: "Yes, please investigate and reship", icon: 'âœ…' }, { label: "Actually, let me check again first", icon: 'ðŸ”' }] } },
              // Investigate & reship branch - 300px offset left
              { id: 'subflow_investigation_reship', type: 'subflow', position: { x: 100, y: 1750 }, data: { name: 'Investigation + Reship', slug: 'investigation_reship', nodeCount: 6, description: 'Case creation with investigation + reship' } },
              { id: 'end1', type: 'end', position: { x: 100, y: 2100 }, data: { title: 'Investigation & Reship Initiated', showSurvey: true } },
              // Check again branch - 300px offset right
              { id: 'msg4', type: 'message', position: { x: 800, y: 1750 }, data: { persona: 'amy', content: "No worries at all! Sometimes packages show up in unexpected places. Take your time to have another look and just come back if you still need help." } },
              { id: 'end2', type: 'end', position: { x: 800, y: 2100 }, data: { title: 'Customer Checking', showSurvey: false } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'msg3', animated: true },
              { id: 'e4', source: 'msg3', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'subflow_investigation_reship', sourceHandle: 'opt-0', label: 'Investigate & reship', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg4', sourceHandle: 'opt-1', label: 'Check again', animated: true },
              { id: 'e7', source: 'subflow_investigation_reship', target: 'end1', animated: true },
              { id: 'e8', source: 'msg4', target: 'end2', animated: true }
            ]
          },

          // FAILED ATTEMPT ADDRESS - 350px vertical spacing
          failed_attempt_address: {
            id: 'failed_attempt_address',
            parentId: 'track_order',
            name: 'Failed Attempt - Address Change',
            description: 'Customer needs to change delivery address after failed attempt - carrier contact info provided',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Address Change Flow' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 350 }, data: { persona: 'amy', content: "Since your package is already with {{carrierName}}, you'll need to contact them directly to update the delivery address or arrange a pickup." } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 700 }, data: { persona: 'amy', content: "<strong>{{carrierName}} Contact Information:</strong><br><br>ðŸ“ž Phone: <strong>{{carrierPhone}}</strong><br>ðŸ”— Track Package: <a href=\\"{{carrierUrl}}\\" target=\\"_blank\\">Click here to track on {{carrierName}}</a><br>ðŸ“¦ Tracking #: <strong>{{trackingNumber}}</strong>" } },
              { id: 'msg3', type: 'message', position: { x: 450, y: 1050 }, data: { persona: 'amy', content: "When you call, they can help you:<br>â€¢ Update the delivery address<br>â€¢ Schedule a redelivery<br>â€¢ Arrange a pickup at a local facility" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 690 }, data: { prompt: 'What would you like to do?', options: [{ label: "Thanks, I'll contact them", icon: 'ðŸ“ž' }, { label: "I'd rather get a reship", icon: 'ðŸ“¦' }] } },
              { id: 'end1', type: 'end', position: { x: 150, y: 890 }, data: { title: 'Contacting Carrier', showSurvey: false } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 550, y: 890 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end2', type: 'end', position: { x: 550, y: 1090 }, data: { title: 'Reship Created', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'msg3', animated: true },
              { id: 'e4', source: 'msg3', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'end1', sourceHandle: 'opt-0', label: 'Contact carrier', animated: true },
              { id: 'e6', source: 'opts1', target: 'subflow_reship', sourceHandle: 'opt-1', label: 'Reship', animated: true },
              { id: 'e7', source: 'subflow_reship', target: 'end2', animated: true }
            ]
          },

          // MULTIPLE FAILED ATTEMPTS - 350px vertical spacing
          multiple_failed_attempts: {
            id: 'multiple_failed_attempts',
            parentId: 'track_order',
            name: 'Multiple Failed Delivery Attempts',
            description: 'Multiple failed attempts - address check, then contact carrier, reship, or INLINE shipping refund ladder (20%+reship â†’ 50%+reship â†’ full)',
            nodes: [
              { id: 'start', type: 'start', position: { x: 600, y: 0 }, data: { label: 'Multiple Failed Attempts' } },
              { id: 'msg1', type: 'message', position: { x: 550, y: 350 }, data: { persona: 'amy', content: "I'm really sorry you're dealing with this â€” multiple failed attempts is frustrating. Let me help you figure out the best solution." } },
              { id: 'msg2', type: 'message', position: { x: 550, y: 700 }, data: { persona: 'amy', content: "Is your address correct, or do you need to update it?" } },
              { id: 'opts1', type: 'options', position: { x: 550, y: 1050 }, data: { prompt: 'What would you like to do?', options: [{ label: "My address is correct", icon: 'âœ…' }, { label: "I need to update my address", icon: 'ðŸ“' }] } },
              // Address correct branch - left
              { id: 'msg3', type: 'message', position: { x: 150, y: 1400 }, data: { persona: 'amy', content: "Got it. Since {{carrierName}} has been unable to deliver, here are your options:<br><br><strong>Option 1: Contact {{carrierName}}</strong><br>ðŸ“ž Call {{carrierPhone}} to schedule a specific delivery time or arrange pickup.<br>ðŸ”— <a href=\\"{{carrierUrl}}\\" target=\\"_blank\\">Track your package on {{carrierName}}</a><br><br><strong>Option 2: We reship to a different address</strong><br>If you have an alternate address (work, neighbor, etc.) that might work better." } },
              { id: 'opts2', type: 'options', position: { x: 150, y: 1750 }, data: { prompt: 'What would you like to do?', options: [{ label: "I'll contact the carrier", icon: 'ðŸ“ž' }, { label: "Reship to different address", icon: 'ðŸ“¦' }, { label: "I want a refund instead", icon: 'ðŸ’°' }] } },
              { id: 'end1', type: 'end', position: { x: -200, y: 2100 }, data: { title: 'Contacting Carrier', showSurvey: false } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 150, y: 2100 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end2', type: 'end', position: { x: 150, y: 2450 }, data: { title: 'Reship Created', showSurvey: true } },
              
              // ========== INLINE SHIPPING REFUND LADDER (right of options) ==========
              { id: 'offer_20', type: 'offer', position: { x: 600, y: 2100 }, data: { percent: 20, label: '20% + Reship', message: "How about a <strong>20% refund ({{refundAmount20}}) PLUS we'll reship</strong>?" } },
              { id: 'opts_20', type: 'options', position: { x: 600, y: 2450 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 20% + reship', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: 300, y: 2800 }, data: { type: 'refund', subtype: 'partial_20_reship', priority: 'normal' } },
              { id: 'subflow_reship_20', type: 'subflow', position: { x: 300, y: 3150 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_20', type: 'end', position: { x: 300, y: 3500 }, data: { title: '20% + Reship!', showSurvey: true } },
              // 30% offer
              { id: 'offer_30', type: 'offer', position: { x: 600, y: 2800 }, data: { percent: 30, label: '30% + Reship', message: "<strong>30% refund ({{refundAmount30}}) AND free reship</strong>." } },
              { id: 'opts_30', type: 'options', position: { x: 600, y: 3150 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30% + reship', icon: 'âœ…' }, { label: 'Still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: 300, y: 3500 }, data: { type: 'refund', subtype: 'partial_30_reship', priority: 'normal' } },
              { id: 'subflow_reship_30', type: 'subflow', position: { x: 300, y: 3850 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_30', type: 'end', position: { x: 300, y: 4200 }, data: { title: '30% + Reship!', showSurvey: true } },
              // Manager delay
              { id: 'msg_manager1', type: 'message', position: { x: 600, y: 3500 }, data: { persona: 'amy', content: "Let me check with my manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 600, y: 3850 }, data: { duration: 8000, message: 'Checking with manager...' } },
              // 40% offer
              { id: 'offer_40', type: 'offer', position: { x: 600, y: 4200 }, data: { percent: 40, label: '40% + Reship', message: "My manager approved <strong>40% refund PLUS free reship</strong>." } },
              { id: 'opts_40', type: 'options', position: { x: 600, y: 4550 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40% + reship', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: 300, y: 4900 }, data: { type: 'refund', subtype: 'partial_40_reship', priority: 'normal' } },
              { id: 'subflow_reship_40', type: 'subflow', position: { x: 300, y: 5250 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_40', type: 'end', position: { x: 300, y: 5600 }, data: { title: '40% + Reship!', showSurvey: true } },
              // Manager delay 2
              { id: 'msg_manager2', type: 'message', position: { x: 600, y: 4900 }, data: { persona: 'amy', content: "One more check with my manager..." } },
              { id: 'delay2', type: 'delay', position: { x: 600, y: 5250 }, data: { duration: 8000, message: 'Final check...' } },
              // 50% offer
              { id: 'offer_50', type: 'offer', position: { x: 600, y: 5600 }, data: { percent: 50, label: '50% Maximum + Reship', message: "Our <strong>maximum: 50% refund PLUS free reship</strong>." } },
              { id: 'opts_50', type: 'options', position: { x: 600, y: 5950 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50% + reship', icon: 'âœ…' }, { label: 'Full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: 300, y: 6300 }, data: { type: 'refund', subtype: 'partial_50_reship', priority: 'normal' } },
              { id: 'subflow_reship_50', type: 'subflow', position: { x: 300, y: 6650 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_50', type: 'end', position: { x: 300, y: 7000 }, data: { title: '50% + Reship!', showSurvey: true } },
              // Full refund
              { id: 'msg_full_refund', type: 'message', position: { x: 600, y: 6300 }, data: { persona: 'amy', content: "I'll process a full refund. Expect 3-5 business days." } },
              { id: 'case_full', type: 'case', position: { x: 600, y: 6650 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 600, y: 7000 }, data: { title: 'Full Refund!', showSurvey: true } },
              
              // Address update branch - right
              { id: 'subflow_address_change', type: 'subflow', position: { x: 1000, y: 1400 }, data: { name: 'Failed Attempt - Address Change', slug: 'failed_attempt_address', nodeCount: 6 } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e4', source: 'opts1', target: 'msg3', sourceHandle: 'opt-0', label: 'Address correct', animated: true },
              { id: 'e5', source: 'opts1', target: 'subflow_address_change', sourceHandle: 'opt-1', label: 'Update address', animated: true },
              { id: 'e6', source: 'msg3', target: 'opts2', animated: true },
              { id: 'e7', source: 'opts2', target: 'end1', sourceHandle: 'opt-0', label: 'Contact carrier', animated: true },
              { id: 'e8', source: 'opts2', target: 'subflow_reship', sourceHandle: 'opt-1', label: 'Reship', animated: true },
              { id: 'e9', source: 'opts2', target: 'offer_20', sourceHandle: 'opt-2', label: 'Refund', animated: true },
              { id: 'e10', source: 'subflow_reship', target: 'end2', animated: true },
              // 20% + reship
              { id: 'e11', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e12', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e13', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e14', source: 'case_20', target: 'subflow_reship_20', animated: true },
              { id: 'e15', source: 'subflow_reship_20', target: 'end_20', animated: true },
              // 30% + reship
              { id: 'e16', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e17', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e18', source: 'opts_30', target: 'msg_manager1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e19', source: 'case_30', target: 'subflow_reship_30', animated: true },
              { id: 'e20', source: 'subflow_reship_30', target: 'end_30', animated: true },
              // Manager delay 1
              { id: 'e21', source: 'msg_manager1', target: 'delay1', animated: true },
              { id: 'e22', source: 'delay1', target: 'offer_40', animated: true },
              // 40% + reship
              { id: 'e23', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e24', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e25', source: 'opts_40', target: 'msg_manager2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e26', source: 'case_40', target: 'subflow_reship_40', animated: true },
              { id: 'e27', source: 'subflow_reship_40', target: 'end_40', animated: true },
              // Manager delay 2
              { id: 'e28', source: 'msg_manager2', target: 'delay2', animated: true },
              { id: 'e29', source: 'delay2', target: 'offer_50', animated: true },
              // 50% + reship
              { id: 'e30', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e31', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e32', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e33', source: 'case_50', target: 'subflow_reship_50', animated: true },
              { id: 'e34', source: 'subflow_reship_50', target: 'end_50', animated: true },
              // Full refund
              { id: 'e35', source: 'msg_full_refund', target: 'case_full', animated: true },
              { id: 'e36', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          pickup_not_there: {
            id: 'pickup_not_there',
            parentId: 'track_order',
            name: 'Pickup Location - Package Not There',
            description: 'Customer went to pickup location but package wasn\\'t there - investigation flow',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Pickup Not There' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Just to make sure we're on the same page, the tracking shows your package should be at:<br><br><strong>{{pickupLocationName}}</strong><br><br>Is this where you went?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 330 }, data: { prompt: 'Did you go to the correct location?', options: [{ label: "Yes, that's where I went", icon: 'âœ…' }, { label: "No, I went somewhere else", icon: 'âŒ' }] } },
              { id: 'msg2', type: 'message', position: { x: 150, y: 510 }, data: { persona: 'amy', content: "Got it! Your package is actually at <strong>{{pickupLocationName}}</strong>. Please try picking it up from there and let me know if you still have issues." } },
              { id: 'opts2', type: 'options', position: { x: 150, y: 690 }, data: { prompt: 'What would you like to do?', options: [{ label: "Thanks, I'll go there", icon: 'âœ…' }, { label: "I still need help", icon: 'âš ï¸' }] } },
              { id: 'end1', type: 'end', position: { x: -50, y: 870 }, data: { title: 'Customer Going to Location', showSurvey: false } },
              { id: 'msg3', type: 'message', position: { x: 550, y: 510 }, data: { persona: 'amy', content: "I'm sorry to hear that. Could you share a few details about your pickup attempt? This will help us investigate." } },
              { id: 'form1', type: 'form', position: { x: 550, y: 690 }, data: { formType: 'Pickup Attempt Form', label: 'Pickup Details', fields: ['pickupDate', 'pickupLocation', 'pickupNotes'] } },
              { id: 'msg4', type: 'message', position: { x: 550, y: 870 }, data: { persona: 'amy', content: "Thanks for those details. This is quite rare so we'll need to open a formal investigation. Just so you know, PuppyPad and {{carrierName}} are two separate companies. Our responsibility is to pack your order and hand it off to them safely, which we did. But we always go above and beyond to help when things go wrong on their end." } },
              { id: 'msg5', type: 'message', position: { x: 550, y: 1050 }, data: { persona: 'amy', content: "Here's how the investigation works:<br><br>â€¢ We'll contact {{carrierName}} and {{pickupLocation}} directly<br>â€¢ They'll review the security camera footage from that day<br>â€¢ They'll pull scan records to see when your package arrived and if anyone collected it<br>â€¢ Staff logs and handover records will be checked<br>â€¢ {{carrierName}} will file a police report as part of their missing package process" } },
              { id: 'msg6', type: 'message', position: { x: 550, y: 1230 }, data: { persona: 'amy', content: "Your local police may reach out to you for a statement since you're the intended recipient. This helps if they need to pull CCTV footage or follow up with {{pickupLocation}}. We want to make this right, so while that's happening, we can reship your order. Would you like us to proceed?" } },
              { id: 'opts3', type: 'options', position: { x: 550, y: 1410 }, data: { prompt: 'What would you like to do?', options: [{ label: "Yes, please investigate and reship", icon: 'âœ…' }, { label: "Actually, let me check again first", icon: 'ðŸ”' }] } },
              { id: 'subflow_investigation_reship', type: 'subflow', position: { x: 350, y: 1590 }, data: { name: 'Investigation + Reship', slug: 'investigation_reship', nodeCount: 6 } },
              { id: 'msg7', type: 'message', position: { x: 750, y: 1590 }, data: { persona: 'amy', content: "No worries at all! Sometimes packages show up in unexpected places. Take your time to have another look and just come back if you still need help." } },
              { id: 'end2', type: 'end', position: { x: 350, y: 1790 }, data: { title: 'Investigation Case Created', showSurvey: true } },
              { id: 'end3', type: 'end', position: { x: 750, y: 1790 }, data: { title: 'Customer Checking Again', showSurvey: false } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e3', source: 'opts1', target: 'msg2', sourceHandle: 'opt-1', label: 'Wrong location', animated: true },
              { id: 'e4', source: 'opts1', target: 'msg3', sourceHandle: 'opt-0', label: 'Correct location', animated: true },
              { id: 'e5', source: 'msg2', target: 'opts2', animated: true },
              { id: 'e6', source: 'opts2', target: 'end1', sourceHandle: 'opt-0', label: 'Go there', animated: true },
              { id: 'e7', source: 'opts2', target: 'msg3', sourceHandle: 'opt-1', label: 'Still need help', animated: true },
              { id: 'e8', source: 'msg3', target: 'form1', animated: true },
              { id: 'e9', source: 'form1', target: 'msg4', animated: true },
              { id: 'e10', source: 'msg4', target: 'msg5', animated: true },
              { id: 'e11', source: 'msg5', target: 'msg6', animated: true },
              { id: 'e12', source: 'msg6', target: 'opts3', animated: true },
              { id: 'e13', source: 'opts3', target: 'subflow_investigation_reship', sourceHandle: 'opt-0', label: 'Investigate & reship', animated: true },
              { id: 'e14', source: 'opts3', target: 'msg7', sourceHandle: 'opt-1', label: 'Check again', animated: true },
              { id: 'e15', source: 'subflow_investigation_reship', target: 'end2', animated: true },
              { id: 'e16', source: 'msg7', target: 'end3', animated: true }
            ]
          },

          exception_investigation: {
            id: 'exception_investigation',
            parentId: 'track_order',
            name: 'Exception/Expired Tracking Investigation',
            description: 'Tracking shows exception - investigate and resolve, or INLINE shipping refund ladder (20%+reshipâ†’50%+reshipâ†’full)',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Exception Investigation' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 350 }, data: { persona: 'amy', content: "I see there's an issue with your package delivery. Let me help you figure out what's going on." } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 700 }, data: { persona: 'amy', content: "I'll create a case for our team to investigate. They'll check what happened within 1-2 business days." } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 1050 }, data: { prompt: 'What would you like to do?', options: [{ label: "Investigate and reship", icon: 'ðŸ”' }, { label: "I'd prefer a refund", icon: 'ðŸ’°' }] } },
              // Investigate + reship branch - left
              { id: 'case1', type: 'case', position: { x: 50, y: 1400 }, data: { type: 'shipping', subtype: 'exception_investigation', priority: 'normal' } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 50, y: 1750 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end1', type: 'end', position: { x: 50, y: 2100 }, data: { title: 'Case Created & Reship', showSurvey: true } },
              
              // ========== INLINE SHIPPING REFUND LADDER (right branch) ==========
              { id: 'offer_20', type: 'offer', position: { x: 650, y: 1400 }, data: { percent: 20, label: '20% + Reship', message: "<strong>20% refund PLUS free reship</strong>" } },
              { id: 'opts_20', type: 'options', position: { x: 650, y: 1750 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 20% + reship', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_20', type: 'case', position: { x: 350, y: 2100 }, data: { type: 'refund', subtype: 'partial_20_reship', priority: 'normal' } },
              { id: 'subflow_reship_20', type: 'subflow', position: { x: 350, y: 2450 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_20', type: 'end', position: { x: 350, y: 2800 }, data: { title: '20% + Reship!', showSurvey: true } },
              { id: 'offer_30', type: 'offer', position: { x: 650, y: 2100 }, data: { percent: 30, label: '30% + Reship', message: "<strong>30% refund + free reship</strong>" } },
              { id: 'opts_30', type: 'options', position: { x: 650, y: 2450 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_30', type: 'case', position: { x: 350, y: 2800 }, data: { type: 'refund', subtype: 'partial_30_reship', priority: 'normal' } },
              { id: 'subflow_reship_30', type: 'subflow', position: { x: 350, y: 3150 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_30', type: 'end', position: { x: 350, y: 3500 }, data: { title: '30% + Reship!', showSurvey: true } },
              { id: 'msg_mgr1', type: 'message', position: { x: 650, y: 2800 }, data: { persona: 'amy', content: "Checking with manager..." } },
              { id: 'delay1', type: 'delay', position: { x: 650, y: 3150 }, data: { duration: 8000, message: 'Manager check...' } },
              { id: 'offer_40', type: 'offer', position: { x: 650, y: 3500 }, data: { percent: 40, label: '40% + Reship', message: "<strong>40% refund + free reship</strong>" } },
              { id: 'opts_40', type: 'options', position: { x: 650, y: 3850 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40%', icon: 'âœ…' }, { label: 'Need more', icon: 'ðŸ’°' }] } },
              { id: 'case_40', type: 'case', position: { x: 350, y: 4200 }, data: { type: 'refund', subtype: 'partial_40_reship', priority: 'normal' } },
              { id: 'subflow_reship_40', type: 'subflow', position: { x: 350, y: 4550 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_40', type: 'end', position: { x: 350, y: 4900 }, data: { title: '40% + Reship!', showSurvey: true } },
              { id: 'msg_mgr2', type: 'message', position: { x: 650, y: 4200 }, data: { persona: 'amy', content: "Final manager check..." } },
              { id: 'delay2', type: 'delay', position: { x: 650, y: 4550 }, data: { duration: 8000, message: 'Final check...' } },
              { id: 'offer_50', type: 'offer', position: { x: 650, y: 4900 }, data: { percent: 50, label: '50% Maximum + Reship', message: "<strong>Maximum 50% + free reship</strong>" } },
              { id: 'opts_50', type: 'options', position: { x: 650, y: 5250 }, data: { prompt: 'Best offer', options: [{ label: 'Accept 50%', icon: 'âœ…' }, { label: 'Full refund', icon: 'ðŸ’°' }] } },
              { id: 'case_50', type: 'case', position: { x: 350, y: 5600 }, data: { type: 'refund', subtype: 'partial_50_reship', priority: 'normal' } },
              { id: 'subflow_reship_50', type: 'subflow', position: { x: 350, y: 5950 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_50', type: 'end', position: { x: 350, y: 6300 }, data: { title: '50% + Reship!', showSurvey: true } },
              { id: 'msg_full', type: 'message', position: { x: 650, y: 5600 }, data: { persona: 'amy', content: "Full refund processing..." } },
              { id: 'case_full', type: 'case', position: { x: 650, y: 5950 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end_full', type: 'end', position: { x: 650, y: 6300 }, data: { title: 'Full Refund!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e4', source: 'opts1', target: 'case1', sourceHandle: 'opt-0', label: 'Investigate & reship', animated: true },
              { id: 'e5', source: 'opts1', target: 'offer_20', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              { id: 'e6', source: 'case1', target: 'subflow_reship', animated: true },
              { id: 'e7', source: 'subflow_reship', target: 'end1', animated: true },
              // 20% + reship
              { id: 'e8', source: 'offer_20', target: 'opts_20', animated: true },
              { id: 'e9', source: 'opts_20', target: 'case_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e10', source: 'opts_20', target: 'offer_30', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e11', source: 'case_20', target: 'subflow_reship_20', animated: true },
              { id: 'e12', source: 'subflow_reship_20', target: 'end_20', animated: true },
              // 30% + reship
              { id: 'e13', source: 'offer_30', target: 'opts_30', animated: true },
              { id: 'e14', source: 'opts_30', target: 'case_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e15', source: 'opts_30', target: 'msg_mgr1', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e16', source: 'case_30', target: 'subflow_reship_30', animated: true },
              { id: 'e17', source: 'subflow_reship_30', target: 'end_30', animated: true },
              // Manager delay 1
              { id: 'e18', source: 'msg_mgr1', target: 'delay1', animated: true },
              { id: 'e19', source: 'delay1', target: 'offer_40', animated: true },
              // 40% + reship
              { id: 'e20', source: 'offer_40', target: 'opts_40', animated: true },
              { id: 'e21', source: 'opts_40', target: 'case_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e22', source: 'opts_40', target: 'msg_mgr2', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e23', source: 'case_40', target: 'subflow_reship_40', animated: true },
              { id: 'e24', source: 'subflow_reship_40', target: 'end_40', animated: true },
              // Manager delay 2
              { id: 'e25', source: 'msg_mgr2', target: 'delay2', animated: true },
              { id: 'e26', source: 'delay2', target: 'offer_50', animated: true },
              // 50% + reship
              { id: 'e27', source: 'offer_50', target: 'opts_50', animated: true },
              { id: 'e28', source: 'opts_50', target: 'case_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e29', source: 'opts_50', target: 'msg_full', sourceHandle: 'opt-1', label: 'Decline', animated: true },
              { id: 'e30', source: 'case_50', target: 'subflow_reship_50', animated: true },
              { id: 'e31', source: 'subflow_reship_50', target: 'end_50', animated: true },
              // Full refund
              { id: 'e32', source: 'msg_full', target: 'case_full', animated: true },
              { id: 'e33', source: 'case_full', target: 'end_full', animated: true }
            ]
          },

          reship_flow: {
            id: 'reship_flow',
            parentId: 'track_order',
            name: 'Reship Flow',
            description: 'Create free reship with address confirmation',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Reship Flow' } },
              { id: 'cond1', type: 'condition', position: { x: 350, y: 150 }, data: { variable: 'address.address1', operator: 'exists', value: 'true', yesLabel: 'Has address', noLabel: 'No address' } },
              { id: 'msg1', type: 'message', position: { x: 150, y: 330 }, data: { persona: 'amy', content: "I'll create a free reship for you! First, let me confirm your shipping address:<br><br><div class=\\"address-display\\">{{formattedAddress}}</div>" } },
              { id: 'msg2', type: 'message', position: { x: 550, y: 330 }, data: { persona: 'amy', content: "I'll create a free reship for you! Please provide your shipping address:" } },
              { id: 'msg3', type: 'message', position: { x: 150, y: 510 }, data: { persona: 'amy', content: "Is this address correct, or would you like to update it?" } },
              { id: 'opts1', type: 'options', position: { x: 150, y: 690 }, data: { prompt: 'Is the address correct?', options: [{ label: "This address is correct", icon: 'âœ…' }, { label: "I need to update it", icon: 'âœï¸' }] } },
              { id: 'form1', type: 'form', position: { x: 550, y: 510 }, data: { formType: 'Address Form', label: 'Shipping Address', fields: ['address1', 'address2', 'city', 'province', 'zip', 'country'] } },
              { id: 'form2', type: 'form', position: { x: 350, y: 870 }, data: { formType: 'Address Form', label: 'Update Address', fields: ['address1', 'address2', 'city', 'province', 'zip', 'country'] } },
              { id: 'api1', type: 'api', position: { x: 150, y: 870 }, data: { service: 'Shopify', endpoint: '/api/reship', description: 'Create reshipment with confirmed address', request: '{ orderId, address }', response: '{ reshipmentId, trackingNumber }' } },
              { id: 'msg4', type: 'message', position: { x: 150, y: 1050 }, data: { persona: 'amy', content: "Perfect! I've created a free reship for you. You'll receive tracking information via email once it ships." } },
              { id: 'end1', type: 'end', position: { x: 150, y: 1230 }, data: { title: 'Reship Created!', showSurvey: true } },
              { id: 'api2', type: 'api', position: { x: 550, y: 690 }, data: { service: 'Shopify', endpoint: '/api/reship', description: 'Create reshipment with new address', request: '{ orderId, address }', response: '{ reshipmentId, trackingNumber }' } },
              { id: 'api3', type: 'api', position: { x: 350, y: 1050 }, data: { service: 'Shopify', endpoint: '/api/reship', description: 'Create reshipment with updated address', request: '{ orderId, address }', response: '{ reshipmentId, trackingNumber }' } },
              { id: 'end2', type: 'end', position: { x: 550, y: 870 }, data: { title: 'Reship Created!', showSurvey: true } },
              { id: 'end3', type: 'end', position: { x: 350, y: 1230 }, data: { title: 'Reship Created!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'cond1', animated: true },
              { id: 'e2', source: 'cond1', target: 'msg1', sourceHandle: 'yes', label: 'Has address', animated: true },
              { id: 'e3', source: 'cond1', target: 'msg2', sourceHandle: 'no', label: 'No address', animated: true },
              { id: 'e4', source: 'msg1', target: 'msg3', animated: true },
              { id: 'e5', source: 'msg3', target: 'opts1', animated: true },
              { id: 'e6', source: 'opts1', target: 'api1', sourceHandle: 'opt-0', label: 'Correct', animated: true },
              { id: 'e7', source: 'opts1', target: 'form2', sourceHandle: 'opt-1', label: 'Update', animated: true },
              { id: 'e8', source: 'msg2', target: 'form1', animated: true },
              { id: 'e9', source: 'form1', target: 'api2', animated: true },
              { id: 'e10', source: 'form2', target: 'api3', animated: true },
              { id: 'e11', source: 'api1', target: 'msg4', animated: true },
              { id: 'e12', source: 'api2', target: 'msg4', animated: true },
              { id: 'e13', source: 'api3', target: 'msg4', animated: true },
              { id: 'e14', source: 'msg4', target: 'end1', animated: true },
              { id: 'e15', source: 'msg4', target: 'end2', animated: true },
              { id: 'e16', source: 'msg4', target: 'end3', animated: true }
            ]
          },

          investigation_reship: {
            id: 'investigation_reship',
            parentId: 'track_order',
            name: 'Investigation + Reship',
            description: 'Open investigation case and reship order simultaneously',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Investigation + Reship' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Okay, I'll get that started for you. Our team will open the investigation with the carrier and we'll reship your order in the meantime." } },
              { id: 'case1', type: 'case', position: { x: 350, y: 330 }, data: { type: 'shipping', subtype: 'pickup_investigation', priority: 'high', note: 'Package not at pickup location - investigation opened' } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 350, y: 510 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 690 }, data: { persona: 'amy', content: "I've created both the investigation case and your reshipment. You'll receive tracking for the new shipment via email, and we'll keep you updated on the investigation." } },
              { id: 'end1', type: 'end', position: { x: 350, y: 870 }, data: { title: 'Investigation & Reship Complete', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'case1', animated: true },
              { id: 'e3', source: 'case1', target: 'subflow_reship', animated: true },
              { id: 'e4', source: 'subflow_reship', target: 'msg2', animated: true },
              { id: 'e5', source: 'msg2', target: 'end1', animated: true }
            ]
          },

          // SHIPPING REFUND LADDER - 350px vertical spacing, includes reship at each step
          shipping_refund_ladder: {
            id: 'shipping_refund_ladder',
            parentId: 'track_order',
            name: 'Shipping Refund Ladder',
            description: 'Progressive refund offers for shipping issues: 20% + reship â†’ 30% + reship â†’ (manager delay) â†’ 40% + reship â†’ (manager delay) â†’ 50% + reship â†’ full refund',
            nodes: [
              // Entry
              { id: 'start', type: 'start', position: { x: 600, y: 0 }, data: { label: 'Shipping Refund Ladder' } },
              
              // STEP 1: 20% + reship offer
              { id: 'offer1_20', type: 'offer', position: { x: 200, y: 350 }, data: { percent: 20, label: 'Keep product & reship', message: "I'd love to make this right for you. How about a <strong>20% refund ({{refundAmount20}}) PLUS we'll reship your order</strong> free of charge? That way you get some money back AND your products!", needsManagerApproval: false } },
              { id: 'opts_20', type: 'options', position: { x: 200, y: 700 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 20% + reship', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_accept_20', type: 'case', position: { x: -150, y: 1050 }, data: { type: 'refund', subtype: 'partial_20_reship', priority: 'normal', note: '20% refund + reship' } },
              { id: 'subflow_reship_20', type: 'subflow', position: { x: -150, y: 1400 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_accept_20', type: 'end', position: { x: -150, y: 1750 }, data: { title: '20% Refund + Reship!', showSurvey: true } },
              
              // STEP 2: 30% + reship offer
              { id: 'offer2_30', type: 'offer', position: { x: 200, y: 1050 }, data: { percent: 30, label: 'Keep product & reship', message: "I really want to help you here. Let me offer you a <strong>30% refund ({{refundAmount30}}) AND a free reship</strong>. You'll get a good chunk of money back plus we'll send out a new shipment right away.", needsManagerApproval: false } },
              { id: 'opts_30', type: 'options', position: { x: 200, y: 1400 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30% + reship', icon: 'âœ…' }, { label: 'I still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_accept_30', type: 'case', position: { x: -150, y: 1750 }, data: { type: 'refund', subtype: 'partial_30_reship', priority: 'normal', note: '30% refund + reship' } },
              { id: 'subflow_reship_30', type: 'subflow', position: { x: -150, y: 2100 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_accept_30', type: 'end', position: { x: -150, y: 2450 }, data: { title: '30% Refund + Reship!', showSurvey: true } },
              
              // Manager delay 1 (before 40%)
              { id: 'msg_manager_check1', type: 'message', position: { x: 200, y: 1750 }, data: { persona: 'amy', content: "Let me check with my manager to see if there's anything more I can do for you..." } },
              { id: 'delay1', type: 'delay', position: { x: 200, y: 2100 }, data: { duration: 8000, message: 'Checking with manager...' } },
              
              // STEP 3: 40% + reship offer (requires manager)
              { id: 'offer3_40', type: 'offer', position: { x: 200, y: 2450 }, data: { percent: 40, label: 'Manager approved + reship', message: "Great news! My manager has approved a <strong>40% refund ({{refundAmount40}}) PLUS a free reship</strong> for you. This is a significant discount and we really want to make sure you're happy.", needsManagerApproval: true } },
              { id: 'opts_40', type: 'options', position: { x: 200, y: 2800 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40% + reship', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_accept_40', type: 'case', position: { x: -150, y: 3150 }, data: { type: 'refund', subtype: 'partial_40_reship', priority: 'normal', note: '40% refund + reship (manager approved)' } },
              { id: 'subflow_reship_40', type: 'subflow', position: { x: -150, y: 3500 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_accept_40', type: 'end', position: { x: -150, y: 3850 }, data: { title: '40% Refund + Reship!', showSurvey: true } },
              
              // Manager delay 2 (before 50%)
              { id: 'msg_manager_check2', type: 'message', position: { x: 200, y: 3150 }, data: { persona: 'amy', content: "Let me speak with my manager one more time..." } },
              { id: 'delay2', type: 'delay', position: { x: 200, y: 3500 }, data: { duration: 8000, message: 'Final manager check...' } },
              
              // STEP 4: 50% + reship offer (final offer)
              { id: 'offer4_50', type: 'offer', position: { x: 200, y: 3850 }, data: { percent: 50, label: 'Maximum offer + reship', message: "Okay, I've just spoken with my manager again and they've approved our <strong>maximum offer: 50% refund ({{refundAmount50}}) PLUS a free reship</strong>. This is the very best we can do â€” you'll get half your money back and still receive your products.", needsManagerApproval: true, isFinal: true } },
              { id: 'opts_50', type: 'options', position: { x: 200, y: 4200 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50% + reship', icon: 'âœ…' }, { label: 'I want a full refund only', icon: 'ðŸ’°' }] } },
              { id: 'case_accept_50', type: 'case', position: { x: -150, y: 4550 }, data: { type: 'refund', subtype: 'partial_50_reship', priority: 'normal', note: '50% refund + reship (max offer)' } },
              { id: 'subflow_reship_50', type: 'subflow', position: { x: -150, y: 4900 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end_accept_50', type: 'end', position: { x: -150, y: 5250 }, data: { title: '50% Refund + Reship!', showSurvey: true } },
              
              // STEP 5: Full refund (if all declined)
              { id: 'msg_full_refund', type: 'message', position: { x: 200, y: 4550 }, data: { persona: 'amy', content: "I understand. I'll process a full refund for you. The refund will appear in your account within 3-5 business days." } },
              { id: 'case_full_refund', type: 'case', position: { x: 200, y: 4900 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal', note: 'Full refund processed after declining all partial + reship offers' } },
              { id: 'end_full_refund', type: 'end', position: { x: 200, y: 5250 }, data: { title: 'Full Refund Processed!', showSurvey: true } }
            ],
            edges: [
              // Entry
              { id: 'e1', source: 'start', target: 'offer1_20', animated: true },
              
              // 20% offer
              { id: 'e2', source: 'offer1_20', target: 'opts_20', animated: true },
              { id: 'e3', source: 'opts_20', target: 'case_accept_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e4', source: 'opts_20', target: 'offer2_30', sourceHandle: 'opt-1', label: 'Decline 20%', animated: true },
              { id: 'e5', source: 'case_accept_20', target: 'subflow_reship_20', animated: true },
              { id: 'e6', source: 'subflow_reship_20', target: 'end_accept_20', animated: true },
              
              // 30% offer
              { id: 'e7', source: 'offer2_30', target: 'opts_30', animated: true },
              { id: 'e8', source: 'opts_30', target: 'case_accept_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e9', source: 'opts_30', target: 'msg_manager_check1', sourceHandle: 'opt-1', label: 'Decline 30%', animated: true },
              { id: 'e10', source: 'case_accept_30', target: 'subflow_reship_30', animated: true },
              { id: 'e11', source: 'subflow_reship_30', target: 'end_accept_30', animated: true },
              
              // Manager delay 1
              { id: 'e12', source: 'msg_manager_check1', target: 'delay1', animated: true },
              { id: 'e13', source: 'delay1', target: 'offer3_40', animated: true },
              
              // 40% offer
              { id: 'e14', source: 'offer3_40', target: 'opts_40', animated: true },
              { id: 'e15', source: 'opts_40', target: 'case_accept_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e16', source: 'opts_40', target: 'msg_manager_check2', sourceHandle: 'opt-1', label: 'Decline 40%', animated: true },
              { id: 'e17', source: 'case_accept_40', target: 'subflow_reship_40', animated: true },
              { id: 'e18', source: 'subflow_reship_40', target: 'end_accept_40', animated: true },
              
              // Manager delay 2
              { id: 'e19', source: 'msg_manager_check2', target: 'delay2', animated: true },
              { id: 'e20', source: 'delay2', target: 'offer4_50', animated: true },
              
              // 50% offer
              { id: 'e21', source: 'offer4_50', target: 'opts_50', animated: true },
              { id: 'e22', source: 'opts_50', target: 'case_accept_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e23', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline 50%', animated: true },
              { id: 'e24', source: 'case_accept_50', target: 'subflow_reship_50', animated: true },
              { id: 'e25', source: 'subflow_reship_50', target: 'end_accept_50', animated: true },
              
              // Full refund
              { id: 'e26', source: 'msg_full_refund', target: 'case_full_refund', animated: true },
              { id: 'e27', source: 'case_full_refund', target: 'end_full_refund', animated: true }
            ]
          },

          // ORDER REFUND LADDER - 350px vertical spacing, fully expanded with individual offer nodes
          order_refund_ladder: {
            id: 'order_refund_ladder',
            parentId: 'help_with_order',
            name: 'Order Refund Ladder',
            description: 'Progressive refund offers: 90-day guarantee check â†’ 20% â†’ 30% â†’ (manager delay) â†’ 40% â†’ (manager delay) â†’ 50% â†’ full refund. Each step has accept/decline.',
            nodes: [
              // Entry and guarantee check
              { id: 'start', type: 'start', position: { x: 600, y: 0 }, data: { label: 'Order Refund Ladder' } },
              { id: 'cond_guarantee', type: 'condition', position: { x: 600, y: 350 }, data: { variable: 'guarantee.eligible', operator: '===', value: 'true', yesLabel: 'Within 90 days', noLabel: 'Expired' } },
              
              // Guarantee expired branch - right side
              { id: 'msg_guarantee_expired', type: 'message', position: { x: 1100, y: 700 }, data: { persona: 'amy', content: "I really wish I could help with a refund, but I need to be upfront with you. ðŸ’”<br><br>The 90-day guarantee period has expired for this order. However, I still want to help. Let me create a case for our team to review." } },
              { id: 'case_guarantee_expired', type: 'case', position: { x: 1100, y: 1050 }, data: { type: 'refund', subtype: 'guarantee_expired', priority: 'normal', note: 'Guarantee expired - team review required' } },
              { id: 'end_guarantee_expired', type: 'end', position: { x: 1100, y: 1400 }, data: { title: 'Case Created for Review', showSurvey: true } },
              
              // STEP 1: 20% offer - left side (main ladder)
              { id: 'offer1_20', type: 'offer', position: { x: 200, y: 700 }, data: { percent: 20, label: 'Keep product & continue trying', message: "I understand. As a valued customer, I'd like to offer you a <strong>20% partial refund ({{refundAmount20}})</strong> while you keep the product and continue trying.", needsManagerApproval: false } },
              { id: 'opts_20', type: 'options', position: { x: 200, y: 1050 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 20% refund', icon: 'âœ…' }, { label: 'I need more', icon: 'ðŸ’°' }] } },
              { id: 'case_accept_20', type: 'case', position: { x: -150, y: 1400 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal', note: '20% partial refund accepted' } },
              { id: 'end_accept_20', type: 'end', position: { x: -150, y: 1750 }, data: { title: '20% Refund Processed!', showSurvey: true } },
              
              // STEP 2: 30% offer
              { id: 'offer2_30', type: 'offer', position: { x: 200, y: 1400 }, data: { percent: 30, label: 'Keep product', message: "I really want to make this right. Let me offer you a <strong>30% refund ({{refundAmount30}})</strong> â€” that's a significant amount back while you keep everything.", needsManagerApproval: false } },
              { id: 'opts_30', type: 'options', position: { x: 200, y: 1750 }, data: { prompt: 'What do you think?', options: [{ label: 'Accept 30% refund', icon: 'âœ…' }, { label: 'I still need more', icon: 'ðŸ’°' }] } },
              { id: 'case_accept_30', type: 'case', position: { x: -150, y: 2100 }, data: { type: 'refund', subtype: 'partial_30', priority: 'normal', note: '30% partial refund accepted' } },
              { id: 'end_accept_30', type: 'end', position: { x: -150, y: 2450 }, data: { title: '30% Refund Processed!', showSurvey: true } },
              
              // Manager delay 1 (before 40%)
              { id: 'msg_manager_check1', type: 'message', position: { x: 200, y: 2100 }, data: { persona: 'amy', content: "Let me check with my manager to see if there's anything more I can do for you..." } },
              { id: 'delay1', type: 'delay', position: { x: 200, y: 2450 }, data: { duration: 8000, message: 'Checking with manager...' } },
              
              // STEP 3: 40% offer (requires manager)
              { id: 'offer3_40', type: 'offer', position: { x: 200, y: 2800 }, data: { percent: 40, label: 'Manager approved', message: "Great news! My manager has approved a <strong>40% refund ({{refundAmount40}})</strong> for you. That's nearly half your money back and you still get to keep the products.", needsManagerApproval: true } },
              { id: 'opts_40', type: 'options', position: { x: 200, y: 3150 }, data: { prompt: 'How does that sound?', options: [{ label: 'Accept 40% refund', icon: 'âœ…' }, { label: 'I really need more', icon: 'ðŸ’°' }] } },
              { id: 'case_accept_40', type: 'case', position: { x: -150, y: 3500 }, data: { type: 'refund', subtype: 'partial_40', priority: 'normal', note: '40% partial refund accepted (manager approved)' } },
              { id: 'end_accept_40', type: 'end', position: { x: -150, y: 3850 }, data: { title: '40% Refund Processed!', showSurvey: true } },
              
              // Manager delay 2 (before 50%)
              { id: 'msg_manager_check2', type: 'message', position: { x: 200, y: 3500 }, data: { persona: 'amy', content: "Let me speak with my manager one more time..." } },
              { id: 'delay2', type: 'delay', position: { x: 200, y: 3850 }, data: { duration: 8000, message: 'Final manager check...' } },
              
              // STEP 4: 50% offer (final offer)
              { id: 'offer4_50', type: 'offer', position: { x: 200, y: 4200 }, data: { percent: 50, label: 'Maximum offer', message: "Okay, I've just spoken with my manager again and they've approved our <strong>maximum offer: 50% refund ({{refundAmount50}})</strong>. This is the very best we can do â€” half your money back, no return needed.", needsManagerApproval: true, isFinal: true } },
              { id: 'opts_50', type: 'options', position: { x: 200, y: 4550 }, data: { prompt: 'This is our best offer', options: [{ label: 'Accept 50% refund', icon: 'âœ…' }, { label: 'I want a full refund', icon: 'ðŸ’°' }] } },
              { id: 'case_accept_50', type: 'case', position: { x: -150, y: 4900 }, data: { type: 'refund', subtype: 'partial_50', priority: 'normal', note: '50% partial refund accepted (max offer)' } },
              { id: 'end_accept_50', type: 'end', position: { x: -150, y: 5250 }, data: { title: '50% Refund Processed!', showSurvey: true } },
              
              // STEP 5: Full refund (if all declined)
              { id: 'msg_full_refund', type: 'message', position: { x: 200, y: 4900 }, data: { persona: 'amy', content: "I understand. I'll process a full refund for you. The refund will appear in your account within 3-5 business days." } },
              { id: 'case_full_refund', type: 'case', position: { x: 200, y: 5250 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal', note: 'Full refund processed after declining all partial offers' } },
              { id: 'end_full_refund', type: 'end', position: { x: 200, y: 5600 }, data: { title: 'Full Refund Processed!', showSurvey: true } }
            ],
            edges: [
              // Entry
              { id: 'e1', source: 'start', target: 'cond_guarantee', animated: true },
              { id: 'e2', source: 'cond_guarantee', target: 'offer1_20', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e3', source: 'cond_guarantee', target: 'msg_guarantee_expired', sourceHandle: 'no', label: 'Expired', animated: true },
              
              // Expired branch
              { id: 'e4', source: 'msg_guarantee_expired', target: 'case_guarantee_expired', animated: true },
              { id: 'e5', source: 'case_guarantee_expired', target: 'end_guarantee_expired', animated: true },
              
              // 20% offer
              { id: 'e6', source: 'offer1_20', target: 'opts_20', animated: true },
              { id: 'e7', source: 'opts_20', target: 'case_accept_20', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e8', source: 'opts_20', target: 'offer2_30', sourceHandle: 'opt-1', label: 'Decline 20%', animated: true },
              { id: 'e9', source: 'case_accept_20', target: 'end_accept_20', animated: true },
              
              // 30% offer
              { id: 'e10', source: 'offer2_30', target: 'opts_30', animated: true },
              { id: 'e11', source: 'opts_30', target: 'case_accept_30', sourceHandle: 'opt-0', label: 'Accept 30%', animated: true },
              { id: 'e12', source: 'opts_30', target: 'msg_manager_check1', sourceHandle: 'opt-1', label: 'Decline 30%', animated: true },
              { id: 'e13', source: 'case_accept_30', target: 'end_accept_30', animated: true },
              
              // Manager delay 1
              { id: 'e14', source: 'msg_manager_check1', target: 'delay1', animated: true },
              { id: 'e15', source: 'delay1', target: 'offer3_40', animated: true },
              
              // 40% offer
              { id: 'e16', source: 'offer3_40', target: 'opts_40', animated: true },
              { id: 'e17', source: 'opts_40', target: 'case_accept_40', sourceHandle: 'opt-0', label: 'Accept 40%', animated: true },
              { id: 'e18', source: 'opts_40', target: 'msg_manager_check2', sourceHandle: 'opt-1', label: 'Decline 40%', animated: true },
              { id: 'e19', source: 'case_accept_40', target: 'end_accept_40', animated: true },
              
              // Manager delay 2
              { id: 'e20', source: 'msg_manager_check2', target: 'delay2', animated: true },
              { id: 'e21', source: 'delay2', target: 'offer4_50', animated: true },
              
              // 50% offer
              { id: 'e22', source: 'offer4_50', target: 'opts_50', animated: true },
              { id: 'e23', source: 'opts_50', target: 'case_accept_50', sourceHandle: 'opt-0', label: 'Accept 50%', animated: true },
              { id: 'e24', source: 'opts_50', target: 'msg_full_refund', sourceHandle: 'opt-1', label: 'Decline 50%', animated: true },
              { id: 'e25', source: 'case_accept_50', target: 'end_accept_50', animated: true },
              
              // Full refund
              { id: 'e26', source: 'msg_full_refund', target: 'case_full_refund', animated: true },
              { id: 'e27', source: 'case_full_refund', target: 'end_full_refund', animated: true }
            ]
          },

          // EXISTING CASE CHECK - Deduplication Flow
          existing_case_check: {
            id: 'existing_case_check',
            parentId: 'help_with_order',
            name: 'Existing Case Check',
            description: 'Check for existing open case to prevent duplicates',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Existing Case Check' } },
              { id: 'api_check_case', type: 'api', position: { x: 350, y: 150 }, data: { service: 'Backend', endpoint: '/api/check-case', description: 'Check for existing open case (deduplication)', request: '{ orderNumber, email }', response: '{ existingCase: boolean, caseId?, caseUrl? }' } },
              { id: 'cond_existing_case', type: 'condition', position: { x: 350, y: 330 }, data: { variable: 'existingCase.existingCase', operator: '===', value: 'true', yesLabel: 'Case exists', noLabel: 'No case' } },
              { id: 'msg_existing_case', type: 'message', position: { x: 150, y: 510 }, data: { persona: 'amy', content: "I see you already have an open case for this order! You can view it in the Resolution Hub: <a href=\\"{{caseUrl}}\\" target=\\"_blank\\">View Case {{caseId}}</a><br><br>Is there something else I can help you with?" } },
              { id: 'end_existing_case', type: 'end', position: { x: 150, y: 690 }, data: { title: 'Existing Case Found', showSurvey: false } },
              { id: 'end_no_case', type: 'end', position: { x: 550, y: 510 }, data: { title: 'No Existing Case', showSurvey: false } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'api_check_case', animated: true },
              { id: 'e2', source: 'api_check_case', target: 'cond_existing_case', animated: true },
              { id: 'e3', source: 'cond_existing_case', target: 'msg_existing_case', sourceHandle: 'yes', label: 'Case exists', animated: true },
              { id: 'e4', source: 'cond_existing_case', target: 'end_no_case', sourceHandle: 'no', label: 'No case', animated: true },
              { id: 'e5', source: 'msg_existing_case', target: 'end_existing_case', animated: true }
            ]
          },

          // UNFULFILLED ORDER HANDLING - 10-hour window flow
          unfulfilled_order_handling: {
            id: 'unfulfilled_order_handling',
            parentId: 'help_with_order',
            name: 'Unfulfilled Order Handling',
            description: 'Handle unfulfilled orders within 10-hour window',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Unfulfilled Order Check' } },
              { id: 'cond_can_modify', type: 'condition', position: { x: 350, y: 150 }, data: { variable: 'selectedOrder.canModify', operator: '===', value: 'true', yesLabel: 'Unfulfilled (<10h)', noLabel: 'Fulfilled or >10h' } },
              { id: 'msg_unfulfilled', type: 'message', position: { x: 150, y: 330 }, data: { persona: 'amy', content: "Great news! Your order hasn't shipped yet, so I can still make changes. Would you like to change or cancel your order?" } },
              { id: 'opts_unfulfilled', type: 'options', position: { x: 150, y: 510 }, data: { prompt: 'What would you like to do?', options: [{ label: "Change my order", icon: 'ðŸ”„' }, { label: "Cancel my order", icon: 'âŒ' }, { label: "Actually, keep it as is", icon: 'âœ…' }] } },
              { id: 'subflow_change_order', type: 'subflow', position: { x: -50, y: 690 }, data: { name: 'Change Order', slug: 'change_order', nodeCount: 8 } },
              { id: 'msg_cancel_reason', type: 'message', position: { x: 250, y: 690 }, data: { persona: 'amy', content: "I'll help you cancel. Can you tell me why you'd like to cancel?" } },
              { id: 'opts_cancel_intent', type: 'options', position: { x: 250, y: 870 }, data: { prompt: 'Why would you like to cancel?', options: [{ label: "My dog isn't using it", icon: 'ðŸ•' }, { label: 'I changed my mind', icon: 'ðŸ’­' }, { label: "It didn't meet expectations", icon: 'ðŸ˜•' }, { label: 'Ordered by mistake', icon: 'ðŸ”„' }, { label: 'Other reason', icon: 'â“' }] } },
              { id: 'end_keep_order', type: 'end', position: { x: 350, y: 690 }, data: { title: 'Order Kept', showSurvey: false } },
              { id: 'end_fulfilled', type: 'end', position: { x: 550, y: 330 }, data: { title: 'Order Already Fulfilled', showSurvey: false } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'cond_can_modify', animated: true },
              { id: 'e2', source: 'cond_can_modify', target: 'msg_unfulfilled', sourceHandle: 'yes', label: 'Unfulfilled (<10h)', animated: true },
              { id: 'e3', source: 'cond_can_modify', target: 'end_fulfilled', sourceHandle: 'no', label: 'Fulfilled or >10h', animated: true },
              { id: 'e4', source: 'msg_unfulfilled', target: 'opts_unfulfilled', animated: true },
              { id: 'e5', source: 'opts_unfulfilled', target: 'subflow_change_order', sourceHandle: 'opt-0', label: 'Change order', animated: true },
              { id: 'e6', source: 'opts_unfulfilled', target: 'msg_cancel_reason', sourceHandle: 'opt-1', label: 'Cancel order', animated: true },
              { id: 'e7', source: 'opts_unfulfilled', target: 'end_keep_order', sourceHandle: 'opt-2', label: 'Keep it', animated: true },
              { id: 'e8', source: 'msg_cancel_reason', target: 'opts_cancel_intent', animated: true }
            ]
          }
        }
      };

      // ============================================
      // CUSTOM NODE COMPONENTS
      // ============================================
      const StartNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: {
            padding: '16px 32px',
            borderRadius: '12px',
            background: '#22c55e',
            color: 'white',
            fontWeight: 600,
            fontSize: '15px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '10px',
            boxShadow: selected ? '0 0 0 2px #22c55e, 0 0 0 4px rgba(34, 197, 94, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)',
            minWidth: '140px',
            cursor: 'pointer'
          }
        },
          React.createElement(Icons.Play, null),
          React.createElement('span', null, 'Start'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#16a34a', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const MessageNode = ({ data, selected }) => {
        const personas = { amy: 'Amy', claudia: 'Claudia', sarah: 'Sarah' };
        return React.createElement('div', {
          style: {
            padding: '16px',
            borderRadius: '12px',
            background: 'white',
            border: selected ? '2px solid #3b82f6' : '2px solid #e5e7eb',
            boxShadow: selected ? '0 0 0 2px rgba(59, 130, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)',
            minWidth: '200px',
            maxWidth: '280px',
            cursor: 'pointer'
          }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#3b82f6', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#3b82f6' } }, React.createElement(Icons.MessageSquare, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, personas[data.persona] || 'Amy')
          ),
          React.createElement('p', { style: { fontSize: '14px', color: '#2D3748', lineHeight: '1.5', margin: 0 } }, data.content || 'Hello! How can I help you today?'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#3b82f6', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const OptionsNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #8b5cf6' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(139, 92, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', maxWidth: '280px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#8b5cf6' } }, React.createElement(Icons.List, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Options')
          ),
          React.createElement('p', { style: { fontSize: '14px', color: '#2D3748', marginBottom: '12px', fontWeight: 500 } }, data.prompt || 'What would you like to do?'),
          (data.options || []).slice(0, 3).map((opt, i) => React.createElement('div', { key: i, style: { fontSize: '12px', color: '#6b7280', padding: '8px 12px', background: '#f9fafb', borderRadius: '6px', marginBottom: '6px', border: '1px solid rgba(0, 0, 0, 0.08)' } }, opt.label)),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const ConditionNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #f59e0b' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(245, 158, 11, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#f59e0b', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#f59e0b' } }, React.createElement(Icons.GitBranch, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Condition')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#6b7280', fontFamily: 'monospace', margin: 0 } }, data.variable || '{{variable}}'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'yes', style: { background: '#22c55e', width: '10px', height: '10px', border: '2px solid white', left: '30%' } }),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'no', style: { background: '#ef4444', width: '10px', height: '10px', border: '2px solid white', left: '70%' } })
        );
      };

      const ApiNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #ec4899' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(236, 72, 153, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#ec4899', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#fce7f3', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#ec4899' } }, React.createElement(Icons.Zap, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'API Call')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, \`\${data.service || 'Shopify'}, \${data.endpoint || 'lookup'}\`),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#ec4899', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const AiNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #6366f1' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(99, 102, 241, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#6366f1', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#e0e7ff', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#6366f1' } }, React.createElement(Icons.Bot, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'AI Response')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, 'GPT-powered reply'),
          React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px' } }, data.model || 'gpt-4o-mini'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#6366f1', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const OfferNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '20px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #14b8a6' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(20, 184, 166, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '220px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#14b8a6', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' } },
            React.createElement('div', { style: { width: '32px', height: '32px', borderRadius: '50%', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#14b8a6' } }, React.createElement(Icons.Gift, null)),
            React.createElement('span', { style: { fontSize: '14px', fontWeight: 500, color: '#14b8a6' } }, 'Offer Card')
          ),
          React.createElement('p', { style: { fontSize: '28px', fontWeight: 700, color: '#10b981', margin: 0 } }, \`\${data.percent || 20}% Refund\`),
          React.createElement('p', { style: { fontSize: '14px', color: '#6b7280', marginTop: '6px', marginBottom: '16px' } }, data.label || 'Keep product'),
          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-around', paddingTop: '12px', borderTop: '1px solid #f3f4f6' } },
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Accept'),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Decline')
          ),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'accept', style: { background: '#22c55e', width: '12px', height: '12px', border: '2px solid white', left: '25%' } }),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'decline', style: { background: '#ef4444', width: '12px', height: '12px', border: '2px solid white', left: '75%' } })
        );
      };

      const CaseNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #f97316' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(249, 115, 22, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#f97316', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ffedd5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#f97316' } }, React.createElement(Icons.FolderOpen, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Create Case')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, 'Submit to Hub'),
          React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px' } }, \`Type: \${data.type || 'refund'}\`),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#f97316', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const FormNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #10b981' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(16, 185, 129, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#10b981' } }, React.createElement(Icons.FileText, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, data.formType || 'Form')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, data.label || 'Collect user input'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const EndNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px 20px', borderRadius: '12px', background: '#ef4444', border: selected ? '2px solid #dc2626' : '2px solid #ef4444', boxShadow: selected ? '0 0 0 3px rgba(239, 68, 68, 0.3), 0 10px 15px -3px rgba(0,0,0,0.15)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#fca5a5', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { color: 'white' } }, React.createElement(Icons.Flag, null)),
            React.createElement('span', { style: { fontSize: '14px', fontWeight: 600, color: 'white' } }, 'End')
          ),
          React.createElement('p', { style: { fontSize: '15px', color: 'rgba(255,255,255,0.9)', margin: 0, fontWeight: 500 } }, data.title || 'Thank You!')
        );
      };

      const SubflowNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px 20px', borderRadius: '12px', background: 'white', border: selected ? '2px dashed #8b5cf6' : '2px dashed #c4b5fd', boxShadow: selected ? '0 0 0 2px rgba(139, 92, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 4px 6px -1px rgba(0,0,0,0.05)', minWidth: '220px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#8b5cf6' } },
              React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                React.createElement('path', { d: 'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71' }),
                React.createElement('path', { d: 'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71' })
              )
            ),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#8b5cf6' } }, 'Subflow')
          ),
          React.createElement('p', { style: { fontSize: '15px', fontWeight: 600, color: '#2D3748', margin: 0 } }, data.name || 'Go to Subflow'),
          data.nodeCount && React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px' } }, \`\${data.nodeCount} nodes\`),
          React.createElement('p', { style: { fontSize: '12px', color: '#8b5cf6', marginTop: '6px' } }, 'Click to view â†’'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      // Delay Node - Manager approval delay simulation
      const DelayNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', border: selected ? '2px solid #f59e0b' : '2px solid #fcd34d', boxShadow: selected ? '0 0 0 2px rgba(245, 158, 11, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#f59e0b', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#fbbf24', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#78350f' } },
              React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
                React.createElement('polyline', { points: '12 6 12 12 16 14' })
              )
            ),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 600, color: '#78350f' } }, 'Manager Delay')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#92400e', margin: 0, fontWeight: 500 } }, data.message || 'Checking with manager...'),
          React.createElement('p', { style: { fontSize: '11px', color: '#b45309', marginTop: '6px', fontFamily: 'monospace' } }, \`â±ï¸ \${(data.duration || 8000) / 1000}s delay\`),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#f59e0b', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      // Evidence/Photo Upload Node
      const EvidenceNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #06b6d4' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(6, 182, 212, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#06b6d4', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#cffafe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#06b6d4' } },
              React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                React.createElement('rect', { x: 3, y: 3, width: 18, height: 18, rx: 2 }),
                React.createElement('circle', { cx: 8.5, cy: 8.5, r: 1.5 }),
                React.createElement('polyline', { points: '21 15 16 10 5 21' })
              )
            ),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#0891b2' } }, 'Photo Upload')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, data.label || 'Upload evidence photos'),
          data.description && React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px' } }, data.description),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#06b6d4', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      // Input Node - Text input collection
      const InputNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #10b981' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(16, 185, 129, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#10b981' } },
              React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                React.createElement('path', { d: 'M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z' })
              )
            ),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#059669' } }, 'Text Input')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, data.label || 'Enter text...'),
          data.placeholder && React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px', fontStyle: 'italic' } }, \`"\${data.placeholder}"\`),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const nodeTypes = { 
        start: StartNode, 
        message: MessageNode, 
        options: OptionsNode, 
        condition: ConditionNode, 
        api: ApiNode, 
        ai: AiNode, 
        offer: OfferNode, 
        case: CaseNode, 
        form: FormNode, 
        end: EndNode, 
        subflow: SubflowNode,
        delay: DelayNode,
        evidence: EvidenceNode,
        input: InputNode
      };

      // ============================================
      // LEFT PANEL - FLOW NAVIGATION WITH CARDS
      // ============================================
      const FlowNavigationPanel = ({ 
        parentFlows, 
        subflows, 
        selectedParentId, 
        selectedSubflowId, 
        viewingEntry,
        onSelectParent,
        onSelectSubflow,
        onSelectEntry 
      }) => {
        const [expandedParents, setExpandedParents] = useState({ [selectedParentId]: true });

        const toggleParent = (parentId) => {
          setExpandedParents(prev => ({ ...prev, [parentId]: !prev[parentId] }));
        };

        const selectedParent = parentFlows.find(p => p.id === selectedParentId);

        return React.createElement('div', { 
          style: { 
            width: '320px', 
            background: 'rgba(255, 255, 255, 0.95)',
            backdropFilter: 'blur(20px)',
            WebkitBackdropFilter: 'blur(20px)',
            borderRight: '1px solid rgba(0, 0, 0, 0.06)', 
            display: 'flex', 
            flexDirection: 'column', 
            flexShrink: 0,
            height: '100vh',
            boxShadow: '0 0 0 1px rgba(255, 255, 255, 0.5)'
          } 
        },
          // Header with Back to Hub
          React.createElement('div', { style: { 
            padding: '24px 28px', 
            borderBottom: '1px solid rgba(0, 0, 0, 0.06)', 
            background: 'rgba(255, 255, 255, 0.8)',
            backdropFilter: 'blur(10px)',
            WebkitBackdropFilter: 'blur(10px)'
          } },
            React.createElement('a', { 
              href: '/hub', 
              style: { 
                display: 'flex', 
                alignItems: 'center', 
                gap: '10px', 
                color: '#1a365d', 
                textDecoration: 'none', 
                fontSize: '15px', 
                fontWeight: 500,
                marginBottom: '20px',
                fontFamily: 'var(--font-sans, "Inter", sans-serif)',
                transition: 'all 0.2s ease',
                padding: '6px 10px',
                borderRadius: '8px',
                marginLeft: '-10px'
              },
              onMouseEnter: (e) => { e.target.style.background = 'rgba(26, 54, 93, 0.08)'; },
              onMouseLeave: (e) => { e.target.style.background = 'transparent'; }
            }, 
              React.createElement(Icons.ArrowLeft, null), 
              'Back to Hub'
            ),
            React.createElement('h1', { style: { 
              fontSize: '22px', 
              fontWeight: 700, 
              color: '#1a365d', 
              margin: 0,
              fontFamily: 'var(--font-display, "Space Grotesk", sans-serif)',
              letterSpacing: '-0.02em',
              lineHeight: '1.2'
            } }, 'Flow Documentation'),
            React.createElement('p', { style: { 
              fontSize: '14px', 
              color: '#64748b', 
              marginTop: '8px',
              fontWeight: 400,
              fontFamily: 'var(--font-sans, "Inter", sans-serif)',
              lineHeight: '1.5'
            } }, 'Select a flow to view')
          ),

          // Flow list
          React.createElement('div', { style: { flex: 1, overflowY: 'auto', padding: '24px 20px' } },
            parentFlows.map(parent => {
              const isExpanded = expandedParents[parent.id];
              const isSelected = selectedParentId === parent.id;
              const parentSubflows = parent.subflows.map(id => subflows[id]).filter(Boolean);

              return React.createElement('div', { key: parent.id, style: { marginBottom: '12px' } },
                // Parent Flow Card
                React.createElement('div', {
                  className: \`flow-card parent \${isSelected ? 'active' : ''}\`,
                  onClick: () => {
                    toggleParent(parent.id);
                    if (!isExpanded) {
                      onSelectParent(parent);
                      onSelectEntry();
                    }
                  },
                  style: { 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '12px',
                    background: isSelected ? \`linear-gradient(135deg, \${parent.color}10 0%, \${parent.color}05 100%)\` : undefined,
                    borderColor: isSelected ? parent.color : undefined
                  }
                },
                  React.createElement('div', { 
                    style: { 
                      width: '40px', 
                      height: '40px', 
                      display: 'flex', 
                      alignItems: 'center', 
                      justifyContent: 'center',
                      borderRadius: '10px',
                      background: isSelected ? \`rgba(\${parent.color === '#8b5cf6' ? '139, 92, 246' : parent.color === '#3b82f6' ? '59, 130, 246' : '16, 185, 129'}, 0.1)\` : 'rgba(0, 0, 0, 0.04)',
                      color: isSelected ? parent.color : '#64748b',
                      flexShrink: 0
                    } 
                  }, parent.icon),
                  React.createElement('div', { style: { flex: 1, minWidth: 0 } },
                    React.createElement('div', { style: { 
                      fontSize: '15px', 
                      fontWeight: 600, 
                      color: isSelected ? '#1a365d' : '#0f172a',
                      fontFamily: 'var(--font-sans, "Inter", sans-serif)',
                      letterSpacing: '-0.01em',
                      lineHeight: '1.3'
                    } }, parent.name),
                    React.createElement('div', { style: { 
                      fontSize: '13px', 
                      color: '#64748b', 
                      marginTop: '4px',
                      fontWeight: 400,
                      fontFamily: 'var(--font-sans, "Inter", sans-serif)'
                    } }, \`\${parentSubflows.length + 1} flows\`)
                  ),
                  React.createElement('div', { 
                    style: { 
                      color: '#718096',
                      transform: isExpanded ? 'rotate(180deg)' : 'rotate(0)',
                      transition: 'transform 0.2s'
                    } 
                  }, React.createElement(Icons.ChevronDown, null))
                ),

                // Subflows (when expanded)
                isExpanded && React.createElement('div', { style: { marginLeft: '16px', marginTop: '8px' } },
                  // Entry Flow
                  React.createElement('div', {
                    className: \`flow-card \${viewingEntry && isSelected ? 'active' : ''}\`,
                    onClick: () => { onSelectParent(parent); onSelectEntry(); }
                  },
                    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px' } },
                      React.createElement('div', { style: { width: '8px', height: '8px', borderRadius: '50%', background: viewingEntry && isSelected ? parent.color : '#d1d5db' } }),
                      React.createElement('div', null,
                        React.createElement('div', { style: { 
                          fontSize: '14px', 
                          fontWeight: 500, 
                          color: viewingEntry && isSelected ? '#1a365d' : '#334155',
                          fontFamily: 'var(--font-sans, "Inter", sans-serif)',
                          letterSpacing: '-0.01em'
                        } }, 'Entry Flow'),
                        React.createElement('div', { style: { 
                          fontSize: '12px', 
                          color: '#64748b',
                          marginTop: '2px',
                          fontWeight: 400
                        } }, \`\${parent.entryNodes?.length || 0} nodes\`)
                      )
                    )
                  ),

                  // Subflows
                  parentSubflows.map(subflow => 
                    React.createElement('div', {
                      key: subflow.id,
                      className: \`flow-card \${!viewingEntry && selectedSubflowId === subflow.id ? 'active' : ''}\`,
                      onClick: () => { onSelectParent(parent); onSelectSubflow(subflow); }
                    },
                      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px' } },
                        React.createElement('div', { style: { width: '8px', height: '8px', borderRadius: '50%', background: !viewingEntry && selectedSubflowId === subflow.id ? parent.color : '#d1d5db' } }),
                        React.createElement('div', { style: { flex: 1, minWidth: 0 } },
                          React.createElement('div', { style: { 
                            fontSize: '14px', 
                            fontWeight: 500, 
                            color: !viewingEntry && selectedSubflowId === subflow.id ? '#1a365d' : '#334155',
                            overflow: 'hidden', 
                            textOverflow: 'ellipsis', 
                            whiteSpace: 'nowrap',
                            fontFamily: 'var(--font-sans, "Inter", sans-serif)',
                            letterSpacing: '-0.01em'
                          } }, subflow.name),
                          React.createElement('div', { style: { 
                            fontSize: '12px', 
                            color: '#64748b',
                            marginTop: '2px',
                            fontWeight: 400
                          } }, \`\${subflow.nodes?.length || 0} nodes\`)
                        )
                      )
                    )
                  )
                )
              );
            })
          )
        );
      };

      // ============================================
      // RIGHT PANEL - NODE PROPERTIES (Enhanced)
      // ============================================
      const NodePropertiesPanel = ({ selectedNode, onSimulate }) => {
        const [expandedSections, setExpandedSections] = useState({ prompt: false, request: false, response: false });
        
        const toggleSection = (section) => {
          setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
        };

        if (!selectedNode) {
          return React.createElement('div', { 
            style: { 
              width: '380px', 
              background: 'rgba(255, 255, 255, 0.95)',
              backdropFilter: 'blur(20px)',
              WebkitBackdropFilter: 'blur(20px)',
              borderLeft: '1px solid rgba(0, 0, 0, 0.06)',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '64px 48px',
              color: '#64748b',
              boxShadow: '0 0 0 1px rgba(255, 255, 255, 0.5)'
            } 
          },
            React.createElement('div', { style: { 
              width: '72px', 
              height: '72px', 
              margin: '0 auto 24px', 
              background: 'linear-gradient(135deg, rgba(26, 54, 93, 0.08) 0%, rgba(26, 54, 93, 0.04) 100%)',
              borderRadius: '20px', 
              display: 'flex', 
              alignItems: 'center', 
              justifyContent: 'center',
              color: '#1a365d',
              border: '1px solid rgba(26, 54, 93, 0.1)'
            } },
              React.createElement(Icons.Eye, { width: 28, height: 28 })
            ),
            React.createElement('p', { style: { 
              fontWeight: 600, 
              marginBottom: '8px', 
              color: '#1a365d', 
              fontSize: '17px',
              fontFamily: 'var(--font-display, "Space Grotesk", sans-serif)',
              letterSpacing: '-0.02em'
            } }, 'Select a node'),
            React.createElement('p', { style: { 
              fontSize: '14px', 
              textAlign: 'center', 
              lineHeight: '1.6',
              color: '#64748b',
              fontFamily: 'var(--font-sans, "Inter", sans-serif)',
              maxWidth: '280px'
            } }, 'Click on any node in the canvas to view its properties and details')
          );
        }

        const getIcon = () => {
          const iconMap = { message: Icons.MessageSquare, options: Icons.List, condition: Icons.GitBranch, api: Icons.Zap, ai: Icons.Bot, offer: Icons.Gift, case: Icons.FolderOpen, form: Icons.FileText, end: Icons.Flag, start: Icons.Play, delay: Icons.Play, evidence: Icons.FileText, input: Icons.FileText };
          const IconComp = iconMap[selectedNode.type] || Icons.Play;
          return React.createElement(IconComp);
        };

        const getNodeTitle = () => {
          const titles = {
            ai: 'AI Response (OpenAI)',
            api: 'API Integration',
            offer: 'Refund Offer',
            delay: 'Manager Delay',
            evidence: 'Photo Upload',
            input: 'Text Input',
            form: 'Form Input',
            case: 'Case Creation',
            condition: 'Condition Check',
            options: 'User Options',
            message: 'Bot Message',
            start: 'Flow Start',
            end: 'Flow End',
            subflow: 'Subflow Link'
          };
          return titles[selectedNode.type] || (selectedNode.type + ' Node');
        };

        return React.createElement('div', { 
          style: { 
            width: '380px', 
            background: 'rgba(255, 255, 255, 0.95)',
            backdropFilter: 'blur(20px)',
            WebkitBackdropFilter: 'blur(20px)',
            borderLeft: '1px solid rgba(0, 0, 0, 0.06)',
            display: 'flex',
            flexDirection: 'column',
            flexShrink: 0,
            boxShadow: '0 0 0 1px rgba(255, 255, 255, 0.5)'
          } 
        },
          // Header
          React.createElement('div', { style: { 
            padding: '28px', 
            borderBottom: '1px solid rgba(0, 0, 0, 0.06)',
            background: 'rgba(255, 255, 255, 0.8)',
            backdropFilter: 'blur(10px)',
            WebkitBackdropFilter: 'blur(10px)'
          } },
            React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '14px' } },
              React.createElement('div', { 
                style: { 
                  width: '48px', 
                  height: '48px', 
                  borderRadius: '12px', 
                  background: (nodeColors[selectedNode.type] || '#94a3b8') + '15', 
                  display: 'flex', 
                  alignItems: 'center', 
                  justifyContent: 'center', 
                  color: nodeColors[selectedNode.type] || '#94a3b8',
                  border: \`1px solid \${(nodeColors[selectedNode.type] || '#94a3b8')}25\`
                } 
              }, getIcon()),
              React.createElement('div', { style: { flex: 1 } },
                React.createElement('h3', { style: { 
                  fontSize: '17px', 
                  fontWeight: 600, 
                  margin: 0, 
                  color: '#1a365d',
                  fontFamily: 'var(--font-display, "Space Grotesk", sans-serif)',
                  letterSpacing: '-0.02em',
                  lineHeight: '1.3'
                } }, getNodeTitle()),
                React.createElement('p', { style: { 
                  fontSize: '12px', 
                  color: '#94a3af', 
                  margin: 0, 
                  marginTop: '4px', 
                  fontFamily: 'monospace',
                  letterSpacing: '0.5px',
                  fontWeight: 500
                } }, \`ID: \${selectedNode.id}\`)
              )
            ),
            // Simulate Button
            (selectedNode.type === 'message' || selectedNode.type === 'options' || selectedNode.type === 'offer' || selectedNode.type === 'form') &&
            React.createElement('button', {
              onClick: () => onSimulate && onSimulate(selectedNode),
              style: { 
                marginTop: '20px', 
                width: '100%', 
                padding: '14px 20px', 
                background: 'linear-gradient(135deg, #1a365d 0%, #2c5282 100%)', 
                color: 'white', 
                border: 'none', 
                borderRadius: '12px', 
                fontSize: '14px', 
                fontWeight: 600, 
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '10px',
                fontFamily: 'var(--font-sans, "Inter", sans-serif)',
                boxShadow: '0 2px 8px rgba(26, 54, 93, 0.2)',
                transition: 'all 0.2s ease'
              },
              onMouseEnter: (e) => {
                e.target.style.background = 'linear-gradient(135deg, #2c5282 0%, #1a365d 100%)';
                e.target.style.boxShadow = '0 4px 12px rgba(26, 54, 93, 0.3)';
                e.target.style.transform = 'translateY(-1px)';
              },
              onMouseLeave: (e) => {
                e.target.style.background = 'linear-gradient(135deg, #1a365d 0%, #2c5282 100%)';
                e.target.style.boxShadow = '0 2px 8px rgba(26, 54, 93, 0.2)';
                e.target.style.transform = 'translateY(0)';
              }
            }, 
              React.createElement(Icons.Eye, { width: 18, height: 18 }),
              'View in Simulator'
            )
          ),

          // Content
          React.createElement('div', { style: { flex: 1, padding: '16px', overflowY: 'auto' } },
            // Node Type Badge
            React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('span', { 
                style: { display: 'inline-block', padding: '4px 10px', background: (nodeColors[selectedNode.type] || '#94a3b8') + '15', color: nodeColors[selectedNode.type] || '#94a3b8', borderRadius: '6px', fontSize: '11px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' } 
              }, selectedNode.type)
            ),

            // === AI NODE DETAILS ===
            selectedNode.type === 'ai' && React.createElement('div', null,
              // Model Info
              React.createElement('div', { style: { marginBottom: '16px', padding: '12px', background: '#eef2ff', borderRadius: '10px', border: '1px solid #c7d2fe' } },
                React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' } },
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#6366f1', fontWeight: 600, textTransform: 'uppercase' } }, 'Model'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#4338ca' } }, selectedNode.data.model || 'gpt-4o-mini')
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#6366f1', fontWeight: 600, textTransform: 'uppercase' } }, 'Temperature'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#4338ca' } }, selectedNode.data.temperature || '0.7')
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#6366f1', fontWeight: 600, textTransform: 'uppercase' } }, 'Max Tokens'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#4338ca' } }, selectedNode.data.maxTokens || '800')
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#6366f1', fontWeight: 600, textTransform: 'uppercase' } }, 'Scenario'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#4338ca' } }, selectedNode.data.scenarioType || 'custom')
                  )
                )
              ),
              // System Prompt
              selectedNode.data.systemPrompt && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('div', { 
                  onClick: () => toggleSection('prompt'),
                  style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer', padding: '10px 12px', background: '#f9fafb', borderRadius: '8px', border: '1px solid rgba(0, 0, 0, 0.08)' }
                },
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: '#2D3748' } }, 'System Prompt'),
                  React.createElement('span', { style: { fontSize: '10px', color: '#6b7280' } }, expandedSections.prompt ? 'â–¼' : 'â–¶')
                ),
                expandedSections.prompt && React.createElement('div', { 
                  style: { marginTop: '8px', padding: '12px', background: '#1e1b4b', borderRadius: '8px', maxHeight: '200px', overflowY: 'auto' }
                },
                  React.createElement('pre', { style: { fontSize: '11px', color: '#c7d2fe', whiteSpace: 'pre-wrap', margin: 0, fontFamily: 'monospace', lineHeight: '1.5' } }, selectedNode.data.systemPrompt)
                )
              ),
              // User Prompt Template
              selectedNode.data.userPromptTemplate && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'User Prompt Template'),
                React.createElement('div', { style: { padding: '10px 12px', background: '#fdf4ff', borderRadius: '8px', border: '1px solid #e9d5ff' } },
                  React.createElement('code', { style: { fontSize: '11px', color: '#7e22ce', whiteSpace: 'pre-wrap' } }, selectedNode.data.userPromptTemplate)
                )
              )
            ),

            // === API NODE DETAILS ===
            selectedNode.type === 'api' && React.createElement('div', null,
              // Service & Endpoint
              React.createElement('div', { style: { marginBottom: '16px', padding: '12px', background: '#fdf4ff', borderRadius: '10px', border: '1px solid #f5d0fe' } },
                React.createElement('div', { style: { fontSize: '10px', color: '#a855f7', fontWeight: 600, textTransform: 'uppercase', marginBottom: '4px' } }, 'Service'),
                React.createElement('div', { style: { fontSize: '16px', fontWeight: 700, color: '#7e22ce', marginBottom: '12px' } }, selectedNode.data.service),
                React.createElement('div', { style: { fontSize: '10px', color: '#a855f7', fontWeight: 600, textTransform: 'uppercase', marginBottom: '4px' } }, 'Endpoint'),
                React.createElement('code', { style: { display: 'block', fontSize: '12px', color: '#581c87', background: '#fae8ff', padding: '8px 10px', borderRadius: '6px', fontFamily: 'monospace' } }, selectedNode.data.endpoint)
              ),
              // Description
              selectedNode.data.description && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Description'),
                React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0, lineHeight: '1.5' } }, selectedNode.data.description)
              ),
              // Request Schema
              selectedNode.data.request && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('div', { 
                  onClick: () => toggleSection('request'),
                  style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer', padding: '10px 12px', background: '#ecfdf5', borderRadius: '8px', border: '1px solid #a7f3d0' }
                },
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: '#059669' } }, 'Request Schema'),
                  React.createElement('span', { style: { fontSize: '10px', color: '#6b7280' } }, expandedSections.request ? 'â–¼' : 'â–¶')
                ),
                expandedSections.request && React.createElement('pre', { 
                  style: { marginTop: '8px', padding: '12px', background: '#064e3b', borderRadius: '8px', fontSize: '11px', color: '#6ee7b7', fontFamily: 'monospace', whiteSpace: 'pre-wrap', margin: 0 }
                }, selectedNode.data.request)
              ),
              // Response Schema
              selectedNode.data.response && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('div', { 
                  onClick: () => toggleSection('response'),
                  style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer', padding: '10px 12px', background: '#eff6ff', borderRadius: '8px', border: '1px solid #bfdbfe' }
                },
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: '#2563eb' } }, 'Response Schema'),
                  React.createElement('span', { style: { fontSize: '10px', color: '#6b7280' } }, expandedSections.response ? 'â–¼' : 'â–¶')
                ),
                expandedSections.response && React.createElement('pre', { 
                  style: { marginTop: '8px', padding: '12px', background: '#1e3a8a', borderRadius: '8px', fontSize: '11px', color: '#93c5fd', fontFamily: 'monospace', whiteSpace: 'pre-wrap', margin: 0 }
                }, selectedNode.data.response)
              )
            ),

            // === OFFER NODE DETAILS ===
            selectedNode.type === 'offer' && React.createElement('div', null,
              React.createElement('div', { style: { padding: '20px', background: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)', borderRadius: '12px', textAlign: 'center', marginBottom: '16px' } },
                React.createElement('div', { style: { fontSize: '40px', fontWeight: 700, color: '#059669' } }, \`\${selectedNode.data.percent}%\`),
                React.createElement('div', { style: { fontSize: '14px', color: '#047857', marginTop: '4px', fontWeight: 500 } }, selectedNode.data.label || 'Partial Refund')
              ),
              selectedNode.data.message && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Offer Message'),
                React.createElement('div', { style: { padding: '12px', background: '#f9fafb', borderRadius: '10px', fontSize: '13px', lineHeight: '1.6', border: '1px solid rgba(0, 0, 0, 0.08)' } }, selectedNode.data.message)
              ),
              React.createElement('div', { style: { display: 'flex', gap: '8px', flexWrap: 'wrap' } },
                selectedNode.data.needsManagerApproval && React.createElement('span', { style: { padding: '4px 10px', background: '#fef3c7', color: '#b45309', borderRadius: '20px', fontSize: '11px', fontWeight: 500 } }, 'ðŸ‘” Manager Approval'),
                selectedNode.data.isFinal && React.createElement('span', { style: { padding: '4px 10px', background: '#fee2e2', color: '#dc2626', borderRadius: '20px', fontSize: '11px', fontWeight: 500 } }, 'ðŸ Final Offer'),
                selectedNode.data.forFuture && React.createElement('span', { style: { padding: '4px 10px', background: '#dbeafe', color: '#2563eb', borderRadius: '20px', fontSize: '11px', fontWeight: 500 } }, 'ðŸ“… Future Discount')
              )
            ),

            // === DELAY NODE DETAILS ===
            selectedNode.type === 'delay' && React.createElement('div', null,
              React.createElement('div', { style: { padding: '20px', background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', borderRadius: '12px', textAlign: 'center', marginBottom: '16px' } },
                React.createElement('div', { style: { fontSize: '32px', fontWeight: 700, color: '#92400e' } }, \`\${(selectedNode.data.duration || 8000) / 1000}s\`),
                React.createElement('div', { style: { fontSize: '14px', color: '#b45309', marginTop: '4px', fontWeight: 500 } }, 'Delay Duration')
              ),
              React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Loading Message'),
                React.createElement('div', { style: { padding: '12px', background: '#f9fafb', borderRadius: '10px', fontSize: '13px', border: '1px solid rgba(0, 0, 0, 0.08)' } }, selectedNode.data.message || 'Please wait...')
              ),
              React.createElement('p', { style: { fontSize: '12px', color: '#6b7280', margin: 0, fontStyle: 'italic' } }, 'This simulates manager approval time to make the experience feel more authentic.')
            ),

            // === CONDITION NODE DETAILS ===
            selectedNode.type === 'condition' && React.createElement('div', null,
              React.createElement('div', { style: { padding: '14px', background: '#fffbeb', borderRadius: '10px', border: '1px solid #fde68a', marginBottom: '16px' } },
                React.createElement('div', { style: { fontSize: '10px', color: '#b45309', fontWeight: 600, textTransform: 'uppercase', marginBottom: '8px' } }, 'Condition Logic'),
                React.createElement('code', { style: { display: 'block', fontSize: '13px', color: '#78350f', fontFamily: 'monospace', background: '#fef3c7', padding: '10px', borderRadius: '6px' } }, 
                  \`if (\${selectedNode.data.variable} \${selectedNode.data.operator || '==='} "\${selectedNode.data.value || ''}")\`
                )
              ),
              React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' } },
                React.createElement('div', { style: { padding: '10px', background: '#dcfce7', borderRadius: '8px', textAlign: 'center' } },
                  React.createElement('div', { style: { fontSize: '10px', color: '#16a34a', fontWeight: 600 } }, 'YES BRANCH'),
                  React.createElement('div', { style: { fontSize: '12px', color: '#15803d', fontWeight: 500, marginTop: '4px' } }, selectedNode.data.yesLabel || 'True')
                ),
                React.createElement('div', { style: { padding: '10px', background: '#fee2e2', borderRadius: '8px', textAlign: 'center' } },
                  React.createElement('div', { style: { fontSize: '10px', color: '#dc2626', fontWeight: 600 } }, 'NO BRANCH'),
                  React.createElement('div', { style: { fontSize: '12px', color: '#b91c1c', fontWeight: 500, marginTop: '4px' } }, selectedNode.data.noLabel || 'False')
                )
              )
            ),

            // Persona (for message/ai nodes)
            selectedNode.data?.persona && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Persona'),
              React.createElement('div', { style: { padding: '12px 14px', background: '#f9fafb', borderRadius: '10px', fontSize: '14px', border: '1px solid rgba(0, 0, 0, 0.08)', display: 'flex', alignItems: 'center', gap: '10px' } }, 
                React.createElement('div', { style: { width: '32px', height: '32px', borderRadius: '50%', background: selectedNode.data.persona === 'claudia' ? '#fce7f3' : '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px' } }, selectedNode.data.persona === 'claudia' ? 'ðŸ•' : 'ðŸ‘©'),
                React.createElement('div', null,
                  React.createElement('div', { style: { fontWeight: 600, color: '#2D3748' } }, selectedNode.data.persona === 'amy' ? 'Amy' : selectedNode.data.persona === 'claudia' ? 'Claudia' : selectedNode.data.persona),
                  React.createElement('div', { style: { fontSize: '11px', color: '#718096' } }, selectedNode.data.persona === 'claudia' ? 'Dog Trainer' : 'Customer Support')
                )
              )
            ),

            // Message Content (for message nodes)
            selectedNode.data?.content && selectedNode.type === 'message' && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Message Content'),
              React.createElement('div', { style: { padding: '12px 14px', background: '#f9fafb', borderRadius: '10px', fontSize: '14px', lineHeight: '1.6', border: '1px solid rgba(0, 0, 0, 0.08)', color: '#2D3748' } }, selectedNode.data.content)
            ),

            // Options list
            selectedNode.data?.options && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, \`Options (\${selectedNode.data.options.length})\`),
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '6px' } },
                selectedNode.data.options.map((opt, i) => 
                  React.createElement('div', { key: i, style: { padding: '10px 12px', background: '#f9fafb', borderRadius: '8px', fontSize: '13px', border: '1px solid rgba(0, 0, 0, 0.08)', display: 'flex', alignItems: 'center', gap: '8px' } },
                    React.createElement('span', { style: { width: '22px', height: '22px', borderRadius: '50%', background: '#8b5cf6', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '11px', fontWeight: 600, color: 'white' } }, opt.icon || (i + 1)),
                    opt.label || opt
                  )
                )
              )
            ),

            // Case Details - comprehensive Hub submission info
            selectedNode.type === 'case' && React.createElement('div', { style: { marginBottom: '16px' } },
              // Case Type Header
              React.createElement('div', { style: { padding: '16px', background: 'linear-gradient(135deg, #fff7ed 0%, #ffedd5 100%)', borderRadius: '12px', border: '1px solid #fed7aa', marginBottom: '12px' } },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '12px' } },
                  React.createElement('div', { style: { width: '36px', height: '36px', borderRadius: '8px', background: '#ea580c', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
                    React.createElement(Icons.FolderOpen, { width: 20, height: 20, color: 'white' })
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '16px', fontWeight: 700, color: '#c2410c', textTransform: 'capitalize' } }, 
                      (selectedNode.data.type || 'general').replace(/_/g, ' ') + ' Case'
                    ),
                    React.createElement('div', { style: { fontSize: '12px', color: '#ea580c' } }, 'Submitted to Resolution Hub')
                  )
                )
              ),
              
              // Case Details Grid
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '8px', textTransform: 'uppercase' } }, 'Hub Submission Details'),
              React.createElement('div', { style: { background: '#f9fafb', borderRadius: '10px', border: '1px solid rgba(0, 0, 0, 0.08)', overflow: 'hidden' } },
                // Issue Type
                React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '10px 14px', borderBottom: '1px solid rgba(0, 0, 0, 0.06)' } },
                  React.createElement('span', { style: { fontSize: '12px', color: '#6b7280', fontWeight: 500 } }, 'Issue Type'),
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: '#2D3748', textTransform: 'capitalize' } }, (selectedNode.data.type || 'general').replace(/_/g, ' '))
                ),
                // Subtype/Resolution
                selectedNode.data.subtype && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '10px 14px', borderBottom: '1px solid rgba(0, 0, 0, 0.06)' } },
                  React.createElement('span', { style: { fontSize: '12px', color: '#6b7280', fontWeight: 500 } }, 'Resolution'),
                  React.createElement('code', { style: { fontSize: '11px', color: '#7c3aed', background: '#ede9fe', padding: '2px 8px', borderRadius: '4px', fontWeight: 600 } }, selectedNode.data.subtype.replace(/_/g, ' '))
                ),
                // Priority
                React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '10px 14px', borderBottom: '1px solid rgba(0, 0, 0, 0.06)' } },
                  React.createElement('span', { style: { fontSize: '12px', color: '#6b7280', fontWeight: 500 } }, 'Priority'),
                  React.createElement('span', { 
                    style: { 
                      fontSize: '11px', 
                      fontWeight: 600, 
                      padding: '2px 10px', 
                      borderRadius: '20px',
                      background: selectedNode.data.priority === 'high' ? '#fee2e2' : selectedNode.data.priority === 'urgent' ? '#fef3c7' : '#ecfdf5',
                      color: selectedNode.data.priority === 'high' ? '#dc2626' : selectedNode.data.priority === 'urgent' ? '#d97706' : '#059669',
                      textTransform: 'uppercase'
                    } 
                  }, selectedNode.data.priority || 'normal')
                ),
                // Return Required
                selectedNode.data.returnRequired !== undefined && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '10px 14px', borderBottom: '1px solid rgba(0, 0, 0, 0.06)' } },
                  React.createElement('span', { style: { fontSize: '12px', color: '#6b7280', fontWeight: 500 } }, 'Return Required'),
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: selectedNode.data.returnRequired ? '#dc2626' : '#059669' } }, selectedNode.data.returnRequired ? 'âœ“ Yes' : 'âœ— No')
                ),
                // Include Bonus
                selectedNode.data.includeBonus !== undefined && React.createElement('div', { style: { display: 'flex', justifyContent: 'space-between', padding: '10px 14px', borderBottom: '1px solid rgba(0, 0, 0, 0.06)' } },
                  React.createElement('span', { style: { fontSize: '12px', color: '#6b7280', fontWeight: 500 } }, 'Include Bonus Item'),
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: selectedNode.data.includeBonus ? '#059669' : '#6b7280' } }, selectedNode.data.includeBonus ? 'âœ“ Yes' : 'âœ— No')
                )
              ),
              
              // Data Sent to Hub
              React.createElement('div', { style: { marginTop: '12px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '8px', textTransform: 'uppercase' } }, 'Data Sent to Hub'),
                React.createElement('div', { style: { background: '#1e293b', borderRadius: '8px', padding: '12px', fontFamily: 'monospace', fontSize: '11px', lineHeight: '1.6', color: '#94a3b8' } },
                  React.createElement('div', null, 'â€¢ Order Number: ', React.createElement('span', { style: { color: '#22d3ee' } }, '{{orderNumber}}')),
                  React.createElement('div', null, 'â€¢ Customer Email: ', React.createElement('span', { style: { color: '#22d3ee' } }, '{{customerEmail}}')),
                  React.createElement('div', null, 'â€¢ Issue Type: ', React.createElement('span', { style: { color: '#fbbf24' } }, selectedNode.data.type || 'general')),
                  React.createElement('div', null, 'â€¢ Resolution: ', React.createElement('span', { style: { color: '#a78bfa' } }, selectedNode.data.subtype || 'pending')),
                  React.createElement('div', null, 'â€¢ Refund Amount: ', React.createElement('span', { style: { color: '#4ade80' } }, '{{calculatedAmount}}')),
                  React.createElement('div', null, 'â€¢ Items Affected: ', React.createElement('span', { style: { color: '#22d3ee' } }, '{{selectedItems}}')),
                  React.createElement('div', null, 'â€¢ Conversation ID: ', React.createElement('span', { style: { color: '#22d3ee' } }, '{{conversationId}}'))
                )
              ),
              
              // Note if present
              selectedNode.data.note && React.createElement('div', { style: { marginTop: '12px', padding: '10px 12px', background: '#fef3c7', borderRadius: '8px', border: '1px solid #fde68a' } },
                React.createElement('div', { style: { display: 'flex', alignItems: 'flex-start', gap: '8px' } },
                  React.createElement('span', { style: { fontSize: '14px' } }, 'âš ï¸'),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '11px', fontWeight: 600, color: '#92400e', textTransform: 'uppercase', marginBottom: '2px' } }, 'Agent Note'),
                    React.createElement('div', { style: { fontSize: '12px', color: '#78350f' } }, selectedNode.data.note)
                  )
                )
              )
            ),

            // Form Fields
            selectedNode.type === 'form' && selectedNode.data?.fields && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Form Fields'),
              React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '6px' } },
                selectedNode.data.fields.map((field, i) => 
                  React.createElement('span', { key: i, style: { padding: '4px 10px', background: '#ecfdf5', color: '#059669', borderRadius: '20px', fontSize: '12px', fontWeight: 500 } }, field)
                )
              )
            )
          )
        );
      };

      // ============================================
      // CHAT SIMULATOR COMPONENT
      // Renders nodes exactly as they appear in the actual chat app
      // ============================================
      // Map form types to actual messages from chat app (matches MESSAGES.common and actual flow)
      const FORM_MESSAGES = {
        'Item Selection': "Which item(s) do you need help with? Tap to select:",
        'Customer Lookup': '', // No message before initial form - form appears directly after welcome message
        'Deep Search': "I couldn't find an order with those details. Let's try a deeper search with your shipping information.",
        'Photo Upload': "First, could you upload a photo of everything you actually received? Please include the packaging too... this helps our team investigate what happened.",
      };
      
      const ChatSimulator = ({ node, onClose }) => {
        if (!node) return null;

        const personas = {
          amy: { name: 'Amy', role: 'Customer Support', avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face', color: '#3b82f6' },
          claudia: { name: 'Claudia', role: 'Dog Trainer', avatar: 'https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=100&h=100&fit=crop&crop=face', color: '#ec4899' },
          sarah: { name: 'Sarah', role: 'CX Lead', avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop&crop=face', color: '#8b5cf6' }
        };
        const persona = personas[node.data?.persona] || personas.amy;

        // Helper: Render message bubble (reusable for prompts/labels before forms/options)
        const renderMessageBubble = (messageText) => {
          // Check if content contains HTML tags (like <br>)
          const hasHTML = typeof messageText === 'string' && /<[a-z][\\s\\S]*>/i.test(messageText);
          
          return React.createElement('div', { style: { marginBottom: '8px' } },
            React.createElement('div', { style: { display: 'flex', gap: '12px', maxWidth: '85%' } },
              React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover', flexShrink: 0, marginTop: '4px' } }),
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px' } },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px' } },
                  React.createElement('span', { style: { fontWeight: 600, color: '#2D3748' } }, persona.name),
                  React.createElement('span', { style: { color: '#718096', fontWeight: 400 } }, persona.role)
                ),
                React.createElement('div', { 
                  style: { padding: '14px 18px', background: 'white', borderRadius: '16px', borderBottomLeftRadius: '6px', border: '1px solid rgba(0, 0, 0, 0.08)', fontSize: '15px', lineHeight: '1.5', color: '#2D3748' },
                  ...(hasHTML ? { dangerouslySetInnerHTML: { __html: messageText } } : {})
                }, 
                  hasHTML ? null : messageText
                )
              )
            )
          );
        };

        // Render message bubble
        const renderMessage = () => {
          const messageContent = node.data?.content || node.data?.prompt || node.data?.message || "Hi! I'm Amy from PuppyPad. I can sort this out with you right here so you don't have to go back and forth over email. Just enter your details below. ðŸ™‚";
          // Check if content contains HTML tags (like <br>)
          const hasHTML = typeof messageContent === 'string' && /<[a-z][\\s\\S]*>/i.test(messageContent);
          
          return React.createElement('div', { style: { display: 'flex', gap: '12px', maxWidth: '85%' } },
            React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover', flexShrink: 0, marginTop: '4px' } }),
            React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px' } },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px' } },
                React.createElement('span', { style: { fontWeight: 600, color: '#2D3748' } }, persona.name),
                React.createElement('span', { style: { color: '#718096' } }, persona.role)
              ),
              React.createElement('div', { 
                style: { padding: '14px 18px', background: 'white', borderRadius: '16px', borderBottomLeftRadius: '6px', border: '1px solid rgba(0, 0, 0, 0.08)', fontSize: '15px', lineHeight: '1.5', color: '#2D3748' },
                ...(hasHTML ? { dangerouslySetInnerHTML: { __html: messageContent } } : {})
              }, 
                hasHTML ? null : messageContent
              )
            )
          );
        };

        // Render options buttons
        const renderOptions = () => {
          const options = node.data?.options || [];
          return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '10px', width: '100%', marginTop: '8px' } },
            options.map((opt, i) => 
              React.createElement('button', { 
                key: i, 
                style: { 
                  width: '100%',
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '12px', 
                  padding: '18px 20px', 
                  background: 'white', 
                  border: '1px solid rgba(0, 0, 0, 0.08)', 
                  borderRadius: '16px', 
                  cursor: 'pointer',
                  textAlign: 'left',
                  boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                  transition: 'all 0.25s ease',
                  fontSize: '15px',
                  fontWeight: 500,
                  color: '#2D3748'
                },
                onMouseOver: (e) => { 
                  const btn = e.currentTarget;
                  btn.style.borderColor = '#1a365d';
                  btn.style.background = '#E8EEF4';
                  btn.style.transform = 'translateX(4px)';
                  btn.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
                  const icon = btn.querySelector('.icon');
                  if (icon) {
                    icon.style.background = '#1a365d';
                    icon.style.color = 'white';
                    icon.style.transform = 'scale(1.1)';
                  }
                },
                onMouseOut: (e) => { 
                  const btn = e.currentTarget;
                  btn.style.borderColor = 'rgba(0, 0, 0, 0.08)';
                  btn.style.background = 'white';
                  btn.style.transform = 'translateX(0)';
                  btn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                  const icon = btn.querySelector('.icon');
                  if (icon) {
                    icon.style.background = '#F3F4F6';
                    icon.style.color = 'inherit';
                    icon.style.transform = 'scale(1)';
                  }
                }
              },
                opt.icon && React.createElement('span', { style: { width: '40px', height: '40px', borderRadius: '12px', background: '#F3F4F6', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', transition: 'all 0.25s ease', flexShrink: 0 }, className: 'icon' }, opt.icon),
                opt.label || opt
              )
            )
          );
        };

        // Render offer card
        const renderOffer = () => {
          return React.createElement('div', { style: { position: 'relative', background: 'linear-gradient(135deg, #1a365d 0%, #2c5282 100%)', borderRadius: '24px', padding: '32px 24px', textAlign: 'center', margin: '16px 0', color: 'white', boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), 0 0 40px rgba(26, 54, 93, 0.2)', overflow: 'hidden' } },
            React.createElement('div', { style: { fontSize: '40px', marginBottom: '12px', position: 'relative', zIndex: 1 } }, 'ðŸ’°'),
            React.createElement('div', { style: { fontFamily: 'Space Grotesk, Poppins, sans-serif', fontSize: '64px', fontWeight: 800, lineHeight: 1, marginBottom: '8px', background: 'linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', backgroundClip: 'text', position: 'relative', zIndex: 1 } }, \`\${node.data?.percent || 20}%\`),
            React.createElement('div', { style: { fontSize: '18px', opacity: 0.9, marginBottom: '8px', position: 'relative', zIndex: 1 } }, node.data?.value || \`$\${((node.data?.percent || 20) * 10).toFixed(2)} back to you\`),
            React.createElement('div', { style: { fontSize: '15px', opacity: 0.8, marginBottom: '20px', position: 'relative', zIndex: 1 } }, node.data?.label || 'Partial refund â€” keep your products'),
            React.createElement('div', { style: { display: 'flex', gap: '12px', marginTop: '24px', position: 'relative', zIndex: 1 } },
                React.createElement('button', { style: { flex: 1, padding: '16px 24px', borderRadius: '16px', fontSize: '15px', fontWeight: 700, cursor: 'pointer', background: 'white', color: '#1a365d', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)' } }, 'Accept Offer'),
                React.createElement('button', { style: { flex: 1, padding: '16px 24px', borderRadius: '16px', fontSize: '15px', fontWeight: 700, cursor: 'pointer', background: 'rgba(255,255,255,0.15)', color: 'white', border: '1px solid rgba(255,255,255,0.3)' } }, 'No thanks')
            ),
            React.createElement('div', { style: { fontSize: '13px', opacity: 0.7, marginTop: '16px', position: 'relative', zIndex: 1 } }, 'Reviewed within 1-2 days, then 3-5 days to your account')
          );
        };

        // Render form - matches exact chat app rendering based on formType
        const renderForm = () => {
          const formType = node.data?.formType || '';
          
          // Item Selection form - show product cards (NOT email form!) - matches renderItemCards() in app.js
          if (formType === 'Item Selection') {
            // Sample products for demonstration (matches actual chat app structure)
            const sampleItems = [
              { name: 'PuppyPad Original', variant: 'Large Pack', price: '$49.99', image: 'https://via.placeholder.com/60', selected: false },
              { name: 'PuppyPad 2.0', variant: 'Regular Pack', price: '$39.99', image: 'https://via.placeholder.com/60', selected: true },
              { name: 'Travel Size Pack', variant: 'Small', price: '$19.99', image: 'https://via.placeholder.com/60', selected: false }
            ];
            
            return React.createElement('div', { style: { marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '12px' } },
                sampleItems.map((item, i) => 
                  React.createElement('div', {
                    key: i,
                    style: {
                      background: item.selected ? '#E8EEF4' : 'white',
                      borderRadius: '16px',
                      padding: '14px',
                      display: 'flex',
                      gap: '14px',
                      alignItems: 'center',
                      boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                      marginBottom: '10px',
                      cursor: 'pointer',
                      transition: 'all 0.25s ease',
                      border: item.selected ? '2px solid #1a365d' : '2px solid transparent'
                    },
                    onMouseOver: (e) => {
                      if (!item.selected) {
                        e.currentTarget.style.borderLeft = '4px solid #1a365d';
                        e.currentTarget.style.transform = 'translateX(8px)';
                      }
                    },
                    onMouseOut: (e) => {
                      if (!item.selected) {
                        e.currentTarget.style.borderLeft = '2px solid transparent';
                        e.currentTarget.style.transform = 'translateX(0)';
                      }
                    }
                  },
                    React.createElement('img', { src: item.image, alt: item.name, style: { width: '60px', height: '60px', borderRadius: '12px', objectFit: 'cover', background: '#F3F4F6', flexShrink: 0 } }),
                    React.createElement('div', { style: { flex: 1, minWidth: 0 } },
                      React.createElement('div', { style: { fontWeight: 600, fontSize: '14px', marginBottom: '4px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', color: '#2D3748' } }, item.name),
                      React.createElement('div', { style: { fontSize: '13px', color: '#6B7280', marginBottom: '4px' } }, item.variant),
                      React.createElement('div', { style: { fontWeight: 600, color: '#1a365d', fontSize: '14px' } }, item.price)
                    ),
                    React.createElement('div', { style: { width: '24px', height: '24px', borderRadius: '6px', border: '2px solid #D1D5DB', background: item.selected ? '#1a365d' : 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 } },
                      item.selected && React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'white', strokeWidth: '3' },
                        React.createElement('polyline', { points: '20 6 9 17 4 12' })
                      )
                    )
                  )
                )
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Continue')
            );
          }
          
          // Customer Lookup form - toggle form (email/phone) - matches renderIdentifyForm() in app.js
          // Note: For simulator, showing email mode by default (toggle would require state management)
          // For help/subscription flows, includes First Name field (isTrackFlow = false in app.js)
          if (formType === 'Customer Lookup') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { display: 'flex', background: '#F3F4F6', borderRadius: '9999px', padding: '4px', marginBottom: '20px', position: 'relative' } },
                React.createElement('div', { 
                  style: { 
                    flex: 1, 
                    padding: '12px 24px', 
                    textAlign: 'center', 
                    fontWeight: 700, 
                    fontSize: '14px', 
                    color: 'white', 
                    borderRadius: '9999px', 
                    background: '#1a365d',
                    position: 'relative',
                    zIndex: 1
                  } 
                }, 'Email'),
                React.createElement('div', { 
                  style: { 
                    flex: 1, 
                    padding: '12px 24px', 
                    textAlign: 'center', 
                    fontWeight: 600, 
                    fontSize: '14px', 
                    color: '#9CA3AF', 
                    borderRadius: '9999px', 
                    background: 'transparent',
                    position: 'relative',
                    zIndex: 1
                  } 
                }, 'Phone')
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Email Address *'),
                React.createElement('input', { 
                  type: 'email', 
                  placeholder: 'you@example.com',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'First Name *'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: 'Your first name',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Order Number (optional)'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: '#12345P',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Find My Order')
            );
          }
          
          // Deep Search form - address fields - matches deepSearchForm in app.js exactly
          if (formType === 'Deep Search') {
            // Default fields match app.js renderDeepSearchForm: firstName, lastName, address1 (Street Address), country
            const fields = node.data?.fields || ['firstName', 'lastName', 'address1', 'country'];
            
            // Map field names to display labels (matches app.js labels exactly)
            const getFieldLabel = (field) => {
              if (field === 'firstName') return 'First Name';
              if (field === 'lastName') return 'Last Name';
              if (field === 'address1') return 'Street Address';
              if (field === 'country') return 'Country';
              return field.replace(/([A-Z])/g, ' $1').trim();
            };
            
            // Map field names to placeholders (matches app.js placeholders exactly)
            const getFieldPlaceholder = (field) => {
              if (field === 'firstName') return 'Your first name';
              if (field === 'lastName') return 'Your last name';
              if (field === 'address1') return '123 Main Street';
              if (field === 'country') return 'Select country';
              return \`Enter \${field.replace(/([A-Z])/g, ' $1').toLowerCase()}...\`;
            };
            
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('p', { style: { color: '#718096', marginBottom: '16px', fontSize: '14px', margin: '0 0 16px 0' } }, 'Please provide your shipping address details to help me find your order:'),
              fields.map((field, i) => {
                const isCountry = field === 'country';
                return React.createElement('div', { key: i, style: { marginBottom: '20px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, getFieldLabel(field) + ' *'),
                  isCountry 
                    ? React.createElement('select', { 
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', cursor: 'pointer' },
                        defaultValue: 'US'
                      },
                        React.createElement('option', { value: 'US' }, 'United States'),
                        React.createElement('option', { value: 'CA' }, 'Canada'),
                        React.createElement('option', { value: 'GB' }, 'United Kingdom'),
                        React.createElement('option', { value: 'AU' }, 'Australia')
                      )
                    : React.createElement('input', { 
                        type: 'text', 
                        placeholder: getFieldPlaceholder(field),
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                      })
                );
              }),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Search Again')
            );
          }
          
          // Dog Info Form - matches renderDogInfoForm() in app.js
          if (formType === 'Dog Info Form') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { borderBottom: '1px solid #E5E7EB', paddingBottom: '16px', marginBottom: '20px' } },
                React.createElement('div', { style: { fontSize: '15px', fontWeight: 600, color: '#2D3748', marginBottom: '16px' } }, 'Dog 1'),
                React.createElement('div', { style: { marginBottom: '16px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, "Dog's Name *"),
                  React.createElement('input', { type: 'text', placeholder: 'e.g., Max', style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' } })
                ),
                React.createElement('div', { style: { marginBottom: '16px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Breed *'),
                  React.createElement('input', { type: 'text', placeholder: 'e.g., Golden Retriever', style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' } })
                ),
                React.createElement('div', { style: { marginBottom: '16px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Age *'),
                  React.createElement('input', { type: 'text', placeholder: 'e.g., 2 years', style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' } })
                )
              ),
              React.createElement('button', { style: { width: '100%', padding: '12px 20px', background: '#F9FAFB', color: '#2D3748', border: '1px solid #E5E7EB', borderRadius: '12px', fontSize: '14px', fontWeight: 600, cursor: 'pointer', marginBottom: '16px' } }, '+ Add Another Dog'),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'What have you tried so far?'),
                React.createElement('textarea', { rows: 3, placeholder: "Tell us what methods you've already attempted...", style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', resize: 'vertical', minHeight: '80px' } })
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Get Personalized Tips')
            );
          }
          
          // Pickup Attempt Form - matches submitPickupAttempt() in app.js
          if (formType === 'Pickup Attempt Form') {
            const fields = node.data?.fields || ['pickupDate', 'pickupLocation', 'pickupNotes'];
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              fields.map((field, i) => {
                const isDate = field === 'pickupDate';
                const isTextarea = field === 'pickupNotes';
                const getLabel = (f) => {
                  if (f === 'pickupDate') return 'When did you try to pick it up?';
                  if (f === 'pickupLocation') return 'What location did you go to?';
                  if (f === 'pickupNotes') return 'What did they tell you? (optional)';
                  return f.replace(/([A-Z])/g, ' $1').trim();
                };
                const getPlaceholder = (f) => {
                  if (f === 'pickupLocation') return 'e.g., USPS on Main Street, UPS Store downtown';
                  if (f === 'pickupNotes') return 'e.g., They said they couldn\\'t find it, no record of the package, etc.';
                  return '';
                };
                return React.createElement('div', { key: i, style: { marginBottom: '20px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, getLabel(field)),
                  isDate 
                    ? React.createElement('input', { 
                        type: 'date', 
                        max: new Date().toISOString().split('T')[0],
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                      })
                    : isTextarea
                    ? React.createElement('textarea', { 
                        rows: 2,
                        placeholder: getPlaceholder(field),
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', resize: 'vertical', minHeight: '60px' }
                      })
                    : React.createElement('input', { 
                        type: 'text', 
                        placeholder: getPlaceholder(field),
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                      })
                );
              }),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Submit')
            );
          }

          // Address Form - matches showAddressForm() in app.js with country-specific fields
          if (formType === 'Address Form') {
            const fields = node.data?.fields || ['country', 'address1', 'address2', 'city', 'province', 'zip'];
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Country *'),
                React.createElement('select', { 
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', cursor: 'pointer' },
                  defaultValue: 'United States'
                },
                  React.createElement('option', { value: 'United States' }, 'United States'),
                  React.createElement('option', { value: 'Canada' }, 'Canada'),
                  React.createElement('option', { value: 'United Kingdom' }, 'United Kingdom'),
                  React.createElement('option', { value: 'Australia' }, 'Australia')
                )
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Street Address *'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: '123 Main St',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Apt/Suite/Unit'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: 'Apt 4B',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'City *'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: 'City',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'State *'),
                React.createElement('select', { 
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', cursor: 'pointer' },
                  defaultValue: 'CA'
                },
                  React.createElement('option', { value: 'CA' }, 'California'),
                  React.createElement('option', { value: 'NY' }, 'New York'),
                  React.createElement('option', { value: 'TX' }, 'Texas')
                )
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'ZIP Code *'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: '12345',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Confirm & Reship')
            );
          }

          // Audio Player - matches showSarahVoiceNote() in app.js
          if (formType === 'Audio Player') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' } },
                React.createElement('img', { 
                  src: personas.sarah.avatar, 
                  alt: 'Sarah', 
                  style: { width: '48px', height: '48px', borderRadius: '50%', objectFit: 'cover' } 
                }),
                React.createElement('div', null,
                  React.createElement('div', { style: { fontSize: '15px', fontWeight: 600, color: '#2D3748' } }, 'Sarah'),
                  React.createElement('div', { style: { fontSize: '12px', color: '#718096' } }, 'Customer Experience Lead')
                )
              ),
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: '#F9FAFB', borderRadius: '12px' } },
                React.createElement('button', { 
                  style: { 
                    width: '48px', 
                    height: '48px', 
                    borderRadius: '50%', 
                    background: '#1a365d', 
                    border: 'none', 
                    color: 'white', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    cursor: 'pointer',
                    flexShrink: 0
                  } 
                }, 'â–¶'),
                React.createElement('div', { style: { flex: 1, height: '40px', background: '#E5E7EB', borderRadius: '8px', position: 'relative', overflow: 'hidden' } },
                  React.createElement('div', { style: { display: 'flex', alignItems: 'flex-end', justifyContent: 'space-around', height: '100%', padding: '0 8px', gap: '2px' } },
                    Array.from({ length: 40 }, (_, i) => 
                      React.createElement('div', { 
                        key: i, 
                        style: { 
                          width: '3px', 
                          height: \`\${20 + Math.random() * 60}%\`, 
                          background: '#9CA3AF', 
                          borderRadius: '2px' 
                        } 
                      })
                    )
                  )
                ),
                React.createElement('div', { style: { fontSize: '12px', color: '#718096', minWidth: '40px', textAlign: 'right' } }, '0:00')
              )
            );
          }

          // Satisfaction Buttons - matches showSatisfactionButtons() in app.js
          if (formType === 'Satisfaction Buttons') {
            const options = node.data?.options || ["Yes, I'll try these!", "No, I need more help"];
            return React.createElement('div', { style: { display: 'flex', gap: '12px', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('button', { 
                style: { 
                  flex: 1, 
                  display: 'flex', 
                  flexDirection: 'column', 
                  alignItems: 'center', 
                  justifyContent: 'center',
                  gap: '8px', 
                  padding: '20px 16px', 
                  background: 'white', 
                  border: '2px solid #22c55e', 
                  borderRadius: '16px', 
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                } 
              },
                React.createElement('div', { style: { fontSize: '32px' } }, 'ðŸ˜Š'),
                React.createElement('div', { style: { fontSize: '14px', fontWeight: 600, color: '#22c55e', textAlign: 'center' } }, options[0] || "Yes, I'll try these!")
              ),
              React.createElement('button', { 
                style: { 
                  flex: 1, 
                  display: 'flex', 
                  flexDirection: 'column', 
                  alignItems: 'center', 
                  justifyContent: 'center',
                  gap: '8px', 
                  padding: '20px 16px', 
                  background: 'white', 
                  border: '2px solid #ef4444', 
                  borderRadius: '16px', 
                  cursor: 'pointer',
                  transition: 'all 0.2s ease'
                } 
              },
                React.createElement('div', { style: { fontSize: '32px' } }, 'ðŸ˜”'),
                React.createElement('div', { style: { fontSize: '14px', fontWeight: 600, color: '#ef4444', textAlign: 'center' } }, options[1] || 'No, I need more help')
              )
            );
          }

          // Text Input - matches general text input in app.js
          if (formType === 'Text Input') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, node.data?.label || 'Your message'),
                React.createElement('textarea', { 
                  rows: 4,
                  placeholder: node.data?.placeholder || 'Type your message here...',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', resize: 'vertical', minHeight: '100px' }
                })
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Submit')
            );
          }

          // Photo Upload - matches photo upload in app.js
          if (formType === 'Photo Upload') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { 
                style: { 
                  border: '2px dashed #D1D5DB', 
                  borderRadius: '16px', 
                  padding: '40px 20px', 
                  textAlign: 'center', 
                  background: '#F9FAFB',
                  cursor: 'pointer',
                  marginBottom: '20px'
                } 
              },
                React.createElement('div', { style: { fontSize: '48px', marginBottom: '12px' } }, 'ðŸ“·'),
                React.createElement('div', { style: { fontSize: '15px', fontWeight: 600, color: '#2D3748', marginBottom: '8px' } }, 'Click to upload photos'),
                React.createElement('div', { style: { fontSize: '13px', color: '#6B7280' } }, 'or drag and drop'),
                React.createElement('div', { style: { fontSize: '12px', color: '#9CA3AF', marginTop: '8px' } }, 'PNG, JPG up to 10MB')
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Continue')
            );
          }

          // Quantity Selector - matches quantity input in app.js
          if (formType === 'Quantity Selector') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '12px' } }, node.data?.label || 'Select quantity'),
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '16px', justifyContent: 'center' } },
                  React.createElement('button', { 
                    style: { width: '48px', height: '48px', borderRadius: '50%', border: '2px solid #E5E7EB', background: 'white', fontSize: '24px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#2D3748' } 
                  }, 'âˆ’'),
                  React.createElement('div', { 
                    style: { width: '80px', height: '56px', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '28px', fontWeight: 700, color: '#1a365d', background: '#F3F4F6', borderRadius: '12px' } 
                  }, '1'),
                  React.createElement('button', { 
                    style: { width: '48px', height: '48px', borderRadius: '50%', border: '2px solid #E5E7EB', background: 'white', fontSize: '24px', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#2D3748' } 
                  }, '+')
                ),
                node.data?.max && React.createElement('div', { style: { textAlign: 'center', fontSize: '12px', color: '#6B7280', marginTop: '8px' } }, \`Max: \${node.data.max}\`)
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Continue')
            );
          }

          // Unknown form type - show a helpful message instead of fallback email form
          return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px', textAlign: 'center' } },
            React.createElement('div', { style: { fontSize: '40px', marginBottom: '12px' } }, 'ðŸ“'),
            React.createElement('div', { style: { fontSize: '16px', fontWeight: 600, color: '#2D3748', marginBottom: '8px' } }, formType),
            React.createElement('div', { style: { fontSize: '13px', color: '#6B7280' } }, 'Form preview not yet available'),
            React.createElement('div', { style: { fontSize: '12px', color: '#9CA3AF', marginTop: '8px', fontStyle: 'italic' } }, 'Check app.js for implementation details')
          );
        };

        return React.createElement('div', { 
          style: { 
            position: 'fixed', 
            top: 0, 
            left: 0, 
            right: 0, 
            bottom: 0, 
            background: 'rgba(0,0,0,0.5)', 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center',
            zIndex: 1000,
            backdropFilter: 'blur(4px)'
          },
          onClick: onClose
        },
          React.createElement('div', { 
            style: { 
              width: '420px', 
              maxHeight: '80vh',
              background: '#f8fafc', 
              borderRadius: '24px', 
              overflow: 'hidden',
              boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)'
            },
            onClick: e => e.stopPropagation()
          },
            // Simulator Header
            React.createElement('div', { style: { background: 'white', padding: '16px 20px', borderBottom: '1px solid #e5e7eb', display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
                React.createElement('div', { style: { position: 'relative' } },
                  React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '44px', height: '44px', borderRadius: '50%', objectFit: 'cover', border: '3px solid white', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' } }),
                  React.createElement('div', { style: { position: 'absolute', bottom: '2px', right: '2px', width: '10px', height: '10px', borderRadius: '50%', background: '#22c55e', border: '2px solid white' } })
                ),
                React.createElement('div', null,
                  React.createElement('h1', { style: { fontSize: '16px', fontWeight: 600, margin: 0, color: '#111827' } }, persona.name),
                  React.createElement('div', { style: { fontSize: '12px', color: '#22c55e', display: 'flex', alignItems: 'center', gap: '4px' } },
                    React.createElement('span', { style: { width: '6px', height: '6px', borderRadius: '50%', background: '#22c55e' } }),
                    'Online'
                  )
                )
              ),
              React.createElement('button', { 
                onClick: onClose,
                style: { width: '32px', height: '32px', borderRadius: '50%', background: '#f3f4f6', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', color: '#6b7280' }
              }, 'Ã—')
            ),

            // Chat Preview Area
            React.createElement('div', { style: { padding: '20px', minHeight: '300px', maxHeight: '60vh', overflowY: 'auto' } },
              // Render based on node type
              (node.type === 'message' || node.type === 'ai') && renderMessage(),
              node.type === 'options' && React.createElement('div', null, 
                // Render prompt as Amy's message bubble first (matches actual chat app - addBotMessage first, then addOptions)
                node.data?.prompt && React.createElement('div', { style: { marginBottom: '8px' } },
                  React.createElement('div', { style: { display: 'flex', gap: '12px', maxWidth: '85%' } },
                    React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover', flexShrink: 0, marginTop: '4px' } }),
                    React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px' } },
                      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px' } },
                        React.createElement('span', { style: { fontWeight: 600, color: '#2D3748' } }, persona.name),
                        React.createElement('span', { style: { color: '#718096', fontWeight: 400 } }, persona.role)
                      ),
                      React.createElement('div', { style: { padding: '14px 18px', background: 'white', borderRadius: '16px', borderBottomLeftRadius: '6px', border: '1px solid rgba(0, 0, 0, 0.08)', fontSize: '15px', lineHeight: '1.5', color: '#2D3748' } }, 
                        node.data.prompt
                      )
                    )
                  )
                ),
                renderOptions()
              ),
              node.type === 'offer' && React.createElement('div', null,
                React.createElement('div', { style: { display: 'flex', gap: '12px', maxWidth: '85%', marginBottom: '16px' } },
                  React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover', flexShrink: 0 } }),
                  React.createElement('div', { style: { padding: '14px 18px', background: 'white', borderRadius: '16px', borderBottomLeftRadius: '6px', border: '1px solid rgba(0, 0, 0, 0.08)', fontSize: '15px', lineHeight: '1.5' } }, 
                    node.data?.message || "I'd like to offer you a partial refund while you keep the product."
                  )
                ),
                renderOffer()
              ),
              node.type === 'form' && React.createElement('div', null, 
                // Render label/prompt as Amy's message bubble first (matches actual chat app - addBotMessage first, then addInteractiveContent)
                // Customer Lookup: NO message bubble (form appears directly after welcome message)
                (() => {
                  const formType = node.data?.formType || '';
                  // Customer Lookup should NOT show a message bubble - form appears directly after welcome
                  if (formType === 'Customer Lookup') {
                    return null;
                  }
                  const formMessage = FORM_MESSAGES[formType] || node.data?.label || '';
                  // For Item Selection, use the exact message from chat app; for others, use label if no specific message
                  const messageToShow = formType === 'Item Selection' ? FORM_MESSAGES['Item Selection'] : 
                                       formType === 'Deep Search' ? FORM_MESSAGES['Deep Search'] :
                                       formMessage || '';
                  return messageToShow ? renderMessageBubble(messageToShow) : null;
                })(),
                renderForm()
              )
            ),

            // Simulator Footer
            React.createElement('div', { style: { padding: '12px 16px', borderTop: '1px solid #e5e7eb', background: 'white', textAlign: 'center' } },
              React.createElement('span', { style: { fontSize: '11px', color: '#718096' } }, 'ðŸ” Simulator Preview â€” This is how the node appears in the chat app')
            )
          )
        );
      };

      // ============================================
      // MAIN APP COMPONENT
      // ============================================
      const FlowDocsApp = () => {
        const [selectedParent, setSelectedParent] = useState(FLOW_DATA.parentFlows[0]);
        const [selectedSubflow, setSelectedSubflow] = useState(null);
        const [viewingEntry, setViewingEntry] = useState(true);
        const [selectedNode, setSelectedNode] = useState(null);
        const [simulatorNode, setSimulatorNode] = useState(null);

        // Get current flow data
        const currentFlow = viewingEntry 
          ? { id: 'entry', name: 'Entry Flow', nodes: selectedParent.entryNodes, edges: selectedParent.entryEdges }
          : selectedSubflow;

        const [nodes, setNodes, onNodesChange] = useNodesState(currentFlow?.nodes || []);
        const [edges, setEdges, onEdgesChange] = useEdgesState(currentFlow?.edges || []);

        // API base URL (same pattern as hub-app.js)
        const getApiBase = () => {
          const hostname = window.location.hostname;
          if (hostname.includes('pages.dev') || hostname.includes('pages.cloudflare.com')) {
            return 'https://puppypad-resolution-worker.gulfam.workers.dev';
          }
          return '';
        };

        const API_BASE = getApiBase();

        // Load saved positions from API
        const loadSavedPositions = async (flowId, defaultNodes) => {
          try {
            const token = localStorage.getItem('hub_token') || '';
            const response = await fetch(\`\${API_BASE}/hub/api/flow-positions/\${flowId}\`, {
              headers: {
                'Authorization': \`Bearer \${token}\`
              }
            });
            const data = await response.json();
            
            if (data.success && data.positions) {
              return defaultNodes.map(node => {
                const savedPos = data.positions[node.id];
                if (savedPos) {
                  return { ...node, position: savedPos };
                }
                return node;
              });
            }
          } catch (e) {
            console.warn('Failed to load saved positions:', e);
          }
          return defaultNodes;
        };

        // Save positions to API
        const savePositions = async (flowId, nodes) => {
          try {
            const positions = {};
            nodes.forEach(node => {
              if (node.position) {
                positions[node.id] = node.position;
              }
            });

            const user = JSON.parse(localStorage.getItem('hub_user') || '{}');
            const token = localStorage.getItem('hub_token') || '';
            
            await fetch(\`\${API_BASE}/hub/api/flow-positions/\${flowId}\`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': \`Bearer \${token}\`
              },
              body: JSON.stringify({ 
                positions,
                user: user.email || user.name || 'unknown'
              })
            });
          } catch (e) {
            console.warn('Failed to save positions:', e);
          }
        };

        // Reset layout (clear saved positions)
        const resetLayout = useCallback(async () => {
          if (currentFlow?.id) {
            try {
              const token = localStorage.getItem('hub_token') || '';
              await fetch(\`\${API_BASE}/hub/api/flow-positions/\${currentFlow.id}\`, {
                method: 'DELETE',
                headers: {
                  'Authorization': \`Bearer \${token}\`
                }
              });
              
              // Reload nodes with original positions
              const originalNodes = viewingEntry 
                ? selectedParent.entryNodes 
                : selectedSubflow?.nodes || [];
              setNodes(originalNodes);
            } catch (e) {
              console.error('Failed to reset layout:', e);
            }
          }
        }, [currentFlow?.id, viewingEntry, selectedParent, selectedSubflow]);

        // Update nodes when flow changes - load saved positions if available
        useEffect(() => {
          if (currentFlow) {
            const loadFlow = async () => {
              const originalNodes = currentFlow.nodes || [];
              const nodesWithSavedPositions = await loadSavedPositions(currentFlow.id, originalNodes);
              setNodes(nodesWithSavedPositions);
              setEdges(currentFlow.edges || []);
              setSelectedNode(null);
            };
            loadFlow();
          }
        }, [currentFlow?.id, viewingEntry, selectedSubflow?.id]);

        // Save positions when nodes are dragged (debounced)
        useEffect(() => {
          if (currentFlow?.id && nodes.length > 0) {
            const timeoutId = setTimeout(() => {
              savePositions(currentFlow.id, nodes);
            }, 500); // Debounce saves by 500ms
            return () => clearTimeout(timeoutId);
          }
        }, [nodes, currentFlow?.id]);

        const handleSelectParent = (parent) => {
          setSelectedParent(parent);
        };

        const handleSelectSubflow = (subflow) => {
          setSelectedSubflow(subflow);
          setViewingEntry(false);
        };

        const handleSelectEntry = () => {
          setSelectedSubflow(null);
          setViewingEntry(true);
        };

        const onNodeClick = useCallback((event, node) => {
          setSelectedNode(node);
          // If clicking a subflow node, navigate to that subflow
          if (node.type === 'subflow' && node.data?.slug) {
            const subflow = FLOW_DATA.subflows[node.data.slug];
            if (subflow) {
              setSelectedSubflow(subflow);
              setViewingEntry(false);
            }
          }
        }, []);

        const handleSimulate = useCallback((node) => {
          setSimulatorNode(node);
        }, []);

        const handleCloseSimulator = useCallback(() => {
          setSimulatorNode(null);
        }, []);

        const defaultEdgeOptions = {
          type: 'smoothstep',
          animated: true,
          style: { strokeWidth: 2, stroke: '#94a3b8' },
          markerEnd: { type: MarkerType.ArrowClosed, color: '#94a3b8' }
        };

        return React.createElement('div', { style: { display: 'flex', height: '100vh' } },
          // Left Panel - Flow Navigation
          React.createElement(FlowNavigationPanel, {
            parentFlows: FLOW_DATA.parentFlows,
            subflows: FLOW_DATA.subflows,
            selectedParentId: selectedParent?.id,
            selectedSubflowId: selectedSubflow?.id,
            viewingEntry: viewingEntry,
            onSelectParent: handleSelectParent,
            onSelectSubflow: handleSelectSubflow,
            onSelectEntry: handleSelectEntry
          }),
          
          // Center - React Flow Canvas
          React.createElement('div', { style: { flex: 1, background: 'linear-gradient(135deg, #fef7f0 0%, #fdf2f8 25%, #f5f3ff 50%, #eff6ff 75%, #f0fdf4 100%)' } },
            React.createElement(ReactFlowComponent, {
              nodes: nodes,
              edges: edges,
              onNodesChange: onNodesChange,
              onEdgesChange: onEdgesChange,
              onNodeClick: onNodeClick,
              nodeTypes: nodeTypes,
              defaultEdgeOptions: defaultEdgeOptions,
              nodesDraggable: true,
              fitView: true,
              fitViewOptions: { padding: 0.3 },
              minZoom: 0.1,
              maxZoom: 2
            },
              React.createElement(Background, { variant: 'dots', gap: 20, size: 1, color: '#e2e8f0' }),
              React.createElement(Controls, null),
              React.createElement('div', {
                style: {
                  position: 'absolute',
                  top: 10,
                  right: 10,
                  zIndex: 5
                }
              },
                React.createElement('button', {
                  onClick: resetLayout,
                  style: {
                    padding: '8px 16px',
                    background: '#ef4444',
                    color: 'white',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: 500,
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                  }
                }, 'Reset Layout')
              ),
              React.createElement(MiniMap, { 
                nodeColor: (n) => nodeColors[n.type] || '#94a3b8',
                maskColor: 'rgba(255,255,255,0.8)'
              })
            )
          ),
          
          // Right Panel - Node Properties
          React.createElement(NodePropertiesPanel, { 
            selectedNode: selectedNode,
            onSimulate: handleSimulate
          }),

          // Chat Simulator Modal
          simulatorNode && React.createElement(ChatSimulator, {
            node: simulatorNode,
            onClose: handleCloseSimulator
          })
        );
      };

      // Mount the app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(FlowDocsApp));
    })();
  </script>
</body>
</html>
`;
}

