<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Flow Documentation | PuppyPad Resolution Hub</title>
  
  <!-- Fonts -->
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=Space+Grotesk:wght@500;600;700&display=swap" rel="stylesheet">
  
  <!-- React 18 -->
  <script crossorigin src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script crossorigin src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  
  <!-- React Flow v11 -->
  <script src="https://unpkg.com/reactflow@11.10.4/dist/umd/index.js"></script>
  <link rel="stylesheet" href="https://unpkg.com/reactflow@11.10.4/dist/style.css">
  
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }
    
    body {
      font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif;
      background: #f8fafc;
      min-height: 100vh;
    }
    
    h1, h2, h3, h4 {
      font-family: 'Space Grotesk', sans-serif;
    }
    
    #root {
      height: 100vh;
    }
    
    /* React Flow handle styling */
    .react-flow__handle {
      width: 10px !important;
      height: 10px !important;
      border-radius: 50% !important;
      border: 2px solid white !important;
      box-shadow: 0 1px 3px rgba(0,0,0,0.2) !important;
    }
    
    .react-flow__handle-top {
      top: -5px !important;
    }
    
    .react-flow__handle-bottom {
      bottom: -5px !important;
    }
    
    .react-flow__edge-path {
      stroke-width: 2px;
    }
    
    .react-flow__edge.animated path {
      stroke-dasharray: 5;
      animation: dashdraw 0.5s linear infinite;
    }
    
    @keyframes dashdraw {
      from { stroke-dashoffset: 10; }
      to { stroke-dashoffset: 0; }
    }
    
    .react-flow__background {
      background-color: transparent !important;
    }
    
    .react-flow__minimap {
      background: rgba(255,255,255,0.9) !important;
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
    }
    
    .react-flow__controls {
      background: rgba(255,255,255,0.95);
      border-radius: 8px;
      box-shadow: 0 4px 12px rgba(0,0,0,0.1);
      border: 1px solid #e5e7eb;
    }
    
    .react-flow__controls-button {
      background: white;
      border-bottom: 1px solid #e5e7eb;
    }
    
    .react-flow__controls-button:hover {
      background: #f9fafb;
    }

    /* Flow card styles */
    .flow-card {
      background: white;
      border-radius: 12px;
      border: 1px solid #e5e7eb;
      padding: 14px 16px;
      cursor: pointer;
      transition: all 0.2s ease;
      margin-bottom: 8px;
    }
    
    .flow-card:hover {
      border-color: #c7d2fe;
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.1);
      transform: translateY(-1px);
    }
    
    .flow-card.active {
      border-color: #818cf8;
      background: linear-gradient(135deg, #eef2ff 0%, #faf5ff 100%);
      box-shadow: 0 4px 12px rgba(99, 102, 241, 0.15);
    }
    
    .flow-card.parent {
      background: linear-gradient(135deg, #f8fafc 0%, #f1f5f9 100%);
    }
    
    .flow-card.parent:hover {
      background: linear-gradient(135deg, #f1f5f9 0%, #e2e8f0 100%);
    }
  </style>
</head>
<body>
  <div id="root"></div>
  
  <script>
    (function() {
      const { useState, useCallback, useEffect, useMemo } = React;
      const { 
        ReactFlow: ReactFlowComponent, 
        Controls, 
        Background, 
        MiniMap,
        useNodesState, 
        useEdgesState,
        Handle,
        Position,
        MarkerType
      } = window.ReactFlow;

      // ============================================
      // SVG ICONS
      // ============================================
      const Icons = {
        Play: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'currentColor', stroke: 'none' },
          React.createElement('polygon', { points: '5 3 19 12 5 21 5 3' })
        ),
        MessageSquare: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M21 15a2 2 0 0 1-2 2H7l-4 4V5a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2z' })
        ),
        List: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('line', { x1: 8, y1: 6, x2: 21, y2: 6 }),
          React.createElement('line', { x1: 8, y1: 12, x2: 21, y2: 12 }),
          React.createElement('line', { x1: 8, y1: 18, x2: 21, y2: 18 }),
          React.createElement('line', { x1: 3, y1: 6, x2: 3.01, y2: 6 }),
          React.createElement('line', { x1: 3, y1: 12, x2: 3.01, y2: 12 }),
          React.createElement('line', { x1: 3, y1: 18, x2: 3.01, y2: 18 })
        ),
        GitBranch: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('line', { x1: 6, y1: 3, x2: 6, y2: 15 }),
          React.createElement('circle', { cx: 18, cy: 6, r: 3 }),
          React.createElement('circle', { cx: 6, cy: 18, r: 3 }),
          React.createElement('path', { d: 'M18 9a9 9 0 0 1-9 9' })
        ),
        Zap: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polygon', { points: '13 2 3 14 12 14 11 22 21 10 12 10 13 2' })
        ),
        Bot: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('rect', { x: 3, y: 11, width: 18, height: 10, rx: 2 }),
          React.createElement('circle', { cx: 12, cy: 5, r: 2 }),
          React.createElement('path', { d: 'M12 7v4' }),
          React.createElement('line', { x1: 8, y1: 16, x2: 8, y2: 16 }),
          React.createElement('line', { x1: 16, y1: 16, x2: 16, y2: 16 })
        ),
        Gift: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polyline', { points: '20 12 20 22 4 22 4 12' }),
          React.createElement('rect', { x: 2, y: 7, width: 20, height: 5 }),
          React.createElement('line', { x1: 12, y1: 22, x2: 12, y2: 7 }),
          React.createElement('path', { d: 'M12 7H7.5a2.5 2.5 0 0 1 0-5C11 2 12 7 12 7z' }),
          React.createElement('path', { d: 'M12 7h4.5a2.5 2.5 0 0 0 0-5C13 2 12 7 12 7z' })
        ),
        FolderOpen: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M22 19a2 2 0 0 1-2 2H4a2 2 0 0 1-2-2V5a2 2 0 0 1 2-2h5l2 3h9a2 2 0 0 1 2 2z' }),
          React.createElement('path', { d: 'M2 10h20' })
        ),
        FileText: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M14 2H6a2 2 0 0 0-2 2v16a2 2 0 0 0 2 2h12a2 2 0 0 0 2-2V8z' }),
          React.createElement('polyline', { points: '14 2 14 8 20 8' }),
          React.createElement('line', { x1: 16, y1: 13, x2: 8, y2: 13 }),
          React.createElement('line', { x1: 16, y1: 17, x2: 8, y2: 17 }),
          React.createElement('polyline', { points: '10 9 9 9 8 9' })
        ),
        Flag: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M4 15s1-1 4-1 5 2 8 2 4-1 4-1V3s-1 1-4 1-5-2-8-2-4 1-4 1z' }),
          React.createElement('line', { x1: 4, y1: 22, x2: 4, y2: 15 })
        ),
        ArrowLeft: () => React.createElement('svg', { width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('line', { x1: 19, y1: 12, x2: 5, y2: 12 }),
          React.createElement('polyline', { points: '12 19 5 12 12 5' })
        ),
        ChevronRight: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polyline', { points: '9 18 15 12 9 6' })
        ),
        ChevronDown: () => React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polyline', { points: '6 9 12 15 18 9' })
        ),
        Eye: () => React.createElement('svg', { width: 18, height: 18, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('path', { d: 'M1 12s4-8 11-8 11 8 11 8-4 8-11 8-11-8-11-8z' }),
          React.createElement('circle', { cx: 12, cy: 12, r: 3 })
        ),
        Layers: () => React.createElement('svg', { width: 16, height: 16, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2, strokeLinecap: 'round', strokeLinejoin: 'round' },
          React.createElement('polygon', { points: '12 2 2 7 12 12 22 7 12 2' }),
          React.createElement('polyline', { points: '2 17 12 22 22 17' }),
          React.createElement('polyline', { points: '2 12 12 17 22 12' })
        )
      };

      // Node colors - expanded for new node types
      const nodeColors = {
        start: '#22c55e',
        message: '#3b82f6',
        options: '#8b5cf6',
        condition: '#f59e0b',
        api: '#ec4899',
        ai: '#6366f1',
        offer: '#14b8a6',
        case: '#f97316',
        form: '#10b981',
        end: '#ef4444',
        subflow: '#8b5cf6',
        timeCheck: '#0ea5e9',
        guaranteeCheck: '#8b5cf6',
        managerDelay: '#f97316',
        evidence: '#06b6d4',
        tracking: '#0284c7',
        input: '#10b981',
        delay: '#f59e0b'
      };

      // ============================================
      // COMPREHENSIVE FLOW DATA - All 3 Parent Flows + 11 Intent Subflows
      // ============================================
      // ‚ö†Ô∏è SYNC REMINDER: This data must match app.js exactly!
      // - Messages must match message text in app.js functions
      // - Form fields must match form rendering in app.js
      // - Persona roles must match PERSONAS constant in app.js
      // - See SYNC_CHECKLIST.md for update instructions
      // ============================================
      const FLOW_DATA = {
        parentFlows: [
          { 
            id: 'help_with_order', 
            name: 'Help With My Order', 
            icon: 'üí¨',
            color: '#8b5cf6', 
            description: 'Customer needs assistance with an existing order - refunds, returns, issues',
            subflows: ['dog_not_using', 'changed_mind', 'not_met_expectations', 'ordered_mistake', 'missing_item', 'wrong_item', 'damaged', 'charged_unexpectedly', 'not_received', 'quality_difference', 'other_reason', 'change_order'],
            entryNodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Customer clicks Help With Order' } },
              { id: 'msg1', type: 'message', position: { x: 450, y: 120 }, data: { persona: 'amy', content: "Hi! I'm Amy from PuppyPad. I can sort this out with you right here so you don't have to go back and forth over email. Just enter your details below. üôÇ" } },
              { id: 'form1', type: 'form', position: { x: 450, y: 320 }, data: { formType: 'Customer Lookup', label: 'Email or Order Number', fields: ['email', 'orderNumber'] } },
              { id: 'api1', type: 'api', position: { x: 450, y: 480 }, data: { service: 'Shopify', endpoint: '/api/lookup', description: 'Find customer orders by email or order number', request: '{ email, orderNumber }', response: '{ orders[], customer }' } },
              { id: 'cond1', type: 'condition', position: { x: 450, y: 640 }, data: { variable: 'orders.length', operator: '>', value: '0', yesLabel: 'Found', noLabel: 'Not Found' } },
              { id: 'api_check_case', type: 'api', position: { x: 250, y: 820 }, data: { service: 'Backend', endpoint: '/api/check-case', description: 'Check for existing open case (deduplication)', request: '{ orderNumber, email }', response: '{ existingCase: boolean, caseId?, caseUrl? }' } },
              { id: 'cond_existing_case', type: 'condition', position: { x: 250, y: 1000 }, data: { variable: 'existingCase.existingCase', operator: '===', value: 'true', yesLabel: 'Case exists', noLabel: 'No case' } },
              { id: 'msg_existing_case', type: 'message', position: { x: 50, y: 1180 }, data: { persona: 'amy', content: "I see you already have an open case for this order! You can view it in the Resolution Hub: <a href=\"{{caseUrl}}\" target=\"_blank\">View Case {{caseId}}</a><br><br>Is there something else I can help you with?" } },
              { id: 'cond_can_modify', type: 'condition', position: { x: 250, y: 1180 }, data: { variable: 'selectedOrder.canModify', operator: '===', value: 'true', yesLabel: 'Unfulfilled (<10h)', noLabel: 'Fulfilled or >10h' } },
              { id: 'itemSelect', type: 'form', position: { x: 250, y: 1360 }, data: { formType: 'Item Selection', label: 'Which items need help?', description: 'Customer selects affected items from their order' } },
              { id: 'deepSearch', type: 'form', position: { x: 650, y: 820 }, data: { formType: 'Deep Search', label: 'More details needed', fields: ['firstName', 'lastName', 'address1', 'country'] } },
              { id: 'msg_unfulfilled', type: 'message', position: { x: 50, y: 1360 }, data: { persona: 'amy', content: "Great news! Your order hasn't shipped yet, so I can still make changes. Would you like to change or cancel your order?" } },
              { id: 'opts_unfulfilled', type: 'options', position: { x: 50, y: 1540 }, data: { prompt: 'What would you like to do?', options: [{ label: "Change my order", icon: 'üîÑ' }, { label: "Cancel my order", icon: '‚ùå' }, { label: "Actually, keep it as is", icon: '‚úÖ' }] } },
              { id: 'subflow_change_order', type: 'subflow', position: { x: -150, y: 1720 }, data: { name: 'Change Order', slug: 'change_order', nodeCount: 8 } },
              { id: 'msg_cancel_reason', type: 'message', position: { x: 150, y: 1720 }, data: { persona: 'amy', content: "I'll help you cancel. Can you tell me why you'd like to cancel?" } },
              { id: 'opts_cancel_intent', type: 'options', position: { x: 150, y: 1900 }, data: { prompt: 'Why would you like to cancel?', options: [{ label: "My dog isn't using it", icon: 'üêï' }, { label: 'I changed my mind', icon: 'üí≠' }, { label: "It didn't meet expectations", icon: 'üòï' }, { label: 'Ordered by mistake', icon: 'üîÑ' }, { label: 'Other reason', icon: '‚ùì' }] } },
              { id: 'end_keep_order', type: 'end', position: { x: 250, y: 1720 }, data: { title: 'Order Kept', showSurvey: false } },
              { id: 'opts1', type: 'options', position: { x: 250, y: 1540 }, data: { prompt: "Got it! What's going on with your order?", options: [
                { label: "My dog isn't using it", icon: 'üêï' },
                { label: 'I changed my mind', icon: 'üí≠' },
                { label: "It didn't meet expectations", icon: 'üòï' },
                { label: 'Ordered by mistake', icon: 'üîÑ' },
                { label: 'Something was missing', icon: 'üì¶' },
                { label: 'Wrong item received', icon: 'üîÄ' },
                { label: 'Order arrived damaged', icon: 'üíî' },
                { label: 'Charged unexpectedly', icon: 'üí≥' },
                { label: "Haven't received order", icon: 'üöö' },
                { label: 'Quality difference', icon: 'üîç' },
                { label: 'Other reason', icon: '‚ùì' }
              ] } },
              { id: 'sub1', type: 'subflow', position: { x: -200, y: 1250 }, data: { name: 'Dog Not Using', slug: 'dog_not_using', nodeCount: 12 } },
              { id: 'sub2', type: 'subflow', position: { x: 50, y: 1250 }, data: { name: 'Changed Mind', slug: 'changed_mind', nodeCount: 15 } },
              { id: 'sub3', type: 'subflow', position: { x: 300, y: 1250 }, data: { name: 'Not Met Expectations', slug: 'not_met_expectations', nodeCount: 10 } },
              { id: 'sub4', type: 'subflow', position: { x: 550, y: 1250 }, data: { name: 'Ordered Mistake', slug: 'ordered_mistake', nodeCount: 8 } },
              { id: 'sub5', type: 'subflow', position: { x: 800, y: 1250 }, data: { name: 'Missing Item', slug: 'missing_item', nodeCount: 9 } },
              { id: 'sub6', type: 'subflow', position: { x: -200, y: 1450 }, data: { name: 'Wrong Item', slug: 'wrong_item', nodeCount: 10 } },
              { id: 'sub7', type: 'subflow', position: { x: 50, y: 1450 }, data: { name: 'Damaged', slug: 'damaged', nodeCount: 11 } },
              { id: 'sub8', type: 'subflow', position: { x: 300, y: 1450 }, data: { name: 'Charged Unexpectedly', slug: 'charged_unexpectedly', nodeCount: 22 } },
              { id: 'sub9', type: 'subflow', position: { x: 550, y: 1450 }, data: { name: 'Not Received', slug: 'not_received', nodeCount: 14 } },
              { id: 'sub10', type: 'subflow', position: { x: 800, y: 1450 }, data: { name: 'Quality Difference', slug: 'quality_difference', nodeCount: 8 } },
              { id: 'sub11', type: 'subflow', position: { x: 300, y: 1650 }, data: { name: 'Other Reason', slug: 'other_reason', nodeCount: 6 } },
              { id: 'sub12', type: 'subflow', position: { x: -150, y: 1900 }, data: { name: 'Change Order', slug: 'change_order', nodeCount: 8 } }
            ],
            entryEdges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'api1', animated: true },
              { id: 'e4', source: 'api1', target: 'cond1', animated: true },
              { id: 'e5', source: 'cond1', target: 'api_check_case', sourceHandle: 'yes', label: 'Orders found', animated: true },
              { id: 'e6', source: 'cond1', target: 'deepSearch', sourceHandle: 'no', label: 'Not found', animated: true },
              { id: 'e7', source: 'api_check_case', target: 'cond_existing_case', animated: true },
              { id: 'e8', source: 'cond_existing_case', target: 'msg_existing_case', sourceHandle: 'yes', label: 'Case exists', animated: true },
              { id: 'e9', source: 'cond_existing_case', target: 'cond_can_modify', sourceHandle: 'no', label: 'No case', animated: true },
              { id: 'e10', source: 'cond_can_modify', target: 'msg_unfulfilled', sourceHandle: 'yes', label: 'Unfulfilled (<10h)', animated: true },
              { id: 'e11', source: 'cond_can_modify', target: 'itemSelect', sourceHandle: 'no', label: 'Fulfilled or >10h', animated: true },
              { id: 'e12', source: 'msg_unfulfilled', target: 'opts_unfulfilled', animated: true },
              { id: 'e13', source: 'opts_unfulfilled', target: 'subflow_change_order', sourceHandle: 'opt-0', label: 'Change order', animated: true },
              { id: 'e14', source: 'opts_unfulfilled', target: 'msg_cancel_reason', sourceHandle: 'opt-1', label: 'Cancel order', animated: true },
              { id: 'e15', source: 'opts_unfulfilled', target: 'end_keep_order', sourceHandle: 'opt-2', label: 'Keep it', animated: true },
              { id: 'e16', source: 'msg_cancel_reason', target: 'opts_cancel_intent', animated: true },
              { id: 'e17', source: 'opts_cancel_intent', target: 'sub1', sourceHandle: 'opt-0', label: 'Dog not using', animated: true },
              { id: 'e18', source: 'opts_cancel_intent', target: 'sub2', sourceHandle: 'opt-1', label: 'Changed mind', animated: true },
              { id: 'e19', source: 'opts_cancel_intent', target: 'sub3', sourceHandle: 'opt-2', label: 'Not met expectations', animated: true },
              { id: 'e20', source: 'opts_cancel_intent', target: 'sub4', sourceHandle: 'opt-3', label: 'Ordered mistake', animated: true },
              { id: 'e21', source: 'opts_cancel_intent', target: 'sub11', sourceHandle: 'opt-4', label: 'Other reason', animated: true },
              { id: 'e22', source: 'itemSelect', target: 'opts1', animated: true },
              { id: 'e23', source: 'deepSearch', target: 'api1', label: 'Retry search', animated: true },
              { id: 'e24', source: 'subflow_change_order', target: 'sub12', animated: true },
              { id: 'e25', source: 'opts1', target: 'sub1', label: 'Dog not using', animated: true },
              { id: 'e26', source: 'opts1', target: 'sub2', label: 'Changed mind', animated: true },
              { id: 'e27', source: 'opts1', target: 'sub3', label: 'Not met expectations', animated: true },
              { id: 'e28', source: 'opts1', target: 'sub4', label: 'Ordered mistake', animated: true },
              { id: 'e29', source: 'opts1', target: 'sub5', label: 'Missing item', animated: true },
              { id: 'e30', source: 'opts1', target: 'sub6', label: 'Wrong item', animated: true },
              { id: 'e31', source: 'opts1', target: 'sub7', label: 'Damaged', animated: true },
              { id: 'e32', source: 'opts1', target: 'sub8', label: 'Charged', animated: true },
              { id: 'e33', source: 'opts1', target: 'sub9', label: 'Not received', animated: true },
              { id: 'e34', source: 'opts1', target: 'sub10', label: 'Quality', animated: true },
              { id: 'e35', source: 'opts1', target: 'sub11', label: 'Other', animated: true }
            ]
          },
          { 
            id: 'track_order', 
            name: 'Track My Order', 
            icon: 'üì¶',
            color: '#3b82f6', 
            description: 'Customer wants to check order status and tracking information',
            subflows: ['tracking_flow'],
            entryNodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Customer clicks Track Order' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Hi! I'm Amy. Let me help you track your order ‚Äî just enter your details below and I'll pull it right up. üì¶" } },
              { id: 'sub1', type: 'subflow', position: { x: 350, y: 330 }, data: { name: 'Order Tracking Flow', slug: 'tracking_flow', nodeCount: 45 } }
            ],
            entryEdges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'sub1', animated: true }
            ]
          },
          { 
            id: 'manage_subscription', 
            name: 'Manage My Subscription', 
            icon: 'üîÑ',
            color: '#10b981', 
            description: 'Customer wants to pause, cancel, or modify their subscription',
            subflows: ['pause_subscription', 'cancel_subscription', 'change_frequency'],
            entryNodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Customer clicks Manage Subscription' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Hi! I'm Amy. I'll help you manage your subscription ‚Äî just enter your details below to get started. üîÑ" } },
              { id: 'form1', type: 'form', position: { x: 350, y: 330 }, data: { formType: 'Customer Lookup', label: 'Find Your Subscription' } },
              { id: 'api1', type: 'api', position: { x: 350, y: 490 }, data: { service: 'Shopify', endpoint: '/api/subscriptions', description: 'Find active subscriptions', request: '{ email }', response: '{ subscriptions[] }' } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 670 }, data: { prompt: 'What would you like to do with your subscription?', options: [{ label: 'Pause subscription', icon: '‚è∏Ô∏è' }, { label: 'Cancel subscription', icon: '‚ùå' }, { label: 'Change frequency', icon: 'üìÖ' }] } },
              { id: 'sub1', type: 'subflow', position: { x: 100, y: 900 }, data: { name: 'Pause Subscription', slug: 'pause_subscription', nodeCount: 6 } },
              { id: 'sub2', type: 'subflow', position: { x: 350, y: 900 }, data: { name: 'Cancel Subscription', slug: 'cancel_subscription', nodeCount: 12 } },
              { id: 'sub3', type: 'subflow', position: { x: 600, y: 900 }, data: { name: 'Change Frequency', slug: 'change_frequency', nodeCount: 7 } }
            ],
            entryEdges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'api1', animated: true },
              { id: 'e4', source: 'api1', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'sub1', sourceHandle: 'opt-0', label: 'Pause', animated: true },
              { id: 'e6', source: 'opts1', target: 'sub2', sourceHandle: 'opt-1', label: 'Cancel', animated: true },
              { id: 'e7', source: 'opts1', target: 'sub3', sourceHandle: 'opt-2', label: 'Change', animated: true }
            ]
          }
        ],
        subflows: {
          // DOG NOT USING - Claudia AI Tips Flow
          dog_not_using: {
            id: 'dog_not_using',
            parentId: 'help_with_order',
            name: 'Dog Not Using Product',
            description: 'Customer reports their dog is not using the PuppyPad - handled by trainer Claudia with personalized tips',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Dog Not Using Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I understand ‚Äî the main reason you purchased this was to solve your problem, and we want to make sure it works for you! üêï<br><br>Let me get some details about your pup so we can help." } },
              { id: 'form1', type: 'form', position: { x: 350, y: 350 }, data: { formType: 'Dog Info Form', label: 'Tell us about your dog', fields: ['dogName', 'dogBreed', 'dogAge', 'methodsTried'] } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 530 }, data: { persona: 'amy', content: "Thanks for sharing! I'm connecting you with our dog trainer, Claudia. She's amazing at this! üêæ‚ù§Ô∏è" } },
              { id: 'ai1', type: 'ai', position: { x: 350, y: 730 }, data: { 
                persona: 'claudia', 
                model: 'gpt-4o',
                temperature: 0.75,
                maxTokens: 1000,
                scenarioType: 'dog_tips',
                systemPrompt: "You are Claudia, a compassionate dog trainer who specializes in dog behavior. The PuppyPad is infused with pheromones that naturally attract dogs. Give breed-specific and age-appropriate advice. ALWAYS use the dog's actual name throughout.",
                userPromptTemplate: "Dog: {{dogName}} ({{dogBreed}}, {{dogAge}}). What they've tried: {{methodsTried}}. Write warm HTML response with personalized tips."
              } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 950 }, data: { prompt: 'Did the tips help?', options: [{ label: "Yes, I'll try them!", icon: '‚ú®' }, { label: 'Still having issues', icon: 'üòî' }] } },
              { id: 'msg3', type: 'message', position: { x: 100, y: 1150 }, data: { persona: 'claudia', content: "That's great to hear! üéâ Give it a go and remember ‚Äî consistency is key. You've got this!" } },
              { id: 'end1', type: 'end', position: { x: 100, y: 1330 }, data: { title: 'Tips Accepted!', showSurvey: true } },
              { id: 'api1', type: 'api', position: { x: 600, y: 1150 }, data: { service: 'Shopify', endpoint: '/api/guarantee/check', description: 'Check 90-day guarantee status' } },
              { id: 'cond1', type: 'condition', position: { x: 600, y: 1330 }, data: { variable: 'guaranteeActive', operator: '===', value: 'true', yesLabel: 'Active', noLabel: 'Expired' } },
              { id: 'offer1', type: 'offer', position: { x: 450, y: 1530 }, data: { percent: 30, label: 'Keep product & try tips', needsManagerApproval: false } },
              { id: 'msg4', type: 'message', position: { x: 750, y: 1530 }, data: { persona: 'amy', content: "I understand the 90-day guarantee has expired, but I still want to help. Let me create a case for our team to review." } },
              { id: 'case1', type: 'case', position: { x: 450, y: 1730 }, data: { type: 'refund', subtype: 'dog_not_using', priority: 'normal' } },
              { id: 'end2', type: 'end', position: { x: 550, y: 1930 }, data: { title: 'Case Created', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'ai1', animated: true },
              { id: 'e5', source: 'ai1', target: 'opts1', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg3', sourceHandle: 'opt-0', label: 'Tips helped', animated: true },
              { id: 'e7', source: 'opts1', target: 'api1', sourceHandle: 'opt-1', label: 'Still issues', animated: true },
              { id: 'e8', source: 'msg3', target: 'end1', animated: true },
              { id: 'e9', source: 'api1', target: 'cond1', animated: true },
              { id: 'e10', source: 'cond1', target: 'offer1', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e11', source: 'cond1', target: 'msg4', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e12', source: 'offer1', target: 'case1', animated: true },
              { id: 'e13', source: 'msg4', target: 'case1', animated: true },
              { id: 'e14', source: 'case1', target: 'end2', animated: true }
            ]
          },

          // CHANGED MIND - AI Persuasion + Refund Ladder
          changed_mind: {
            id: 'changed_mind',
            parentId: 'help_with_order',
            name: 'Changed My Mind',
            description: 'Customer wants a refund - AI persuasion followed by 20%‚Üí30%‚Üí40%‚Üí50% refund ladder',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Changed Mind Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I understand, and I appreciate you being upfront about it. Can you tell me a bit more about why you changed your mind? I'd love to help if I can!" } },
              { id: 'input1', type: 'form', position: { x: 350, y: 350 }, data: { formType: 'Text Input', label: 'Tell us more...', placeholder: 'What made you change your mind?' } },
              { id: 'ai1', type: 'ai', position: { x: 350, y: 530 }, data: { 
                persona: 'amy', 
                model: 'gpt-4o-mini',
                temperature: 0.7,
                maxTokens: 800,
                scenarioType: 'changed_mind',
                systemPrompt: "You are Amy, a warm customer support specialist. Identify WHY they changed their mind (pet loss, dog trained, impulse buy, too many, found elsewhere, moving, timing, financial, misunderstood, vague). Respond appropriately to each reason. Be warm but don't mention refunds.",
                userPromptTemplate: "Customer: {{customerName}}. Their message: {{customerMessage}}. Products ordered: {{orderItems}}"
              } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 750 }, data: { prompt: 'Does this help? Would you like to keep your order?', options: [{ label: "Yes, I'll keep it!", icon: '‚ú®' }, { label: "No, I'd like a refund", icon: 'üí∞' }] } },
              { id: 'end1', type: 'end', position: { x: 100, y: 950 }, data: { title: 'Kept Order!', showSurvey: true } },
              { id: 'api1', type: 'api', position: { x: 600, y: 950 }, data: { service: 'Shopify', endpoint: '/api/guarantee/check', description: 'Validate 90-day guarantee' } },
              { id: 'cond1', type: 'condition', position: { x: 600, y: 1130 }, data: { variable: 'guaranteeActive', operator: '===', value: 'true', yesLabel: '‚úì Active', noLabel: '‚úó Expired' } },
              { id: 'offer1', type: 'offer', position: { x: 400, y: 1350 }, data: { percent: 20, label: 'Keep product', message: "As a valued customer, I'd like to offer you a 20% partial refund while you keep the product.", needsManagerApproval: false } },
              { id: 'offer2', type: 'offer', position: { x: 400, y: 1570 }, data: { percent: 30, label: 'Keep product', message: "I really want to make this right. Let me offer you a 30% refund.", needsManagerApproval: false } },
              { id: 'delay1', type: 'delay', position: { x: 400, y: 1790 }, data: { duration: 8000, message: 'Checking with manager...', description: '8 second delay to simulate manager approval' } },
              { id: 'offer3', type: 'offer', position: { x: 400, y: 1990 }, data: { percent: 40, label: 'Keep product', message: "Great news! My manager has approved a 40% refund for you.", needsManagerApproval: true } },
              { id: 'delay2', type: 'delay', position: { x: 400, y: 2210 }, data: { duration: 8000, message: 'Final check with manager...', description: '8 second delay' } },
              { id: 'offer4', type: 'offer', position: { x: 400, y: 2410 }, data: { percent: 50, label: 'Keep product', message: "Maximum offer: 50% refund. This is the very best we can do.", needsManagerApproval: true, isFinal: true } },
              { id: 'case1', type: 'case', position: { x: 150, y: 2610 }, data: { type: 'refund', subtype: 'partial_accept', priority: 'normal' } },
              { id: 'case2', type: 'case', position: { x: 650, y: 2610 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'msg2', type: 'message', position: { x: 800, y: 1350 }, data: { persona: 'amy', content: "I'm sorry, but our 90-day guarantee has expired for this order. However, I've created a case for our team to review your situation." } },
              { id: 'case3', type: 'case', position: { x: 800, y: 1550 }, data: { type: 'refund', subtype: 'expired_review', priority: 'low' } },
              { id: 'end2', type: 'end', position: { x: 400, y: 2810 }, data: { title: 'Refund Processed', showSurvey: true } },
              { id: 'end3', type: 'end', position: { x: 800, y: 1750 }, data: { title: 'Case Created', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'input1', animated: true },
              { id: 'e3', source: 'input1', target: 'ai1', animated: true },
              { id: 'e4', source: 'ai1', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'end1', sourceHandle: 'opt-0', label: 'Keep order', animated: true },
              { id: 'e6', source: 'opts1', target: 'api1', sourceHandle: 'opt-1', label: 'Want refund', animated: true },
              { id: 'e7', source: 'api1', target: 'cond1', animated: true },
              { id: 'e8', source: 'cond1', target: 'offer1', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e9', source: 'cond1', target: 'msg2', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e10', source: 'offer1', target: 'case1', sourceHandle: 'accept', label: 'Accept 20%', animated: true },
              { id: 'e11', source: 'offer1', target: 'offer2', sourceHandle: 'decline', label: 'Decline', animated: true },
              { id: 'e12', source: 'offer2', target: 'case1', sourceHandle: 'accept', label: 'Accept 30%', animated: true },
              { id: 'e13', source: 'offer2', target: 'delay1', sourceHandle: 'decline', label: 'Decline', animated: true },
              { id: 'e14', source: 'delay1', target: 'offer3', animated: true },
              { id: 'e15', source: 'offer3', target: 'case1', sourceHandle: 'accept', label: 'Accept 40%', animated: true },
              { id: 'e16', source: 'offer3', target: 'delay2', sourceHandle: 'decline', label: 'Decline', animated: true },
              { id: 'e17', source: 'delay2', target: 'offer4', animated: true },
              { id: 'e18', source: 'offer4', target: 'case1', sourceHandle: 'accept', label: 'Accept 50%', animated: true },
              { id: 'e19', source: 'offer4', target: 'case2', sourceHandle: 'decline', label: 'Full refund', animated: true },
              { id: 'e20', source: 'case1', target: 'end2', animated: true },
              { id: 'e21', source: 'case2', target: 'end2', animated: true },
              { id: 'e22', source: 'msg2', target: 'case3', animated: true },
              { id: 'e23', source: 'case3', target: 'end3', animated: true }
            ]
          },

          // NOT MET EXPECTATIONS - Similar to Changed Mind
          not_met_expectations: {
            id: 'not_met_expectations',
            parentId: 'help_with_order',
            name: 'Not Met Expectations',
            description: 'Customer disappointed with product - AI response then refund ladder',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Not Met Expectations' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I'm really sorry to hear that üòî We always want our products to exceed expectations. Could you share what specifically didn't meet your expectations?" } },
              { id: 'input1', type: 'form', position: { x: 350, y: 350 }, data: { formType: 'Text Input', label: 'What disappointed you?' } },
              { id: 'ai1', type: 'ai', position: { x: 350, y: 530 }, data: { persona: 'amy', model: 'gpt-4o-mini', scenarioType: 'changed_mind', systemPrompt: 'Respond to customer disappointment with empathy and product benefits' } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 730 }, data: { prompt: 'Does this help at all?', options: [{ label: "Yes, I'll give it another try" }, { label: "No, I'd like a refund" }] } },
              { id: 'end1', type: 'end', position: { x: 100, y: 930 }, data: { title: 'Giving it another try!', showSurvey: true } },
              { id: 'subflow1', type: 'subflow', position: { x: 600, y: 930 }, data: { name: 'Refund Ladder', slug: 'refund_ladder_internal', description: 'Continue to 20%‚Üí30%‚Üí40%‚Üí50% ladder' } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'input1', animated: true },
              { id: 'e3', source: 'input1', target: 'ai1', animated: true },
              { id: 'e4', source: 'ai1', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'end1', sourceHandle: 'opt-0', animated: true },
              { id: 'e6', source: 'opts1', target: 'subflow1', sourceHandle: 'opt-1', animated: true }
            ]
          },

          // ORDERED BY MISTAKE
          ordered_mistake: {
            id: 'ordered_mistake',
            parentId: 'help_with_order',
            name: 'Ordered by Mistake',
            description: 'Customer accidentally ordered - can change or cancel',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Ordered by Mistake' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "No worries! Would you like to change your order to something else, or would you prefer a refund?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 350 }, data: { prompt: 'What would you like to do?', options: [{ label: 'Change my order', icon: 'üîÑ' }, { label: 'I want a refund', icon: 'üí∞' }] } },
              { id: 'msg2', type: 'message', position: { x: 100, y: 550 }, data: { persona: 'amy', content: "Great! Let me help you modify your order. What would you like to change it to?" } },
              { id: 'case1', type: 'case', position: { x: 100, y: 750 }, data: { type: 'order_change', priority: 'normal' } },
              { id: 'end1', type: 'end', position: { x: 100, y: 950 }, data: { title: 'Order Change Requested', showSurvey: true } },
              { id: 'subflow1', type: 'subflow', position: { x: 600, y: 550 }, data: { name: 'Refund Ladder', slug: 'changed_mind', description: 'Go through refund ladder' } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e3', source: 'opts1', target: 'msg2', sourceHandle: 'opt-0', label: 'Change order', animated: true },
              { id: 'e4', source: 'opts1', target: 'subflow1', sourceHandle: 'opt-1', label: 'Want refund', animated: true },
              { id: 'e5', source: 'msg2', target: 'case1', animated: true },
              { id: 'e6', source: 'case1', target: 'end1', animated: true }
            ]
          },

          // MISSING ITEM
          missing_item: {
            id: 'missing_item',
            parentId: 'help_with_order',
            name: 'Missing Item',
            description: 'Something was missing from the order - evidence upload then reship offer',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Missing Item Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Oh no, I'm so sorry to hear that! üòî Let me help you get this sorted out. Which item(s) were missing from your order?" } },
              { id: 'form1', type: 'form', position: { x: 350, y: 350 }, data: { formType: 'Item Selection', label: 'Select missing items' } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 530 }, data: { persona: 'amy', content: "Got it. Could you upload a photo of what you received? This helps us investigate what happened." } },
              { id: 'evidence1', type: 'form', position: { x: 350, y: 730 }, data: { formType: 'Photo Upload', label: 'Upload photo of package/items received', acceptTypes: 'image/*' } },
              { id: 'msg3', type: 'message', position: { x: 350, y: 930 }, data: { persona: 'amy', content: "Thank you! I've noted everything down. To make things right, we'd love to reship the missing items to you... and as an apology for the trouble, we'll include an extra item on us!" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 1150 }, data: { prompt: 'Would you like us to go ahead with this?', options: [{ label: 'Yes, send my missing items', icon: 'üì¶' }, { label: "No, I'd like a different solution", icon: 'üîÑ' }] } },
              { id: 'case1', type: 'case', position: { x: 100, y: 1370 }, data: { type: 'reship', subtype: 'missing_item', priority: 'high', includeBonus: true } },
              { id: 'end1', type: 'end', position: { x: 100, y: 1570 }, data: { title: 'Reship Ordered!', showSurvey: true } },
              { id: 'msg4', type: 'message', position: { x: 600, y: 1370 }, data: { persona: 'amy', content: "No problem! We can provide a refund for the missing items instead. Our team will calculate the refund based on what was missing." } },
              { id: 'case2', type: 'case', position: { x: 600, y: 1570 }, data: { type: 'refund', subtype: 'missing_item_refund', priority: 'normal' } },
              { id: 'end2', type: 'end', position: { x: 600, y: 1770 }, data: { title: 'Refund Case Created', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'evidence1', animated: true },
              { id: 'e5', source: 'evidence1', target: 'msg3', animated: true },
              { id: 'e6', source: 'msg3', target: 'opts1', animated: true },
              { id: 'e7', source: 'opts1', target: 'case1', sourceHandle: 'opt-0', label: 'Reship', animated: true },
              { id: 'e8', source: 'opts1', target: 'msg4', sourceHandle: 'opt-1', label: 'Different solution', animated: true },
              { id: 'e9', source: 'case1', target: 'end1', animated: true },
              { id: 'e10', source: 'msg4', target: 'case2', animated: true },
              { id: 'e11', source: 'case2', target: 'end2', animated: true }
            ]
          },

          // WRONG ITEM
          wrong_item: {
            id: 'wrong_item',
            parentId: 'help_with_order',
            name: 'Wrong Item Received',
            description: 'Customer received wrong item - evidence upload then exchange/refund',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Wrong Item Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I'm so sorry about that mix-up! üòî Could you tell me what you received versus what you ordered?" } },
              { id: 'form1', type: 'form', position: { x: 350, y: 350 }, data: { formType: 'Text Input', label: 'Describe what you received' } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 530 }, data: { persona: 'amy', content: "Got it. Please upload a photo of what you received so we can verify and fix this quickly." } },
              { id: 'evidence1', type: 'form', position: { x: 350, y: 730 }, data: { formType: 'Photo Upload', label: 'Upload photo of received item' } },
              { id: 'msg3', type: 'message', position: { x: 350, y: 930 }, data: { persona: 'amy', content: "Thank you! We'll ship out the correct item right away. You can keep the wrong item ‚Äî no need to return it!" } },
              { id: 'case1', type: 'case', position: { x: 350, y: 1130 }, data: { type: 'reship', subtype: 'wrong_item', priority: 'high', keepWrongItem: true } },
              { id: 'end1', type: 'end', position: { x: 350, y: 1330 }, data: { title: 'Correct Item Shipping!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'evidence1', animated: true },
              { id: 'e5', source: 'evidence1', target: 'msg3', animated: true },
              { id: 'e6', source: 'msg3', target: 'case1', animated: true },
              { id: 'e7', source: 'case1', target: 'end1', animated: true }
            ]
          },

          // DAMAGED
          damaged: {
            id: 'damaged',
            parentId: 'help_with_order',
            name: 'Order Arrived Damaged',
            description: 'Package or product arrived damaged - evidence required',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Damaged Order Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Oh no, I'm so sorry your order arrived damaged! üíî That's definitely not the experience we want for you. Can you upload some photos of the damage?" } },
              { id: 'evidence1', type: 'form', position: { x: 350, y: 370 }, data: { formType: 'Photo Upload', label: 'Upload photos of damage', description: 'Photos of package and/or product damage', multiple: true } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 570 }, data: { persona: 'amy', content: "Thank you for those photos. I've documented everything. Would you like us to send a replacement, or would you prefer a refund?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 790 }, data: { prompt: 'How would you like us to resolve this?', options: [{ label: 'Send a replacement', icon: 'üì¶' }, { label: 'Process a refund', icon: 'üí∞' }] } },
              { id: 'case1', type: 'case', position: { x: 100, y: 1010 }, data: { type: 'reship', subtype: 'damaged', priority: 'high' } },
              { id: 'case2', type: 'case', position: { x: 600, y: 1010 }, data: { type: 'refund', subtype: 'damaged', priority: 'high' } },
              { id: 'end1', type: 'end', position: { x: 350, y: 1210 }, data: { title: 'Case Created', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'evidence1', animated: true },
              { id: 'e3', source: 'evidence1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'case1', sourceHandle: 'opt-0', label: 'Replacement', animated: true },
              { id: 'e6', source: 'opts1', target: 'case2', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              { id: 'e7', source: 'case1', target: 'end1', animated: true },
              { id: 'e8', source: 'case2', target: 'end1', animated: true }
            ]
          },

          // CHARGED UNEXPECTEDLY - Full Branching
          charged_unexpectedly: {
            id: 'charged_unexpectedly',
            parentId: 'help_with_order',
            name: 'Charged Unexpectedly',
            description: 'Customer was charged when they didn\'t expect it - full branching with delivery status checks',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Unexpected Charge Flow' } },
              { id: 'msg1', type: 'message', position: { x: 500, y: 120 }, data: { persona: 'amy', content: "I completely understand ‚Äî unexpected charges can be confusing! üí≥<br><br>This can happen for a few reasons: sometimes a family member places an order as a gift, it could be a subscription renewal you forgot about, or perhaps an order from a while back that slipped your mind.<br><br>Either way, I'm here to help sort this out for you! Let me pull up your order details." } },
              { id: 'api1', type: 'api', position: { x: 500, y: 300 }, data: { service: 'Shopify', endpoint: '/api/orders/recent-charges', description: 'Look up recent charges for customer', request: '{ email }', response: '{ orders[] }' } },
              { id: 'msg2', type: 'message', position: { x: 500, y: 480 }, data: { persona: 'amy', content: "Here's what I found:<br><br><strong>Order:</strong> {{orderNumber}}<br><strong>Date:</strong> {{orderDate}}<br><strong>Total Charged:</strong> {{totalPrice}}<br><br><strong>Items:</strong><br>{{itemsList}}<br><br>Is this the charge you're referring to?" } },
              { id: 'opts1', type: 'options', position: { x: 500, y: 680 }, data: { prompt: 'Is this the charge?', options: [{ label: "Yes, this is it", icon: '‚úÖ' }, { label: "No, I don't recognize this", icon: '‚ùå' }] } },
              
              // Confirmed branch
              { id: 'msg3', type: 'message', position: { x: 300, y: 880 }, data: { persona: 'amy', content: "Got it! So you see the order, but you're saying you didn't place it yourself?<br><br>No worries ‚Äî like I mentioned, this could be a family member, a gift, or maybe even an accidental order. Let me check a few things..." } },
              { id: 'api2', type: 'api', position: { x: 300, y: 1060 }, data: { service: 'ParcelPanel', endpoint: '/api/tracking', description: 'Check delivery status', request: '{ orderNumber }', response: '{ tracking, status }' } },
              { id: 'cond1', type: 'condition', position: { x: 300, y: 1240 }, data: { variable: 'tracking.status', operator: 'includes', value: 'delivered', yesLabel: 'Delivered', noLabel: 'Not Delivered' } },
              
              // Delivered branch
              { id: 'msg4', type: 'message', position: { x: 100, y: 1420 }, data: { persona: 'amy', content: "I can see this order has been <strong>delivered</strong>! üì¶<br><br>Here's what I can do: since you have the products, would you like to keep them and I'll give you a <strong>20% refund ({{refundAmount20}})</strong> for all this confusion?<br><br>That way you get some money back and can still enjoy the products!" } },
              { id: 'offer1_delivered', type: 'offer', position: { x: 100, y: 1620 }, data: { percent: 20, label: 'Keep products + 20% refund', message: "20% refund for confusion - keep the products" } },
              { id: 'opts_delivered', type: 'options', position: { x: 100, y: 1820 }, data: { prompt: 'What would you like to do?', options: [{ label: "Accept 20% refund", icon: '‚úÖ' }, { label: "I'd like a higher refund", icon: 'üí∞' }] } },
              { id: 'case_partial_20_delivered', type: 'case', position: { x: -100, y: 2020 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'subflow_refund_ladder_delivered', type: 'subflow', position: { x: 100, y: 2020 }, data: { name: 'Order Refund Ladder', slug: 'order_refund_ladder', nodeCount: 10, startStep: 1 } },
              
              // Not Delivered branch
              { id: 'msg5', type: 'message', position: { x: 500, y: 1420 }, data: { persona: 'amy', content: "I see this order hasn't been delivered yet! üì¶<br><br>Here's what I can do: I'll give you a <strong>20% refund ({{refundAmount20}})</strong> for all this confusion, and you can keep the order when it arrives. What do you think?" } },
              { id: 'offer1_not_delivered', type: 'offer', position: { x: 500, y: 1620 }, data: { percent: 20, label: 'Keep order when arrives + 20% refund', message: "20% refund for confusion - keep order when it arrives" } },
              { id: 'opts_not_delivered', type: 'options', position: { x: 500, y: 1820 }, data: { prompt: 'What would you like to do?', options: [{ label: "Accept 20% refund", icon: '‚úÖ' }, { label: "I'd like a higher refund", icon: 'üí∞' }] } },
              { id: 'case_partial_20_not_delivered', type: 'case', position: { x: 300, y: 2020 }, data: { type: 'refund', subtype: 'partial_20', priority: 'normal' } },
              { id: 'subflow_refund_ladder_not_delivered', type: 'subflow', position: { x: 500, y: 2020 }, data: { name: 'Order Refund Ladder', slug: 'order_refund_ladder', nodeCount: 10, startStep: 1 } },
              
              // Not Recognized branch
              { id: 'msg6', type: 'message', position: { x: 700, y: 880 }, data: { persona: 'amy', content: "I understand ‚Äî it can be confusing when you don't recognize a charge! ü§î<br><br>Here's the thing: our system doesn't store payment details or allow manual charges, so this order was definitely placed through our website. It could be:<br><br>‚Ä¢ A family member or friend ordered for you as a surprise üéÅ<br>‚Ä¢ You might have ordered a while back and forgot<br>‚Ä¢ Someone in your household made a purchase<br><br>But don't worry ‚Äî I'm here to help either way! Let me tell you about what's actually in this order..." } },
              { id: 'api3', type: 'api', position: { x: 700, y: 1060 }, data: { service: 'AI', endpoint: '/api/ai-response', description: 'Generate product benefits pitch', request: '{ scenarioType: "product_benefits_pitch", products, productSkus }', response: '{ messages[] }' } },
              { id: 'msg7', type: 'message', position: { x: 700, y: 1240 }, data: { persona: 'amy', content: "{{aiGeneratedProductPitch}}" } },
              { id: 'opts_not_recognized', type: 'options', position: { x: 700, y: 1420 }, data: { prompt: 'What would you like to do?', options: [{ label: "I'll keep the order", icon: '‚úÖ' }, { label: "I still want a refund", icon: 'üí∞' }] } },
              { id: 'end_keep_order', type: 'end', position: { x: 500, y: 1620 }, data: { title: 'Order Kept', showSurvey: true } },
              { id: 'subflow_refund_ladder_not_recognized', type: 'subflow', position: { x: 900, y: 1620 }, data: { name: 'Order Refund Ladder', slug: 'order_refund_ladder', nodeCount: 10 } },
              
              // End nodes
              { id: 'end_partial_refund', type: 'end', position: { x: -100, y: 2220 }, data: { title: 'Partial Refund Processed', showSurvey: true } },
              { id: 'end_refund_ladder', type: 'end', position: { x: 100, y: 2220 }, data: { title: 'Refund Processed', showSurvey: true } },
              { id: 'end_partial_not_delivered', type: 'end', position: { x: 300, y: 2220 }, data: { title: 'Partial Refund Processed', showSurvey: true } },
              { id: 'end_refund_ladder_not_delivered', type: 'end', position: { x: 500, y: 2220 }, data: { title: 'Refund Processed', showSurvey: true } },
              { id: 'end_refund_not_recognized', type: 'end', position: { x: 900, y: 1820 }, data: { title: 'Refund Processed', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'api1', animated: true },
              { id: 'e3', source: 'api1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'msg3', sourceHandle: 'opt-0', label: 'Yes, this is it', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg6', sourceHandle: 'opt-1', label: "No, don't recognize", animated: true },
              
              // Confirmed branch
              { id: 'e7', source: 'msg3', target: 'api2', animated: true },
              { id: 'e8', source: 'api2', target: 'cond1', animated: true },
              { id: 'e9', source: 'cond1', target: 'msg4', sourceHandle: 'yes', label: 'Delivered', animated: true },
              { id: 'e10', source: 'cond1', target: 'msg5', sourceHandle: 'no', label: 'Not delivered', animated: true },
              
              // Delivered branch
              { id: 'e11', source: 'msg4', target: 'offer1_delivered', animated: true },
              { id: 'e12', source: 'offer1_delivered', target: 'opts_delivered', animated: true },
              { id: 'e13', source: 'opts_delivered', target: 'case_partial_20_delivered', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e14', source: 'opts_delivered', target: 'subflow_refund_ladder_delivered', sourceHandle: 'opt-1', label: 'Higher refund', animated: true },
              { id: 'e15', source: 'case_partial_20_delivered', target: 'end_partial_refund', animated: true },
              { id: 'e16', source: 'subflow_refund_ladder_delivered', target: 'end_refund_ladder', animated: true },
              
              // Not Delivered branch
              { id: 'e17', source: 'msg5', target: 'offer1_not_delivered', animated: true },
              { id: 'e18', source: 'offer1_not_delivered', target: 'opts_not_delivered', animated: true },
              { id: 'e19', source: 'opts_not_delivered', target: 'case_partial_20_not_delivered', sourceHandle: 'opt-0', label: 'Accept 20%', animated: true },
              { id: 'e20', source: 'opts_not_delivered', target: 'subflow_refund_ladder_not_delivered', sourceHandle: 'opt-1', label: 'Higher refund', animated: true },
              { id: 'e21', source: 'case_partial_20_not_delivered', target: 'end_partial_not_delivered', animated: true },
              { id: 'e22', source: 'subflow_refund_ladder_not_delivered', target: 'end_refund_ladder_not_delivered', animated: true },
              
              // Not Recognized branch
              { id: 'e23', source: 'msg6', target: 'api3', animated: true },
              { id: 'e24', source: 'api3', target: 'msg7', animated: true },
              { id: 'e25', source: 'msg7', target: 'opts_not_recognized', animated: true },
              { id: 'e26', source: 'opts_not_recognized', target: 'end_keep_order', sourceHandle: 'opt-0', label: 'Keep order', animated: true },
              { id: 'e27', source: 'opts_not_recognized', target: 'subflow_refund_ladder_not_recognized', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              { id: 'e28', source: 'subflow_refund_ladder_not_recognized', target: 'end_refund_not_recognized', animated: true }
            ]
          },

          // NOT RECEIVED - With Shipping Ladder
          not_received: {
            id: 'not_received',
            parentId: 'help_with_order',
            name: 'Haven\'t Received Order',
            description: 'Order not received - check tracking then shipping ladder (refund + reship)',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Not Received Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Let me check the tracking status for your order..." } },
              { id: 'api1', type: 'api', position: { x: 350, y: 330 }, data: { service: 'ParcelPanel', endpoint: '/api/tracking', description: 'Get real-time tracking status' } },
              { id: 'cond1', type: 'condition', position: { x: 350, y: 510 }, data: { variable: 'trackingStatus', operator: '===', value: 'delivered', yesLabel: 'Delivered', noLabel: 'In Transit' } },
              { id: 'msg2', type: 'message', position: { x: 100, y: 730 }, data: { persona: 'amy', content: "I can see this order has been delivered! üì¶ Since you have the products, would you like to keep them and I'll give you a 20% refund for all this confusion?" } },
              { id: 'msg3', type: 'message', position: { x: 600, y: 730 }, data: { persona: 'amy', content: "I see this order hasn't been delivered yet! üì¶ Here's what I can do: I'll give you a 20% refund for all this confusion, and you can keep the order when it arrives." } },
              { id: 'offer1', type: 'offer', position: { x: 350, y: 950 }, data: { percent: 20, label: 'Keep product + reship', message: "20% refund PLUS we'll reship your order free of charge!" } },
              { id: 'offer2', type: 'offer', position: { x: 350, y: 1170 }, data: { percent: 30, label: 'Keep product + reship', message: "30% refund AND a free reship." } },
              { id: 'delay1', type: 'delay', position: { x: 350, y: 1390 }, data: { duration: 8000, message: 'Checking with manager...' } },
              { id: 'offer3', type: 'offer', position: { x: 350, y: 1590 }, data: { percent: 40, label: 'Keep product + reship', message: "Manager approved: 40% refund PLUS a free reship!", needsManagerApproval: true } },
              { id: 'delay2', type: 'delay', position: { x: 350, y: 1810 }, data: { duration: 8000, message: 'Final manager check...' } },
              { id: 'offer4', type: 'offer', position: { x: 350, y: 2010 }, data: { percent: 50, label: 'Maximum offer + reship', message: "Maximum offer: 50% refund PLUS a free reship!", needsManagerApproval: true, isFinal: true } },
              { id: 'case1', type: 'case', position: { x: 100, y: 2210 }, data: { type: 'shipping', subtype: 'partial_refund_reship', priority: 'normal' } },
              { id: 'case2', type: 'case', position: { x: 600, y: 2210 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'end1', type: 'end', position: { x: 350, y: 2410 }, data: { title: 'Resolution Complete', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'api1', animated: true },
              { id: 'e3', source: 'api1', target: 'cond1', animated: true },
              { id: 'e4', source: 'cond1', target: 'msg2', sourceHandle: 'yes', label: 'Delivered', animated: true },
              { id: 'e5', source: 'cond1', target: 'msg3', sourceHandle: 'no', label: 'Not delivered', animated: true },
              { id: 'e6', source: 'msg2', target: 'offer1', animated: true },
              { id: 'e7', source: 'msg3', target: 'offer1', animated: true },
              { id: 'e8', source: 'offer1', target: 'case1', sourceHandle: 'accept', label: 'Accept', animated: true },
              { id: 'e9', source: 'offer1', target: 'offer2', sourceHandle: 'decline', label: 'Decline', animated: true },
              { id: 'e10', source: 'offer2', target: 'case1', sourceHandle: 'accept', animated: true },
              { id: 'e11', source: 'offer2', target: 'delay1', sourceHandle: 'decline', animated: true },
              { id: 'e12', source: 'delay1', target: 'offer3', animated: true },
              { id: 'e13', source: 'offer3', target: 'case1', sourceHandle: 'accept', animated: true },
              { id: 'e14', source: 'offer3', target: 'delay2', sourceHandle: 'decline', animated: true },
              { id: 'e15', source: 'delay2', target: 'offer4', animated: true },
              { id: 'e16', source: 'offer4', target: 'case1', sourceHandle: 'accept', animated: true },
              { id: 'e17', source: 'offer4', target: 'case2', sourceHandle: 'decline', label: 'Full refund', animated: true },
              { id: 'e18', source: 'case1', target: 'end1', animated: true },
              { id: 'e19', source: 'case2', target: 'end1', animated: true }
            ]
          },

          // QUALITY DIFFERENCE
          quality_difference: {
            id: 'quality_difference',
            parentId: 'help_with_order',
            name: 'Quality Difference',
            description: 'Customer notices quality or material differences from previous orders',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Quality Difference Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I'm sorry to hear you noticed a difference! We take quality very seriously. Can you tell me what seems different?" } },
              { id: 'form1', type: 'form', position: { x: 350, y: 370 }, data: { formType: 'Text Input', label: 'Describe the quality difference' } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 570 }, data: { persona: 'amy', content: "Thank you for that feedback. Could you upload some photos so our quality team can take a look?" } },
              { id: 'evidence1', type: 'form', position: { x: 350, y: 790 }, data: { formType: 'Photo Upload', label: 'Upload comparison photos' } },
              { id: 'case1', type: 'case', position: { x: 350, y: 990 }, data: { type: 'quality', subtype: 'quality_difference', priority: 'high' } },
              { id: 'msg3', type: 'message', position: { x: 350, y: 1190 }, data: { persona: 'amy', content: "Thanks for those photos. I've created a priority case for our quality team to review. They'll get back to you within 1-2 business days." } },
              { id: 'end1', type: 'end', position: { x: 350, y: 1390 }, data: { title: 'Quality Review Requested', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'evidence1', animated: true },
              { id: 'e5', source: 'evidence1', target: 'case1', animated: true },
              { id: 'e6', source: 'case1', target: 'msg3', animated: true },
              { id: 'e7', source: 'msg3', target: 'end1', animated: true }
            ]
          },

          // OTHER REASON
          other_reason: {
            id: 'other_reason',
            parentId: 'help_with_order',
            name: 'Other Reason',
            description: 'Customer has a different issue - free text then refund ladder',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Other Reason Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "No problem ‚Äî tell me what's going on and I'll do my best to help:" } },
              { id: 'input1', type: 'form', position: { x: 350, y: 350 }, data: { formType: 'Text Input', label: 'Describe your issue...', placeholder: 'Tell us what happened' } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 550 }, data: { persona: 'amy', content: "Thank you for explaining. Let me see what options I have for you." } },
              { id: 'subflow1', type: 'subflow', position: { x: 350, y: 750 }, data: { name: 'Refund Ladder', slug: 'changed_mind', description: '20% ‚Üí 30% ‚Üí 40% ‚Üí 50% ladder' } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'input1', animated: true },
              { id: 'e3', source: 'input1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'subflow1', animated: true }
            ]
          },

          // TRACKING FLOW
          tracking_flow: {
            id: 'tracking_flow',
            parentId: 'track_order',
            name: 'Order Tracking Flow',
            description: 'Customer lookup ‚Üí Shopify API ‚Üí ParcelPanel tracking ‚Üí Status-based conditionals with time windows',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Tracking Flow' } },
              { id: 'form1', type: 'form', position: { x: 500, y: 120 }, data: { formType: 'Customer Lookup', label: 'Find Your Order', fields: ['email', 'orderNumber'] } },
              { id: 'api1', type: 'api', position: { x: 500, y: 300 }, data: { service: 'Shopify', endpoint: '/api/lookup', description: 'Find customer orders', request: '{ email, orderNumber }', response: '{ orders[], fulfillments[] }' } },
              { id: 'cond1', type: 'condition', position: { x: 500, y: 480 }, data: { variable: 'orders.length', operator: '>', value: '0', yesLabel: 'Found', noLabel: 'Not Found' } },
              { id: 'api2', type: 'api', position: { x: 300, y: 680 }, data: { service: 'ParcelPanel', endpoint: '/api/tracking', description: 'Get real-time tracking from carriers', request: '{ trackingNumber }', response: '{ status, daysInTransit, isInternational, location, estimatedDelivery, events[] }' } },
              { id: 'cond2', type: 'condition', position: { x: 300, y: 860 }, data: { variable: 'tracking.status', operator: '===', value: 'delivered', yesLabel: 'Delivered', noLabel: 'Other Status' } },
              { id: 'cond3', type: 'condition', position: { x: 100, y: 1040 }, data: { variable: 'tracking.status', operator: '===', value: 'in_transit', yesLabel: 'In Transit', noLabel: 'Other' } },
              { id: 'cond4', type: 'condition', position: { x: 100, y: 1220 }, data: { variable: 'tracking.daysInTransit', operator: '>=', value: '15', yesLabel: '15+ days', noLabel: '<15 days' } },
              { id: 'cond5', type: 'condition', position: { x: -100, y: 1400 }, data: { variable: 'tracking.daysInTransit', operator: '>=', value: '6', yesLabel: '6-14 days', noLabel: '0-5 days' } },
              { id: 'cond6', type: 'condition', position: { x: 100, y: 1040 }, data: { variable: 'tracking.status', operator: '===', value: 'out_for_delivery', yesLabel: 'Out for Delivery', noLabel: 'Other' } },
              { id: 'cond7', type: 'condition', position: { x: 100, y: 1040 }, data: { variable: 'tracking.status', operator: '===', value: 'pending', yesLabel: 'Pending', noLabel: 'Other' } },
              { id: 'cond8', type: 'condition', position: { x: 100, y: 1040 }, data: { variable: 'tracking.status', operator: '===', value: 'failed_attempt', yesLabel: 'Failed Attempt', noLabel: 'Other' } },
              { id: 'cond9', type: 'condition', position: { x: 100, y: 1040 }, data: { variable: 'tracking.status', operator: 'includes', value: 'pickup', yesLabel: 'Pickup', noLabel: 'Other' } },
              { id: 'cond10', type: 'condition', position: { x: 100, y: 1040 }, data: { variable: 'tracking.status', operator: '===', value: 'exception', yesLabel: 'Exception', noLabel: 'Other' } },
              
              // Delivered branch
              { id: 'msg_delivered', type: 'message', position: { x: 100, y: 1220 }, data: { persona: 'amy', content: "According to tracking, your order was delivered on <strong>{{deliveryDate}}</strong>.<br><br>Before we investigate, could you please double-check these common locations?<br><br>‚Ä¢ <strong>Neighbors</strong> - Sometimes packages are left next door<br>‚Ä¢ <strong>Family/household members</strong> - Someone may have brought it inside<br>‚Ä¢ <strong>Safe spots</strong> - Behind pillars, under mats, in bushes<br>‚Ä¢ <strong>Front desk/mailroom</strong> - If you live in an apartment or building<br>‚Ä¢ <strong>Garage or side door</strong> - Carriers sometimes leave packages there" } },
              { id: 'opts_delivered', type: 'options', position: { x: 100, y: 1440 }, data: { prompt: 'What would you like to do?', options: [{ label: "I've checked all these places", icon: 'üîç' }, { label: "Give me time to check", icon: '‚è∞' }, { label: "I found it!", icon: '‚úÖ' }] } },
              { id: 'subflow_delivered_not_received', type: 'subflow', position: { x: -100, y: 1660 }, data: { name: 'Delivered Not Received', slug: 'delivered_not_received', nodeCount: 8 } },
              { id: 'end_delivered_found', type: 'end', position: { x: 300, y: 1660 }, data: { title: 'Package Found!', showSurvey: true } },
              
              // In Transit - 15+ days (Extended Transit)
              { id: 'subflow_extended_transit', type: 'subflow', position: { x: -300, y: 1580 }, data: { name: 'Extended Transit', slug: 'extended_transit', nodeCount: 12 } },
              
              // In Transit - 6-14 days (Sarah Voice Note)
              { id: 'msg_sarah_voice', type: 'message', position: { x: -500, y: 1580 }, data: { persona: 'sarah', content: "Your package has been in transit for {{daysInTransit}} days now. Our CX lead Sarah has a quick update for you..." } },
              { id: 'audio1', type: 'form', position: { x: -500, y: 1760 }, data: { formType: 'Audio Player', label: 'Sarah Voice Note', description: 'Waveform audio player with Sarah reassurance message' } },
              { id: 'opts_sarah', type: 'options', position: { x: -500, y: 1940 }, data: { prompt: 'How can I help?', options: [{ label: "I'll wait a bit longer", icon: '‚è≥' }, { label: "I have a concern", icon: '‚ö†Ô∏è' }] } },
              { id: 'subflow_extended_from_voice', type: 'subflow', position: { x: -700, y: 2120 }, data: { name: 'Extended Transit', slug: 'extended_transit', nodeCount: 12 } },
              
              // In Transit - 0-5 days (Normal)
              { id: 'cond_international', type: 'condition', position: { x: -500, y: 1580 }, data: { variable: 'tracking.isInternational', operator: '===', value: 'true', yesLabel: 'International', noLabel: 'Domestic' } },
              { id: 'msg_in_transit_normal', type: 'message', position: { x: -700, y: 1760 }, data: { persona: 'amy', content: "Your order is currently <strong>in transit</strong> and has been shipping for {{daysInTransit}} day(s). Delivery typically takes 5-10 business days. Expected delivery: <strong>{{estimatedDelivery}}</strong><br><br>It's still within the normal delivery window ‚Äî your package is on its way!" } },
              { id: 'msg_in_transit_intl', type: 'message', position: { x: -300, y: 1760 }, data: { persona: 'amy', content: "Your order is currently <strong>in transit</strong> and has been shipping for {{daysInTransit}} day(s). Since this is shipping from our international warehouse, it can sometimes take an additional 5 business days. Expected delivery: <strong>{{estimatedDelivery}}</strong><br><br>It's still within the normal delivery window ‚Äî your package is on its way!" } },
              { id: 'opts_in_transit', type: 'options', position: { x: -500, y: 1940 }, data: { prompt: 'What would you like to do?', options: [{ label: "Okay, I'll wait", icon: '‚è≥' }, { label: "I have a concern", icon: '‚ö†Ô∏è' }] } },
              { id: 'subflow_extended_from_normal', type: 'subflow', position: { x: -700, y: 2120 }, data: { name: 'Extended Transit', slug: 'extended_transit', nodeCount: 12 } },
              
              // Out for Delivery
              { id: 'msg_out_for_delivery', type: 'message', position: { x: 500, y: 1220 }, data: { persona: 'amy', content: "Great news! Your package is <strong>out for delivery today</strong>. It should arrive within the next few hours. Expected delivery: <strong>{{estimatedDelivery}}</strong>" } },
              { id: 'msg_out_intl', type: 'message', position: { x: 500, y: 1400 }, data: { persona: 'amy', content: "Your order is shipping from our international warehouse, which can sometimes take a bit longer but it's on its way to you!" } },
              { id: 'opts_out_delivery', type: 'options', position: { x: 500, y: 1580 }, data: { prompt: 'What would you like to do?', options: [{ label: "Perfect, I'll wait", icon: '‚úÖ' }, { label: "It's been out for delivery for days", icon: '‚ö†Ô∏è' }] } },
              { id: 'case_stuck_out_delivery', type: 'case', position: { x: 700, y: 1760 }, data: { type: 'shipping', subtype: 'stuck_out_for_delivery', priority: 'high' } },
              
              // Pending
              { id: 'msg_pending', type: 'message', position: { x: 900, y: 1220 }, data: { persona: 'amy', content: "Your order is currently being prepared for shipment. The carrier has received the shipping information but hasn't picked up the package yet.<br><br>This typically happens within 1-2 business days of placing your order." } },
              { id: 'cond_pending_days', type: 'condition', position: { x: 900, y: 1400 }, data: { variable: 'tracking.daysInTransit', operator: '>', value: '3', yesLabel: '>3 days', noLabel: '‚â§3 days' } },
              { id: 'msg_pending_long', type: 'message', position: { x: 1100, y: 1580 }, data: { persona: 'amy', content: "However, I notice it's been a few days. Would you like me to look into this for you?" } },
              { id: 'opts_pending_long', type: 'options', position: { x: 1100, y: 1760 }, data: { prompt: 'What would you like to do?', options: [{ label: "Yes, please investigate", icon: 'üîç' }, { label: "I'll wait a bit longer", icon: '‚è≥' }] } },
              { id: 'case_pending_investigate', type: 'case', position: { x: 1300, y: 1940 }, data: { type: 'shipping', subtype: 'pending_too_long', priority: 'normal' } },
              { id: 'opts_pending_normal', type: 'options', position: { x: 700, y: 1580 }, data: { prompt: 'What would you like to do?', options: [{ label: "Got it, I'll wait", icon: '‚úÖ' }, { label: "I need to cancel instead", icon: '‚ùå' }] } },
              { id: 'case_pending_cancel', type: 'case', position: { x: 900, y: 1760 }, data: { type: 'refund', subtype: 'order_cancellation', priority: 'normal' } },
              
              // Failed Attempt
              { id: 'msg_failed_attempt', type: 'message', position: { x: 1300, y: 1220 }, data: { persona: 'amy', content: "The carrier attempted to deliver your package but was unsuccessful. This could be due to:<br><br>‚Ä¢ No one available to sign<br>‚Ä¢ Address access issues<br>‚Ä¢ Weather conditions<br><br>They'll typically try again within 1-2 business days." } },
              { id: 'opts_failed_attempt', type: 'options', position: { x: 1300, y: 1400 }, data: { prompt: 'What would you like to do?', options: [{ label: "I'll be home next time", icon: 'üè†' }, { label: "I need to change my address", icon: 'üìç' }, { label: "They've tried multiple times", icon: '‚ö†Ô∏è' }] } },
              { id: 'subflow_failed_address', type: 'subflow', position: { x: 1500, y: 1580 }, data: { name: 'Failed Attempt - Address Change', slug: 'failed_attempt_address', nodeCount: 6 } },
              { id: 'subflow_multiple_failed', type: 'subflow', position: { x: 1700, y: 1580 }, data: { name: 'Multiple Failed Attempts', slug: 'multiple_failed_attempts', nodeCount: 8 } },
              
              // Pickup
              { id: 'msg_pickup', type: 'message', position: { x: 1500, y: 1220 }, data: { persona: 'amy', content: "Good news! Your package has arrived and is ready for you." } },
              { id: 'api_pickup_parse', type: 'api', position: { x: 1500, y: 1400 }, data: { service: 'AI', endpoint: '/api/parse-pickup-location', description: 'Parse pickup location from tracking data using AI', request: '{ tracking, checkpoints, shippingAddress }', response: '{ pickupLocationName, displayCarrier, lastMileTrackingNumber }' } },
              { id: 'msg_pickup_location', type: 'message', position: { x: 1500, y: 1580 }, data: { persona: 'amy', content: "Your package is ready for pickup at:<br><br><strong>{{pickupLocationName}}</strong><br><br>Please bring a valid ID when you go to pick it up." } },
              { id: 'opts_pickup', type: 'options', position: { x: 1500, y: 1760 }, data: { prompt: 'What would you like to do?', options: [{ label: "Thanks, I'll pick it up", icon: '‚úÖ' }, { label: "Package not at pickup location", icon: '‚ùå' }] } },
              { id: 'subflow_pickup_not_there', type: 'subflow', position: { x: 1700, y: 1940 }, data: { name: 'Pickup Not There', slug: 'pickup_not_there', nodeCount: 10 } },
              
              // Exception
              { id: 'msg_exception', type: 'message', position: { x: 1700, y: 1220 }, data: { persona: 'amy', content: "I see there's an issue with your package delivery. Let me help you figure out what's going on." } },
              { id: 'opts_exception', type: 'options', position: { x: 1700, y: 1400 }, data: { prompt: 'What would you like to do?', options: [{ label: "Investigate and reship", icon: 'üîç' }, { label: "I'd prefer a refund", icon: 'üí∞' }] } },
              { id: 'subflow_exception_investigate', type: 'subflow', position: { x: 1900, y: 1580 }, data: { name: 'Exception Investigation', slug: 'exception_investigation', nodeCount: 6 } },
              
              // Not Found branch
              { id: 'msg_not_found', type: 'message', position: { x: 700, y: 680 }, data: { persona: 'amy', content: "I couldn't find an order with those details. Let's try searching with more information." } },
              { id: 'form2', type: 'form', position: { x: 700, y: 860 }, data: { formType: 'Deep Search', label: 'Additional Details', fields: ['firstName', 'lastName', 'address1', 'country'] } },
              
              // End nodes
              { id: 'end_tracking_complete', type: 'end', position: { x: -500, y: 2300 }, data: { title: 'Tracking Complete!', showSurvey: true } },
              { id: 'end_waiting', type: 'end', position: { x: -300, y: 2300 }, data: { title: 'Thanks for your patience!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'form1', animated: true },
              { id: 'e2', source: 'form1', target: 'api1', animated: true },
              { id: 'e3', source: 'api1', target: 'cond1', animated: true },
              { id: 'e4', source: 'cond1', target: 'api2', sourceHandle: 'yes', label: 'Order found', animated: true },
              { id: 'e5', source: 'cond1', target: 'msg_not_found', sourceHandle: 'no', label: 'Not found', animated: true },
              { id: 'e6', source: 'msg_not_found', target: 'form2', animated: true },
              { id: 'e7', source: 'form2', target: 'api1', label: 'Retry search', animated: true },
              
              // Status routing
              { id: 'e8', source: 'api2', target: 'cond2', animated: true },
              { id: 'e9', source: 'cond2', target: 'msg_delivered', sourceHandle: 'yes', label: 'Delivered', animated: true },
              { id: 'e10', source: 'cond2', target: 'cond3', sourceHandle: 'no', label: 'Other status', animated: true },
              
              // Delivered branch
              { id: 'e11', source: 'msg_delivered', target: 'opts_delivered', animated: true },
              { id: 'e12', source: 'opts_delivered', target: 'subflow_delivered_not_received', sourceHandle: 'opt-0', label: 'Checked all places', animated: true },
              { id: 'e13', source: 'opts_delivered', target: 'end_waiting', sourceHandle: 'opt-1', label: 'Give me time', animated: true },
              { id: 'e14', source: 'opts_delivered', target: 'end_delivered_found', sourceHandle: 'opt-2', label: 'Found it', animated: true },
              
              // In Transit branch
              { id: 'e15', source: 'cond3', target: 'cond4', sourceHandle: 'yes', label: 'In Transit', animated: true },
              { id: 'e16', source: 'cond4', target: 'subflow_extended_transit', sourceHandle: 'yes', label: '15+ days', animated: true },
              { id: 'e17', source: 'cond4', target: 'cond5', sourceHandle: 'no', label: '<15 days', animated: true },
              { id: 'e18', source: 'cond5', target: 'msg_sarah_voice', sourceHandle: 'yes', label: '6-14 days', animated: true },
              { id: 'e19', source: 'cond5', target: 'cond_international', sourceHandle: 'no', label: '0-5 days', animated: true },
              { id: 'e20', source: 'msg_sarah_voice', target: 'audio1', animated: true },
              { id: 'e21', source: 'audio1', target: 'opts_sarah', animated: true },
              { id: 'e22', source: 'opts_sarah', target: 'end_waiting', sourceHandle: 'opt-0', label: 'Wait longer', animated: true },
              { id: 'e23', source: 'opts_sarah', target: 'subflow_extended_from_voice', sourceHandle: 'opt-1', label: 'Have concern', animated: true },
              { id: 'e24', source: 'cond_international', target: 'msg_in_transit_intl', sourceHandle: 'yes', label: 'International', animated: true },
              { id: 'e25', source: 'cond_international', target: 'msg_in_transit_normal', sourceHandle: 'no', label: 'Domestic', animated: true },
              { id: 'e26', source: 'msg_in_transit_normal', target: 'opts_in_transit', animated: true },
              { id: 'e27', source: 'msg_in_transit_intl', target: 'opts_in_transit', animated: true },
              { id: 'e28', source: 'opts_in_transit', target: 'end_waiting', sourceHandle: 'opt-0', label: 'Wait', animated: true },
              { id: 'e29', source: 'opts_in_transit', target: 'subflow_extended_from_normal', sourceHandle: 'opt-1', label: 'Have concern', animated: true },
              
              // Out for Delivery branch
              { id: 'e30', source: 'cond3', target: 'cond6', sourceHandle: 'no', label: 'Check other statuses', animated: true },
              { id: 'e31', source: 'cond6', target: 'msg_out_for_delivery', sourceHandle: 'yes', label: 'Out for Delivery', animated: true },
              { id: 'e32', source: 'msg_out_for_delivery', target: 'cond_international', animated: true },
              { id: 'e33', source: 'cond_international', target: 'msg_out_intl', sourceHandle: 'yes', label: 'International', animated: true },
              { id: 'e34', source: 'msg_out_intl', target: 'opts_out_delivery', animated: true },
              { id: 'e35', source: 'msg_out_for_delivery', target: 'opts_out_delivery', animated: true },
              { id: 'e36', source: 'opts_out_delivery', target: 'end_waiting', sourceHandle: 'opt-0', label: 'Wait', animated: true },
              { id: 'e37', source: 'opts_out_delivery', target: 'case_stuck_out_delivery', sourceHandle: 'opt-1', label: 'Stuck for days', animated: true },
              
              // Pending branch
              { id: 'e38', source: 'cond6', target: 'cond7', sourceHandle: 'no', label: 'Check pending', animated: true },
              { id: 'e39', source: 'cond7', target: 'msg_pending', sourceHandle: 'yes', label: 'Pending', animated: true },
              { id: 'e40', source: 'msg_pending', target: 'cond_pending_days', animated: true },
              { id: 'e41', source: 'cond_pending_days', target: 'msg_pending_long', sourceHandle: 'yes', label: '>3 days', animated: true },
              { id: 'e42', source: 'cond_pending_days', target: 'opts_pending_normal', sourceHandle: 'no', label: '‚â§3 days', animated: true },
              { id: 'e43', source: 'msg_pending_long', target: 'opts_pending_long', animated: true },
              { id: 'e44', source: 'opts_pending_long', target: 'case_pending_investigate', sourceHandle: 'opt-0', label: 'Investigate', animated: true },
              { id: 'e45', source: 'opts_pending_long', target: 'end_waiting', sourceHandle: 'opt-1', label: 'Wait', animated: true },
              { id: 'e46', source: 'opts_pending_normal', target: 'end_waiting', sourceHandle: 'opt-0', label: 'Wait', animated: true },
              { id: 'e47', source: 'opts_pending_normal', target: 'case_pending_cancel', sourceHandle: 'opt-1', label: 'Cancel', animated: true },
              
              // Failed Attempt branch
              { id: 'e48', source: 'cond7', target: 'cond8', sourceHandle: 'no', label: 'Check failed', animated: true },
              { id: 'e49', source: 'cond8', target: 'msg_failed_attempt', sourceHandle: 'yes', label: 'Failed Attempt', animated: true },
              { id: 'e50', source: 'msg_failed_attempt', target: 'opts_failed_attempt', animated: true },
              { id: 'e51', source: 'opts_failed_attempt', target: 'end_waiting', sourceHandle: 'opt-0', label: 'Wait', animated: true },
              { id: 'e52', source: 'opts_failed_attempt', target: 'subflow_failed_address', sourceHandle: 'opt-1', label: 'Change address', animated: true },
              { id: 'e53', source: 'opts_failed_attempt', target: 'subflow_multiple_failed', sourceHandle: 'opt-2', label: 'Multiple attempts', animated: true },
              
              // Pickup branch
              { id: 'e54', source: 'cond8', target: 'cond9', sourceHandle: 'no', label: 'Check pickup', animated: true },
              { id: 'e55', source: 'cond9', target: 'msg_pickup', sourceHandle: 'yes', label: 'Pickup', animated: true },
              { id: 'e56', source: 'msg_pickup', target: 'api_pickup_parse', animated: true },
              { id: 'e57', source: 'api_pickup_parse', target: 'msg_pickup_location', animated: true },
              { id: 'e58', source: 'msg_pickup_location', target: 'opts_pickup', animated: true },
              { id: 'e59', source: 'opts_pickup', target: 'end_waiting', sourceHandle: 'opt-0', label: 'Pick it up', animated: true },
              { id: 'e60', source: 'opts_pickup', target: 'subflow_pickup_not_there', sourceHandle: 'opt-1', label: 'Not there', animated: true },
              
              // Exception branch
              { id: 'e61', source: 'cond9', target: 'cond10', sourceHandle: 'no', label: 'Check exception', animated: true },
              { id: 'e62', source: 'cond10', target: 'msg_exception', sourceHandle: 'yes', label: 'Exception', animated: true },
              { id: 'e63', source: 'msg_exception', target: 'opts_exception', animated: true },
              { id: 'e64', source: 'opts_exception', target: 'subflow_exception_investigate', sourceHandle: 'opt-0', label: 'Investigate', animated: true },
              { id: 'e65', source: 'opts_exception', target: 'subflow_extended_transit', sourceHandle: 'opt-1', label: 'Refund', animated: true }
            ]
          },

          // SUBSCRIPTION FLOWS
          pause_subscription: {
            id: 'pause_subscription',
            parentId: 'manage_subscription',
            name: 'Pause Subscription',
            description: 'Customer wants to temporarily pause deliveries - duration selection then API call',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Pause Subscription' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 170 }, data: { persona: 'amy', content: "No problem! How long would you like to pause your subscription?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 370 }, data: { prompt: 'Select pause duration', options: [{ label: '1 month', icon: 'üìÖ' }, { label: '2 months', icon: 'üìÖ' }, { label: '3 months', icon: 'üìÖ' }] } },
              { id: 'api1', type: 'api', position: { x: 350, y: 590 }, data: { service: 'Shopify', endpoint: '/api/subscriptions/pause', description: 'Pause subscription for selected duration', request: '{ subscriptionId, pauseDuration }', response: '{ success, resumeDate }' } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 790 }, data: { persona: 'amy', content: "Done! Your subscription is now paused. We'll automatically resume on {{resumeDate}}. You'll get a reminder email before then!" } },
              { id: 'end1', type: 'end', position: { x: 350, y: 990 }, data: { title: 'Subscription Paused!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e3', source: 'opts1', target: 'api1', animated: true },
              { id: 'e4', source: 'api1', target: 'msg2', animated: true },
              { id: 'e5', source: 'msg2', target: 'end1', animated: true }
            ]
          },

          cancel_subscription: {
            id: 'cancel_subscription',
            parentId: 'manage_subscription',
            name: 'Cancel Subscription',
            description: 'Customer wants to cancel - reason selection with special handling + retention offers',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Cancel Subscription' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 170 }, data: { persona: 'amy', content: "I'm sorry to see you go! Before we cancel, may I ask why you're looking to cancel?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 390 }, data: { prompt: 'Reason for canceling?', options: [{ label: 'Too expensive', icon: 'üí∞' }, { label: 'Dog passed away', icon: 'üåà' }, { label: 'Moving', icon: 'üè†' }, { label: 'Dog no longer needs it', icon: 'üêï' }, { label: 'Other reason', icon: '‚ùì' }] } },
              { id: 'offer1', type: 'offer', position: { x: 50, y: 650 }, data: { percent: 20, label: '20% off next 3 months', message: "I understand budget can be tight. What if I offer you 20% off your next 3 shipments?", forFuture: true } },
              { id: 'case1', type: 'case', position: { x: 250, y: 650 }, data: { type: 'subscription', subtype: 'pet_loss', priority: 'high', note: 'Pet loss - handle with sensitivity and compassion' } },
              { id: 'msg2', type: 'message', position: { x: 450, y: 650 }, data: { persona: 'amy', content: "Good luck with your move! I'll process your cancellation right away." } },
              { id: 'msg3', type: 'message', position: { x: 650, y: 650 }, data: { persona: 'amy', content: "That's great that your pup is doing well! I'll cancel your subscription, but feel free to come back if you ever need us again." } },
              { id: 'input1', type: 'form', position: { x: 850, y: 650 }, data: { formType: 'Text Input', label: 'Tell us more...' } },
              { id: 'api1', type: 'api', position: { x: 450, y: 890 }, data: { service: 'Shopify', endpoint: '/api/subscriptions/cancel', description: 'Cancel subscription', request: '{ subscriptionId, reason }', response: '{ success }' } },
              { id: 'end1', type: 'end', position: { x: 350, y: 1110 }, data: { title: 'Subscription Updated', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e3', source: 'opts1', target: 'offer1', label: 'Too expensive', animated: true },
              { id: 'e4', source: 'opts1', target: 'case1', label: 'Pet loss', animated: true },
              { id: 'e5', source: 'opts1', target: 'msg2', label: 'Moving', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg3', label: 'No longer needs', animated: true },
              { id: 'e7', source: 'opts1', target: 'input1', label: 'Other', animated: true },
              { id: 'e8', source: 'offer1', target: 'api1', animated: true },
              { id: 'e9', source: 'case1', target: 'end1', animated: true },
              { id: 'e10', source: 'msg2', target: 'api1', animated: true },
              { id: 'e11', source: 'msg3', target: 'api1', animated: true },
              { id: 'e12', source: 'input1', target: 'api1', animated: true },
              { id: 'e13', source: 'api1', target: 'end1', animated: true }
            ]
          },

          change_order: {
            id: 'change_order',
            parentId: 'help_with_order',
            name: 'Change Order (Unfulfilled)',
            description: 'Customer wants to change their order within 10-hour unfulfilled window',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Change Order Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Sure! What would you like instead? Tell me what product, size, or color you'd prefer:" } },
              { id: 'form1', type: 'form', position: { x: 350, y: 330 }, data: { formType: 'Text Input', label: 'What would you like instead?', fields: ['changeOrderDetails'] } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 510 }, data: { persona: 'amy', content: "Got it! I'll create a case for our team to swap your order. Has your current product been used?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 690 }, data: { prompt: 'Has your product been used?', options: [{ label: "Yes, used", icon: '‚úÖ' }, { label: "No, unused", icon: '‚ùå' }] } },
              { id: 'msg3_used', type: 'message', position: { x: 150, y: 870 }, data: { persona: 'amy', content: "Since it's been used, we'll send you the new item and give you a <strong>20% refund</strong> as well. You can keep the used one!" } },
              { id: 'msg3_unused', type: 'message', position: { x: 550, y: 870 }, data: { persona: 'amy', content: "Great! Once you ship back the item using a carrier of your choice, we'll send out your new order. Just reply to your confirmation email with the tracking number so we can monitor the return. Free of charge!" } },
              { id: 'case1', type: 'case', position: { x: 150, y: 1050 }, data: { type: 'shipping', subtype: 'order_change_used_20_percent', priority: 'normal', note: 'Order change - product used, 20% refund + new item' } },
              { id: 'case2', type: 'case', position: { x: 550, y: 1050 }, data: { type: 'shipping', subtype: 'order_change_return_swap', priority: 'normal', note: 'Order change - product unused, return swap' } },
              { id: 'end1', type: 'end', position: { x: 150, y: 1230 }, data: { title: 'Order Change Requested!', showSurvey: true } },
              { id: 'end2', type: 'end', position: { x: 550, y: 1230 }, data: { title: 'Order Change Requested!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'form1', animated: true },
              { id: 'e3', source: 'form1', target: 'msg2', animated: true },
              { id: 'e4', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'msg3_used', sourceHandle: 'opt-0', label: 'Used', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg3_unused', sourceHandle: 'opt-1', label: 'Unused', animated: true },
              { id: 'e7', source: 'msg3_used', target: 'case1', animated: true },
              { id: 'e8', source: 'msg3_unused', target: 'case2', animated: true },
              { id: 'e9', source: 'case1', target: 'end1', animated: true },
              { id: 'e10', source: 'case2', target: 'end2', animated: true }
            ]
          },

          change_frequency: {
            id: 'change_frequency',
            parentId: 'manage_subscription',
            name: 'Change Delivery Frequency',
            description: 'Customer wants to adjust delivery frequency',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Change Frequency' } },
              { id: 'api1', type: 'api', position: { x: 350, y: 170 }, data: { service: 'Shopify', endpoint: '/api/subscriptions/current', description: 'Get current subscription details', response: '{ currentFrequency, nextDelivery }' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 370 }, data: { persona: 'amy', content: "Your current delivery frequency is {{currentFrequency}}. What would you like to change it to?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 590 }, data: { prompt: 'Select new frequency', options: [{ label: 'Every 2 weeks', icon: 'üìÖ' }, { label: 'Every month', icon: 'üìÖ' }, { label: 'Every 6 weeks', icon: 'üìÖ' }, { label: 'Every 2 months', icon: 'üìÖ' }] } },
              { id: 'api2', type: 'api', position: { x: 350, y: 830 }, data: { service: 'Shopify', endpoint: '/api/subscriptions/update-frequency', description: 'Update subscription frequency', request: '{ subscriptionId, newFrequency }', response: '{ success, nextDelivery }' } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 1030 }, data: { persona: 'amy', content: "Perfect! I've updated your delivery frequency. Your next delivery will be on {{nextDelivery}}." } },
              { id: 'end1', type: 'end', position: { x: 350, y: 1230 }, data: { title: 'Frequency Updated!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'api1', animated: true },
              { id: 'e2', source: 'api1', target: 'msg1', animated: true },
              { id: 'e3', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e4', source: 'opts1', target: 'api2', animated: true },
              { id: 'e5', source: 'api2', target: 'msg2', animated: true },
              { id: 'e6', source: 'msg2', target: 'end1', animated: true }
            ]
          },

          // ============================================
          // DETAILED TRACKING SUBFLOWS
          // ============================================
          
          extended_transit: {
            id: 'extended_transit',
            parentId: 'track_order',
            name: 'Extended Transit (15+ Days)',
            description: 'Package in transit for 15+ days - offer reship or refund with explanation',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Extended Transit Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I see your package has been in transit for <strong>{{daysInTransit}} days</strong> ‚Äî that's definitely longer than expected, and I completely understand your frustration." } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 330 }, data: { persona: 'amy', content: "There could be a few reasons why this has happened:<br><br><strong>1. International warehouse shipping:</strong> Due to high demand, your order may have shipped from one of our international warehouses instead of a local one. We try to keep all our warehouses stocked, but sometimes items go out of stock locally.<br><br><strong>2. Address issues:</strong> Sometimes there are problems with the delivery address ‚Äî a missing apartment number, incorrect postcode, or the carrier couldn't access the location.<br><br><strong>3. Customs or carrier delays:</strong> Packages can get held up in customs processing or experience unexpected carrier delays along the route." } },
              { id: 'msg3', type: 'message', position: { x: 350, y: 550 }, data: { persona: 'amy', content: "Whatever the reason, {{daysInTransit}} days is too long and we want to make this right for you.<br><br>Here's the thing ‚Äî we don't charge you for shipping, so if we reship your order, we'll likely lose money on both the shipping costs and the product itself. But your satisfaction matters more to us, and we want to make sure you receive your order." } },
              { id: 'msg4', type: 'message', position: { x: 350, y: 750 }, data: { persona: 'amy', content: "So here's what I can offer you:" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 950 }, data: { prompt: 'How would you like to proceed?', options: [{ label: "Reship my order (free)", icon: 'üì¶' }, { label: "I'd prefer a refund", icon: 'üí∞' }] } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 150, y: 1170 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'subflow_refund_ladder', type: 'subflow', position: { x: 550, y: 1170 }, data: { name: 'Shipping Refund Ladder', slug: 'shipping_refund_ladder', nodeCount: 10 } },
              { id: 'end1', type: 'end', position: { x: 350, y: 1370 }, data: { title: 'Resolution Complete', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'msg3', animated: true },
              { id: 'e4', source: 'msg3', target: 'msg4', animated: true },
              { id: 'e5', source: 'msg4', target: 'opts1', animated: true },
              { id: 'e6', source: 'opts1', target: 'subflow_reship', sourceHandle: 'opt-0', label: 'Reship', animated: true },
              { id: 'e7', source: 'opts1', target: 'subflow_refund_ladder', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              { id: 'e8', source: 'subflow_reship', target: 'end1', animated: true },
              { id: 'e9', source: 'subflow_refund_ladder', target: 'end1', animated: true }
            ]
          },

          delivered_not_received: {
            id: 'delivered_not_received',
            parentId: 'track_order',
            name: 'Delivered But Not Received',
            description: 'Customer says package was marked delivered but they didn\'t receive it',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Delivered Not Received' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I understand this is frustrating. Let me create a case for our team to investigate with the carrier." } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 330 }, data: { persona: 'amy', content: "We'll contact the carrier and review:<br>‚Ä¢ Security camera footage from delivery day<br>‚Ä¢ Scan records to see when package arrived<br>‚Ä¢ Staff logs and handover records<br>‚Ä¢ The carrier will file a police report as part of their missing package process" } },
              { id: 'msg3', type: 'message', position: { x: 350, y: 510 }, data: { persona: 'amy', content: "Your local police may reach out to you for a statement since you're the intended recipient. This helps if they need to pull CCTV footage or follow up. We want to make this right, so while that's happening, we can reship your order. Would you like us to proceed?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 730 }, data: { prompt: 'What would you like to do?', options: [{ label: "Yes, please investigate and reship", icon: '‚úÖ' }, { label: "Actually, let me check again first", icon: 'üîç' }] } },
              { id: 'subflow_investigation_reship', type: 'subflow', position: { x: 150, y: 950 }, data: { name: 'Investigation + Reship', slug: 'investigation_reship', nodeCount: 6 } },
              { id: 'msg4', type: 'message', position: { x: 550, y: 950 }, data: { persona: 'amy', content: "No worries at all! Sometimes packages show up in unexpected places. Take your time to have another look and just come back if you still need help." } },
              { id: 'end1', type: 'end', position: { x: 150, y: 1150 }, data: { title: 'Case Created', showSurvey: true } },
              { id: 'end2', type: 'end', position: { x: 550, y: 1150 }, data: { title: 'Customer Checking', showSurvey: false } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'msg3', animated: true },
              { id: 'e4', source: 'msg3', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'subflow_investigation_reship', sourceHandle: 'opt-0', label: 'Investigate & reship', animated: true },
              { id: 'e6', source: 'opts1', target: 'msg4', sourceHandle: 'opt-1', label: 'Check again', animated: true },
              { id: 'e7', source: 'subflow_investigation_reship', target: 'end1', animated: true },
              { id: 'e8', source: 'msg4', target: 'end2', animated: true }
            ]
          },

          failed_attempt_address: {
            id: 'failed_attempt_address',
            parentId: 'track_order',
            name: 'Failed Attempt - Address Change',
            description: 'Customer needs to change delivery address after failed attempt',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Address Change Flow' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Since your package is already with {{carrierName}}, you'll need to contact them directly to update the delivery address or arrange a pickup." } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 330 }, data: { persona: 'amy', content: "<strong>{{carrierName}} Contact Information:</strong><br><br>üìû Phone: <strong>{{carrierPhone}}</strong><br>üîó Track Package: <a href=\"{{carrierUrl}}\" target=\"_blank\">Click here to track on {{carrierName}}</a><br>üì¶ Tracking #: <strong>{{trackingNumber}}</strong>" } },
              { id: 'msg3', type: 'message', position: { x: 350, y: 510 }, data: { persona: 'amy', content: "When you call, they can help you:<br>‚Ä¢ Update the delivery address<br>‚Ä¢ Schedule a redelivery<br>‚Ä¢ Arrange a pickup at a local facility" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 690 }, data: { prompt: 'What would you like to do?', options: [{ label: "Thanks, I'll contact them", icon: 'üìû' }, { label: "I'd rather get a reship", icon: 'üì¶' }] } },
              { id: 'end1', type: 'end', position: { x: 150, y: 890 }, data: { title: 'Contacting Carrier', showSurvey: false } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 550, y: 890 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end2', type: 'end', position: { x: 550, y: 1090 }, data: { title: 'Reship Created', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'msg3', animated: true },
              { id: 'e4', source: 'msg3', target: 'opts1', animated: true },
              { id: 'e5', source: 'opts1', target: 'end1', sourceHandle: 'opt-0', label: 'Contact carrier', animated: true },
              { id: 'e6', source: 'opts1', target: 'subflow_reship', sourceHandle: 'opt-1', label: 'Reship', animated: true },
              { id: 'e7', source: 'subflow_reship', target: 'end2', animated: true }
            ]
          },

          multiple_failed_attempts: {
            id: 'multiple_failed_attempts',
            parentId: 'track_order',
            name: 'Multiple Failed Delivery Attempts',
            description: 'Carrier has tried multiple times to deliver - offer solutions',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Multiple Failed Attempts' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I'm really sorry you're dealing with this ‚Äî multiple failed attempts is frustrating. Let me help you figure out the best solution." } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 330 }, data: { persona: 'amy', content: "Is your address correct, or do you need to update it?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 510 }, data: { prompt: 'What would you like to do?', options: [{ label: "My address is correct", icon: '‚úÖ' }, { label: "I need to update my address", icon: 'üìç' }] } },
              { id: 'msg3', type: 'message', position: { x: 150, y: 730 }, data: { persona: 'amy', content: "Got it. Since {{carrierName}} has been unable to deliver, here are your options:<br><br><strong>Option 1: Contact {{carrierName}}</strong><br>üìû Call {{carrierPhone}} to schedule a specific delivery time or arrange pickup.<br>üîó <a href=\"{{carrierUrl}}\" target=\"_blank\">Track your package on {{carrierName}}</a><br><br><strong>Option 2: We reship to a different address</strong><br>If you have an alternate address (work, neighbor, etc.) that might work better." } },
              { id: 'opts2', type: 'options', position: { x: 150, y: 950 }, data: { prompt: 'What would you like to do?', options: [{ label: "I'll contact the carrier", icon: 'üìû' }, { label: "Reship to different address", icon: 'üì¶' }, { label: "I want a refund instead", icon: 'üí∞' }] } },
              { id: 'end1', type: 'end', position: { x: -50, y: 1170 }, data: { title: 'Contacting Carrier', showSurvey: false } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 150, y: 1170 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'subflow_refund_ladder', type: 'subflow', position: { x: 350, y: 1170 }, data: { name: 'Shipping Refund Ladder', slug: 'shipping_refund_ladder', nodeCount: 10 } },
              { id: 'subflow_address_change', type: 'subflow', position: { x: 550, y: 730 }, data: { name: 'Failed Attempt - Address Change', slug: 'failed_attempt_address', nodeCount: 6 } },
              { id: 'end2', type: 'end', position: { x: 150, y: 1370 }, data: { title: 'Reship Created', showSurvey: true } },
              { id: 'end3', type: 'end', position: { x: 350, y: 1370 }, data: { title: 'Refund Processed', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e4', source: 'opts1', target: 'msg3', sourceHandle: 'opt-0', label: 'Address correct', animated: true },
              { id: 'e5', source: 'opts1', target: 'subflow_address_change', sourceHandle: 'opt-1', label: 'Update address', animated: true },
              { id: 'e6', source: 'msg3', target: 'opts2', animated: true },
              { id: 'e7', source: 'opts2', target: 'end1', sourceHandle: 'opt-0', label: 'Contact carrier', animated: true },
              { id: 'e8', source: 'opts2', target: 'subflow_reship', sourceHandle: 'opt-1', label: 'Reship', animated: true },
              { id: 'e9', source: 'opts2', target: 'subflow_refund_ladder', sourceHandle: 'opt-2', label: 'Refund', animated: true },
              { id: 'e10', source: 'subflow_reship', target: 'end2', animated: true },
              { id: 'e11', source: 'subflow_refund_ladder', target: 'end3', animated: true }
            ]
          },

          pickup_not_there: {
            id: 'pickup_not_there',
            parentId: 'track_order',
            name: 'Pickup Location - Package Not There',
            description: 'Customer went to pickup location but package wasn\'t there - investigation flow',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Pickup Not There' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Just to make sure we're on the same page, the tracking shows your package should be at:<br><br><strong>{{pickupLocationName}}</strong><br><br>Is this where you went?" } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 330 }, data: { prompt: 'Did you go to the correct location?', options: [{ label: "Yes, that's where I went", icon: '‚úÖ' }, { label: "No, I went somewhere else", icon: '‚ùå' }] } },
              { id: 'msg2', type: 'message', position: { x: 150, y: 510 }, data: { persona: 'amy', content: "Got it! Your package is actually at <strong>{{pickupLocationName}}</strong>. Please try picking it up from there and let me know if you still have issues." } },
              { id: 'opts2', type: 'options', position: { x: 150, y: 690 }, data: { prompt: 'What would you like to do?', options: [{ label: "Thanks, I'll go there", icon: '‚úÖ' }, { label: "I still need help", icon: '‚ö†Ô∏è' }] } },
              { id: 'end1', type: 'end', position: { x: -50, y: 870 }, data: { title: 'Customer Going to Location', showSurvey: false } },
              { id: 'msg3', type: 'message', position: { x: 550, y: 510 }, data: { persona: 'amy', content: "I'm sorry to hear that. Could you share a few details about your pickup attempt? This will help us investigate." } },
              { id: 'form1', type: 'form', position: { x: 550, y: 690 }, data: { formType: 'Pickup Attempt Form', label: 'Pickup Details', fields: ['pickupDate', 'pickupLocation', 'pickupNotes'] } },
              { id: 'msg4', type: 'message', position: { x: 550, y: 870 }, data: { persona: 'amy', content: "Thanks for those details. This is quite rare so we'll need to open a formal investigation. Just so you know, PuppyPad and {{carrierName}} are two separate companies. Our responsibility is to pack your order and hand it off to them safely, which we did. But we always go above and beyond to help when things go wrong on their end." } },
              { id: 'msg5', type: 'message', position: { x: 550, y: 1050 }, data: { persona: 'amy', content: "Here's how the investigation works:<br><br>‚Ä¢ We'll contact {{carrierName}} and {{pickupLocation}} directly<br>‚Ä¢ They'll review the security camera footage from that day<br>‚Ä¢ They'll pull scan records to see when your package arrived and if anyone collected it<br>‚Ä¢ Staff logs and handover records will be checked<br>‚Ä¢ {{carrierName}} will file a police report as part of their missing package process" } },
              { id: 'msg6', type: 'message', position: { x: 550, y: 1230 }, data: { persona: 'amy', content: "Your local police may reach out to you for a statement since you're the intended recipient. This helps if they need to pull CCTV footage or follow up with {{pickupLocation}}. We want to make this right, so while that's happening, we can reship your order. Would you like us to proceed?" } },
              { id: 'opts3', type: 'options', position: { x: 550, y: 1410 }, data: { prompt: 'What would you like to do?', options: [{ label: "Yes, please investigate and reship", icon: '‚úÖ' }, { label: "Actually, let me check again first", icon: 'üîç' }] } },
              { id: 'subflow_investigation_reship', type: 'subflow', position: { x: 350, y: 1590 }, data: { name: 'Investigation + Reship', slug: 'investigation_reship', nodeCount: 6 } },
              { id: 'msg7', type: 'message', position: { x: 750, y: 1590 }, data: { persona: 'amy', content: "No worries at all! Sometimes packages show up in unexpected places. Take your time to have another look and just come back if you still need help." } },
              { id: 'end2', type: 'end', position: { x: 350, y: 1790 }, data: { title: 'Investigation Case Created', showSurvey: true } },
              { id: 'end3', type: 'end', position: { x: 750, y: 1790 }, data: { title: 'Customer Checking Again', showSurvey: false } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'opts1', animated: true },
              { id: 'e3', source: 'opts1', target: 'msg2', sourceHandle: 'opt-1', label: 'Wrong location', animated: true },
              { id: 'e4', source: 'opts1', target: 'msg3', sourceHandle: 'opt-0', label: 'Correct location', animated: true },
              { id: 'e5', source: 'msg2', target: 'opts2', animated: true },
              { id: 'e6', source: 'opts2', target: 'end1', sourceHandle: 'opt-0', label: 'Go there', animated: true },
              { id: 'e7', source: 'opts2', target: 'msg3', sourceHandle: 'opt-1', label: 'Still need help', animated: true },
              { id: 'e8', source: 'msg3', target: 'form1', animated: true },
              { id: 'e9', source: 'form1', target: 'msg4', animated: true },
              { id: 'e10', source: 'msg4', target: 'msg5', animated: true },
              { id: 'e11', source: 'msg5', target: 'msg6', animated: true },
              { id: 'e12', source: 'msg6', target: 'opts3', animated: true },
              { id: 'e13', source: 'opts3', target: 'subflow_investigation_reship', sourceHandle: 'opt-0', label: 'Investigate & reship', animated: true },
              { id: 'e14', source: 'opts3', target: 'msg7', sourceHandle: 'opt-1', label: 'Check again', animated: true },
              { id: 'e15', source: 'subflow_investigation_reship', target: 'end2', animated: true },
              { id: 'e16', source: 'msg7', target: 'end3', animated: true }
            ]
          },

          exception_investigation: {
            id: 'exception_investigation',
            parentId: 'track_order',
            name: 'Exception/Expired Tracking Investigation',
            description: 'Tracking shows exception or expired status - investigate and resolve',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Exception Investigation' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "I see there's an issue with your package delivery. Let me help you figure out what's going on." } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 330 }, data: { persona: 'amy', content: "I'll create a case for our team to investigate with the carrier. They'll check what happened and get back to you within 1-2 business days." } },
              { id: 'opts1', type: 'options', position: { x: 350, y: 510 }, data: { prompt: 'What would you like to do?', options: [{ label: "Investigate and reship", icon: 'üîç' }, { label: "I'd prefer a refund", icon: 'üí∞' }] } },
              { id: 'case1', type: 'case', position: { x: 150, y: 690 }, data: { type: 'shipping', subtype: 'exception_investigation', priority: 'normal' } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 150, y: 870 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'subflow_refund_ladder', type: 'subflow', position: { x: 550, y: 690 }, data: { name: 'Shipping Refund Ladder', slug: 'shipping_refund_ladder', nodeCount: 10 } },
              { id: 'end1', type: 'end', position: { x: 150, y: 1070 }, data: { title: 'Case Created & Reship', showSurvey: true } },
              { id: 'end2', type: 'end', position: { x: 550, y: 870 }, data: { title: 'Refund Processed', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'msg2', animated: true },
              { id: 'e3', source: 'msg2', target: 'opts1', animated: true },
              { id: 'e4', source: 'opts1', target: 'case1', sourceHandle: 'opt-0', label: 'Investigate & reship', animated: true },
              { id: 'e5', source: 'opts1', target: 'subflow_refund_ladder', sourceHandle: 'opt-1', label: 'Refund', animated: true },
              { id: 'e6', source: 'case1', target: 'subflow_reship', animated: true },
              { id: 'e7', source: 'subflow_reship', target: 'end1', animated: true },
              { id: 'e8', source: 'subflow_refund_ladder', target: 'end2', animated: true }
            ]
          },

          reship_flow: {
            id: 'reship_flow',
            parentId: 'track_order',
            name: 'Reship Flow',
            description: 'Create free reship with address confirmation',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Reship Flow' } },
              { id: 'cond1', type: 'condition', position: { x: 350, y: 150 }, data: { variable: 'address.address1', operator: 'exists', value: 'true', yesLabel: 'Has address', noLabel: 'No address' } },
              { id: 'msg1', type: 'message', position: { x: 150, y: 330 }, data: { persona: 'amy', content: "I'll create a free reship for you! First, let me confirm your shipping address:<br><br><div class=\"address-display\">{{formattedAddress}}</div>" } },
              { id: 'msg2', type: 'message', position: { x: 550, y: 330 }, data: { persona: 'amy', content: "I'll create a free reship for you! Please provide your shipping address:" } },
              { id: 'msg3', type: 'message', position: { x: 150, y: 510 }, data: { persona: 'amy', content: "Is this address correct, or would you like to update it?" } },
              { id: 'opts1', type: 'options', position: { x: 150, y: 690 }, data: { prompt: 'Is the address correct?', options: [{ label: "This address is correct", icon: '‚úÖ' }, { label: "I need to update it", icon: '‚úèÔ∏è' }] } },
              { id: 'form1', type: 'form', position: { x: 550, y: 510 }, data: { formType: 'Address Form', label: 'Shipping Address', fields: ['address1', 'address2', 'city', 'province', 'zip', 'country'] } },
              { id: 'form2', type: 'form', position: { x: 350, y: 870 }, data: { formType: 'Address Form', label: 'Update Address', fields: ['address1', 'address2', 'city', 'province', 'zip', 'country'] } },
              { id: 'api1', type: 'api', position: { x: 150, y: 870 }, data: { service: 'Shopify', endpoint: '/api/reship', description: 'Create reshipment with confirmed address', request: '{ orderId, address }', response: '{ reshipmentId, trackingNumber }' } },
              { id: 'msg4', type: 'message', position: { x: 150, y: 1050 }, data: { persona: 'amy', content: "Perfect! I've created a free reship for you. You'll receive tracking information via email once it ships." } },
              { id: 'end1', type: 'end', position: { x: 150, y: 1230 }, data: { title: 'Reship Created!', showSurvey: true } },
              { id: 'api2', type: 'api', position: { x: 550, y: 690 }, data: { service: 'Shopify', endpoint: '/api/reship', description: 'Create reshipment with new address', request: '{ orderId, address }', response: '{ reshipmentId, trackingNumber }' } },
              { id: 'api3', type: 'api', position: { x: 350, y: 1050 }, data: { service: 'Shopify', endpoint: '/api/reship', description: 'Create reshipment with updated address', request: '{ orderId, address }', response: '{ reshipmentId, trackingNumber }' } },
              { id: 'end2', type: 'end', position: { x: 550, y: 870 }, data: { title: 'Reship Created!', showSurvey: true } },
              { id: 'end3', type: 'end', position: { x: 350, y: 1230 }, data: { title: 'Reship Created!', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'cond1', animated: true },
              { id: 'e2', source: 'cond1', target: 'msg1', sourceHandle: 'yes', label: 'Has address', animated: true },
              { id: 'e3', source: 'cond1', target: 'msg2', sourceHandle: 'no', label: 'No address', animated: true },
              { id: 'e4', source: 'msg1', target: 'msg3', animated: true },
              { id: 'e5', source: 'msg3', target: 'opts1', animated: true },
              { id: 'e6', source: 'opts1', target: 'api1', sourceHandle: 'opt-0', label: 'Correct', animated: true },
              { id: 'e7', source: 'opts1', target: 'form2', sourceHandle: 'opt-1', label: 'Update', animated: true },
              { id: 'e8', source: 'msg2', target: 'form1', animated: true },
              { id: 'e9', source: 'form1', target: 'api2', animated: true },
              { id: 'e10', source: 'form2', target: 'api3', animated: true },
              { id: 'e11', source: 'api1', target: 'msg4', animated: true },
              { id: 'e12', source: 'api2', target: 'msg4', animated: true },
              { id: 'e13', source: 'api3', target: 'msg4', animated: true },
              { id: 'e14', source: 'msg4', target: 'end1', animated: true },
              { id: 'e15', source: 'msg4', target: 'end2', animated: true },
              { id: 'e16', source: 'msg4', target: 'end3', animated: true }
            ]
          },

          investigation_reship: {
            id: 'investigation_reship',
            parentId: 'track_order',
            name: 'Investigation + Reship',
            description: 'Open investigation case and reship order simultaneously',
            nodes: [
              { id: 'start', type: 'start', position: { x: 400, y: 0 }, data: { label: 'Investigation + Reship' } },
              { id: 'msg1', type: 'message', position: { x: 350, y: 150 }, data: { persona: 'amy', content: "Okay, I'll get that started for you. Our team will open the investigation with the carrier and we'll reship your order in the meantime." } },
              { id: 'case1', type: 'case', position: { x: 350, y: 330 }, data: { type: 'shipping', subtype: 'pickup_investigation', priority: 'high', note: 'Package not at pickup location - investigation opened' } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 350, y: 510 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'msg2', type: 'message', position: { x: 350, y: 690 }, data: { persona: 'amy', content: "I've created both the investigation case and your reshipment. You'll receive tracking for the new shipment via email, and we'll keep you updated on the investigation." } },
              { id: 'end1', type: 'end', position: { x: 350, y: 870 }, data: { title: 'Investigation & Reship Complete', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'msg1', animated: true },
              { id: 'e2', source: 'msg1', target: 'case1', animated: true },
              { id: 'e3', source: 'case1', target: 'subflow_reship', animated: true },
              { id: 'e4', source: 'subflow_reship', target: 'msg2', animated: true },
              { id: 'e5', source: 'msg2', target: 'end1', animated: true }
            ]
          },

          shipping_refund_ladder: {
            id: 'shipping_refund_ladder',
            parentId: 'track_order',
            name: 'Shipping Refund Ladder',
            description: 'Progressive refund offers for shipping issues (20% ‚Üí 30% ‚Üí 40% ‚Üí 50% ‚Üí full)',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Shipping Refund Ladder' } },
              { id: 'offer1', type: 'offer', position: { x: 500, y: 150 }, data: { percent: 20, label: 'Keep product & reship', message: "I'd love to make this right for you. How about a <strong>20% refund PLUS we'll reship your order</strong> free of charge? That way you get some money back AND your products!", needsManagerApproval: false } },
              { id: 'offer2', type: 'offer', position: { x: 500, y: 350 }, data: { percent: 30, label: 'Keep product & reship', message: "I really want to help you here. Let me offer you a <strong>30% refund AND a free reship</strong>. You'll get a good chunk of money back plus we'll send out a new shipment right away.", needsManagerApproval: false } },
              { id: 'delay1', type: 'delay', position: { x: 500, y: 550 }, data: { duration: 8000, message: 'Checking with manager...' } },
              { id: 'offer3', type: 'offer', position: { x: 500, y: 750 }, data: { percent: 40, label: 'Keep product & reship', message: "Great news! My manager has approved a <strong>40% refund PLUS a free reship</strong> for you. This is a significant discount and we really want to make sure you're happy.", needsManagerApproval: true } },
              { id: 'delay2', type: 'delay', position: { x: 500, y: 950 }, data: { duration: 8000, message: 'Final manager check...' } },
              { id: 'offer4', type: 'offer', position: { x: 500, y: 1150 }, data: { percent: 50, label: 'Maximum offer + reship', message: "Okay, I've just spoken with my manager again and they've approved our <strong>maximum offer: 50% refund PLUS a free reship</strong>. This is the very best we can do ‚Äî you'll get half your money back and still receive your products.", needsManagerApproval: true, isFinal: true } },
              { id: 'case_full_refund', type: 'case', position: { x: 500, y: 1350 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'case_partial_refund', type: 'case', position: { x: 300, y: 1550 }, data: { type: 'refund', subtype: 'partial_refund_reship', priority: 'normal' } },
              { id: 'subflow_reship', type: 'subflow', position: { x: 300, y: 1750 }, data: { name: 'Reship Flow', slug: 'reship_flow', nodeCount: 8 } },
              { id: 'end1', type: 'end', position: { x: 500, y: 1950 }, data: { title: 'Full Refund Processed', showSurvey: true } },
              { id: 'end2', type: 'end', position: { x: 300, y: 1950 }, data: { title: 'Partial Refund + Reship', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'offer1', animated: true },
              { id: 'e2', source: 'offer1', target: 'offer2', sourceHandle: 'decline', label: 'Decline 20%', animated: true },
              { id: 'e3', source: 'offer1', target: 'case_partial_refund', sourceHandle: 'accept', label: 'Accept 20%', animated: true },
              { id: 'e4', source: 'offer2', target: 'delay1', sourceHandle: 'decline', label: 'Decline 30%', animated: true },
              { id: 'e5', source: 'offer2', target: 'case_partial_refund', sourceHandle: 'accept', label: 'Accept 30%', animated: true },
              { id: 'e6', source: 'delay1', target: 'offer3', animated: true },
              { id: 'e7', source: 'offer3', target: 'delay2', sourceHandle: 'decline', label: 'Decline 40%', animated: true },
              { id: 'e8', source: 'offer3', target: 'case_partial_refund', sourceHandle: 'accept', label: 'Accept 40%', animated: true },
              { id: 'e9', source: 'delay2', target: 'offer4', animated: true },
              { id: 'e10', source: 'offer4', target: 'case_full_refund', sourceHandle: 'decline', label: 'Decline 50%', animated: true },
              { id: 'e11', source: 'offer4', target: 'case_partial_refund', sourceHandle: 'accept', label: 'Accept 50%', animated: true },
              { id: 'e12', source: 'case_full_refund', target: 'end1', animated: true },
              { id: 'e13', source: 'case_partial_refund', target: 'subflow_reship', animated: true },
              { id: 'e14', source: 'subflow_reship', target: 'end2', animated: true }
            ]
          },

          order_refund_ladder: {
            id: 'order_refund_ladder',
            parentId: 'help_with_order',
            name: 'Order Refund Ladder',
            description: 'Progressive refund offers for order issues with 90-day guarantee check (20% ‚Üí 30% ‚Üí 40% ‚Üí 50% ‚Üí full)',
            nodes: [
              { id: 'start', type: 'start', position: { x: 500, y: 0 }, data: { label: 'Order Refund Ladder' } },
              { id: 'cond_guarantee', type: 'condition', position: { x: 500, y: 120 }, data: { variable: 'guarantee.eligible', operator: '===', value: 'true', yesLabel: 'Within 90 days', noLabel: 'Expired' } },
              { id: 'msg_guarantee_expired', type: 'message', position: { x: 700, y: 300 }, data: { persona: 'amy', content: "I really wish I could help with a refund, but I need to be upfront with you. üíî<br><br>The 90-day guarantee period has expired for this order. However, I still want to help. Let me create a case for our team to review." } },
              { id: 'case_guarantee_expired', type: 'case', position: { x: 700, y: 480 }, data: { type: 'refund', subtype: 'guarantee_expired', priority: 'normal' } },
              { id: 'end_guarantee_expired', type: 'end', position: { x: 700, y: 660 }, data: { title: 'Case Created for Review', showSurvey: true } },
              { id: 'offer1', type: 'offer', position: { x: 300, y: 300 }, data: { percent: 20, label: 'Keep product & continue trying', message: "I understand. As a valued customer, I'd like to offer you a <strong>20% partial refund</strong> while you keep the product and continue trying.", needsManagerApproval: false } },
              { id: 'offer2', type: 'offer', position: { x: 300, y: 480 }, data: { percent: 30, label: 'Keep product', message: "I really want to make this right. Let me offer you a <strong>30% refund</strong> ‚Äî that's a significant amount back while you keep everything.", needsManagerApproval: false } },
              { id: 'delay1', type: 'delay', position: { x: 300, y: 660 }, data: { duration: 8000, message: 'Checking with manager...' } },
              { id: 'offer3', type: 'offer', position: { x: 300, y: 840 }, data: { percent: 40, label: 'Keep product', message: "Great news! My manager has approved a <strong>40% refund</strong> for you. That's nearly half your money back and you still get to keep the products.", needsManagerApproval: true } },
              { id: 'delay2', type: 'delay', position: { x: 300, y: 1020 }, data: { duration: 8000, message: 'Final manager check...' } },
              { id: 'offer4', type: 'offer', position: { x: 300, y: 1200 }, data: { percent: 50, label: 'Maximum offer', message: "Okay, I've just spoken with my manager again and they've approved our <strong>maximum offer: 50% refund</strong>. This is the very best we can do ‚Äî half your money back, no return needed.", needsManagerApproval: true, isFinal: true } },
              { id: 'case_full_refund', type: 'case', position: { x: 300, y: 1380 }, data: { type: 'refund', subtype: 'full_refund', priority: 'normal' } },
              { id: 'case_partial_refund', type: 'case', position: { x: 100, y: 1560 }, data: { type: 'refund', subtype: 'partial_refund', priority: 'normal' } },
              { id: 'end_full_refund', type: 'end', position: { x: 300, y: 1560 }, data: { title: 'Full Refund Processed', showSurvey: true } },
              { id: 'end_partial_refund', type: 'end', position: { x: 100, y: 1740 }, data: { title: 'Partial Refund Processed', showSurvey: true } }
            ],
            edges: [
              { id: 'e1', source: 'start', target: 'cond_guarantee', animated: true },
              { id: 'e2', source: 'cond_guarantee', target: 'offer1', sourceHandle: 'yes', label: 'Within 90 days', animated: true },
              { id: 'e3', source: 'cond_guarantee', target: 'msg_guarantee_expired', sourceHandle: 'no', label: 'Expired', animated: true },
              { id: 'e4', source: 'msg_guarantee_expired', target: 'case_guarantee_expired', animated: true },
              { id: 'e5', source: 'case_guarantee_expired', target: 'end_guarantee_expired', animated: true },
              { id: 'e6', source: 'offer1', target: 'offer2', sourceHandle: 'decline', label: 'Decline 20%', animated: true },
              { id: 'e7', source: 'offer1', target: 'case_partial_refund', sourceHandle: 'accept', label: 'Accept 20%', animated: true },
              { id: 'e8', source: 'offer2', target: 'delay1', sourceHandle: 'decline', label: 'Decline 30%', animated: true },
              { id: 'e9', source: 'offer2', target: 'case_partial_refund', sourceHandle: 'accept', label: 'Accept 30%', animated: true },
              { id: 'e10', source: 'delay1', target: 'offer3', animated: true },
              { id: 'e11', source: 'offer3', target: 'delay2', sourceHandle: 'decline', label: 'Decline 40%', animated: true },
              { id: 'e12', source: 'offer3', target: 'case_partial_refund', sourceHandle: 'accept', label: 'Accept 40%', animated: true },
              { id: 'e13', source: 'delay2', target: 'offer4', animated: true },
              { id: 'e14', source: 'offer4', target: 'case_full_refund', sourceHandle: 'decline', label: 'Decline 50%', animated: true },
              { id: 'e15', source: 'offer4', target: 'case_partial_refund', sourceHandle: 'accept', label: 'Accept 50%', animated: true },
              { id: 'e16', source: 'case_full_refund', target: 'end_full_refund', animated: true },
              { id: 'e17', source: 'case_partial_refund', target: 'end_partial_refund', animated: true }
            ]
          }
        }
      };

      // ============================================
      // CUSTOM NODE COMPONENTS
      // ============================================
      const StartNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: {
            padding: '16px 32px',
            borderRadius: '12px',
            background: '#22c55e',
            color: 'white',
            fontWeight: 600,
            fontSize: '15px',
            display: 'flex',
            alignItems: 'center',
            justifyContent: 'center',
            gap: '10px',
            boxShadow: selected ? '0 0 0 2px #22c55e, 0 0 0 4px rgba(34, 197, 94, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)',
            minWidth: '140px',
            cursor: 'pointer'
          }
        },
          React.createElement(Icons.Play, null),
          React.createElement('span', null, 'Start'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#16a34a', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const MessageNode = ({ data, selected }) => {
        const personas = { amy: 'Amy', claudia: 'Claudia', sarah: 'Sarah' };
        return React.createElement('div', {
          style: {
            padding: '16px',
            borderRadius: '12px',
            background: 'white',
            border: selected ? '2px solid #3b82f6' : '2px solid #e5e7eb',
            boxShadow: selected ? '0 0 0 2px rgba(59, 130, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)',
            minWidth: '200px',
            maxWidth: '280px',
            cursor: 'pointer'
          }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#3b82f6', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#3b82f6' } }, React.createElement(Icons.MessageSquare, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, personas[data.persona] || 'Amy')
          ),
          React.createElement('p', { style: { fontSize: '14px', color: '#2D3748', lineHeight: '1.5', margin: 0 } }, data.content || 'Hello! How can I help you today?'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#3b82f6', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const OptionsNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #8b5cf6' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(139, 92, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', maxWidth: '280px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#8b5cf6' } }, React.createElement(Icons.List, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Options')
          ),
          React.createElement('p', { style: { fontSize: '14px', color: '#2D3748', marginBottom: '12px', fontWeight: 500 } }, data.prompt || 'What would you like to do?'),
          (data.options || []).slice(0, 3).map((opt, i) => React.createElement('div', { key: i, style: { fontSize: '12px', color: '#6b7280', padding: '8px 12px', background: '#f9fafb', borderRadius: '6px', marginBottom: '6px', border: '1px solid rgba(0, 0, 0, 0.08)' } }, opt.label)),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const ConditionNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #f59e0b' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(245, 158, 11, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#f59e0b', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#fef3c7', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#f59e0b' } }, React.createElement(Icons.GitBranch, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Condition')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#6b7280', fontFamily: 'monospace', margin: 0 } }, data.variable || '{{variable}}'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'yes', style: { background: '#22c55e', width: '10px', height: '10px', border: '2px solid white', left: '30%' } }),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'no', style: { background: '#ef4444', width: '10px', height: '10px', border: '2px solid white', left: '70%' } })
        );
      };

      const ApiNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #ec4899' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(236, 72, 153, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#ec4899', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#fce7f3', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#ec4899' } }, React.createElement(Icons.Zap, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'API Call')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, `${data.service || 'Shopify'}, ${data.endpoint || 'lookup'}`),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#ec4899', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const AiNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #6366f1' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(99, 102, 241, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#6366f1', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#e0e7ff', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#6366f1' } }, React.createElement(Icons.Bot, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'AI Response')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, 'GPT-powered reply'),
          React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px' } }, data.model || 'gpt-4o-mini'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#6366f1', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const OfferNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '20px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #14b8a6' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(20, 184, 166, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '220px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#14b8a6', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '16px' } },
            React.createElement('div', { style: { width: '32px', height: '32px', borderRadius: '50%', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#14b8a6' } }, React.createElement(Icons.Gift, null)),
            React.createElement('span', { style: { fontSize: '14px', fontWeight: 500, color: '#14b8a6' } }, 'Offer Card')
          ),
          React.createElement('p', { style: { fontSize: '28px', fontWeight: 700, color: '#10b981', margin: 0 } }, `${data.percent || 20}% Refund`),
          React.createElement('p', { style: { fontSize: '14px', color: '#6b7280', marginTop: '6px', marginBottom: '16px' } }, data.label || 'Keep product'),
          React.createElement('div', { style: { display: 'flex', justifyContent: 'space-around', paddingTop: '12px', borderTop: '1px solid #f3f4f6' } },
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Accept'),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Decline')
          ),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'accept', style: { background: '#22c55e', width: '12px', height: '12px', border: '2px solid white', left: '25%' } }),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, id: 'decline', style: { background: '#ef4444', width: '12px', height: '12px', border: '2px solid white', left: '75%' } })
        );
      };

      const CaseNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #f97316' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(249, 115, 22, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#f97316', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ffedd5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#f97316' } }, React.createElement(Icons.FolderOpen, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, 'Create Case')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, 'Submit to Hub'),
          React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px' } }, `Type: ${data.type || 'refund'}`),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#f97316', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const FormNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #10b981' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(16, 185, 129, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#10b981' } }, React.createElement(Icons.FileText, null)),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#6b7280' } }, data.formType || 'Form')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, data.label || 'Collect user input'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const EndNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px 20px', borderRadius: '12px', background: '#ef4444', border: selected ? '2px solid #dc2626' : '2px solid #ef4444', boxShadow: selected ? '0 0 0 3px rgba(239, 68, 68, 0.3), 0 10px 15px -3px rgba(0,0,0,0.15)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '180px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#fca5a5', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '8px' } },
            React.createElement('div', { style: { color: 'white' } }, React.createElement(Icons.Flag, null)),
            React.createElement('span', { style: { fontSize: '14px', fontWeight: 600, color: 'white' } }, 'End')
          ),
          React.createElement('p', { style: { fontSize: '15px', color: 'rgba(255,255,255,0.9)', margin: 0, fontWeight: 500 } }, data.title || 'Thank You!')
        );
      };

      const SubflowNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px 20px', borderRadius: '12px', background: 'white', border: selected ? '2px dashed #8b5cf6' : '2px dashed #c4b5fd', boxShadow: selected ? '0 0 0 2px rgba(139, 92, 246, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 4px 6px -1px rgba(0,0,0,0.05)', minWidth: '220px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#ede9fe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#8b5cf6' } },
              React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                React.createElement('path', { d: 'M10 13a5 5 0 0 0 7.54.54l3-3a5 5 0 0 0-7.07-7.07l-1.72 1.71' }),
                React.createElement('path', { d: 'M14 11a5 5 0 0 0-7.54-.54l-3 3a5 5 0 0 0 7.07 7.07l1.71-1.71' })
              )
            ),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#8b5cf6' } }, 'Subflow')
          ),
          React.createElement('p', { style: { fontSize: '15px', fontWeight: 600, color: '#2D3748', margin: 0 } }, data.name || 'Go to Subflow'),
          data.nodeCount && React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px' } }, `${data.nodeCount} nodes`),
          React.createElement('p', { style: { fontSize: '12px', color: '#8b5cf6', marginTop: '6px' } }, 'Click to view ‚Üí'),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#8b5cf6', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      // Delay Node - Manager approval delay simulation
      const DelayNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', border: selected ? '2px solid #f59e0b' : '2px solid #fcd34d', boxShadow: selected ? '0 0 0 2px rgba(245, 158, 11, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#f59e0b', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#fbbf24', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#78350f' } },
              React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                React.createElement('circle', { cx: 12, cy: 12, r: 10 }),
                React.createElement('polyline', { points: '12 6 12 12 16 14' })
              )
            ),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 600, color: '#78350f' } }, 'Manager Delay')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#92400e', margin: 0, fontWeight: 500 } }, data.message || 'Checking with manager...'),
          React.createElement('p', { style: { fontSize: '11px', color: '#b45309', marginTop: '6px', fontFamily: 'monospace' } }, `‚è±Ô∏è ${(data.duration || 8000) / 1000}s delay`),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#f59e0b', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      // Evidence/Photo Upload Node
      const EvidenceNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #06b6d4' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(6, 182, 212, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#06b6d4', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#cffafe', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#06b6d4' } },
              React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                React.createElement('rect', { x: 3, y: 3, width: 18, height: 18, rx: 2 }),
                React.createElement('circle', { cx: 8.5, cy: 8.5, r: 1.5 }),
                React.createElement('polyline', { points: '21 15 16 10 5 21' })
              )
            ),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#0891b2' } }, 'Photo Upload')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, data.label || 'Upload evidence photos'),
          data.description && React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px' } }, data.description),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#06b6d4', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      // Input Node - Text input collection
      const InputNode = ({ data, selected }) => {
        return React.createElement('div', {
          style: { padding: '16px', borderRadius: '12px', background: 'white', border: selected ? '2px solid #10b981' : '2px solid #e5e7eb', boxShadow: selected ? '0 0 0 2px rgba(16, 185, 129, 0.2), 0 10px 15px -3px rgba(0,0,0,0.1)' : '0 10px 15px -3px rgba(0,0,0,0.1)', minWidth: '200px', cursor: 'pointer' }
        },
          React.createElement(Handle, { type: 'target', position: Position.Top, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } }),
          React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px', marginBottom: '10px' } },
            React.createElement('div', { style: { width: '28px', height: '28px', borderRadius: '50%', background: '#d1fae5', display: 'flex', alignItems: 'center', justifyContent: 'center', color: '#10b981' } },
              React.createElement('svg', { width: 14, height: 14, viewBox: '0 0 24 24', fill: 'none', stroke: 'currentColor', strokeWidth: 2 },
                React.createElement('path', { d: 'M17 3a2.828 2.828 0 1 1 4 4L7.5 20.5 2 22l1.5-5.5L17 3z' })
              )
            ),
            React.createElement('span', { style: { fontSize: '13px', fontWeight: 500, color: '#059669' } }, 'Text Input')
          ),
          React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0 } }, data.label || 'Enter text...'),
          data.placeholder && React.createElement('p', { style: { fontSize: '11px', color: '#718096', marginTop: '4px', fontStyle: 'italic' } }, `"${data.placeholder}"`),
          React.createElement(Handle, { type: 'source', position: Position.Bottom, style: { background: '#10b981', width: '10px', height: '10px', border: '2px solid white' } })
        );
      };

      const nodeTypes = { 
        start: StartNode, 
        message: MessageNode, 
        options: OptionsNode, 
        condition: ConditionNode, 
        api: ApiNode, 
        ai: AiNode, 
        offer: OfferNode, 
        case: CaseNode, 
        form: FormNode, 
        end: EndNode, 
        subflow: SubflowNode,
        delay: DelayNode,
        evidence: EvidenceNode,
        input: InputNode
      };

      // ============================================
      // LEFT PANEL - FLOW NAVIGATION WITH CARDS
      // ============================================
      const FlowNavigationPanel = ({ 
        parentFlows, 
        subflows, 
        selectedParentId, 
        selectedSubflowId, 
        viewingEntry,
        onSelectParent,
        onSelectSubflow,
        onSelectEntry 
      }) => {
        const [expandedParents, setExpandedParents] = useState({ [selectedParentId]: true });

        const toggleParent = (parentId) => {
          setExpandedParents(prev => ({ ...prev, [parentId]: !prev[parentId] }));
        };

        const selectedParent = parentFlows.find(p => p.id === selectedParentId);

        return React.createElement('div', { 
          style: { 
            width: '300px', 
            background: '#f8fafc', 
            borderRight: '1px solid #e5e7eb', 
            display: 'flex', 
            flexDirection: 'column', 
            flexShrink: 0,
            height: '100vh'
          } 
        },
          // Header with Back to Hub
          React.createElement('div', { style: { padding: '16px 20px', borderBottom: '1px solid #e5e7eb', background: 'white' } },
            React.createElement('a', { 
              href: '/hub', 
              style: { 
                display: 'flex', 
                alignItems: 'center', 
                gap: '8px', 
                color: '#6366f1', 
                textDecoration: 'none', 
                fontSize: '14px', 
                fontWeight: 500,
                marginBottom: '16px'
              } 
            }, 
              React.createElement(Icons.ArrowLeft, null), 
              'Back to Hub'
            ),
            React.createElement('h1', { style: { fontSize: '18px', fontWeight: 700, color: '#111827', margin: 0 } }, 'Flow Documentation'),
            React.createElement('p', { style: { fontSize: '13px', color: '#6b7280', marginTop: '4px' } }, 'Select a flow to view')
          ),

          // Flow list
          React.createElement('div', { style: { flex: 1, overflowY: 'auto', padding: '16px' } },
            parentFlows.map(parent => {
              const isExpanded = expandedParents[parent.id];
              const isSelected = selectedParentId === parent.id;
              const parentSubflows = parent.subflows.map(id => subflows[id]).filter(Boolean);

              return React.createElement('div', { key: parent.id, style: { marginBottom: '12px' } },
                // Parent Flow Card
                React.createElement('div', {
                  className: `flow-card parent ${isSelected ? 'active' : ''}`,
                  onClick: () => {
                    toggleParent(parent.id);
                    if (!isExpanded) {
                      onSelectParent(parent);
                      onSelectEntry();
                    }
                  },
                  style: { 
                    display: 'flex', 
                    alignItems: 'center', 
                    gap: '12px',
                    background: isSelected ? `linear-gradient(135deg, ${parent.color}10 0%, ${parent.color}05 100%)` : undefined,
                    borderColor: isSelected ? parent.color : undefined
                  }
                },
                  React.createElement('div', { style: { fontSize: '24px' } }, parent.icon),
                  React.createElement('div', { style: { flex: 1, minWidth: 0 } },
                    React.createElement('div', { style: { fontSize: '14px', fontWeight: 600, color: '#111827' } }, parent.name),
                    React.createElement('div', { style: { fontSize: '12px', color: '#6b7280', marginTop: '2px' } }, `${parentSubflows.length + 1} flows`)
                  ),
                  React.createElement('div', { 
                    style: { 
                      color: '#718096',
                      transform: isExpanded ? 'rotate(180deg)' : 'rotate(0)',
                      transition: 'transform 0.2s'
                    } 
                  }, React.createElement(Icons.ChevronDown, null))
                ),

                // Subflows (when expanded)
                isExpanded && React.createElement('div', { style: { marginLeft: '16px', marginTop: '8px' } },
                  // Entry Flow
                  React.createElement('div', {
                    className: `flow-card ${viewingEntry && isSelected ? 'active' : ''}`,
                    onClick: () => { onSelectParent(parent); onSelectEntry(); }
                  },
                    React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px' } },
                      React.createElement('div', { style: { width: '8px', height: '8px', borderRadius: '50%', background: viewingEntry && isSelected ? parent.color : '#d1d5db' } }),
                      React.createElement('div', null,
                        React.createElement('div', { style: { fontSize: '13px', fontWeight: 500, color: '#2D3748' } }, 'Entry Flow'),
                        React.createElement('div', { style: { fontSize: '11px', color: '#718096' } }, `${parent.entryNodes?.length || 0} nodes`)
                      )
                    )
                  ),

                  // Subflows
                  parentSubflows.map(subflow => 
                    React.createElement('div', {
                      key: subflow.id,
                      className: `flow-card ${!viewingEntry && selectedSubflowId === subflow.id ? 'active' : ''}`,
                      onClick: () => { onSelectParent(parent); onSelectSubflow(subflow); }
                    },
                      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '10px' } },
                        React.createElement('div', { style: { width: '8px', height: '8px', borderRadius: '50%', background: !viewingEntry && selectedSubflowId === subflow.id ? parent.color : '#d1d5db' } }),
                        React.createElement('div', { style: { flex: 1, minWidth: 0 } },
                          React.createElement('div', { style: { fontSize: '13px', fontWeight: 500, color: '#2D3748', overflow: 'hidden', textOverflow: 'ellipsis', whiteSpace: 'nowrap' } }, subflow.name),
                          React.createElement('div', { style: { fontSize: '11px', color: '#718096' } }, `${subflow.nodes?.length || 0} nodes`)
                        )
                      )
                    )
                  )
                )
              );
            })
          )
        );
      };

      // ============================================
      // RIGHT PANEL - NODE PROPERTIES (Enhanced)
      // ============================================
      const NodePropertiesPanel = ({ selectedNode, onSimulate }) => {
        const [expandedSections, setExpandedSections] = useState({ prompt: false, request: false, response: false });
        
        const toggleSection = (section) => {
          setExpandedSections(prev => ({ ...prev, [section]: !prev[section] }));
        };

        if (!selectedNode) {
          return React.createElement('div', { 
            style: { 
              width: '360px', 
              background: 'white',
              borderLeft: '1px solid #e5e7eb',
              display: 'flex',
              flexDirection: 'column',
              alignItems: 'center',
              justifyContent: 'center',
              padding: '40px',
              color: '#718096'
            } 
          },
            React.createElement('div', { style: { width: '64px', height: '64px', margin: '0 auto 20px', background: '#f3f4f6', borderRadius: '16px', display: 'flex', alignItems: 'center', justifyContent: 'center' } },
              React.createElement(Icons.Eye, null)
            ),
            React.createElement('p', { style: { fontWeight: 600, marginBottom: '6px', color: '#6b7280', fontSize: '15px' } }, 'Select a node'),
            React.createElement('p', { style: { fontSize: '13px', textAlign: 'center', lineHeight: '1.5' } }, 'Click on any node in the canvas to view its properties and details')
          );
        }

        const getIcon = () => {
          const iconMap = { message: Icons.MessageSquare, options: Icons.List, condition: Icons.GitBranch, api: Icons.Zap, ai: Icons.Bot, offer: Icons.Gift, case: Icons.FolderOpen, form: Icons.FileText, end: Icons.Flag, start: Icons.Play, delay: Icons.Play, evidence: Icons.FileText, input: Icons.FileText };
          const IconComp = iconMap[selectedNode.type] || Icons.Play;
          return React.createElement(IconComp);
        };

        const getNodeTitle = () => {
          const titles = {
            ai: 'AI Response (OpenAI)',
            api: 'API Integration',
            offer: 'Refund Offer',
            delay: 'Manager Delay',
            evidence: 'Photo Upload',
            input: 'Text Input',
            form: 'Form Input',
            case: 'Case Creation',
            condition: 'Condition Check',
            options: 'User Options',
            message: 'Bot Message',
            start: 'Flow Start',
            end: 'Flow End',
            subflow: 'Subflow Link'
          };
          return titles[selectedNode.type] || (selectedNode.type + ' Node');
        };

        return React.createElement('div', { 
          style: { 
            width: '360px', 
            background: 'white',
            borderLeft: '1px solid #e5e7eb',
            display: 'flex',
            flexDirection: 'column',
            flexShrink: 0
          } 
        },
          // Header
          React.createElement('div', { style: { padding: '20px', borderBottom: '1px solid #f3f4f6' } },
            React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
              React.createElement('div', { 
                style: { width: '40px', height: '40px', borderRadius: '10px', background: (nodeColors[selectedNode.type] || '#94a3b8') + '15', display: 'flex', alignItems: 'center', justifyContent: 'center', color: nodeColors[selectedNode.type] || '#94a3b8' } 
              }, getIcon()),
              React.createElement('div', { style: { flex: 1 } },
                React.createElement('h3', { style: { fontSize: '15px', fontWeight: 600, margin: 0, color: '#111827' } }, getNodeTitle()),
                React.createElement('p', { style: { fontSize: '11px', color: '#718096', margin: 0, marginTop: '2px', fontFamily: 'monospace' } }, `ID: ${selectedNode.id}`)
              )
            ),
            // Simulate Button
            (selectedNode.type === 'message' || selectedNode.type === 'options' || selectedNode.type === 'offer' || selectedNode.type === 'form') &&
            React.createElement('button', {
              onClick: () => onSimulate && onSimulate(selectedNode),
              style: { 
                marginTop: '12px', 
                width: '100%', 
                padding: '10px 16px', 
                background: 'linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%)', 
                color: 'white', 
                border: 'none', 
                borderRadius: '8px', 
                fontSize: '13px', 
                fontWeight: 600, 
                cursor: 'pointer',
                display: 'flex',
                alignItems: 'center',
                justifyContent: 'center',
                gap: '8px'
              }
            }, 
              React.createElement(Icons.Eye, null),
              'View in Simulator'
            )
          ),

          // Content
          React.createElement('div', { style: { flex: 1, padding: '16px', overflowY: 'auto' } },
            // Node Type Badge
            React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('span', { 
                style: { display: 'inline-block', padding: '4px 10px', background: (nodeColors[selectedNode.type] || '#94a3b8') + '15', color: nodeColors[selectedNode.type] || '#94a3b8', borderRadius: '6px', fontSize: '11px', fontWeight: 600, textTransform: 'uppercase', letterSpacing: '0.5px' } 
              }, selectedNode.type)
            ),

            // === AI NODE DETAILS ===
            selectedNode.type === 'ai' && React.createElement('div', null,
              // Model Info
              React.createElement('div', { style: { marginBottom: '16px', padding: '12px', background: '#eef2ff', borderRadius: '10px', border: '1px solid #c7d2fe' } },
                React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' } },
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#6366f1', fontWeight: 600, textTransform: 'uppercase' } }, 'Model'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#4338ca' } }, selectedNode.data.model || 'gpt-4o-mini')
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#6366f1', fontWeight: 600, textTransform: 'uppercase' } }, 'Temperature'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#4338ca' } }, selectedNode.data.temperature || '0.7')
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#6366f1', fontWeight: 600, textTransform: 'uppercase' } }, 'Max Tokens'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#4338ca' } }, selectedNode.data.maxTokens || '800')
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#6366f1', fontWeight: 600, textTransform: 'uppercase' } }, 'Scenario'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#4338ca' } }, selectedNode.data.scenarioType || 'custom')
                  )
                )
              ),
              // System Prompt
              selectedNode.data.systemPrompt && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('div', { 
                  onClick: () => toggleSection('prompt'),
                  style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer', padding: '10px 12px', background: '#f9fafb', borderRadius: '8px', border: '1px solid rgba(0, 0, 0, 0.08)' }
                },
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: '#2D3748' } }, 'System Prompt'),
                  React.createElement('span', { style: { fontSize: '10px', color: '#6b7280' } }, expandedSections.prompt ? '‚ñº' : '‚ñ∂')
                ),
                expandedSections.prompt && React.createElement('div', { 
                  style: { marginTop: '8px', padding: '12px', background: '#1e1b4b', borderRadius: '8px', maxHeight: '200px', overflowY: 'auto' }
                },
                  React.createElement('pre', { style: { fontSize: '11px', color: '#c7d2fe', whiteSpace: 'pre-wrap', margin: 0, fontFamily: 'monospace', lineHeight: '1.5' } }, selectedNode.data.systemPrompt)
                )
              ),
              // User Prompt Template
              selectedNode.data.userPromptTemplate && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'User Prompt Template'),
                React.createElement('div', { style: { padding: '10px 12px', background: '#fdf4ff', borderRadius: '8px', border: '1px solid #e9d5ff' } },
                  React.createElement('code', { style: { fontSize: '11px', color: '#7e22ce', whiteSpace: 'pre-wrap' } }, selectedNode.data.userPromptTemplate)
                )
              )
            ),

            // === API NODE DETAILS ===
            selectedNode.type === 'api' && React.createElement('div', null,
              // Service & Endpoint
              React.createElement('div', { style: { marginBottom: '16px', padding: '12px', background: '#fdf4ff', borderRadius: '10px', border: '1px solid #f5d0fe' } },
                React.createElement('div', { style: { fontSize: '10px', color: '#a855f7', fontWeight: 600, textTransform: 'uppercase', marginBottom: '4px' } }, 'Service'),
                React.createElement('div', { style: { fontSize: '16px', fontWeight: 700, color: '#7e22ce', marginBottom: '12px' } }, selectedNode.data.service),
                React.createElement('div', { style: { fontSize: '10px', color: '#a855f7', fontWeight: 600, textTransform: 'uppercase', marginBottom: '4px' } }, 'Endpoint'),
                React.createElement('code', { style: { display: 'block', fontSize: '12px', color: '#581c87', background: '#fae8ff', padding: '8px 10px', borderRadius: '6px', fontFamily: 'monospace' } }, selectedNode.data.endpoint)
              ),
              // Description
              selectedNode.data.description && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Description'),
                React.createElement('p', { style: { fontSize: '13px', color: '#2D3748', margin: 0, lineHeight: '1.5' } }, selectedNode.data.description)
              ),
              // Request Schema
              selectedNode.data.request && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('div', { 
                  onClick: () => toggleSection('request'),
                  style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer', padding: '10px 12px', background: '#ecfdf5', borderRadius: '8px', border: '1px solid #a7f3d0' }
                },
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: '#059669' } }, 'Request Schema'),
                  React.createElement('span', { style: { fontSize: '10px', color: '#6b7280' } }, expandedSections.request ? '‚ñº' : '‚ñ∂')
                ),
                expandedSections.request && React.createElement('pre', { 
                  style: { marginTop: '8px', padding: '12px', background: '#064e3b', borderRadius: '8px', fontSize: '11px', color: '#6ee7b7', fontFamily: 'monospace', whiteSpace: 'pre-wrap', margin: 0 }
                }, selectedNode.data.request)
              ),
              // Response Schema
              selectedNode.data.response && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('div', { 
                  onClick: () => toggleSection('response'),
                  style: { display: 'flex', alignItems: 'center', justifyContent: 'space-between', cursor: 'pointer', padding: '10px 12px', background: '#eff6ff', borderRadius: '8px', border: '1px solid #bfdbfe' }
                },
                  React.createElement('span', { style: { fontSize: '12px', fontWeight: 600, color: '#2563eb' } }, 'Response Schema'),
                  React.createElement('span', { style: { fontSize: '10px', color: '#6b7280' } }, expandedSections.response ? '‚ñº' : '‚ñ∂')
                ),
                expandedSections.response && React.createElement('pre', { 
                  style: { marginTop: '8px', padding: '12px', background: '#1e3a8a', borderRadius: '8px', fontSize: '11px', color: '#93c5fd', fontFamily: 'monospace', whiteSpace: 'pre-wrap', margin: 0 }
                }, selectedNode.data.response)
              )
            ),

            // === OFFER NODE DETAILS ===
            selectedNode.type === 'offer' && React.createElement('div', null,
              React.createElement('div', { style: { padding: '20px', background: 'linear-gradient(135deg, #d1fae5 0%, #a7f3d0 100%)', borderRadius: '12px', textAlign: 'center', marginBottom: '16px' } },
                React.createElement('div', { style: { fontSize: '40px', fontWeight: 700, color: '#059669' } }, `${selectedNode.data.percent}%`),
                React.createElement('div', { style: { fontSize: '14px', color: '#047857', marginTop: '4px', fontWeight: 500 } }, selectedNode.data.label || 'Partial Refund')
              ),
              selectedNode.data.message && React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Offer Message'),
                React.createElement('div', { style: { padding: '12px', background: '#f9fafb', borderRadius: '10px', fontSize: '13px', lineHeight: '1.6', border: '1px solid rgba(0, 0, 0, 0.08)' } }, selectedNode.data.message)
              ),
              React.createElement('div', { style: { display: 'flex', gap: '8px', flexWrap: 'wrap' } },
                selectedNode.data.needsManagerApproval && React.createElement('span', { style: { padding: '4px 10px', background: '#fef3c7', color: '#b45309', borderRadius: '20px', fontSize: '11px', fontWeight: 500 } }, 'üëî Manager Approval'),
                selectedNode.data.isFinal && React.createElement('span', { style: { padding: '4px 10px', background: '#fee2e2', color: '#dc2626', borderRadius: '20px', fontSize: '11px', fontWeight: 500 } }, 'üèÅ Final Offer'),
                selectedNode.data.forFuture && React.createElement('span', { style: { padding: '4px 10px', background: '#dbeafe', color: '#2563eb', borderRadius: '20px', fontSize: '11px', fontWeight: 500 } }, 'üìÖ Future Discount')
              )
            ),

            // === DELAY NODE DETAILS ===
            selectedNode.type === 'delay' && React.createElement('div', null,
              React.createElement('div', { style: { padding: '20px', background: 'linear-gradient(135deg, #fef3c7 0%, #fde68a 100%)', borderRadius: '12px', textAlign: 'center', marginBottom: '16px' } },
                React.createElement('div', { style: { fontSize: '32px', fontWeight: 700, color: '#92400e' } }, `${(selectedNode.data.duration || 8000) / 1000}s`),
                React.createElement('div', { style: { fontSize: '14px', color: '#b45309', marginTop: '4px', fontWeight: 500 } }, 'Delay Duration')
              ),
              React.createElement('div', { style: { marginBottom: '16px' } },
                React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Loading Message'),
                React.createElement('div', { style: { padding: '12px', background: '#f9fafb', borderRadius: '10px', fontSize: '13px', border: '1px solid rgba(0, 0, 0, 0.08)' } }, selectedNode.data.message || 'Please wait...')
              ),
              React.createElement('p', { style: { fontSize: '12px', color: '#6b7280', margin: 0, fontStyle: 'italic' } }, 'This simulates manager approval time to make the experience feel more authentic.')
            ),

            // === CONDITION NODE DETAILS ===
            selectedNode.type === 'condition' && React.createElement('div', null,
              React.createElement('div', { style: { padding: '14px', background: '#fffbeb', borderRadius: '10px', border: '1px solid #fde68a', marginBottom: '16px' } },
                React.createElement('div', { style: { fontSize: '10px', color: '#b45309', fontWeight: 600, textTransform: 'uppercase', marginBottom: '8px' } }, 'Condition Logic'),
                React.createElement('code', { style: { display: 'block', fontSize: '13px', color: '#78350f', fontFamily: 'monospace', background: '#fef3c7', padding: '10px', borderRadius: '6px' } }, 
                  `if (${selectedNode.data.variable} ${selectedNode.data.operator || '==='} "${selectedNode.data.value || ''}")`
                )
              ),
              React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' } },
                React.createElement('div', { style: { padding: '10px', background: '#dcfce7', borderRadius: '8px', textAlign: 'center' } },
                  React.createElement('div', { style: { fontSize: '10px', color: '#16a34a', fontWeight: 600 } }, 'YES BRANCH'),
                  React.createElement('div', { style: { fontSize: '12px', color: '#15803d', fontWeight: 500, marginTop: '4px' } }, selectedNode.data.yesLabel || 'True')
                ),
                React.createElement('div', { style: { padding: '10px', background: '#fee2e2', borderRadius: '8px', textAlign: 'center' } },
                  React.createElement('div', { style: { fontSize: '10px', color: '#dc2626', fontWeight: 600 } }, 'NO BRANCH'),
                  React.createElement('div', { style: { fontSize: '12px', color: '#b91c1c', fontWeight: 500, marginTop: '4px' } }, selectedNode.data.noLabel || 'False')
                )
              )
            ),

            // Persona (for message/ai nodes)
            selectedNode.data?.persona && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Persona'),
              React.createElement('div', { style: { padding: '12px 14px', background: '#f9fafb', borderRadius: '10px', fontSize: '14px', border: '1px solid rgba(0, 0, 0, 0.08)', display: 'flex', alignItems: 'center', gap: '10px' } }, 
                React.createElement('div', { style: { width: '32px', height: '32px', borderRadius: '50%', background: selectedNode.data.persona === 'claudia' ? '#fce7f3' : '#dbeafe', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '14px' } }, selectedNode.data.persona === 'claudia' ? 'üêï' : 'üë©'),
                React.createElement('div', null,
                  React.createElement('div', { style: { fontWeight: 600, color: '#2D3748' } }, selectedNode.data.persona === 'amy' ? 'Amy' : selectedNode.data.persona === 'claudia' ? 'Claudia' : selectedNode.data.persona),
                  React.createElement('div', { style: { fontSize: '11px', color: '#718096' } }, selectedNode.data.persona === 'claudia' ? 'Dog Trainer' : 'Customer Support')
                )
              )
            ),

            // Message Content (for message nodes)
            selectedNode.data?.content && selectedNode.type === 'message' && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Message Content'),
              React.createElement('div', { style: { padding: '12px 14px', background: '#f9fafb', borderRadius: '10px', fontSize: '14px', lineHeight: '1.6', border: '1px solid rgba(0, 0, 0, 0.08)', color: '#2D3748' } }, selectedNode.data.content)
            ),

            // Options list
            selectedNode.data?.options && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, `Options (${selectedNode.data.options.length})`),
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '6px' } },
                selectedNode.data.options.map((opt, i) => 
                  React.createElement('div', { key: i, style: { padding: '10px 12px', background: '#f9fafb', borderRadius: '8px', fontSize: '13px', border: '1px solid rgba(0, 0, 0, 0.08)', display: 'flex', alignItems: 'center', gap: '8px' } },
                    React.createElement('span', { style: { width: '22px', height: '22px', borderRadius: '50%', background: '#8b5cf6', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '11px', fontWeight: 600, color: 'white' } }, opt.icon || (i + 1)),
                    opt.label || opt
                  )
                )
              )
            ),

            // Case Details
            selectedNode.type === 'case' && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Case Details'),
              React.createElement('div', { style: { padding: '12px 14px', background: '#fff7ed', borderRadius: '10px', border: '1px solid #fed7aa' } },
                React.createElement('div', { style: { display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '8px' } },
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#ea580c', fontWeight: 600, textTransform: 'uppercase' } }, 'Type'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: '#c2410c', textTransform: 'capitalize' } }, selectedNode.data.type || 'general')
                  ),
                  React.createElement('div', null,
                    React.createElement('div', { style: { fontSize: '10px', color: '#ea580c', fontWeight: 600, textTransform: 'uppercase' } }, 'Priority'),
                    React.createElement('div', { style: { fontSize: '13px', fontWeight: 600, color: selectedNode.data.priority === 'high' ? '#dc2626' : '#374151', textTransform: 'capitalize' } }, selectedNode.data.priority || 'normal')
                  )
                ),
                selectedNode.data.subtype && React.createElement('div', { style: { marginTop: '8px' } },
                  React.createElement('div', { style: { fontSize: '10px', color: '#ea580c', fontWeight: 600, textTransform: 'uppercase' } }, 'Subtype'),
                  React.createElement('code', { style: { fontSize: '12px', color: '#9a3412', background: '#ffedd5', padding: '2px 6px', borderRadius: '4px' } }, selectedNode.data.subtype)
                ),
                selectedNode.data.note && React.createElement('div', { style: { marginTop: '8px', padding: '8px', background: '#fef3c7', borderRadius: '6px', fontSize: '12px', color: '#92400e' } },
                  '‚ö†Ô∏è ' + selectedNode.data.note
                )
              )
            ),

            // Form Fields
            selectedNode.type === 'form' && selectedNode.data?.fields && React.createElement('div', { style: { marginBottom: '16px' } },
              React.createElement('label', { style: { fontSize: '11px', fontWeight: 600, color: '#6b7280', display: 'block', marginBottom: '6px', textTransform: 'uppercase' } }, 'Form Fields'),
              React.createElement('div', { style: { display: 'flex', flexWrap: 'wrap', gap: '6px' } },
                selectedNode.data.fields.map((field, i) => 
                  React.createElement('span', { key: i, style: { padding: '4px 10px', background: '#ecfdf5', color: '#059669', borderRadius: '20px', fontSize: '12px', fontWeight: 500 } }, field)
                )
              )
            )
          )
        );
      };

      // ============================================
      // CHAT SIMULATOR COMPONENT
      // Renders nodes exactly as they appear in the actual chat app
      // ============================================
      // Map form types to actual messages from chat app (matches MESSAGES.common and actual flow)
      const FORM_MESSAGES = {
        'Item Selection': "Which item(s) do you need help with? Tap to select:",
        'Customer Lookup': '', // No message before initial form - form appears directly after welcome message
        'Deep Search': "I couldn't find an order with those details. Let's try a deeper search with your shipping information.",
        'Photo Upload': "First, could you upload a photo of everything you actually received? Please include the packaging too... this helps our team investigate what happened.",
      };
      
      const ChatSimulator = ({ node, onClose }) => {
        if (!node) return null;

        const personas = {
          amy: { name: 'Amy', role: 'Customer Support', avatar: 'https://images.unsplash.com/photo-1494790108377-be9c29b29330?w=100&h=100&fit=crop&crop=face', color: '#3b82f6' },
          claudia: { name: 'Claudia', role: 'Dog Trainer', avatar: 'https://images.unsplash.com/photo-1559839734-2b71ea197ec2?w=100&h=100&fit=crop&crop=face', color: '#ec4899' },
          sarah: { name: 'Sarah', role: 'CX Lead', avatar: 'https://images.unsplash.com/photo-1438761681033-6461ffad8d80?w=100&h=100&fit=crop&crop=face', color: '#8b5cf6' }
        };
        const persona = personas[node.data?.persona] || personas.amy;

        // Helper: Render message bubble (reusable for prompts/labels before forms/options)
        const renderMessageBubble = (messageText) => {
          // Check if content contains HTML tags (like <br>)
          const hasHTML = typeof messageText === 'string' && /<[a-z][\s\S]*>/i.test(messageText);
          
          return React.createElement('div', { style: { marginBottom: '8px' } },
            React.createElement('div', { style: { display: 'flex', gap: '12px', maxWidth: '85%' } },
              React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover', flexShrink: 0, marginTop: '4px' } }),
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px' } },
                React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px' } },
                  React.createElement('span', { style: { fontWeight: 600, color: '#2D3748' } }, persona.name),
                  React.createElement('span', { style: { color: '#718096', fontWeight: 400 } }, persona.role)
                ),
                React.createElement('div', { 
                  style: { padding: '14px 18px', background: 'white', borderRadius: '16px', borderBottomLeftRadius: '6px', border: '1px solid rgba(0, 0, 0, 0.08)', fontSize: '15px', lineHeight: '1.5', color: '#2D3748' },
                  ...(hasHTML ? { dangerouslySetInnerHTML: { __html: messageText } } : {})
                }, 
                  hasHTML ? null : messageText
                )
              )
            )
          );
        };

        // Render message bubble
        const renderMessage = () => {
          const messageContent = node.data?.content || node.data?.prompt || node.data?.message || "Hi! I'm Amy from PuppyPad. I can sort this out with you right here so you don't have to go back and forth over email. Just enter your details below. üôÇ";
          // Check if content contains HTML tags (like <br>)
          const hasHTML = typeof messageContent === 'string' && /<[a-z][\s\S]*>/i.test(messageContent);
          
          return React.createElement('div', { style: { display: 'flex', gap: '12px', maxWidth: '85%' } },
            React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover', flexShrink: 0, marginTop: '4px' } }),
            React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px' } },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px' } },
                React.createElement('span', { style: { fontWeight: 600, color: '#2D3748' } }, persona.name),
                React.createElement('span', { style: { color: '#718096' } }, persona.role)
              ),
              React.createElement('div', { 
                style: { padding: '14px 18px', background: 'white', borderRadius: '16px', borderBottomLeftRadius: '6px', border: '1px solid rgba(0, 0, 0, 0.08)', fontSize: '15px', lineHeight: '1.5', color: '#2D3748' },
                ...(hasHTML ? { dangerouslySetInnerHTML: { __html: messageContent } } : {})
              }, 
                hasHTML ? null : messageContent
              )
            )
          );
        };

        // Render options buttons
        const renderOptions = () => {
          const options = node.data?.options || [];
          return React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '10px', width: '100%', marginTop: '8px' } },
            options.map((opt, i) => 
              React.createElement('button', { 
                key: i, 
                style: { 
                  width: '100%',
                  display: 'flex', 
                  alignItems: 'center', 
                  gap: '12px', 
                  padding: '18px 20px', 
                  background: 'white', 
                  border: '1px solid rgba(0, 0, 0, 0.08)', 
                  borderRadius: '16px', 
                  cursor: 'pointer',
                  textAlign: 'left',
                  boxShadow: '0 1px 2px rgba(0, 0, 0, 0.05)',
                  transition: 'all 0.25s ease',
                  fontSize: '15px',
                  fontWeight: 500,
                  color: '#2D3748'
                },
                onMouseOver: (e) => { 
                  const btn = e.currentTarget;
                  btn.style.borderColor = '#1a365d';
                  btn.style.background = '#E8EEF4';
                  btn.style.transform = 'translateX(4px)';
                  btn.style.boxShadow = '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)';
                  const icon = btn.querySelector('.icon');
                  if (icon) {
                    icon.style.background = '#1a365d';
                    icon.style.color = 'white';
                    icon.style.transform = 'scale(1.1)';
                  }
                },
                onMouseOut: (e) => { 
                  const btn = e.currentTarget;
                  btn.style.borderColor = 'rgba(0, 0, 0, 0.08)';
                  btn.style.background = 'white';
                  btn.style.transform = 'translateX(0)';
                  btn.style.boxShadow = '0 1px 2px rgba(0, 0, 0, 0.05)';
                  const icon = btn.querySelector('.icon');
                  if (icon) {
                    icon.style.background = '#F3F4F6';
                    icon.style.color = 'inherit';
                    icon.style.transform = 'scale(1)';
                  }
                }
              },
                opt.icon && React.createElement('span', { style: { width: '40px', height: '40px', borderRadius: '12px', background: '#F3F4F6', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '20px', transition: 'all 0.25s ease', flexShrink: 0 }, className: 'icon' }, opt.icon),
                opt.label || opt
              )
            )
          );
        };

        // Render offer card
        const renderOffer = () => {
          return React.createElement('div', { style: { position: 'relative', background: 'linear-gradient(135deg, #1a365d 0%, #2c5282 100%)', borderRadius: '24px', padding: '32px 24px', textAlign: 'center', margin: '16px 0', color: 'white', boxShadow: '0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04), 0 0 40px rgba(26, 54, 93, 0.2)', overflow: 'hidden' } },
            React.createElement('div', { style: { fontSize: '40px', marginBottom: '12px', position: 'relative', zIndex: 1 } }, 'üí∞'),
            React.createElement('div', { style: { fontFamily: 'Space Grotesk, Poppins, sans-serif', fontSize: '64px', fontWeight: 800, lineHeight: 1, marginBottom: '8px', background: 'linear-gradient(135deg, #fff 0%, rgba(255,255,255,0.8) 100%)', WebkitBackgroundClip: 'text', WebkitTextFillColor: 'transparent', backgroundClip: 'text', position: 'relative', zIndex: 1 } }, `${node.data?.percent || 20}%`),
            React.createElement('div', { style: { fontSize: '18px', opacity: 0.9, marginBottom: '8px', position: 'relative', zIndex: 1 } }, node.data?.value || `$${((node.data?.percent || 20) * 10).toFixed(2)} back to you`),
            React.createElement('div', { style: { fontSize: '15px', opacity: 0.8, marginBottom: '20px', position: 'relative', zIndex: 1 } }, node.data?.label || 'Partial refund ‚Äî keep your products'),
            React.createElement('div', { style: { display: 'flex', gap: '12px', marginTop: '24px', position: 'relative', zIndex: 1 } },
                React.createElement('button', { style: { flex: 1, padding: '16px 24px', borderRadius: '16px', fontSize: '15px', fontWeight: 700, cursor: 'pointer', background: 'white', color: '#1a365d', border: 'none', boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)' } }, 'Accept Offer'),
                React.createElement('button', { style: { flex: 1, padding: '16px 24px', borderRadius: '16px', fontSize: '15px', fontWeight: 700, cursor: 'pointer', background: 'rgba(255,255,255,0.15)', color: 'white', border: '1px solid rgba(255,255,255,0.3)' } }, 'No thanks')
            ),
            React.createElement('div', { style: { fontSize: '13px', opacity: 0.7, marginTop: '16px', position: 'relative', zIndex: 1 } }, 'Reviewed within 1-2 days, then 3-5 days to your account')
          );
        };

        // Render form - matches exact chat app rendering based on formType
        const renderForm = () => {
          const formType = node.data?.formType || '';
          
          // Item Selection form - show product cards (NOT email form!) - matches renderItemCards() in app.js
          if (formType === 'Item Selection') {
            // Sample products for demonstration (matches actual chat app structure)
            const sampleItems = [
              { name: 'PuppyPad Original', variant: 'Large Pack', price: '$49.99', image: 'https://via.placeholder.com/60', selected: false },
              { name: 'PuppyPad 2.0', variant: 'Regular Pack', price: '$39.99', image: 'https://via.placeholder.com/60', selected: true },
              { name: 'Travel Size Pack', variant: 'Small', price: '$19.99', image: 'https://via.placeholder.com/60', selected: false }
            ];
            
            return React.createElement('div', { style: { marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '10px', marginBottom: '12px' } },
                sampleItems.map((item, i) => 
                  React.createElement('div', {
                    key: i,
                    style: {
                      background: item.selected ? '#E8EEF4' : 'white',
                      borderRadius: '16px',
                      padding: '14px',
                      display: 'flex',
                      gap: '14px',
                      alignItems: 'center',
                      boxShadow: '0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06)',
                      marginBottom: '10px',
                      cursor: 'pointer',
                      transition: 'all 0.25s ease',
                      border: item.selected ? '2px solid #1a365d' : '2px solid transparent'
                    },
                    onMouseOver: (e) => {
                      if (!item.selected) {
                        e.currentTarget.style.borderLeft = '4px solid #1a365d';
                        e.currentTarget.style.transform = 'translateX(8px)';
                      }
                    },
                    onMouseOut: (e) => {
                      if (!item.selected) {
                        e.currentTarget.style.borderLeft = '2px solid transparent';
                        e.currentTarget.style.transform = 'translateX(0)';
                      }
                    }
                  },
                    React.createElement('img', { src: item.image, alt: item.name, style: { width: '60px', height: '60px', borderRadius: '12px', objectFit: 'cover', background: '#F3F4F6', flexShrink: 0 } }),
                    React.createElement('div', { style: { flex: 1, minWidth: 0 } },
                      React.createElement('div', { style: { fontWeight: 600, fontSize: '14px', marginBottom: '4px', whiteSpace: 'nowrap', overflow: 'hidden', textOverflow: 'ellipsis', color: '#2D3748' } }, item.name),
                      React.createElement('div', { style: { fontSize: '13px', color: '#6B7280', marginBottom: '4px' } }, item.variant),
                      React.createElement('div', { style: { fontWeight: 600, color: '#1a365d', fontSize: '14px' } }, item.price)
                    ),
                    React.createElement('div', { style: { width: '24px', height: '24px', borderRadius: '6px', border: '2px solid #D1D5DB', background: item.selected ? '#1a365d' : 'white', display: 'flex', alignItems: 'center', justifyContent: 'center', flexShrink: 0 } },
                      item.selected && React.createElement('svg', { width: '16', height: '16', viewBox: '0 0 24 24', fill: 'none', stroke: 'white', strokeWidth: '3' },
                        React.createElement('polyline', { points: '20 6 9 17 4 12' })
                      )
                    )
                  )
                )
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Continue')
            );
          }
          
          // Customer Lookup form - toggle form (email/phone) - matches renderIdentifyForm() in app.js
          // Note: For simulator, showing email mode by default (toggle would require state management)
          // For help/subscription flows, includes First Name field (isTrackFlow = false in app.js)
          if (formType === 'Customer Lookup') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { display: 'flex', background: '#F3F4F6', borderRadius: '9999px', padding: '4px', marginBottom: '20px', position: 'relative' } },
                React.createElement('div', { 
                  style: { 
                    flex: 1, 
                    padding: '12px 24px', 
                    textAlign: 'center', 
                    fontWeight: 700, 
                    fontSize: '14px', 
                    color: 'white', 
                    borderRadius: '9999px', 
                    background: '#1a365d',
                    position: 'relative',
                    zIndex: 1
                  } 
                }, 'Email'),
                React.createElement('div', { 
                  style: { 
                    flex: 1, 
                    padding: '12px 24px', 
                    textAlign: 'center', 
                    fontWeight: 600, 
                    fontSize: '14px', 
                    color: '#9CA3AF', 
                    borderRadius: '9999px', 
                    background: 'transparent',
                    position: 'relative',
                    zIndex: 1
                  } 
                }, 'Phone')
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Email Address *'),
                React.createElement('input', { 
                  type: 'email', 
                  placeholder: 'you@example.com',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'First Name *'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: 'Your first name',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Order Number (optional)'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: '#12345P',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Find My Order')
            );
          }
          
          // Deep Search form - address fields - matches deepSearchForm in app.js exactly
          if (formType === 'Deep Search') {
            // Default fields match app.js renderDeepSearchForm: firstName, lastName, address1 (Street Address), country
            const fields = node.data?.fields || ['firstName', 'lastName', 'address1', 'country'];
            
            // Map field names to display labels (matches app.js labels exactly)
            const getFieldLabel = (field) => {
              if (field === 'firstName') return 'First Name';
              if (field === 'lastName') return 'Last Name';
              if (field === 'address1') return 'Street Address';
              if (field === 'country') return 'Country';
              return field.replace(/([A-Z])/g, ' $1').trim();
            };
            
            // Map field names to placeholders (matches app.js placeholders exactly)
            const getFieldPlaceholder = (field) => {
              if (field === 'firstName') return 'Your first name';
              if (field === 'lastName') return 'Your last name';
              if (field === 'address1') return '123 Main Street';
              if (field === 'country') return 'Select country';
              return `Enter ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}...`;
            };
            
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('p', { style: { color: '#718096', marginBottom: '16px', fontSize: '14px', margin: '0 0 16px 0' } }, 'Please provide your shipping address details to help me find your order:'),
              fields.map((field, i) => {
                const isCountry = field === 'country';
                return React.createElement('div', { key: i, style: { marginBottom: '20px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, getFieldLabel(field) + ' *'),
                  isCountry 
                    ? React.createElement('select', { 
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', cursor: 'pointer' },
                        defaultValue: 'US'
                      },
                        React.createElement('option', { value: 'US' }, 'United States'),
                        React.createElement('option', { value: 'CA' }, 'Canada'),
                        React.createElement('option', { value: 'GB' }, 'United Kingdom'),
                        React.createElement('option', { value: 'AU' }, 'Australia')
                      )
                    : React.createElement('input', { 
                        type: 'text', 
                        placeholder: getFieldPlaceholder(field),
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                      })
                );
              }),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Search Again')
            );
          }
          
          // Dog Info Form - matches renderDogInfoForm() in app.js
          if (formType === 'Dog Info Form') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { borderBottom: '1px solid #E5E7EB', paddingBottom: '16px', marginBottom: '20px' } },
                React.createElement('div', { style: { fontSize: '15px', fontWeight: 600, color: '#2D3748', marginBottom: '16px' } }, 'Dog 1'),
                React.createElement('div', { style: { marginBottom: '16px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, "Dog's Name *"),
                  React.createElement('input', { type: 'text', placeholder: 'e.g., Max', style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' } })
                ),
                React.createElement('div', { style: { marginBottom: '16px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Breed *'),
                  React.createElement('input', { type: 'text', placeholder: 'e.g., Golden Retriever', style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' } })
                ),
                React.createElement('div', { style: { marginBottom: '16px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Age *'),
                  React.createElement('input', { type: 'text', placeholder: 'e.g., 2 years', style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' } })
                )
              ),
              React.createElement('button', { style: { width: '100%', padding: '12px 20px', background: '#F9FAFB', color: '#2D3748', border: '1px solid #E5E7EB', borderRadius: '12px', fontSize: '14px', fontWeight: 600, cursor: 'pointer', marginBottom: '16px' } }, '+ Add Another Dog'),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'What have you tried so far?'),
                React.createElement('textarea', { rows: 3, placeholder: "Tell us what methods you've already attempted...", style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', resize: 'vertical', minHeight: '80px' } })
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Get Personalized Tips')
            );
          }
          
          // Pickup Attempt Form - matches submitPickupAttempt() in app.js
          if (formType === 'Pickup Attempt Form') {
            const fields = node.data?.fields || ['pickupDate', 'pickupLocation', 'pickupNotes'];
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              fields.map((field, i) => {
                const isDate = field === 'pickupDate';
                const isTextarea = field === 'pickupNotes';
                const getLabel = (f) => {
                  if (f === 'pickupDate') return 'When did you try to pick it up?';
                  if (f === 'pickupLocation') return 'What location did you go to?';
                  if (f === 'pickupNotes') return 'What did they tell you? (optional)';
                  return f.replace(/([A-Z])/g, ' $1').trim();
                };
                const getPlaceholder = (f) => {
                  if (f === 'pickupLocation') return 'e.g., USPS on Main Street, UPS Store downtown';
                  if (f === 'pickupNotes') return 'e.g., They said they couldn\'t find it, no record of the package, etc.';
                  return '';
                };
                return React.createElement('div', { key: i, style: { marginBottom: '20px' } },
                  React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, getLabel(field)),
                  isDate 
                    ? React.createElement('input', { 
                        type: 'date', 
                        max: new Date().toISOString().split('T')[0],
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                      })
                    : isTextarea
                    ? React.createElement('textarea', { 
                        rows: 2,
                        placeholder: getPlaceholder(field),
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', resize: 'vertical', minHeight: '60px' }
                      })
                    : React.createElement('input', { 
                        type: 'text', 
                        placeholder: getPlaceholder(field),
                        style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                      })
                );
              }),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Submit')
            );
          }

          // Address Form - matches showAddressForm() in app.js with country-specific fields
          if (formType === 'Address Form') {
            const fields = node.data?.fields || ['country', 'address1', 'address2', 'city', 'province', 'zip'];
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Country *'),
                React.createElement('select', { 
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', cursor: 'pointer' },
                  defaultValue: 'United States'
                },
                  React.createElement('option', { value: 'United States' }, 'United States'),
                  React.createElement('option', { value: 'Canada' }, 'Canada'),
                  React.createElement('option', { value: 'United Kingdom' }, 'United Kingdom'),
                  React.createElement('option', { value: 'Australia' }, 'Australia')
                )
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Street Address *'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: '123 Main St',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'Apt/Suite/Unit'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: 'Apt 4B',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'City *'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: 'City',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'State *'),
                React.createElement('select', { 
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease', cursor: 'pointer' },
                  defaultValue: 'CA'
                },
                  React.createElement('option', { value: 'CA' }, 'California'),
                  React.createElement('option', { value: 'NY' }, 'New York'),
                  React.createElement('option', { value: 'TX' }, 'Texas')
                )
              ),
              React.createElement('div', { style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px' } }, 'ZIP Code *'),
                React.createElement('input', { 
                  type: 'text', 
                  placeholder: '12345',
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              ),
              React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Confirm & Reship')
            );
          }

          // Audio Player - matches showSarahVoiceNote() in app.js
          if (formType === 'Audio Player') {
            return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' } },
                React.createElement('img', { 
                  src: personas.sarah.avatar, 
                  alt: 'Sarah', 
                  style: { width: '48px', height: '48px', borderRadius: '50%', objectFit: 'cover' } 
                }),
                React.createElement('div', null,
                  React.createElement('div', { style: { fontSize: '15px', fontWeight: 600, color: '#2D3748' } }, 'Sarah'),
                  React.createElement('div', { style: { fontSize: '12px', color: '#718096' } }, 'Customer Experience Lead')
                )
              ),
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px', padding: '12px', background: '#F9FAFB', borderRadius: '12px' } },
                React.createElement('button', { 
                  style: { 
                    width: '48px', 
                    height: '48px', 
                    borderRadius: '50%', 
                    background: '#1a365d', 
                    border: 'none', 
                    color: 'white', 
                    display: 'flex', 
                    alignItems: 'center', 
                    justifyContent: 'center', 
                    cursor: 'pointer',
                    flexShrink: 0
                  } 
                }, '‚ñ∂'),
                React.createElement('div', { style: { flex: 1, height: '40px', background: '#E5E7EB', borderRadius: '8px', position: 'relative', overflow: 'hidden' } },
                  React.createElement('div', { style: { display: 'flex', alignItems: 'flex-end', justifyContent: 'space-around', height: '100%', padding: '0 8px', gap: '2px' } },
                    Array.from({ length: 40 }, (_, i) => 
                      React.createElement('div', { 
                        key: i, 
                        style: { 
                          width: '3px', 
                          height: `${20 + Math.random() * 60}%`, 
                          background: '#9CA3AF', 
                          borderRadius: '2px' 
                        } 
                      })
                    )
                  )
                ),
                React.createElement('div', { style: { fontSize: '12px', color: '#718096', minWidth: '40px', textAlign: 'right' } }, '0:00')
              )
            );
          }

          // Regular form - render input fields based on fields array
          const fields = node.data?.fields || ['email'];
          return React.createElement('div', { style: { background: 'white', borderRadius: '24px', padding: '24px', boxShadow: '0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05)', border: '1px solid rgba(0, 0, 0, 0.08)', marginTop: '8px', marginBottom: '20px' } },
            fields.map((field, i) => 
              React.createElement('div', { key: i, style: { marginBottom: '20px' } },
                React.createElement('label', { style: { display: 'block', fontSize: '14px', fontWeight: 600, color: '#718096', marginBottom: '8px', textTransform: 'capitalize' } }, field.replace(/([A-Z])/g, ' $1').trim() + (field === 'email' ? ' *' : '')),
                React.createElement('input', { 
                  type: field === 'email' ? 'email' : 'text', 
                  placeholder: field === 'email' ? 'you@example.com' : `Enter ${field.replace(/([A-Z])/g, ' $1').toLowerCase()}...`,
                  style: { width: '100%', padding: '14px 18px', fontSize: '16px', fontFamily: 'inherit', color: '#2D3748', background: '#F9FAFB', border: '2px solid transparent', borderRadius: '12px', transition: 'all 0.15s ease' }
                })
              )
            ),
            React.createElement('button', { style: { width: '100%', padding: '18px 20px', background: 'linear-gradient(135deg, #1a365d 0%, #2d3748 100%)', color: 'white', border: 'none', borderRadius: '16px', fontSize: '15px', fontWeight: 600, cursor: 'pointer', boxShadow: '0 4px 14px rgba(26, 54, 93, 0.4)' } }, 'Continue')
          );
        };

        return React.createElement('div', { 
          style: { 
            position: 'fixed', 
            top: 0, 
            left: 0, 
            right: 0, 
            bottom: 0, 
            background: 'rgba(0,0,0,0.5)', 
            display: 'flex', 
            alignItems: 'center', 
            justifyContent: 'center',
            zIndex: 1000,
            backdropFilter: 'blur(4px)'
          },
          onClick: onClose
        },
          React.createElement('div', { 
            style: { 
              width: '420px', 
              maxHeight: '80vh',
              background: '#f8fafc', 
              borderRadius: '24px', 
              overflow: 'hidden',
              boxShadow: '0 25px 50px -12px rgba(0,0,0,0.25)'
            },
            onClick: e => e.stopPropagation()
          },
            // Simulator Header
            React.createElement('div', { style: { background: 'white', padding: '16px 20px', borderBottom: '1px solid #e5e7eb', display: 'flex', alignItems: 'center', justifyContent: 'space-between' } },
              React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '12px' } },
                React.createElement('div', { style: { position: 'relative' } },
                  React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '44px', height: '44px', borderRadius: '50%', objectFit: 'cover', border: '3px solid white', boxShadow: '0 2px 8px rgba(0,0,0,0.1)' } }),
                  React.createElement('div', { style: { position: 'absolute', bottom: '2px', right: '2px', width: '10px', height: '10px', borderRadius: '50%', background: '#22c55e', border: '2px solid white' } })
                ),
                React.createElement('div', null,
                  React.createElement('h1', { style: { fontSize: '16px', fontWeight: 600, margin: 0, color: '#111827' } }, persona.name),
                  React.createElement('div', { style: { fontSize: '12px', color: '#22c55e', display: 'flex', alignItems: 'center', gap: '4px' } },
                    React.createElement('span', { style: { width: '6px', height: '6px', borderRadius: '50%', background: '#22c55e' } }),
                    'Online'
                  )
                )
              ),
              React.createElement('button', { 
                onClick: onClose,
                style: { width: '32px', height: '32px', borderRadius: '50%', background: '#f3f4f6', border: 'none', cursor: 'pointer', display: 'flex', alignItems: 'center', justifyContent: 'center', fontSize: '18px', color: '#6b7280' }
              }, '√ó')
            ),

            // Chat Preview Area
            React.createElement('div', { style: { padding: '20px', minHeight: '300px', maxHeight: '60vh', overflowY: 'auto' } },
              // Render based on node type
              (node.type === 'message' || node.type === 'ai') && renderMessage(),
              node.type === 'options' && React.createElement('div', null, 
                // Render prompt as Amy's message bubble first (matches actual chat app - addBotMessage first, then addOptions)
                node.data?.prompt && React.createElement('div', { style: { marginBottom: '8px' } },
                  React.createElement('div', { style: { display: 'flex', gap: '12px', maxWidth: '85%' } },
                    React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover', flexShrink: 0, marginTop: '4px' } }),
                    React.createElement('div', { style: { display: 'flex', flexDirection: 'column', gap: '4px' } },
                      React.createElement('div', { style: { display: 'flex', alignItems: 'center', gap: '8px', fontSize: '13px' } },
                        React.createElement('span', { style: { fontWeight: 600, color: '#2D3748' } }, persona.name),
                        React.createElement('span', { style: { color: '#718096', fontWeight: 400 } }, persona.role)
                      ),
                      React.createElement('div', { style: { padding: '14px 18px', background: 'white', borderRadius: '16px', borderBottomLeftRadius: '6px', border: '1px solid rgba(0, 0, 0, 0.08)', fontSize: '15px', lineHeight: '1.5', color: '#2D3748' } }, 
                        node.data.prompt
                      )
                    )
                  )
                ),
                renderOptions()
              ),
              node.type === 'offer' && React.createElement('div', null,
                React.createElement('div', { style: { display: 'flex', gap: '12px', maxWidth: '85%', marginBottom: '16px' } },
                  React.createElement('img', { src: persona.avatar, alt: persona.name, style: { width: '36px', height: '36px', borderRadius: '50%', objectFit: 'cover', flexShrink: 0 } }),
                  React.createElement('div', { style: { padding: '14px 18px', background: 'white', borderRadius: '16px', borderBottomLeftRadius: '6px', border: '1px solid rgba(0, 0, 0, 0.08)', fontSize: '15px', lineHeight: '1.5' } }, 
                    node.data?.message || "I'd like to offer you a partial refund while you keep the product."
                  )
                ),
                renderOffer()
              ),
              node.type === 'form' && React.createElement('div', null, 
                // Render label/prompt as Amy's message bubble first (matches actual chat app - addBotMessage first, then addInteractiveContent)
                // Customer Lookup: NO message bubble (form appears directly after welcome message)
                (() => {
                  const formType = node.data?.formType || '';
                  // Customer Lookup should NOT show a message bubble - form appears directly after welcome
                  if (formType === 'Customer Lookup') {
                    return null;
                  }
                  const formMessage = FORM_MESSAGES[formType] || node.data?.label || '';
                  // For Item Selection, use the exact message from chat app; for others, use label if no specific message
                  const messageToShow = formType === 'Item Selection' ? FORM_MESSAGES['Item Selection'] : 
                                       formType === 'Deep Search' ? FORM_MESSAGES['Deep Search'] :
                                       formMessage || '';
                  return messageToShow ? renderMessageBubble(messageToShow) : null;
                })(),
                renderForm()
              )
            ),

            // Simulator Footer
            React.createElement('div', { style: { padding: '12px 16px', borderTop: '1px solid #e5e7eb', background: 'white', textAlign: 'center' } },
              React.createElement('span', { style: { fontSize: '11px', color: '#718096' } }, 'üîç Simulator Preview ‚Äî This is how the node appears in the chat app')
            )
          )
        );
      };

      // ============================================
      // MAIN APP COMPONENT
      // ============================================
      const FlowDocsApp = () => {
        const [selectedParent, setSelectedParent] = useState(FLOW_DATA.parentFlows[0]);
        const [selectedSubflow, setSelectedSubflow] = useState(null);
        const [viewingEntry, setViewingEntry] = useState(true);
        const [selectedNode, setSelectedNode] = useState(null);
        const [simulatorNode, setSimulatorNode] = useState(null);

        // Get current flow data
        const currentFlow = viewingEntry 
          ? { id: 'entry', name: 'Entry Flow', nodes: selectedParent.entryNodes, edges: selectedParent.entryEdges }
          : selectedSubflow;

        const [nodes, setNodes, onNodesChange] = useNodesState(currentFlow?.nodes || []);
        const [edges, setEdges, onEdgesChange] = useEdgesState(currentFlow?.edges || []);

        // API base URL (same pattern as hub-app.js)
        const getApiBase = () => {
          const hostname = window.location.hostname;
          if (hostname.includes('pages.dev') || hostname.includes('pages.cloudflare.com')) {
            return 'https://puppypad-resolution-worker.gulfam.workers.dev';
          }
          return '';
        };

        const API_BASE = getApiBase();

        // Load saved positions from API
        const loadSavedPositions = async (flowId, defaultNodes) => {
          try {
            const token = localStorage.getItem('hub_token') || '';
            const response = await fetch(`${API_BASE}/hub/api/flow-positions/${flowId}`, {
              headers: {
                'Authorization': `Bearer ${token}`
              }
            });
            const data = await response.json();
            
            if (data.success && data.positions) {
              return defaultNodes.map(node => {
                const savedPos = data.positions[node.id];
                if (savedPos) {
                  return { ...node, position: savedPos };
                }
                return node;
              });
            }
          } catch (e) {
            console.warn('Failed to load saved positions:', e);
          }
          return defaultNodes;
        };

        // Save positions to API
        const savePositions = async (flowId, nodes) => {
          try {
            const positions = {};
            nodes.forEach(node => {
              if (node.position) {
                positions[node.id] = node.position;
              }
            });

            const user = JSON.parse(localStorage.getItem('hub_user') || '{}');
            const token = localStorage.getItem('hub_token') || '';
            
            await fetch(`${API_BASE}/hub/api/flow-positions/${flowId}`, {
              method: 'PUT',
              headers: {
                'Content-Type': 'application/json',
                'Authorization': `Bearer ${token}`
              },
              body: JSON.stringify({ 
                positions,
                user: user.email || user.name || 'unknown'
              })
            });
          } catch (e) {
            console.warn('Failed to save positions:', e);
          }
        };

        // Reset layout (clear saved positions)
        const resetLayout = useCallback(async () => {
          if (currentFlow?.id) {
            try {
              const token = localStorage.getItem('hub_token') || '';
              await fetch(`${API_BASE}/hub/api/flow-positions/${currentFlow.id}`, {
                method: 'DELETE',
                headers: {
                  'Authorization': `Bearer ${token}`
                }
              });
              
              // Reload nodes with original positions
              const originalNodes = viewingEntry 
                ? selectedParent.entryNodes 
                : selectedSubflow?.nodes || [];
              setNodes(originalNodes);
            } catch (e) {
              console.error('Failed to reset layout:', e);
            }
          }
        }, [currentFlow?.id, viewingEntry, selectedParent, selectedSubflow]);

        // Update nodes when flow changes - load saved positions if available
        useEffect(() => {
          if (currentFlow) {
            const loadFlow = async () => {
              const originalNodes = currentFlow.nodes || [];
              const nodesWithSavedPositions = await loadSavedPositions(currentFlow.id, originalNodes);
              setNodes(nodesWithSavedPositions);
              setEdges(currentFlow.edges || []);
              setSelectedNode(null);
            };
            loadFlow();
          }
        }, [currentFlow?.id, viewingEntry, selectedSubflow?.id]);

        // Save positions when nodes are dragged (debounced)
        useEffect(() => {
          if (currentFlow?.id && nodes.length > 0) {
            const timeoutId = setTimeout(() => {
              savePositions(currentFlow.id, nodes);
            }, 500); // Debounce saves by 500ms
            return () => clearTimeout(timeoutId);
          }
        }, [nodes, currentFlow?.id]);

        const handleSelectParent = (parent) => {
          setSelectedParent(parent);
        };

        const handleSelectSubflow = (subflow) => {
          setSelectedSubflow(subflow);
          setViewingEntry(false);
        };

        const handleSelectEntry = () => {
          setSelectedSubflow(null);
          setViewingEntry(true);
        };

        const onNodeClick = useCallback((event, node) => {
          setSelectedNode(node);
          // If clicking a subflow node, navigate to that subflow
          if (node.type === 'subflow' && node.data?.slug) {
            const subflow = FLOW_DATA.subflows[node.data.slug];
            if (subflow) {
              setSelectedSubflow(subflow);
              setViewingEntry(false);
            }
          }
        }, []);

        const handleSimulate = useCallback((node) => {
          setSimulatorNode(node);
        }, []);

        const handleCloseSimulator = useCallback(() => {
          setSimulatorNode(null);
        }, []);

        const defaultEdgeOptions = {
          type: 'smoothstep',
          animated: true,
          style: { strokeWidth: 2, stroke: '#94a3b8' },
          markerEnd: { type: MarkerType.ArrowClosed, color: '#94a3b8' }
        };

        return React.createElement('div', { style: { display: 'flex', height: '100vh' } },
          // Left Panel - Flow Navigation
          React.createElement(FlowNavigationPanel, {
            parentFlows: FLOW_DATA.parentFlows,
            subflows: FLOW_DATA.subflows,
            selectedParentId: selectedParent?.id,
            selectedSubflowId: selectedSubflow?.id,
            viewingEntry: viewingEntry,
            onSelectParent: handleSelectParent,
            onSelectSubflow: handleSelectSubflow,
            onSelectEntry: handleSelectEntry
          }),
          
          // Center - React Flow Canvas
          React.createElement('div', { style: { flex: 1, background: 'linear-gradient(135deg, #fef7f0 0%, #fdf2f8 25%, #f5f3ff 50%, #eff6ff 75%, #f0fdf4 100%)' } },
            React.createElement(ReactFlowComponent, {
              nodes: nodes,
              edges: edges,
              onNodesChange: onNodesChange,
              onEdgesChange: onEdgesChange,
              onNodeClick: onNodeClick,
              nodeTypes: nodeTypes,
              defaultEdgeOptions: defaultEdgeOptions,
              nodesDraggable: true,
              fitView: true,
              fitViewOptions: { padding: 0.3 },
              minZoom: 0.1,
              maxZoom: 2
            },
              React.createElement(Background, { variant: 'dots', gap: 20, size: 1, color: '#e2e8f0' }),
              React.createElement(Controls, null),
              React.createElement('div', {
                style: {
                  position: 'absolute',
                  top: 10,
                  right: 10,
                  zIndex: 5
                }
              },
                React.createElement('button', {
                  onClick: resetLayout,
                  style: {
                    padding: '8px 16px',
                    background: '#ef4444',
                    color: 'white',
                    border: 'none',
                    borderRadius: '6px',
                    cursor: 'pointer',
                    fontSize: '14px',
                    fontWeight: 500,
                    boxShadow: '0 2px 4px rgba(0,0,0,0.1)'
                  }
                }, 'Reset Layout')
              ),
              React.createElement(MiniMap, { 
                nodeColor: (n) => nodeColors[n.type] || '#94a3b8',
                maskColor: 'rgba(255,255,255,0.8)'
              })
            )
          ),
          
          // Right Panel - Node Properties
          React.createElement(NodePropertiesPanel, { 
            selectedNode: selectedNode,
            onSimulate: handleSimulate
          }),

          // Chat Simulator Modal
          simulatorNode && React.createElement(ChatSimulator, {
            node: simulatorNode,
            onClose: handleCloseSimulator
          })
        );
      };

      // Mount the app
      const root = ReactDOM.createRoot(document.getElementById('root'));
      root.render(React.createElement(FlowDocsApp));
    })();
  </script>
</body>
</html>
